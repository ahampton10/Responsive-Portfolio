/*
 http://mths.be/placeholder v2.0.7 by @mathias 
 @fileoverview
 - Using the 'QRCode for Javascript library'
 - Fixed dataset of 'QRCode for Javascript library' for support full-spec.
 - this library has no dependencies.

 @author davidshimjs
 @see <a href="http://www.d-project.com/" target="_blank">http://www.d-project.com/</a>
 @see <a href="http://jeromeetienne.github.com/jquery-qrcode/" target="_blank">http://jeromeetienne.github.com/jquery-qrcode/</a>
 jquery.Jcrop.js v0.9.12
 jQuery Image Cropping Plugin - released under MIT License 
 Author: Kelly Hallman <khallman@gmail.com>
 http://github.com/tapmodo/Jcrop
 Copyright (c) 2008-2013 Tapmodo Interactive LLC {{{

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.

 }}}
 https://d3js.org Version 4.12.2. Copyright 2017 Mike Bostock.
 Pusher JavaScript Library v4.1.0
 https://pusher.com/

 Copyright 2017, Pusher
 Released under the MIT licence.
 https://fareharbor.com/about/licenses/
*/
window.FH_VERSION="0.9.0.1";
(function(){window.configure=function(h){var b=window.slipstream?window.slipstream.configuration:"unknown";h.factory("$exceptionHandler",["Raven",function(a){return function(c,f){var e=_.isArray(c.stack)?c.stack.join("\n"):c.stack;window.slipstream&&window.slipstream.isSentryClientSideEnabled&&a.captureException(c,{extra:{cause:f,message:c.message,stack:e}});if("production"!==b){var g="$exceptionHandler: uncaught exception "+c.message;f&&(g+=' (caused by "'+f+'")',c.message+=' (caused by "'+f+'")');
console.error(g,e||"(no stack trace)")}}}]);h.config(["$animateProvider","$compileProvider","$injector","$interpolateProvider","$httpProvider","$locationProvider","$sceProvider","convertProvider",function(a,c,f,e,g,d,l,m){c.debugInfoEnabled("production"!==b);d.html5Mode(!0);d.hashPrefix("!");e.startSymbol("[[");e.endSymbol("]]");e.staticStartSymbol("[!");e.staticEndSymbol("!]");g.defaults.transformResponse.push(function(a){return m.serverResponse(a)});g.defaults.transformRequest.unshift(function(a){return m.clientRequest(a)});
g.defaults.xsrfCookieName="csrftoken";g.defaults.xsrfHeaderName="X-CSRFToken";g.defaults.headers.common["X-Requested-With"]="XMLHttpRequest";g.defaults.headers.common["X-CSRFToken"]=window.slipstream.csrfToken||"";a.classNameFilter(/\banimatable\b/)}]);h.run(["$filter","$browser","$injector","$interpolate","$rootScope",function(a,b,f,e,g){window.$$injector=f;g.isReadonlyEnabled=window.slipstream.isReadonlyEnabled;g.max=Math.max;g.addClassIf=a("addClassIf");g.isUndefined=a("isUndefined");g.handheldsMaxWidth=
window.slipstream.isEmbedded?549:679;g.T=window.T;g.cT=window.cT;g.nT=window.nT;g.ncT=window.ncT;g.interpolate=interpolate;g.$bind=function(a,b){var d=this,c=function(){var c=_.get(d,b);_.set(d,a,c)};c();d.$watch(c)};g.$model=function(a){var b=_.bind(a,a,this);b.assign=_.bind(a.assign,a,this);return b};g.$once=function(a,b){var d=this.$on(a,function(){d();return b.apply(this,arguments)});return d};g.isSet=function(a){return _.isUndefined(a)?!1:""===a?!0:this.$eval(a)};var d=g.$new;g.$new=function(a,
b){return a?d.call(this,!1,this.$root):d.call(this,a,b)};g.$safeApply=function(a){if(this.$root){var b=this.$root.$$phase;return"$apply"==b||"$digest"==b?a&&a():this.$apply(a)}};g.$safeDigest=function(){if(this.$root){var a=this.$root.$$phase;"$apply"==a||"$digest"==a||this.$digest()}};g.$asyncApply=function(a){var d=b.defer(_.ignore,31536E6),e=function(){b.defer.cancel(d)};a(e);return e};g.$interpolate=function(a,b){var d=this,c=!1;b&&(d=d.$new(),_.extend(d,b),c=!0);if(_.isUndefined(a))return"";
var f=e(a);if(!f)return"";f=f(d);c&&d.$destroy();return f};window.$$digest=function(a,b){var d=angular.element(document.querySelector("[ng-app]"));b=b||d.injector().get("$rootScope");a=a||100;console.info("digest: running "+a+"...");for(var d=performance.now(),c=0;c<a;c++)b.$digest();c=performance.now();console.info("digest: average time "+(c-d)/a+"ms");var d=0,c=b,e;do if(d+=c.$$watchers?c.$$watchers.length:0,!(e=c.$$childHead||c!==b&&c.$$nextSibling))for(;c!==b&&!(e=c.$$nextSibling);)c=c.$parent;
while(c=e);console.info("digest: watcher count",d)};window.$$scope=function(a){return angular.element(a).scope()}}])}})();
(function(h,b,a){function c(b){var d={},c=/^jQuery\d+$/;a.each(b.attributes,function(a,b){b.specified&&!c.test(b.name)&&(d[b.name]=b.value)});return d}function f(d,c){var e=a(this);if(this.value==e.attr("placeholder")&&e.hasClass("placeholder"))if(e.data("placeholder-password")){e=e.hide().next().show().attr("id",e.removeAttr("id").data("placeholder-id"));if(!0===d)return e[0].value=c;e.focus()}else this.value="",e.removeClass("placeholder"),this==b.activeElement&&this.select()}function e(){var b,
d=a(this),e=this.id;if(""==this.value){if("password"==this.type){if(!d.data("placeholder-textinput")){try{b=d.clone().attr({type:"text"})}catch(g){b=a("<input>").attr(a.extend(c(this),{type:"text"}))}b.removeAttr("name").data({"placeholder-password":!0,"placeholder-id":e}).bind("focus.placeholder",f);d.data({"placeholder-textinput":b,"placeholder-id":e}).before(b)}d=d.removeAttr("id").hide().prev().attr("id",e).show()}d.addClass("placeholder");d[0].value=d.attr("placeholder")}else d.removeClass("placeholder")}
var g="placeholder"in b.createElement("input"),d="placeholder"in b.createElement("textarea"),l=a.fn,m=a.valHooks;g&&d?(l=l.placeholder=function(){return this},l.input=l.textarea=!0):(l=l.placeholder=function(){this.filter((g?"textarea":":input")+"[placeholder]").not(".placeholder").bind({"focus.placeholder":f,"blur.placeholder":e}).data("placeholder-enabled",!0).trigger("blur.placeholder");return this},l.input=g,l.textarea=d,l={get:function(b){var d=a(b);return d.data("placeholder-enabled")&&d.hasClass("placeholder")?
"":b.value},set:function(d,c){var g=a(d);if(!g.data("placeholder-enabled"))return d.value=c;""==c?(d.value=c,d!=b.activeElement&&e.call(d)):g.hasClass("placeholder")?f.call(d,!0,c)||(d.value=c):d.value=c;return g}},g||(m.input=l),d||(m.textarea=l),a(function(){a(b).delegate("form","submit.placeholder",function(){var b=a(".placeholder",this).each(f);setTimeout(function(){b.each(e)},10)})}),a(h).bind("beforeunload.placeholder",function(){a(".placeholder").each(function(){this.value=""})}))})(this,document,
jQuery);var QRCode;
(function(){function h(a){this.mode=g.MODE_8BIT_BYTE;this.data=a;this.parsedData=[];a=0;for(var b=this.data.length;a<b;a++){var d=[],c=this.data.charCodeAt(a);65536<c?(d[0]=240|(c&1835008)>>>18,d[1]=128|(c&258048)>>>12,d[2]=128|(c&4032)>>>6,d[3]=128|c&63):2048<c?(d[0]=224|(c&61440)>>>12,d[1]=128|(c&4032)>>>6,d[2]=128|c&63):128<c?(d[0]=192|(c&1984)>>>6,d[1]=128|c&63):d[0]=c;this.parsedData.push(d)}this.parsedData=Array.prototype.concat.apply([],this.parsedData);this.parsedData.length!=this.data.length&&
(this.parsedData.unshift(191),this.parsedData.unshift(187),this.parsedData.unshift(239))}function b(a,b){this.typeNumber=a;this.errorCorrectLevel=b;this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=[]}function a(a,b){if(void 0==a.length)throw Error(a.length+"/"+b);for(var d=0;d<a.length&&0==a[d];)d++;this.num=Array(a.length-d+b);for(var c=0;c<a.length-d;c++)this.num[c]=a[c+d]}function c(a,b){this.totalCount=a;this.dataCount=b}function f(){this.buffer=[];this.length=0}function e(){var a=
!1,b=navigator.userAgent;/android/i.test(b)&&(a=!0,(b=b.toString().match(/android ([0-9]\.[0-9])/i))&&b[1]&&(a=parseFloat(b[1])));return a}h.prototype={getLength:function(a){return this.parsedData.length},write:function(a){for(var b=0,d=this.parsedData.length;b<d;b++)a.put(this.parsedData[b],8)}};b.prototype={addData:function(a){a=new h(a);this.dataList.push(a);this.dataCache=null},isDark:function(a,b){if(0>a||this.moduleCount<=a||0>b||this.moduleCount<=b)throw Error(a+","+b);return this.modules[a][b]},
getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(a,d){this.moduleCount=4*this.typeNumber+17;this.modules=Array(this.moduleCount);for(var c=0;c<this.moduleCount;c++){this.modules[c]=Array(this.moduleCount);for(var e=0;e<this.moduleCount;e++)this.modules[c][e]=null}this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.setupPositionAdjustPattern();
this.setupTimingPattern();this.setupTypeInfo(a,d);7<=this.typeNumber&&this.setupTypeNumber(a);null==this.dataCache&&(this.dataCache=b.createData(this.typeNumber,this.errorCorrectLevel,this.dataList));this.mapData(this.dataCache,d)},setupPositionProbePattern:function(a,b){for(var d=-1;7>=d;d++)if(!(-1>=a+d||this.moduleCount<=a+d))for(var c=-1;7>=c;c++)-1>=b+c||this.moduleCount<=b+c||(this.modules[a+d][b+c]=0<=d&&6>=d&&(0==c||6==c)||0<=c&&6>=c&&(0==d||6==d)||2<=d&&4>=d&&2<=c&&4>=c?!0:!1)},getBestMaskPattern:function(){for(var a=
0,b=0,d=0;8>d;d++){this.makeImpl(!0,d);var c=l.getLostPoint(this);if(0==d||a>c)a=c,b=d}return b},createMovieClip:function(a,b,d){a=a.createEmptyMovieClip(b,d);this.make();for(b=0;b<this.modules.length;b++){d=1*b;for(var c=0;c<this.modules[b].length;c++){var e=1*c;this.modules[b][c]&&(a.beginFill(0,100),a.moveTo(e,d),a.lineTo(e+1,d),a.lineTo(e+1,d+1),a.lineTo(e,d+1),a.endFill())}}return a},setupTimingPattern:function(){for(var a=8;a<this.moduleCount-8;a++)null==this.modules[a][6]&&(this.modules[a][6]=
0==a%2);for(a=8;a<this.moduleCount-8;a++)null==this.modules[6][a]&&(this.modules[6][a]=0==a%2)},setupPositionAdjustPattern:function(){for(var a=l.getPatternPosition(this.typeNumber),b=0;b<a.length;b++)for(var d=0;d<a.length;d++){var c=a[b],e=a[d];if(null==this.modules[c][e])for(var f=-2;2>=f;f++)for(var k=-2;2>=k;k++)this.modules[c+f][e+k]=-2==f||2==f||-2==k||2==k||0==f&&0==k?!0:!1}},setupTypeNumber:function(a){for(var b=l.getBCHTypeNumber(this.typeNumber),d=0;18>d;d++){var c=!a&&1==(b>>d&1);this.modules[Math.floor(d/
3)][d%3+this.moduleCount-8-3]=c}for(d=0;18>d;d++)c=!a&&1==(b>>d&1),this.modules[d%3+this.moduleCount-8-3][Math.floor(d/3)]=c},setupTypeInfo:function(a,b){for(var d=l.getBCHTypeInfo(this.errorCorrectLevel<<3|b),c=0;15>c;c++){var e=!a&&1==(d>>c&1);6>c?this.modules[c][8]=e:8>c?this.modules[c+1][8]=e:this.modules[this.moduleCount-15+c][8]=e}for(c=0;15>c;c++)e=!a&&1==(d>>c&1),8>c?this.modules[8][this.moduleCount-c-1]=e:9>c?this.modules[8][15-c-1+1]=e:this.modules[8][15-c-1]=e;this.modules[this.moduleCount-
8][8]=!a},mapData:function(a,b){for(var d=-1,c=this.moduleCount-1,e=7,f=0,k=this.moduleCount-1;0<k;k-=2)for(6==k&&k--;;){for(var g=0;2>g;g++)if(null==this.modules[c][k-g]){var m=!1;f<a.length&&(m=1==(a[f]>>>e&1));l.getMask(b,c,k-g)&&(m=!m);this.modules[c][k-g]=m;e--; -1==e&&(f++,e=7)}c+=d;if(0>c||this.moduleCount<=c){c-=d;d=-d;break}}}};b.PAD0=236;b.PAD1=17;b.createData=function(a,d,e){d=c.getRSBlocks(a,d);for(var k=new f,g=0;g<e.length;g++){var m=e[g];k.put(m.mode,4);k.put(m.getLength(),l.getLengthInBits(m.mode,
a));m.write(k)}for(g=a=0;g<d.length;g++)a+=d[g].dataCount;if(k.getLengthInBits()>8*a)throw Error("code length overflow. ("+k.getLengthInBits()+">"+8*a+")");for(k.getLengthInBits()+4<=8*a&&k.put(0,4);0!=k.getLengthInBits()%8;)k.putBit(!1);for(;!(k.getLengthInBits()>=8*a);){k.put(b.PAD0,8);if(k.getLengthInBits()>=8*a)break;k.put(b.PAD1,8)}return b.createBytes(k,d)};b.createBytes=function(b,d){for(var c=0,e=0,f=0,k=Array(d.length),g=Array(d.length),m=0;m<d.length;m++){var n=d[m].dataCount,s=d[m].totalCount-
n,e=Math.max(e,n),f=Math.max(f,s);k[m]=Array(n);for(var p=0;p<k[m].length;p++)k[m][p]=255&b.buffer[p+c];c+=n;p=l.getErrorCorrectPolynomial(s);n=(new a(k[m],p.getLength()-1)).mod(p);g[m]=Array(p.getLength()-1);for(p=0;p<g[m].length;p++)s=p+n.getLength()-g[m].length,g[m][p]=0<=s?n.get(s):0}for(p=m=0;p<d.length;p++)m+=d[p].totalCount;c=Array(m);for(p=n=0;p<e;p++)for(m=0;m<d.length;m++)p<k[m].length&&(c[n++]=k[m][p]);for(p=0;p<f;p++)for(m=0;m<d.length;m++)p<g[m].length&&(c[n++]=g[m][p]);return c};for(var g=
{MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8},d={L:1,M:0,Q:3,H:2},l={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,
134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],G15:1335,G18:7973,G15_MASK:21522,getBCHTypeInfo:function(a){for(var b=a<<10;0<=l.getBCHDigit(b)-l.getBCHDigit(l.G15);)b^=l.G15<<l.getBCHDigit(b)-l.getBCHDigit(l.G15);return(a<<10|b)^l.G15_MASK},getBCHTypeNumber:function(a){for(var b=a<<12;0<=l.getBCHDigit(b)-l.getBCHDigit(l.G18);)b^=
l.G18<<l.getBCHDigit(b)-l.getBCHDigit(l.G18);return a<<12|b},getBCHDigit:function(a){for(var b=0;0!=a;)b++,a>>>=1;return b},getPatternPosition:function(a){return l.PATTERN_POSITION_TABLE[a-1]},getMask:function(a,b,d){switch(a){case 0:return 0==(b+d)%2;case 1:return 0==b%2;case 2:return 0==d%3;case 3:return 0==(b+d)%3;case 4:return 0==(Math.floor(b/2)+Math.floor(d/3))%2;case 5:return 0==b*d%2+b*d%3;case 6:return 0==(b*d%2+b*d%3)%2;case 7:return 0==(b*d%3+(b+d)%2)%2;default:throw Error("bad maskPattern:"+
a);}},getErrorCorrectPolynomial:function(b){for(var d=new a([1],0),c=0;c<b;c++)d=d.multiply(new a([1,m.gexp(c)],0));return d},getLengthInBits:function(a,b){if(1<=b&&10>b)switch(a){case g.MODE_NUMBER:return 10;case g.MODE_ALPHA_NUM:return 9;case g.MODE_8BIT_BYTE:return 8;case g.MODE_KANJI:return 8;default:throw Error("mode:"+a);}else if(27>b)switch(a){case g.MODE_NUMBER:return 12;case g.MODE_ALPHA_NUM:return 11;case g.MODE_8BIT_BYTE:return 16;case g.MODE_KANJI:return 10;default:throw Error("mode:"+
a);}else if(41>b)switch(a){case g.MODE_NUMBER:return 14;case g.MODE_ALPHA_NUM:return 13;case g.MODE_8BIT_BYTE:return 16;case g.MODE_KANJI:return 12;default:throw Error("mode:"+a);}else throw Error("type:"+b);},getLostPoint:function(a){for(var b=a.getModuleCount(),d=0,c=0;c<b;c++)for(var e=0;e<b;e++){for(var f=0,k=a.isDark(c,e),g=-1;1>=g;g++)if(!(0>c+g||b<=c+g))for(var l=-1;1>=l;l++)0>e+l||b<=e+l||0==g&&0==l||k==a.isDark(c+g,e+l)&&f++;5<f&&(d+=3+f-5)}for(c=0;c<b-1;c++)for(e=0;e<b-1;e++)if(f=0,a.isDark(c,
e)&&f++,a.isDark(c+1,e)&&f++,a.isDark(c,e+1)&&f++,a.isDark(c+1,e+1)&&f++,0==f||4==f)d+=3;for(c=0;c<b;c++)for(e=0;e<b-6;e++)a.isDark(c,e)&&(!a.isDark(c,e+1)&&a.isDark(c,e+2)&&a.isDark(c,e+3)&&a.isDark(c,e+4)&&!a.isDark(c,e+5)&&a.isDark(c,e+6))&&(d+=40);for(e=0;e<b;e++)for(c=0;c<b-6;c++)a.isDark(c,e)&&(!a.isDark(c+1,e)&&a.isDark(c+2,e)&&a.isDark(c+3,e)&&a.isDark(c+4,e)&&!a.isDark(c+5,e)&&a.isDark(c+6,e))&&(d+=40);for(e=f=0;e<b;e++)for(c=0;c<b;c++)a.isDark(c,e)&&f++;a=Math.abs(100*f/b/b-50)/5;return d+
10*a}},m={glog:function(a){if(1>a)throw Error("glog("+a+")");return m.LOG_TABLE[a]},gexp:function(a){for(;0>a;)a+=255;for(;256<=a;)a-=255;return m.EXP_TABLE[a]},EXP_TABLE:Array(256),LOG_TABLE:Array(256)},k=0;8>k;k++)m.EXP_TABLE[k]=1<<k;for(k=8;256>k;k++)m.EXP_TABLE[k]=m.EXP_TABLE[k-4]^m.EXP_TABLE[k-5]^m.EXP_TABLE[k-6]^m.EXP_TABLE[k-8];for(k=0;255>k;k++)m.LOG_TABLE[m.EXP_TABLE[k]]=k;a.prototype={get:function(a){return this.num[a]},getLength:function(){return this.num.length},multiply:function(b){for(var d=
Array(this.getLength()+b.getLength()-1),c=0;c<this.getLength();c++)for(var e=0;e<b.getLength();e++)d[c+e]^=m.gexp(m.glog(this.get(c))+m.glog(b.get(e)));return new a(d,0)},mod:function(b){if(0>this.getLength()-b.getLength())return this;for(var d=m.glog(this.get(0))-m.glog(b.get(0)),c=Array(this.getLength()),e=0;e<this.getLength();e++)c[e]=this.get(e);for(e=0;e<b.getLength();e++)c[e]^=m.gexp(m.glog(b.get(e))+d);return(new a(c,0)).mod(b)}};c.RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,
44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],
[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,
69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,
17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,
146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,
14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]];c.getRSBlocks=function(a,b){var d=c.getRsBlockTable(a,b);if(void 0==d)throw Error("bad rs block @ typeNumber:"+a+"/errorCorrectLevel:"+b);for(var e=d.length/3,f=[],k=0;k<e;k++)for(var g=d[3*k+0],l=d[3*k+
1],m=d[3*k+2],n=0;n<g;n++)f.push(new c(l,m));return f};c.getRsBlockTable=function(a,b){switch(b){case d.L:return c.RS_BLOCK_TABLE[4*(a-1)+0];case d.M:return c.RS_BLOCK_TABLE[4*(a-1)+1];case d.Q:return c.RS_BLOCK_TABLE[4*(a-1)+2];case d.H:return c.RS_BLOCK_TABLE[4*(a-1)+3]}};f.prototype={get:function(a){return 1==(this.buffer[Math.floor(a/8)]>>>7-a%8&1)},put:function(a,b){for(var d=0;d<b;d++)this.putBit(1==(a>>>b-d-1&1))},getLengthInBits:function(){return this.length},putBit:function(a){var b=Math.floor(this.length/
8);this.buffer.length<=b&&this.buffer.push(0);a&&(this.buffer[b]|=128>>>this.length%8);this.length++}};var n=[[17,14,11,7],[32,26,20,14],[53,42,32,24],[78,62,46,34],[106,84,60,44],[134,106,74,58],[154,122,86,64],[192,152,108,84],[230,180,130,98],[271,213,151,119],[321,251,177,137],[367,287,203,155],[425,331,241,177],[458,362,258,194],[520,412,292,220],[586,450,322,250],[644,504,364,280],[718,560,394,310],[792,624,442,338],[858,666,482,382],[929,711,509,403],[1003,779,565,439],[1091,857,611,461],[1171,
911,661,511],[1273,997,715,535],[1367,1059,751,593],[1465,1125,805,625],[1528,1190,868,658],[1628,1264,908,698],[1732,1370,982,742],[1840,1452,1030,790],[1952,1538,1112,842],[2068,1628,1168,898],[2188,1722,1228,958],[2303,1809,1283,983],[2431,1911,1351,1051],[2563,1989,1423,1093],[2699,2099,1499,1139],[2809,2213,1579,1219],[2953,2331,1663,1273]],s=function(){var a=function(a,b){this._el=a;this._htOption=b};a.prototype.draw=function(a){function b(a,d){var c=document.createElementNS("http://www.w3.org/2000/svg",
a),e;for(e in d)d.hasOwnProperty(e)&&c.setAttribute(e,d[e]);return c}var d=this._htOption,c=this._el,e=a.getModuleCount();this.clear();var f=b("svg",{viewBox:"0 0 "+String(e)+" "+String(e),width:"100%",height:"100%",fill:d.colorLight});f.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink");c.appendChild(f);f.appendChild(b("rect",{fill:d.colorLight,width:"100%",height:"100%"}));f.appendChild(b("rect",{fill:d.colorDark,width:"1",height:"1",id:"template"}));for(d=
0;d<e;d++)for(c=0;c<e;c++)if(a.isDark(d,c)){var k=b("use",{x:String(d),y:String(c)});k.setAttributeNS("http://www.w3.org/1999/xlink","href","#template");f.appendChild(k)}};a.prototype.clear=function(){for(;this._el.hasChildNodes();)this._el.removeChild(this._el.lastChild)};return a}(),p="svg"===document.documentElement.tagName.toLowerCase()?s:"undefined"==typeof CanvasRenderingContext2D?function(){var a=function(a,b){this._el=a;this._htOption=b};a.prototype.draw=function(a){for(var b=this._htOption,
d=this._el,c=a.getModuleCount(),e=Math.floor(b.width/c),f=Math.floor(b.height/c),k=['<table style="border:0;border-collapse:collapse;">'],g=0;g<c;g++){k.push("<tr>");for(var l=0;l<c;l++)k.push('<td style="border:0;border-collapse:collapse;padding:0;margin:0;width:'+e+"px;height:"+f+"px;background-color:"+(a.isDark(g,l)?b.colorDark:b.colorLight)+';"></td>');k.push("</tr>")}k.push("</table>");d.innerHTML=k.join("");a=d.childNodes[0];d=(b.width-a.offsetWidth)/2;b=(b.height-a.offsetHeight)/2;0<d&&0<b&&
(a.style.margin=b+"px "+d+"px")};a.prototype.clear=function(){this._el.innerHTML=""};return a}():function(){function a(){this._elImage.src=this._elCanvas.toDataURL("image/png");this._elImage.style.display="block";this._elCanvas.style.display="none"}function b(a,d){var c=this;c._fFail=d;c._fSuccess=a;if(null===c._bSupportDataURI){var e=document.createElement("img"),f=function(){c._bSupportDataURI=!1;c._fFail&&c._fFail.call(c)};e.onabort=f;e.onerror=f;e.onload=function(){c._bSupportDataURI=!0;c._fSuccess&&
c._fSuccess.call(c)};e.src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg=="}else!0===c._bSupportDataURI&&c._fSuccess?c._fSuccess.call(c):!1===c._bSupportDataURI&&c._fFail&&c._fFail.call(c)}if(this._android&&2.1>=this._android){var d=1/window.devicePixelRatio,c=CanvasRenderingContext2D.prototype.drawImage;CanvasRenderingContext2D.prototype.drawImage=function(a,b,e,f,k,g,l,m,n){if("nodeName"in a&&/img/i.test(a.nodeName))for(var s=
arguments.length-1;1<=s;s--)arguments[s]*=d;else"undefined"==typeof m&&(arguments[1]*=d,arguments[2]*=d,arguments[3]*=d,arguments[4]*=d);c.apply(this,arguments)}}var f=function(a,b){this._bIsPainted=!1;this._android=e();this._htOption=b;this._elCanvas=document.createElement("canvas");this._elCanvas.width=b.width;this._elCanvas.height=b.height;a.appendChild(this._elCanvas);this._el=a;this._oContext=this._elCanvas.getContext("2d");this._bIsPainted=!1;this._elImage=document.createElement("img");this._elImage.alt=
"Scan me!";this._elImage.style.display="none";this._el.appendChild(this._elImage);this._bSupportDataURI=null};f.prototype.draw=function(a){var b=this._elImage,d=this._oContext,c=this._htOption,e=a.getModuleCount(),f=c.width/e,k=c.height/e,g=Math.round(f),l=Math.round(k);b.style.display="none";this.clear();for(b=0;b<e;b++)for(var m=0;m<e;m++){var n=a.isDark(b,m),s=m*f,r=b*k;d.strokeStyle=n?c.colorDark:c.colorLight;d.lineWidth=1;d.fillStyle=n?c.colorDark:c.colorLight;d.fillRect(s,r,f,k);d.strokeRect(Math.floor(s)+
0.5,Math.floor(r)+0.5,g,l);d.strokeRect(Math.ceil(s)-0.5,Math.ceil(r)-0.5,g,l)}this._bIsPainted=!0};f.prototype.makeImage=function(){this._bIsPainted&&b.call(this,a)};f.prototype.isPainted=function(){return this._bIsPainted};f.prototype.clear=function(){this._oContext.clearRect(0,0,this._elCanvas.width,this._elCanvas.height);this._bIsPainted=!1};f.prototype.round=function(a){return!a?a:Math.floor(1E3*a)/1E3};return f}();QRCode=function(a,b){this._htOption={width:256,height:256,typeNumber:4,colorDark:"#000000",
colorLight:"#ffffff",correctLevel:d.H};"string"===typeof b&&(b={text:b});if(b)for(var c in b)this._htOption[c]=b[c];"string"==typeof a&&(a=document.getElementById(a));this._htOption.useSVG&&(p=s);this._android=e();this._el=a;this._oQRCode=null;this._oDrawing=new p(this._el,this._htOption);this._htOption.text&&this.makeCode(this._htOption.text)};QRCode.prototype.makeCode=function(a){var c=this._htOption.correctLevel,e=1,f;f=encodeURI(a).toString().replace(/\%[0-9a-fA-F]{2}/g,"a");f=f.length+(f.length!=
a?3:0);for(var k=0,g=n.length;k<=g;k++){var l=0;switch(c){case d.L:l=n[k][0];break;case d.M:l=n[k][1];break;case d.Q:l=n[k][2];break;case d.H:l=n[k][3]}if(f<=l)break;else e++}if(e>n.length)throw Error("Too long data");this._oQRCode=new b(e,this._htOption.correctLevel);this._oQRCode.addData(a);this._oQRCode.make();this._el.title=a;this._oDrawing.draw(this._oQRCode);this.makeImage()};QRCode.prototype.makeImage=function(){"function"==typeof this._oDrawing.makeImage&&(!this._android||3<=this._android)&&
this._oDrawing.makeImage()};QRCode.prototype.clear=function(){this._oDrawing.clear()};QRCode.CorrectLevel=d})();angular.module("lib","lib.controllers lib.directives lib.filters lib.factories lib.services lib.services.interpolate".split(" "));
(function(){var h=angular.module("lib.controllers",["auth.services","db.services","lib.services"]);h.controller("lib.shared.CompanyAdminNotesEditableCtrl",["$scope","controllers","db","require","shortcutsOverlay",function(b,a,c,f,e){f.inScope(b,"company","lib.shared.CompanyAdminNotesEditableCtrl");a.editController(b,{collectionKey:"companies",elementKey:"company",modelKey:"editableCompany",update:c.company.adminNotes.update,editCallback:function(){b.editableCompany.adminNotes||(b.editableCompany.adminNotes=
"# Dashboard Notes\n\n[YOUR CONTENT HERE]\n______\n\n# Additional Feature Notes\n\n[ex: Cart, Price Schedules]\n\n______\n\n# Item Specific Notes\n\n[YOUR CONTENT HERE]\n______\n\n# Resource Notes\n\n[YOUR CONTENT HERE]\n______\n\n# Related Dashboards\n\n[LINK TO DASHBOARDS HERE]\n______\n\n# Major Updates Log\n\nYour Name:\n\nWhat You Updated:\n\nDate:");e.confirmClose(!0)},cancelCallback:_.partial(e.confirmClose,!1),successCallback:function(){b.editCtrl.editing=!1;e.confirmClose(!1)},params:function(){return{shortname:b.company.shortname}}})}]);
h.controller("lib.shared.NewTransportationCtrl",["$scope","$attrs","$injector","$interpolate","$parse","auth","controllers","convert","db","require","models",function(b,a,c,f,e,g,d,l,m,k,n){k.inScope(b,"customField","lib.shared.NewTransportationCtrl");var s=c.get("plusbook"),p=c.get("rebook"),r=e(a.ngNewTransportation),t=r(b);t&&_.isString(t)&&(t=l.serverResponse(_.parseJSON(t)));var v=function(a){b.newTransportationCtrl.data=a;a.lodging?(b.newTransportationCtrl.currentLodging=_.find(b.newTransportationCtrl.lodgings,
function(b){return b.pk===a.lodging}),b.newTransportationCtrl.currentLodging||(a.lodging="")):b.newTransportationCtrl.currentLodging=null;a.route&&!s.currentSourceBooking&&!q()?(b.newTransportationCtrl.currentRoute=_.find(b.newTransportationCtrl.routes,function(b){return b.pk===a.route}),b.newTransportationCtrl.currentRoute||(a.route="")):b.newTransportationCtrl.currentRoute=null;a.stop&&b.newTransportationCtrl.currentRoute?(b.newTransportationCtrl.currentStop=_.find(b.newTransportationCtrl.currentRoute.stops,
function(b){return b.pk===a.stop}),b.newTransportationCtrl.currentStop||(a.stop="")):(a.route="",b.newTransportationCtrl.currentRoute=null,a.stop="",b.newTransportationCtrl.currentStop=null);b.newTransportationCtrl.needsTransportation=!!b.newTransportationCtrl.currentStop||b.customFieldPricing.visibility.isRequired;b.newTransportationCtrl.needsTransportation&&p.currentBooking&&y()},y=function(){b.newTransportationCtrl.rebookingTransportation=!0;b.newTransportationCtrl.rebookTransportationOptions=
[];b.newTransportationCtrl.rebookTransportationOption=null;var a=function(a){_.find(b.newTransportationCtrl.rebookTransportationOptions,function(b){return b.route===a.route&&b.stop===a.stop})||(b.newTransportationCtrl.rebookTransportationOptions.push(a),b.newTransportationCtrl.rebookTransportationOption||(b.newTransportationCtrl.rebookTransportationOption=a))};if(b.availability.defaultRoute){if(p.currentBooking.stop){var d=_.find(b.availability.defaultRoute.stops,function(a){return a.pickup===p.currentBooking.stop.pickup});
d&&a({text:T("Match pickup location"),tip:T("Move to route of new availability but keep same pickup location"),route:b.availability.defaultRoute,stop:d})}(d=_.chooseFirst(b.newTransportationCtrl.currentLodging.preferredPickups,function(a){return _.find(b.availability.defaultRoute.stops,function(b){if(b.pickup===a.pickup)return b})}))&&a({text:T("Use new availability's default"),tip:T("Use the lodging's preferred stop on the default route"),route:b.availability.defaultRoute,stop:d})}b.newTransportationCtrl.currentRoute&&
b.newTransportationCtrl.currentStop&&a({text:T("Keep old booking's options"),route:b.newTransportationCtrl.currentRoute,stop:b.newTransportationCtrl.currentStop});if(b.newTransportationCtrl.canOverrideTransportation){var c={text:T("Pick new options"),route:b.availability.defaultRoute||"",stop:""};a(c)}b.newTransportationCtrl.rebookTransportationOption&&(b.newTransportationCtrl.data.route=b.newTransportationCtrl.rebookTransportationOption.route.pk,b.newTransportationCtrl.currentRoute=b.newTransportationCtrl.rebookTransportationOption.route,
b.newTransportationCtrl.data.stop=b.newTransportationCtrl.rebookTransportationOption.stop.pk,b.newTransportationCtrl.currentStop=b.newTransportationCtrl.rebookTransportationOption.stop);var e=!1;b.$watch("newTransportationCtrl.data",function(a,d){var f=_.find(b.newTransportationCtrl.rebookTransportationOptions,function(b,d){return b.route.pk===a.route&&b.stop.pk===a.stop}),f=f||c;f!==b.newTransportationCtrl.rebookTransportationOption&&(b.newTransportationCtrl.rebookTransportationOption=f,e=!0,b.$evalAsync(function(){e=
!1}))},!0);b.$watch("newTransportationCtrl.rebookTransportationOption",function(a,d){a&&a!==d&&!e&&(a.route&&(b.newTransportationCtrl.data.route=a.route.pk,b.newTransportationCtrl.currentRoute=a.route),b.$evalAsync(function(){b.newTransportationCtrl.data.stop=a.stop?a.stop.pk:"";b.newTransportationCtrl.currentStop=a.stop||null}))})};b.availability||(b.availability={company:b.company,startAt:moment()});b.newTransportationCtrl={canOverrideTransportation:g.permissions.can("overrideTransportation",n.Booking,
b.availability.company),needsTransportation:void 0,rebookingTransportation:!1,rebookingTransportationOptions:[],rebookingTransportationOption:null,data:{lodging:"",lodgingRoomNumber:"",selfLodgingAddress:"",route:"",stop:""},status:"loading"};b.newTransportationCtrl.needsTransportation=b.customFieldPricing.visibility.isRequired?!0:b.newTransportationCtrl.canOverrideTransportation?!1:void 0;var q=function(){return b.newTransportationCtrl.canOverrideTransportation&&!b.booking&&!b.availability.defaultRoute};
b.newTransportationCtrl.showSelfTransportation=function(){return q()||!b.newTransportationCtrl.currentLodging?!1:!b.newTransportationCtrl.isTransportationAvailable()||!1===b.newTransportationCtrl.needsTransportation};b.newTransportationCtrl.isTransportationAvailable=function(){if(q()||!b.newTransportationCtrl.routes.length||!b.newTransportationCtrl.currentLodging)return!1;var a;if(a=!b.newTransportationCtrl.canOverrideTransportation)if(a=!b.customFieldPricing.visibility.isRequired)a=u(),a=!C(a);return a?
!1:!0};b.newTransportationCtrl.showRoutes=function(){return 1>=b.newTransportationCtrl.routes.length?!1:b.newTransportationCtrl.canOverrideTransportation};b.newTransportationCtrl.showStops=function(){return 0>=b.newTransportationCtrl.stops.length?!1:b.newTransportationCtrl.canOverrideTransportation?!0:!C(b.newTransportationCtrl.currentRoute)};b.newTransportationCtrl.showNeedsTransportation=function(){return b.customFieldPricing.visibility.isRequired?!1:b.newTransportationCtrl.isTransportationAvailable()};
b.newTransportationCtrl.showTransportationPrice=function(){return!b.customField.isPricingHidden&&(n.PriceLine.showOffset(b.customFieldPricing)||n.PriceLine.showRate(b.customFieldPricing))};var h=function(){b.newTransportationCtrl.stops=b.newTransportationCtrl.currentRoute?b.newTransportationCtrl.currentRoute.stops:[]},u=function(){return 1===b.newTransportationCtrl.routes.length?b.newTransportationCtrl.routes[0]:b.availability.defaultRoute?b.availability.defaultRoute:null},z=function(){var a=u();
a?(b.newTransportationCtrl.data.route=a.pk,b.newTransportationCtrl.currentRoute=a):(b.newTransportationCtrl.data.route="",b.newTransportationCtrl.currentRoute=null)},C=function(a){if(b.newTransportationCtrl.currentLodging&&a)return 1===b.newTransportationCtrl.stops.length&&(b.newTransportationCtrl.canOverrideTransportation||b.customFieldPricing.visibility.isRequired)?b.newTransportationCtrl.stops[0]:_.chooseFirst(b.newTransportationCtrl.currentLodging.preferredPickups,function(b){return _.chooseFirst(a.stops,
function(a){if(a.pickup===b.pickup)return a})})},F=function(){var a=C(b.newTransportationCtrl.currentRoute);if(a)return b.newTransportationCtrl.data.stop=a.pk,b.newTransportationCtrl.currentStop=a,!0;b.newTransportationCtrl.data.stop="";b.newTransportationCtrl.currentStop=null;!b.newTransportationCtrl.canOverrideTransportation&&!b.customFieldPricing.visibility.isRequired&&(b.newTransportationCtrl.data.route="",b.newTransportationCtrl.currentRoute=null);return!1},x=function(a){return{route:a,run:{capacity:a.capacity,
customerCount:0,bookingCount:0},pk:a.pk}};b.newTransportationCtrl.routeSelectionText=function(a){var d=a.route;a=a.run;if(!b.newTransportationCtrl.canOverrideTransportation||!a.customerCount)return d.name;var c=a.customerCount.toString();null!==a.capacity&&(c+=" "+T("of")+" "+a.capacity.toString());c=interpolate(nT("(%(count)s people booked so far)","(%(count)s people booked so far)",c),{count:c});return d.name+" "+c};var w,G,M,K=function(){w=m.lodgings({shortname:b.availability.company.shortname},
null,null,null,{tagAlong:!0});G=b.newTransportationCtrl.canOverrideTransportation?m.routes({shortname:b.availability.company.shortname},null,null,null,{tagAlong:!0}):b.availability.defaultRoute?m.route({shortname:b.availability.company.shortname,routePk:b.availability.defaultRoute.pk},null,null,null,{tagAlong:!0}):[];M=b.newTransportationCtrl.canOverrideTransportation?m.runs.searchByDate({shortname:b.availability.company.shortname,date:b.availability.startAt.format("YYYY-MM-DD")},null,null,null,{tagAlong:!0}):
[];d.dataController(b,{promises:[w.$promise,G.$promise,M.$promises],successCallback:H,errorCallback:function(){b.newTransportationCtrl.status="error"}})},H=function(){b.newTransportationCtrl.status="success";b.newTransportationCtrl.lodgings=w;b.newTransportationCtrl.routes=_.isArray(G)?G:[G];b.newTransportationCtrl.routeSelections=_.map(b.newTransportationCtrl.routes,x);_.forEach(M,function(a){var d=_.find(b.newTransportationCtrl.routeSelections,function(b){return b.route===a.route});d&&(d.run=a)});
t&&v(t);b.$watch("customFieldPricing.visibility.isRequired",function(a){a&&(b.newTransportationCtrl.needsTransportation=!0)});b.$watch("newTransportationCtrl.currentLodging",function(a,d){a&&b.newTransportationCtrl.needsTransportation&&(b.newTransportationCtrl.currentRoute||z(),a!==d&&F(),a===d&&(!b.newTransportationCtrl.canOverrideTransportation&&!b.newTransportationCtrl.currentStop)&&(h(),F()))});b.$watch("newTransportationCtrl.currentRoute",function(a,b){h();a!==b&&a&&F()});b.$watch("newTransportationCtrl.needsTransportation",
function(a,d){a!==d&&(a?(b.newTransportationCtrl.currentRoute||z(),F()):(b.newTransportationCtrl.data.route="",b.newTransportationCtrl.currentRoute=null,b.newTransportationCtrl.data.stop="",b.newTransportationCtrl.currentStop=null))});b.$watch("newTransportationCtrl.data",function(){b.newTransportationCtrl.data.lodging?r.assign(b,_.stringifyJSON(l.clientRequest(b.newTransportationCtrl.data))):r.assign(b,"")},!0)};b.availability.pk&&_.isUndefined(b.availability.defaultRoute)?m.availability({shortname:b.availability.company.shortname,
itemPk:b.availability.item.pk,availabilityPk:b.availability.pk}).$promise.then(function(){K()}):K()}])})();
(function(){var h=angular.module("lib.directives",[]),b={isTouchEnabled:"ontouchstart"in window||navigator.msMaxTouchPoints,isTextInput:function(a){return a.is("input")&&_.isUndefined(a.attr("type"))||a.is('input[type="text"], input[type="password"], input[type="email"], input[type="tel"], input[type="number"], input[type="url"], input[type="search"], textarea')},bind:function(a,b,d){a.$watch(d,function(d){a[b]=d})},watcher:function(a,b,d,c,e){var f=a.$eval(b);a.$watch(b,function(a){f=a;c&&c(f)},
e);return function(){return!_.isUndefined(f)?f:d}},observer:function(a,b,d,c){var e;e=a[b];a.$observe(b,function(a){e=a;c&&c(e)});return function(){if(!_.isUndefined(e))return e;if(!_.isUndefined(d))return d;throw Error("d: undefined attribute "+b+" for observer");}},restrictKeypresses:function(a,b){a.on("keypress",function(a){if(a.which&&(!a.metaKey&&!a.controlKey&&!a.altKey)&&!(8===a.which||9===a.which||13===a.which)){var d=String.fromCharCode(a.which);b.test(d)||a.preventDefault()}})},safeInvoke:function(a,
b){return _.isArray(b)?a.invoke(b):b},conditionalDirective:function(a){a=_.extend({operator:_.constant(_.identity),link:_.constant(_.ignore),transclude:_.constant(_.ignore),once:_.never},a);return["$animate","$injector",function(d,c){return _.extend({transclude:"element",priority:800,terminal:!0,restrict:"A",compile:function(e,f,g){var r=b.safeInvoke(c,a.watch),t=b.safeInvoke(c,a.operator),v=b.safeInvoke(c,a.transclude),y=b.safeInvoke(c,_.isBoolean(a.once)?_.constant(a.once):a.once);return function(b,
c,e,f){a.link(b,c,e,f);var k,n,s=r(b,c,e,f),h=v(b,c,e,f),G=t(b,c,e,f),M=b.$watch(s,function(a){k&&(d.leave(k),k=void 0);n&&(n.$destroy(),n=void 0);G(a)&&(n=b.$new(),g(n,function(a){k=a;h(n,a);d.enter(a,c.parent(),c)}));y(b,c,e)&&M()})}}},a.directiveDescription)}]},isDropdownSupported:/iP(od|hone|ad)/i.test(window.navigator.userAgent)||/Android/i.test(window.navigator.userAgent)&&/Mobile/i.test(window.navigator.userAgent)||/BlackBerry|Windows Phone|webOS/i.test(window.navigator.userAgent)?!1:!0};h.constant("d",
b);h.config(["$provide",function(a){a.decorator("ngIfDirective",["$delegate",function(a){a.shift();return a}])}]);var a=function(a){var b=a.$modelValue;_.forEach(a.$formatters,function(a){b=a(b)});a.$viewValue=b;a.$render()},c=function(a,b){h.directive(a,[function(){return{restrict:b,priority:500,require:"form",link:function(a,b,d,c){c.$errorCallbacks=[];c.$successCallbacks=[];b.attr("novalidate","novalidate")}}}])};c("form","E");c("ngForm","A");var f=function(a,b){var d="20"+a,c=parseInt(b,10).toFixed();
if(!isNaN(c))return{month:c,year:d}},e=[{device:"MSR100U",trackSeparator:"^",fullName:function(a){var b=a.split("/");a=(b[1]||"").trim();b=(b[0]||"").trim();return a?a+" "+b:b},details:function(a){var b=/;(\d+)=(\d\d)(\d\d)/.exec(a);b||(b=/%B(\d+)=(\d\d)(\d\d)/.exec(a));if(b&&(a=b[1],b=f(b[2],b[3])))return{number:a,expiryMonth:b.month,expiryYear:b.year}}},{device:"denzer-has-a-weird-one",trackSeparator:"^",fullName:_.identity,details:function(a){var b=/;(\d+)=(\d\d)(\d\d)/.exec(a);if(b&&(a=b[1],b=
f(b[2],b[3])))return{number:a,expiryMonth:b.month,expiryYear:b.year}}},{device:"knock-off-MSR100U",trackSeparator:"",details:function(a){var b=/^(\d+)=(\d\d)(\d\d)/.exec(a);if(b&&(a=b[1],b=f(b[2],b[3])))return{number:a,expiryMonth:b.month,expiryYear:b.year}}}];h.directive("ngOverthrow",[function(){return{restrict:"A",link:function(a,b,d){b.addClass("overthrow")}}}]);h.directive("ngSticky",["$parse","$window","auth","d",function(a,b,d,c){return{restrict:"A",link:function(a,e,f){if(!a.isSet(f.ngStickyAllowTouch)&&
c.isTouchEnabled)console.info("ng-sticky: touch is enabled");else{var g=a.$eval(f.ngStickyEdgeTopMargin)||0;a.$eval(f.ngStickyEdgeBottomMargin);var l=a.$eval(f.ngStickyTopMargin)||0,y=a.$eval(f.ngStickyBottomMargin)||0,q=$(b),h=function(){var a=$(f.ngStickyContent);if(a.length){var b=d.currentUser.isAuthenticated?93:0,c=q.height()-b,m=q.scrollTop(),n=a.offset().top,a=a.outerHeight(),s=e.outerHeight();if(s>a||s>c)return e.removeClass("sticky sticky-pinned sticky-floating").css({top:"",bottom:""}),
"no-sticky";c=m+(g+b);m=n+l;n=c+s>n+a-y;a=c>m&&!n;if(c<=m)return n=l,e.removeClass("sticky-floating"),e.addClass("sticky sticky-pinned").css({top:n,bottom:""}),["sticky-pinned","top",n];if(a)return n=b+g,e.removeClass("sticky-pinned"),e.addClass("sticky sticky-floating").css({top:b+g,bottom:""}),["sticky-floating","top",n];if(n)return e.removeClass("sticky-floating"),e.addClass("sticky sticky-pinned").css({top:"",bottom:y}),["sticky-pinned","bottom",y];console.warn("ng-sticky: nothing makes sense")}},
u,z=function(){var b=h();angular.equals(u,b)||(u=b,a.$apply())};q.on("scroll",z);q.on("resize",z);a.$watch(function(){setTimeout(z)})}}}}]);h.directive("ngSwipe",[function(){return{restrict:"A",link:function(a,b,d){var c=a.$eval(d.ngSwipe),f=function(a){return _.chooseFirst(e,function(b){var d="";if(b.trackSeparator){var c=a.split(b.trackSeparator);if(3!==c.length)return;d=b.fullName(c[1]);if(_.isUndefined(d))return}else c=["","",a];b=b.details(c[2]);if(!_.isUndefined(b))return _.extend(b,{fullName:d})})};
b.on("keypress",function(d){13===d.which&&a.$apply(function(){c(f(b.val()))})});b.on("blur",function(){a.$apply(function(){c()})});b.val("");b.focus()}}}]);h.directive("ngApp",[function(){return{restrict:"A",link:function(a,b,d){$("html").removeClass("html-loading")}}}]);h.directive("ngAutoselect",["d",function(a){return{restrict:"A",link:function(b,d,c){d.attr("readonly","readonly");if(!a.isTouchEnabled){var e=!1;d.on("click",function(){d.focus();e||(d.select(),e=!0)});d.on("blur",function(){e=!1})}}}}]);
h.directive("ngAutofocus",["$timeout","d",function(a,b){var d=function(a){if(a.is("input, textarea, select"))return a;a=a.find("input, textarea, select").first();if(a.length)return a};return{restrict:"A",link:function(c,e,f){var g=c.isSet(f.ngAutofocus),t=c.isSet(f.ngAutofocusSelect),v=c.isSet(f.ngAutofocusOpen);g&&(b.isTouchEnabled?t&&a(function(){var b=d(e);if(b&&!b.is("select"))b.on("focus",function(){a(function(){b[0].setSelectionRange(0,1E3)})})}):a(function(){var a=d(e);a&&(a.hasClass("ng-dropdown")?
(a.trigger("dropdown:focus"),v&&a.trigger("dropdown:open")):(a.focus(),t&&!a.is("select")&&a.select()))}))}}}]);h.directive("ngAutoNavigate",["$location","$timeout","$window","navigation",function(a,b,d,c){return{restrict:"A",link:function(e,f,g){var t=!1;(t=g.ngAutoNavigate?e.$eval(g.ngAutoNavigate):!0)&&b(function(){var b=f.prop("href");a.$$rewrite(b)?c.navigate(b):(d.parent||window).location.href=b})}}}]);h.directive("ngCurrentOption",["$parse",function(a){return{restrict:"A",scope:!0,controller:["$scope",
"$attrs",function(b,d){var c=this,e=a(d.ngCurrentOption),f=a(d.ngCurrentOptionTarget||"currentOption"),g=a(d.ngCurrentOptionCollection),t=b.$eval(d.ngCurrentOptionKey)||"pk",v=function(a,d){var e=_.find(d,function(b){return b[t]===a});e||(e=null);f.assign(b.$parent,e);c.currentOption=e};b.$parent.$watch(e,function(a){var d=g(b);v(a,d)});b.$parent.$watch(function(){return _.pluck(g(b),"uri")},function(){var a=g(b),d=e(b);v(d,a)},!0)}],controllerAs:"currentOptionCtrl"}}]);h.directive("ngWatchHeight",
["$document","$window","db","lightframe",function(a,b,d,c){return{restrict:"A",link:function(b,d,e){var f=function(){if(a[0].body)return a[0].body.offsetHeight},k=function(a){c.updateHeight(a)};b.$watch(f,k);setInterval(function(){k(f())},2500)}}}]);h.directive("ngDimensions",["$document","$parse","$window","$rootScope","scrollbar",function(a,b,d,c,e){var f=function(){return{width:Math.max(a[0].documentElement.clientWidth,d.innerWidth||0),height:Math.max(a[0].documentElement.clientHeight,d.innerHeight||
0)}},g=function(a){return{width:a.width(),height:a.height(),outerWidth:a.outerWidth(),outerHeight:a.outerHeight()}};return{restrict:"A",link:function(a,c,l){if(!l.ngDimensionsWhen||a.$eval(l.ngDimensionsWhen)){var n=a.isSet(l.ngDimensionsViewport)?f:_.bind(g,null,c);c=b(l.ngDimensions||"dimensions");var h=n();c.assign(a,h);var u=Math.max(e.getWidth(),15);c=function(){var b=n();if(!(b.width===h.width&&b.height===h.height)){var d=h.width-b.width;0<d&&d<=u||(_.extend(h,b),a.$digest())}};var z=_.debounce(c,
0),C=_.debounce(c,250);a.$watch(z);$(d).on("resize",C);a.$on("$destroy",function(){$(d).off("resize",C);z.cancel();C.cancel()})}}}}]);h.directive("ngStyleOnce",[function(){return{restrict:"A",link:function(a,b,d){b.css(a.$eval(d.ngStyleOnce))}}}]);c=function(a){h.directive(a.name,[function(){return{restrict:"A",link:function(b,d,c){var e=a.transform||_.identity,f=a.isNumeric&&!_.isUndefined(c[a.name+"AddToInitial"]),g=function(){var e=b.$eval(c[a.name+"Selector"]);return e?$(e):d},t=c[a.name+"ForceInitialValue"]?
b.$eval(c[a.name+"ForceInitialValue"]):g().css(a.property);a.isNumeric&&(t=parseInt(t,10));if(_.isUndefined(t)||_.contains(a.emptyValues,t))t="";var v=function(b){b?(f&&t&&(b+=t),g().css(a.property,e(b))):g().css(a.property,t)};a.interpolate?c.$observe(a.name,v):b.$watch(c[a.name],v);b.$on("$destroy",function(){v()})}}}])};c({name:"ngBackgroundImage",property:"background-image",transform:function(a){return"url("+(-1===a.indexOf("Cdn")?a.replace("Url","CdnUrl"):a)+")"},emptyValues:["none"]});c({name:"ngBackgroundColor",
property:"background-color",emptyValues:["rgba(0, 0, 0, 0)","transparent"]});c({name:"ngTop",property:"top",isNumeric:!0});h.directive("ngLocation",[function(){return{restrict:"A",link:function(a,b,d){var c=function(){var a={width:b[0].offsetWidth,height:b[0].offsetHeight},d;try{d=b.position()}catch(e){d={top:0,left:0}}a={position:d,size:a};c.position=a.position;c.size=a.size;return a};a[d.ngLocation]=c}}}]);h.directive("ngScrollStatic",["$window",function(a){return{restrict:"A",link:function(b,d,
c){var e=c.ngScrollStaticContainer||"html,body",f=!c.ngScrollStaticContainer,g=b.$eval(c.ngScrollStaticPadding)||0;(function(){var b=c.ngScrollStatic,d=$(e),b=d.find(b);if(b.length&&d.length){var b=_.min(_.map(b,function(a){return $(a).position().top||0})),k=_.chooseFirst(d,function(a){if(a.scrollHeight)return a.scrollHeight})||0,m=_.min(_.choose(d,function(a){if(a=$(a).height())return a}));f&&(m=Math.min(m,a.innerHeight));k=Math.max(0,k-m);b-=g;0>b?b=0:b>k&&(b=k);d.scrollTop(b)}})()}}}]);h.directive("ngScrollTo",
["$window",function(a){return{restrict:"A",link:function(b,d,c){var e=b.isSet(c.ngScrollOnClick),f=b.isSet(c.ngScrollSmooth),g=b.isSet(c.ngScrollForce),t=c.ngScrollContainer||"html,body",v=!c.ngScrollContainer,y=function(){var b=c.ngScrollTo;if(b){"top"===b&&(b="body");var d=$(b),b=$(t);if(d.length&&b.length){var d=Math.min.apply(Math,_.map(d,function(a){return $(a).offset().top||0})),e=_.chooseFirst(b,function(a){if(a=$(a).scrollTop())return a})||0,k=_.chooseFirst(b,function(a){if(a.scrollHeight)return a.scrollHeight})||
0,m=Math.min.apply(Math,_.choose(b,function(a){if(a=$(a).height())return a}));v&&(m=Math.min(m,a.innerHeight));var k=Math.max(0,k-m),e=1>Math.abs(d-e),s;0>d?(s=15,d=0):e?s=d-15:d>k&&(s=k-15,d=k);k&&(g&&!_.isUndefined(s)?b.stop().animate({scrollTop:s},250,"swing").animate({scrollTop:d},250,"swing"):f?b.stop().animate({scrollTop:d},500,"swing"):b.scrollTop(d))}}};if(e)d.on("click",function(a){y()});else y()}}}]);h.directive("ngTopScrolled",["$document",function(a){return{restrict:"A",link:function(b,
d,c){b=b.$eval(c.ngTopScrolled)||0;b=a.scrollTop()+b;d.css({top:b})}}}]);h.directive("ngWithLocation",[function(){return{restrict:"A",link:function(a,b,d){a.$watch(d.ngWithLocation,function(c){b.toggleClass("with-location",!!c);if(c){var e=0,f=0;if(d.ngWithLocationOffset)var g=a.$eval(d.ngWithLocationOffset)||{},e=g.x||e,f=g.y||f;g=a.$eval(d.ngWithLocationRight)||!1;f={top:c.position.top+f};f.left=g?c.position.left+-b[0].offsetWidth+e:c.position.left+c.size.width+e;b.toggleClass("left",!g);b.toggleClass("right",
g);b.css(f)}})}}}]);h.directive("ngTranslate",["$window","translate",function(a,b){return{restrict:"A",link:function(a,d){b.initialize(d)}}}]);var g=function(a){return a&&!_.isUndefined(a.x)&&!_.isUndefined(a.y)&&a.width&&a.height};h.directive("ngImage",["$parse",function(a){var b=function(a){return _.map(a,function(a,b){return b+"="+a.toString()}).join("&")};return{restrict:"A",compile:function(d,c){var e=a(c.ngImage),f=_.isUndefined(c.ngImageOnce)?_.always:""===c.ngImageOnce?_.always:a(c.ngImageOnce);
return function(a,d,c){var k=function(e){if(e){var f=a.$eval(c.ngImageCrop),k=a.$eval(c.ngImageSquare),l=a.$eval(c.ngImageMaxWidth),n=a.$eval(c.ngImageMaxHeight),s=a.$eval(c.ngImageMaxSize),p=a.$eval(c.ngImageWidth),q=a.$eval(c.ngImageHeight),y=a.$eval(c.ngImageFilter),h=a.$eval(c.ngImageFilterAmount),H=["blur","sharpen"],L={cache:!0,compress:!0,quality:90};g(f)&&_.extend(L,{crop:f.x.toFixed(0)+","+f.y.toFixed(0)+","+f.width.toFixed(0)+","+f.height.toFixed(0)});k&&_.extend(L,{w:k,h:k,fit:"crop"});
l&&_.extend(L,{w:l,fit:"max"});n&&_.extend(L,{h:n,fit:"max"});s&&_.extend(L,{w:s,h:s,fit:"max"});p&&_.extend(L,{w:p});q&&_.extend(L,{h:q});y&&(-1!==_.indexOf(H,y)&&h)&&(L.filter=y,L[y+"Amount"]=h);_.startsWith(e,"https://fh-sites.imgix.net")||(e=e+"/convert?"+b(L));d.is("img")?d.attr("src",e):d.css("background-image","url("+e+")");return e}console.info("ng-image: no url supplied")};if(f()){var l=k(e(a));console.info("ng-image: once",l)}else a.$watch(e,function(a){a=k(a);console.info("ng-image: watch",
a)})}}}}]);h.directive("ngCrop",["$parse","$timeout",function(a,b){return{restrict:"A",require:"^form",link:function(d,c,e,f){c.attr("src",d.$eval(e.ngCrop));var r=d.$eval(e.ngCropAspectRatio)||1.9,t=a(e.ngCropModel),v=function(a){d.$safeApply(function(){var b=t(d),e=c[0].naturalWidth/c.width();b.x=Math.floor(a.x*e);b.y=Math.floor(a.y*e);b.width=Math.floor(a.w*e);b.height=Math.floor(a.h*e);f.$setDirty()})},y,q=function(){c.Jcrop({onSelect:v,keySupport:!1,aspectRatio:r},function(){y=this;var a=t(d),
b=c[0].naturalWidth/c.width();if(g(a))var e=Math.floor(a.x/b),f=Math.floor(a.y/b),l=e+Math.floor(a.width/b),a=f+Math.floor(a.height/b);else f=y.getWidgetSize(),e=f[0],f=f[1],e/r<f?(l=e,a=e/r,e=0,f=(f-a)/2):(l=f*r,a=f,e=(e-l)/2,f=0),e=Math.floor(e),f=Math.floor(f),l=e+Math.floor(l),a=f+Math.floor(a);y.setSelect([e,f,l,a])})};b(function(){q();d.$on("$destroy",function(){y&&y.destroy()})})}}}]);h.directive("ngAudio",[function(){return{restrict:"A",link:function(a,b,d){var c=d.ngAudioSrc,e;a[d.ngAudio]=
function(){e||(e=$('<audio><source src="'+c+'"></audio>'),b.append(e));e[0].load();e[0].play()};a.$on("$destroy",function(){e&&e.remove()})}}}]);h.directive("ngTip",["$parse","$sanitize","d",function(a,b,d){var c;return{restrict:"A",link:function(e,f,g){var t=g.ngTipLocation,v=g.ngTipWhen?a(g.ngTipWhen):_.always,y=$("body"),q=g.ngTipPosition;if(!d.isTouchEnabled||e.$eval(g.ngTipTouch)){c||(c=$('<span class="tip" aria-live="polite"></span>'),y.append(c));var h=function(){var a=f.attr("class")||"",
a=a.split(" "),a=_.choose(a,function(a){if(a)return"tip-ele--"+a});return a=a.join(" ")},u=function(){var a=f;if(t&&(a=f.find(t),!a.length))return;if(v(e)){var d=q?"tip-"+q:"";c.attr("class","tip").addClass(F()+" "+h()+" "+d);c.html(b(C()));c.css({width:"auto"});var d=a.offset(),k=a.outerWidth();0===k&&a[0]instanceof SVGElement&&(k=a[0].getBoundingClientRect().width);var g=c.outerWidth(),l=c.outerHeight(),r=parseInt(y.css("top"),10)||0,u={};if("right"===q||"left"===q)a=a.outerHeight(),u.top=Math.floor(d.top+
a/2-l/2)-r;"right"===q?u.left=d.left+k+8:"left"===q?u.left=d.left-g-8:(u.top=Math.floor(d.top-l-8-r),u.left=Math.floor(Math.max(d.left+(k-g)/2,0)));c.css(u);c.addClass("showing")}},z=function(){c.attr("class","tip");c.css({top:-100,left:-100})},C=d.observer(g,"ngTip",""),F=d.observer(g,"ngTipClasses","");f.on("mouseenter",u);f.on("mouseleave",z);f.on("retip",function(){window.setTimeout(function(){if(e.$root){var a=c.hasClass("showing");z();a&&u()}})});e.$on("$destroy",z)}}}}]);h.directive("ngRadioFlyer",
[function(){return{link:function(a,b,d){var c=function(a){b.find('input[type="radio"]').each(function(){var b=$(this),d=_.isUndefined(a)?b.is(":checked"):b.val()===a;b.closest("label").toggleClass("radio-selected",d)})};d.ngRadioFlyer?a.$watch(d.ngRadioFlyer,function(a){c(a)}):a.$watch(function(){c()});a.$evalAsync(function(){c()})}}}]);h.directive("ngCheckboxMadness",[function(){return{require:"ngModel",link:function(a,b,d){a.$watch(d.ngModel,function(a){b.closest(".field").toggleClass("checkbox-selected",
!!a)})}}}]);h.directive("ngSupportHacks",_.optional(["d","events","?native",function(a,b,d){return{restrict:"A",link:function(c){var e=$("html");e.addClass(a.isTouchEnabled?"touch":"not-touch");e.addClass(d&&d.isNative?"native":"not-native");b.on(c,"fareharbor.native.inApp",function(a,b){e.addClass("native").removeClass("not-native")})}}}]));h.directive("ngBlurEscape",["$document","d",function(a,b){return{restrict:"A",link:function(d,c,e){a.on("keydown",function(a){if(27===a.which){var d=$(a.target);
b.isTextInput(d)&&(a.preventDefault(),a.stopPropagation(),d.trigger("blur"))}})}}}]);h.directive("ngShortcut",["$parse","navigation","shortcuts",function(a,b,d){return{restrict:"A",compile:function(c,e){var f=a(e.ngShortcut),g=e.ngShortcutAction?a(e.ngShortcutAction):_.ignore;return function(a,c,e){var l=f(a);if(!_.isUndefined(l)){var l=l.split("|"),n=_.ignore;a.isSet(e.ngShortcutClick)&&(n=_.then(n,function(){c.trigger("click")}));a.isSet(e.ngShortcutFocus)&&(n=_.then(n,function(){c.is("input, textarea, select")?
setTimeout(function(){c.trigger("focus")}):c.find("input, textarea").first().trigger("focus")}));if(e.ngShortcutNavigate)var s=a.$interpolate(e.ngShortcutNavigate),n=_.then(n,function(){a.$apply(function(){b.navigate(s)})});e.ngShortcutAction&&(n=_.then(n,function(){a.$apply(function(){g(a)})}));a.isSet(e.ngShortcutOnly)&&c.addClass("ng-hide");_.forEach(l,function(b){var c=d.register({keySet:b,action:n,description:e.ngShortcutDescription||""});a.$on("$destroy",function(){d.unregister(c)})})}}}}}]);
h.directive("ngUnclick",["$parse",function(a){return{restrict:"A",link:function(b,d,c){var e=a(c.ngUnclick),f=function(a){$(a.target).closest("[ng-unclick], [ng-unclick-ignore]").length||e(b)};$("html").on("click",f);b.$on("$destroy",function(){$("html").off("click",f)})}}}]);h.directive("ngGenericForm",[function(){return{link:function(a,b,d){a[d.ngGenericForm]={}}}}]);h.directive("ngSortable",[function(){return{restrict:"A",link:function(a,b,d){var c=a.$eval(d.ngSortable)||_.ignore,e=d.ngSortableHandle||
".sortable-handle",f=d.ngSortableSelector||"li.sortable",g='<li class="sortable sortable-placeholder"></li>';a.$eval(d.ngSortableTable)&&(g='<tbody class="sortable"><tr><td style="height: 50px"></td></tr></tbody>');d={itemSelector:f,placeHolderTemplate:g,dragEnd:function(b,d){var e=$(this),f=$(b),k=$(d),g=e.data("ng-sortable-item"),m=f.data("ng-sortable-item"),s=k.data("ng-sortable-item");g===s&&(s=null);g===m&&(m=null);return a.$apply(function(){return c(g,m,s)})}};e&&(d.dragSelector=e,d.dragSelectorExclude=
"input, textarea");b.dragsort(d);a.$on("$destroy",function(){b.dragsort("destroy")})}}}]);h.directive("ngSortableItem",[function(){return{restrict:"A",link:function(a,b,d){if(a=a.$eval(d.ngSortableItem))b.data("ng-sortable-item",a),b.addClass("sortable")}}}]);h.directive("ngDropdown",["$interpolate","$parse","$sanitize","d",function(a,b,d,c){var e=/^\s*([\s\S]+?)(?:\s+as\s+([\s\S]+?))?(?:\s+group\s+by\s+([\s\S]+?))?\s+for\s+(?:([\$\w][\$\w]*)|(?:\(\s*([\$\w][\$\w]*)\s*,\s*([\$\w][\$\w]*)\s*\)))\s+in\s+([\s\S]+?)(?:\s+track\s+by\s+([\s\S]+?))?$/,
f=/^\s*([\s\S]+?)(?:\s+as\s+([\s\S]+?))?(?:\s+hide\s+when\s+([\s\S]+?))?(?:\s+disable\s+when\s+([\s\S]+?))?\s+for\s+(?:([\$\w][\$\w]*)|(?:\(\s*([\$\w][\$\w]*)\s*,\s*([\$\w][\$\w]*)\s*\)))\s+in\s+([\s\S]+?)?$/,g=T("Choose an option"),t={errorLoading:_.constant(T("The results could not be loaded")),inputTooLong:function(a){a=a.input.length-a.maximum;return interpolate(nT("Please delete %(count)s character","Please delete %(count)s characters",a),{count:a})},inputTooShort:function(a){a=a.minimum-a.input.length;
return interpolate(nT("Please enter %(count)s or more character","Please enter %(count)s or more characters",a),{count:a})},loadingMore:_.constant(T("Loading more results...")),maximumSelected:function(a){return interpolate(nT("You can only select %(count)s item","You can only select %(count)s items",a.maximum),{count:a.maximum})},noResults:_.constant(T("No results found")),searching:_.constant(T("Searching..."))};return{restrict:"A",require:"ngModel",compile:function(v,y){var q,h,u,z,C,F,x,w,G,M,
K;if(y.ngDropdownRemoteOptions){M="remote-options-mode";q=y.ngDropdownRemoteOptions.match(f);if(!q){console.error("ngDropdown: malformed ngDropdownRemoteOptions expression.");return}C=b(q[2]||q[1]);x=q[3]?b(q[3]):null;w=q[4]?b(q[4]):null;h=q[6];u=q[5]||q[7];z=b(q[2]?q[1]:u);F=b(q[8]);K=y.ngDropdownMinimum?b(y.ngDropdownMinimum):_.constant(2)}else if(y.ngOptions){M="ng-options-mode";q=y.ngOptions.match(e);if(!q){console.error("ngDropdown: ng-options regex must match angular.");return}h=q[5];u=q[4]||
q[6];G=b(q[7])}else{console.error("ngDropdown: ngDropdownRemoteOptions or ngOptions required.");return}var H="ng-options-mode"===M&&!c.isDropdownSupported,L=a(y.ngPlaceholder||g),E=y.ngPlaceholderValue?b(y.ngPlaceholderValue):_.constant(null),N=y.ngDropdownCurrentOption&&b(y.ngDropdownCurrentOption),I=y.ngDropdownAllowClear&&b(y.ngDropdownAllowClear),D=b(y.ngModel);q=$("<option class='empty-option' value='' label=''></option>");v.prepend(q);H?v.closest(".the-field").addClass("ng-dropdown-disabled"):
(v.css("width","100%"),v.addClass("ng-dropdown"));return function(a,b,c,e){var f=!I||I(a);if(H&&!f)var g=a.$watch(c.ngModel,function(a){""!==b.val()&&(b.find(".empty-option").remove(),g())});var l=E(a);e.$parsers.push(function(a){return null===a?l:a});if(!H){var m,f={language:t,minimumResultsForSearch:8,allowClear:f,placeholder:L(a)},n={};f.templateResult=function(a){var b=$("<span>"+d(a.text)+"</span>");a=n[a.id];_.isObject(a)&&a.classes&&b.addClass(a.classes);return b};var s={},r=function(b,d,c){if(!b)return null;
h&&(s[h]=c);s[u]=d;return b(a,s)};if("remote-options-mode"===M){var p=F(a),v=function(a,b){return{id:a.uri||a.pk.toString(),text:r(C,a,b),disabled:r(w,a,b),ngModelValue:r(z,a,b),originalValue:a}};f.minimumInputLength=K(a);f.ajax={delay:250,transport:function(a,b,d){var c=p(a.data.term);c.$promise.then(function(){b(c)},function(){d(c)});return{abort:c.$promise.cancel}},processResults:function(a){n={};var b=[];_.forEach(a,function(a,d){if(!r(x,a,d)){var c=v(a,d);b.push(c);n[c.id]=c.ngModelValue}});
return{results:b}}};e.$parsers.unshift(function(a){return n[a]||null})}else if("ng-options-mode"===M){e={"default":function(){var b=G(a);if(_.isArray(b))if(b.length)if(_.isUndefined(b[0].label))if(_.isUndefined(b[0].uri))if(_.isUndefined(b[0].pk)){if(_.isString(b[0]))return b}else return _.pluck(b,"pk");else return _.pluck(b,"uri");else return _.pluck(b,"label");else return b;else if(_.isObject(b))return _.keys(b)},uri:function(){var b=G(a);return _.pluck(b,"uri")},pk:function(){var b=G(a);return _.pluck(b,
"pk")}}[a.$eval(c.ngDropdownWatchType)||"default"];var q=function(){window.setTimeout(function(){b.trigger("change.select2")})};a.$watch(e,function(){n=_.indexBy(G(a),function(a,b){return b.toString()});m.dataAdapter.destroy();q()},!0);a.$watch(c.ngModel,q)}e=b.closest(".ng-dropdown-context");e.length&&(f.dropdownParent=e);_.forEach(["open","focus"],function(a){b.bind("dropdown:"+a,function(){b.select2(a)})});a.$watch(c.ngDisabled,function(a){b.attr("disabled",!!a)});a.$watch(function(){return!!b.parents("fieldset[disabled]").length},
function(a){b.attr("disabled",a)});a.$on("$destroy",function(){m.destroy()});b.select2(f);m=b.data("select2");"remote-options-mode"===M&&N&&(a.$watch(N,function(a){if(!_.isUndefined(a)){var b=[];a&&b.push(v(a));m.trigger("selection:update",{data:b})}}),a.$watch(D,function(b){b||N.assign(a,null)}),m.on("select",function(b){a.$apply(function(){N.assign(a,b.data.originalValue)})}))}}}}}]);h.directive("ngIf",b.conditionalDirective({watch:["$parse",function(a){return function(b,d,c){var e=a(c.ngIf);return function(){return!!e(b)}}}],
operator:function(a,b,d){return function(b){d.ngThen&&(a[d.ngThen]=b);return b}}}));h.directive("ngIfOnce",b.conditionalDirective({watch:["$parse",function(a){return function(b,d,c){var e=a(c.ngIfOnce);return function(){return!!e(b)}}}],operator:function(a,b,d){return function(b){d.ngThen&&(a[d.ngThen]=b);return b}},once:!0}));h.directive("ngIfInLabs",b.conditionalDirective({watch:["labs",function(a){return function(b,d,c){return function(){var d=c.ngIfInLabs.replace("!",""),e=c.ngIfInLabsVariation,
f=0===c.ngIfInLabs.indexOf("!"),d=a.isInVariation(d,e);c.ngThen&&(b[c.ngThen]=d);return f?!d:d}}}]}));h.directive("ngElse",b.conditionalDirective({watch:["$parse",function(a){return function(b,d,c){var e=a(c.ngElse);return function(){return!e(b)}}}]}));h.directive("ngElseOnce",b.conditionalDirective({watch:["$parse",function(a){return function(b,d,c){var e=a(c.ngElseOnce);return function(){return!e(b)}}}],once:!0}));h.directive("ngWatch",b.conditionalDirective({watch:["$parse",function(a){return function(b,
d,c){return a(c.ngWatch)}}],operator:_.constant(_.always),transclude:["$parse",function(a){return function(b,d,c){var e=a(c.ngWatchAction)||_.ignore;return function(){e(b)}}}]}));h.directive("ngInterval",[function(){return{link:function(a,b,d){b=a.$eval(d.ngInterval)||1;var c=setInterval(function(){a.$digest()},1E3*b);a.$on("$destroy",function(){clearInterval(c)})}}}]);h.directive("ngData",["$q",function(a){return{scope:!0,transclude:!0,templateUrl:"ng-data",controllerAs:"dataCtrl",controller:["$scope",
"$attrs",function(b,d){var c=this;c.status="loading";b.isSet(d.ngDataSmall)?c.type="small":b.isSet(d.ngDataManual)?c.type="manual":c.type="large";c.transcludeOnError="transclude"===(d.ngDataOnError||"");var e=b.$eval(d.ngData);if(_.isUndefined(e))c.status="success";else{var f=_.isArray(e);if(!f&&(!_.isObject(e)||!_.isFunction(e.then)))c.status="success";else{f&&(e=a.all(e));var g=b.$eval(d.ngDataStale);if(!_.isUndefined(g)&&(g=f?g:[g],!_.any(g,"$fresh"))){c.status="success";return}e.then(function(){c.status=
"success"},function(){c.status="error"})}}}]}}]);h.config(["$provide",function(a){a.decorator("ngShowDirective",["$delegate",function(a){a.shift();return a}])}]);h.directive("ngShow",["$parse",function(a){return{restrict:"A",compile:function(b,d){var c=a(d.ngShow);return function(a,b,d){a.$watch(c,function(c){b.toggleClass("ng-hide",!c);d.ngThen&&(a[d.ngThen]=c)})}}}}]);h.directive("ngShowOnce",["$parse",function(a){return{restrict:"A",compile:function(b,d){var c=a(d.ngShowOnce);return function(a,
b,d){var e=c(a);b.toggleClass("ng-hide",!e);d.ngThen&&(a[d.ngThen]=e)}}}}]);h.config(["$provide",function(a){a.decorator("ngHideDirective",["$delegate",function(a){a.shift();return a}])}]);h.directive("ngHideOnce",["$parse",function(a){return{restrict:"A",compile:function(b,d){var c=a(d.ngHideOnce);return function(a,b,d){var e=!!c(a);b.toggleClass("ng-hide",e);d.ngThen&&(a[d.ngThen]=e)}}}}]);h.directive("ngHide",["$parse",function(a){return{restrict:"A",compile:function(b,d){var c=a(d.ngHide);return function(a,
b,d){a.$watch(c,function(c){c=!!c;b.toggleClass("ng-hide",c);d.ngThen&&(a[d.ngThen]=c)})}}}}]);h.directive("ngAutoExporter",["$interpolate","autoExport",function(a,b){return{scope:!0,templateUrl:"auto-exporter",replace:!0,compile:function(d,c){var e=a(c.ngAutoExporter),f=a(c.ngAutoExporterFilename);return function(a,d,c){a.autoExport=b;a.isLeft=a.isSet(c.ngAutoExporterLeft);a.$watch(e,function(b){a.namespace=b});a.$watch(f,function(b){a.filename=b})}}}}]);h.directive("ngAutoExportValue",[function(){return{restrict:"A",
compile:function(a,b){var d=b.ngAutoExportValue||"";b.$set("ngAutoExportValue","");return function(a,b,c){b.data("ngAutoExportValue",function(){return a.$interpolate(d)})}}}}]);h.directive("ngAutoExportSkip",["$parse",function(a){return{restrict:"A",compile:function(b,d){var c=a(d.ngAutoExportSkip||"true");return function(a,b,d){b.data("ngAutoExportSkip",_.bind(c,null,a))}}}}]);h.directive("ngAutoExportOnly",["$parse",function(a){return{restrict:"A",compile:function(b,d){if(d.ngAutoExportOnly){var c=
a(d.ngAutoExportOnly);return function(a,b,d){a.$watch(c,function(a){b.toggleClass("ng-hide",a)})}}b.addClass("ng-hide")}}}]);h.directive("ngAutoExport",["$interpolate","$parse","autoExport",function(a,b,d){return{restrict:"A",scope:!0,compile:function(c,e){var f=a(e.ngAutoExport),g=e.ngAutoExportProcess?b(e.ngAutoExportProcess):null;return function(a,b){var c=f(a),l={isCSS:a.isSet(e.ngAutoExportCss),tableSelector:e.ngAutoExportTable,rowSelector:e.ngAutoExportRow,cellSelector:e.ngAutoExportCell};g&&
(l.process=_.bind(g,null,a));var m=d.addExport(c,b,l);a.$on("$destroy",function(){d.removeExport(m)})}}}}]);h.directive("ngTableFilters",["$parse","$rootScope","require",function(a,b,d){return{restrict:"A",scope:!0,controller:function(){var a=this;a.ignore=null;a.filters=[];a.addFilter=function(b){d.assert(b.type,"ng-table-filter: expected filter description to include type");d.assert(b.filter,"ng-table-filter: expected filter description to include filter");a.filters.push(b);y(b)};a.removeFilter=
function(b){l(b);_.overwriteWithout(a.filters,b)};a.reset=function(){_.forEach(a.filters,function(a){a.resetValue()});a.update()};a.isFiltering=function(b){return _.any(_.map(a.filters,function(a){return a.isFiltering()}))};var c=function(b,d){for(var c=[],e=a.filters.length,f,g,k,l=0,m=d.length;l<m;l++){g=d[l];f=!0;if(g&&g!==a.ignore)for(var s=0;s<e;s++)if(k=a.filters[s],k.isFiltering()&&!k.filter(g)){f=!1;break}f&&c.push(g)}_.overwrite(b,c);b.filtered=d.length-c.length},e={},f={};a.update=function(){console.info("ng-table-filters: filtering collections");
_.forEach(e,function(a,b){c(f[b],a)});l()};a.debouncedUpdate=_.debounce(function(){b.$apply(function(){a.update()})},500);a.addCollection=function(a,b){e[a.$id]=b||[];var d=f[a.$id];_.isUndefined(d)&&(d=f[a.$id]=[]);c(d,e[a.$id]);return d};a.removeCollection=function(a){delete e[a.$id];delete f[a.$id]};var g={},l=function(b){g&&(_.isUndefined(b)?_.forEach(a.filters,function(a){l(a)}):!_.isUndefined(b.identifier)&&!_.isUndefined(b.value)&&(g[b.identifier]=b.value))},y=function(b){if(g)if(_.isUndefined(b))_.forEach(a.filters,
y);else if(!_.isUndefined(b.identifier)){var d=g[b.identifier];_.isUndefined(d)?b.resetValue():b.value=d}};a.updateModel=function(b){l();g=b||{};y();a.update();return g};a.storeModel=function(){l();return g}},compile:function(b,d){var c=d.ngTableFilters?a(d.ngTableFilters):null,e=d.ngTableFiltersModel?a(d.ngTableFiltersModel):null,f=d.ngTableFiltersIgnore?a(d.ngTableFiltersIgnore):null;return{pre:function(a,b,d,g){a.$tableFilters=g;e&&a.$watch(e,function(b){e.assign(a,g.updateModel(b))});c&&a.$watchCollection(c,
function(b){a.$collection=g.addCollection(a,b)});f&&a.$watch(f,function(a){g.ignore=a;g.update()})}}}}}]);h.directive("ngTableFilter",["$compile","$parse","$templateCache",function(a,b,d){return{restrict:"A",require:["^ngTableFilters","ngTableFilter"],scope:!0,controller:function(){this.name="";this.isFiltering=_.never;this.filter=_.always},compile:function(c,e){var f=d.get(e.ngTableFilterTemplate||"tableFilter.filter");if(f){var g=a(f),t=e.ngTableFilterIdentifier?b(e.ngTableFilterIdentifier):null;
return{pre:function(a,b,d,c){var e=c[0],f=c[1];a.$tableFilter=f;f.reset=function(){f.resetValue();e.update()};f.name=f.identifier=d.ngTableFilter;t&&(f.identifier=t(a));d.$observe("ngTableFilter",function(a){f.name=a});b.addClass("ng-table-filter");a.$watch(function(){return f.isFiltering()},function(a){b.toggleClass("filtering",a)});g(a,function(a){b.append(a)})},post:function(a,b,d,c){var e=c[0],f=c[1];e.addFilter(f);a.$on("$destroy",function(){e.removeFilter(f)})}}}console.error("ng-table-filter-filter: template not found")}}}]);
h.directive("ngTableFilterString",["$parse",function(a){return{restrict:"A",require:["^ngTableFilters","ngTableFilter"],compile:function(b,d){var c=a(d.ngTableFilterString);return{post:function(a,b,d,e){var f=e[0],g=e[1];g.type="string";g.value="";g.resetValue=function(){g.value=""};var k="";g.isFiltering=function(){k=g.value.toLowerCase();return!!k};g.filter=function(b){return 0<=(c(a,{$row:b})||"").toLowerCase().indexOf(k)};a.$watch(function(){return g.value},function(){f.debouncedUpdate()})}}}}}]);
h.directive("ngTableFilterDate",["$parse",function(a){return{restrict:"A",require:["^ngTableFilters","ngTableFilter"],compile:function(b,d){var c=a(d.ngTableFilterDate);return{pre:function(a,b,d,e){var f=e[0],g=e[1];g.operations=[{name:T("Before"),value:"before"},{name:T("On"),value:"on"},{name:T("After"),value:"after"}];var k={},l;k.on=function(b){return(b=c(a,{$row:b})||0)?0===b.diff(l,"days"):!1};k.before=function(b){return(b=c(a,{$row:b})||0)?0>b.diff(l,"days"):!1};k.after=function(b){return(b=
c(a,{$row:b})||0)?0<b.diff(l,"days"):!1};g.type="date";g.value={operation:"on",date:""};g.resetValue=function(){g.value.date=""};g.isFiltering=function(){l=g.value.date?moment(g.value.date,"YYYY-MM-DD"):null;return!!l};g.filter=k[g.value.operation];a.$watch(function(){return g.value.operation},function(a){g.filter=k[a];f.debouncedUpdate()});a.$watch(function(){return g.value.date},function(){f.debouncedUpdate()})}}}}}]);h.directive("ngTableFilterAmount",["$parse",function(a){return{restrict:"A",require:["^ngTableFilters",
"ngTableFilter"],compile:function(b,d){var c=a(d.ngTableFilterAmount);return{pre:function(a,b,d,e){var f=e[0],g=e[1];g.operations=[{name:T("is"),value:"equal"},{name:T("less than"),value:"less-than"},{name:T("greater than"),value:"greater-than"}];var k={equal:function(b){return(c(a,{$row:b})||0)===g.value.amount},"less-than":function(b){return(c(a,{$row:b})||0)<g.value.amount},"greater-than":function(b){return(c(a,{$row:b})||0)>g.value.amount}};g.type="amount";g.value={operation:"greater-than",amount:""};
g.resetValue=function(){g.value.amount=""};g.isFiltering=function(){return""!==g.value.amount};g.filter=k[g.value.operation];a.$watch(function(){return g.value.operation},function(a){g.filter=k[a];f.debouncedUpdate()});a.$watch(function(){return g.value.amount},function(){f.debouncedUpdate()})}}}}}]);h.directive("ngTableFilterNumber",["$parse",function(a){return{restrict:"A",require:["^ngTableFilters","ngTableFilter"],compile:function(b,d){var c=a(d.ngTableFilterNumber);return{pre:function(a,b,d,
e){var f=e[0],g=e[1];g.operations=[{name:T("is"),value:"equal"},{name:T("less than"),value:"less-than"},{name:T("greater than"),value:"greater-than"}];var k={equal:function(b){return(c(a,{$row:b})||0)===g.value.number},"less-than":function(b){return(c(a,{$row:b})||0)<g.value.number},"greater-than":function(b){return(c(a,{$row:b})||0)>g.value.number}};g.type="number";g.value={operation:"greater-than",number:""};g.resetValue=function(){g.value.number=""};g.isFiltering=function(){return""!==g.value.number};
g.filter=k[g.value.operation];a.$watch(function(){return g.value.operation},function(a){g.filter=k[a];f.debouncedUpdate()});a.$watch(function(){return g.value.number},function(){f.debouncedUpdate()})}}}}}]);h.directive("ngTableFilterChoice",["$parse",function(a){return{restrict:"A",require:["^ngTableFilters","ngTableFilter"],compile:function(b,d){var c=a(d.ngTableFilterChoice),e=a(d.ngTableFilterChoices),f=a(d.ngTableFilterChoiceName||"$choice.name"),g=a(d.ngTableFilterChoiceValue||"$choice.pk");
return{pre:function(a,b,d,k){var l=k[0],m=k[1];m.choiceValue=function(b){return g(a,{$choice:b})};m.choiceName=function(b){return f(a,{$choice:b})};b=e(a);var h=_.map(b,function(a){return m.choiceValue(a)});m.type="choices";m.choices=b;m.value={};m.resetValue=function(){_.forEach(h,function(a){m.value[a]=!1})};m.resetValue();m.isFiltering=function(){return _.any(_.values(m.value))};m.filter=function(b){var d=c(a,{$row:b})||!1;if(_.isArray(d)){for(var e=0,f=d.length;e<f;e++)if(b=m.choiceValue(d[e]),
0<=h.indexOf(b)&&m.value[b])return!0;return!1}b=m.choiceValue(d);return 0<=h.indexOf(b)?m.value[b]:!1};a.$watch(function(){return m.value},function(){l.debouncedUpdate()},!0)}}}}}]);h.directive("ngTableFilterYesno",["$parse",function(a){return{restrict:"A",require:["^ngTableFilters","ngTableFilter"],compile:function(b,d){var c=a(d.ngTableFilterYesno);return{pre:function(a,b,d,e){var f=e[0],g=e[1],k=g.ANY="any";g.type="yesno";g.value=k;g.resetValue=function(){g.value=k};g.isFiltering=function(){return g.value!==
k};g.filter=function(b){return(c(a,{$row:b})||!1)===g.value};a.$watch(function(){return g.value},function(){f.debouncedUpdate()})}}}}}]);h.directive("ngTableFilterView",["$compile","$templateCache",function(a,b){var d={};return{require:"^ngTableFilter",link:{pre:function(c,e,f,g){f="tableFilter.filters."+g.type;var t=d[f];if(!t){t=b.get(f);if(!t){console.warn("ng-table-filter-view: invalid or custom type",g.type);e.remove();return}t=d[f]=a(t)}t(c,function(a){e.append(a)})}}}}]);h.directive("ngTables",
[function(){return{restrict:"A",scope:!0,controllerAs:"tablesCtrl",controller:function(){var a=this;a.tables=[];a.predicate=null;a.addTable=function(b){_.contains(a.tables,b)||a.tables.push(b)};a.removeTable=function(b){_.overwriteWithout(a.tables,b)};a.toggle=function(b){a.predicate=b;_.forEach(a.tables,function(a){a.toggle(b)})}}}}]);h.directive("ngTable",["$filter",function(a){var b=a("orderBy");return{restrict:"A",scope:!0,controller:["$scope","$attrs","$parse","$element",function(a,d,c,e){var f=
this,g,l=d.ngTableName||"$table",h=a.isSet(d.ngTableFiltered)?e.controller("ngTableFilters"):null;f.collection=[];f.predicate=null;f.isReversed=!1;f.isHeadersIgnored=a.isSet(d.ngTableIgnoreHeaders);f.toggle=function(a){a&&f.predicate===a?f.isReversed=!f.isReversed:(f.predicate=a,f.isReversed=!1);f.update()};f.update=function(a){_.isUndefined(a)||(g=a);a=g;f.predicate&&(a=b(g,f.predicate,f.isReversed));_.overwrite(f.collection,a);_.forEach(q,function(a){a()})};var q=[];f.watch=function(a,b){q.push(b);
a.$on("$destroy",function(){_.overwriteWithout(q,b)})};a.tablesCtrl&&a.isSet(d.ngTableTables)&&(a.tablesCtrl.addTable(f),f.predicate=a.tablesCtrl.predicate,a.$on("$destroy",function(){a.tablesCtrl.removeTable(f)}));d=c(d.ngTable);f.update(d(a));var B;a.$watchCollection(d,function(b){h?B=h.addCollection(a,b):f.update(b)});h&&(a.$watchCollection(function(){return B},function(a){f.update(a);f.filtered=a.filtered}),a.$on("$destroy",function(){h.removeCollection(a)}));_.set(a,l,f)}]}}]);h.directive("ngTableHeader",
["tableHeaders","require",function(a,b){return{restrict:"A",require:["^?ngTable","^?ngTables"],link:function(d,c,e,f){var g=f[0]||f[1];g&&(g===f[0]&&g.isHeadersIgnored)&&(g=f[1],b.assert(g,"If ngTable is only for summaries, ngTables is required for headers!"));b.assert(g,"ngTable or ngTables required");if(!e.ngTableHeaderWhen||d.$eval(e.ngTableHeaderWhen)){var t=a.parsePredicate(d,e.ngTableHeader,d.isSet(e.ngTableHeaderDefault),e.ngTableHeaderKey);d.isSet(e.ngTableHeaderDisabled)||(c.on("click",function(){d.$apply(function(){g.toggle(t)})}),
c.addClass("ng-table-header"),d.$watch(function(){return g.predicate===t},function(a){c.toggleClass("active",a)}));t.isDefault&&g.toggle(t)}}}}]);h.directive("ngTableSummary",["$parse","require",function(a,b){return{scope:!0,restrict:"A",compile:function(d,c){var e=c.ngTableSummary?a(c.ngTableSummary):null,f=c.ngTableSummaryOperator?a(c.ngTableSummaryOperator):function(a,b){return(b.$acc||0)+(b.$row||0)},g=c.ngTableSummaryInitial?a(c.ngTableSummaryInitial):c.ngTableSummaryOperator?null:_.constant(0);
c.ngTableSummaries&&(e=a(c.ngTableSummaries),g=function(){return[]},f=function(a,b){_.forEach(b.$row,function(a,d){b.$acc[d]=(b.$acc[d]||0)+(a||0)});return b.$acc});return{pre:function(d,c,k){c=k.ngTableSummaryTableName||"$table";b.inScope(d,c,"ngTable controller must be in scope");var n=d[c],h=k.ngTableSummaryWhen?a(k.ngTableSummaryWhen):_.always,u=function(){if(!h(d))return"";var a=g?g(d):null;return _.reduce(n.collection,function(a,b){return f(d,{$acc:a,$row:e?e(d,{$row:b}):b})},a)};c=function(){d.$summary=
u()};c();d.isSet(k.ngTableSummaryOnce)||(d.isSet(k.ngTableSummaryTableOnly)?n.watch(d,c):d.$watch(c))}}}}}]);h.directive("ngGroup",[function(){return{scope:!0,restrict:"A",require:["ngGroup","^?ngGroups"],controller:function(){var a=this;a.collection=[];a.groups=[];a.byFn=a.asFn=a.name=null;a.group=function(){var b=!0,d=a.byFn;d||(d=_.constant(""),b=!1);var c=a.asFn?a.asFn:d,e={},f={};if(a.collection.length){var g=_.groupBy(a.collection,function(b){b={$row:b};var g=d(b)||"";if(_.isUndefined(e[g])){var m=
c===d?g:c(b);e[g]=m||null}_.isUndefined(f[g])&&(f[g]=a.sortByFn?a.sortByFn(b):e[g]);return g}),t={};_.forEach(a.groups,function(a){t[a.by]=a});g=_.map(g,function(d,c){var g=t[c]||{};_.extend(g,{isGrouped:b,by:c,as:e[c],name:a.name,rows:d,sortBy:f[c]});return g});_.overwrite(a.groups,_.sortBy(g,"sortBy"))}else _.overwrite(a.groups,[{isGrouped:b,name:a.name,rows:[]}])};a.groupBy=function(b,d,c,e){a.byFn=b;a.asFn=d;a.sortByFn=c;a.name=e;a.group()};a.update=function(b){a.collection=b;a.group()}},link:function(a,
b,d,c){var e=c[0],f=c[1];f&&(f.addNgGroupCtrl(e),a.$on("$destroy",function(){f.removeNgGroupCtrl(e)}));a.$groups=e.groups;a.$watchCollection(d.ngGroup,function(a){e.update(a)})}}}]);h.directive("ngGroupBy",["$parse","require",function(a,b){return{require:["^?ngGroup","^?ngGroups"],compile:function(d,c){var e=c.ngGroupBy?a(c.ngGroupBy):null,f=c.ngGroupAs?a(c.ngGroupAs):null,g=c.ngGroupSortBy?a(c.ngGroupSortBy):null,t=c.ngGroupByModel?a(c.ngGroupByModel):null;return function(a,d,k,l){var h=l[0]||l[1];
b.assert(h,"Either ngGroup or ngGroups required on ancestor");var z,C,F;e&&(z=_.bind(e,null,a),C=_.bind(f,null,a));g&&(F=_.bind(g,null,a));var x=function(){h.groupBy(z,C,F,k.ngGroupName)};a.isSet(k.ngGroupDefault)&&x();d.on("click",function(){t?t.assign(a,c.ngGroupBy):x()});a.$watch(function(){return h.byFn===z},function(a){d.toggleClass("toggled",a)});t&&a.$watch(t,function(a,b){a===c.ngGroupBy&&x()})}}}}]);h.directive("ngGroups",["$parse","events",function(a,b){return{scope:!0,restrict:"A",controller:["$scope",
"$attrs",function(a,d){var c=this;c.ngGroupCtrls=[];var e=function(a){a.groupBy(c.byFn,c.asFn,c.sortByFn,c.name)};c.groupBy=function(a,b,d,f){c.byFn=a;c.asFn=b;c.sortByFn=d;c.name=f;_.forEach(c.ngGroupCtrls,e)};c.addNgGroupCtrl=function(a){c.ngGroupCtrls.push(a);c.byFn&&e(a)};c.removeNgGroupCtrl=function(a){_.ref.remove(c.ngGroupCtrls,a)};if(d.ngGroupsRegroupEvent)b.on(a,d.ngGroupsRegroupEvent,function(){_.forEach(c.ngGroupCtrls,e)})}]}}]);h.directive("ngToggle",["$parse","$rootScope","toggles",function(a,
b,d){return{restrict:"A",compile:function(b,c){var e=a(c.ngToggleValue),f=a(c.ngToggleDefault),g=a(c.ngToggleGroupValue),m=c.ngToggleWhen?a(c.ngToggleWhen):null;return function(a,b,c){var l=e(a)||c.ngToggle,n=f(a)||!1,s=g(a)||c.ngToggleGroup,h=a.isSet(c.ngToggleAutoClose),x=a.isSet(c.ngToggleGroupCloseable),w=_.isUndefined(c.ngToggleInteractive)||a.isSet(c.ngToggleInteractive),G=m?_.bind(m,null,a):null;d.create(l,{autoClose:h,defaultState:n,group:s,isCloseableGroup:x,when:G});w&&(n="click",a.isSet(c.ngToggleMousedown)&&
(n="mousedown"),b.on(n,function(b){a.$apply(function(){d.toggle(l)})}));a.$watch(function(){return d.state(l)},function(a){b.toggleClass("toggled",a)});a.$on("$destroy",function(){d.destroy(l)})}}}}]);h.directive("ngToggled",b.conditionalDirective({watch:["$parse","toggles",function(a,b){return function(d,c,e){var f=d.$eval(e.ngToggledValue)||e.ngToggled,g=e.ngToggledAlwaysWhen?a(e.ngToggledAlwaysWhen):_.never;return function(){return b.state(f)||g(d)}}}],operator:["$parse",function(a){return function(b,
d,c){var e=c.ngToggledAction?a(c.ngToggledAction):_.ignore;return function(a){e(b,{$value:a});return a}}}]}));h.directive("ngToggledShow",["$parse","toggles",function(a,b){return{link:function(d,c,e){var f=e.ngToggledAction?a(e.ngToggledAction):_.ignore,g=e.ngToggledAlwaysWhen?a(e.ngToggledAlwaysWhen):_.never,t=d.$eval(e.ngToggledShowValue)||e.ngToggledShow;d.$watch(function(){return b.state(t)||g(d)},function(a){f(d,{$value:a});c.css("display",a?"":"none")})}}}]);h.directive("ngWith",["$parse",function(a){return{restrict:"A",
scope:!0,priority:900,compile:function(b,d){var c=a(d.ngWith);return{pre:function(a,b,d){c(a);a.$watch(c)}}}}}]);h.directive("ngFadeIn",[function(){return{restrict:"A",link:function(a,b,d){a=parseInt(d.ngFadeIn);b.hide();b.fadeIn(a)}}}]).directive("ngFadeOut",[function(){return{restrict:"A",link:function(a,b,d){var c=parseInt(d.ngFadeOut);d=d.ngFadeTarget;var e=$(b);b=a;d&&(b=a.$eval(d));b.fadeOut=function(b){e.fadeOut(c,function(){b&&b(a)})}}}}]);h.directive("ngNullForm",[function(){return{name:"form",
controller:function(){this.$setPristine=this.$setDirty=this.$removeControl=this.$setValidity=this.$addControl=_.ignore;this.$$renameControl=function(a,b){a.$name=b}},link:{pre:function(a){a.nullForm={$dirty:!1,$pristine:!0,$valid:!0,$invalid:!1}}}}}]);h.directive("ngName",[function(){return{restrict:"A",require:["ngModel","^?form"],link:function(a,b,d,c){a.$watch(d.ngName,function(a){b.attr("name",a);var d=c[0],e=c[1];e.$removeControl(d);d.$name=a;e.$addControl(d)})}}}]).directive("ngPrefix",[function(){return{restrict:"A",
priority:100,controller:["$scope","$element","$attrs",function(a,b,d){var c=b.attr("name");a.$watch(d.ngPrefix,function(a){var b=c;a&&(b=a+"-"+b);d.$set("name",b)})}]}}]);h.directive("ngOutboundLink",[function(){return{restrict:"A",priority:-1,link:function(a,b,d){var c=a.$interpolate(d.ngOutboundLink)||"_self";(!d.ngOutboundLinkWhen||a.$eval(d.ngOutboundLinkWhen))&&b.attr("target",c)}}}]);h.directive("ngBackButton",["$window",function(a){return{restrict:"A",link:function(b,d,c){d.on("click",function(b){setTimeout(function(){a.history.back()},
50)})}}}]);h.directive("ngSearchLink",["navigation",function(a){return{restrict:"A",link:function(b,d,c){c.$observe("ngSearchLink",function(e){var f=b.$eval(c.ngSearchLinkCompany)||a.currentCompany;f&&(e=f.$url(urls.dashboard.bookings.index)+"?q="+e,d.attr("href",e))})}}}]);h.directive("ngPrint",_.optional(["$timeout","$window","?native",function(a,b,d){var c=d&&d.isNative;return{restrict:"A",link:function(e,f,g){var t=function(){if(c){var a;if(g.ngPrintNative){a=$(e.$interpolate(g.ngPrintNative));
if(!a.length)return;a=a[0]}d.print(a)}else b.print()};f.on("click",function(a){a.preventDefault();a.stopPropagation();t()});e.isSet(g.ngPrintAuto)&&a(function(){t()},c?0:400)}}}]));h.directive("ngOpenWindow",["$window","d",function(a,b){return{restrict:"A",link:function(d,c,e){var f=b.observer(e,"ngOpenWindow"),g=b.observer(e,"ngOpenWindowArguments","toolbar=0,status=0,scrollbars=1");c.on("click",function(b){if(f()){var c=d.$eval(e.ngOpenWindowWidth);b=d.$eval(e.ngOpenWindowHeight);var m=g();if(c)var n=
Math.max(0,(a.screen.width-c)/2),m=m+(",width="+c)+(",left="+n);b&&(c=Math.max(0,(a.screen.height-b)/2),m+=",height="+b,m+=",top="+c);a.open(f(),"angular-open-winow",m)}})}}}]);h.directive("ngCloseWindow",["$window","d",function(a,b){return{restrict:"A",link:function(b,d,c){d.on("click",function(b){a.close()})}}}]);h.directive("ngTouch",["$parse","d",function(a,b){return{restrict:"A",compile:function(d,c){var e=a(c.ngTouch);return function(a,d){d.on(b.isTouchEnabled?"touchstart":"click",function(){a.$apply(function(){e(a)})})}}}}]);
h.directive("ngConfirmClick",[function(){return{priority:-1,restrict:"A",link:function(a,b,d){var c=a.isSet(d.ngConfirmClickStrict);b.on("click",function(b){if(!(c&&this!==b.target)){var e=d.ngConfirmClick,f;if(f=e)f=_.isUndefined(d.ngConfirmClickWhen)?!0:a.$eval(d.ngConfirmClickWhen,{$event:b}),f=f&&!confirm(e);f&&(b.stopImmediatePropagation(),b.preventDefault())}})}}}]);h.directive("ngCancelClick",[function(){return{priority:-1,restrict:"A",link:function(a,b,d){b.on("click",function(b){a.$eval(d.ngCancelClick)&&
(b.stopImmediatePropagation(),b.preventDefault())})}}}]);c=function(a,b){h.directive(a,[function(){return{restrict:"A",link:function(d,c,e){var f=d.isSet(e[a+"Strict"]);c.on("click",function(c){f&&this!==c.target||b.test(c)&&d.$apply(function(){!1===d.$eval(e[a])&&(c.stopPropagation(),c.preventDefault())})})}}}])};h.config(["$provide",function(a){a.decorator("ngClickDirective",["$delegate",function(a){a.shift();return a}])}]);c("ngClick",{test:function(a){return!a.shiftKey&&!a.ctrlKey&&!a.metaKey&&
!a.altKey}});c("ngShiftClick",{test:function(a){return a.shiftKey&&!a.ctrlKey&&!a.metaKey&&!a.altKey}});c("ngControlClick",{test:function(a){return!a.shiftKey&&a.ctrlKey&&!a.metaKey&&!a.altKey}});c("ngMetaClick",{test:function(a){return!a.shiftKey&&!a.ctrlKey&&a.metaKey&&!a.altKey}});c("ngAltClick",{test:function(a){return!a.shiftKey&&!a.ctrlKey&&!a.metaKey&&a.altKey}});c("ngShiftOrAltClick",{test:function(a){return(a.shiftKey||a.altKey)&&!a.ctrlKey&&!a.metaKey}});h.directive("ngPhoneNumberInput",
["d",function(a){return{priority:1,restrict:"A",link:function(b,d){a.restrictKeypresses(d,/\+|\d/)}}}]);h.directive("ngAmountInput",["$parse","d",function(b,d){return{priority:1,require:"ngModel",restrict:"A",link:function(c,e,f,g){var r=b(f.ngModel),t=parseFloat(f.max),v=parseFloat(f.min),h=f.ngAmountInputMax&&b(f.ngAmountInputMax),q=f.ngAmountInputMin&&b(f.ngAmountInputMin),B=f.ngAmountInputDefault&&b(f.ngAmountInputDefault),u=c.isSet(f.ngAmountInputAllowEmpty),u=!f.required||u,z=function(){return B?
B(c)/100:0},C=/[0-9]|\./;if(f.ngAmountInputPositive?!c.$eval(f.ngAmountInputPositive):1)C=/[0-9]|\.|\-/;d.restrictKeypresses(e,C);g.$parsers.push(function(a){if(_.isUndefined(a)||""===a||null===a){if(u)return"";g.$$lastCommittedViewValue=z().toString();return _.roundHalfToEven(100*z())}g.$setValidity("required",!0);var b=q?Math.max(q(c)/100,v):v,d=h?Math.min(h(c)/100,t):t;!_.isNaN(b)&&a<b&&(a=b,g.$setValidity("min_value",!0));!_.isNaN(d)&&a>d&&(a=d,g.$setValidity("max_value",!0));return _.roundHalfToEven(100*
a)});g.$formatters.unshift(function(a){return _.isUndefined(a)||""===a||null===a?u?"":z():_.roundHalfToEven(a/100,2).toFixed(2)});c.$watch(r,function(a,b){!u&&(_.isUndefined(a)&&_.isUndefined(b))&&r.assign(c,z())});e.on("blur",function(){a(g)})}}}]);h.directive("ngJsonInput",["$parse",function(a){var b=/^(?!^[_\-])(?!.*[_\-]$)[a-zA-Z0-9_\-]+$/,d=function(a){try{_.parseJSON(a)}catch(b){return!1}return!0};return{require:"ngModel",restrict:"A",link:function(c,e,f,g){var t=a(f.ngModel);g.$parsers.push(function(a){a=
$.trim(a);if(_.isUndefined(a)||""===a||null===a)return g.$setValidity("valid_json",!0),"";var c=a;b.test(c)&&(c='"'+c+'"');g.$setValidity("valid_json",d(c));return a});c.$watch(t,function(a){a&&('"'===a.charAt(0)&&'"'===a.slice(-1))&&(a=a.slice(1,a.length-1),(!a||b.test(a))&&t.assign(c,a))})}}}]);h.directive("ngBindOnce",[function(){return{link:function(a,b,d){b.addClass("ng-binding").data("$binding",d.ngBindOnce);a=a.$eval(d.ngBindOnce)||"";b[0].textContent=a.toString()}}}]);h.directive("ngBindHtmlOnce",
["$sce","clientOptions",function(a,b){return{link:function(d,c,e){c.addClass("ng-binding").data("$binding",e.ngBindHtmlOnce);b.reflectUrlsInHrefs(c);c.html(a.getTrustedHtml(d.$eval(e.ngBindHtmlOnce))||"")}}}]);var c=function(a,b,d){h.directive(a,["$compile","$filter","$injector","auth","navigation",function(c,e,f,g,t){var v=T("You don't have permission to see this amount"),h=f.invoke(b.render),q=e("currencySymbol");return{restrict:"A",compile:function(b,e){b.addClass("notranslate amount");var f={};
f.hideDecimalWhenInteger="ngAmountHideCents"in e;f.showNullAsZero="ngAmountShowNullAsZero"in e;return function(b,e,m){var s,t,p=function(a,l){if(!(a===t&&l===s)){t=a;s=l;var p=b.$eval(m.ngAmountCurrency)||b.processorCurrency||l;d=d||"viewAmounts";l&&!g.permissions.can(d,l)?(p=q(p,"short"),c('<span ng-tip="'+v+'">'+p+"?</span>")(b,function(a){e.empty().append(a)}),e.addClass("amount-hidden")):(p=h(b,m,t,l,p,f),e.text(p),e.addClass("amount-visible"),e.toggleClass("negative",0>t))}};b.$watch(m[a],function(d){p(d,
b.$eval(m[a+"Company"])||b.company||null)});_.isUndefined(m[a+"Company"])||b.$watch(m[a+"Company"],function(d){p(b.$eval(m[a]),d||null)})}}}}])},d={render:["$filter",function(a){var b=a("amount");return function(a,d,c,e,f,g){return b(c,f,g.hideDecimalWhenInteger,!0,g.showNullAsZero)}}]};c("ngAmount",d);c("ngInvoiceAmount",d,"viewInvoiceAmounts");c("ngAmountRate",{render:["$filter",function(a){var b=a("percentage");return function(a,d,c){return b(c)}}]});h.directive("ngFloatInput",function(){return{priority:1,
require:"ngModel",link:function(a,b,d,c){a.$eval(d.ngFloatInput);var e=d.ngFloatInputMaxDigits?a.$eval(d.ngFloatInputMaxDigits):null,f=d.ngFloatInputDecimalPlaces?a.$eval(d.ngFloatInputDecimalPlaces):null,g;if(b=d.ngFloatInputMin||d.min){var t=a.$eval(b);g=function(a){c.$setValidity("min_value",a>=t)}}var v;if(d=d.ngFloatInputMax||d.max){var h=a.$eval(d);v=function(a){c.$setValidity("max_value",a<=h)}}c.$parsers.push(function(a){"."===a&&(a="");if(null!==f){var b=a.indexOf(".");-1!==b&&a.length-(b+
1)>f&&(a=a.slice(0,b+1)+a.slice(b+1,b+1+f))}null!==e&&(b=e,_.startsWith(a,"-")&&(b+=1),_.contains(a,".")&&(b+=1),a.length>b&&(a=a.substring(0,b)));b=parseFloat(a);if(isNaN(b))return a;g&&g(b);v&&v(b);return b})}}});h.directive("ngBooleanSelect",function(){return{priority:1,require:"ngModel",link:function(a,b,d,c){c.$parsers.push(function(a){return _.contains([!0,"True","true","1"],a)?!0:_.contains([!1,"False","false","0"],a)?!1:a});c.$formatters.push(function(a){return!0===a?"True":!1===a?"False":
a})}}});h.directive("ngIntInput",["$parse","d",function(b,d){return{require:"ngModel",priority:1,compile:function(c,e){var f=b(e.ngIntInputMin),g=b(e.ngIntInputMax);return function(b,c,e,k){b.isSet(e.ngIntInput)&&(d.restrictKeypresses(c,/[-0-9]/),k.$parsers.push(function(a){var d=f(b),c=g(b);if(""===a)return a;var e=parseInt(a,10);if(isNaN(e))return a;_.isUndefined(d)||(e<d&&(e=d),k.$setValidity("min",!0));_.isUndefined(c)||(e>c&&(e=c),k.$setValidity("max",!0));return e}),c.on("blur",function(){a(k)}))}}}}]);
h.directive("ngLoadTime",["$window",function(a){return{restrict:"A",link:function(){console.info("ng-load-time",(new Date-a.$$loadTime)/1E3)}}}]);h.directive("ngPlaceholder",[function(){return function(a,b,d){d.$observe("ngPlaceholder",function(a){b.attr("placeholder",a);if("SELECT"===b[0].nodeName){var d=b.children("option").first();d.text()||(d.attr("label",a),d.text(a))}else a&&b.placeholder()})}}]);h.directive("ngDatepicker",["$parse","d","localization","moment","Pikaday",function(b,d,c,e,f){return{require:"ngModel",
priority:1,restrict:"A",compile:function(c,g){var k=b(g.ngDatepickerYearRange),v=b(g.ngDatepickerMinDate);return function(b,c,l,p){var h=b.isSet(l.ngDatepickerAllowEmpty),C=e.localeData().longDateFormat("L"),F=b.company&&b.company.features?b.company.features.isSundayBased:!0;_.isUndefined(g.ngDatepickerSundayBased)||(F=b.isSet(g.ngDatepickerSundayBased));var x=$(c),w=_.replaceAll(C,/[a-zA-Z]/,"");d.restrictKeypresses(c,RegExp("[0-9]|/|["+w+"]"));var G=function(a,b){var d=e(a,b);return!d||!d.isValid()?
h?"":e():d},F={field:x[0],format:C,onSelect:function(){b.$apply(function(){p.$setViewValue(M.toString())})},minDate:v,yearRange:k,onOpen:function(){var a=G(p.$modelValue,"YYYY-MM-DD");a&&M.setMoment(a)},firstDay:F?0:1,i18n:{previousMonth:T("Previous Month"),nextMonth:T("Next Month"),months:[T("January"),T("February"),cT("the month of March","March"),T("April"),cT("the month of May","May"),T("June"),T("July"),T("August"),T("September"),T("October"),T("November"),T("December")],weekdays:[T("Sunday"),
T("Monday"),T("Tuesday"),T("Wednesday"),T("Thursday"),T("Friday"),T("Saturday")],weekdaysShort:[cT("Abbreviation of Sunday","Sun"),cT("Abbreviation of Monday","Mon"),cT("Abbreviation of Tuesday","Tue"),cT("Abbreviation of Wednesday","Wed"),cT("Abbreviation of Thursday","Thu"),cT("Abbreviation of Friday","Fri"),cT("Abbreviation of Saturday","Sat")]}},M=new f(F),K=function(a,b,d){return(a=G(a,b))?a.format(d):""};p.$parsers.push(function(a){return K(a,C,"YYYY-MM-DD")});p.$formatters.unshift(function(a){return K(a,
"YYYY-MM-DD",C)});!b.$eval(l.ngModel)&&!h&&(l=p.$pristine,p.$pristine=!1,p.$setViewValue(e().format(C)),p.$render(),p.$pristine=l);c.on("blur",function(){a(p)});b.$on("$destroy",function(){M.destroy()});v&&b.$watch(v,function(b){M.config({minDate:b?b.toDate():void 0});b&&0>e(p.$modelValue,"YYYY-MM-DD").diff(b)&&(p.$modelValue=b.format("YYYY-MM-DD"),p.$$writeModelToScope(),a(p))})}}}}]);h.directive("ngTimepicker",["$parse","$timeout","d","localization","moment",function(b,d,c,e,f){return{require:"ngModel",
restrict:"A",link:function(b,g,l,v){var h=e.current().TIME_FORMATS.default;l=e.current().SERVER_TIME_FORMAT;var q=$(g);c.restrictKeypresses(g,/[0-9]|[:amp]/);var B=q.timepicker({timeFormat:l});g.on("selectTime",function(){b.$safeApply(function(){var a=B.val();a!==v.$viewValue&&v.$setViewValue(a)})});var u=function(a,b,d){b=f(a,b);return!a||!b||!b.isValid()?"":b.format(d)};v.$parsers.push(function(a){return u(a,h,"HH:mm")});v.$formatters.unshift(function(a){var b=u(a,"HH:mm",h);d(function(){B.timepicker("setTime",
b)});return b});g.on("blur",function(){a(v)});b.$on("$destroy",function(){B.timepicker("remove")})}}}]);h.directive("ngInternationalPhoneField",["$compile","$parse","$timeout","auth","localization","models","navigation",function(a,b,d,c,e,f,g){return{require:"ngModel",restrict:"A",link:function(f,p,h,q){var B=b(h.ngModel),u=b(h.ngInternationalPhoneFieldPhoneCountryModel),B=B(f),z=u(f),C=$(p);p=f.$eval(h.ngInternationalPhoneFieldCountries)||[];var F=function(){return C.intlTelInput("getSelectedCountryData")},
x=function(){var b=F(),d=C.siblings(".flag-container").find(".selected-flag");d.attr("ng-tip",function(){return T("Country Code")+(_.isEmpty(b)?"":": +"+b.dialCode+" "+b.name)}).attr("ng-tip-classes","tip-indent").attr("title",null);a(d)(f)},w=_.map(p,function(a){return a[0].toLowerCase()}),G=function(a){a=a?a.toLowerCase():"";return _.contains(w,a)},M=function(a){d(function(){u.assign(f,a.toUpperCase())},0)};p=[];if(1<w.length){c.currentUser.isAuthenticated||p.push(e.browser.ACCEPT_LANGUAGE_COUNTRY_CODE.toLowerCase());
h=g.currentCompany;var K=h.country;if("US"===h.processorCountry||!h.country)K=h.processorCountry;p.push(K.toLowerCase());p=_.uniq(p);p=_.filter(p,function(a){return G(a)})}var H="";z&&G(z)?H=z.toLowerCase():B||(p.length?H=p[0]:w.length&&(H=w[0]));C.intlTelInput({autoPlaceholder:"off",formatOnDisplay:!1,onlyCountries:w,preferredCountries:p,initialCountry:H});M(H);x();B&&C.intlTelInput("setNumber",B);f.$watch(u,function(a,b){C.parents(".international-phone-field").toggleClass("no-country",!a);if(a!==
b)if(!a||G(a)){var d=a,d=d?d.toLowerCase():"";C.intlTelInput("setCountry",d)}else M(H)});C.on("countrychange",function(){f.$safeApply(function(){var a;a=F();a=!a||!a.iso2?"":a.iso2.toUpperCase();M(a);q.$setDirty();q.$setViewValue(C.val());x()})});C.on("open:countrydropdown",function(){f.$safeApply(function(){var a=C.siblings(".flag-container").find(".country-list");a.length&&!a.hasClass("tb-flyout")&&a.addClass("tb-flyout")})});f.$on("$destroy",function(){C.intlTelInput("destroy")})}}}]);h.directive("ngSlideshow",
["$animate","$compile","$templateCache","$timeout",function(a,b,d,c){return{restrict:"A",controller:["$scope","$element","$attrs",function(b,d,c){var e=b.$eval(c.ngSlideshowDelay)||4500,f,g,k=this;k.isPlaying=!1;k.slides=[];k.currentSlide=null;k.addSlide=function(a){a={element:a};k.slides.push(a);return a};k.removeSlide=function(a){k.slides[g]===a&&(g+=1,g>=k.slides.length&&(g=0));_.overwriteWithout(k.slides,a);k.slides[g]||(g=void 0)};k.showSlide=function(b){if(k.slides.length){var d=_.indexOf(k.slides,
b);0>d||(!_.isUndefined(g)&&k.slides[g]!==b&&(b=k.slides[g],k.currentSlide=null,a.removeClass(b.element,"slideshow-showing")),g=d,d=k.slides[g],k.currentSlide=d,a.addClass(d.element,"slideshow-showing"),k.isPlaying&&k.play())}};k.next=function(){var a;_.isUndefined(g)?a=0:(a=g+1,a>=k.slides.length&&(a=0));k.showSlide(k.slides[a])};k.previous=function(){var a;_.isUndefined(g)?a=0:(a=g-1,0>a&&(a=k.slides.length-1));k.showSlide(k.slides[a])};k.pause=function(){a.removeClass("slideshow-playing");a.addClass("slideshow-paused");
clearTimeout(f);k.isPlaying=!1};var m=function(){b.$safeApply(function(){f=null;k.slides.length&&k.next()})};k.play=function(a){k.isPlaying=!0;f&&clearTimeout(f);f=setTimeout(m,a?0:e)}}],link:function(a,c,e,f){e=d.get("slideshow-dots");var g=d.get("slideshow-arrows");a=a.$new();a.slideshow=f;c.append(b(e)(a));c.append(b(g)(a));f.play(!0)}}}]);h.directive("ngSlideshowSlide",[function(){return{restrict:"A",require:"^ngSlideshow",link:function(a,b,d,c){b.addClass("slideshow-slide");c.slides.length||
b.addClass("slideshow-showing");var e=c.addSlide(b);a.$on("$destroy",function(){c.removeSlide(e)})}}}]);h.directive("ngDiff",["diff",function(a){return{restrict:"A",link:function(b,d,c){var e=b.$eval(c.ngDiff);b=b.$eval(c.ngDiffWith);if(_.isUndefined(e)||null===e)e="";if(_.isUndefined(b)||null===b)b="";d.addClass("diff");_.forEach(a.diffWords(b,e),function(a){var b=$("<span />");a.added?b.addClass("diff-added"):a.removed?b.addClass("diff-removed"):b.addClass("diff-unchanged");b.text(a.value);d.append(b)})}}}]);
h.directive("ngMarkdownFileUpload",["fileuploader","flash",function(a,b){return{require:"ngModel",restrict:"A",link:function(d,c,e,f){var g,t=_.first(c);c.bind("keyup click",function(){_.isUndefined(t.selectionStart)||(g=t.selectionStart)});c.parents(e.ngMarkdownParent).first().find(e.ngMarkdownFileUpload).on("click",function(){a.uploadAsMarkdown().then(function(a){if(a){var d=f.$viewValue||"",c=_.isUndefined(g)?d.length:g,e=d.substr(0,c);e&&!e.match(/\s$/)&&(e+="\n");(d=d.substr(c))&&!d.match(/^\s/)&&
(d="\n"+d);f.$setViewValue(e+a+d);f.$render();b.success(T("Uploaded file"))}},function(){b.error(T("File was not uploaded, please try again"))})})}}}]);h.directive("ngMarkdownBulkFileUpload",["events","fileuploader","flash",function(a,b,d){return{restrict:"A",link:function(c,e,f){var g=f.ngMarkdownBulkFileUpload?"ngMarkdownBulkFileUpload."+f.ngMarkdownBulkFileUpload:null;e.on("click",function(){b.uploadAsMarkdown().then(function(b){b&&(a.broadcast(g,b),d.success(T("Uploaded file")))})})}}}]);h.directive("ngMarkdownBulkFileUploadChild",
["events",function(a){return{restrict:"A",require:"ngModel",link:function(b,d,c,e){a.on(b,c.ngMarkdownBulkFileUploadChild?"ngMarkdownBulkFileUpload."+c.ngMarkdownBulkFileUploadChild:null,function(a,b){if(b){var d=e.$viewValue||"",c=b;d&&(c=d+"\n"+b);e.$setViewValue(c);e.$render()}})}}}]);h.directive("ngMarkdownPreview",["Showdown",function(a){return{require:"ngModel",restrict:"A",link:function(b,d,c,e){var f=new a.converter;b=d.parents(c.ngMarkdownParent).first();d=b.find(c.ngMarkdownPreview);var g=
b.find(c.ngMarkdownPreviewResult);d.on("click",function(){var a="",b=e.$viewValue;b&&(b=_.escape(b),a=f.makeHtml(b));g.html(a)})}}}]);h.directive("ngMailcheck",["Mailcheck",function(a){return{restrict:"A",scope:{email:"=ngMailcheck"},template:'<a ng-show="suggestedEmail">'+T("Did you mean")+" <b>[[ suggestedEmail ]]</b>?</a>",link:function(b,d,c,e){b.suggestedEmail="";b.$watch("email",function(d){d?a.run({email:d,suggested:function(a){b.suggestedEmail=a.full},empty:function(){b.suggestedEmail=""}}):
b.suggestedEmail=""});d.on("click",function(){b.email=b.suggestedEmail})}}}]);c=function(a){return h.directive(a.name,[function(){return{restrict:"A",link:function(b,d,c){d="$"+a.name;var e=b[d],f;e&&(f=e.isEnabled,e.isEnabled=!1);if(b.hasOwnProperty(d))throw Error("lib.directives: multiple copies of "+a.name+" modifier in same scope");var g={isEnabled:!0};b[d]=g;var t=$(a.selector),v=a.get(t),h=v;c.$observe(a.name,function(b,d){g.isEnabled&&(h=b,a.set(t,b,d))});b.$on("$destroy",function(){a.set(t,
v,h);e&&(e.isEnabled=f)})}}}])};c({name:"ngTitle",selector:"title",get:function(a){return document.title},set:function(a,b){return document.title=b}});c({name:"ngMetaViewport",selector:'meta[name="viewport"]',get:function(a){return a.attr("content")},set:function(a,b){return a.attr("content",b)}});h.directive("ngBodyClass",[function(){return{restrict:"A",link:function(a,b,d){var c=$("body"),e="";a.$watch(function(){var b=a.$eval(d.ngBodyClass);return _.isObject(b)?_.mapObject(b,function(a){return!!a}):
b},function(a){c.removeClass(e);var b="";_.isObject(a)?_.forEach(a,function(a,d){a&&(b+=d+" ")}):b=a;c.addClass(b);e=b},!0);a.$on("$destroy",function(){c.removeClass(e)})}}}]);h.directive("ngBodyClassOnce",[function(){return{restrict:"A",link:function(a,b,d){b=$("body");a=a.$eval(d.ngBodyClassOnce);var c="";_.isObject(a)?_.forEach(a,function(a,b){a&&(c+=b+" ")}):c=a;b.addClass(c)}}}]);h.directive("ngInline",["$templateCache",function(a){return{restrict:"A",priority:400,compile:function(b,d){var c=
d.ngInline,e=a.get(c);e?b.html(e):console.warn("ng-inline: invalid template",c)}}}]);h.directive("ngLink",["$compile","$templateCache",function(a,b){var d={};return{restrict:"A",priority:400,link:function(c,e,f){if(f=c.$interpolate(f.ngLink)){var g=d[f];if(!g){g=b.get(f);if(!g){console.warn("ng-link: invalid template",f);return}g=a(g);d[f]=g}g(c,function(a){e.empty().append(a)})}else console.warn("ng-link: invalid template name",f)}}}]);h.directive("ngLoad",["$compile","$http","$templateCache",function(a,
b,d){return{restrict:"A",priority:400,compile:function(c,e){var f="/"+e.ngLoad,g=d.get(f);if(g)console.info("ng-load: compiled load",f),c.html(g);else{(g=d.get("ng-load-spinner"))&&c.html(g);var t;return function(c,e,g){var n=function(){t(c,function(a){e.empty().append(a)})};g=function(b){b=b.data;d.put(f,b);console.info("ng-load: downloaded load",f);t=a(b);n()};t?(console.info("ng-load: linked load",f),n(c,e)):b.get(f).then(null,function(){console.error("ng-load: unable failed to load, retrying...",
f);return b.get(f)}).then(g,function(){console.error("ng-load: unable to load",f);var b=d.get("ng-load-error");e.empty().append(a(b)(c))})}}}}}]);h.directive("ngNewTransportation",["$parse",function(a){return{restrict:"A",require:"^?form",controller:"lib.shared.NewTransportationCtrl",link:{pre:function(a,b,d,c){if(c){c.$setValidity("loading-transportation",!1);var e=a.$watch("newTransportationCtrl.status",function(a){if("success"===a||"error"===a)c.$setValidity("loading-transportation",!0),e()});
a.$on("$destroy",function(){c.$setValidity("loading-transportation",!0)})}}}}}]);h.directive("ngPseudoPlaceholder",[function(){return{restrict:"A",link:function(a,b,d){var c=b.closest(".field");c.addClass("field-pseudo-input-placeholder");a.$watch(function(){return b.val()},function(a){c.toggleClass("showing-pseudo-placeholder",!a)})}}}]);h.directive("ngDebug",[function(){return{restrict:"A",link:function(a,b,d){debugger}}}]);h.directive("ngLog",[function(){return{restrict:"A",link:function(a,b,d){console.log("ng-log: link",
a.$eval(d.ngLog));a.$on("$destroy",function(){console.log("ng-log: $destroy",a.$eval(d.ngLog))})}}}]);h.directive("ngCurrentBlock",["$parse",function(a){return{restrict:"A",link:function(b,d,c){var e=a(c.ngCurrentBlockBlocks);b.$watch(c.ngCurrentBlockAffiliation,function(a){var d;a&&(d=e(b),d=_.find(d,function(b){return b.affiliation===a}));b.currentBlock=d})}}}]);h.directive("ngStartBooking",["navigation","postBook",function(a,b){return{priority:-1,restrict:"A",link:function(d,c,e){c.on("click",
function(){d.$apply(function(){var c;c=e.ngStartBooking?d.$interpolate(e.ngStartBooking):a.url;b.startBooking(c)})})}}}]);h.directive("ngDump",["$parse",function(a){return{restrict:"A",link:function(b,d,c){var e=a(c.ngDump);console.log("ng-dump: link",e(b));b.isSet(c.ngDumpWatch)&&b.$watch(function(){console.log("ng-dump: $watch",e(b))})}}}]);h.directive("ngQrCode",["$interpolate","QRCode",function(a,b){return{restrict:"A",compile:function(d,c){var e=a(c.ngQrCode);return function(a,d){var c=e(a);
new b(d[0],{text:c,width:256,height:256,colorDark:"#000000"})}}}}]);h.directive("ngModelDependencies",["$parse",function(a){return{restrict:"A",controller:function(){var a=this;a.dependents=[];a.addDependent=function(b){a.dependents.push(b)}},compile:function(b,d){var c=a(d.ngModelDependencies);return function(a,b,d,e){a.$watch(c,function(a){a?b.prop("disabled",!1):(b.prop("disabled",!0),_.forEach(e.dependents,function(a){a(!1)}))})}}}}]);h.directive("ngModel",["$parse",function(a){return{require:"^?ngModelDependencies",
link:function(b,d,c,e){if(e){console.info("adding dependent",c.ngModel);var f=a(c.ngModel);e.addDependent(function(a){return f.assign(b,a)})}}}}]);h.directive("ngSelectAll",["$parse",function(a){return{restrict:"A",templateUrl:"ng-select-all",scope:!0,compile:function(b,d){var c=a(d.ngSelectAll),e=a(d.ngSelectAllModel),f=d.ngSelectAllWhen?a(d.ngSelectAllWhen):_.always,g=a(d.ngSelectAllDefaults),t=a(d.ngSelectAllDefaultField);return function(a,b,l){var m=function(g){if(!b.parents("fieldset[disabled]").length){var l=
c(a);_.forEach(l,function(b){var d={$element:b};f(a,d)&&e.assign(a,g(b),d)});(l=a.$eval(d.ngSelectAllCallback))&&l()}};a.selectText=a.$interpolate(l.ngSelectAllText);a.selectAll=_.bind(m,null,_.constant(!0));a.selectNone=_.bind(m,null,_.constant(!1));a.allowDefaults=!!g(a);if(a.allowDefaults){var h=_.makeIteratee(t(a));a.selectDefaults=function(){var b=g(a);m(function(a){return!!b[h(a)]})}}}}}}]);h.directive("ngClearInput",["$parse",function(a){return{restrict:"A",compile:function(b,d){b.addClass("ng-clear-input");
var c=a(d.ngClearInput);return function(a,b,d){var e=_.isUndefined(d.ngClearInputRefocus)||a.isSet(d.ngClearInputRefocus);console.info("refocus",e);a.$watch(c,function(a){b.toggleClass("ng-hide",!a)});b.on("click",function(d){d.preventDefault();d.stopPropagation();e&&b.prev().focus();a.$apply(function(){c.assign(a,"")})})}}}}]);h.directive("ngDjangoField",["$parse",function(a){return{restrict:"A",compile:function(b,d){var c=a(d.ngDjangoField),e=a(d.ngDjangoFieldModel),f=_.isUndefined(d.ngDjangoFieldRequired)?
_.constant(!1):""===d.ngDjangoFieldRequired?_.constant(!0):a(d.ngDjangoFieldRequired),g=_.isUndefined(d.ngDjangoFieldDisabled)?_.constant(!1):a(d.ngDjangoFieldDisabled);return{pre:function(a,b){b.addClass("field")},post:function(a,b){a.$watch(function(){var b=c(a)||{},d=e(a),k=f(a),l=g(a),d=""===d||_.isUndefined(d);return{"ng-pristine":b.$pristine,"ng-dirty":b.$dirty,"ng-invalid":b.$invalid||d&&k,"ng-disabled":l,"ng-required":k}},function(a){var d=_.map(a,function(a,b){if(a)return b});a=_.map(a,function(a,
b){if(!a)return b});b.addClass(d.join(" ")).removeClass(a.join(" "))},!0)}}}}}]);h.directive("ngNoisyInvalidFields",[function(){return{restrict:"A",require:"ngNoisyInvalidFields",controller:["$scope",function(a){var b=this;b.isShowing=!1;var d=function(){$("body").toggleClass("noisy-invalid-fields",b.isShowing)};b.show=function(a){b.isShowing=_.isUndefined(a)?!0:a;d()};b.hide=function(){b.isShowing=!1;d()};a.$on("$destroy",function(){b.hide()})}],controllerAs:"noisyInvalidFieldsCtrl"}}]);h.directive("ngFiltered",
["$parse","$timeout",function(a,b){return{restrict:"A",scope:!0,controller:["$scope","$attrs","$element",function(d,c,e){var f=this;f.searchTerm="";f.isFiltering=!1;f.objects=[];f.reset=function(){g.assign(d,"");u("")};var g=a(c.ngFiltered),t=a(c.ngFilteredObjects),v;c.ngFilteredSearchDocument&&(v=a(c.ngFilteredSearchDocument));var h=!1;d.isSet(c.ngFilteredElements)&&(h=!0,t=function(){return e.find("[ng-filtered-element]")},v=function(a,b){return b.$obj.innerText});var q=function(){_.forEach(e.find("[ng-filtered-element-group]"),
function(a){a=$(a);var b=0<a.find("[ng-filtered-element]:not(.ng-hide)").length;a.toggleClass("ng-hide",!b)})},B=function(){var a=t(d);if(!f.searchTerm)return h&&(_.forEach(a,function(a){$(a).removeClass("ng-hide")}),_.forEach(e.find("[ng-filtered-element-group]"),function(a){$(a).removeClass("ng-hide")})),a;a=_.filter(a,function(a){var b;b=v?v(d,{$obj:a}):a;b=_.contains(b.toLowerCase(),f.searchTerm.toLowerCase());h&&$(a).toggleClass("ng-hide",!b);return b});h&&q();return a},u=function(a){d.$safeApply(function(){f.searchTerm=
a;f.isFiltering=!!f.searchTerm;b(function(){f.objects=B()})})},z=_.debounce(u,100);d.$watch(g,function(a){z(a)})}],controllerAs:"filteredCtrl"}}]);h.directive("ngNegateCheckbox",[function(){return{require:"ngModel",link:function(a,b,d,c){c.$parsers.push(function(a){return!a});c.$formatters.push(function(a){return!a})}}}]);h.directive("ngShortcutsOverlay",[function(){return{templateUrl:"lib.shortcutsOverlay"}}]);h.directive("ngSvg",[function(){return{compile:function(a,b){var d=document.getElementById(b.ngSvg);
d?(a.addClass("ng-svg"),a[0].appendChild(d.cloneNode(!0))):console.warn("ng-svg: unable to find svg:",b.ngSvg)}}}]);h.directive("ngHoursBeforeMidnight",["$parse",function(a){return{templateUrl:"ng-hours-before-midnight",controllerAs:"hoursBeforeMidnightCtrl",controller:["$scope","$attrs",function(b,d){var c=this,e=a(d.ngHoursBeforeMidnight);b.$watch(e,function(a){if(!(_.isUndefined(a)||""===a)){var b=moment().startOf("day").subtract(a,"hours");a=Math.ceil(a/24);c.time=b;c.days=a}})}]}}])})();
(function(){var h=angular.module("lib.filters",["lib.services"]);h.factory("filterFields",[function(){var b=[void 0,"",null,[],{}],a=function(a){return _.any(b,function(b){return _.isEqual(b,a)})};return{EMPTY_VALUES:b,isEmpty:a,isSet:function(b,f){return a(f)?!a(b):_.isArray(b)&&_.isArray(f)?!_.isEqual(b.sort(),f.sort()):!_.isEqual(b,f)}}}]);h.filter("isNumber",[function(){return _.isNumber}]);h.filter("isBoolean",[function(){return _.isBoolean}]);h.filter("humanize",["convert",function(b){return b.humanize}]);
h.filter("percentage",["localization",function(b){return function(a,c,f,e){_.isUndefined(f)&&(f=1);var g=b.current();if(f)a=a?a/f:0;else return g.formatPercentage(1,0,!c);e?_.isNumber(e)||(e=0):e=5;return g.formatPercentage(a,e,!c)}}]);h.filter("percentageFromPercentage",["$filter",function(b){return function(a,c,f,e){return b("percentage")(a/100,c,f,e)}}]);h.filter("cssPercentage",[function(){return function(b){if(_.isUndefined(b))return"";b=Math.floor(1E4*b)/100;return b+"%"}}]);h.filter("pluralize",
[function(){return function(b,a,c){c=c||"s";a=a||"";b=parseInt(b||"0",10);b=isNaN(b)?0:b;return 1===b?a:c}}]).filter("capitalize",[function(){return function(b){return _.capitalize(b)}}]).filter("lowercase",[function(){return function(b){return b.toLowerCase()}}]).filter("uppercase",[function(){return function(b){return b.toUpperCase()}}]).filter("bracketWrap",[function(){return function(b){return"["+b+"]"}}]).filter("aOrAnBefore",[function(){var b=/[aeiouAEIOU]/;return function(a,c){return(a&&b.test(a.charAt(0))?
c?"An":"an":c?"A":"a")+" "+a}}]).filter("css",[function(){return function(b){b=(b||"").replace(/\s+/g,"-");b=b.replace(/-+/g,"-");b=b.replace(/[^-\w]/g,"");return b.toLowerCase()}}]).filter("addClassIf",[function(){return function(b,a,c){return b?a||"":c||""}}]).filter("addClasses",[function(){return function(b){var a=[];_.forEach(b,function(b,f){b&&a.push(f)});return a.join(" ")}}]).filter("isDefined",[function(){return function(b){return!_.isUndefined(b)}}]).filter("isUndefined",[function(){return function(b){return _.isUndefined(b)}}]).filter("map",
[function(){return function(b,a){return _.map(b,a)}}]).filter("any",[function(){return _.any}]).filter("keys",[function(){return _.keys}]).filter("exclude",[function(){return function(b,a){return _.filter(b,function(b){return!a(b)})}}]).filter("colonless",[function(){var b=/:+\s*$/;return function(a){return(a||"").replace(b,"")}}]).filter("commaSeparated",[function(){return function(b){return!b?"":_.filter(b).join(", ")}}]).filter("replaceAll",[function(){return _.replaceAll}]).filter("ageInYears",
[function(){return function(b){return moment().diff(b,"years")}}]);h.factory("localization",["$browser","$window","auth","convert","db","models","moment","navigation",function(b,a,c,f,e,g,d,l){d.locale("en-us");var m=e.slipstream("unitsLanguageFormats"),k=e.slipstream("unitsLanguageCodes"),n=function(a){if(!a)return"";a=a.toLowerCase().match(/^([a-z]{2}-)?([a-z]{2})$/);if(!a||3!==a.length)return"";a=a[2];if(!a)return"";a=a.toUpperCase();return _.contains(g.Company.COUNTRY_CODES,a)?a:""};a.ldmlnum.round=
_.roundHalfToEven;var s=function(b){m[b]||(console.warn("localization: unsupported language",b),b="en-us");var d=m[b],c=T("Today"),e=_.extend({"export":"MM/YYYY"},d.client.month),f=_.extend({"default":d.client.date.short,"export":"YYYY-MM-DD"},d.client.date);a.ldmlnum.locale.xx=a.ldmlnum.locale(d.groupSymbol,d.decimalSymbol,d.plusSignSymbol,d.minusSignSymbol);var g=a.ldmlnum(d.decimalPattern,"xx"),k=a.ldmlnum(d.currencyPattern,"xx"),l=a.ldmlnum(d.percentPattern,"xx"),n=RegExp("\\"+d.decimalSymbol+
"0+");return{language:b,formatNumber:g,formatCurrency:function(a,b,d){b=b||"";b=k(a).replace("\u00a4\u00a4\u00a4",b).replace("\u00a4\u00a4",b).replace("\u00a4",b);_.isInteger(a)&&d&&(b=b.replace(n,""));return b},formatPercentage:function(a,b,c){b=l(a,b);c&&(0<a&&-1===b.indexOf(d.plusSignSymbol))&&(b=d.plusSignSymbol+b);return b},PERCENT_SYMBOL:d.percentSymbol,VALID_DATETIME_FORMATS:"default short shortNoYear shortFullYear dayWithMonthAbbr long longNoYear export input".split(" "),TIME_SEPARATOR:d.timeSeparator,
HTML_TIME_SEPARATOR:d.htmlTimeSeparator,RANGE_SEPARATOR:" - ",HTML_RANGE_SEPARATOR:"<br/>- ",TODAY:c,DAY_FORMAT:"dddd",DAYS_FORMATS:{"default":"[[ days ]] [days]"},ALL_DAY_FORMATS:{"default":"[All day]"},MONTH_FORMATS:e,DATE_FORMATS:f}};b=(e.slipstream("acceptLanguage")||"").split(",");b=b.length?_.find(b,function(a){return!!n(a)}):"";var p=n(b),r="",t={},v=function(a,b,d){d=d||{};d.server&&d.topOfHour&&console.error("localization: unsupported use of `server` and `topOfHour` options in `__getTimeFormat()");
var c;d.server?(c="server",d="exact"):(c="client",d=d.topOfHour?"topOfHour":"exact");var e=m[a];if(e){var g=e[c];if(g)if(g=g.time)if(g=g[d]){b=b||e[c].time[d].default;if(e=g.values)return(e=e[f.camelKey(b)])||console.warn("localization: failed to identify time format for:",a,c,"time",d,"values",b),e;console.warn("localization: failed to identify time format for:",a,c,"time",d,"values")}else console.warn("localization: failed to identify time format for:",a,c,"time",d);else console.warn("localization: failed to identify time format for:",
a,c,"time");else console.warn("localization: failed to identify time format for:",a,c)}else console.warn("localization: failed to identify time format for:",a)},h=g.Company,q=function(a,b){b=b||{};b.server&&b.topOfHour&&console.error("localization: unsupported use of `server` and `topOfHour` options in `__fallbackTimeFormat()");return a===h.TWENTY_FOUR_HOUR_TIME_FORMAT_TYPE?b.server?h.FALLBACK_SERVER_EXACT_TWENTY_FOUR_HOUR_TIME_FORMAT:b.topOfHour?h.FALLBACK_CLIENT_TOP_OF_HOUR_TWENTY_FOUR_HOUR_TIME_FORMAT:
h.FALLBACK_CLIENT_EXACT_TWENTY_FOUR_HOUR_TIME_FORMAT:b.server?h.FALLBACK_SERVER_EXACT_TWELVE_HOUR_TIME_FORMAT:b.topOfHour?h.FALLBACK_CLIENT_TOP_OF_HOUR_TWELVE_HOUR_TIME_FORMAT:h.FALLBACK_CLIENT_EXACT_TWELVE_HOUR_TIME_FORMAT},B=function(a,b){var d;if(c.currentUser.isAuthenticated){d=c.currentUser.company.isAdmin&&l.currentCompany?l.currentCompany:c.currentUser.company;var e;e=d.timeFormatType===h.COMPANY_LOCALE_DEFAULT_TIME_FORMAT_TYPE?v(d.language,void 0,b):v(d.language,d.timeFormatType,b);e||(console.warn("localization: falling back for time format type:",
d.timeFormatType,b),e=q(d.timeFormatType,b));return e}if(l.currentCompany)return d=l.currentCompany,e=d.anonymousTimeFormatType===h.ANONYMOUS_USER_LOCALE_DEFAULT_TIME_FORMAT_TYPE?v(a,void 0,b):d.anonymousTimeFormatType===h.COMPANY_LOCALE_DEFAULT_TIME_FORMAT_TYPE?v(d.language,void 0,b):v(d.language,d.anonymousTimeFormatType,b),e||(console.warn("localization: falling back for anonymous time format type:",d.anonymousTimeFormatType,b),e=q(d.anonymousTimeFormatType,b)),e;console.warn("localization: falling back to 12-hour time for an anonymous user with no current company");
return h.FALLBACK_CLIENT_EXACT_TWELVE_HOUR_TIME_FORMAT},u=function(a,b){if(_.contains(b,a))return a;var d=a.split("-")[0];if(_.contains(b,d))return d;for(var c=0,e=b.length;c<e;c++){var f=b[c],g=f.split("-")[0];if(d===g)return f}};b={browser:{ACCEPT_LANGUAGE:b,ACCEPT_LANGUAGE_COUNTRY_CODE:p},setLanguageManuallyForAnonymousUser:function(a,b){var d;a:if(d=u(a,k),!d){if(b&&(d=u(b.language,k)))break a;d="en-us"}m[d]?(console.log("localization: manually setting units language for anonymous user",d,"based on target language",
a),r=d):console.warn("localization: unsupported language",d)},current:function(){var a;a=!c.currentUser.isAuthenticated&&r?r:e.slipstream("unitsLanguage")||"en-us";t[a]=t[a]||s(a);var b=t[a];d.locale(a);a={TIME_FORMATS:_.extend({"default":"h:mma","export":"hh:mma"},B(a)),TOP_OF_HOUR_TIME_FORMATS:_.extend({"default":"ha","export":"hh:mma"},B(a,{topOfHour:!0})),SERVER_TIME_FORMAT:B(a,{server:!0})};return _.extend({},b,a)}};b.current();return b}]);h.factory("dates",["$interpolate","localization",function(b,
a){var c=a.current,f=function(a,d,c,e){var f=d[c.format]||d["default"];if(!f)return console.warn("dates: invalid date format",c.format,"valid formats",d),"";_.isUndefined(e)||(f=b(f)(e));return!f?"":a.format(f)},e={format:"short",isRelative:!1,isRelativeTime:!1,isHtml:!1,endAt:null,hideDate:null},g=function(a,b,d,c){return c?b||"":b&&d?b+a+d:b||d},d=function(a,b){if(!moment.isMoment(a)||!moment.isMoment(b))return!1;var d=a.clone().startOf("day"),c=b.clone().startOf("day");return!d.diff(c)},l=function(a){var b=
a.clone().startOf("day");return!a.diff(b)},m=function(a){var b=a.clone().startOf("hour");return!a.diff(b)},k=function(a,b){if(b.isRelative&&b.isRelativeTime){var d=moment(),d=a.diff(d,"hours");if(b.isRelative&&0<=d&&6>d)return a.fromNow()}},n=function(a,b){b=b||e;var d=k(a,b);if(d)return d;if(b.endAt&&l(a)&&l(b.endAt)){d=Math.abs(b.endAt.diff(a,"days"));if(1<d)return f(a,c().DAYS_FORMATS,b,{days:d});if(1===d)return f(a,c().ALL_DAY_FORMATS,b)}return m(a)?f(a,c().TOP_OF_HOUR_TIME_FORMATS,b):f(a,c().TIME_FORMATS,
b)},s=function(a,b){b=b||e;return b.isRelative&&d(a,moment())?c().TODAY:f(a,c().DATE_FORMATS,b)},p=function(a,b){b=b||e;if(b.endAt&&l(a)&&l(b.endAt))return s(a,b);var f=s(a,b),m=k(a,b);if(m)return m;m=_.extend({},b);delete m.endAt;return(m=n(a,m))&&b.isHideDate&&d(a,b.hideDate)?m:g(c().TIME_SEPARATOR,f,m)};return{options:function(a){var b=_.extend({},e);_.contains(a,"short")?console.warn("date: unnecessary short format specifier"):_.find(c().VALID_DATETIME_FORMATS,function(d){if(_.contains(a,d))return b.format=
d,!0});b.isRelative=_.contains(a,"relative");b.isRelativeTime=_.contains(a,"relative-time");b.isAlwaysHideDate=_.contains(a,"always-hide-date");b.isHideDate=b.isAlwaysHideDate||_.contains(a,"hide-date");b.isHtml=_.contains(a,"html");b.is12amPlus1=_.contains(a,"12am+1");_.forEach(a,function(d){moment.isMoment(d)&&(b.endAt?b.isHideDate?b.hideDate=d:console.warn("date: extra moments",a,skipEndAt):b.endAt=d)});return b},isSameDay:d,isMidnight:l,isTopOfHour:m,getMonth:function(a,b){b=b||e;return f(a,c().MONTH_FORMATS,
b)},getDay:function(a,b){b=b||e;return b.isRelative&&d(a,moment())?c().TODAY:f(a,c().DAY_FORMAT,b)},getDate:s,getDateRange:function(a,b,f){f=f||e;if(d(a,b))return s(a,f);var k=f.isHtml?c().HTML_RANGE_SEPARATOR:c().RANGE_SEPARATOR;return g(k,s(a,f),s(b,f))},getTime:n,getRelativeTime:k,getTimeRange:function(a,b,d){d=d||e;var k=d.isHtml?c().HTML_RANGE_SEPARATOR:c().RANGE_SEPARATOR,m=Math.abs(a.diff(b,"days"));if(0===a.diff(b))return n(a,d);if(l(a)&&l(b))return 1<m?f(a,c().DAYS_FORMATS,d,{days:m}):f(a,
c().ALL_DAY_FORMATS,d);d=null;return 0===m?g(k,n(a,d),n(b,d)):1===m?g(k,n(a,d),n(b,d)+" "+T("(next day)")):g(k,n(a,d),n(b,d)+" "+interpolate(T("(%(count)s days later)"),{count:m.toString()}))},getDatetime:p,getDatetimeRange:function(a,b,f){f=f||e;if(0===a.diff(b))return p(a,f);var k=f.isHtml?c().HTML_RANGE_SEPARATOR:c().RANGE_SEPARATOR;if(l(a)&&l(b))return 1<Math.abs(a.diff(b,"days"))?(b=b.clone(),b.subtract(1,"days"),g(k,s(a,f),s(b,f))):f.isAlwaysHideDate&&d(a,f.hideDate)?n(a,f):s(a,f);var m;if(m=
f.is12amPlus1)if(m=l(b)){m=a;var h=b;!moment.isMoment(m)||!moment.isMoment(h)?m=!1:(m=m.clone().startOf("day"),h=h.clone().startOf("day"),m=1===h.diff(m,"days"))}if(d(a,b)||m){b=g(c().RANGE_SEPARATOR,n(a,f),n(b,f));m&&(b+="+1");if(f.isHideDate&&d(a,f.hideDate))return b;a=s(a,f);f=f.isHtml?c().HTML_TIME_SEPARATOR:c().TIME_SEPARATOR;return g(f,a,b)}f.isHideDate?(m=_.defaults({isHideDate:!1,hideDate:null},f),f=f.isAlwaysHideDate?f:m):f=m=f;return g(k,p(a,f),p(b,m))}}}]);h.filter("dateOffset",["moment",
function(b){return function(a,c,f,e){if(!b.isMoment(a))return"";c=c||0;f=f||"minutes";a=a.clone();return e?a.add(c,f):a.subtract(c,f)}}]).filter("dateSubtract",["$filter",function(b){return function(a,c,f){return b("dateOffset")(a,c,f,!1)}}]).filter("dateAdd",["$filter",function(b){return function(a,c,f){return b("dateOffset")(a,c,f,!0)}}]);h.filter("dateRange",["dates","moment",function(b,a){return function(c){var f=b.options(_.rest(arguments)),e=f.endAt;return!a.isMoment(c)||!a.isMoment(e)?(console.log("dateRange: invalid moments",
c,e,f),""):b.getDateRange(c,e,f)}}]).filter("datetimeRange",["dates","moment",function(b,a){return function(c){var f=b.options(_.rest(arguments)),e=f.endAt;return!a.isMoment(c)||!a.isMoment(e)?(console.log("datetimeRange: invalid moments",c,e,f),""):b.getDatetimeRange(c,e,f)}}]).filter("timeRange",["dates","moment",function(b,a){return function(c){var f=b.options(_.rest(arguments)),e=f.endAt;return!a.isMoment(c)||!a.isMoment(e)?(console.log("timeRange: invalid moments",c,e,f),""):b.getTimeRange(c,
e,f)}}]).filter("date",["dates","moment",function(b,a){return function(c){_.isString(c)&&(c=a(c));var f=b.options(_.rest(arguments));return!a.isMoment(c)?(console.log("date: invalid moment",c,f),""):b.getDate(c,f)}}]).filter("day",["dates","moment",function(b,a){return function(c){var f=b.options(_.rest(arguments));return!a.isMoment(c)?(console.log("day: invalid moment",c,f),""):b.getDay(c,f)}}]).filter("month",["dates","moment",function(b,a){return function(c){var f=b.options(_.rest(arguments));
return!a.isMoment(c)?(console.log("day: invalid moment",c,f),""):b.getMonth(c,f)}}]).filter("datetime",["dates","moment",function(b,a){return function(c){var f=b.options(_.rest(arguments));return!a.isMoment(c)?(console.log("datetime: invalid moment",c,f),""):b.getDatetime(c,f)}}]).filter("datetimeWithTimezone",["dates","moment",function(b,a){return function(c,f){var e=b.options(_.slice(arguments,2));if(!a.isMoment(c))return console.log("datetimeWithTimezone: invalid moment",c,f,e),"";if(!_.isString(f))return console.log("datetimeWithTimezone: invalid timezone",
c,f,e),"";var g=a.tz(c.valueOf(),f);return b.getDatetime(g,e)}}]).filter("timeWithTimezone",["dates","moment",function(b,a){return function(c,f){var e=b.options(_.slice(arguments,2));if(!_.isString(f))return console.log("timeWithTimezone: invalid timezone",c,f,e),"";var g=a.tz(c.valueOf(),f);return b.getTime(g,e)}}]).filter("dateWithTimezone",["dates","moment",function(b,a){return function(c,f){var e=b.options(_.slice(arguments,2));if(!a.isMoment(c))return console.log("dateWithTimezone: invalid moment",
c,f,e),"";var g=a.tz(c.valueOf(),f);return b.getDate(g,e)}}]).filter("time",["dates","moment",function(b,a){return function(c){var f=b.options(_.rest(arguments));return!c||_.isString(c)&&(c=a(c,"HH:mm"),!a.isMoment(c))?"":b.getTime(c,f)}}]);h.filter("range",[function(){return function(b,a){return _.range(b,a)}}]);h.filter("safeHtml",[function(){return function(b){return b.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;")}}]);h.filter("firstLineOfMarkdown",[function(){var b=/^\s*$/,a=
/^#+/,c=/([*_]{1,3})(\S.*?\S?)\1/;return function(f){if(!f)return"";f=_.find(f.split("\n"),function(a){return!b.test(a)})||"";return _.trim(f.replace(a,"").replace(c,"$2").replace(c,"$2"))}}]);h.filter("encodeURIComponent",[function(){return function(b){return encodeURIComponent(b)}}]);h.filter("hostname",[function(){return function(b){if(!b)return"";var a=b.toLowerCase(),c=document.createElement("a");c.setAttribute("href",a);c=c.hostname;return!c||-1===a.indexOf(c)?b:c=c.replace(/^www./,"")}}]);
h.filter("withLineBreaks",[function(){return function(b){return b.replace(/\n+/g,"\n<br />\n")}}]);h.factory("phoneNumbers",[function(){var b=_.toTrueKeys([201,202,203,205,206,207,208,209,210,212,213,214,215,216,217,218,219,220,224,225,227,228,229,231,234,239,240,248,251,252,253,254,256,260,262,267,269,270,272,274,276,278,281,283,301,302,303,304,305,307,308,309,310,312,313,314,315,316,317,318,319,320,321,323,325,327,330,331,334,336,337,339,341,346,347,351,352,360,361,364,369,380,385,386,401,402,404,
405,406,407,408,409,410,412,413,414,415,417,419,423,424,425,430,432,434,435,440,442,443,447,458,464,469,470,475,478,479,480,484,501,502,503,504,505,507,508,509,510,512,513,515,516,517,518,520,530,531,534,539,540,541,551,557,559,561,562,563,564,567,570,571,573,574,575,580,582,585,586,601,602,603,605,606,607,608,609,610,612,614,615,616,617,618,619,620,623,626,627,628,629,630,631,636,641,646,650,651,657,659,660,661,662,667,669,678,679,681,682,689,701,702,703,704,706,707,708,712,713,714,715,716,717,718,
719,720,724,725,727,730,731,732,734,737,740,743,747,754,757,760,762,763,764,765,769,770,772,773,774,775,779,781,785,786,801,802,803,804,805,806,808,810,812,813,814,815,816,817,818,828,830,831,832,843,845,847,848,850,854,856,857,858,859,860,862,863,864,865,870,872,878,901,903,904,906,907,908,909,910,912,913,914,915,916,917,918,919,920,925,927,928,929,930,931,934,935,936,937,938,940,941,947,949,951,952,954,956,959,970,971,972,973,975,978,979,980,984,985,989]),a=function(a){return a?a.replace(/\D/g,
""):""},c=function(b){return!b?"":("+"===b[0]?"+":"")+a(b)},f=/^\+?\d{5,15}$/,e=function(c){c=a(c);11===c.length&&"1"===c[0]&&(c=c.slice(1));if(10===c.length){var d=c.slice(0,3);if(b[d])return{isUsPhoneNumber:!0,areaCode:d,exchange:c.slice(3,6),suffix:c.slice(6,10)}}return{isUsPhoneNumber:!1}};return{cleanPhoneNumber:c,digits:a,isPossiblyValid:function(a){return f.test(c(a))},parseUsPhoneNumber:e,formatUsPhoneNumber:function(a){a=a||"";if("+"===a[0])return a;var b=e(a);return!b.isUsPhoneNumber?a:
"("+b.areaCode+") "+b.exchange+"-"+b.suffix}}}]);h.filter("phone",["navigation","phoneNumbers",function(b,a){return function(b){return a.formatUsPhoneNumber(b)}}]);h.filter("contactPhone",["navigation",function(b){return function(a){var c=b.currentCompany,c=c.country||c.processorCountry;return!a.phoneCountry||a.phoneCountry===c?a.displayPhoneNational:a.displayPhoneInternational}}]);h.filter("currencyClass",[function(){return function(b){return(b=_.resolveCurrency(b))?"currency--"+b:""}}]);h.filter("currencySymbol",
["auth","db","localization",function(b,a,c){var f=a.slipstream("currencies");return function(a,g){a=_.resolveCurrency(a);var d=f[a];if(!d)return console.warn("currencySymbol filter: unsupported currency",a),"";b.currentUser.isAuthenticated&&(g=b.currentUser.company.isAdmin?"long":"short");if("short"===g)return d.symbol;if("long"===g)return d.symbolLong;var l=d.symbolLongByLanguage;return(l?l[c.current().language]:"")||d.symbolLong}}]);h.filter("currencyDisplayName",["db","localization",function(b,
a){var c=b.slipstream("currencies");return function(a,b){a=_.resolveCurrency(a);var g=c[a];return!g?(console.warn("currencyDisplayName filter: unsupported currency",a),""):"short"==b?g.displayName:g.displayNameLong}}]);h.filter("amount",["$filter","db","localization","navigation",function(b,a,c,f){var e=a.slipstream("currencies"),g=b("currencySymbol");return function(a,b,m,k,n){n&&null===a&&(a=0);if(!_.isNumber(a))return"";_.isBoolean(b)&&_.isUndefined(k)&&(k=!m,m=b,b=null);b=_.resolveCurrency(b);
b||(f.currentCompany?(console.warn("amount filter: not passed currency, falling back to currentCompany"),b=f.currentCompany.processorCurrency):(console.warn("amount filter: not passed currency, no currentCompany to fall back to"),b="",k=!1));_.isUndefined(k)&&(k=!0);n=c.current();var s=e[b];s?s=s.decimalPlaces:(console.warn("amount filter: passed unsupported currency:",b),k=!1,s=2);a/=Math.pow(10,s);b=k?g(b,k):"";return n.formatCurrency(a,b,m)}}]);h.filter("count",["localization",function(b){return function(a,
c){return null===a||void 0===a?"":b.current().formatNumber(a,c||4)}}]);h.filter("stripNewlines",[function(){return function(b){return b.replace(/\r|\n/g,"").replace(/\s+/g," ")}}]);h.filter("yesno",[function(){return function(b,a,c){a=_.isUndefined(a)?"Yes":a;c=_.isUndefined(c)?"No":c;return b?a:c}}]);h.filter("name",[function(){return function(b,a,c){a=a||"";return _.isString(b)?b||a:_.isObject(b)?(b.shortName||b.name||b.unicode||a)+(b.isArchived&&!c?" ("+T("archived")+")":""):a}}]);h.filter("primaryImageUrl",
[function(){return function(b){return b.imageCdnUrl||(b.images&&b.images.length?b.images[0].croppedCdnUrl:"")}}]);h.filter("value",[function(){return function(b){return _.isString(b)?b:b.value}}]);h.filter("personalizeCollectedByText",["$filter","auth",function(b,a){var c=b("name");return function(b){return a.isCompanyUser(b)?T("Collected by you"):interpolate(T("Collected by %(companyName)s"),{companyName:c(b)})}}]);h.filter("lastNameFirst",[function(){return function(b){b=b.split(/\s+/);var a=b.pop();
b.length&&(a+=",");b.unshift(a);return b.join(" ")}}]);h.filter("initials",[function(){return function(b){b=b.split(/\s+/);return 1<b.length?b[0][0]+b[b.length-1][0]:b[0][0]||""}}]);h.filter("onlineStatusClass",[function(){return function(b){return!b?"":b.isBookableOnlyByPhone?"icon-ava-phone":b.isBookable&&b.isUnlisted?"icon-ava-unlisted":!b.isBookable&&(b.isResourcesAvailable||b.item.company.companyFeatures.isResourceBookableCapacityEnabled)?"icon-ava-lock":""}}]);h.filter("capacityIndicatorClass",
[function(){return function(b){var a=_.contains(arguments,"filled"),c=_.contains(arguments,"large")?"icon-user":"icon-user-small";return b.companyFeatures.isResourceBookableCapacityEnabled?a?"cb-square filled":"cb-square":a?c+" full":c+" empty"}}]);h.filter("blockedCapacityClass",[function(){return function(b,a){return 0===b?"ava-is-empty":b===a?"ava-is-full":b>a?"ava-is-overbooked":"ava-is-booked"}}]);h.filter("capacityClass",["models",function(b){return function(a,c,f){var e=a.customerCount,g=a.capacity;
_.isUndefined(c)||(e=c);var d;_.isUndefined(f)&&(f=!0);if(a.cls===b.ItemGroup.cls)return 0<(a.bookingCount||0)?"ava-is-booked":"ava-is-empty";a.cls===b.Block.cls&&(d=a.reservedCapacity-e);a.cls===b.CustomerTypeRate.cls&&(d=g-e);if(a.cls===b.Availability.cls){d=f?"bookableCapacity":"blocksIncludedBookableCapacity";f=f?"nonResourceBookableCapacity":"blocksIncludedNonResourceBookableCapacity";if(!e)return"ava-is-empty";if(a.company.companyFeatures.isResourceBookableCapacityEnabled){d=a[d];if(_.isUndefined(d))return console.log("capacityClass: no capacity information for object",
a.uri),"ava-is-empty";if(a.isOverusingResources||0>a[f])return"ava-is-overbooked"}else{d=a[f];if(_.isUndefined(d))return console.log("capacityClass: no capacity information for object",a.uri),"ava-is-empty";null!==d&&(d+=a.customerCount-e)}}return 0>=e?"ava-is-empty":0>d?"ava-is-overbooked":0===d?"ava-is-full":null===d||0<d?"ava-is-booked":"ava-is-empty"}}]);h.filter("liveCapacityClass",["models",function(b){return function(a,b){if(!a||a.$fresh)return"ava-is-empty";var f=b.bookCountsCtrl.availabilityCustomerCount;
if(!f)return"ava-is-empty";if(0===b.bookCountsCtrl.customerCount&&(b.availability.isOverbooked||b.availability.isOverusingResources)||a.isOverbookingAvailability||a.isOverusingResources)return"ava-is-overbooked";if(0===a.availabilityLiveBookableCapacity)return"ava-is-full";if(0<f&&(null===a.availabilityLiveBookableCapacity||0<a.availabilityLiveBookableCapacity))return"ava-is-booked";console.log("liveCapacityClass: no capacity information.",a,f);return"ava-is-empty"}}]);h.filter("availableClass",[function(){return function(b,
a){var c=b.capacity-b.customerCount;_.isUndefined(a)||(c=a);return 0>=c?"ava-is-unbookable":"ava-is-bookable"}}]);h.filter("hasCustomersClass",[function(){return function(b){return 0<b.customerCount?"ava-is-booked":"ava-is-empty"}}]);h.filter("abs",[function(){return function(b){return Math.abs(b||0)}}]);h.filter("isAllDay",["dates",function(b){return function(a){return!a?(console.warn("isAllDay: invalid range"),!1):!a.startAt||!a.endAt||+a.startAt===+a.endAt?!1:b.isMidnight(a.startAt)&&b.isMidnight(a.endAt)}}]);
h.filter("isMidnight",["dates","moment",function(b,a){return function(c){return!a.isMoment(c)?(console.warn("isMidnight: invalid date",c),!1):b.isMidnight(c)}}]);h.filter("contains",[function(){return function(b,a){return _.contains(b,a)}}]);h.filter("bookingUrl",["auth","navigation","urls",function(b,a,c){return function(f){var e=f.company;return f.isPending?(f=f.$url(c.embeds.book.wait.booking),a.extendQuery(f,{status:"initial"})):b.permissions.can("viewDashboardSection",e)?f.$url(c.dashboard.overlay.contact.booking):
f.affiliation&&b.permissions.can("viewDashboardSection",f.affiliation.affiliateCompany)?f.$url(c.dashboard.bookings.contact.affiliateBookingPermalink):f.$url(c.company.item.booking)}}]);h.filter("orderUrl",["auth","navigation","urls",function(b,a,c){return function(a){if(b.permissions.can("viewDashboardSection",a.company))return a.$url(c.dashboard.overlay.contact.order);var e=_.filter(a.allBookings,function(a){return a.affiliation&&b.permissions.can("viewDashboardSection",a.affiliation.affiliateCompany)});
return 0<e.length?c.populate(c.dashboard.bookings.contact.affiliateOrderPermalink,{affiliateShortname:e[0].affiliation.affiliateCompany.shortname,shortname:a.company.shortname,contactPk:a.contact.pk,orderUuid:a.uuid}):a.$url(c.company.order.index)}}]);h.filter("contactUrl",["auth","navigation","urls","require",function(b,a,c,f){return function(a){if(b.permissions.can("viewDashboardSection",a.company))return a.$url(c.dashboard.overlay.contact.index);var f=_.findWhere(b.currentUser.company.partners,
{company:a.company});return f&&f.affiliateGroup&&b.permissions.can("viewDashboardSection",b.currentUser.company)?c.populate(c.dashboard.bookings.contact.affiliateContactPermalink,{affiliateShortname:b.currentUser.company.shortname,shortname:a.company.shortname,contactPk:a.pk}):a.$url(c.company.index)}}]);h.filter("availabilityUrl",["auth","models","urls",function(b,a,c){return function(a){return b.permissions.can("viewDashboardSection",a.item.company)?a.$url(c.dashboard.overlay.availability.index):
a.$url(c.company.item.book)}}]);h.filter("itemGroupUrl",["auth","flows","models","urls",function(b,a,c,f){return function(c,g){var d=b.permissions.can("viewDashboardSection",c.item.company)?f.dashboard.overlay.item.date:f.company.item.date,d=f.populate(d,{shortname:c.item.company.shortname,itemPk:c.item.pk,date:g.format("YYYY-MM-DD")});return d=a.extendWithFlow(d)}}]);h.filter("itemUrl",["auth","urls",function(b,a){return function(c){return b.permissions.can("viewItemsSection",c.company)?c.$url(a.dashboard.items.item.index):
c.$url(a.company.item.index)}}]);h.filter("checkinUrl",["db","urls",function(b,a){return function(c){return!c?"":b.slipstream("checkinDomain")+a.populate(a.embeds.checkin.qr,{encodedCustomerPk:c.encodedPk})}}]);h.filter("waiverUrl",[function(){return function(b,a){return b.company.smartwaiverUrl+"?auto_waiverid="+b.waiverUuid+"&auto_tag=fh_id_"+a.pk}}]);h.filter("invoiceUrl",["auth","navigation","urls",function(b,a,c){return function(f,e){e=e||"index";var g;g=a.currentCompany===f.company&&b.permissions.can("viewDashboardSection",
f.company)?c.dashboard.reports.invoices.invoice[e]:f.affiliation&&b.permissions.can("viewDashboardSection",f.affiliation.affiliateCompany)?c.dashboard.reports.invoices.partnerInvoice[e]:c.company.invoice.index;if(!g)throw Error("invoiceUrl: invalid view "+e);return f.$url(g)}}]);h.filter("uploadUrl",["navigation","urls",function(b,a){return function(c){return a.populate(a.dashboard.reports.accounts.upload,{shortname:b.currentCompany.shortname,uploadPk:c.pk})}}]);h.filter("companyDefaultIntegrationsUrl",
["navigation","urls","auth","models",function(b,a,c,f){return function(b){var g={shortname:b.shortname};return c.permissions.canList(f.ResellerCompany,b)?b.isAdmin?a.populate(a.dashboard.settings.reseller.apps.index,g):a.populate(a.dashboard.settings.reseller.index,g):a.populate(a.dashboard.settings.integrations.subscribe,g)}}]);h.filter("key",[function(){return function(b){return b.cls+"."+b.pk}}]);h.filter("summary",[function(){return function(b,a,c){return _.reduce(b,function(b,c){return b+(_.getDotted(c,
a)||0)},c||0)}}]);h.filter("uniqueCount",["$filter",function(b){var a=b("pluralize");return function(b,f,e,g){var d={};_.forEach(b,function(a){a=_.get(a,f);_.isObject(a)&&a.uri&&(a=a.uri);d[a]=1});b=_.sum(d);return e||g?b.toString()+" "+a(b,e,g):b}}]);h.filter("uncamel",[function(){var b=/([a-z])([A-Z])/g,a=function(a,b,e){return b+" "+e};return function(c){return c.replace(b,a)}}]);h.filter("activityChange",["$filter","models",function(b,a){var c=b("amount"),f=b("percentage"),e=function(a){moment.isMoment(a)||
(a=moment.parseZone(a));return a},g={AmountField:c,PositiveAmountField:c,PercentField:f,PositivePercentField:f,DateTimeField:function(a){return b("datetime")(e(a))},DateField:function(a){return b("date")(e(a))},ColumnWidthField:function(b){return a.FlowNode.WIDTH_LABELS[b]||b}};return function(a,c){var e=g[c];return e?e(a):_.isObject(a)?b("name")(a):a}}]);h.filter("defaultIfUndefined",[function(){return function(b,a){return _.isUndefined(b)?a:b}}]);h.filter("fieldOrBoolean",["$filter",function(b){return function(a){return!0===
a?"is set":!1===a?"is empty":_.isObject(a)?b("name")(a):a}}]);h.filter("names",["$filter",function(b){return function(a){return _.map(a,b("name")).join(", ")}}]);h.filter("isEmptyFilter",["filterFields",function(b){return function(a){return _.any(b.EMPTY_VALUES,function(b){return _.isEqual(b,a)})}}]);h.filter("defaults",[function(){return _.defaults}]);h.filter("parsePresetDateRange",["dateUtils",function(b){return function(a,c){return b.dateRange(a,c)}}]);h.filter("colorClass",["models",function(b){return function(a,
c,f){c=c||"";f=f||"";if(!a)return f;a.cls===b.Booking.cls?a=a.availability.item:a.item&&(a=a.item);a.color&&(a=a.color);if(!a||!_.isNumber(a))return f;if(!b.Item.isValidColor(a))return console.warn("colorClass filter: unsupported color:",a),f;c&&"-"!==c.charAt(0)&&(c=" "+c);return"color-"+a+c}}]);h.filter("approximate",["$filter",function(b){return function(a,c){var f,e=1,g=c?"+":"";if(1E3<=a)f=100,e=1E3,g="k"+g;else if(100<=a)f=100;else if(10<=a)f=10;else return a;return b("count")((a-a%f)/e,1)+
g}}]);h.filter("displayLanguage",["models",function(b){return function(a){return b.SupportedLanguage.display(a)}}])})();
(function(){var h=angular.module("lib.services","flash.services lib.factories lib.filters lib.models lib.processors ngSanitize".split(" "));h.factory("sessionStorage",[function(){var b=function(){var a={};return{get:function(b){b=a[b];if(!_.isUndefined(b))return _.parseJSON(b)},set:function(b,e){a[b]=_.stringifyJSON(e)},del:function(b){delete a[b]},clear:function(){a={}}}},a=b();a.create=b;return a}]);h.factory("storage",["$window","sessionStorage",function(b,a){var c;try{window.localStorage.setItem("$test",
"$test"),window.localStorage.removeItem("$test"),c=!0}catch(f){c=!1}var e;c?(e={key:function(a){try{return b.localStorage.key(a)}catch(d){}},get:function(a){try{var d=b.localStorage.getItem(a);if(_.isString(d))return _.parseJSON(d)}catch(c){}},set:function(a,d){try{b.localStorage.setItem(a,_.stringifyJSON(d))}catch(c){}},del:function(a){try{b.localStorage.removeItem(a)}catch(d){}},clear:function(){try{b.localStorage.clear()}catch(a){}}},Object.defineProperty(e,"length",{get:function(){try{return b.localStorage.length}catch(a){return 0}},
configurable:!1,enumerable:!1})):e=a.create();e.isPersistent=function(){return c};return e}]);h.factory("persistentStorage",["$q","$rootScope","clientOptions","db","events","navigation","require","storage",function(b,a,c,f,e,g,d,l){_.isValidUuid(c.userIdentifier)||(b=l.get("persistentStorageIdentifier"),c.userIdentifier=_.isValidUuid(b)?b:_.uuid());l.set("persistentStorageIdentifier",c.userIdentifier);var m=c.userIdentifier;console.log("persistentStorage: identified user:",c.userIdentifier);var k=
function(a){d.notNull(g.currentCompany,"shortname","persistentStorage needs currentCompany");var b={identifier:c.userIdentifier,shortname:g.currentCompany.shortname};a&&(b.key=a);return b},n={getIdentifier:function(){return c.userIdentifier},setIdentifier:function(a){l.set("persistentStorageIdentifier",a);c.userIdentifier=a;console.log("persistentStorage: re-identified user:",a);e.broadcast("persistentStorage.reIdentifiedUser")},restoreIdentifier:function(){n.setIdentifier(m)},regenerateIdentifier:function(){n.setIdentifier(_.uuid())},
get:function(a){a=k(a);var b=f.persistentStoreItem(a);return b.$promise.then(function(a){return b})},set:function(a,b){var d=k(a),c=f.persistentStoreItem.update(d,b);return c.$promise.then(function(){return c})},del:function(a){a=k(a);return f.persistentStoreItem.remove(a).$promise},clear:function(){var a=k();return f.persistentStoreForCompany.remove(a).$promise},getForAllCompanies:function(a){var b=f.persistentStore({identifier:c.userIdentifier});return b.$promise.then(function(){var d={};_.forEach(b,
function(b){d[b.company.shortname]={company:b.company};d[b.company.shortname][a]=b[a]});return d})}};e.on(a,"auth.logout",n.regenerateIdentifier);e.on(a,"auth.login",n.regenerateIdentifier);return n}]);h.factory("translate",["$rootScope","$window","db",function(b,a,c){var f,e=function(d){0>=d?console.warn("translate: failed to load Google Translate"):!a.google||!a.google.translate||!a.google.translate.TranslateElement?(console.info("translate: not yet loaded, retrying..."),setTimeout(_.bind(e,_,d-
1),1E3)):(console.info("translate: loaded"),b.$apply(function(){g.isReady=!0}))},g={isReady:!1,initialize:function(b){g.isReady?f?b.append(f):(f=$('<div id="google-translate"></div>'),b.append(f),new a.google.translate.TranslateElement({pageLanguage:"en"},f[0])):console.warn("translate: attempting to initialize before load")}};c.slipstream("isAnonymous")&&e(3);return g}]);h.factory("postBook",["$filter","auth","navigation","require",function(b,a,c,f){return{startBooking:function(b){console.log("postBook: start booking",
b);a.sessionStorage.set("postBook.path",b)},stopBooking:function(e){f.assert(e,"postBook: expected booking");var g=b("bookingUrl")(e),d=a.sessionStorage.get("postBook.path");a.sessionStorage.del("postBook.path");console.log("postBook: stop booking",e,g,d);if(!d)return g;e=c.parseMultiUrl(g);if(!e||0!==d.indexOf(e.path))return g;g={};g[e.key]=e.multiPath;_.extend(g,e.search);return c.extendQuery(d,g)}}}]);h.constant("Showdown",window.Showdown);h.constant("Mailcheck",window.Mailcheck);h.constant("moment",
window.moment);h.constant("Pikaday",window.Pikaday);h.constant("QRCode",window.QRCode);h.factory("filepicker",function(){return window.filepicker||null});h.factory("fileuploader",["$q","$window",function(b,a){var c={},f=window.filepicker;c.upload=function(){var c=b.defer();f.pickAndStore({},{location:"S3"},function(b){var d=b?_.first(b):"";if(d.url){b=d.url.replace(a.slipstream.remoteFileDomain,a.slipstream.remoteFileCdnDomain);var f=d.filename||"attachment",d=(d.mimetype||"").match(/^image\/\S+$/);
c.resolve({url:b,fileName:f,isImage:d})}else c.reject()},function(a){a&&101===a.code?c.resolve():c.reject()});return c.promise};c.uploadAsMarkdown=function(){return c.upload().then(function(a){if(a){var b=a.url,d=a.fileName;a=a.isImage?"!["+T("Description of image")+"]("+b+")":"["+T("View")+" "+d+"]("+b+")";return a}return""})};return c}]);h.factory("d3",function(){return window.d3});h.factory("Raven",function(){return window.Raven||{}});h.factory("diff",function(){return window.JsDiff});h.factory("exporter",
["$q","$rootScope","$timeout","$window","filepicker",function(b,a,c,f,e){var g=document.createElement("a"),d="download"in g&&"Blob"in window,l=function(d,c,f){var g=b.defer();e.store(d,{filename:c,mimetype:f},function(b){a.$safeApply(function(){g.resolve(b.url)})},function(){a.$safeApply(function(){g.reject()})});return g.promise},m=function(a,k,m){m=m||{};var r=b.defer();if(d)c(function(){var b=new Blob([a],{type:m.mediaType}),b=URL.createObjectURL(b);g.setAttribute("href",b);g.setAttribute("download",
k);document.body.appendChild(g);g.click();document.body.removeChild(g);r.resolve()},0,!1);else if(m.openWindow){var t=encodeURIComponent(a);window.open("data:"+m.mediaType+";charset=utf-8,"+t);r.resolve()}else{if(!e||e._queue)return r.reject(),r.promise;l(a,k,"application/octet-stream").then(function(a){f.location.href=a;r.resolve()},function(){r.reject()})}return r.promise},k=function(a){var b="\ufeff";_.forEach(a,function(a){a=_.map(a,function(a){_.isUndefined(a)?a="":_.isString(a)&&(a=a.replace(/^\s+|\s+$/g,
""),a=a.replace(/\s+/g," "),a=a.replace(/,$/,""),a=a.replace(/"/g,'""'),a='"'+a+'"');return a});b+=a.join(",")+"\n"});return b};return{exportToCsvFile:function(a,b,d){d=d||{};d.mediaType="text/csv";a=k(a);return m(a,b,d)},isDownloadSupported:d}}]);h.factory("xmessage",["$window","db",function(b,a){return{broadcast:function(c,f,e){c={type:c};_.extend(c,f);e=e||"*";f="";try{f=_.stringifyJSON(c),a.slipstream("isDebug")&&console.info("xmessage: broadcast",f),b.parent.postMessage(f,e)}catch(g){console.error("xmessage: unable to broadcast",
f)}},on:function(c,f,e,g){g=g||"*";var d=function(b){try{var d=_.parseJSON(b.data);_.isObject(d)&&(a.slipstream("isDebug")&&console.info("xmessage: on",d),f&&d.type===f&&("*"!==g&&(!g||g!==d.origin)||e(d.data)))}catch(c){}};b.addEventListener("message",d);var l=function(){b.removeEventListener("message",d)};c.$on("$destroy",function(){l()});return l}}}]);h.factory("events",["$rootScope",function(b){return{on:function(a,b,f){return a.$on(b,f)},broadcast:function(){b.$broadcast.apply(b,arguments)}}}]);
h.factory("require",function(){var b=function(a,b){a="require: "+a;return b?a+" ("+b+")":a};return{assert:function(a,c){if(!a)throw Error(b("expected '"+a+"' to be true",c));},assertDefined:function(a,c){if(_.isUndefined(a))throw Error(b("expected '"+a+"' to be defined",c));},notNull:function(a,c,f){if(null===a[c])throw Error(b("expected '"+c+"' not to be null",f));},defined:function(a,c,f){if(_.isUndefined(a[c]))throw Error(b("expected '"+c+"' to be defined",f));},unDefined:function(a,c,f){if(!_.isUndefined(a[c]))throw Error(b("expected '"+
c+"' to be undefined",f));},inScope:function(a,c,f){if(_.isUndefined(_.getDotted(a,c)))throw Error(b("expected '"+c+"' to be in scope",f));},notInScope:function(a,c,f){if(!_.isUndefined(a[c]))throw Error(b("expected '"+c+"' not to be in scope",f));}}});h.provider("convert",["moment",function(b){var a=/_([a-z0-9])/g,c=function(b){b=b||"";return"/"===b[0]?b:b.replace(a,function(a,b){return b.toUpperCase()})},f=function(a,d){if(!a)return null;var c=b(a,"YYYY-MM-DDTHH:mm:ssZZ",!0);if(c.isValid())return c;
c=b(a,"YYYY-MM-DDTHH:mm:ss",!0);if(c.isValid())return c;c=b(a,"YYYY-MM-DD",!0);if(c.isValid())return c;throw Error("convert: invalid date "+d+": "+a);},e=/_at$/,g=function(a){if(_.isArray(a))for(var b=0,d=a.length;b<d;b++)g(a[b]);else if(_.isObject(a))for(b in a)if(a.hasOwnProperty(b)){d=a[b];delete a[b];var k=c(b);e.test(b)||"at"===b?a[k]=f(d,k):a[k]=g(d)}return a},d=function(a,b,d){return b+"_"+d.toLowerCase()},l=/([a-z])([A-Z0-9])/g,m=/([0-9])([a-zA-Z])/g,k=function(a){a=a.replace(l,d);return a.replace(m,
d)},n=function(a){var d,c;if(b.isMoment(a))d=a.format();else{if(_.isDate(a))throw Error("convert: expected moment, not date "+a);if(_.isArray(a)){d=[];c=0;for(var e=a.length;c<e;c++)d.push(n(a[c]))}else if(_.isObject(a))for(e in d={},a)e&&(a.hasOwnProperty(e)&&"$"!==e[0])&&(c=k(e),d[c]=n(a[e]));else d=a}return d},s=function(a,b,d){return b+" "+d},p=function(a,b){a=a.toString();a=a.replace(l,s);a=a.replace(m,s);a=a.replace(/-/g," ");return _[b?"titleize":"capitalize"](a.toLowerCase())};this.serverResponse=
g;this.clientRequest=n;this.$get=function(){return{serverResponse:g,clientRequest:n,camelKey:c,unCamelKey:k,humanize:p}}}]);h.factory("shortcutsOverlay",["$rootScope","auth","db","events",function(b,a,c,f){var e={isShowing:!1,shouldConfirmClose:!1,show:function(){e.isShowing=!0},hide:function(){e.isShowing=!1},confirmClose:function(a){e.shouldConfirmClose=a}},g;f.on(b,"navigation.company.updated",function(b,f){if(!c.slipstream("isDebug")){var m=f.company;m&&g!==m&&(g=m,m.adminNotes&&a.permissions.canAdminUpdate(m)&&
e.show())}});return e}]);h.factory("shortcuts",["$document","auth","d",function(b,a,c){var f=[],e={"delete":8,tab:9,enter:13,"return":13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222},g=function(a,b){for(var d=a.length,c=0;c<d;c++)e[a[c]]=b+c};g("1234567890",49);g("abcdefghijklmnopqrstuvwxyz",65);var d={};_.forEach(e,function(a,b){d[a]=b});var l={shift:"shift",ctrl:"ctrl",meta:"meta",alt:"alt"},m=function(a){a=
a.split("+");var b={};_.forEach(l,function(a){b[a]=!1});_.forEach(a,function(a){var d=l[a];d?b[d]=!0:b.keyCode=e[a]});return b};b.on("keydown",function(b){if(a.currentUser.isAuthenticated){var g=$(b.target);if(!c.isTextInput(g)&&!g.is(".js-disable-shortcuts, select")){g={};g.keyCode=e[d[b.which]];g.meta=b.metaKey||!1;g.alt=b.altKey||!1;g.ctrl=b.ctrlKey||!1;g.shift=b.shiftKey||!1;for(var m,l=f.length-1;0<=l;l--)if(m=f[l],g&&m.keys&&g.keyCode===m.keys.keyCode&&g.ctrl===m.keys.ctrl&&g.alt===m.keys.alt&&
g.meta===m.keys.meta&&g.shift===m.keys.shift){b.preventDefault();m.action();break}}}});return{shortcuts:f,register:function(a){a.keys=m(a.keySet);if(a.keys)return f.push(a),a},unregister:function(a){_.overwriteWithout(f,a)}}}]);h.factory("toggles",["$document","$rootScope",function(b,a){$("html").on("click",function(f){var e=$(f.target);e.closest("[ng-toggle], [ng-toggled], [ng-toggled-show]").length||$.contains(b[0].documentElement,f.target)&&(e.closest(".select2-container, .pika-select").length||
a.$apply(function(){_.forEach(c.toggles,function(a,b){if(a.autoClose&&(!a.group||a.isCloseableGroup))a.state=!1})}))});var c={toggles:{},create:function(b,e){var g=c.toggles[b];g?(g.state=e.defaultState||g.state||!1,g.count+=1):(g={autoClose:e.autoClose||!1,state:e.defaultState||!1,group:e.group||null,isCloseableGroup:e.isCloseableGroup||!1,when:e.when||_.always,count:1},c.toggles[b]=g,g.group&&(g.deregisterGroupWatch=a.$watch(function(){return g.state},function(a){a&&_.forEach(c.toggles,function(a,
b){g!==a&&g.group===a.group&&(a.state=!1)})})))},destroy:function(a){var b=c.toggles[a];b?(b.count-=1,b.count||(b.deregisterGroupWatch&&b.deregisterGroupWatch(),delete c.toggles[a])):console.warn("invalid toggle",a)},toggle:function(a,b){var g=c.toggles[a];g?g.when()?(b=_.isUndefined(b)?!g.state:!!b,g.state=g.group?g.isCloseableGroup?b:!0:b):console.info("toggles: disabled toggle",a):console.warn("toggles: invalid toggle",a)},state:function(a){a=c.toggles[a];return!a?!1:a.state},closeAll:function(){_.forEach(c.toggles,
function(a){a.state=!1})}};return c}]);angular.module("lib.services.interpolate",[]).provider("$interpolate",[function(){var b="{{",a="}}",c="{!",f="!}";this.startSymbol=function(a){return a?(b=a,this):b};this.endSymbol=function(b){return b?(a=b,this):a};this.staticStartSymbol=function(a){return a?(c=a,this):c};this.staticEndSymbol=function(a){return a?(f=a,this):f};this.$get=["$parse","$exceptionHandler","$sce",function(e,g,d){var l=b.length,m=a.length,k=c.length,n=f.length;g=function(g,p,h){for(var t,
v,y=0,q=[],B=g.length,u=!1,z,C,F,x,w=[];y<B;)-1!=(t=g.indexOf(b,y))&&-1!=(v=g.indexOf(a,t+l))?(y!=t&&q.push(g.substring(y,t)),q.push({fn:e(z=g.substring(t+l,v)),exp:z,"static":!1}),y=v+m,u=!0):-1!=(t=g.indexOf(c,y))&&-1!=(v=g.indexOf(f,t+k))?(y!=t&&q.push(g.substring(y,t)),q.push({fn:e(z=g.substring(t+k,v)),exp:z,"static":!0}),y=v+n,u=!0):(y!=B&&q.push(g.substring(y)),y=B);if(!(B=q.length))q.push(""),B=1;if(h&&1<q.length)throw Error("$interpolate: error while interpolating: SCE violation");if(!p||
u)return w.length=B,x=function(a){if("undefined"!==typeof x.value)return x.value;try{for(var b=0,c=0,e=B,f;c<e;c++)f=q[c],"object"===typeof f?(C=f.fn(a),C=h?d.getTrusted(h,C):d.valueOf(C),F=typeof C,null===C||"undefined"===F?C="":"number"===F?C=""+C:"string"!==F&&(C=angular.toJson(C)),f.static?q[c]=C:b++):C=f,w[c]=C;var k=w.join("");b||(x.value=k);return k}catch(m){console.error("unable to interpolate",g,"error",m)}},x.exp=g,x.parts=q,x};g.startSymbol=function(){return b};g.endSymbol=function(){return a};
g.staticStartSymbol=function(){return c};g.staticEndSymbol=function(){return f};return g}]}]);h.factory("selectedItems",["navigation",function(b){return{extendUrl:function(a,c){if(c.length){var f={"selected-items":_.pluck(c,"pk").join(",")};return b.compose(a,f)}return a}}}]);h.factory("parseAttrsForScope",["$parse",function(b){return function(a,c,f,e){var g={},d=_.isString(e)?function(a){return e+_.capitalize(a.slice(0,1))+a.slice(1)}:function(a){return a};_.forEach(f,function(e,f){var k=d(f);"@"===
e?g[f]=a[k]:"="===e?g[f]=c.$eval(a[k]):"&"===e&&(g[f]=b(a[k]).bind(null,c))});return g}}]);h.factory("tableHeaders",["$parse",function(b){return{parsePredicate:function(a,c,f,e){e=e||"$row";var g=_.choose(c.split(";"),function(a){if(a)return b(a)}),g=_.map(g,function(b,f){return function(f){var g={};g[e]=f;g=b(a,g);moment.isMoment(g)&&(g=g.unix());return _.isUndefined(g)?(console.warn("ng-table-header: predicate returned undefined",c,f),0):g}});1===g.length&&(g=g[0]);g.source=c;g.isDefault=f||!1;
return g}}}]);h.factory("autoExport",["$filter","$q","$timeout","exporter","flash",function(b,a,c,f,e){var g=b("stripNewlines"),d=function(a){return a.replace(/\u2011/g,"-")},l=function(a){return _.map(a.contents(),function(a){var b=$(a);if(3===a.nodeType)return b.text();if(b.is(":visible")&&!b.is("[ng-auto-export-skip]"))return l(b)}).join(" ")},m=function(a){a=!_.isUndefined(a)?a:1;return _.map(_.range(a),_.constant(""))},k=function(a){if(!a||!a.length)console.warn("autoExport: no exports found");
else{if(1===a.length)return a[0];var b={rows:a[0].rows,filename:a[0].filename};_.forEach(_.rest(a),function(a){b.rows.push(m());_.ref.append(b.rows,a.rows)});return b}},n=function(a,b){var c=b.rowSelector?b.rowSelector:b.isCSS?"> .thead > .tr, > .tbody > .tr, > .tfoot > .tr":"> thead > tr, > tbody > tr, > tfoot > tr",e=b.cellSelector?b.cellSelector:b.isCSS?"> .td":"> td",f=a.data().ngAutoExportSkip;if(!f||!f()){var k=[];_.forEach(a.find(c),function(a){a=$(a);var b;if(!(b=a.data().ngAutoExportSkip)||
!b()){var c=[];_.forEach(a.find(e),function(a){a=$(a);var b=a.data(),e;if(!(e=b.ngAutoExportSkip)||!e()){var f;e=(f=b.ngAutoExportValue)?f():l(a);c.push(d(g(e).trim()));f=(f=a.prop("colspan"))?parseInt(f,10):1;_.ref.append(c,m(f-1))}});k.push(c)}});return{rows:k}}},s={},p={status:"ready",ready:function(){return"ready"===p.status||"error"===p.status},autoExport:function(b,d,g){b=b||"default";d=d||b;if(p.ready()){var m=s[b]||[];if(m.length){var l=function(){p.status="error";e.error("Error exporting "+
d)};p.status="processing";c(function(){var b=[];try{var c=[];_.forEach(m,function(d){if(d.process){var e=d.process(),e=a.when(e);c.push(e);e.then(function(a){a&&b.push({rows:a})})}else{var e=d.tableSelector?d.tableSelector:d.isCSS?".table":"table",f=d.element;f.is(e)||(f=f.find(e));_.forEach(f,function(a){(a=n($(a),d))&&b.push(a)})}});a.all(c).then(function(){var a=k(b);a?(p.status="exporting",f.exportToCsvFile(a.rows,d,g).then(function(){p.status="ready"},l)):p.status="ready"})}catch(e){l(),console.error("Error exporting",
e)}},0,!1)}else console.warn("autoExport: no exports")}else console.warn("autoExport: not ready")},addExport:function(a,b,d){a=a||"default";var c=s[a]=s[a]||[];a={element:b,namespace:a};_.extend(a,d||{});c.push(a);return a},removeExport:function(a){var b=s[a.namespace]=s[a.namespace]||[];_.ref.remove(b,a)},isDownloadSupported:f.isDownloadSupported,canExport:function(a){return s[a]?0<s[a].length:!1}};return p}]);h.factory("scrollbar",[function(){var b={width:null,getWidth:function(){if(null!==b.width)return b.width;
var a=document.createElement("p");a.style.width="100%";a.style.height="200px";var c=document.createElement("div");c.style.position="absolute";c.style.top="0px";c.style.left="0px";c.style.visibility="hidden";c.style.width="200px";c.style.height="150px";c.style.overflow="hidden";c.appendChild(a);document.body.appendChild(c);var f=a.offsetWidth;c.style.overflow="scroll";a=a.offsetWidth;f==a&&(a=c.clientWidth);document.body.removeChild(c);b.width=Math.max(f-a,0);return b.width}};return b}]);h.factory("dateUtils",
["moment","models",function(b,a){var c=/^\d\d:\d\d$/,f=function(a){return _.isUndefined(a)?b():b().tz(a)},e=function(a,b){return function(d){return[f(d).subtract(1,a+"s").startOf(a),b?f(d).subtract(1,a+"s"):f(d).subtract(1,a+"s").endOf(a)]}},g=function(a,b){return function(d){return[f(d).startOf(a),b?f(d):f(d).endOf(a)]}},d=function(a){return function(b){return[f(b).add(1,a+"s").startOf(a),f(b).add(1,a+"s").endOf(a)]}},l=function(a){return function(b){return[f(b).startOf("day"),f(b).add(a-1,"days").endOf("day")]}},
m=function(a){return function(b){return[f(b).subtract(a-1,"days").startOf("day"),f(b).endOf("day")]}},k=a.Report,n={};n[k.TODAY_DATE_RANGE]=g("day");n[k.THIS_WEEK_DATE_RANGE]=g("week");n[k.THIS_WEEK_TO_DATE_DATE_RANGE]=g("week",!0);n[k.THIS_MONTH_DATE_RANGE]=g("month");n[k.THIS_MONTH_TO_DATE_DATE_RANGE]=g("month",!0);n[k.THIS_QUARTER_DATE_RANGE]=g("quarter");n[k.THIS_QUARTER_TO_DATE_DATE_RANGE]=g("quarter",!0);n[k.THIS_YEAR_DATE_RANGE]=g("year");n[k.THIS_YEAR_TO_DATE_DATE_RANGE]=g("year",!0);n[k.REMAINING_THIS_YEAR_DATE_RANGE]=
function(a){return function(b){return[f(b).startOf("day"),f(b).endOf(a)]}}("year");n[k.YESTERDAY_DATE_RANGE]=e("day");n[k.LAST_WEEK_DATE_RANGE]=e("week");n[k.LAST_WEEK_TO_DATE_DATE_RANGE]=e("week",!0);n[k.LAST_MONTH_DATE_RANGE]=e("month");n[k.LAST_MONTH_TO_DATE_DATE_RANGE]=e("month",!0);n[k.LAST_QUARTER_DATE_RANGE]=e("quarter");n[k.LAST_QUARTER_TO_DATE_DATE_RANGE]=e("quarter",!0);n[k.LAST_YEAR_DATE_RANGE]=e("year");n[k.LAST_YEAR_TO_DATE_DATE_RANGE]=e("year",!0);n[k.TOMORROW_DATE_RANGE]=d("day");n[k.NEXT_WEEK_DATE_RANGE]=
d("week");n[k.NEXT_MONTH_DATE_RANGE]=d("month");n[k.NEXT_YEAR_DATE_RANGE]=d("year");n[k.LAST_SEVEN_DAYS_DATE_RANGE]=m(7);n[k.LAST_THIRTY_DAYS_DATE_RANGE]=m(30);n[k.NEXT_SEVEN_DAYS_DATE_RANGE]=l(7);n[k.NEXT_THIRTY_DAYS_DATE_RANGE]=l(30);var s={};s[k.THIS_WEEK_DATE_RANGE]=[!0,!0];s[k.THIS_WEEK_TO_DATE_DATE_RANGE]=[!0,!1];s[k.LAST_WEEK_DATE_RANGE]=[!0,!0];s[k.LAST_WEEK_TO_DATE_DATE_RANGE]=[!0,!1];s[k.NEXT_WEEK_DATE_RANGE]=[!0,!0];return{DATE_RANGES:n,dateRange:function(a,b){var d=n[a];d||(d=n[k.TODAY_DATE_RANGE]);
var c=d(b.timezone);b.features.isSundayBased||(d=s[a])&&_.forEach(d,function(a,b){a&&c[b].add(1,"days")});return c},isInvertedRange:function(a){if(!a[0]||!a[1])return!1;var d=c.test(a[0]),e=d?"HH:mm":null;if(d&&"00:00"===a[1])return!1;d=b(a[0],e);a=b(a[1],e);return d.isValid()&&a.isValid()&&d>a}}}]);h.factory("searchTerms",[function(){return{}}]);h.factory("flows",["$q","availabilityCalendarController","cache","clientOptions","db","models","navigation","require","urls",function(b,a,c,f,e,g,d,l,m){var k=
g.FlowNode,n=d.getPks("selected-items"),s=function(a,b){!a.children.length&&b&&(a.emptyPageChildren=_.map(b,function(b){return{cls:k.cls,uri:"",pk:null,company:a.company,type:k.ITEM_TYPE,parent:a,item:b,properties:{},unicode:b.unicode}}))},p,h=function(a,b){var d=e.defaultFlowPage({shortname:a});d.$promise.then(function(){b.resolve();t.initialFlowNode=d.flowNode},b.reject)},t={wrapEndpoint:function(a,b){return function(d,c,f,g,k){g=g||{};n.length&&(g.selectedItems=n.join(","));b||(g.isPage=!0);k=
k||{};k.ignoreQueryParamsInCacheUri=!0;k.sideKeys=["emptyPageItems"];d=a(d,c,f,g,k);d.$promise.then(function(a){a!==e.CANCELLED&&s(b?a.primaryData.flowNode:a.primaryData,a.emptyPageItems)});return d}},isNoFlow:function(){return t.initialFlowNode===k.NO_FLOW},currentFlowNodePk:function(){var a=d.get(k.FLOW_QUERY);return"no"===a?!1:a?_.int(a):null},currentFlowNodeUrl:function(a,b){var d=t.currentFlowNodePk();if(!1===d)return null;var c;if(d)return c=b?m.company.flowNode.calendar:m.company.flowNode.index,
m.populate(c,{flowNodePk:d,shortname:a.shortname});c=b?m.company.items.calendar:m.company.items.index;return a.$url(c)},currentFlowNodeFromCache:function(a){l.assert(t.initialFlowNode,"flows must be initialized");var b=t.currentFlowNodePk();if(b){a={shortname:a,flowNodePk:b};b=m.populate(m.api.flowNode,a);b=c.cache[b];if(!b||!b.breadcrumbs)b=e.flowNode(a);return b}return t.initialFlowNode},initialFlowNode:void 0,initialItemBindings:void 0,initialize:function(a){if(p)return console.log("flows: already initialized"),
p;var c=b.defer();p=c.promise;var f=t.currentFlowNodePk();if(!1===f){var g=d.pathStartsWith(m.company.item.index);if(g)return t.initialItemBindings=g,t.initialFlowNode=k.NO_FLOW,c.resolve(),p;d.clear(k.FLOW_QUERY,!0)}if(d.get(k.IS_SUGGESTED_QUERY))g=[],g.push(e.defaultFlowPage({shortname:a}).$promise),f&&!t.isOnFlowNodePage()&&g.push(e.flowNode({shortname:a,flowNodePk:f}).$promise),b.all(g).then(function(a){t.initialFlowNode=a[0].primaryData.flowNode;c.resolve()},c.reject);else if(f){var l=e.flowNode({shortname:a,
flowNodePk:f});l.$promise.then(function(){t.initialFlowNode=l;c.resolve()},function(b){d.clear(k.FLOW_QUERY,!0);h(a,c)})}else h(a,c);return p},initialUrl:function(){l.assert(t.initialFlowNode,"flows must be initialized");return t.initialFlowNode===k.NO_FLOW?m.populate(m.company.item.index,t.initialItemBindings):t.initialFlowNode.$url(m.company.flowNode.index)},extendWithFlow:function(a){var b=k.FLOW_QUERY,c=d.get(b);if(_.isUndefined(c))return a;var e={};e[b]=c;return d.compose(a,e,!0)},calendarController:function(b,
d,c){var g=e.company.calendar,k={shortname:d.company.shortname},m={allowGrouped:"yes",bookableOnly:f.isBookableOnly?"yes":"no"};0<d.childrenCount?m.flow=d.pk:n.length&&(g=e.items.calendar,k.itemPks=n.join(","));return a(b,_.extend({url:c.url,company:d.company,endpoint:g,params:k,queryParams:m},c))},rootOf:function(a){l.assert(a.breadcrumbs,"expected full cached flowNode");return _.first(a.breadcrumbs)||a},showInitialFlowNodeLink:function(a){return!t.initialFlowNode||t.initialFlowNode===k.NO_FLOW||
t.rootOf(t.initialFlowNode)===t.rootOf(a)?!1:!0},isOnInitialFlowNode:function(){l.assert(t.initialFlowNode,"flows must be initialized");var a=t.currentFlowNodePk();return null===a||a===t.initialFlowNode.pk},isOnFlowNodePage:function(){return!(!d.pathEquals(m.company.items.index)&&!d.pathStartsWith(m.company.items.calendar))},initialFlowNodeUrl:function(){var a={};a[k.IS_SUGGESTED_QUERY]="";return d.compose(t.initialFlowNode.$url(m.company.flowNode.index),a)}};return t}]);h.run(["$rootScope","flows",
"searchTerms","shortcutsOverlay","toggles","translate",function(b,a,c,f,e,g){b.toggles=e;b.translate=g;b.searchTerms=c;b.shortcutsOverlay=f;b.flows=a}])})();
(function(){var h=angular.module("lib.factories",[]);h.factory("dataController",["$q","cache","db",function(b,a,c){var f={};return function(e,g){g=g||{};var d=g.successCallback||_.ignore,l=g.errorCallback||_.ignore;e.dataCtrl={STALE:f,status:"loading",isStale:!1};var m=!1;e.$on("$destroy",function(){_.forEach(g.promises,function(a){a&&a.cancel&&a.cancel()});m=!0});var k=function(a){e.dataCtrl.status=a;e.dataCtrl.isStale=!1},n=function(a){if(a){var b=c.errorStatus(a.status);b&&(l(a),k(b))}},s=function(a){if(!m){var b=
d(a);b&&_.isFunction(b.then)?b.then(function(){k("success")},n):k("success");return a}},p=function(){e.dataCtrl.status="loading";var c=_.choose(g.promises||[]);if(!c.length)return s();g.stale&&_.every(g.stale,function(b){return!_.isUndefined(b)&&!a.fresh(b)})&&(d(e.dataCtrl.STALE),e.dataCtrl.isStale=!0,e.dataCtrl.status="success");b.all(c).then(s,n)};e.dataCtrl.showLoading=function(){e.dataCtrl.status="loading"};e.dataCtrl.showComplete=function(){e.dataCtrl.status="success"};g.retry&&(e.retry=function(){p()});
p();return e}}]);h.factory("navigationController",["navigation",function(b){return function(a,c){a.navigationCtrl={entries:c.entries||[]};_.forEach(a.navigationCtrl.entries,function(a){_.isUndefined(a.isCurrent)&&(a.isCurrent=function(){var c=a.navigationUrl||a.url;return!c?!1:(a.equals?b.pathEquals:b.pathStartsWith)(c)})});a.navigationCtrl.isVisible=function(a){return _.isUndefined(a.isVisible)?!0:_.isFunction(a.isVisible)?a.isVisible():a.isVisible};return a}}]);h.factory("headerController",["$timeout",
"auth","models","navigation","navigationController","urls",function(b,a,c,f,e,g){return function(d,l){d.headerCtrl={};d.headerCtrl.logout=function(){d.headerCtrl.company?f.navigate(d.headerCtrl.company.$url(g.company.login)):f.navigate(g.index);b(function(){a.logout()})};a.currentUser.isAuthenticated&&(d.headerCtrl.relatedCompanies=a.relatedCompanies());d.$watch(l.companyFn,function(b){d.headerCtrl.company=b;e(d,{entries:[{text:"Admin",url:b.$url(g.dashboard.admin.index),isVisible:function(){return b.isAdmin&&
a.permissions.can("viewAdminSection",b)},shortcut:"shift+a",shortcutDescription:"Show Admin."},{text:"Bookings",url:b.$url(g.dashboard.bookings.index),isVisible:function(){return(b.isCharter||b.isAffiliate)&&a.permissions.can("viewBookingsSection",b)},shortcut:"shift+b",shortcutDescription:"Show Bookings calendar."},{text:"Manifest",url:b.$url(g.dashboard.manifest.index),isVisible:function(){return b.isCharter&&a.permissions.can("viewManifestSection",b)},shortcut:"shift+m",shortcutDescription:"Show Manifest."},
{text:"Reports",url:b.$url(g.dashboard.reports.index),isVisible:function(){return a.permissions.canList(c.Report,b)},shortcut:"shift+r",shortcutDescription:"Show Reports."},{text:"Items",url:b.$url(g.dashboard.items.index),isVisible:function(){return b.isCharter&&a.permissions.can("viewItemsSection",b)},shortcut:"shift+i",shortcutDescription:"Show Items.",isCurrent:function(){return f.pathStartsWith(g.dashboard.items.index)||f.pathStartsWith(g.dashboard.resources.index)}},{text:"Settings",url:b.$url(g.dashboard.settings.index),
shortcut:"shift+s|shift+e",shortcutDescription:"Show Settings."},{text:"Website Admin",url:"https://content.fareharbor.me/wp-admin/",isVisible:_.getter(b,"isAdmin"),isOutbound:!0},{text:"Help",url:b.$url(g.root.help),isOutbound:!0}]})});return d}}]);h.factory("emailSubjectsController",["$q","db","models","require",function(b,a,c,f){var e=[c.Booking.cls,c.Order.cls,c.Availability.cls];return function(g,d){f.defined(d,"modelKey");f.defined(d,"target","emailSubjectsCtrl: target must be provided");f.assert(_.contains(e,
d.target.cls),"emailSubjectsCtrl: target must be an availability, booking, or an order");var l={};g[d.controllerAs||"emailSubjectsCtrl"]=l;var m=d.target.company,k=d.prefix||"",n=k+"type",s=k+"subject",p=k+"language",h=function(a,b){b||(b=_.getDotted(g,d.modelKey));return _.isObject(b)?_.getDotted(b,a):void 0},t=function(a,b){_.getDotted(g,d.modelKey)[a]=b};l.resetToDefault=function(){var a=h(n),b="";g.isSubjectEditable=c.Notification.isSubjectEditable(a);a===c.Notification.DISPUTE_TYPE&&(b=c.Notification.subjectForDisputeType(d.target));
d.subjectKeys?_.forEach(d.subjectKeys,function(a,d){t(d,b||g.subjects[a]||g.subjects[m.language])}):(a=h(p),t(s,b||g.subjects[a]))};var v=!1,y=b.defer();l.promises=[y.promise];g.$watchCollection(function(){return _.getDotted(g,d.modelKey)},function(b,e){var f=h(n,b),k=h(n,e),s=h(p,b),t=h(p,e);if(!v&&f)if(f===c.Notification.DISPUTE_TYPE)l.resetToDefault();else{if(d.target.cls===c.Availability.cls){if(g.subjects&&f===k)return;k=_.values(d.subjectKeys).join(",");g.subjects=a.subjects.availability({shortname:m.shortname,
type:f,availabilityPk:d.target.pk,languages:k})}else{if(!s||g.subjects&&f===k&&s===t)return;g.subjects=d.target.cls===c.Order.cls?a.subjects.order({shortname:m.shortname,type:f,orderUuid:d.target.uuid,language:s}):a.subjects.booking({shortname:m.shortname,type:f,bookingUuid:d.target.uuid,language:s})}v=!0;g.subjects.$promise.then(function(){l.resetToDefault();v=!1;y.resolve()}).catch(function(){y.reject()})}});return l}}]);h.factory("cannedMessagesController",["$q","auth","db","flash","models","navigation",
"require","toggles",function(b,a,c,f,e,g,d,l){return function(m,k){d.defined(k,"modelKey");d.defined(k,"noteField");k.cannedField=k.cannedField||"message";var n={};m.cannedMessagesCtrl=n;n.toggleKey="canned-message-"+m.$id;n.useDefaultMessage=!k.languageKey&&!k.onTranslationsLoad&&!k.languageOverride;var s=function(a,b){var d=e.SupportedLanguage.rootLanguage(b),c=_.find(a,{language:b});return(c=(c=c||_.find(a,{language:d}))||_.find(a,function(a){return e.SupportedLanguage.shareRootLanguage(a.language,
b)}))?c.fieldValue:null};n.onTranslationsLoad=k.onTranslationsLoad||function(a,b){var d=b[k.cannedField],c=k.languageOverride||m[k.modelKey][k.languageKey],g=a(c);g?d=g:e.SupportedLanguage.shareRootLanguage(b.company.language,c)||f.warn(interpolate(T("Selected canned message is missing translation for %(language)s, using original message instead."),{language:e.SupportedLanguage.display(c)}));n.addMessageToNote(d)};n.select=function(b){var d=a.permissions.canView(e.SupportedLanguage,b.company),g=b.company.companyFeatures.isContentTranslationEnabled;
if(n.useDefaultMessage||!g||!d){n.addMessageToNote(b[k.cannedField]);var h=e.SupportedLanguage.shareRootLanguage(k.languageOverride||m[k.modelKey][k.languageKey],b.company.language);g&&(!d&&!h)&&f.warn(interpolate(T("You do not have permission to view translated content for %(companyName)s. Please contact your administrator."),{companyName:b.company.name}));l.toggle(n.toggleKey,!1)}else{n.loadingCannedMessagePk=b.pk;var y=c.translationsForField({shortname:b.company.shortname,objectType:b.cls,objectId:b.pk,
objectField:k.cannedField});return y.$promise.then(function(){var a=_.filter(y.translationsForField,function(a){return a.supportedLanguage.isLive}),a=_.bind(s,null,a);n.onTranslationsLoad(a,b)}).finally(function(){n.loadingCannedMessagePk=!1;l.toggle(n.toggleKey,!1)})}};n.addMessageToNote=k.addMessageToNote||function(a){var b=m[k.modelKey][k.noteField]||"",b=b.replace(/\s+$/g,"");""!==b&&(b=b.concat("\n\n"));a=b.concat(a);m[k.modelKey][k.noteField]=k.formattingFn?k.formattingFn(a):a};n.TYPES=k.types||
e.CannedMessage.TYPES;n.displayType=e.CannedMessage.displayType;n.promises=[];k.cannedMessagesByType||(k.cannedMessagesByType={},_.forEach(n.TYPES,function(a){k.cannedMessagesByType[a]=[]}),_.forEach(_.unique([g.currentCompany,a.currentUser.company,k.company]),function(b){b&&a.permissions.canList(e.CannedMessage,b)&&(b=c.cannedMessages({shortname:b.shortname}),n.promises.push(b.$promise.catch(_.ignore)))}),b.all(n.promises).then(function(a){a=_.sortBy(_.flatten(_.pluck(a,"primaryData")),"name");_.forEach(a,
function(a){_.contains(n.TYPES,a.type)&&k.cannedMessagesByType[a.type].push(a)})}));n.cannedMessagesByType=k.cannedMessagesByType;n.isEmptyMessage=function(a){a=a[k.cannedField];return _.isString(a)?_.isEmpty(a):_.isNull(a)};n.hasEmptyMessages=function(a){return _.all(n.cannedMessagesByType[a],n.isEmptyMessage)};return m}}]);h.factory("imageUploadController",["$q","filepicker","require",function(b,a,c){return function(f,e){c.defined(e,"modelKey");var g=e.id||"image",d=e.field||"imageUrl",l=e.width||
2560,m=e.height||2560,k=_.isUndefined(e.resetAfterSubmit)?!0:e.resetAfterSubmit,n=function(){_.extend(f.imageUploadCtrl[g],{url:"",urls:{},initialUrls:{},isSelected:!1,isPristine:!0,isUploading:!1,isCropping:!1,isSavingCrop:!1,crop:{},unCroppedUrl:null})},s=function(d){var c=b.defer();a.store({url:d},{location:"S3"},function(a){console.log("imageUploadCtrl: stored image ",a.url);c.resolve(a)},function(a){console.error("imageUploadCtrl: unable to store image",a);c.reject(a)});return c.promise},p=function(d){var c=
b.defer(),e={height:m,width:l,fit:"max"};a.convert(d,e,function(a){f.$safeApply(function(){console.log("imageUploadCtrl: converted image",a.url,e);c.resolve(a)})},function(a){f.$safeApply(function(){console.error("imageUploadCtrl: unable to convert image",a);c.reject(a)})});return c.promise};if(!f.imageUploadCtrl||f.imageUploadCtrl.scope!==f)f.imageUploadCtrl={scope:f,ids:[]},f.imageUploadCtrl.isPristine=function(){return _.every(f.imageUploadCtrl.ids,function(a){return f.imageUploadCtrl[a].isPristine})},
f.imageUploadCtrl.isUploading=function(){return _.some(f.imageUploadCtrl.ids,function(a){return f.imageUploadCtrl[a].isUploading})};f.imageUploadCtrl.ids.push(g);f.imageUploadCtrl[g]={};f.imageUploadCtrl[g].clear=function(){f.imageUploadCtrl[g].urls[d]="";f[e.modelKey][d]="";_.extend(f.imageUploadCtrl[g],{url:"",isSelected:!1,isPristine:!1,crop:{},unCroppedUrl:null})};f.imageUploadCtrl[g].select=function(){f.imageUploadCtrl[g].isUploading=!0;a.pick({mimetypes:["image/*"],services:["COMPUTER","WEBCAM",
"FACEBOOK","INSTAGRAM","URL"]},function(a){f.$apply(function(){p(a).then(function(a){f.imageUploadCtrl[g].urls[d]=a.url;f[e.modelKey][d]=a.url;_.extend(f.imageUploadCtrl[g],{url:a.url,isSelected:!0,isPristine:!1,isUploading:!1,crop:{},unCroppedUrl:null})},function(a){console.error("imageUploadCtrl.select: unable to convert image",a);f.imageUploadCtrl[g].isUploading=!1})})},function(a){f.$apply(function(){101!==a.code&&console.error("imageUploadCtrl.select: unable to pick image",a);f.imageUploadCtrl[g].isUploading=
!1})})};f.imageUploadCtrl[g].edit=function(){c.defined(e,"elementKey");var a=f[e.elementKey][d];f.imageUploadCtrl[g].urls[d]=a;f.imageUploadCtrl[g].initialUrls[d]=a;f[e.modelKey][d]=a;_.extend(f.imageUploadCtrl[g],{url:a,isSelected:!!a,crop:{},unCroppedUrl:null})};f.imageUploadCtrl[g].submit=function(){var a=f.imageUploadCtrl[g].urls[d],a=f.imageUploadCtrl[g].initialUrls[d]!==a&&a?s(a):b.reject();f.imageUploadCtrl[g].isPristine=!0;k&&n();return a};f.imageUploadCtrl[g].cancel=function(){n()};f.imageUploadCtrl[g].saveCrop=
function(){f.imageUploadCtrl[g].isSavingCrop=!0;var b={fit:"crop",crop:[f.imageUploadCtrl[g].crop.x,f.imageUploadCtrl[g].crop.y,f.imageUploadCtrl[g].crop.width,f.imageUploadCtrl[g].crop.height],format:"jpg",quality:90},c=f.imageUploadCtrl[g].url;a.stat({url:c},function(k){k.url=c;a.convert(k,b,function(a){f.$safeApply(function(){f[e.modelKey][d]=a.url;f.imageUploadCtrl[g].urls[d]=a.url;_.extend(f.imageUploadCtrl[g],{url:a.url,isPristine:!1,isCropping:!1,isSavingCrop:!1,unCroppedUrl:c})})},function(a){console.error("imageUploadCtrl.saveCrop: unable to crop image",
a)})})};f.imageUploadCtrl[g].startCropping=function(){f.imageUploadCtrl[g].unCroppedUrl&&(f.imageUploadCtrl[g].url=f.imageUploadCtrl[g].unCroppedUrl);f.imageUploadCtrl[g].isCropping=!0};f.imageUploadCtrl[g].cancelCrop=function(){f.imageUploadCtrl[g].isCropping=!1;f.imageUploadCtrl[g].url=f[e.modelKey][d]};n();return f}}]);h.factory("splitPaymentController",["require","toggles",function(b,a){return function(b,f){b.splitPaymentCtrl={customerCount:f.customerCount(),amount:f.amount(),divideByPeople:1,
payForPeople:1,splitAmount:0};b.$watch(function(){return f.amount()},function(a){b.splitPaymentCtrl.amount=a});b.$watch(f.customerCount,function(a){a=Math.max(1,a);b.splitPaymentCtrl.customerCount=a;b.splitPaymentCtrl.divideByPeople=a;b.splitPaymentCtrl.payForPeople=Math.min(b.splitPaymentCtrl.divideByPeople,b.splitPaymentCtrl.payForPeople)});b.$watch(function(){var a=_.roundHalfToEven(b.splitPaymentCtrl.amount*b.splitPaymentCtrl.payForPeople/b.splitPaymentCtrl.divideByPeople);isFinite(a)||(a=0);
return a},function(a){b.splitPaymentCtrl.splitAmount=a});b.splitPaymentCtrl.useSplitAmount=function(){var e=Math.min(b.splitPaymentCtrl.splitAmount,f.max());0>=e||(f.amount(e),a.toggle("splitPaymentCalc",!1))}}}]);h.factory("reorderController",["$window","db","flash",function(b,a,c){return function(f,e){var g=e.reorderCallback||_.ignore,d=e.reorderConfirm,l=e.reorderConfirmWhen||(d?_.always:_.never);f=f||{};f.reorderCtrl={};f.reorderCtrl.reorder=function(m,k,n){var s={},p=0;k&&(s.previousPk=k.pk,
p=(k.sortableIndex||0)+0.1);!n&&e.alwaysLast&&(n=e.alwaysLast);n&&(s.nextPk=n.pk,p=(n.sortableIndex||0)-0.1);var h;e.collectionKey?h=_.get(f,e.collectionKey):e.collectionFn&&(h=e.collectionFn(m));if(h){if(l(m,k,n)&&!b.confirm(d||T("Are you sure you want to reorder this list?")))return!1;m.sortableIndex=p;_.ref.reorder(h,m,k,n);m=a.reorder({shortname:(m.company?m.company:e.company).shortname,objectCls:m.cls?m.cls:e.cls,objectPk:m.pk},{},null,s);g(m);m.$promise.then(function(){c.success(T("Saved sort order"))},
function(){c.error(T("Sort order not saved, please try again."))})}};return f}}]);h.factory("listController",["reorderController","imageUploadController","urls","events",function(b,a,c,f){return function(e,g){var d=g.get,l=g.create||d&&d.create,m=g.remove,k=g.successCallback||_.ignore,n=g.errorCallback||_.ignore,s=g.submitCallback||_.ignore,p=g.removeCallback||_.ignore,h=_.isFunction(g.params)?g.params:_.constant(g.params||{}),t=c.extract,v=_.isUndefined(g.reset)?!0:g.reset,y=_.isUndefined(g.closeAfterSubmit)?
!0:g.closeAfterSubmit,q=!!g.imageUpload,B=g.defaultModel||{};_.isFunction(B)||(B=_.constant(B));e[g.modelKey]=_.extend({},B());q&&a(e,{modelKey:g.modelKey});d&&(g.collectionKey&&!_.isArray(_.get(e,g.collectionKey)))&&_.set(e,g.collectionKey,d(h()));e.listCtrl={};e.listCtrl.submit=function(a){var b=e[g.modelKey],d=s(a);d&&(b=_.extend({},b,d));var c=(g.createFn?g.createFn():l)(h(),b,a);c.$promise.then(function(b){if(g.collectionKey){var d=_.get(e,g.collectionKey);d&&(_.isArray(c)?g.overwrite?_.overwrite(d,
c):_.ref.append(d,c):d.push(c))}e.listCtrl.cancel(a);g.refreshActivities&&f.broadcast("dashboard.shared.ActivitiesCtrl.refresh");q&&e.imageUploadCtrl.image.submit();k(c,a,b)},function(b){n(b,a)})};e.listCtrl.adding=g.adding||!1;e.listCtrl.cancel=function(a){y&&(e.listCtrl.adding=!1);v&&(e[g.modelKey]=_.extend({},B()));a.$setPristine()};e.listCtrl.add=function(){e.listCtrl.adding=!0};e.listCtrl.toggle=function(){e.listCtrl.adding=!e.listCtrl.adding};e.listCtrl.close=function(a){e.listCtrl.adding=!1;
a&&v&&(e[g.modelKey]=_.extend({},B()),a.$setPristine())};g.sortable&&g.collectionKey&&(e.listCtrl.reorder=b(e,{collectionKey:g.collectionKey,reorderCallback:g.reorderCallback,reorderConfirm:g.reorderConfirm,reorderConfirmWhen:g.reorderConfirmWhen,alwaysLast:g.alwaysLast,company:g.company}).reorderCtrl.reorder);g.remove&&(e.listCtrl.remove=function(a,b){e.listCtrl.status="removing";m(t(a),{},b).$promise.then(function(){e.listCtrl.status="success";b&&_.overwrite(b,{});g.collectionKey&&_.overwriteWithout(_.get(e,
g.collectionKey),_.isReferenceEqualTo(a));g.refreshActivities&&f.broadcast("dashboard.shared.ActivitiesCtrl.refresh");p(a)})});return e}}]);h.factory("createController",[function(){return function(b,a){var c=a.get||{},f=a.create||c.create,e=a.successCallback||_.ignore,g=a.errorCallback||_.ignore,d=a.submitCallback||_.ignore,l=_.isFunction(a.params)?a.params:_.constant(a.params||{}),m=_.isUndefined(a.reset)?!0:a.reset,k=a.defaultModel||{},n=function(d){return _.set(b,a.modelKey,d)};n(_.extend({},k));
b.createCtrl={};b.createCtrl.creating=!1;b.createCtrl.submit=function(c){d(c);var k=f(l(),_.get(b,a.modelKey),c);k.$promise.then(function(){b.createCtrl.cancel(c);e(k,c)},function(a){g(a,c)})};b.createCtrl.cancel=function(a){m&&n(_.extend({},k));a.$setPristine();b.createCtrl.creating=!1};return b}}]);h.factory("removeController",[function(){return function(b,a){var c=a.remove||a.get.remove,f=a.removeCallback||_.ignore,e=_.isFunction(a.params)?a.params:_.constant(a.params||{});b.removeCtrl={status:"success"};
b.removeCtrl.remove=function(g){b.removeCtrl.status="removing";c(e(),{},g).$promise.then(function(){b.removeCtrl.status="success";g&&_.overwrite(g,{});a.collectionKey&&_.overwriteWithout(b[a.collectionKey],_.isReferenceEqualTo(b[a.elementKey]));f(b[a.elementKey],g)},function(){b.removeCtrl.status="error"})};return b}}]);h.factory("editController",["$injector","events","flash","imageUploadController","navigation",function(b,a,c,f,e){return function(g,d){var l=d.get||_.ignore,m=d.update||l.update,k=
d.remove||l.remove,n=d.successCallback||_.ignore,s=d.errorCallback||_.ignore,p=d.editCallback||_.ignore,h=d.removeCallback||_.ignore,t=d.cancelCallback||_.ignore,v=d.submitCallback||_.ignore,y=_.isFunction(d.params)?d.params:_.constant(d.params||{}),q=d.jsonFieldKeys||[],B=!!d.imageUpload;g.editCtrl={};g.editCtrl.editing=!1;g.editCtrl.status="success";B&&f(g,{modelKey:d.modelKey,elementKey:d.elementKey});if(!_.isUndefined(_.get(g,d.collectionKey))||d.remove)g.editCtrl.remove=function(b){g.editCtrl.status=
"removing";k(y(),{},b).$promise.then(function(){g.editCtrl.status="success";b&&_.overwrite(b,{});var f=_.get(g,d.collectionKey);f&&_.overwriteWithout(f,_.isReferenceEqualTo(g[d.elementKey]));d.refreshActivities&&a.broadcast("dashboard.shared.ActivitiesCtrl.refresh");d.flashAfterRemove&&(f=_.isString(d.flashAfterRemove)?d.flashAfterRemove:"Deleted "+g[d.elementKey].unicode+".",c.success(f));d.navigateAfterRemove&&e.navigate(d.navigateAfterRemove);h(g[d.elementKey],b)},function(){g.editCtrl.status=
"error"})};var u=function(){var a={};_.forEach(g[d.elementKey],function(b,d){if(!_.isObject(b)||_.includes(q,d))a[d]=b});d.modelFields&&(a=_.pick(a,d.modelFields));g[d.modelKey]=a;b.get("popovers").close("supported-languages-popover")};g.editCtrl.edit=function(a,b){b||u();g.editCtrl.editing=!0;B&&g.imageUploadCtrl.image.edit();p(a)};g.editCtrl.cancel=function(a){g.editCtrl.editing=!1;u();t(a);a&&a.$setPristine();d.editing&&g.editCtrl.edit(a)};g.editCtrl.submit=function(b){var c=g[d.modelKey],e=v(b);
e&&(c=_.extend({},c,e));g.editCtrl.status="submitting";var f=m(y(),c,b);f.$promise.then(function(c){g.editCtrl.status="success";b.$setPristine();g.editCtrl.editing=!1;d.refreshActivities&&a.broadcast("dashboard.shared.ActivitiesCtrl.refresh");B&&g.imageUploadCtrl.image.submit();n(f,b,c);d.editing&&g.editCtrl.edit(b)},function(a){g.editCtrl.status="error";s(a,b);d.editing&&g.editCtrl.edit(b,d.skipResetAfterError)})};d.editing&&g.editCtrl.edit();return g}}]);h.factory("calendarController",["$filter",
"$injector","auth","cache","db","events","localization","navigation","require","urls",function(b,a,c,f,e,g,d,l,m,k){return function(b,m){var p=a.get("flows"),h=k.calendarUrls(m.url),t=_.isFunction(m.params)?m.params:_.constant(m.params||{}),v=_.isFunction(m.queryParams)?m.queryParams:_.constant(m.queryParams||{}),y=m.endpoint,q=m.beforeRequest||_.ignore,B=m.largeDaySelected||_.ignore,u=m.smallDaySelected||_.ignore,z=_.isFunction(m.isSundayBased)?m.isSundayBased:_.isBoolean(m.isSundayBased)?_.constant(m.isSundayBased):
_.constant(m.company?m.company.features.isSundayBased:!0);b.calendarCtrl={status:"uninitialized",company:m.company||null,isSundayBased:z,calendar:{},isRetrieving:!1,isEmptyAllowed:m.isEmptyAllowed||!1,date:moment().startOf("day"),isCalendarEmpty:m.isCalendarEmpty||_.ignore,isWeekEmpty:m.isWeekEmpty||_.ignore,isDayEmpty:m.isDayEmpty||_.ignore,isDayUsed:m.isDayUsed||_.ignore,isEditable:m.isEditable||!1,editDay:m.editDay||_.ignore};var C=moment().startOf("day");b.calendarCtrl.dropdownMonths=_.map([T("January"),
T("February"),cT("the month of March","March"),T("April"),cT("the month of May","May"),T("June"),T("July"),T("August"),T("September"),T("October"),T("November"),T("December")],function(a,b){return{value:b,text:a}});b.calendarCtrl.dropdownYears=_.map(_.range(C.year()-2,C.year()+5),function(a){return{value:a,text:a}});var F=!1,x,w,G=b.calendarCtrl.refresh=function(a){F=!1;if(!1!==q()){var d=_.extend({year:b.calendarCtrl.date.format("YYYY"),month:b.calendarCtrl.date.format("MM")},t()),c=v();if(a||!angular.equals([d,
c],[x,w]))x=d,w=c,b.calendarCtrl.status="loading",K={},b.calendarCtrl.calendar.$promise&&b.calendarCtrl.calendar.$promise.cancel(),b.calendarCtrl.calendar=y(_.extend({},d),{},null,c),f.fresh(b.calendarCtrl.calendar)?b.calendarCtrl.isRetrieving=!0:N(),b.calendarCtrl.calendar.$promise.then(function(a){a!==e.CANCELLED&&(N(),b.calendarCtrl.status="success",b.calendarCtrl.isRetrieving=!1)},function(){b.calendarCtrl.status="error";b.calendarCtrl.isRetrieving=!1})}},M=function(a,b){var d=C-a.at;return 0===
d?b.current||"":0<d?b.past||"":b.future||""};b.calendarCtrl.dayPastPresentFutureClass=function(a){return M(a,{past:"past-day",current:"current-day"})};b.calendarCtrl.isPastWeek=function(a){return M(_.last(a.days),{past:!0})};var K={},H=C.clone().startOf("month");b.calendarCtrl.showingPastWeek=function(a){return 0!==b.calendarCtrl.date.clone().startOf("month").diff(H)||K[a.number]};b.calendarCtrl.showPastWeek=function(a){K[a.number]=!0};l.watch(b,function(a){if(l.pathEquals(h.index))l.redirect(k.populate(h.month,
{year:b.calendarCtrl.date.format("YYYY"),month:b.calendarCtrl.date.format("MM")}));else{var d;(d=l.pathEquals(h.month))?(a=d.year,d=d.month-1,a=moment({year:a,month:d,day:1}),b.calendarCtrl.style="month",b.calendarCtrl.date=a,b.calendarCtrl.monthDropdown=a.month(),b.calendarCtrl.yearDropdown=a.year(),g.broadcast("lib.shared.CalendarCtrl.month",{date:b.calendarCtrl.date}),G()):console.warn("calendarController: invalid calendar url",a)}});var L=b.calendarCtrl.monthUrl=function(a){return k.populate(h.month,
{year:a.format("YYYY"),month:a.format("MM")})};b.calendarCtrl.nextMonthUrl=function(){var a=b.calendarCtrl.date.clone();a.add(1,"months");return L(a)};b.calendarCtrl.currentMonthUrl=function(){return L(C)};b.calendarCtrl.previousMonthUrl=function(){var a=b.calendarCtrl.date.clone();a.add(-1,"months");return L(a)};b.$watch("calendarCtrl.yearDropdown",function(a,d){if(!_.isUndefined(d)&&a!==d){var c=b.calendarCtrl.date.clone();c.year(a);c=L(c);l.pathEquals(c)||l.navigate(p.extendWithFlow(c))}});b.$watch("calendarCtrl.monthDropdown",
function(a,d){if(!_.isUndefined(d)&&a!==d){var c=b.calendarCtrl.date.clone();c.month(a);c=L(c);l.pathEquals(c)||l.navigate(p.extendWithFlow(c))}});b.calendarCtrl.isCurrentMonth=function(){return b.calendarCtrl.date.year()===C.year()&&b.calendarCtrl.date.month()===C.month()};g.on(b,"lib.shared.CalendarCtrl.refresh",function(){G(!0)});var E=function(a){var d=b.calendarCtrl.calendar.weeks;if(!d)return null;var c=null;_.some(d,function(b){return _.some(b.days,function(b){return b.at.isSame(a,"day")?(c=
b,!0):!1})});return c};b.calendarCtrl.goToToday=function(){l.navigate(b.calendarCtrl.currentMonthUrl());b.calendarCtrl.selectedDay=E(moment());K={}};b.calendarCtrl.selectLargeDay=function(a){b.calendarCtrl.selectedDay=a;B(a)};b.calendarCtrl.dayLabel=function(a,c){return c===b.calendarCtrl.calendar.weeks[0]&&a===c.days[0]?a.at.format(d.current().DATE_FORMATS.dayWithMonthAbbr):1===a.number?a.at.format(d.current().DATE_FORMATS.dayWithMonthAbbr):a.number};b.calendarCtrl.selectSmallDay=function(a){b.calendarCtrl.selectedDay=
a;u(a);F=!0};var N=function(){if(c.currentUser.isAuthenticated){var a;a=F?b.calendarCtrl.selectedDay.at:b.calendarCtrl.date.year()===C.year()&&b.calendarCtrl.date.month()===C.month()?C:b.calendarCtrl.date;b.calendarCtrl.selectedDay=E(a)}else b.calendarCtrl.selectedDay=null};b.calendarCtrl.debouncedRefresh=_.debounce(function(a){b.$safeApply(function(){b.calendarCtrl.refresh(a)})},1E3,{leading:!0});b.calendarCtrl.effectiveRange=function(a,b){var d=a.startAt,c=a.endAt;d<b.at&&(d=b.at);c>b.at+864E5&&
(c=b.at.clone().add(1,"day").startOf("day"));return{startAt:d,endAt:c}};return b}}]);h.factory("availabilityCalendarController",["$filter","auth","calendarController","events","navigation",function(b,a,c,f,e){return function(a,d){var l=_.isFunction(d.params)?d.params:_.constant(d.params||{}),m=d.beforeRequest||_.ignore,k=_.isUndefined(d.autoOpenItemGroups)?!0:d.autoOpenItemGroups,n=d.openLightframe?d.openLightframe:e.navigate,s=d.items||null;f.on(a,"dashboard.bookings.NavigationCtrl.calendarFilter.items",
function(b,d){var c=d.items||[],e=_.difference(c,a.calendarCtrl.items).length;a.calendarCtrl.items=c;e&&a.calendarCtrl.debouncedRefresh(!0)});f.on(a,"dashboard.bookings.NavigationCtrl.filterChoicesUpdated",function(b,d){d&&(a.calendarCtrl.items=d.filteredItems||[]);a.calendarCtrl.refresh()});_.extend(d,{isCalendarEmpty:function(){return!a.calendarCtrl.calendar.availabilityCount},isWeekEmpty:function(a){return!a.availabilityCount},isDayEmpty:function(b){var d=b.availabilities;b=b.itemGroups||[];return!d.length&&
!b.length?!0:a.isCalendarFiltered?_.all(d,a.isCalendarFiltered)&&_.all(b,a.isCalendarFiltered):!1},isDayUsed:function(b){var d=b.availabilities;b=b.itemGroups||[];a.isCalendarFiltered&&(d=_.reject(d,a.isCalendarFiltered),b=_.reject(b,a.isCalendarFiltered));d=_.sum(_.pluck(d,"customerCount"));b=_.sum(_.pluck(b,"customerCount"));return 0<d+b},smallDaySelected:function(a){var d=a.availabilities,c=a.itemGroups||[];k&&(!d.length&&1===c.length)&&(a=b("itemGroupUrl")(c[0],a.at),n(a))},beforeRequest:function(){return a.calendarCtrl.items&&
!a.calendarCtrl.items.length?!1:m()},params:function(){var b=_.extend({},l());if(a.calendarCtrl.items){var d=_.pluck(a.calendarCtrl.items,"pk").join(",");b.itemPks=d}return b}});c(a,d);_.extend(a.calendarCtrl,{items:s,nextBookableMonthUrl:function(){var b=a.calendarCtrl.calendar.nextBookableStartAt;if(b)return a.calendarCtrl.monthUrl(b)},alreadyRedirectedToNextBookableMonth:!1,redirectToNextBookableMonth:function(){a.calendarCtrl.alreadyRedirectedToNextBookableMonth||(a.calendarCtrl.alreadyRedirectedToNextBookableMonth=
!0,e.redirect(a.calendarCtrl.nextBookableMonthUrl()))}});return a}}]);h.factory("emailPreviewController",["convert","models","navigation","urls",function(b,a,c,f){var e={type:"type",emails:"emails",subject:"subject",note:"note",language:"language"};return function(g,d){var l=_.extend({},e,d.fields),m=_.isFunction(d.params)?d.params:_.constant(d.params||{}),k;d.data&&(k=_.isFunction(d.data)?d.data:function(){return d.data});g.emailPreviewCtrl={};g.emailPreviewCtrl.previewUrl=function(){var a={};_.forEach(l,
function(b,c){b&&(a[c]=g[d.modelKey][b]||"")});d.languageOverride&&(a.language=d.languageOverride);k&&_.extend(a,b.clientRequest(k()));var e=f.populate(d.url,m(a.type));return c.compose(e,a)};var n=_.isFunction(d.isPreviewable)?d.isPreviewable:_.constant(d.isPreviewable);g.emailPreviewCtrl.isPreviewable=function(){var b=g[d.modelKey][l.type],c=g[d.modelKey][l.emails],e=g[d.modelKey][l.subject];if(!b||!c||!e)return!1;c=n(b);return!_.isUndefined(c)?c:a.Notification.isPreviewable(b)};return g}}]);h.factory("affiliationController",
["$q","auth","cache","db","editController","events","models",function(b,a,c,f,e,g,d){return function(l,m){var k=function(a){return(m.prefix?m.prefix+"-":"")+"voucher-"+a};l.affiliationCtrl={status:"success",substatus:"success",showDesks:!1};l.affiliationCtrl.agentName=function(a){return a===d.Agent.OTHER_AGENT?a.name:a.name+" (#"+a.pk+")"};l[m.modelKey][k("agent")]="";l[m.modelKey][k("agentName")]="";l[m.modelKey][k("desk")]="";l[m.modelKey][k("deskName")]="";var n=function(e){l.affiliationCtrl.agents=
[];l.affiliationCtrl.desks=[];l.affiliationCtrl.showDesks=!1;if(e){var g={agents:a.permissions.canCreate(d.Agent,e),desks:a.permissions.canCreate(d.Desk,e)},k={agents:d.Agent.OTHER_AGENT,desks:d.Desk.OTHER_DESK},m=function(a,b){_.overwrite(l.affiliationCtrl[a],b);g[a]&&l.affiliationCtrl[a].push(k[a])},n=[];if(a.permissions.canList(d.Agent,e.affiliateCompany)){var s=f.agents({shortname:e.affiliateCompany.shortname}),h=s.$promise.then(function(){m("agents",s)});c.fresh(s)?n.push(h):m("agents",s)}if(a.permissions.canList(d.Desk,
e.affiliateCompany)){var u=f.desks({shortname:e.affiliateCompany.shortname});e=u.$promise.then(function(){l.affiliationCtrl.showDesks=0<u.length;m("desks",u)});c.fresh(u)?n.push(e):(l.affiliationCtrl.showDesks=0<u.length,m("desks",u))}n.length&&(l.affiliationCtrl.substatus="loading",b.all(n).then(function(){l.affiliationCtrl.substatus="success"}))}};l.$watch(m.affiliateModelKey+".currentAffiliation",function(a,b){n(a);if(a&&b&&a!==b||!a)l[m.modelKey][k("agent")]="",l[m.modelKey][k("agentName")]="",
l[m.modelKey][k("desk")]="",l[m.modelKey][k("deskName")]=""});var s=function(b){var e=m.booking?m.booking.company:m.company;a.permissions.canList(d.Affiliation,e)?e.affiliatesCount>d.Affiliation.MAX_SELECTABLE_AFFILIATES?(l.affiliationCtrl.affiliatesNgDropdownEndpoint=f.searchEndpoint(f.affiliates.pickable,{shortname:e.shortname}),l.affiliationCtrl.status="success"):(l.affiliationCtrl.affiliations=f.affiliates.pickable({shortname:e.shortname},null,null,null,{flashError:!!m.booking}),l.affiliationCtrl.status=
c.fresh(l.affiliationCtrl.affiliations)?"loading":"stale",l.affiliationCtrl.affiliations.$promise.then(function(){l.affiliationCtrl.status="success";m.booking&&m.booking.affiliation&&!_.contains(l.affiliationCtrl.affiliations,m.booking.affiliation)&&l.affiliationCtrl.affiliations.unshift(m.booking.affiliation)},function(){m.booking&&l.editCtrl.cancel(b)})):l.affiliationCtrl.status="success"};m.booking?e(l,{elementKey:"affiliation",modelKey:m.modelKey,update:f.booking.affiliation.update,editCallback:function(a){s(a);
l[m.modelKey].isBlockable=m.booking.isBlockable;l[m.modelKey].affiliation=m.booking.affiliation?m.booking.affiliation.pk:"";l[m.modelKey][k("agent")]=m.booking.agent?m.booking.agent.pk:"";l[m.modelKey][k("desk")]=m.booking.desk?m.booking.desk.pk:"";l[m.modelKey][k("voucherNumber")]=m.booking.voucherNumber;l[m.affiliateModelKey].currentAffiliation=m.booking.affiliation||null},successCallback:function(a){var b=-1==l[m.modelKey][k("agent")],d=-1==l[m.modelKey][k("desk")];(b||d)&&n(a.booking.affiliation);
g.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},params:function(){return{shortname:m.booking.company.shortname,bookingUuid:m.booking.uuid}}}):s()}}]);h.factory("controllers",["affiliationController","calendarController","cannedMessagesController","createController","dataController","editController","emailPreviewController","emailSubjectsController","headerController","imageUploadController","listController","navigationController","removeController","reorderController","splitPaymentController",
function(b,a,c,f,e,g,d,l,m,k,n,s,h,r,t){return{affiliationController:b,calendarController:a,cannedMessagesController:c,createController:f,dataController:e,editController:g,emailPreviewController:d,emailSubjectsController:l,headerController:m,imageUploadController:k,listController:n,navigationController:s,removeController:h,reorderController:r,splitPaymentController:t}}])})();
(function(){var h=angular.module("lib.processors",["auth.services","db.services","lib.services","navigation.services"]),b={UNSUPPORTED:T("Unsupported processor. Please refresh the page and try again. If you continue to have trouble please contact support@fareharbor.com."),SCRIPT:T("Could not contact processor. Please refresh the page and try again."),TIMEOUT:T("Connection error. Please check your internet connection and try again."),WAIT:T("Please wait a few moments and try again."),TRY_AGAIN:T("Please try again."),
REFRESH:T("Please refresh the page and try again."),GENERIC_BANK_ACCOUNT:T("Could not update bank account. Please make sure all details have been entered correctly and try again."),REFRESH_BANK_ACCOUNT:T("Could not update bank account. Please refresh the page and try again."),TRY_AGAIN_BANK_ACCOUNT:T("Could not update bank account. Please try again."),GENERIC_CARD:T("Could not process payment. Please refresh the page and try again ensuring all card details have been entered correctly. If you continue to have trouble please contact support@fareharbor.com."),
REFRESH_CARD:T("Could not process payment. Please refresh the page and try again."),BAD_CARD:T("Could not process payment. Please make sure all card details have been entered correctly. If you are still unsuccessful you may need to call the card issuer or try a different card."),INVALID_ROUTING_NUMBER:T("Invalid routing number."),INVALID_CARD_NUMBER:T("Invalid card number. Please check that you have entered your card number correctly and try again."),BAD_CARD_NUMBER:T("Incorrect card number. Please check that you have entered your card number correctly and try again."),
INVALID_DEMO_CARD_NUMBER:T("Only demo card numbers can be used while demo mode is enabled."),INVALID_EXPIRATION:T("Invalid card expiration date. Please check that you've selected the correct expiration date for your card and try again."),BAD_EXPIRATION:T("Expired card. Please enter a valid card."),INVALID_SECURITY_CODE:T("Invalid CVC (card security code). Please check that you've entered your card's security code correctly and try again."),BAD_SECURITY_CODE:T("Incorrect CVC (card security code). Please check that you've entered your card's security code correctly and try again."),
INVALID_COUNTRY_CODE:T("Invalid country. Plesae check that your billing country is correct and try again."),INVALID_POSTAL_CODE:T("Invalid postal (zip) code. Please check that your billing postal code is correct and try again."),BAD_POSTAL_CODE:T("Incorrect postal (zip) code. Please check that your billing postal code is correct and try again.")};h.factory("processors",["$injector","auth","convert","db","Raven",function(a,c,f,e,g){var d={INDIVIDUAL_ENTITY_TYPE:"individual",COMPANY_ENTITY_TYPE:"company",
DEFAULT_PROCESSOR_TYPE:"stripe",STRIPE_PROCESSOR_TYPE:"stripe",BALANCED_PROCESSOR_TYPE:"balanced",PROCESSOR_TYPES:["stripe","balanced"],VERIFICATION_REQUIREMENTS:e.slipstream("processorVerificationRequirements"),VERIFICATION_REQUIREMENT_TO_FORM_FIELD:e.slipstream("processorVerificationRequirementToCompanyTaxInformationFormField",{doNotConvert:!0}),SUPPORTED_BANK_ACCOUNT_COUNTRIES:e.slipstream("processorSupportedBankAccountCountries"),BANK_ACCOUNT_VERIFICATION_ENABLED_COUNTRIES:e.slipstream("processorBankAccountVerificationEnabledCountries"),
SUPPORTED_CURRENCIES:e.slipstream("processorSupportedCurrencies"),UNVERIFIED_VERIFICATION_STATUS:"unverified",SUBMITTED_VERIFICATION_STATUS:"submitted",PENDING_VERIFICATION_STATUS:"pending",VERIFIED_VERIFICATION_STATUS:"verified",ERRORS:b,SECRET_FIELD:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",secretField:function(a){return Array(Math.max((a||"").length,d.SECRET_FIELD.length)+1).join(d.SECRET_FIELD[0])},cardType:function(a){if(!a)return"";a=a.toString().trim();var b={};b["2"]=b["51"]=b["52"]=
b["53"]=b["54"]=b["55"]="mastercard";b["34"]=b["37"]="american express";b["4"]="visa";b["6"]="discover";b["35"]="jcb";b["30"]=b["36"]=b["38"]="diners club";var d=_.find(_.keys(b),function(b){return 0===a.indexOf(b)});return d?b[d]:"unknown"},cardTypeAbbreviation:function(a){return{visa:"visa",mastercard:"mc","american express":"amex",discover:"discover","diners club":"diners",jcb:"jcb",unknown:"unknown"}[a]||""},cardLast4:function(a){return a.substr(a.length-4)},verificationRequirements:function(a,
b,c){if(d.VERIFICATION_REQUIREMENTS){var e=[a,b,c,"minimum"].join(".");if(e=_.get(d.VERIFICATION_REQUIREMENTS,e))return e}a="processors: verification requirements not identified for "+a+" "+b+" "+c;console.error(a);g.captureMessage(a,{level:d.ERROR})},requiredVerificationFields:function(a,b){try{if(!b)throw Error("missing verification requirements");if(!d.VERIFICATION_REQUIREMENT_TO_FORM_FIELD)throw Error("missing verification mapping");var c=d.VERIFICATION_REQUIREMENT_TO_FORM_FIELD[a];if(!c)throw Error("missing verification mapping for processor type");
var e={};_.each(b,function(a){(a=c[a])&&(e[f.camelKey(a)]=!0)});if(_.isEmpty(e))throw Error("no required fields");return e}catch(s){var h="processors: verification fields not identified for "+a+": "+s.message;console.warn(h);g.captureMessage(h,{extra:{verificationRequirements:b},level:d.ERROR})}},supportedBankAccountCountries:function(a,b,c){if(d.SUPPORTED_BANK_ACCOUNT_COUNTRIES){var e=[a,b,c].join(".");if(e=_.get(d.SUPPORTED_BANK_ACCOUNT_COUNTRIES,e))return e}a="processors: supported bank account countries not identified for "+
a+" "+b+" "+c;console.error(a);g.captureMessage(a,{level:d.ERROR})},verificationEnabledBankAccountCountries:function(a,b){if(d.BANK_ACCOUNT_VERIFICATION_ENABLED_COUNTRIES){var c=[a,b].join(".");if(c=_.get(d.BANK_ACCOUNT_VERIFICATION_ENABLED_COUNTRIES,c))return c}c="processors: unable to identify verification enabled bank account countries for "+a+" "+b;console.error(c);g.captureMessage(c,{level:d.ERROR})},isVerificationEnabledForBankAccountCountry:function(a,b,c){var e=d.verificationEnabledBankAccountCountries(a,
b);if(e)return _.contains(e,c);a="processors: unable to identify whether bank account verification is enabled for "+a+" "+b+" "+c;console.error(a);g.captureMessage(a,{level:d.ERROR})},isBankAccountVerificationEnabled:function(a,b,c){var e=d.verificationEnabledBankAccountCountries(a,b);if(e){if(!e.length)return!1;var f=d.supportedBankAccountCountries(a,b,c);if(f)return!!_.intersection(f,e).length}a="processors: unable to identify whether bank account verification is enabled for "+a+" "+b+" "+c;console.error(a);
g.captureMessage(a,{level:d.ERROR})},supportedCurrencies:function(a,b){if(d.SUPPORTED_CURRENCIES){var c=[a,b].join(".");if(c=_.get(d.SUPPORTED_CURRENCIES,c))return c}c="processors: unable to determine supported currencies for "+a+" "+b;console.error(c);g.captureMessage(c,{level:d.ERROR})},INFO:"info",ERROR:"error",log:function(a,b,e,n){b=b||{};e=e||{};n=n||d.INFO;var s={userIdentifier:c.currentUser.isAuthenticated?c.currentUser.identifier:"anonymous"},s=_.extend(s,e);try{b=f.clientRequest(b),g.captureMessage(a,
{extra:b,tags:s,level:n})}catch(h){console.error("processors: invalid log data",b),g.captureMessage(a,{extra:{message:"invalid log data: "+h.toString()},tags:s,level:n})}console.info("processors: "+a)},get:function(b){return a.get(b||"stripe")}};return d}]);h.factory("stripe",["$q","$rootScope","db","processors","Stripe",function(a,b,f,e,g){var d={invalid_number:e.ERRORS.INVALID_CARD_NUMBER,incorrect_number:e.ERRORS.BAD_CARD_NUMBER,invalid_expiry_month:e.ERRORS.INVALID_EXPIRATION,invalid_expiry_year:e.ERRORS.INVALID_EXPIRATION,
expired_card:e.ERRORS.BAD_EXPIRATION,invalid_cvc:e.ERRORS.INVALID_SECURITY_CODE,incorrect_cvc:e.ERRORS.BAD_SECURITY_CODE,incorrect_zip:e.ERRORS.BAD_POSTAL_CODE,card_declined:e.ERRORS.BAD_CARD,processing_error:e.ERRORS.TRY_AGAIN,rate_limit:e.ERRORS.WAIT},l=[{regex:/^Expired API Key provided/i,message:e.ERRORS.REFRESH}],m=f.slipstream("stripeLivePublishableKey"),k=f.slipstream("stripeTestPublishableKey"),n=function(f,k,l){var n=a.defer();g.setPublishableKey(m);f={currency:f.processorCurrency,country:k.processorCountry,
account_number:k.accountNumber,account_holder_name:k.accountHolderName,account_holder_type:k.accountHolderType};k.routingNumber&&(f.routing_number=k.routingNumber);g.bankAccount.createToken(f,function(a,f){b.$safeApply(function(){if(f.error){e.log("Stripe client-side error ("+(f.status||"unknown error")+")",_.extend({stripeResponse:f},l));var a=f.error.message+".";f.error.code&&(a=d[f.error.code]||a);return n.reject([a])}return n.resolve({processorType:"stripe",stripeBankAccountToken:f.id})})});return n.promise},
s=function(f,n,s,h){var p=a.defer();if(!g)return e.log("Stripe: unable to load stripe.js"),p.reject([e.ERRORS.SCRIPT]),p.promise;g.setPublishableKey(s?k:m);f={number:n.number,exp_month:n.expirationMonth,exp_year:n.expirationYear};n.cvc&&(f.cvc=n.cvc);f.name=n.name||"";f.address_zip=n.postalCode||"";f.address_country=n.countryCode||"";g.card.createToken(f,function(a,f){b.$safeApply(function(){if(!f)return p.reject([e.ERRORS.TIMEOUT]);if(f.error){var a;f.error.code?a=d[f.error.code]:f.error.message&&
_.forEach(l,function(b){if(f.error.message.match(b.regex))return a=b.message,!1});a||(a=e.ERRORS.GENERIC_CARD);var b="card_error"===f.error.type?e.INFO:e.ERROR,c="Stripe client-side "+(f.status||"")+" error",c=c+(" ("+(f.error.type||"unknown error")+")");f.error.message&&(c+=" - "+f.error.message);e.log(c,_.extend({stripeResponse:f,error:a},h),{type:f.error.type},b);return p.reject([a])}return p.resolve({processorType:"stripe",stripeToken:f.id})})});return p.promise},h=function(a,b,d){b=g(b?k:m);
return(d?b.handleCardSetup:b.handleCardAction)(a)};return{PROCESSOR_TYPE:"stripe",PENDING_STATEMENT_TEXT:"STRIPE",STATEMENT_TEXT_PREFIX:"",tokenizeBankAccount:function(b,d,c){if(!g){var f=a.defer();e.log("Stripe: unable to load stripe.js");f.reject([e.ERRORS.SCRIPT]);return f.promise}f=n(b,d,c);b=n(b,d,c);return a.all([f,b]).then(function(a){return{processorType:"stripe",stripeAccountBankAccountToken:a[0].stripeBankAccountToken,stripeCustomerBankAccountToken:a[1].stripeBankAccountToken}},function(b){return a.reject(_.unique(_.append(b)))})},
tokenizeCard:s,tokenizedCard:function(a){return{processorType:"stripe",stripeToken:a}},testToken:function(a,b){var d={number:"4242424242424242",expirationMonth:1,expirationYear:moment().year()+1,cvc:"123"};b=_.extend(b,{testing:!0});return s(a,d,a.isDemoModeEnabled,b).then(function(a){a=a.stripeToken;console.info("stripe: test token",a);return a})},chargedCard:function(a){var b={processorType:"stripe",stripePaymentIntentId:a.processorId};_.extend(b,a);return b},completeClientAction:function(b,d,c,
e,f){var g=a.defer();h(d,e,c).then(function(a){if(a.error)g.reject(T("Authorization failed"));else{var b={processorType:"stripe",stripeToken:null};c?b.stripeSetupIntentId=a.setupIntent.id:b.stripePaymentIntentId=a.paymentIntent.id;g.resolve(b)}},function(){g.reject(T("Authorization failed"))});return g.promise}}}]);h.factory("balanced",["$rootScope","$timeout","$q","processors",function(a,b,f,e){a=function(){var a=f.defer();a.reject([e.ERRORS.UNSUPPORTED]);return a.promise};return{PROCESSOR_TYPE:"balanced",
PENDING_STATEMENT_TEXT:"BALANCED",STATEMENT_TEXT_PREFIX:"BAL*",tokenizeBankAccount:a,tokenizeCard:a}}]);h.factory("cardflight",function(){return{isTestToken:function(a){return/^test_/.test(a)}}});h.factory("Stripe",function(){return window.Stripe||null});h.factory("stripeEmv",["$q","$rootScope","$window","auth","db","flash","models",function(a,b,f,e,g,d,l){if(!f.StripeTerminal)return null;var m={};m[f.StripeTerminal.PaymentStatus.READY]=T("Waiting...");m[f.StripeTerminal.PaymentStatus.COLLECTING_PAYMENT_METHOD]=
T("Waiting for card...");m[f.StripeTerminal.PaymentStatus.CONFIRMING_PAYMENT_INTENT]=T("Charging card...");m.DISCONNECTED=T("Not connected.");m.UNKNOWN=T("Not connected.");var k=function(a){return function(){return new f.Promise(function(b,d){g.emvDevice.authenticate({shortname:a.shortname},null,null,{}).$promise.then(function(a){b(a.data.connectionToken)},function(a){console.error("stripeEmv: failed to retrieve connection token",a);d(Error("failed to retrieve activation token from Stripe."))})})}},
n=function(){b.$safeApply()},s=function(){b.$safeApply(function(){d.error(T("Reader has been disconnected unexpectedly."))})},h=function(){b.$safeApply()},r,t={STORAGE_KEY:"stripeEmvDevicePk",providerType:"stripe",selectDevice:function(b){if(!b||!b.reader)return a.reject();r||t.connect(b.emvDevice.company);return r.connectReader(b.reader,{fail_if_in_use:!0}).then(function(d){if(d.error)return d.error.code!==l.EmvDevice.CONNECT_READER_ERROR_CODE&&console.error("stripeEmv: failed to connect",d),a.reject(d.error);
b.status=l.EmvDevice.ONLINE_STATUS;return a.when(b)})},discoverEmvDevices:function(b,d){r||t.connect(b);return r.discoverReaders().then(function(b){if(b.error)return console.warn("stripeEmv: failed to discover",b.error),a.reject(b.error);console.log("stripeEmv: successfully discovered readers",b.discoveredReaders);var c=_.map(d,function(a){var d=_.find(b.discoveredReaders,{id:a.identifier});return{emvDevice:a,status:d&&d.status===l.EmvDevice.ONLINE_STATUS?l.EmvDevice.ONLINE_STATUS:l.EmvDevice.OFFLINE_STATUS,
reader:d}});return a.when(c)},function(b){console.warn("stripeEmv: failed reader discovery",b);return a.reject()})},connect:function(a){e.permissions.canList(l.EmvDevice,a)&&(r=f.StripeTerminal.create({onFetchConnectionToken:k(a),onCheckoutStatusChanged:n,onUnexpectedReaderDisconnect:s,onConnectionStatusChange:h}))},disconnect:function(){r&&(r.disconnectReader(),r=null)},isConnected:function(){return r&&"connected"===r.getConnectionStatus()},charge:function(d,e,f,k,m){return r.setReaderDisplay({type:"cart",
cart:{line_items:[{description:e.unicode,amount:f,quantity:1}],tax:0,total:f,currency:d.processorCurrency}}).then(function(){b.$apply();return g.emvDevice.createInteractionToken({shortname:d.shortname},{description:e.unicode,bookingGrosses:k}).$promise}).then(function(a){b.$apply();return r.collectPaymentMethod(a.primaryData)}).then(function(d){b.$apply();return d.error?a.reject(d.error):null===d.paymentIntent?a.reject({code:"payment_intent_is_null"}):r.processPayment(d.paymentIntent).then(function(d){b.$apply();
return d.error?a.reject(d.error):a.when({processorId:d.paymentIntent.id})})}).catch(function(d){b.$apply();var e=l.EmvDevice.UNKNOWN_ERROR;d.code&&(e=l.EmvDevice.STRIPE_ERRORS[d.code]||e);d.data&&d.data.createEmvInteractionTokenForm&&(e=d.data.createEmvInteractionTokenForm.all[0]);console.error("stripeEmv: unhandled error",d,e);return a.reject(e)})},cancel:function(){r&&r.cancelCollectPaymentMethod()},information:function(){return r?m[r.getPaymentStatus()]||m.UNKNOWN:m.DISCONNECTED},lastDecline:function(){return null}};
return t}]);h.factory("loginProviders",[function(){return{NAMES_BY_TYPE:{google:"Google",marriott:"Marriott",auth0:"Auth0"}}}]);h.factory("emv",["$q","$rootScope","auth","db","events","models","stripeEmv","storage",function(a,b,f,e,g,d,l,m){var k=null,n=null,s=_.filter([l]),h=function(a){return _.find(s,function(b){if(b.providerType===a)return b})},r={STRIPE_PROVIDER:l,SUPPORTED_PROVIDERS:s,currentDevice:null,disconnect:function(){if(n)return n.disconnect()},isConnectedToDevice:function(a){return r.isConnected()&&
a===r.currentDevice},isConnected:function(){if(n)return n.isConnected()},storeDeviceSelection:function(a){n&&k&&m.set(!n||!k?"":n.STORAGE_KEY+":"+k.shortname,a.pk)},selectDevice:function(b){if(!n||!b)return a.reject();r.currentDevice!==b.emvDevice&&r.disconnect();return n.selectDevice(b).then(function(a){r.currentDevice=a.emvDevice;r.storeDeviceSelection(r.currentDevice)})},previouslySelectedDevicePk:function(){if(n&&k)return m.get(!n||!k?"":n.STORAGE_KEY+":"+k.shortname)},connect:function(a){a&&
a.features.isEmvEnabled&&(n=h(a.features.emvProvider))&&n.connect(a)},charge:function(b,d,c,e,f){return!n?a.reject():n.charge(b,d,c,e,f)},discoverEmvDevices:function(b){if(!f.permissions.canList(d.EmvDevice,b)||!b||!b.features.isEmvEnabled)return a.when([]);var c=e.emvDevices({shortname:b.shortname},null,null,null,{flashError:!1}),g=function(a){return _.map(a,function(a){return{emvDevice:a,status:d.EmvDevice.OFFLINE_STATUS}})};r.isConnected()||(r.disconnect(),r.connect(b));return c.$promise.then(function(){return!n?
a.when(g(c)):n.discoverEmvDevices(b,c).then(function(b){return a.when(b)}).catch(function(b){console.warn("emv: failed to discover emv devices",b);return a.when(g(c))})})},information:function(){return!n?"":n.information()},lastDecline:function(){return!n?null:r.isDebugging?r.debugDecline:n.isConnected()?n.lastDecline():null},cancel:function(){if(n)return n.cancel()}};g.on(b,"auth.logout",function(){n&&n.disconnect()});g.on(b,"navigation.company.updated",function(a,b){var d=b.company;if(!k||d)if(!d||
!(k===d&&n&&n.isConnected()))k=d,n&&n.disconnect(),d.features.isEmvEnabled&&(n=h(d.features.emvProvider))&&f.currentUser.isAuthenticated&&r.discoverEmvDevices(d).then(function(a){a=_.filter(a,function(a){return"online"===a.status});var b,d=r.previouslySelectedDevicePk();d&&(b=_.find(a,function(a){return a.emvDevice.pk===d})||_.first(a));r.selectDevice(b).catch(function(){console.warn("Unable to connect to device.")})}).catch(function(){console.warn("Unable to connect to device: EMV provider not loaded.")})});
r.isDebugging=!1;r.debugDecline={customerReceipt:[{key:"Date",value:"12/32/17"},{key:"Time",value:"12:32pm"},{key:"Amount",value:"USD$12.32"},{key:"Information",value:"Authorization declined."},{key:"Description",value:"Booking #1234"}],merchantReceipt:[{key:"Date",value:"12/32/17"},{key:"Time",value:"12:32pm"},{key:"Amount",value:"USD$12.32"},{key:"Information",value:"Authorization declined."},{key:"Description",value:"Booking #1234"}]};r.debugDetails=[{key:"Date",value:"12/32/17"},{key:"Time",value:"12:32pm"},
{key:"Amount",value:"USD$12.32"},{key:"Information",value:"Authorization declined."},{key:"Description",value:"Booking #1234"},{key:"Name",value:"Adeventure Extremer"},{key:"Address",value:"12:32pm"},{key:"Zip",value:"12321"},{key:"City",value:"Aina Haina"},{key:"Country",value:"USA"},{key:"Contact",value:"4155551212"},{key:"Transaction",value:"ch_1BLzcrL4FOCDmmKvrGbjEG2t"},{key:"Authorization",value:"123212321"},{key:"Scheme",value:"super sweet VISA"},{key:"Account",value:"**** **** **** 4242"},
{key:"AID",value:"A0000000031010"},{key:"Entry Mode",value:"Chip"},{key:"Verification",value:"Signature"}];return r}]);h.run(["$rootScope","emv","loginProviders","processors",function(a,b,f,e){a.emv=b;a.loginProviders=f;a.processors=e}])})();
(function(){var h=angular.module("lib.models",[]);h.factory("models",["$filter","$injector","convert","require",function(b,a,c,f){var e=b("orderBy"),g=b("pluralize"),d=b("name"),l=[["US",cT('"USA" acronym for United States of America',"USA")],["AF",T("Afghanistan")],["AL",T("Albania")],["DZ",T("Algeria")],["AS",T("American Samoa")],["AD",T("Andorra")],["AO",T("Angola")],["AI",T("Anguilla")],["AQ",T("Antarctica")],["AG",T("Antigua & Barbuda")],["AR",T("Argentina")],["AM",T("Armenia")],["AW",T("Aruba")],
["AU",T("Australia")],["AT",T("Austria")],["AZ",T("Azerbaijan")],["BS",T("Bahama")],["BH",T("Bahrain")],["BD",T("Bangladesh")],["BB",T("Barbados")],["BY",T("Belarus")],["BE",T("Belgium")],["BZ",T("Belize")],["BJ",T("Benin")],["BM",T("Bermuda")],["BT",T("Bhutan")],["BO",T("Bolivia")],["BA",T("Bosnia and Herzegovina")],["BW",T("Botswana")],["BV",T("Bouvet Island")],["BR",T("Brazil")],["IO",T("British Indian Ocean Territory")],["VG",T("British Virgin Islands")],["BN",T("Brunei Darussalam")],["BG",T("Bulgaria")],
["BF",T("Burkina Faso")],["BI",T("Burundi")],["KH",T("Cambodia")],["CM",T("Cameroon")],["CA",T("Canada")],["CV",T("Cape Verde")],["KY",T("Cayman Islands")],["CF",T("Central African Republic")],["TD",T("Chad")],["CL",T("Chile")],["CN",T("China")],["CX",T("Christmas Island")],["CC",T("Cocos (Keeling) Islands")],["CO",T("Colombia")],["KM",T("Comoros")],["CG",T("Congo")],["CK",T("Cook Iislands")],["CR",T("Costa Rica")],["HR",T("Croatia")],["CU",T("Cuba")],["CY",T("Cyprus")],["CZ",T("Czech Republic")],
["DK",T("Denmark")],["DJ",T("Djibouti")],["DM",T("Dominica")],["DO",T("Dominican Republic")],["TP",T("East Timor")],["EC",T("Ecuador")],["EG",T("Egypt")],["SV",T("El Salvador")],["GQ",T("Equatorial Guinea")],["ER",T("Eritrea")],["EE",T("Estonia")],["ET",T("Ethiopia")],["FK",T("Falkland Islands (Malvinas)")],["FO",T("Faroe Islands")],["FJ",T("Fiji")],["FI",T("Finland")],["FR",T("France")],["FX",T("France, Metropolitan")],["GF",T("French Guiana")],["PF",T("French Polynesia")],["TF",T("French Southern Territories")],
["GA",T("Gabon")],["GM",T("Gambia")],["GE",T("Georgia")],["DE",T("Germany")],["GH",T("Ghana")],["GI",T("Gibraltar")],["GR",T("Greece")],["GL",T("Greenland")],["GD",T("Grenada")],["GP",T("Guadeloupe")],["GU",T("Guam")],["GT",T("Guatemala")],["GN",T("Guinea")],["GW",T("Guinea-Bissau")],["GY",T("Guyana")],["HT",T("Haiti")],["HM",T("Heard & McDonald Islands")],["HN",T("Honduras")],["HK",T("Hong Kong")],["HU",T("Hungary")],["IS",T("Iceland")],["IN",T("India")],["ID",T("Indonesia")],["IQ",T("Iraq")],["IE",
T("Ireland")],["IR",T("Islamic Republic of Iran")],["IL",T("Israel")],["IT",T("Italy")],["CI",T("Ivory Coast")],["JM",T("Jamaica")],["JP",T("Japan")],["JO",T("Jordan")],["KZ",T("Kazakhstan")],["KE",T("Kenya")],["KI",T("Kiribati")],["KP",T("Korea, Democratic People's Republic of")],["KR",T("Korea, Republic of")],["KW",T("Kuwait")],["KG",T("Kyrgyzstan")],["LA",T("Lao People's Democratic Republic")],["LV",T("Latvia")],["LB",T("Lebanon")],["LS",T("Lesotho")],["LR",T("Liberia")],["LY",T("Libyan Arab Jamahiriya")],
["LI",T("Liechtenstein")],["LT",T("Lithuania")],["LU",T("Luxembourg")],["MO",T("Macau")],["MG",T("Madagascar")],["MW",T("Malawi")],["MY",T("Malaysia")],["MV",T("Maldives")],["ML",T("Mali")],["MT",T("Malta")],["MH",T("Marshall Islands")],["MQ",T("Martinique")],["MR",T("Mauritania")],["MU",T("Mauritius")],["YT",T("Mayotte")],["MX",T("Mexico")],["FM",T("Micronesia")],["MD",T("Moldova, Republic of")],["MC",T("Monaco")],["MN",T("Mongolia")],["MS",T("Monserrat")],["MA",T("Morocco")],["MZ",T("Mozambique")],
["MM",T("Myanmar")],["NA",T("Namibia")],["NR",T("Nauru")],["NP",T("Nepal")],["NL",T("Netherlands")],["AN",T("Netherlands Antilles")],["NC",T("New Caledonia")],["NZ",T("New Zealand")],["NI",T("Nicaragua")],["NE",T("Niger")],["NG",T("Nigeria")],["NU",T("Niue")],["NF",T("Norfolk Island")],["MP",T("Northern Mariana Islands")],["NO",T("Norway")],["OM",T("Oman")],["PK",T("Pakistan")],["PW",T("Palau")],["PA",T("Panama")],["PG",T("Papua New Guinea")],["PY",T("Paraguay")],["PE",T("Peru")],["PH",T("Philippines")],
["PN",T("Pitcairn")],["PL",T("Poland")],["PT",T("Portugal")],["PR",T("Puerto Rico")],["QA",T("Qatar")],["RE",T("Reunion")],["RO",T("Romania")],["RU",T("Russian Federation")],["RW",T("Rwanda")],["LC",T("Saint Lucia")],["WS",T("Samoa")],["SM",T("San Marino")],["ST",T("Sao Tome & Principe")],["SA",T("Saudi Arabia")],["SN",T("Senegal")],["RS",T("Serbia")],["SC",T("Seychelles")],["SL",T("Sierra Leone")],["SG",T("Singapore")],["SK",T("Slovakia")],["SI",T("Slovenia")],["SB",T("Solomon Islands")],["SO",T("Somalia")],
["ZA",T("South Africa")],["GS",T("South Georgia and the South Sandwich Islands")],["ES",T("Spain")],["LK",T("Sri Lanka")],["SH",T("St. Helena")],["KN",T("St. Kitts and Nevis")],["PM",T("St. Pierre & Miquelon")],["VC",T("St. Vincent & the Grenadines")],["SD",T("Sudan")],["SR",T("Suriname")],["SJ",T("Svalbard & Jan Mayen Islands")],["SZ",T("Swaziland")],["SE",T("Sweden")],["CH",T("Switzerland")],["SY",T("Syrian Arab Republic")],["TW",T("Taiwan")],["TJ",T("Tajikistan")],["TZ",T("Tanzania, United Republic of")],
["TH",T("Thailand")],["TG",T("Togo")],["TK",T("Tokelau")],["TO",T("Tonga")],["TT",T("Trinidad & Tobago")],["TN",T("Tunisia")],["TR",T("Turkey")],["TM",T("Turkmenistan")],["TC",T("Turks & Caicos Islands")],["TV",T("Tuvalu")],["UG",T("Uganda")],["UA",T("Ukraine")],["AE",T("United Arab Emirates")],["GB",T("United Kingdom (Great Britain)")],["UM",T("United States Minor Outlying Islands")],["VI",T("United States Virgin Islands")],["US",cT('"USA" acronym for United States of America',"USA")],["ZZ",T("Unknown or unspecified country")],
["UY",T("Uruguay")],["UZ",T("Uzbekistan")],["VU",T("Vanuatu")],["VA",T("Vatican City State (Holy See)")],["VE",T("Venezuela")],["VN",T("Viet Nam")],["WF",T("Wallis & Futuna Islands")],["EH",T("Western Sahara")],["YE",T("Yemen")],["YU",T("Yugoslavia")],["ZR",T("Zaire")],["ZM",T("Zambia")],["ZW",T("Zimbabwe")]],m=_.map(l,function(a){return a[0]}),k=function(b){var d=a.get("db").slipstream("currencyChoices");return _.isUndefined(d)?(console.warn("getCurrencyChoices: currency choices undefined"),[]):
!b?d:_.filter(d,function(a){return _.contains(b,a[0])})},n={NETWORK_FILTER:"#network",COMPANY_FILTER:"#company",ADMIN_FILTER:{},filterUrl:function(a){return a===n.COMPANY_FILTER?"":a===n.ADMIN_FILTER?"admin/":a===n.NETWORK_FILTER?"network/":"network/"+a.shortname+"/"}},s=function(a,b,d,c){return function(e){return e[a]===b?e[d]:c}},h={US_COUNTRY_CODE:"US",ADMIN_TYPE:"admin",CHARTER_TYPE:"charter",AFFILIATE_TYPE:"affiliate",CALL_CENTER_SHORTNAME:"fhcallcenter",NO_FEE_TYPE:"no-fee",PERCENTAGE_FEE_TYPE:"percentage-fee",
FLAT_FEE_TYPE:"flat-fee",TIERED_FEE_TYPE:"tiered-fee",WATERFALL_FEE_TYPE:"waterfall-fee",ROLLING_WINDOW_PERIOD_TYPE:"rolling-window-period",IMMEDIATE_PERIOD_TYPE:"immediate-period",REFUND_RESERVE_AMOUNT_FORMAT:"fixed",REFUND_RESERVE_PERCENT_FORMAT:"percent",US_PROCESSOR_COUNTRY:"US",ADMIN_SHORTNAME:"admin",isAdmin:function(a){return a&&a.shortname===h.ADMIN_SHORTNAME},MONTH_VIEW:"month",DAY_VIEW:"day",AGENDA_VIEW:"agenda",GRID_VIEW:"grid",TIMELINE_VIEW:"timeline",AVAILABILITY_TIMELINE:"availability",
RESOURCE_TIMELINE:"resource",MANIFEST_AVAILABILITIES_VIEW:"availabilities",MANIFEST_ITEMS_VIEW:"items",MANIFEST_BOOKINGS_VIEW:"bookings",MANIFEST_RUNS_VIEW:"runs",MANIFEST_RESOURCES_VIEW:"resources",TAKE_PAYMENT_PREFERENCE:"take",INFO_PAYMENT_PREFERENCE:"info",SKIP_PAYMENT_PREFERENCE:"skip",FH_BLUE:"#0a6ece",DEFAULT_TIERED_FEE_SCHEDULE:[{cutoff:0,rate:"0.06"}],DEFAULT_PRE_LOCATION_HEADING:T("Before we begin:"),DEFAULT_START_LOCATION_HEADING:T("Please meet us at:"),DEFAULT_PRIMARY_LOCATION_HEADING:T("We're headed to:"),
DEFAULT_END_LOCATION_HEADING:T("We will end at:"),forObject:function(a){if(a)return a.cls===h.cls?a:a.company},INVOICE_FEE_RATE:1.9,INVOICE_FLAT_FEE:30,COUNTRIES:l,COUNTRY_CODES:m,getCountryDefaults:function(b){var d=a.get("db").slipstream("countryDefaults");return _.isUndefined(d)?(console.warn("getCountryDefaults: country defaults data undefined"),[]):d[b]},getCurrencyChoices:k,getCurrencyCodes:function(){var b=a.get("db").slipstream("currencies");return _.isUndefined(b)?(console.warn("getCurrencyCodes: currency data undefined"),
[]):_.keys(b)},DEFAULT_LANGUAGE:"en-us",DEFAULT_INCLUDED_TAX_PERCENTAGE_BY_COUNTRY:{AU:10},DEFAULT_TAX_DISPLAY_NAME:T("Taxes"),DEFAULT_TAX_DISPLAY_NAMES:{AU:"GST"},IDEAL_COUNTRY_CODES:["NL"],IDEAL_CURRENCIES:["eur"],SCA_REQUIRED_PROCESSOR_COUNTRIES:"IE ES IT BE AT NO PT FI DE NL SE GB DK FR".split(" "),taxDisplayName:function(a){return a.features.taxDisplayName?a.features.taxDisplayName:h.DEFAULT_TAX_DISPLAY_NAMES[a.processorCountry]||h.DEFAULT_TAX_DISPLAY_NAME},COMPANY_LOCALE_DEFAULT_TIME_FORMAT_TYPE:"company_locale_default",
ANONYMOUS_USER_LOCALE_DEFAULT_TIME_FORMAT_TYPE:"user_locale_default",TWELVE_HOUR_TIME_FORMAT_TYPE:"12_hour",TWENTY_FOUR_HOUR_TIME_FORMAT_TYPE:"24_hour",FALLBACK_SERVER_EXACT_TWELVE_HOUR_TIME_FORMAT:"g:iA",FALLBACK_SERVER_EXACT_TWENTY_FOUR_HOUR_TIME_FORMAT:"H:i",FALLBACK_CLIENT_EXACT_TWELVE_HOUR_TIME_FORMAT:"h:mma",FALLBACK_CLIENT_EXACT_TWENTY_FOUR_HOUR_TIME_FORMAT:"HH:mm",FALLBACK_CLIENT_TOP_OF_HOUR_TWELVE_HOUR_TIME_FORMAT:"ha",FALLBACK_CLIENT_TOP_OF_HOUR_TWENTY_FOUR_HOUR_TIME_FORMAT:"HH:mm",FAST_PAYOUT_TIMEZONES:["US/Eastern",
"US/Central","US/Mountain","US/Arizona","US/Pacific"],isFastPayoutsAvailable:function(a){return!1}},r=_.map([h.MONTH_VIEW,h.DAY_VIEW,h.AGENDA_VIEW,h.GRID_VIEW,h.TIMELINE_VIEW],function(a){return[a,_.capitalize(a)]}),t=_.filter(r,function(a){return a[0]!==h.DAY_VIEW});h.dashboardBookingsViewChoices=function(a){return a?r:t};h.rollingWindowDays=s("payoutPeriodType",h.ROLLING_WINDOW_PERIOD_TYPE,"rollingWindowDays",0);h.flatFee=s("feeType",h.FLAT_FEE_TYPE,"flatFee",0);h.percentageFeeRate=s("feeType",
h.PERCENTAGE_FEE_TYPE,"percentageFeeRate",0);var v={downtimeAlert:"2018-12-23T03:00-08:00"},m={verboseName:T("resource requirement"),verboseNamePlural:T("resource requirements"),name:function(a){return a.isItemLevel?a.shortName+" ("+a.item.name+")":a.shortName}},y={BOOKING_TYPE:"booking",CUSTOMERS_TYPE:"customers",FOR_ALL_CUSTOMER_PROTOTYPES:T("Every customer"),forCustomerPrototypes:function(a){return a.type===y.BOOKING_TYPE?T("Whole booking"):!a.customerPrototypeRequirements.length&&!a.customerTypeRequirements.length?
y.FOR_ALL_CUSTOMER_PROTOTYPES:a.requirementGroup.isItemLevel?_.map(a.customerPrototypeRequirements,function(a){a=a.customerPrototype;return a.name||a.customerType.name}).join(", "):_.map(a.customerTypeRequirements,function(a){return a.customerType.name}).join(", ")}},s={verboseName:T("group"),RELATED_FEATURE_FLAG:"isSeatingEnabled"},q={verboseName:T("seat"),UNLIMITED:"unlimited",CAPACITY_CHOICES:[[0,0],[1,1],["unlimited",T("Unlimited")]],FORM_FIELDS:"name isNameVisible width height capacity seatZonePk seatGroupPk".split(" "),
RELATED_FEATURE_FLAG:"isSeatingEnabled",getOverlappingSeat:function(a,b){return _.find(b,function(b){return q.isOverlappingOtherSeat(a,b)?b:null})},isOverlappingOtherSeat:function(a,b){if(a===b)return!1;var d=a.yCoord+a.height-1;if(a.xCoord+a.width-1<b.xCoord||d<b.yCoord)return!1;d=b.yCoord+b.height-1;return b.xCoord+b.width-1<a.xCoord||d<a.yCoord?!1:!0},newPositions:function(a,b,d){var c=_.min(a,function(a){return a.xCoord+a.yCoord});return _.map(a,function(a){return{xCoord:b+(a.xCoord-c.xCoord),
yCoord:d+(a.yCoord-c.yCoord)}})},reposition:function(a,b,d,c){var e=q.defaultName(a.xCoord,a.yCoord),f=q.defaultName(b,d);a.name.match(e)?a.name=a.name.replace(e,f):c&&(a.name=a.name+"-"+f);a.xCoord=b;a.yCoord=d},defaultSeat:function(a,b,d,c){return{name:q.defaultName(a,b),isNameVisible:!1,width:1,height:1,capacity:1,seatZonePk:d,seatGroupPk:c,xCoord:a,yCoord:b}},defaultName:function(a,b){return a+1+"-"+(b+1)},commonSeatGroup:function(a,b){var d=_.unique(_.pluck(a,"seatGroupPk"));return 1!==d.length?
null:_.findWhere(b,{pk:d[0]})}},B={verboseName:T("zone"),RELATED_FEATURE_FLAG:"isSeatingEnabled"},u={MAX_COLOR:12,DEFAULT_RECEIPT_FOOTER:cT('"order" as in sales order',"Thanks for your order!"),isValidColor:function(a){return _.isNumber(a)&&0<=a&&a<=u.MAX_COLOR},checklistName:function(a){var b=a.name;a.isPrivate?b="<span class='badge badge-lock ghost'>"+T("Private")+"</span> "+b:a.isUnlisted&&(b="<span class='badge'>"+T("Unlisted")+"</span> "+b);a.shortName&&(b=b+" <span class='fh-grey'>("+a.shortName+
")</span>");return b},verboseName:T("item"),verboseNamePlural:T("items")},z={NO_FLOW:{pk:!1,name:T("None")},PAGE_TYPE:"page",LINK_TYPE:"link",ITEM_TYPE:"item",FLOW_QUERY:"flow",IS_SUGGESTED_QUERY:"suggested-flow",verboseName:T("flow page"),verboseNamePlural:T("flow pages"),WIDTH_ONE_THIRD:"1-3",WIDTH_HALF:"1-2",WIDTH_TWO_THIRDS:"2-3",WIDTH_FULL:"1-1",HEIGHT_1:1,HEIGHT_2:2,HEIGHT_3:3,singleItemRedirect:function(a){return a&&a!==z.NO_FLOW&&z.isAllItems(a)&&a.emptyPageChildren&&1===a.emptyPageChildren.length?
a.emptyPageChildren[0].item:null},effectiveChildren:function(a){var b=a.children;z.isAllItems(a)&&(b=a.emptyPageChildren);return b||[]},childItems:function(a){return _.compact(_.pluck(z.effectiveChildren(a),"item"))},childPages:function(a){return _.filter(a.children,{type:z.PAGE_TYPE})},isCalendarIncluded:function(a){if(!a.isCalendarIncluded)return!1;a=z.effectiveChildren(a);return _.any(a,function(a){return a.type===z.PAGE_TYPE||a.type===z.ITEM_TYPE&&!a.item.isRetail})},breadcrumbName:function(a){return a.shortName||
a.name},isAllItems:function(a){return 0===a.childrenCount},isSingleLevelFlow:function(a){f.assert(a.children&&a.breadcrumbs,"Flow node must be fully loaded");return 0<a.breadcrumbs.length||0<z.childPages(a).length?!1:!0},gridColumnCount:function(a){a=z.effectiveChildren(a).length;return 6<=a||3===a?3:4<=a||2===a?2:1},defaultBlockWidth:function(a){if(!z.isAllItems(a))return z.WIDTH_ONE_THIRD;a=z.gridColumnCount(a);return 3===a?z.WIDTH_ONE_THIRD:2===a?z.WIDTH_HALF:z.WIDTH_FULL},emptyGridBlockCount:function(a){if(!z.isAllItems(a))return 0;
var b=z.gridColumnCount(a);return(a=z.effectiveChildren(a).length%b)?b-a:0},heading:function(a){return a.properties.heading||(a.item?a.item.name:a.name)},subheading:function(a){return a.properties.subheading?a.properties.subheading:a.item?a.item.headline:""},imageUrl:function(a){return a.imageCdnUrl?a.imageCdnUrl:a.item?a.item.imageCdnUrl||(a.item.images.length?a.item.images[0].croppedCdnUrl:null):null},imageMaxWidth:function(a){return!a.properties.width?550:z.isTallBlock(a)?null:z.imageMinWidth(a)},
imageMaxHeight:function(a){return!a.properties.width?null:z.isTallBlock(a)?z.imageMinHeight(a):null},imageMinWidth:function(a){switch(a.properties.width){case z.WIDTH_ONE_THIRD:return 604;case z.WIDTH_HALF:return 920;case z.WIDTH_TWO_THIRDS:return 1236;case z.WIDTH_FULL:return 1868;default:return 0}},imageMinHeight:function(a){switch(a.properties.height){case z.HEIGHT_1:return 332;case z.HEIGHT_2:return 692;case z.HEIGHT_3:return 1052;default:return 0}},isTallBlock:function(a){return a.properties.height>
z.HEIGHT_1&&(a.properties.width===z.WIDTH_ONE_THIRD||a.properties.width===z.WIDTH_HALF)||a.properties.width===z.WIDTH_TWO_THIRDS&&a.properties.height===z.HEIGHT_3},WIDTH_LABELS:{}};z.WIDTH_LABELS[z.WIDTH_ONE_THIRD]="one-third";z.WIDTH_LABELS[z.WIDTH_HALF]="half";z.WIDTH_LABELS[z.WIDTH_TWO_THIRDS]="two-thirds";z.WIDTH_LABELS[z.WIDTH_FULL]="full";var C={find:function(a,b,d){var c;d||(c=_.find(a,function(a){return a.customerPrototype===b.customerPrototype}));c||(c=_.find(a,function(a){return a.customerPrototype.customerType===
b.customerPrototype.customerType}));return c}},F={ANY_CONDITIONS_TYPE:"any",ALL_CONDITIONS_TYPE:"all",isVisibleWhenBooking:function(a,b,d){return a.isHidden?!1:!a.customFieldInstanceConditions.length?!0:(a.conditionsType===F.ANY_CONDITIONS_TYPE?_.any:_.all)(a.customFieldInstanceConditions,function(a){return x.isMatch(a,b,d)})},find:function(a,b){return _.contains(a,b)?b:_.find(a,{customField:b.customField})}},x={SELECTED_TYPE:"selected",NOT_SELECTED_TYPE:"not-selected",EXACT_TYPE:"exact",NOT_EXACT_TYPE:"not-exact",
SELECTED_NOT_EXACT_TYPE:"selected-ne",RANGE_TYPE:"range",SELECTED_OPTIONS:[{name:T("is not empty"),value:"selected"},{name:T("is empty"),value:"not-selected"}],EXACT_OPTIONS:[{name:T("is not empty"),value:"selected"},{name:T("is empty"),value:"not-selected"},{name:T("is:"),value:"exact"},{name:T("is not:"),value:"selected-ne"},{name:T("is empty or not:"),value:"not-exact"}],RANGE_OPTIONS:[{name:T("is in range:"),value:"range"}],isValidParent:function(a){return _.contains([D.SHORT_TYPE,D.YES_NO_TYPE,
D.CODE_GENERATOR_TYPE,D.EXTENDED_OPTION_TYPE,D.MULTI_CAMPAIGN_TYPE,D.COUNT_TYPE],a.customField.type)},types:function(a){if(x.needsExactValue(a)){var b=x.EXACT_OPTIONS;a.customField.type===D.COUNT_TYPE&&(b=b.concat(x.RANGE_OPTIONS));return b}return x.SELECTED_OPTIONS},needsExactValue:function(a){return _.contains([D.SHORT_TYPE,D.EXTENDED_OPTION_TYPE,D.COUNT_TYPE],a.customField.type)},needsCustomField:function(a){return _.contains([x.EXACT_TYPE,x.NOT_EXACT_TYPE,x.SELECTED_NOT_EXACT_TYPE,x.RANGE_TYPE],
a.type)},isMatch:function(a,b,d){d=d||{};var c=d[a.uri];if(!_.isUndefined(c))return c;d[a.uri]=!1;var e=a.parentCustomFieldInstance;if(!e||e.isHidden||!F.isVisibleWhenBooking(e,b,d))return!1;c=a.type;b=b(e);c===x.SELECTED_TYPE?c=!!b:c===x.NOT_SELECTED_TYPE?c=!b:c===x.EXACT_TYPE?c=a.exactValue===b:c===x.NOT_EXACT_TYPE?c=!b||a.exactValue!==b:c===x.SELECTED_NOT_EXACT_TYPE?c=!!b&&a.exactValue!==b:c===x.RANGE_TYPE?(c=a.properties,c=c.rangeStart<=b&&b<=c.rangeEnd):c=!1;return d[a.uri]=c},rawValue:function(a){return a.type===
x.RANGE_TYPE?a.properties:a.exactValue}},w={CHECKED_IN_TYPE:"checked-in",NO_SHOW_TYPE:"no-show",MIXED_CHECKIN_STATUS:{pk:"mixed",name:T("Set check-in per customer..."),type:"mixed"},EMPTY_CHECKIN_STATUS:{pk:"",name:T("Not yet checked in")},RELATED_FEATURE_FLAG:"isCheckinEnabled",isCheckedIn:function(a){return a&&a.type===w.CHECKED_IN_TYPE},isNoShow:function(a){return a&&a.type===w.NO_SHOW_TYPE},isMixed:function(a){return a===w.MIXED_CHECKIN_STATUS},bookingCheckinStatus:function(a){if(a&&a.customers&&
a.customers.length){var b=a.customers[0]?a.customers[0].checkinStatus:null;return _.every(a.customers,{checkinStatus:b})?b:w.MIXED_CHECKIN_STATUS}},bookingCheckinStatusObject:function(a){return w.bookingCheckinStatus(a)||w.EMPTY_CHECKIN_STATUS},bookingCheckinBreakdown:function(a){var b={};_.forEach(a.customers,function(a){var d=a.customerTypeRate.customerPrototype.customerType,c=a.checkinStatus||null;a=d.uri+":"+(c?c.uri:"");d=b[a]||{count:0,customerType:d,checkinStatus:c};d.count+=1;b[a]=d});a=e(_.values(b),
function(a){return!a.checkinStatus?[1,2,0,a.customerType.sortableIndex]:[0,a.checkinStatus.type===ra.CheckinStatus.NOT_CHECKED_IN_TYPE?1:0,a.checkinStatus.sortableIndex,a.customerType.sortableIndex]});return _.map(a,function(a){var b=a.customerType.shortName||g(a.count,a.customerType.singular,a.customerType.plural),d=a.checkinStatus?a.checkinStatus.name:T("not checked in");return a.count.toString()+"\u00a0"+b+"\u00a0"+d}).join(", ")},checkinStatusClass:function(a){return a?a.type:"not-checked-in"},
checkinStatusSort:function(a){return[!!a,w.isCheckedIn(a),w.isMixed(a),w.isNoShow(a),a?a.sortableIndex:0]}},G=function(a){return function(b){return M.effectiveBookingRestriction(b,a)}},M={AUTO_STATUS:"auto",OPEN_STATUS:"open",CALL_STATUS:"call",CLOSED_STATUS:"closed",DISPLAY_STATUS_BY_STATUS:{auto:T("Auto close"),open:T("Open"),call:T("Closed & Call to book"),closed:T("Closed & hidden")},displayStatus:function(a){return M.DISPLAY_STATUS_BY_STATUS[a]},cutoffReachedStart:function(a){var b=M.cutoffReachedKind(a),
d=M.cutoffReachedHours(a);return Xa.cutoffStart(b,d,a.utcStartAt)},cutoffUnreachedStart:function(a){var b=M.cutoffUnreachedKind(a),d=M.cutoffUnreachedHours(a);return Xa.cutoffStart(b,d,a.utcStartAt)},effectiveBookingRestriction:function(a,b){return a.bookingRestriction?a.bookingRestriction[b]:a.item.bookingRestriction?a.item.bookingRestriction[b]:a.item[b]},soldOutText:G("soldOutText"),isBookableEverByPhone:G("isBookableEverByPhone"),cutoffReachedKind:G("cutoffReachedKind"),cutoffReachedHours:G("cutoffReachedHours"),
cutoffUnreachedKind:G("cutoffUnreachedKind"),cutoffUnreachedHours:G("cutoffUnreachedHours"),isInPast:function(a){var b=a.utcEndAt;a=a.customerCount?M.cutoffReachedStart(a):M.cutoffUnreachedStart(a);b=Math.max(b.unix(),a.unix());a=moment().unix();return b<a},minimumPartySize:function(a){return a.customerCount?M.effectiveBookingRestriction(a,"minimumSubsequentPartySize"):M.effectiveBookingRestriction(a,"minimumInitialPartySize")},maximumPartySize:function(a){return a.customerCount?M.effectiveBookingRestriction(a,
"maximumSubsequentPartySize"):M.effectiveBookingRestriction(a,"maximumInitialPartySize")},blockedCustomerCount:function(a){return _.sum(a.blocks,"customerCount")},reservedCapacity:function(a){return _.sum(a.blocks,"reservedCapacity")},AFFILIATE_SORT_ORDER:"affiliate",BOOKED_AT_SORT_ORDER:"bookedAt",BOOKED_BY_SORT_ORDER:"bookedBy",CONTACT_NAME_SORT_ORDER:"name",PAID_STATUS_SORT_ORDER:"status",PAX_COUNT_SORT_ORDER:"paxCount"},K={COMPLETED_TYPE:"completed",PENDING_TYPE:"pending",items:function(a){return H.uniqueItems(a.allBookings)},
isNoTax:function(a){return _.all(a.contributingBookings,"availability.item.isNoTax")},receiptFooter:function(a){a=_.uniq(_.map(K.items(a),"receiptFooter"));return 1===a.length&&a[0]?a[0]:u.DEFAULT_RECEIPT_FOOTER},showTaxByType:function(a){return a.company.features.isTaxTypeBreakdownEnabled&&!(Ka.LEGACY_TAX_TYPE_PK in a.contributingBookingCosts.totalCost.taxByType)}},G={COUNTRIES:l},H={CANCELLED_STATUS:"cancelled",UNCANCELLED_STATUS:"uncancelled",PAID_PAID_STATUS:"paid",UNPAID_PAID_STATUS:"unpaid",
OVERPAID_PAID_STATUS:"overpaid",UNDERPAID_PAID_STATUS:"underpaid",COMPLETED_TYPE:"completed",PENDING_TYPE:"pending",paymentsAndRefunds:function(a){var b=_.append.apply(null,_.map(a.payments,"refunds"));_.ref.append(b,a.payments);return _.sortBy(b,"createdAt")},adjustBookingFee:function(a,b,d,c){b+=d;return!b||!c?a:c<b?_.roundHalfToEven(a*((b-c)/b)):0},affiliateCompany:function(a){return a.affiliation?a.affiliation.affiliateCompany:void 0},newTransportation:function(a){if(a.customFieldValues)return _.find(a.customFieldValues,
function(a){return a.customFieldInstance.customField.type===D.NEW_TRANSPORTATION_TYPE});console.warn("models.Booking.newTransportation: booking has no custom field values")},waiverCustomFields:function(a){var b=[],d=function(a){return a.customFieldInstance.customField.type===D.WAIVER_TYPE},c=function(a){return a.customFieldInstance.customField},e=_.map(_.filter(a.customFieldValues,d),c),f=[];_.forEach(a.customers,function(a){f.push(_.map(_.filter(a.customFieldValues,d),c))});f=_.flatten(f);b=b.concat(f,
e);if(b.length)return _.uniq(b,"pk");console.warn("models.Booking.waivers: booking has no waiver custom fields")},generatedCustomFields:function(a){var b={};_.forEach(a.generatedCodes,function(a){var d=a.generatingCampaign,c=d.customField,e=b[c.uri]||{customField:c,generatedCampaigns:{}};b[c.uri]=e;c=e.generatedCampaigns[d.uri]||{generatingCampaign:d,generatedCodes:[]};e.generatedCampaigns[d.uri]=c;c.generatedCodes.push(a)});a=_.sortBy(_.values(b,function(a){return a.customField.name}));_.forEach(a,
function(a){a.generatedCampaigns=_.sortBy(_.values(a.generatedCampaigns,function(a){return a.generatingCampaign.campaign.name}))});return a},isEligibleForAutoFollowUpEmail:function(a){return a.item.isFollowUpEnabled&&a.contact.email},isEligibleForAutoReminderEmail:function(a){return a.item.isReminderEnabled&&a.contact.email},isEligibleForAutoReminderSms:function(a){return a.company.isSmsEnabled&&a.item.isSmsReminderEnabled&&a.isSmsEnabled&&ea.isEligiblePhoneNumber(a.contact.phone,a.contact.phoneCountry,
a.contact.company)},isEligibleForReviewExpress:function(a){return a.item.isReviewExpressEnabled&&a.contact.email},isEligibleForOnlineCancellation:function(a){var b="paid"===a.paidStatus,d=_.filter(a.payments,function(a){return!a.isRefunded&&!a.isProcessorBasedType});return!M.isInPast(a.availability)&&!a.isCancelled&&a.company.features.isCancellationPoliciesEnabled&&a.company.features.isOnlineCancellationEnabled&&!!a.effectiveCancellationRule&&a.effectiveCancellationRule.isCancellationAllowed&&b&&
!d.length},charterInvoiceRevenue:function(a){return!a.affiliation?null:a.invoicedToCharter+a.invoiceableToCharter},charterInvoiceOwed:function(a){return!a.affiliation?null:a.invoicedToAffiliate+a.invoiceableToAffiliate},isEligibleForCancellation:function(a,b){if(!a.company.features.isCancellationPoliciesEnabled||!a.effectiveCancellationRule||!a.effectiveCancellationRule.isCancellationAllowed)return!1;var d=b?b.company:null;return a.affiliation&&a.affiliation.affiliateCompany===d&&_.any(a.payments,
function(a){return!a.isDeferred&&!a.isCollectedByAffiliate})?!1:!0},isEligibleForRebook:function(a,b){return H.isEligibleForCancellation(a,b)},itemsInOrder:function(a){return a.isOrder?_.uniq(_.pluck(a.order.allBookings,"item")):[a.item]},hasEmailableDisputes:function(a){return _.some(a.payments,function(a){return ba.isOpenDisputeStatus(a)})},customerTypeRateCountKey:function(a){return"customerTypeRate"+a.pk+"-count"},customFieldInstanceKey:function(a,b,d){b=_.isObject(b)?b.cls===C.cls?b.pk.toString()+
"-"+d.toString():b.key:_.isString(b)?b:"Booking";return"customFieldInstance"+a.pk+"For"+b+"-value"},uniqueItems:function(a){return _.uniq(_.map(a,"item"))},effectivePrimaryLocation:function(a){var b=a.availability.item,d=b.startLocation,c=b.primaryLocation;!c&&!b.isCustomPrimaryLocation&&(c=a.company.defaultItemPrimaryLocation);c&&(d&&c.pk===d.pk)&&(c=null);return c},showTaxByType:function(a){return a.company.features.isTaxTypeBreakdownEnabled&&null===a.explicitGross&&!(Ka.LEGACY_TAX_TYPE_PK in a.costs.totalCost.taxByType)}},
L={OTHER_AGENT:{name:T("Add new agent"),pk:-1}},E={OTHER_DESK:{name:T("Add new desk"),pk:-1}},N={PERCENTAGE_COMMISSION_TYPE:"percentage",FLAT_COMMISSION_TYPE:"flat",AFFILIATE_TAKE_PAYMENT_PREFERENCE:"affiliate-take",CARD_ON_FILE_PAYMENT_PREFERENCE:"card-on-file",TAKE_PAYMENT_PREFERENCE:h.TAKE_PAYMENT_PREFERENCE,INFO_PAYMENT_PREFERENCE:h.INFO_PAYMENT_PREFERENCE,SKIP_PAYMENT_PREFERENCE:h.SKIP_PAYMENT_PREFERENCE,MAX_SELECTABLE_AFFILIATES:400,isOnlineBookingEnabled:function(a){return(a=a.affiliateGroup&&
a.affiliateGroup.groupPermissions)&&a.canCreateBookings},verboseName:T("affiliate"),verboseNamePlural:T("affiliates"),name:function(a){return!a?"":!a.affiliateCompany?a.unicode:a.affiliateCompany.name}},I={NEW_STATUS:"new",PENDING_STATUS:"pending",RUNNING_STATUS:"running",FAILED_STATUS:"failed",SUCCEEDED_STATUS:"succeeded",CANCELLED_STATUS:"cancelled",ALL_PARTNER_FILTER_OPTION:"all",DIRECT_PARTNER_FILTER_OPTION:"direct",ALL_AFFILIATE_FILTER_OPTION:"all",DIRECT_AFFILIATE_FILTER_OPTION:"direct",ALL_ITEM_FILTER_OPTION:"all",
ALL_USER_FILTER_OPTION:"all",ONLINE_USER_FILTER_OPTION:"online",ORIGINAL_USER_TYPE_FILTER_OPTION:"original",CURRENT_USER_TYPE_FILTER_OPTION:"current",ALL_CANCELLED_BOOKINGS_FILTER_OPTION:"all",NO_CANCELLED_BOOKINGS_FILTER_OPTION:"none",NON_REFUNDED_CANCELLED_BOOKINGS_FILTER_OPTION:"non-refunded",ONLY_CANCELLED_BOOKINGS_FILTER_OPTION:"only",AVAILABILITY_DATE_TYPE:"availability",BOOKING_DATE_TYPE:"booking",BOOKING_ORIGINAL_DATE_TYPE:"booking-original",DISPUTE_DATE_TYPE:"dispute",PAYMENT_DATE_TYPE:"payment",
PAYMENT_OR_REFUND_DATE_TYPE:"payment-or-refund",PAYMENT_OR_REFUND_ACCRUAL_DATE_TYPE:"payment-or-refund-accrual",LINE_ITEM_DATE_TYPE:"line-item",ALL_TRANSACTION_TAG_FILTER_OPTION:"all",ALL_SALESPERSON_FILTER_OPTION:"all",ALL_DISPUTE_STATUS_FILTER_OPTION:"all",ALL_CLOSED_DISPUTE_STATUS_FILTER_OPTION:"all-closed",ALL_OPEN_DISPUTE_STATUS_FILTER_OPTION:"all-open",ALL_CURRENCY_FILTER_OPTION:"all",UNCANCELLED_FILTER_OPTION:"uncancelled",REFUNDED_CANCELLED_FILTER_OPTION:"refunded",UNREFUNDED_CANCELLED_FILTER_OPTION:"unrefunded",
ADVANCED_TYPE:"advanced",emptyFilters:function(){return _.mapValues(ra.Report.MODELS,function(){return[]})},emptyColumns:function(){return _.mapValues(ra.Report.MODELS,function(){return{}})},emptyCompanyOptions:function(a){return _.keyBy(a,"pk",function(a){var b={};a.isCharter&&(b.filters=I.emptyFilters());a.isAffiliate&&(b.selectedAllPartners=void 0,b.allPartnerFilters=I.emptyFilters(),b.partners={},b.selectedPartners={});return b})},emptyReportOptions:function(a){return{modelName:"",presetDateRange:"",
startDate:"",endDate:"",dateType:"",filters:I.emptyFilters(),companies:I.emptyCompanyOptions(a),selectedCharters:{},selectedAffiliates:{},groups:[],isDetailed:"",columns:I.emptyColumns(),isOpened:!1,customFieldValueModel:""}},defaultGroups:function(){return[I.ITEM_GROUP]},defaultBookingCancelledStatusFilter:function(){return{type:I.CANCELLED_STATUS_FILTER_TYPE,data:{value:[I.UNCANCELLED_FILTER_OPTION,I.UNREFUNDED_CANCELLED_FILTER_OPTION]}}},defaultFilters:function(){return _.extend(I.emptyFilters(),
{Booking:[I.defaultBookingCancelledStatusFilter()]})},defaultBookingColumns:function(){return _.toTrueKeys([I.BOOKING_COUNT_COLUMN,I.BOOKING_ID_COLUMN,I.BOOKING_BOOKED_BY_COLUMN,I.CREATED_AT_COLUMN,I.AVAILABILITY_DATETIME_COLUMN,I.TOTAL_COST_PRICE_COLUMN,I.TOTAL_COST_TAX_COLUMN,I.TOTAL_COST_TOTAL_COLUMN,I.CONTACT_NAME_COLUMN,I.CUSTOMER_COUNT_COLUMN,I.AFFILIATE_COLUMN,I.VOUCHER_NUMBER_COLUMN,I.INVOICEABLE_TO_CHARTER_COLUMN,I.INVOICEABLE_TO_AFFILIATE_COLUMN,I.RECEIPT_PROCESSING_FEE_COLUMN,I.COLLECTED_TOTAL_COST_TOTAL_COLUMN,
I.RECEIPT_NET_COLUMN])},defaultCustomerColumns:function(){return _.toTrueKeys([I.CUSTOMER_COUNT_COLUMN,I.TOTAL_COST_PRICE_COLUMN,I.TOTAL_COST_TAX_COLUMN,I.TOTAL_COST_TOTAL_COLUMN,I.COLLECTED_TOTAL_COST_PRICE_COLOUMN,I.COLLECTED_TOTAL_COST_TAX_COLOUMN,I.COLLECTED_TOTAL_COST_TOTAL_COLUMN])},defaultCustomFieldValueColumns:function(){return _.toTrueKeys([I.USE_COUNT_COLUMN,I.TOTAL_COST_PRICE_COLUMN,I.TOTAL_COST_TAX_COLUMN,I.TOTAL_COST_TOTAL_COLUMN,I.COLLECTED_TOTAL_COST_PRICE_COLOUMN,I.COLLECTED_TOTAL_COST_TAX_COLOUMN,
I.COLLECTED_TOTAL_COST_TOTAL_COLUMN])},defaultLineItemColumns:function(){return _.toTrueKeys([I.CREATED_AT_COLUMN,I.TOTAL_COST_PRICE_COLUMN,I.TOTAL_COST_TAX_COLUMN,I.TOTAL_COST_TOTAL_COLUMN,I.LINE_ITEM_DESCRIPTION_COLUMN])},defaultPaymentColumns:function(){return _.toTrueKeys([I.CREATED_AT_COLUMN,I.PAYMENT_OR_REFUND_COLUMN,I.PAYMENT_OR_REFUND_ID_COLUMN,I.PAYMENT_TYPE_COLUMN,I.PAYMENT_AND_REFUND_GROSS_COLUMN,I.PAYMENT_AND_REFUND_PROCESSING_FEE_COLUMN,I.PAYMENT_AND_REFUND_NET_COLUMN,I.PAYMENT_COUNT_COLUMN,
I.REFUND_COUNT_COLUMN,I.PAYMENT_TOTAL_TAX_COLUMN,I.REFUND_TOTAL_PRICE_COLUMN])},defaultPaymentColumnsWithTax:function(){return _.extend(I.defaultPaymentColumns(),_.toTrueKeys([I.PAYMENT_AND_REFUND_TOTAL_TAX_COLUMN]))},defaultCustomerReportColumns:function(){return _.extend(I.emptyColumns(),{Customer:I.defaultCustomerColumns(),Booking:_.toTrueKeys([I.BOOKING_ID_COLUMN,I.BOOKING_COUNT_COLUMN,I.CUSTOMER_COUNT_COLUMN,I.TOTAL_COST_TOTAL_COLUMN])})},defaultColumns:function(){return _.extend(I.emptyColumns(),
{Booking:I.defaultBookingColumns(),Customer:I.defaultCustomerColumns(),CustomFieldValue:I.defaultCustomFieldValueColumns(),LineItem:I.defaultLineItemColumns()})},defaultReportOptions:function(a){var b=_.defaults({dateType:I.AVAILABILITY_DATE_TYPE,presetDateRange:I.YESTERDAY_DATE_RANGE,isDetailed:!1,groups:I.defaultGroups(),columns:I.defaultColumns(),filters:I.defaultFilters(),customFieldValueModel:Ya.cls},I.emptyReportOptions(a));a=a[0];b.selectedCharters[a.pk]=a.isCharter;b.selectedAffiliates[a.pk]=
!a.isCharter&&a.isAffiliate;return b}},D={STACK_PRICING_TYPE:"stack",CURRENT_PRICING_TYPE:"current",INITIAL_PRICING_TYPE:"initial",ZERO_PRICING_TYPE:"zero",SHORT_TYPE:"short",LONG_TYPE:"long",YES_NO_TYPE:"yes-no",EXTENDED_OPTION_TYPE:"extended-option",HEADER_TYPE:"header",NOTE_TYPE:"note",TRANSPORTATION_TYPE:"transportation",NEW_TRANSPORTATION_TYPE:"new-transportation",CODE_TYPE:"code",MULTI_CAMPAIGN_TYPE:"multi-campaign",CODE_GENERATOR_TYPE:"code-generator",CARD_GENERATOR_TYPE:"card-generator",COUNT_TYPE:"count",
WAIVER_TYPE:"waiver",DISPLAY_ONLY_TYPES:["note","header"],suggestedAmounts:function(a){if(a.type!==D.CARD_GENERATOR_TYPE)return[];a=a.cardSuggestedAmount||2500;return[a,2*a,4*a]},isDisplayOnly:function(a){return _.contains(D.DISPLAY_ONLY_TYPES,a.type)},isManifestField:function(a){return D.isDisplayOnly(a)?!1:!_.contains([D.NEW_TRANSPORTATION_TYPE,D.CODE_GENERATOR_TYPE,D.WAIVER_TYPE],a.type)},isAggregatable:function(a){return _.contains([ra.CustomField.EXTENDED_OPTION_TYPE,ra.CustomField.CODE_TYPE,
ra.CustomField.MULTI_CAMPAIGN_TYPE,ra.CustomField.YES_NO_TYPE,ra.CustomField.TRANSPORTATION_TYPE,ra.CustomField.COUNT_TYPE],a.type)},usesCheckbox:function(a){return _.contains([D.YES_NO_TYPE,D.CODE_GENERATOR_TYPE],a.type)},needsRequired:function(a){return D.isDisplayOnly(a)?!1:!_.contains([D.TRANSPORTATION_TYPE,D.COUNT_TYPE],a.type)},needsPricing:function(a){return _.contains([D.YES_NO_TYPE,D.CODE_TYPE,D.CODE_GENERATOR_TYPE,D.CARD_GENERATOR_TYPE,D.NEW_TRANSPORTATION_TYPE,D.COUNT_TYPE],a.type)},needsAlwaysPerCustomer:function(a){return D.needsPricing(a)||
_.contains([D.EXTENDED_OPTION_TYPE],a.type)},pricedByValue:function(a){return a.type===D.CARD_GENERATOR_TYPE},pricedByOptions:function(a){return _.contains([D.EXTENDED_OPTION_TYPE,D.MULTI_CAMPAIGN_TYPE],a.type)},needsBookingNotes:function(a){return _.contains([D.CODE_TYPE,D.CODE_GENERATOR_TYPE,D.CARD_GENERATOR_TYPE,D.MULTI_CAMPAIGN_TYPE,D.YES_NO_TYPE,D.TRANSPORTATION_TYPE,D.NEW_TRANSPORTATION_TYPE,D.EXTENDED_OPTION_TYPE,D.COUNT_TYPE],a.type)},needsHint:function(a){return _.contains([D.SHORT_TYPE,
D.LONG_TYPE,D.CODE_TYPE,D.NEW_TRANSPORTATION_TYPE,D.MULTI_CAMPAIGN_TYPE],a.type)},hasExtraOptions:function(a){return _.contains([D.EXTENDED_OPTION_TYPE,D.TRANSPORTATION_TYPE,D.MULTI_CAMPAIGN_TYPE],a.type)},isDefaultValueAllowed:function(a){return _.contains(D.DEFAULT_VALUE_TYPES,a.type)},isValidRawValue:function(a,b,d){return a.type===D.EXTENDED_OPTION_TYPE?""===b?!0:_.isNumber(b)&&_.find(a.extendedOptions,{pk:b}):a.type===D.COUNT_TYPE?d===x.RANGE_TYPE?!(b.rangeStart>a.countMax||b.rangeEnd<a.countMin):
_.isNumber(b)&&b>=a.countMin&&b<=a.countMax:!0},displayForRawValue:function(a,b,c){return a.type===D.EXTENDED_OPTION_TYPE?""===b?"":(a=_.find(a.extendedOptions,{pk:b}))?d(a):"Deleted option":a.type===D.YES_NO_TYPE?b?"Yes":"No":c===x.RANGE_TYPE?b.rangeStart+" \u2014 "+b.rangeEnd:_.isUndefined(b)||null===b?"":b.toString()},isOptionAvailable:function(a,b){if(""===b)return!0;var d=a.type;return d===D.EXTENDED_OPTION_TYPE?_.some(a.extendedOptions,function(a){return a.pk===b}):d===D.TRANSPORTATION_TYPE?
_.some(a.transportationOptions,function(a){return a.pk===b}):d===D.COUNT_TYPE?b>=a.countMin&&b<=a.countMax:!0},autofillValue:function(a,b,d){if(!_.isUndefined(b)&&(a=a.customField,D.isOptionAvailable(a,b)))return d&&a.type===D.NEW_TRANSPORTATION_TYPE&&(b=void 0),_.clone(b)},verboseName:T("custom field"),verboseNamePlural:T("custom fields"),dropdownName:function(a){return"["+a.shortDisplayType+"] "+a.name}};_.extend(D,{GROUPED_TYPES:{text:[D.SHORT_TYPE,D.LONG_TYPE],checkbox:[D.YES_NO_TYPE,D.CODE_GENERATOR_TYPE],
dropdown:[D.EXTENDED_OPTION_TYPE],quantity:[D.COUNT_TYPE],transportation:[D.NEW_TRANSPORTATION_TYPE,D.TRANSPORTATION_TYPE],code:[D.MULTI_CAMPAIGN_TYPE,D.CODE_TYPE],label:[D.HEADER_TYPE],waiver:[D.WAIVER_TYPE],"gift-card":[D.CARD_GENERATOR_TYPE]},groupedType:function(a){return _.findKey(D.GROUPED_TYPES,function(b){return _.contains(b,a)})},DEFAULT_VALUE_TYPES:[D.SHORT_TYPE,D.YES_NO_TYPE,D.CODE_GENERATOR_TYPE,D.EXTENDED_OPTION_TYPE,D.COUNT_TYPE]});var Z=function(a){return _.some(a.payments,function(a){return a.type===
ba.AFFILIATE_TYPE?!1:!a.isDeferred&&!a.isRefunded})},ia=function(a){return _.some(a.payments,function(a){return a.type===ba.AFFILIATE_TYPE?!1:!a.isDeferred&&!!a.refundCount})},J={AVAILABILITY_MANIFEST_TYPE:"availability-manifest",ORDER_CONFIRMATION_TYPE:"order-confirmation",ORDER_CANCELLATION_TYPE:"order-cancellation",ORDER_RECEIPT_TYPE:"order-receipt",ORDER_REFUNDED_TYPE:"order-refunded",ORDER_SHARE_TYPE:"order-share",BANK_ACCOUNT_CHANGE_TYPE:"bank-account-change",BOOKING_CANCELLATION_TYPE:"booking-cancellation",
BOOKING_CONFIRMATION_TYPE:"booking-confirmation",BOOKING_FOLLOW_UP_TYPE:"booking-follow-up",BOOKING_MESSAGE_TYPE:"booking-message",BOOKING_RECEIPT_TYPE:"booking-receipt",BOOKING_REBOOKED_TYPE:"booking-rebooked",BOOKING_REFUNDED_TYPE:"booking-refunded",BOOKING_REMINDER_TYPE:"booking-reminder",BOOKING_SHARE_TYPE:"booking-share",NOTIFICATION_FAILURE_TYPE:"notification-failure",CREW_CHANGE_TYPE:"crew-change",CREW_REMINDER_TYPE:"crew-reminder",DAILY_MANIFEST_TYPE:"daily-manifest",DISPUTE_TYPE:"dispute",
INVOICE_PAYMENT_REQUEST_TYPE:"invoice-payment-request",INVOICE_UPLOAD_STATUS_UPDATE_TYPE:"invoice-upload-status-update",STORED_VALUE_CARD_TYPE:"stored-value-card",FAILED_SOFORT_PAYMENTS_TYPE:"failed-sofort-payments",displayType:function(a){a=a.replace("booking-","").replace("order-","");return _.capitalize(a)},notificationTypesForOrder:function(a){var b=[];a.contributingBookingCount&&b.push(J.ORDER_CONFIRMATION_TYPE);_.any(a.allBookings,Z)&&b.push(J.ORDER_RECEIPT_TYPE);_.any(a.allBookings,ia)&&b.push(J.ORDER_REFUNDED_TYPE);
_.any(a.allBookings,"isCancelled")&&b.push(J.ORDER_CANCELLATION_TYPE);return b},notificationTypesForBooking:function(a){if(a.rebookedTo)return[];var b=[];a.isCancelled?b.push(J.BOOKING_CANCELLATION_TYPE):a.rebookedFrom?(b.push(J.BOOKING_REBOOKED_TYPE),b.push(J.BOOKING_REMINDER_TYPE),b.push(J.BOOKING_CONFIRMATION_TYPE)):(b.push(J.BOOKING_CONFIRMATION_TYPE),b.push(J.BOOKING_REMINDER_TYPE));Z(a)&&b.push(J.BOOKING_RECEIPT_TYPE);ia(a)&&b.push(J.BOOKING_REFUNDED_TYPE);b.push(J.BOOKING_MESSAGE_TYPE);b.push(J.BOOKING_FOLLOW_UP_TYPE);
return b},isPreviewable:function(a){return _.contains([J.ORDER_CANCELLATION_TYPE,J.ORDER_CONFIRMATION_TYPE,J.BOOKING_CANCELLATION_TYPE,J.BOOKING_CONFIRMATION_TYPE,J.BOOKING_FOLLOW_UP_TYPE,J.BOOKING_MESSAGE_TYPE,J.BOOKING_REMINDER_TYPE,J.INVOICE_PAYMENT_REQUEST_TYPE],a)},isSubjectEditable:function(a){return _.contains([J.BOOKING_CANCELLATION_TYPE,J.BOOKING_FOLLOW_UP_TYPE,J.BOOKING_MESSAGE_TYPE,J.BOOKING_REBOOKED_TYPE,J.BOOKING_RECEIPT_TYPE,J.BOOKING_REFUNDED_TYPE,J.ORDER_RECEIPT_TYPE,J.ORDER_REFUNDED_TYPE],
a)},filterByType:function(a,b){return _.filter(a,function(a){return a.type===b})},bookingConfirmationNotifications:function(a){return J.filterByType(a,J.BOOKING_CONFIRMATION_TYPE)},bookingFollowUpNotifications:function(a){return J.filterByType(a,J.BOOKING_FOLLOW_UP_TYPE)},bookingRebookedNotifications:function(a){return J.filterByType(a,J.BOOKING_REBOOKED_TYPE)},bookingReminderNotifications:function(a){return J.filterByType(a,J.BOOKING_REMINDER_TYPE)},invoicePaymentRequestNotifications:function(a){return J.filterByType(a,
J.INVOICE_PAYMENT_REQUEST_TYPE)},UNKNOWN_STATUS:"unknown",PROCESSED_STATUS:"processed",DEFERRED_STATUS:"deferred",DELIVERED_STATUS:"delivered",USER_OPENED_STATUS:"open",USER_CLICKED_URL_STATUS:"click",BOUNCE_STATUS:"bounce",DROPPED_STATUS:"dropped",USER_REPORTED_SPAM_STATUS:"spamreport",USER_UNSUBSCRIBED_STATUS:"unsubscribe",isOpened:function(a){return _.contains([J.USER_OPENED_STATUS,J.USER_CLICKED_URL_STATUS,J.USER_REPORTED_SPAM_STATUS,J.USER_UNSUBSCRIBED_STATUS],a)},isFailed:function(a){return _.contains([J.BOUNCE_STATUS,
J.DROPPED_STATUS],a)},subjectForDisputeType:function(a){return interpolate(T("[Response Needed] New Dispute for Booking #%(bookingId)s (%(personName)s)"),{bookingId:a.pk,personName:a.contact.name})}},ea={US_COUNTRY_CODE:"US",INTERNATIONAL_ENABLED_COUNTRIES:l,INTERNATIONAL_DISABLED_COUNTRIES:[["US","USA"]],TEST_NUMBERS:"+15005550001 +15005550002 +15005550003 +15005550004 +15005550006 +15005550009".split(" "),INTERNATIONAL_ENABLED_NUMBER_REGEX:/^\+?\d{5,15}$/,INTERNATIONAL_DISABLED_NUMBER_REGEX:/^(\+1|1)?\d{10}$/,
INTERNATIONAL_ENABLED_NUMBER_MAX_LENGTH:16,INTERNATIONAL_DISABLED_NUMBER_MAX_LENGTH:12,isTestNumber:function(b){b="+"+a.get("phoneNumbers").digits(b);return _.contains(ea.TEST_NUMBERS,b)},isTestNumberAllowed:function(){return window.slipstream&&"production"!=window.slipstream.configuration&&window.slipstream.isTwilioTestAccountEnabled},isEligiblePhoneNumber:function(b,d,c){if(ea.isTestNumberAllowed()&&ea.isTestNumber(b))return!0;var e=a.get("phoneNumbers");return!e.isPossiblyValid(b)?!1:d?"US"===
d?e.parseUsPhoneNumber(b).isUsPhoneNumber:!c?(console.warn("SmsNotification.isEligiblePhoneNumber: company not provided"),!1):c.features.isInternationalSmsEnabled:e.parseUsPhoneNumber(b).isUsPhoneNumber?!0:!c?(console.warn("SmsNotification.isEligiblePhoneNumber: company not provided"),!1):c.features.isInternationalSmsEnabled},groupByStatus:function(a){var b=_.groupBy(a,"status"),d=[];_.forEach("delivered sent pending queued sending rejected undelivered failed invalid".split(" "),function(a){var c=
b[a];c&&c.length&&d.push({status:a,displayStatus:c[0].displayStatus,items:c})});return d}},P={AVAILABILITY_MANIFEST_TYPE:J.AVAILABILITY_MANIFEST_TYPE,BANK_ACCOUNT_CHANGE_TYPE:J.BANK_ACCOUNT_CHANGE_TYPE,BOOKING_CONFIRMATION_TYPE:J.BOOKING_CONFIRMATION_TYPE,BOOKING_CANCELLATION_TYPE:J.BOOKING_CANCELLATION_TYPE,NOTIFICATION_FAILURE_TYPE:J.NOTIFICATION_FAILURE_TYPE,CREW_CHANGE_TYPE:J.CREW_CHANGE_TYPE,CREW_REMINDER_TYPE:J.CREW_REMINDER_TYPE,DAILY_MANIFEST_TYPE:J.DAILY_MANIFEST_TYPE,DISPUTE_TYPE:J.DISPUTE_TYPE,
INVOICE_UPLOAD_STATUS_UPDATE_TYPE:J.INVOICE_UPLOAD_STATUS_UPDATE_TYPE,FAILED_SOFORT_PAYMENTS_TYPE:J.FAILED_SOFORT_PAYMENTS_TYPE,DIRECT_BOOKING_OPTION:"isDirect",ONLINE_BOOKING_OPTION:"isOnline",AFFILIATE_BOOKING_OPTION:"isAffiliate",REBOOKED_BOOKING_OPTION:"isRebooked",isTypeSupported:function(a,b){return b===P.BANK_ACCOUNT_CHANGE_TYPE?a.isAffiliate||a.isCharter:b===P.INVOICE_UPLOAD_STATUS_UPDATE_TYPE?(a.isAffiliate||a.isCharter)&&a.isInvoicingEnabled:b===P.FAILED_SOFORT_PAYMENTS_TYPE?!0===a.features.isSofortPaymentsEnabled:
a.isCharter},isAnyTypeSupported:function(a){return _.some(P.TYPES,function(b){return P.isTypeSupported(a,b)})},isUserSubscribed:function(a,b,d){return _.some(a,function(a){return a.user===b&&a.type===d})}};P.TYPES=[P.AVAILABILITY_MANIFEST_TYPE,P.BANK_ACCOUNT_CHANGE_TYPE,P.BOOKING_CANCELLATION_TYPE,P.BOOKING_CONFIRMATION_TYPE,P.NOTIFICATION_FAILURE_TYPE,P.CREW_CHANGE_TYPE,P.CREW_REMINDER_TYPE,P.DAILY_MANIFEST_TYPE,P.DISPUTE_TYPE,P.INVOICE_UPLOAD_STATUS_UPDATE_TYPE];P.ITEM_SUBSCRIPTION_TYPES=[P.AVAILABILITY_MANIFEST_TYPE,
P.BOOKING_CONFIRMATION_TYPE,P.BOOKING_CANCELLATION_TYPE,P.NOTIFICATION_FAILURE_TYPE,P.CREW_CHANGE_TYPE,P.CREW_REMINDER_TYPE];P.HOURS_BEFORE_SUBSCRIPTION_TYPES=[P.AVAILABILITY_MANIFEST_TYPE,P.CREW_REMINDER_TYPE,P.DAILY_MANIFEST_TYPE];P.HOURS_BEFORE_DEFAULTS={};P.HOURS_BEFORE_DEFAULTS[P.AVAILABILITY_MANIFEST_TYPE]=24;P.HOURS_BEFORE_DEFAULTS[P.CREW_REMINDER_TYPE]=24;P.HOURS_BEFORE_DEFAULTS[P.DAILY_MANIFEST_TYPE]=-6;P.CREW_AVAILABILITIES_ONLY_TYPES=[P.AVAILABILITY_MANIFEST_TYPE,P.BOOKING_CONFIRMATION_TYPE];
P.BOOKING_OPTION_TYPES=[P.BOOKING_CANCELLATION_TYPE,P.BOOKING_CONFIRMATION_TYPE];P.BOOKING_OPTIONS=[P.DIRECT_BOOKING_OPTION,P.ONLINE_BOOKING_OPTION,P.AFFILIATE_BOOKING_OPTION,P.REBOOKED_BOOKING_OPTION];P.BOOKING_OPTIONS_BY_TYPE={};P.BOOKING_OPTIONS_BY_TYPE[P.BOOKING_CANCELLATION_TYPE]=[P.DIRECT_BOOKING_OPTION,P.ONLINE_BOOKING_OPTION,P.AFFILIATE_BOOKING_OPTION];P.BOOKING_OPTIONS_BY_TYPE[P.BOOKING_CONFIRMATION_TYPE]=[P.DIRECT_BOOKING_OPTION,P.ONLINE_BOOKING_OPTION,P.AFFILIATE_BOOKING_OPTION,P.REBOOKED_BOOKING_OPTION];
var l={ORDER_CONFIRMATION_TYPE:J.ORDER_CONFIRMATION_TYPE,CANCELLATION_TYPE:J.BOOKING_CANCELLATION_TYPE,CONFIRMATION_TYPE:J.BOOKING_CONFIRMATION_TYPE,FOLLOW_UP_TYPE:J.BOOKING_FOLLOW_UP_TYPE,MESSAGE_TYPE:J.BOOKING_MESSAGE_TYPE,RECEIPT_TYPE:J.BOOKING_RECEIPT_TYPE,REBOOKED_TYPE:J.BOOKING_REBOOKED_TYPE,REFUNDED_TYPE:J.BOOKING_REFUNDED_TYPE,CUSTOM_TYPE:"CUSTOM",INVOICE_PAYMENT_REQUEST_TYPE:J.INVOICE_PAYMENT_REQUEST_TYPE,TYPES:[J.BOOKING_CANCELLATION_TYPE,J.BOOKING_CONFIRMATION_TYPE,J.BOOKING_FOLLOW_UP_TYPE,
J.BOOKING_MESSAGE_TYPE,J.BOOKING_RECEIPT_TYPE,J.BOOKING_REBOOKED_TYPE,J.BOOKING_REFUNDED_TYPE,J.INVOICE_PAYMENT_REQUEST_TYPE,"CUSTOM"],BOOKING_TYPES:[J.BOOKING_CANCELLATION_TYPE,J.BOOKING_CONFIRMATION_TYPE,J.BOOKING_FOLLOW_UP_TYPE,J.BOOKING_MESSAGE_TYPE,J.BOOKING_RECEIPT_TYPE,J.BOOKING_REBOOKED_TYPE,J.BOOKING_REFUNDED_TYPE],ORDER_TYPES:[J.BOOKING_CANCELLATION_TYPE,J.BOOKING_CONFIRMATION_TYPE,J.BOOKING_MESSAGE_TYPE,J.BOOKING_RECEIPT_TYPE,J.BOOKING_REFUNDED_TYPE],displayType:J.displayType},wa={OFFLINE_STATUS:"offline",
ONLINE_STATUS:"online",STRIPE_ERRORS:{reader_error:T("Device error."),canceled:T("Payment cancelled."),no_established_connection:T("Device not connected."),no_active_collect_payment_method_attempt:T("Unable to cancel payment."),cancelable_already_completed:T("Unable to cancel payment."),network_error:T("Error connecting to device."),card_declined:T("Could not process payment because the card was declined. You may need to call the card issuer or try a different card."),requires_payment_method:T("Card declined, try a different card (or try again with the same card)."),
requires_confirmation:T("Temporary connectivity problem, please try again."),already_connected:T("Connect to reader failed because the reader is already connected."),cancelable_already_canceled:T("Cancellation failed because the operation has already been cancelled."),discovery_too_many_readers:T("Please try again, or contact FareHarbor Support. (S-READERS)"),failed_fetch_connection_token:T("Could not fetch a connection token."),invalid_reader_version:T("Please update the EMV card reader."),network_timeout:T("Network timeout."),
no_active_read_reusable_card_attempt:T("An error occurred, please try again."),payment_intent_is_null:T("Request timed out, please try again.")},CONNECT_READER_ERROR_CODE:"reader_error",READER_IN_USE_ERROR_MESSAGE:"Reader is currently in use.",UNKNOWN_ERROR:T("Unknown error. Please refresh the page and try again."),CANCELLED_ERROR:T("Payment cancelled")},ja={PENDING_STATUS:"pending",DISPUTED_STATUS:"disputed",WON_STATUS:"won",LOST_STATUS:"lost",REFUNDED_STATUS:"refunded",displayStatus:function(a){return _.capitalize(a)}};
ja.OPEN_STATUSES=[ja.PENDING_STATUS,ja.DISPUTED_STATUS];ja.CLOSED_STATUSES=[ja.WON_STATUS,ja.LOST_STATUS,ja.REFUNDED_STATUS];ja.STATUSES=ja.OPEN_STATUSES.concat(ja.CLOSED_STATUSES);var ba={CC_TYPE:"balanced-cc",LEGACY_CC_TYPE:"cc",IN_STORE_TYPE:"in-store",AFFILIATE_TYPE:"affiliate",STORED_VALUE_CARD_TYPE:"stored-value-card",MIN_CHARGE_AMOUNT:50,PENDING_DISPUTE_STATUS:"pending",DISPUTED_DISPUTE_STATUS:"disputed",WON_DISPUTE_STATUS:"won",LOST_DISPUTE_STATUS:"lost",REFUNDED_DISPUTE_STATUS:"refunded",
AFFILIATE_PAYMENT_TYPE:"affiliate",AFFILIATE_PAYMENT_DISPLAY_TEXT:T("Collected by affiliate"),IDEAL_BANK_TYPE_CHOICES:[["abn_amro","ABN AMRO"],["asn_bank","ASN Bank"],["bunq","bunq"],["handelsbanken","Handelsbanken"],["ing","ING"],["knab","Knab"],["moneyou","Moneyou"],["rabobank","Rabobank"],["regiobank","RegioBank"],["sns_bank","De Volksbank (SNS Bank)"],["triodos_bank","Triodos Bank"],["van_lanschot","Van Lanschot"]],SOFORT_COUNTRY_CHOICES:[["AT",T("Austria")],["BE",T("Belgium")],["DE",T("Germany")],
["IT",T("Italy")],["NL",T("Netherlands")],["ES",T("Spain")]],isOpenDisputeStatus:function(a){return _.contains(ba.OPEN_DISPUTE_STATUES,a.disputeStatus)},isClosedDisputeStatus:function(a){return _.contains(ba.CLOSED_DISPUTE_STATUSES,a.disputeStatus)},isDisputedAndNonRefundable:function(a){return a.disputeStatus===ba.DISPUTED_DISPUTE_STATUS||a.disputeStatus===ba.LOST_DISPUTE_STATUS||a.disputeStatus===ba.REFUNDED_DISPUTE_STATUS},isEmv:function(a){return a.type===ba.CC_TYPE&&a.metadata&&a.metadata.isEmv},
isEmvSignatureRequired:function(a){return ba.isEmv(a)&&a.metadata.isEmvSignatureRequired},emvDetails:function(a){if(!ba.isEmv(a))return[];var b=_.toTrueKeys("Date;Time;Amount;Description;Name;Address;Zip;City;Country;Contact;Additional Information;Account".split(";"));return _.filter(a.metadata.emvDetails,function(a){return!b[a.key]})},isPartialRefundAllowed:function(a){return!a.isProcessorBasedType||!a.isDisputed||a.disputeStatus===ba.WON_DISPUTE_STATUS||a.disputeStatus===ba.PENDING_DISPUTE_STATUS},
COUNTRIES_WITH_POSTAL_CODES:["US"],DEMO_CARD_NUMBERS:["4111111111111111","5105105105105100","341111111111111","4242424242424242"],isNotCardOnFileProcessorBasedType:function(a){return ba.isProcessorBasedType(a)&&!a.isCardOnFile},isProcessorBasedType:function(a){return a.type===ba.CC_TYPE||a.type===ba.LEGACY_CC_TYPE},isDemoCardNumber:function(a){return _.contains(ba.DEMO_CARD_NUMBERS,a)},needsPostalCode:function(a){return _.contains(ba.COUNTRIES_WITH_POSTAL_CODES,a)},cardPayments:function(a,b){var d=
{};_.forEach(a,function(a){if(!b&&a.type===ba.CC_TYPE||b&&a.isProcessorBasedType){var c=a.processorBasedType+"-"+a.processorBasedIdentifier;d[c]||(d[c]=a)}});return _.values(d)},relatedCardPayments:function(a,b){return _.union.apply(null,_.map(a.contact.relatedBookings,function(a){return ba.cardPayments(a.payments,b)}))},isGratuityEnabled:function(a){return _.any(_.map(a.bookings?a.bookings:[a.booking],"item"),{isGratuityEnabled:!0})},receiptFooters:function(a){return _.filter(_.map(ba.items(a),"receiptFooter"))},
order:function(a){return a.bookings&&a.bookings.length?a.bookings[0].order:null},hasMultipleVisibleContributingBookings:function(a){return!a.bookings?!1:1<a.bookings.length+ +!!a.invisibleBookingCount},items:function(a){return a.booking?[a.booking.item]:H.uniqueItems(a.bookings)},sortByCreatedAt:function(a){return _.sortByOrder(a,function(a){return moment.isMoment(a.createdAt)?a.createdAt.unix():0},!1)},printablePayments:function(a){a=_.map(a,function(a){return a.aggregatedPayment&&a.aggregatedPayment.isAggregated?
a.aggregatedPayment:a});return _.filter(a,function(a){return!a.isDeferred&&a.type!==ba.AFFILIATE_TYPE})},taxByType:function(a,b){if(!a.company.features.isTaxTypeBreakdownEnabled)return null;var d,c=b?"initialCosts":"costs";d=_.isArray(a.payments)?_.reduce(a.payments,function(a,b){return _.sumObjectValues(a,b[c].totalCost.taxByType)},{}):a[c].totalCost.taxByType;return Ka.LEGACY_TAX_TYPE_PK in d?null:d}};ba.OPEN_DISPUTE_STATUES=[ba.PENDING_DISPUTE_STATUS,ba.DISPUTED_DISPUTE_STATUS];ba.CLOSED_DISPUTE_STATUSES=
[ba.WON_DISPUTE_STATUS,ba.LOST_DISPUTE_STATUS,ba.REFUNDED_DISPUTE_STATUS];var S={NO_REPEAT:"none",WEEKLY_REPEAT:"weekly",MONTHLY_REPEAT:"monthly",ALL_DAY_PERIOD:"all-day",TIME_RANGE_PERIOD:"time-range",DAY_RANGE_PERIOD:"day-range",FAILED_STATUS:"failed",SUCCEEDED_STATUS:"succeeded",WEEK_DAYS_KEYS:"sunday monday tuesday wednesday thursday friday saturday".split(" "),WEEK_DAYS:{sunday:T("Sunday"),monday:T("Monday"),tuesday:T("Tuesday"),wednesday:T("Wednesday"),thursday:T("Thursday"),friday:T("Friday"),
saturday:T("Saturday")},WEEK_DAYS_SHORT:{sunday:cT("Abbreviation of Sunday","Su"),monday:cT("Abbreviation of Monday","M"),tuesday:cT("Abbreviation of Tuesday","T"),wednesday:cT("Abbreviation of Wednesday","W"),thursday:cT("Abbreviation of Thursday","Th"),friday:cT("Abbreviation of Friday","F"),saturday:cT("Abbreviation of Saturday","S")},weekDays:function(a){var b=_.clone(S.WEEK_DAYS_KEYS);a.features.isSundayBased||b.push(b.shift());return b},weekDayShort:function(a){return S.WEEK_DAYS_SHORT[a]},
weekDaysDefaultModel:function(){var a={};_.forEach(S.WEEK_DAYS_KEYS,function(b){a[b]=!0});return a},defaultRule:function(){var a={period:S.TIME_RANGE_PERIOD,repeat:S.NO_REPEAT,hours:"",time:"",startOn:null,endOn:null};_.extend(a,S.weekDaysDefaultModel());return a}},ca={ADJUSTMENT_TAG:"adjustment",FUND_BOOKING_FEE_PROCESSING_FEE_TAG:"fund-booking-fee",FUND_PROCESSING_FEE_TAG:"fund-processing-fee",OTHER_TAG:"other",PAYMENT_BOOKING_FEE_TAG:"payment-booking-fee",PAYMENT_BOOKING_FEE_PROCESSING_FEE_TAG:"payment-booking-fee-processing-fee",
PAYMENT_GROSS_TAG:"payment-gross",PAYMENT_PROCESSING_FEE_TAG:"payment-processing-fee",PAYOUT_TAG:"payout",REFUND_GROSS_TAG:"refund-gross",REFUND_BOOKING_FEE_TAG:"refund-booking-fee",REFUND_BOOKING_FEE_PROCESSING_FEE_TAG:"refund-booking-fee-processing-fee",REFUND_PROCESSING_FEE_TAG:"refund-processing-fee",TRANSFER_TAG:"transfer",UPLOAD_TAG:"upload",UNKNOWN_TAG:"",displayTag:function(a){return a===ca.UNKNOWN_TAG?"Unknown":_.capitalize(a.split("-").join(" "))}};ca.TAGS=[ca.ADJUSTMENT_TAG,ca.FUND_BOOKING_FEE_PROCESSING_FEE_TAG,
ca.FUND_PROCESSING_FEE_TAG,ca.OTHER_TAG,ca.PAYMENT_BOOKING_FEE_TAG,ca.PAYMENT_BOOKING_FEE_PROCESSING_FEE_TAG,ca.PAYMENT_GROSS_TAG,ca.PAYMENT_PROCESSING_FEE_TAG,ca.PAYOUT_TAG,ca.REFUND_GROSS_TAG,ca.REFUND_BOOKING_FEE_TAG,ca.REFUND_BOOKING_FEE_PROCESSING_FEE_TAG,ca.REFUND_PROCESSING_FEE_TAG,ca.TRANSFER_TAG,ca.UPLOAD_TAG,ca.UNKNOWN_TAG];var la=function(b,d){if(!b)return!1;var c=a.get("db").slipstream(d);return!_.isArray(c)?(console.warn("isCountryApplicable: invalid value",c,d),!1):_.contains(c,b)},
k={getCurrencyChoices:k},na={VALID_VALIDITY:"valid",INVALID_VALIDITY:"invalid",DATE_RANGE_FOR_AVAILABILITY_TYPE:"range-for-booking",DATE_RANGE_FOR_BOOKING_TYPE:"range-for-availability",displayDayPattern:function(a){if(!_.contains([na.DATE_RANGE_FOR_AVAILABILITY_TYPE,na.DATE_RANGE_FOR_BOOKING_TYPE],a.type))return"";a=a.dayPattern||[];return!a.length||a.length===S.WEEK_DAYS_KEYS.length?"":_.map(a,function(a){return S.WEEK_DAYS_SHORT[a]}).join(", ")}},ka={FLAT_FEE_RULE_TYPE:"flat",MAXIMUM_FEE_RULE_TYPE:"maximum",
calculateFeeableForFee:function(a,b){return _.roundHalfToEven(a/b)},calculateFeeableForRule:function(a,b,d){if(a.feeType!==h.PERCENTAGE_FEE_TYPE||!a.percentageFeeRate)return 0;a=a.percentageFeeRate;if(d.type===ka.FLAT_FEE_RULE_TYPE)return ka.calculateFeeableForFee(d.amount,a);if(d.type===ka.MAXIMUM_FEE_RULE_TYPE){var c=_.roundHalfToEven(b*a);d=d.amount;return c>d?ka.calculateFeeableForFee(d,a):b}console.warn("StoredValueCard.calculateFeeableForRule: invalid rule type",d.type);return 0},calculateFeeable:function(b,
d){if(!b.features.isStoredValueCardBookingFeesEnabled)return 0;var c=a.get("db").slipstream("storedValueCardFeeableRules");if(_.isUndefined(c))return console.warn("StoredValueCard.calculateFeeable: rules are not defined"),0;var e=b.primaryLocation||b,c=c[e.country];if(!c)return 0;if(c.isUnrestricted)return d;e=e.province;if(_.contains(c.unrestrictedProvinces,e))return d;e=c.provinceRules[e];return!e?0:ka.calculateFeeableForRule(b,d,e)},NUMBER_REGEX:/^[a-zA-Z0-9\-_\#\%$]+$/,isNumberValid:function(a){return ka.NUMBER_REGEX.test(a)}},
U={MIN_QR_CODE_SIZE:1,MAX_QR_CODE_SIZE:1.3,STANDARD:{name:"Standard",settings:{isCompanyInformationIncluded:!0,isRotated:!1,len:5.5,height:2,marginTop:0.125,marginRight:0.125,marginBottom:0.125,marginLeft:0.125,hasLeadingStub:!0,leadingStubLength:1,leadingStubMarginTop:0.125,leadingStubMarginBottom:0.125,hasTrailingStub:!1,trailingStubLength:1,trailingStubMarginTop:0.125,trailingStubMarginBottom:0.125}},BLANK:{name:"",settings:{isCompanyInformationIncluded:!0,isRotated:!1,len:5.5,height:2,marginTop:0.125,
marginRight:0.125,marginBottom:0.125,marginLeft:0.125,hasLeadingStub:!0,leadingStubLength:1,leadingStubMarginTop:0.125,leadingStubMarginBottom:0.125,hasTrailingStub:!1,trailingStubLength:1,trailingStubMarginTop:0.125,trailingStubMarginBottom:0.125}},mainLeft:function(a){var b=a.settings.marginLeft;a.settings.hasTrailingStub&&(b+=a.settings.trailingStubLength);return b},mainRight:function(a){var b=a.settings.marginRight;a.settings.hasLeadingStub&&(b+=a.settings.leadingStubLength);return b},qrCodeSize:function(a){a=
a.settings.height-a.settings.marginTop-a.settings.marginBottom;a<U.MIN_QR_CODE_SIZE&&(a=U.MIN_QR_CODE_SIZE);a>U.MAX_QR_CODE_SIZE&&(a=U.MAX_QR_CODE_SIZE);return a},BOCA_PRINT_FORMAT:"boca",RECEIPT_PRINT_FORMAT:"receipt"},aa={ADMIN_ONLY_TYPE:"admin",ADMIN_ONLY_TYPES:"admin admin-charge-disputed admin-dispute-closed duplicated-x-companies duplicated-x-companies-single generated-report ran-report rejected-sms updated-sms-notification-status card-error processor-webhook-error transferred-payment was-transferred-payment webhook-request-failed webhook-request-succeeded".split(" "),
CHANGED_TYPES:["changed","changed-company-admin-notes","changed-booking-note","changed-customer-checkin-status"],isAdminOnly:function(a){return _.contains(aa.ADMIN_ONLY_TYPES,a.type)},isChangedType:function(a){return _.contains(aa.CHANGED_TYPES,a)},objectUrl:function(a){var b;a.object&&(b=a.object.$url());b||(b=a.company.$url());return b},_changesByFieldName:{},changesByFieldName:function(a){var b=aa._changesByFieldName[a.uri];if(b)return b;b={};_.forEach(a.context.changes,function(a){b[c.camelKey(a.field)]=
a});return aa._changesByFieldName[a.uri]=b}},Q={NO_CUSTOM_TAX:"no",ONLY_TAXED_CUSTOM_TAX:"only-taxed",ALL_CUSTOM_TAX:"all",ALWAYS_CUSTOM_TAX:"always",INHERIT_TAX_INCLUSION:"inherit",INCLUDED_TAX_INCLUSION:"included",NOT_INCLUDED_TAX_INCLUSION:"not-included",INHERIT_PRICE_TYPE:"inherit",CHANGE_PRICE_TYPE:"change",INHERIT_SHEET_RATE_TYPE:"inherit",CHANGE_SHEET_RATE_TYPE:"change",OFFSET_MODIFIER_KIND:"offset",PERCENTAGE_MODIFIER_KIND:"percentage",ADJUST_MODIFIER_TYPE:"adjust",SET_MODIFIER_TYPE:"set",
NONE_MODIFIER_TYPE:"none",INHERIT_IS_TAXABLE:"",INHERIT_IS_TAXABLE_LABEL:T("Inherit"),ON_IS_TAXABLE:!0,ON_IS_TAXABLE_LABEL:T("On"),OFF_IS_TAXABLE:!1,OFF_IS_TAXABLE_LABEL:T("Off"),displayTaxInclusion:function(a){var b={};b[Q.INHERIT_TAX_INCLUSION]=T("Inherit");b[Q.INCLUDED_TAX_INCLUSION]=T("Tax included");b[Q.NOT_INCLUDED_TAX_INCLUSION]=T("Tax not included");return b[a]},displayCustomTax:function(a){var b={};b[Q.NO_CUSTOM_TAX]=T("Standard tax");b[Q.ONLY_TAXED_CUSTOM_TAX]=T("Custom tax");b[Q.ALL_CUSTOM_TAX]=
T("Custom tax (include untaxed)");b[Q.ALWAYS_CUSTOM_TAX]=T("Custom tax (include untaxed, even on untaxed sheets)");return b[a]||b[Q.NO_CUSTOM_TAX]},isInheritTaxability:function(a){return a.isTaxable!==Q.OFF_IS_TAXABLE&&a.isTaxable!==Q.ON_IS_TAXABLE&&!_.any(a.taxTypes,_.isBoolean)},isCustomTaxAllowed:function(a,b){return b.features.isCustomTaxEnabled&&!b.features.isAggregateTaxEnabled&&a.modifierType!==Q.NONE_MODIFIER_TYPE},isTaxInclusionAllowed:function(a,b){return b.features.isTaxInclusionEnabled&&
a.modifierType!==Q.NONE_MODIFIER_TYPE&&a.customTax===Q.NO_CUSTOM_TAX&&a.modifierKind!==Q.PERCENTAGE_MODIFIER_KIND},displayTaxable:function(a){return a===Q.ON_IS_TAXABLE?Q.ON_IS_TAXABLE_LABEL:a===Q.OFF_IS_TAXABLE?Q.OFF_IS_TAXABLE_LABEL:Q.INHERIT_IS_TAXABLE_LABEL},isAggregateTaxableObject:function(a){return _.contains([M.cls,u.cls,h.cls],a.cls)},isTaxTypesAllowed:function(a,b,d){return a.isTaxable===Q.OFF_IS_TAXABLE||a.isTaxable===Q.INHERIT_IS_TAXABLE&&b.cls!==u.cls?!1:!d.company.features.isAggregateTaxEnabled||
Q.isAggregateTaxableObject(b)},showOffset:function(a){return a.price.customTax!==Q.NO_CUSTOM_TAX||a.price.modifierType===Q.NONE_MODIFIER_TYPE?!1:a.price.modifierKind===Q.OFFSET_MODIFIER_KIND&&(a.price.offset||a.price.modifierType===Q.SET_MODIFIER_TYPE)},showRate:function(a){return a.price.customTax!==Q.NO_CUSTOM_TAX||a.price.modifierType===Q.NONE_MODIFIER_TYPE?!1:a.price.modifierKind===Q.PERCENTAGE_MODIFIER_KIND&&(a.price.rate||a.price.modifierType===Q.SET_MODIFIER_TYPE)},effectiveOffset:function(a,
b){if(a.price.modifierType===Q.NONE_MODIFIER_TYPE)return 0;b=_.isUndefined(b)?1:b;return _.roundHalfToEven(a.price.offset*a.sheetRate.sheetRate*b)},effectiveRate:function(a,b){if(a.price.modifierType===Q.NONE_MODIFIER_TYPE)return 0;b=_.isUndefined(b)?1:b;return a.price.rate*b},modifierKindChoices:function(b){var d,c=a.get("db").slipstream("currencies");if(c){var e=_.resolveCurrency(b);if(c=c[e])d=c.symbol}d||(console.warn("modifierKindChoices: unable to determine currency symbol",b),d="$");return[[Q.PERCENTAGE_MODIFIER_KIND,
"%"],[Q.OFFSET_MODIFIER_KIND,d]]},isTaxIncluded:function(a){return a.price.taxInclusion===ra.PriceLine.INCLUDED_TAX_INCLUSION&&a.taxes.taxability!==ra.PriceSheet.NONE_TAXABILITY&&a.price.customTax===ra.PriceLine.NO_CUSTOM_TAX&&a.price.modifierKind!==ra.PriceLine.PERCENTAGE_MODIFIER_KIND},isCompanyBaseLine:function(a,b){return b.isBase&&a.cls===h.cls},effectiveTaxTypes:function(a){return _.unique(_.append(_.keys(a.taxes.ratesByType),_.keys(a.taxes.offsetsByType)))}};Q.IS_TAXABLE_CHOICES=[{label:Q.INHERIT_IS_TAXABLE_LABEL,
value:Q.INHERIT_IS_TAXABLE},{label:Q.ON_IS_TAXABLE_LABEL,value:Q.ON_IS_TAXABLE},{label:Q.OFF_IS_TAXABLE_LABEL,value:Q.OFF_IS_TAXABLE}];Q.isTaxableChoices=function(a,b){return Q.isCompanyBaseLine(a,b)?_.slice(Q.IS_TAXABLE_CHOICES,1):Q.IS_TAXABLE_CHOICES};var Ga=_.property("isOnline"),xa=_.property("isBase"),ma=_.property("isTotalBase"),da=_.property("isInvoiceBase"),sa=function(a){return!a.isBase&&!a.isTotalBase&&!a.isInvoiceBase},W={NONE_TAXABILITY:"none",PRO_RATE_TAXABILITY:"pro-rate",FULL_TAXABILITY:"full",
OFFSET_MODIFIER_KIND:"offset",PERCENTAGE_MODIFIER_KIND:"percentage",ADJUST_MODIFIER_TYPE:"adjust",SET_MODIFIER_TYPE:"set",baseSheet:function(a){return _.find(a,xa)},nonBaseSheets:function(a){return _.filter(a,sa)},sheetRateToModel:function(a){return _.roundHalfToEven(100*a,7)},sheetRateFromModel:function(a){return a/100},isInvoiceSheet:function(a){return a.cls===ra.InvoiceSheet.cls},taxable:function(a){if(a.price.modifierType===Q.NONE_MODIFIER_TYPE)return 0;var b=a.taxes.taxability;if(b===W.NONE_TAXABILITY)return 0;
if(b===W.PRO_RATE_TAXABILITY)return Q.effectiveOffset(a);if(b===W.FULL_TAXABILITY)return a.price.offset;console.warn("invalid taxability",b);return 0},isNonBase:sa,dropdownLabel:function(a){var b=a.displayName;a.cls.endsWith("Schedule")&&(b+=" "+T("(schedule)"));return b}};Q.NONE_PRICING={visibility:{isVisible:!0,isHiddenWhenBooking:!1,isHiddenOnReceipts:!1,isRequired:!1},price:{modifierType:Q.NONE_MODIFIER_TYPE},taxes:{taxability:W.PRO_RATE_TAXABILITY},sheetRate:{sheetRate:1}};Q.HIDDEN_PRICING={visibility:{isVisible:!1,
isHiddenWhenBooking:!1,isHiddenOnReceipts:!1,isRequired:!1},price:{modifierType:Q.NONE_MODIFIER_TYPE},taxes:{taxability:W.PRO_RATE_TAXABILITY},sheetRate:{sheetRate:1}};var Ba=_.extend({baseSheet:W.baseSheet,totalBaseSheet:function(a){return _.find(a,ma)},nonBaseSheets:W.nonBaseSheets,onlineSheets:function(a){return _.filter(a,Ga)},displaySheetRate:function(a){return a-1},fromDisplaySheetRate:function(a){return a+1},isOnlineDefault:function(a){return!a||!a.pk?!1:a==a.company.defaultOnlineTotalSheet||
a.company.defaultOnlineTotalSchedule&&a==a.company.defaultOnlineTotalSchedule.fallback}},W),Za=_.extend({INHERIT_VISIBILITY:"inherit",VISIBLE_VISIBILITY:"visible",HIDDEN_VISIBILITY:"hidden"},Q),ta=_.extend({AFFILIATE_RELATIONSHIP:"affiliate",CHARTER_RELATIONSHIP:"charter",invoiceBaseSheet:function(a){return _.find(a,da)},nonBaseSheets:W.nonBaseSheets,displaySheetRate:function(a,b){if(b===ta.CHARTER_RELATIONSHIP)return 1-a;if(b===ta.AFFILIATE_RELATIONSHIP)return a},fromDisplaySheetRate:function(a,
b){if(b===ta.CHARTER_RELATIONSHIP)return 1-a;if(b===ta.AFFILIATE_RELATIONSHIP)return a},displayRelationship:function(a){return a===ta.CHARTER_RELATIONSHIP?"reseller":a===ta.AFFILIATE_RELATIONSHIP?"referral":"none"}},W),Yb=_.extend({},Q),Cb={isOnlineFallback:function(a){return a.fallback&&a.fallback.isOnline},verboseName:T("schedule"),verboseNamePlural:T("schedules")},Db={verboseName:T("schedule"),verboseNamePlural:T("schedules")},Ca={groupRules:function(a,b){var d={};_.forEach(Ca.RULE_TYPES,function(a){d[a]=
[]});_.forEach(a,function(a){d[a.type].push(a)});b&&this.sortDayOfWeekType(d,b);return d},sortDayOfWeekType:function(a,b){var d=S.weekDays(b);_.forEach(a,function(b,c){_.contains(Ca.DAY_OF_WEEK_TYPES,c)&&(a[c]=_.sortBy(b,function(a){return d.indexOf(a.dayPattern[0])}))})},displayType:function(a){return Ca.TYPE_CHOICES[a.type]},isDateType:function(a){return _.contains(Ca.DATE_TYPES,a.type)},isDayOfWeekType:function(a){return _.contains(Ca.DAY_OF_WEEK_TYPES,a.type)},combinedDayPattern:function(a){var b=
_.flatten(_.pluck(a,"dayPattern")),d=[];_.forEach(S.WEEK_DAYS_KEYS,function(a){_.contains(b,a)&&d.push(S.weekDayShort(a))});return d}},Ka={LEGACY_TAX_TYPE_PK:-1,RATE_TYPE:"rate",OFFSET_TYPE:"offset",displayName:function(a){return interpolate(T("%(name)s (%(rate)s)"),{name:b("name")(a),rate:Ka.displayRate(a)})},displayRate:function(a){if(a.type===Ka.RATE_TYPE)return b("percentage")(a.rate,"hideplus");if(a.type===Ka.OFFSET_TYPE)return b("amount")(a.offset,a.company)}},Ya={},xc=function(){var a={GOOGLE_ANALYTICS_TYPE:"google-analytics",
FACEBOOK_TYPE:"facebook",ADROLL_TYPE:"adroll",OPTIMIZELY_TYPE:"optimizely",CUSTOM_CODE_TYPE:"custom-code",IDENTIFIERS_BY_TYPE:{},IDENTIFIER_LABELS:{googleAnalyticsUa:"UA Code",facebookPixel:"Pixel ID",adrollAdvertiser:"Advertiser ID",adrollPixel:"Pixel ID",optimizelyAccount:"Account ID",optimizelyProject:"Project ID",optimizelyEventKey:"Goal Event",optimizelyGoals:"Goal ID(s)",customCode:"Code",customIdentifiers:"Identifiers"},needsCrossDomainField:function(b){return _.includes([a.GOOGLE_ANALYTICS_TYPE,
a.FACEBOOK_TYPE,a.ADROLL_TYPE,a.OPTIMIZELY_TYPE],b)},displayIdentifier:function(b){return a.IDENTIFIER_LABELS[b]}},b=a.IDENTIFIERS_BY_TYPE;b[a.GOOGLE_ANALYTICS_TYPE]=["googleAnalyticsUa"];b[a.FACEBOOK_TYPE]=["facebookPixel"];b[a.ADROLL_TYPE]=["adrollAdvertiser","adrollPixel"];b[a.OPTIMIZELY_TYPE]=["optimizelyAccount","optimizelyProject","optimizelyEventKey","optimizelyGoals"];b[a.CUSTOM_CODE_TYPE]=["customCode","customIdentifiers"];return a}(),Eb=function(a,b){if(!a)return console.warn("supported language: invalid empty language code"),
"";var d=a.split("-")[0];return(d=$a.DISPLAY_LANGUAGES[a]||$a.DISPLAY_LANGUAGES[d])?d[b]:""},$a={isRecognizedLanguage:function(a){return _.contains($a.LANGUAGE_CODES_SORTED,a)},rootLanguage:function(a){return a.split("-")[0]},display:function(a){return Eb(a,"name")},displayLocal:function(a){return Eb(a,"nameLocal")},shareRootLanguage:function(a,b){return a&&b&&$a.rootLanguage(a)===$a.rootLanguage(b)},SCROLL_TO_LANGUAGE_PARAM:"highlight-language"},Xa={BEFORE_MIDNIGHT_CUTOFF_KIND:"before-midnight",
BEFORE_START_CUTOFF_KIND:"before-start",RESTRICTION_FIELDS:"minimumInitialPartySize minimumSubsequentPartySize maximumInitialPartySize maximumSubsequentPartySize isBookableEverByPhone soldOutText cutoffUnreachedKind cutoffUnreachedHours isCutoffUnreachedCallToBook cutoffReachedKind cutoffReachedHours isCutoffReachedCallToBook autoOpenHours autoOpenKind".split(" "),DEFAULT_AUTO_OPEN_HOURS:720,cutoffStart:function(a,b,d){if(a===Xa.BEFORE_START_CUTOFF_KIND)return d.clone().subtract(b,"hours");if(a===
Xa.BEFORE_MIDNIGHT_CUTOFF_KIND)return d.clone().startOf("day").subtract(b,"hours");console.error("BookingRestriction.cutoffStart: invalid kind "+a)}},ra={Order:K,Contact:G,Booking:H,Customer:{},LineItem:{},ItemGroup:{},Availability:M,Company:h,User:{OWNER_TYPE:"owner",ADMIN_TYPE:"admin",EMPLOYEE_TYPE:"employee",ICS_RESELLER_KEY_NAME:"ICS Calendar",showNag:function(a,b,d){a=a.nags[b];if(!a||!d&&a.isDismissed)return!1;b=v[b];return!b?!0:moment().isBefore(b)},getActive:function(a){return _.filter(a,
"isInactive",!1)},sortActiveFirst:function(a){return _.sortBy(a,function(a){return[a.isInactive,a.name.toLowerCase()]})},displayName:function(a){return a.isInactive?a.name+" "+T("(deactivated)"):a.name}},TagGroup:{},Tag:{},TagInstance:{},Item:u,FlowNode:z,CustomFieldInstanceGroup:{},CustomFieldInstanceCondition:x,CustomFieldInstance:F,CustomerType:{},CustomerPrototype:{name:function(a){return a.displayName},customerTypeSuffix:function(a){var b=a.isExclusive?T("exclusive"):"";(a=_.compact([a.name?
a.customerType.shortName||a.customerType.plural:"",b]).join(", "))&&(a="("+a+")");return a}},CustomerTypeRate:C,CheckinStatus:w,Image:{CAROUSEL_GALLERY:"carousel"},CustomField:D,ExtendedOption:{},TransportationOption:{},ConnectedCampaign:{},GeneratingCampaign:{},CannedMessage:l,Notification:J,SmsNotification:ea,ReviewExpressNotification:{},Subscription:P,Payment:ba,Dispute:ja,InStorePaymentType:{isUsable:function(a,b){var d=b.isCharter&&a.isVisibleWhenCollectedByCharter;return b.isAffiliate&&a.isVisibleWhenCollectedByAffiliate||
d},isVisibleWhenCollectedByCharter:function(a){return _.filter(a,"isVisibleWhenCollectedByCharter")},isVisibleWhenCollectedByAffiliate:function(a){return _.filter(a,"isVisibleWhenCollectedByAffiliate")}},EmvDevice:wa,Refund:{FAILED_TRANSFER_STATUS:"failed",SUCCEEDED_TRANSFER_STATUS:"succeeded",taxByType:function(a){if(!a.payment.company.features.isTaxTypeBreakdownEnabled)return null;a=a.costs.totalCost.taxByType;return Ka.LEGACY_TAX_TYPE_PK in a?null:a}},Receipt:{ALL_PAYMENT_RECEIPTS:"all",printedAt:function(){return moment()}},
Rule:S,Payout:{SUCCEEDED_STATUS:"succeeded",PAID_STATUS:"paid",PENDING_STATUS:"pending",FAILED_STATUS:"failed",PROCESSED_STATUS:"processed"},Fund:{},Transfer:{},Upload:{SUCCEEDED_STATUS:"succeeded",PENDING_STATUS:"pending",FAILED_STATUS:"failed"},Transaction:ca,Account:{BANK_TYPE:"bank",DEPOSIT_TYPE:"deposit",ESCROW_TYPE:"escrow"},Adjustment:k,Campaign:{},CampaignValidityRule:na,Code:{},StoredValueType:{},StoredValueCard:ka,StoredValueAdjustment:{},TicketLayout:U,CustomCalendar:{},CustomManifest:{},
CustomReport:{QUERY_PARAM:"saved",QUERY_PARAM_KEY:"pk"},SuggestedReport:{QUERY_PARAM:"suggested",QUERY_PARAM_KEY:"slug",DEFAULT_SLUG:"default"},Activity:aa,Block:{},Agent:L,Desk:E,Affiliation:N,CrewMember:{},Role:{},Hotel:{},Lodging:{RELATED_FEATURE_FLAG:"isTransportationEnabled"},PreferredPickup:{},Pickup:{RELATED_FEATURE_FLAG:"isTransportationEnabled"},Route:{RELATED_FEATURE_FLAG:"isTransportationEnabled"},Stop:{},Run:{},Report:I,Invoice:{PAID_STATUS:"paid",PENDING_STATUS:"pending",UNPAID_STATUS:"unpaid",
OVERDUE_STATUS:"overdue",isInvoicedToCharter:function(a){return 0<a}},InvoiceEntry:{},Location:{RELATED_FEATURE_FLAG:"isLocationsEnabled"},SupportedLanguage:$a,Translation:{displayNameForInstance:function(a){return a.name||a.displayName||a.title||a.unicode},fieldDisplayValue:function(a,b,d){a=_.camelCase(a.fieldName);return d?b[a][d]:b[a]},modelNameForUrl:function(a){return _.kebabCase(a)},modelNameFromUrl:function(a){return _.startCase(a).replace(/ /g,"")},fieldNameForUrl:function(a){return _.kebabCase(a)},
fieldNameFromUrl:function(a){return _.snakeCase(a)}},ViatorMapping:{},Waiver:{RELATED_FEATURE_FLAG:"isSmartwaiverEnabled"},ConnectedWaiver:{},WaiverInstance:{},Group:{AFFILIATE_TYPE:"affiliate",COMPANY_TYPE:"company",PARTNER_TYPE:"partner"},GroupOverride:{companyLevelOverrides:function(a){return _.filter(a,function(a){return null===a.relatedUser})}},PriceSheet:W,PriceLine:Q,TotalSheet:Ba,TotalLine:Za,InvoiceSheet:ta,InvoiceLine:Yb,TotalSchedule:Cb,InvoiceSchedule:Db,TotalScheduleEntry:{},InvoiceScheduleEntry:{},
ScheduleEntryRule:Ca,TotalScheduleEntryRule:{},InvoiceScheduleEntryRule:{},TaxType:Ka,BankAccount:{INDIVIDUAL_ACCOUNT_HOLDER_TYPE:"individual",COMPANY_ACCOUNT_HOLDER_TYPE:"company",ROUTING_NUMBER_REGEX_BY_COUNTRY:{AU:/^[\d]{6}$/,CA:/^0?[\d]{5}-?[\d]{3}$/,GB:/^[\d]{2}-?[\d]{2}-?[\d]{2}$/,NZ:/^[\d]{6}$/,US:/^[\d]{9}$/},isIbanRequired:function(a){return la(a,"ibanBankAccountCountries")},isRoutingNumberRequired:function(a){return!la(a,"ignoreRoutingNumberCountries")}},Card:{},CardAffiliation:{},CustomFieldValue:{},
BookingCustomFieldValue:Ya,CustomerCustomFieldValue:{},Resource:{NONE_GRANULARITY:"none"},RequirementGroup:m,Requirement:y,CustomerPrototypeRequirement:{},CustomerTypeRequirement:{},ResourceRequirement:{START_TIMING:"start-timing",END_TIMING:"end-timing",DATE_TIMING:"date-timing",PADDING_END_AT_KIND:"padding-kind",LENGTH_END_AT_KIND:"length-kind"},ResourceUse:{displayOption:function(a){return a?a.isIgnoreOveruse?T("Create uses, don't check overuse"):a.isSkipResourceUseCreation?T("Don't create uses, check overuse"):
T("Create uses, check overuse"):""},equals:function(a,b){return _.isUndefined(a.customerTypeRate)||_.isUndefined(b.customerTypeRate)?a.booking.pk===b.booking.pk&&a.resourceRequirement.pk===b.resourceRequirement.pk&&a.useCount===b.useCount:a.customerTypeRate.pk===b.customerTypeRate.pk&&a.resourceRequirement.pk===b.resourceRequirement.pk&&a.useCount===b.useCount},resourceUseSummaries:function(a,b){b=b||[];return _.reduce(function(a){return _.reduce(a,function(a,b){var d=b.resourceRequirement.resource;
a[d.pk]=a[d.pk]||[];a[d.pk].push(b);return a},{})}(a),function(a,d,c){a[c]=a[c]||{};a[c].totalUseCount=parseFloat(_.sum(d,"useCount").toFixed(2));a[c].resourcePk=c;a[c].resourceName=d[0].resourceRequirement.resource.name;a[c].isOverused=-1<_.map(b,"pk").indexOf(parseInt(c));return a},{})},resourceUseSummaryKey:function(a,b){return a+"-"+b}},ResourceOverride:{},SeatMap:{RELATED_FEATURE_FLAG:"isSeatingEnabled"},SeatGroup:s,Seat:q,SeatZone:B,Calendar:n,ResellerCompany:{},ResellerCompanyMapping:{},ResellerItem:{},
ResellerItemMapping:{},ResellerCustomerType:{},ResellerCustomerTypeMapping:{},ResellerOption:{},ResellerOptionMapping:{},ResellerKey:{},ResellerApp:{},ResellerAppRequest:{PENDING_STATUS:"pending",CONNECTED_STATUS:"connected"},ResellerAppCompany:{},AnalyticsService:xc,CancellationPolicy:{},CancellationRule:{ALWAYS_TYPE:"always",HOURS_BEFORE_AVAILABILITY_START_TYPE:"hours-before-start",HOURS_BEFORE_AVAILABILITY_MIDNIGHT_TYPE:"hours-before-midnight",HOURS_BEFORE_PSEUDO_TYPE:"hours-before"},BookingRestriction:Xa},
ga=_.keys(ra);_.forEach(ga,function(a){ra[a].cls=a});ra.inject=function(a){_.forEach(ga,function(b){a[b]=ra[b]})};return ra}]);h.run(["$filter","$rootScope","db","emv","models","navigation","processors","urls",function(b,a,c,f,e,g,d,l){e.inject(a);a.nullModel={};e.Company.taxDisplayRate=function(a){return a.features.includedTaxRate?b("percentage")(a.features.includedTaxRate,!0):""};e.Rule.WEEK_DAYS_DISPLAY=_.map(e.Rule.WEEK_DAYS_KEYS,function(a){return e.Rule.WEEK_DAYS[a]});e.Availability.manifestUrl=
function(a){return g.compose(l.populate(l.dashboard.manifest.availabilities,{shortname:a.company.shortname,date:a.startAt?a.startAt.format("YYYY-MM-DD"):void 0}),{items:a.item.pk,availabilities:a.pk})};e.Run.manifestUrl=function(a){return g.compose(l.populate(l.dashboard.manifest.runs,{shortname:a.route.company.shortname,date:a.startAt?a.startAt.format("YYYY-MM-DD"):void 0}),{routes:a.route.pk})};e.Item.manifestUrl=function(a,b){return g.compose(l.populate(l.dashboard.manifest.availabilities,{shortname:a.company.shortname,
date:b}),{items:a.pk})};e.Resource.manifestUrl=function(a,b){return g.compose(l.populate(l.dashboard.manifest.resources,{shortname:a.company.shortname,date:b}),{resources:a.pk})};e.Booking.processorTypes=function(a){a=a||[];return _.filter(_.sortBy(_.uniq(_.pluck(a,"processorType"))))};e.Booking.statementText=function(a,b){var c=a.statementText,f=e.Booking.processorTypes(b);return _.map(f,function(a){return'"'+d.get(a).STATEMENT_TEXT_PREFIX+c+'"'}).join(" or ")};e.Booking.pendingStatementText=function(a){a=
e.Booking.processorTypes([a]);return _.map(a,function(a){return'"'+d.get(a).PENDING_STATEMENT_TEXT+'"'}).join(" or ")};e.Payment.isDefaultProcessorBasedType=function(a){return a.type===e.Payment.CC_TYPE&&a.processorType===d.DEFAULT_PROCESSOR_TYPE};e.Payment.isLegacyProcessorBasedType=function(a){return e.Payment.isProcessorBasedType(a)&&!e.Payment.isDefaultProcessorBasedType(a)};e.Payment.minimumChargeAmounts=c.slipstream("processorMinimumChargeAmounts");var m=e.Report;m.MODELS={};m.MODELS[e.Booking.cls]=
{name:T("Bookings"),singular:T("Booking"),slug:"bookings",model:e.Booking,submodels:[]};m.MODELS[e.Customer.cls]={name:T("Customers"),singular:T("Customer"),slug:"customers",model:e.Customer,submodels:[e.Booking]};m.MODELS[e.LineItem.cls]={name:T("Expenses and Discounts"),singular:T("Expense and discount"),slug:"expenses-and-discounts",model:e.LineItem,submodels:[e.Booking]};m.MODELS[e.CustomFieldValue.cls]={name:T("Custom Field Answers"),singular:T("Custom field answer"),slug:"custom-field-answers",
model:e.CustomFieldValue,submodels:[e.Customer,e.Booking]};m.MODELS[e.Payment.cls]={name:T("Sales"),singular:T("Sales"),slug:"payments-and-refunds",model:e.Payment,submodels:[e.Booking]};m.ORDERED_MODELS=[e.Payment,e.Booking,e.Customer,e.CustomFieldValue,e.LineItem];m.UNSOUND_AGGREGATES={Payment:[e.Booking],Booking:[],Customer:[e.Booking],CustomFieldValue:[e.Booking,e.Customer],LineItem:[e.Booking]};m.advancedUrl=function(a,b){return l.populate(l.dashboard.reports.advanced.index,{shortname:a.shortname,
modelSlug:m.MODELS[b].slug})};m.SWITCH_QUERY_PARAM_KEY="switch";m.advancedSwitchUrl=function(a,b){var d={};d[m.SWITCH_QUERY_PARAM_KEY]=!0;return g.compose(m.advancedUrl(a,b),d)};m.VALID_COLUMNS=c.slipstream("reports.validColumns");m.VALID_GROUPS=c.slipstream("reports.validGroups");m.VALID_FILTERS=c.slipstream("reports.validFilters");m.PROHIBITED_GROUPS=c.slipstream("reports.prohibitedGroups");m.PROHIBITED_HIGHER_GROUPS=c.slipstream("reports.prohibitedHigherGroups");m.ALWAYS_UNSOUND_GROUPINGS=c.slipstream("reports.alwaysUnsoundGroupings");
_.extend(m,c.slipstream("reports.allColumns"));_.extend(m,c.slipstream("reports.allGroups"));_.extend(m,c.slipstream("reports.allFilters"));_.extend(m,c.slipstream("reports.allDateRanges"));m.MODELS_BY_GROUP={};_.forEach(m.VALID_GROUPS,function(a,b){_.forEach(a,function(a){m.MODELS_BY_GROUP[a]=m.MODELS_BY_GROUP[a]||[];m.MODELS_BY_GROUP[a].push(e[b])})});a=e.ScheduleEntryRule;a.TYPE_CHOICES=_.reduce(c.slipstream("scheduleEntryRule.typeChoices"),function(a,b){a[b[0]]=b[1];return a},{});a.DATE_BASED_ON_BOOKING=
"booking";a.DATE_BASED_ON_AVAILABILITY="availability";a.DAY_OF_WEEK_BASED_ON_BOOKING="dow-booking";a.DAY_OF_WEEK_BASED_ON_AVAILABILITY="dow-availability";a.RULE_TYPES=[a.DATE_BASED_ON_BOOKING,a.DATE_BASED_ON_AVAILABILITY,a.DAY_OF_WEEK_BASED_ON_BOOKING,a.DAY_OF_WEEK_BASED_ON_AVAILABILITY];a.DATE_TYPES=[a.DATE_BASED_ON_BOOKING,a.DATE_BASED_ON_AVAILABILITY];a.DAY_OF_WEEK_TYPES=[a.DAY_OF_WEEK_BASED_ON_BOOKING,a.DAY_OF_WEEK_BASED_ON_AVAILABILITY];e.ResourceUse.OPTIONS=c.slipstream("resourceUse.options");
e.ResourceUse.OPTIONS_VALUES_KEYS_MAP=_.reduce(e.ResourceUse.OPTIONS,function(a,b){a[b.value]=b.key;return a},{});e.ResourceUse.OPTIONS_KEYS_DISPLAY_TEXT_MAP=_.reduce(e.ResourceUse.OPTIONS,function(a,b){a[b.key]=b.displayText;return a},{});e.ResourceUse.getUseSettings=function(a){var b;a.cls===e.ResourceRequirement.cls?b=[String(a.isSkipCreation),String(a.isIgnoreResourceOveruse)].join("-"):a.cls===e.Resource.cls?b=[String(a.isSkipResourceUseCreation),String(a.isIgnoreOveruse)].join("-"):console.error("invalid object passed to ResourceUse.getUseSettings");
return e.ResourceUse.OPTIONS_VALUES_KEYS_MAP[b]};e.ResourceUse.getDisplayText=function(a){a=e.ResourceUse.getUseSettings(a);return e.ResourceUse.OPTIONS_KEYS_DISPLAY_TEXT_MAP[a]};e.CustomReport.url=function(a){var b=m.advancedUrl(a.company,a.options.modelName),d={};d[e.CustomReport.QUERY_PARAM]=a[e.CustomReport.QUERY_PARAM_KEY];return g.compose(b,d)};e.SuggestedReport.url=function(a,b){var d=m.advancedUrl(b,a.options.modelName),c={};c[e.SuggestedReport.QUERY_PARAM]=a.slug;return g.compose(d,c)};e.Item.frontendUrl=
function(a,b){return b&&!a.isRetail?l.populate(l.company.item.month,{shortname:a.company.shortname,itemPk:a.pk,year:b.format("YYYY"),month:b.format("MM")}):a.$url(l.company.item.index)};e.FlowNode.frontendUrl=function(a,b){var d="";return d=a.externalUrl?a.externalUrl:a.item?e.Item.frontendUrl(a.item,b):a.$url(l.company.flowNode.index)};e.FlowNode.suggestedItemUrl=function(a,b){var d;d=a.item&&a.item.externalUrl&&!a.externalUrl?a.item.externalUrl:e.FlowNode.frontendUrl(a,b);var c={};a.type!==e.FlowNode.PAGE_TYPE&&
(c[e.FlowNode.FLOW_QUERY]=a.parent.pk);c[e.FlowNode.IS_SUGGESTED_QUERY]=!0;return g.compose(d,c,!0)};_.extend(e.CampaignValidityRule,c.slipstream("campaignValidityRules.allTypes"));if(f.isDebugging){e.Payment.isEmv=function(a){return a.type===e.Payment.CC_TYPE};e.Payment.isEmvSignatureRequired=function(a){return 0===a.pk%2};var k=e.Payment.emvDetails;e.Payment.emvDetails=function(a){a.metadata||(a.metadata={});a.metadata.emvDetails=f.debugDetails;return k(a)}}e.SupportedLanguage.DISPLAY_LANGUAGES=
c.slipstream("displayLanguages");e.SupportedLanguage.LANGUAGE_CODES_SORTED=c.slipstream("languageCodesSorted");e.Translation.translationOverlayUrl=function(a,b,d,c,f){b={shortname:d,objectType:b.cls,objectId:b.pk,objectField:e.Translation.fieldNameForUrl(a)};a="";f?(b.subfield=e.Translation.fieldNameForUrl(f),a=l.populate(l.dashboard.translationsOverlay.forSubfield,b)):a=l.populate(l.dashboard.translationsOverlay.forField,b);f={};f[e.SupportedLanguage.SCROLL_TO_LANGUAGE_PARAM]=c;return g.compose(a,
f)};e.Seat.editUrl=function(a,b){return l.populate(l.dashboard.settings.seating.seatMap.layout.seats,{shortname:b.company.shortname,seatMapPk:b.pk,seatPks:_.isString(a)?a:_.pluck(a,"pk").join(",")})};e.Seat.duplicateUrl=function(a,b){return l.populate(l.dashboard.settings.seating.seatMap.layout.duplicate,{shortname:b.company.shortname,seatMapPk:b.pk,seatPks:_.isString(a)?a:_.pluck(a,"pk").join(",")})};e.Seat.createUrl=function(a,b,d){return l.populate(l.dashboard.settings.seating.seatMap.layout.new,
{shortname:d.company.shortname,seatMapPk:d.seatMap.pk,seatGroupPk:d.pk,xCoord:a,yCoord:b})}}])})();angular.module("auth",["auth.controllers","auth.directives","auth.services"]);
(function(){var h=angular.module("auth.controllers",["lib","navigation"]);h.controller("auth.LoginProviderErrorCtrl",["$scope","navigation",function(b,a){var c=a.get("status")||"",f=a.get("message")||T("Unable to log in via single sign-on.");a.clear("status",!0);a.clear("message",!0);b.errorMessage="";"error"===c&&(b.errorMessage=f)}]);h.controller("auth.LoginCtrl",["$scope","navigation","urls",function(b,a,c){var f=a.get("shortname")||"";b.credentials={shortname:f};var e=a.get("next");b.submit=function(f){b.credentials.shortname&&
(f=c.populate(c.company.login,{shortname:b.credentials.shortname.replace(/\s+/g,"").toLowerCase()}),e&&(f=a.compose(f,{next:e})),a.navigate(f))}}]);h.controller("auth.CompanyLoginCtrl",["$scope","auth","db","navigation","urls",function(b,a,c,f,e){var g=f.currentCompany?f.currentCompany.shortname:"",d=f.get("username")||"";f.clear("username",!0);b.credentials={shortname:g,username:d,password:""};b.isForceReloadingAfterSuccess=!1;var l=f.get("next"),d="yes"===f.get("require");!d&&a.currentUser.isAuthenticated&&
g===a.currentUser.company.shortname?(f.redirect(l||a.currentUser.company.$url(e.dashboard.index),"replace"),b.isForceReloadingAfterSuccess=!0):(b.differentCompanyLoginUrl=e.root.login,l&&(g={next:l},d&&(g.require="yes"),b.differentCompanyLoginUrl=f.compose(b.differentCompanyLoginUrl,g)),b.submit=function(d){a.login(b.credentials,d).then(function(){var d=l||a.currentUser.company.$url(e.dashboard.index);b.isForceReloadingAfterSuccess=(c.slipstream("targetLanguage")||"")!==b.company.language;f.navigate(d,
null,b.isForceReloadingAfterSuccess)},function(){b.credentials.password=""})},b.providerLogin=function(){b.isForceReloadingAfterSuccess=!0;var a=f.currentCompany.$url(e.api.providerLogin);l&&(a=f.compose(a,{next:l}));f.navigate(a,"extend",!0)},b.LOGIN_PROVIDER_OPTION="login-provider",b.FAREHARBOR_OPTION="fareharbor",b.isShowingLoginOptions=f.currentCompany.features.isLoginProviderEnabled&&!f.currentCompany.features.isLoginProviderRequired,b.currentLoginOption=b.isShowingLoginOptions?"":!f.currentCompany.features.isLoginProviderEnabled?
b.FAREHARBOR_OPTION:b.LOGIN_PROVIDER_OPTION,b.selectLoginOption=function(a){b.currentLoginOption=a||""})}]);h.controller("auth.ForgotPasswordCtrl",["$scope","db","flash","navigation","urls",function(b,a,c,f,e){var g=f.get("shortname")||"";f.clear("shortname",!0);var d=f.get("username")||"";f.clear("username",!0);b.alreadyHasCompany=!!g;b.credentials={shortname:g,username:d};b.submit=function(d){a.forgot.password({},b.credentials,d).$promise.then(function(){c.success(T("An email has been sent to the address associated with this account."));
f.navigate(e.root.login)})}}]);h.controller("auth.ResetPasswordCtrl",["$scope","db","flash","navigation","urls",function(b,a,c,f,e){var g=f.get("shortname")||"";f.clear("shortname",!0);var d=f.get("username")||"";f.clear("username",!0);var l=f.get("token")||"";f.clear("token",!0);!g||!d||!l?(c.error(T("Bad password reset link")),f.navigate(e.root.login)):(b.credentials={token:l,username:d,shortname:g,password:""},b.submit=function(d){a.forgot.password.reset({},b.credentials,d).$promise.then(function(){c.success(T("Your password has been changed. Please log in."));
var a=e.populate(e.company.login,{shortname:g}),a=a+("?username="+b.credentials.username);f.navigate(a)})})}]);h.controller("auth.ForgotCredentialsCtrl",["$scope","db","flash","navigation","urls",function(b,a,c,f,e){b.credentials={email:""};b.submit=function(g){var d=b.credentials.email;a.forgot.credentials({},b.credentials,g).$promise.then(function(){c.success(T("We emailed you at")+" <b>"+d+"</b>.");f.navigate(e.root.login)})}}])})();
(function(){angular.module("auth.directives",[]).config(["$compileProvider","d",function(h,b){var a=function(a,c){if(!c.parse||!c.permission)throw Error("auth: "+a+": invalid directive definition");return h.directive(a,b.conditionalDirective({name:a,watch:["$injector","$parse","auth",function(g,d,l){var m=b.safeInvoke(g,c.permission),k=b.safeInvoke(g,c.parse);return function(b,c,e){var g=k(e),l=e.ngCanOnlyWhen?d(e.ngCanOnlyWhen):_.always,h=e.ngCanAlsoWhen?d(e.ngCanAlsoWhen):_.never,y=!e.ngCanOnce||
b.$eval(e.ngCanOnce),q,B=!0;return function(){try{if(h(b))return!0;if(!l(b))return!1;var d;y&&!B?d=q:(d=q=m(g(b)),B=!1);return d}catch(c){throw console.error("auth: "+a+": error checking permission for arguments: "+e[a]),c;}}}}],once:function(a,b,c){return!c.ngCanOnlyWhen&&!c.ngCanAlsoWhen&&(!c.ngCanOnce||a.$eval(c.ngCanOnce))},operator:function(a,b,c){return function(b){c.ngThen&&(a[c.ngThen]=b);return b}}}))},c=function(b,c){return a(b,{parse:["$parse",function(a){return function(d){return a(d[b])}}],
permission:["auth",function(a){return function(b){return a.permissions.can(c.permission,b)}}]})};c("ngCanView",{permission:"view"});c("ngCanUpdate",{permission:"update"});c("ngCanRemove",{permission:"remove"});c("ngCanAdminView",{permission:"adminView"});c("ngCanAdminUpdate",{permission:"adminUpdate"});c("ngCanViewAmounts",{permission:"viewAmounts"});c("ngCanViewDashboardSection",{permission:"viewDashboardSection"});c("ngCanViewAdminSection",{permission:"viewAdminSection"});c("ngCanViewManifestSection",
{permission:"viewManifestSection"});c("ngCanViewInvoiceAmounts",{permission:"viewInvoiceAmounts"});c=function(b,c){return a(b,{parse:["$parse",function(a){return function(d){d=d[b].match(/^\s*([\s\S]+)\s+on\s+([\s\S]+)\s*$/);if(!d)throw Error("auth: "+b+": expected expression of the form '_type_ on _object_'");var c=d[1],e=a(d[2]);return function(a){return{cls:c,owner:e(a)}}}}],permission:["auth",function(a){return function(b){return a.permissions.can(c.permission,b.cls,b.owner)}}]})};c("ngCanCreate",
{permission:"create"});c("ngCanList",{permission:"list"});c("ngCanClear",{permission:"update"});c("ngCanAdminCreate",{permission:"adminCreate"});c("ngCanAdminList",{permission:"adminList"});a("ngCan",{parse:["$parse",function(a){return function(b){var c=b.ngCan.match(/^\s*([\s\S]+)\s+on\s+([\s\S]+)\s*$/);b=b.ngCan.match(/^\s*([\s\S]+)\s+on\s+([\s\S]+)\s+with\s+([\s\S]+)\s*$/);if(!c&&!b)throw Error("auth: ng-can: expected expression of the form '_type_ on _object_' or '_type_ on _model_ with _object_'");
var d=c[1],l=_.never,m=_.never;b?(l=a(b[2]),m=a(b[3])):m=a(c[2]);return function(a){return{permission:d,object:m(a),cls:l(a)}}}}],permission:["auth",function(a){return function(b){return!b.cls?a.permissions.can(b.permission,b.object):a.permissions.can(b.permission,b.cls,b.object)}}]});a("ngCanAny",{parse:["$parse",function(a){return function(b){var c=a(b.ngCanAny),d,l;b.ngCanAnyWith?(d=a(b.ngCanAnyOn),l=a(b.ngCanAnyWith)):(d=_.never,l=a(b.ngCanAnyOn));return function(a){return{permissions:c(a),object:l(a),
cls:d(a)}}}}],permission:["auth",function(a){return function(b){return!b.cls?_.any(b.permissions,function(c){return a.permissions.can(c,b.object)}):_.any(b.permissions,function(c){return a.permissions.can(c,b.cls,b.object)})}}]})}])})();
(function(){var h=angular.module("auth.services",["db.services","lib.services","urls.services"]);h.factory("auth",["$http","$injector","$rootScope","convert","db","events","models","sessionStorage","storage","urls",function(b,a,c,f,e,g,d,l,m,k){var n=["z","hmleigh"],h=["canUpdateOnlyFutureBookings","canViewOnlyCrewedAvailabilities"],p=["canView","canList"],r=e.slipstream("isReadonlyEnabled"),t={isAuthenticated:!1};a={};var v=function(a){var b=L.currentUser;return(a=a||b.company)&&b.isAuthenticated&&
b.company&&b.company===a},y=function(){var a=L.currentUser;return a.isAuthenticated&&a.company&&a.company.isAdmin},q=function(a){return a.affiliation&&a.affiliation.affiliateCompany===L.currentUser.company},B=function(a,b){var d=a.conditions.maxCompanyTier;if(_.isNumber(d)){var c=b.features?b.features.tier:null;if(!_.isNumber(c)||c>d)return!1}return!0},u={},z={};f=function(){z={}};g.on(c,"auth.login",f);g.on(c,"auth.logout",f);g.on(c,"auth.clearEffectiveGroupCache",f);var C=function(a,b){var d,c;
if(L.currentUser.company===b)d=L.currentUser.group;else if(L.currentUser.company.isAdmin)(d=L.currentUser.adminGroup)&&!B(d,b)&&(d=null);else if(L.currentUser.company.isAffiliate){var e=_.findWhere(L.currentUser.company.partners,{company:b});L.currentUser.partnerGroup&&(e&&e.affiliateGroup)&&(c={groupPermissions:_.omit(e.affiliateGroup.groupPermissions,function(a,b){return!(a&&_.get(L.currentUser.partnerGroup.groupPermissions,b,!1))})},_.forEach(h,function(a){if(e.affiliateGroup.groupPermissions[a]||
L.currentUser.partnerGroup.groupPermissions[a])c.groupPermissions[a]=!0}))}if(!d){var f=_.findWhere(L.currentUser.relatedGroupOverrides,{company:b});f||(f=_.findWhere(L.currentUser.company.relatedGroupOverrides,{company:b,relatedUser:null}));f&&(d=f.group||L.currentUser.group)}if(d=d||c)return d;console.warn("auth: user with no effective group",L.currentUser,a,b)},F=function(a){if(!a)throw console.error("auth: invalid permission",this,a,this.cls),Error("auth: invalid permission");a="can"+_.capitalize(a);
if(K.call(this,a)){var b=u[this.cls][a];return!b?(console.error("auth: invalid permission configuration",this,a,u,b),!1):M.call(this,b)}return!1},x=function(a){var b,c,e;if(2===arguments.length)c=(b=arguments[1])?b.cls:"",e=d.Company.forObject(b);else if(3===arguments.length){b=null;if((c=arguments[1])&&!_.isString(c))c=c.cls;e=arguments[2]}else console.error("auth: invalid arguments when checking permission",arguments);if(_.isUndefined(b))throw console.error("auth: invalid object when checking permission",
a,b),Error("auth: invalid object when checking permission "+a);if(!c)throw console.error("auth: invalid class when checking permission",a,c,e),Error("auth: invalid class when checking permission "+a);if(!e)throw console.error("auth: invalid owner when checking permission",a,c,e),Error("auth: invalid owner when checking permission "+a);var f=d.Company.forObject(e);if(!f)throw console.error("auth: invalid company when checking permission",a,c,e,b),Error("auth: invalid company when checking permission "+
a);var g;g=b;var k=f;if(L.currentUser.isAuthenticated){var m=k.uri,l=z[m];_.isUndefined(l)&&(l=C(g,k),z[m]=l);g=l}else g=void 0;b={company:f,instance:b,owner:e,cls:c,group:g,permissions:g?g.groupPermissions:{},can:F};f!==e&&(b[_.uncapitalize(e.cls)]=e);(c=u[c].init)&&c.call(b);return F.call(b,a)};c=function(a){return function(){var b=_.toArray(arguments);b.unshift(a);return x.apply(this,b)}};a.canView=c("view");a.canUpdate=c("update");a.canRemove=c("remove");a.canAdminView=c("adminView");a.canAdminUpdate=
c("adminUpdate");a.canCreate=c("create");a.canList=c("list");a.canAdminCreate=c("adminCreate");a.canAdminList=c("adminList");a.can=x;var w=function(a,b,d){b=b||!1;d=_.isUndefined(d)?b:d;a=_.capitalize(a);var c="canView"+a,e="canEdit"+a,f="canEditPrivateProperties"+a;a="canViewPrivateProperties"+a;return{canView:function(){return b?!0:this.permissions[c]},canList:function(){return d?!0:this.permissions[c]},canCreate:e,canUpdate:e,canRemove:e,canClear:e,canAdminUpdate:f,canAdminCreate:f,canAdminView:a,
canAdminList:a}},G=function(a,b){if(!this||!this.permissions)throw console.error("auth: this context needed to check canUpdatePastBooking",this),Error("auth: this context needed");a=a||this.booking;if(!a)throw console.error("auth: booking reference needed to check canUpdatePastBooking",this),Error("auth: booking reference needed");return b&&a.availability.company.features.isLimitedPastBookingUpdatesEnabled||!this.permissions.canUpdateOnlyFutureBookings||!d.Availability.isInPast(a.availability)};c=
function(a,b){b=b||{};var d=b.field||"booking";a=_.capitalize(a);var c=b.permissionOverrides||{},e=_.isUndefined(b.checkPastBooking)?!0:b.checkPastBooking,f=b.isLimitedPastBookingUpdate||!1,g=c.canView||"canView"+a,k=c.canList||"canView"+a,m=c.canCreate||"canEdit"+a,l=c.canUpdate||"canEdit"+a,n=c.canRemove||"canEdit"+a;return _.extend(w(a,b.canAlwaysView,b.canAlwaysList),{init:function(){this.instance&&(this.booking=_.getDotted(this.instance,d))},canView:function(){return!this.group?!0:!x("view",
this.booking)?!1:this.permissions[g]},canList:function(){return!this.group?!0:!x("view",this.booking)?!1:this.permissions[k]},canCreate:function(){return!x("update",this.booking)||this.booking&&e&&!G.call(this,this.booking,f)?!1:this.permissions[m]},canUpdate:function(){return!x("update",this.booking)||e&&!G.call(this,this.booking,f)?!1:this.permissions[l]},canRemove:function(){return!x("update",this.booking)||e&&!G.call(this,this.booking,f)?!1:this.permissions[n]}})};var M=function(a){if(_.isFunction(a))return a.apply(this);
if(_.isString(a))return this.permissions[a]||!1},K=function(a){return r&&!_.find(p,function(b){return 0===a.indexOf(b)})?!1:!0};f=function(a,b){return function(){a=_.isArray(a)?a:[a];var d=!0,c=_.clone(this);c.cls=c.company.cls;if(!K.call(this,b))return!1;_.forEach(a,function(a){if(!c.can(a)||!K.call(this,a))return d=!1});return d&&M.call(this,b)}};u[d.Company.cls]=w("company",!0);u[d.Company.cls].canCreate=function(){return!y()?!1:this.permissions.canEditCompanies};u[d.Company.cls].canRemove=function(){return this.instance===
L.currentUser.company?!1:this.can("create")};u[d.Company.cls].canUpdateCompanyWebsite="canEditCompany";u[d.Company.cls].canUpdateCompanyPayments=f("viewAmounts","canEditAccounting");u[d.Company.cls].canEditAccounting=f("viewAmounts","canEditAccounting");u[d.Company.cls].canEditTransportation="canEditTransportation";u[d.Company.cls].canDuplicateAcrossCompanies=function(){return L.currentUser.company.isAdmin&&this.permissions.canEditTransportation};u[d.Company.cls].canViewAmounts=function(){return!this.group&&
!L.currentUser.isAuthenticated?!0:this.permissions.canViewAmounts};u[d.Company.cls].canViewInvoiceAmounts="canViewInvoiceAmounts";u[d.Company.cls].canViewPricing=f("viewAmounts","canViewSheets");u[d.Company.cls].canUpdatePricing=f("viewAmounts","canEditPricing");u[d.Company.cls].canViewAdminSection=function(){return!L.currentUser.isAuthenticated?!1:L.currentUser.company.isAdmin&&this.permissions.canViewAdminSection};u[d.Company.cls].canViewDashboardSection="canViewDashboardSection";u[d.Company.cls].canViewItemsSection=
"canViewItemsSection";u[d.Company.cls].canViewSettingsSection="canViewSettingsSection";u[d.Company.cls].canViewBookingsSection="canViewBookingsSection";u[d.Company.cls].canViewManifestSection="canViewManifestSection";u[d.Company.cls].canViewReports="canViewReports";u[d.Company.cls].canViewNetworkSettings="canViewNetworkSettings";u[d.Company.cls].canCancel=function(){return this.permissions.canCancelBookings};u[d.Company.cls].canCancelEligible=function(){return this.permissions.canCancelEligibleBookings};
u[d.Company.cls].canEditSheets="canEditSheets";u[d.TagGroup.cls]=w("tags",!0);var H=function(){return!y()||!this.company.isAdmin?!1:this.permissions.canEditTags};u[d.TagGroup.cls].canCreate=H;u[d.TagGroup.cls].canUpdate=H;u[d.TagGroup.cls].canRemove=H;u[d.Tag.cls]=u[d.TagGroup.cls];u[d.TagInstance.cls]=w("tagInstances",!0);H=function(){return!y()||!x("update",this.owner)?!1:this.permissions.canEditTagInstances};u[d.TagInstance.cls].canCreate=H;u[d.TagInstance.cls].canUpdate=H;u[d.TagInstance.cls].canRemove=
H;u[d.CustomManifest.cls]=w("customManifests");u[d.CustomCalendar.cls]=w("customCalendars");u[d.CustomReport.cls]=w("customReports");u[d.Role.cls]=w("roles");u[d.CrewMember.cls]=w("crewMembers");u[d.CrewMember.cls].canCreateSelfAssignable="canEditCrewMembersSelfAssignable";u[d.CrewMember.cls].canUpdate=function(){return this.permissions.canEditCrewMembers?!0:this.instance.user===L.currentUser?this.permissions.canEditCrewMembersSelfAssignable:!1};u[d.CrewMember.cls].canRemove=function(){return this.permissions.canEditCrewMembers?
!0:this.instance.user===L.currentUser?this.permissions.canEditCrewMembersSelfAssignable:!1};u[d.CrewMember.cls].canCreate=function(){return this.permissions.canEditCrewMembers};u[d.Group.cls]=w("groups");u[d.GroupOverride.cls]=w("groups");u[d.User.cls]=w("users",!0);u[d.User.cls].canUpdate=function(){return this.instance===L.currentUser?!0:this.permissions.canEditUsers};u[d.User.cls].canRemove=function(){return this.instance==L.currentUser?!1:this.permissions.canEditUsers};u[d.Agent.cls]=w("agents",
!0);u[d.Agent.cls].canCreate=function(){return this.permissions.canEditAgents?!0:!this.affiliation?!1:v(this.affiliation.affiliateCompany)?x("create",d.Agent,this.affiliation.affiliateCompany):!1};u[d.Desk.cls]=w("desks",!0);u[d.Desk.cls].canCreate=function(){if(this.permissions.canEditDesks)return!0;if(!this.affiliation)return!1;if(v(this.affiliation.affiliateCompany))return x("create",d.Desk,this.affiliation.affiliateCompany)};u[d.Affiliation.cls]=w("network");u[d.Affiliation.cls].canView=function(){return this.permissions.canViewNetwork?
!0:!this.instance?!1:x("view",d.Affiliation,this.instance.affiliateCompany)};u[d.Affiliation.cls].canRemove=function(){return this.permissions.canEditNetwork?!0:!this.instance?!1:x("remove",d.Affiliation,this.instance.affiliateCompany)};u[d.CannedMessage.cls]=w("cannedMessages");u[d.CannedMessage.cls].canListAssociatedItems="canListAssociatedItems";u[d.Item.cls]=w("items",!0);u[d.Item.cls].canView=function(){return!this.instance.isPrivate||this.permissions.canViewItems};u[d.Item.cls].canViewPrivate=
"canViewPrivateItems";u[d.FlowNode.cls]=w("flowNodes",!0);u[d.Image.cls]=w("images",!0);u[d.CustomField.cls]=w("customFields",!0);u[d.CustomField.cls].canListAssociatedItems="canListAssociatedItems";u[d.CustomField.cls].canSkipRecipientName=function(){return!!this.group};u[d.CustomField.cls].canViewPrivate="canViewPrivateCustomFields";u[d.ExtendedOption.cls]=w("customFields",!0);u[d.TransportationOption.cls]=w("customFields",!0);u[d.ConnectedCampaign.cls]=w("customFields",!0,!1);u[d.ConnectedWaiver.cls]=
w("customFields",!0,!1);u[d.GeneratingCampaign.cls]=w("customFields",!0);u[d.CustomFieldInstance.cls]=w("customFields",!0);u[d.CustomFieldInstanceCondition.cls]=w("customFields",!0);u[d.CustomFieldInstanceGroup.cls]=w("customFields",!0);u[d.Availability.cls]=w("availabilities",!0);u[d.Availability.cls].canCreate=function(){return this.permissions.canViewOnlyCrewedAvailabilities?!1:this.permissions.canCreateAvailabilities};u[d.Availability.cls].canOveruseResources="canOveruseResources";u[d.Availability.cls].canBookClosed=
"canBookClosedAvailabilities";u[d.Availability.cls].canOverbook="canOverbookAvailabilities";u[d.Availability.cls].canBookUnbookable=function(){return this.permissions.canOveruseResources||this.permissions.canBookClosed||this.permissions.canOverbook};u[d.Availability.cls].canUpdateMultiple=function(){return this.permissions.canViewOnlyCrewedAvailabilities?!1:this.permissions.canEditMultipleAvailabilities};u[d.Availability.cls].canViewCapacities="canViewAvailabilityCapacities";u[d.Availability.cls].canReportOn=
"canViewAvailabilities";u[d.Availability.cls].canViewOnlyCrewed="canViewOnlyCrewedAvailabilities";u[d.CustomerType.cls]=w("customerTypes",!0);u[d.CustomerType.cls].canListAssociatedItems="canListAssociatedItems";u[d.CheckinStatus.cls]=w("checkinStatuses");u[d.Campaign.cls]=w("campaigns",!0);u[d.Code.cls]=w("codes");u[d.CampaignValidityRule.cls]=w("campaigns",!0);u[d.StoredValueType.cls]=w("storedValueCards");u[d.StoredValueCard.cls]=w("storedValueCards",!0,!1);u[d.StoredValueAdjustment.cls]=w("storedValueCards",
!0);u[d.Fund.cls]=function(a){a="canView"+_.capitalize(a);return{canView:a,canList:a,canCreate:_.never,canUpdate:_.never,canRemove:_.never}}("accounting");u[d.Fund.cls].canView=u[d.Fund.cls].canList=function(){return!y()?!1:this.permissions.canViewAccounting};u[d.Transaction.cls]=u[d.Fund.cls];u[d.Contact.cls]=w("contacts",!0);u[d.InStorePaymentType.cls]=w("inStorePaymentTypes");u[d.EmvDevice.cls]=w("emvDevices");u[d.EmvDevice.cls].canView=u[d.EmvDevice.cls].canList=function(){return this.permissions.canCreateCreditCardPayments};
u[d.EmvDevice.cls].canCreate=u[d.EmvDevice.cls].canRemove=u[d.EmvDevice.cls].canUpdate=function(){return this.permissions.canEditAccounting};u[d.BankAccount.cls]=w("bankAccounts");u[d.BankAccount.cls].canCreate=function(){return this.permissions.canEditAccounting};u[d.BankAccount.cls].canRemove=function(){return this.permissions.canEditAccounting};u[d.BankAccount.cls].canUpdate=function(){return this.permissions.canEditAccounting};u[d.Card.cls]=w("cards",!0);u[d.Card.cls].canCreate=function(){return this.permissions.canViewCards&&
this.permissions.canEditAccounting};u[d.Card.cls].canRemove=function(){return this.permissions.canViewCards&&this.permissions.canEditAccounting};u[d.Card.cls].canUpdate=function(){return this.permissions.canViewCards&&this.permissions.canEditAccounting};u[d.CardAffiliation.cls]=w("cards",!0);u[d.CardAffiliation.cls].canCreate=function(){return this.permissions.canViewCards&&this.permissions.canEditAccounting};u[d.CardAffiliation.cls].canRemove=function(){return this.permissions.canViewCards&&this.permissions.canEditAccounting};
u[d.CardAffiliation.cls].canUpdate=function(){return this.permissions.canViewCards&&this.permissions.canEditAccounting};u[d.Account.cls]=w("accounting");u[d.Payout.cls]=w("accounting");u[d.Payout.cls].canRetry=function(){return y()&&this.can("adminUpdate")};u[d.Transfer.cls]=w("accounting");u[d.Adjustment.cls]=w("accounting");u[d.Adjustment.cls].canCreate=function(){return!y()?!1:this.permissions.canEditAccounting};u[d.Adjustment.cls].canUpdate=_.never;u[d.Adjustment.cls].canRemove=_.never;u[d.Invoice.cls]=
w("invoices");u[d.InvoiceEntry.cls]=w("invoices");u[d.Upload.cls]=w("accounting");u[d.Upload.cls].canCreateDirectType=function(){return!this.permissions.canEditAccounting?!1:this.permissions.canCreateDirectUploads};u[d.Hotel.cls]=w("hotels",!0);u[d.Hotel.cls].canCreate=function(){return!y()?!1:this.permissions.canEditHotels};u[d.Hotel.cls].canUpdate=u[d.Hotel.cls].canCreate;u[d.Hotel.cls].canRemove=u[d.Hotel.cls].canCreate;u[d.Lodging.cls]=w("transportation",!0);u[d.Pickup.cls]=w("transportation",
!0);u[d.PreferredPickup.cls]=w("transportation",!0);u[d.Route.cls]=w("transportation",!0);u[d.Route.cls].canListAssociatedItems="canListAssociatedItems";u[d.Run.cls]=w("transportation",!0);u[d.Stop.cls]=w("transportation",!0);u[d.Activity.cls]=w("activities");u[d.Activity.cls].canCreate="canEditActivities";u[d.Activity.cls].canView=function(){return d.Activity.isAdminOnly(this.instance)?y():!0};u[d.Activity.cls].canToggleAdminOnlyStatus=function(){return!y()||this.instance.object&&this.instance.object.cls===
d.Activity.cls||d.Activity.isAdminOnly(this.instance)&&!this.instance.context.adminOnlyOriginalType?!1:this.can("update")};u[d.Activity.cls].canCreateNoteOnActivity=function(){return!y()||this.instance.object&&this.instance.object.cls===d.Activity.cls?!1:this.can("create")};u[d.Activity.cls].canList=function(){return this.permissions.canViewActivities||this.permissions.canViewActivitiesSelf};u[d.Activity.cls].canListFeed=function(){return this.permissions.canViewActivitiesFeed};u[d.Waiver.cls]=w("waivers",
!0);u[d.WaiverInstance.cls]=c("waiverInstances");u[d.CustomerPrototype.cls]=w("customFields",!0);u[d.CustomerPrototype.cls].canCreate=function(){return!x("updatePricing",this.company)?!1:this.permissions.canEditCustomFields};u[d.CustomerTypeRate.cls]=w("availabilities",!0);u[d.Block.cls]=w("blocks");u[d.TotalSchedule.cls]=w("sheets");u[d.InvoiceSchedule.cls]=w("sheets");u[d.TotalScheduleEntry.cls]=w("sheets");u[d.InvoiceScheduleEntry.cls]=w("sheets");u[d.TotalScheduleEntryRule.cls]=w("sheets");u[d.InvoiceScheduleEntryRule.cls]=
w("sheets");u[d.TotalSheet.cls]=w("sheets");u[d.TotalSheet.cls].canView=_.always;u[d.TotalSheet.cls].canReportOn=function(){return this.can("list")};u[d.InvoiceSheet.cls]=w("sheets");u[d.InvoiceSheet.cls].canView=_.always;u[d.InvoiceSheet.cls].canReportOn=function(){return this.can("list")};u[d.TotalLine.cls]=w("sheets");u[d.TotalLine.cls].canView=_.always;u[d.TotalLine.cls].canCreate="canEditPricing";u[d.TotalLine.cls].canUpdate="canEditPricing";u[d.TotalLine.cls].canRemove="canEditPricing";u[d.InvoiceLine.cls]=
w("sheets");u[d.InvoiceLine.cls].canView=_.always;u[d.InvoiceLine.cls].canCreate="canEditPricing";u[d.InvoiceLine.cls].canUpdate="canEditPricing";u[d.InvoiceLine.cls].canRemove="canEditPricing";u[d.TaxType.cls]=w("accounting");u[d.Subscription.cls]=w("users");u[d.Notification.cls]=c("notifications",{checkPastBooking:!1});u[d.Notification.cls].canCreate=_.super(u[d.Notification.cls].canCreate,function(){return!this.booking?this.permissions.canEditNotifications:this.super()});u[d.Notification.cls].canCreateDisputeType=
function(){return!y()?!1:this.can("create",this.booking)};u[d.SmsNotification.cls]=c("smsNotifications",{checkPastBooking:!1});u[d.SmsNotification.cls].canCreate=function(){return this.company.isSmsEnabled&&this.permissions.canEditSmsNotifications&&(this.booking?x("update",this.booking):!0)};u[d.ReviewExpressNotification.cls]=c("reviewExpress",{checkPastBooking:!1});u[d.Order.cls]=w("orders");u[d.Booking.cls]=w("bookings");u[d.Booking.cls].canSkipPayment="canSkipPayment";u[d.Booking.cls].canBookHiddenFields=
"canBookHiddenFields";u[d.Booking.cls].canViewAffiliateBookings="canViewAffiliateBookings";u[d.Booking.cls].canOverrideTransportation="canOverrideTransportation";u[d.Booking.cls].canUpdateOnlyFutureBookings="canUpdateOnlyFutureBookings";u[d.Booking.cls].canCreate=function(){return!this.group&&!L.currentUser.isAuthenticated?!0:this.permissions.canCreateBookings};u[d.Booking.cls].canUpdate=function(){return this.permissions.canEditBookings?!0:q(this.instance)};u[d.Booking.cls].canUpdateExplicitTotal=
function(){return!this.permissions.canViewAmounts||this.instance&&!this.can("update")||this.instance&&!G.call(this,this.instance)?!1:this.permissions.canEditBookingExplicitTotals};u[d.Booking.cls].canUpdateExplicitInvoicePrice=function(){return!this.permissions.canViewInvoiceAmounts||this.instance&&!this.can("update")||this.instance&&!G.call(this,this.instance)?!1:this.permissions.canEditBookingExplicitInvoicePrices};u[d.Booking.cls].canViewBookingNote="canViewBookingNotes";u[d.Booking.cls].canUpdateBookingNote=
function(){return!this.can("viewBookingNote")||this.instance&&!G.call(this,this.instance)?!1:this.permissions.canEditBookingNotes};u[d.Booking.cls].canUpdateBookingAffiliations=function(){return!this.can("update")||!G.call(this,this.instance)?!1:this.permissions.canEditBookingAffiliations};u[d.Booking.cls].canUpdateBookingAffiliationInfo=function(){return!this.can("update")||!G.call(this,this.instance)?!1:this.permissions.canEditBookingAffiliationInfo};u[d.Booking.cls].canView=function(){return!this.group||
this.permissions.canViewBookings?!0:q(this.instance)};u[d.Booking.cls].canCancel=function(){return this.can("update")&&this.permissions.canCancelBookings&&G.call(this,this.instance)};u[d.Booking.cls].canCancelEligible=function(){return!this.can("update")||!d.Booking.isEligibleForCancellation(this.instance,L.currentUser)||!G.call(this,this.instance)?!1:this.permissions.canCancelEligibleBookings};u[d.Booking.cls].canRebook=function(){return!this.can("cancel")?!1:this.can("create")};u[d.Booking.cls].canRebookEligible=
function(){return!this.can("cancelEligible")||!d.Booking.isEligibleForRebook(this.instance,L.currentUser)?!1:this.can("create")};u[d.Booking.cls].canEditCustomFieldValues=function(){return this.can("update")&&this.permissions.canEditCustomFieldValues&&G.call(this,this.instance,!0)};u[d.Booking.cls].canChangePriceSheets=function(){return!this.permissions.canViewAmounts||this.instance&&!G.call(this,this.instance)?!1:this.permissions.canChangePriceSheets};u[d.Booking.cls].canReapplyResourceUses=function(){return!G.call(this,
this.instance)?!1:this.permissions.canOveruseResources};u[d.Booking.cls].canCreateCustomRefunds=function(){return!this.permissions.canViewAmounts||!G.call(this,this.instance,!0)?!1:this.permissions.canCreateCustomRefunds};u[d.Customer.cls]=c("customers");u[d.Customer.cls].canViewCheckinStatus=function(){return!this.booking?this.permissions.canViewCustomerCheckinStatus:this.can("view")&&this.permissions.canViewCustomerCheckinStatus};u[d.Customer.cls].canUpdateCheckinStatus=function(){return x("update",
this.booking)&&this.permissions.canEditCustomerCheckinStatus&&G.call(this)};u[d.BookingCustomFieldValue.cls]=c("customFieldValues",{isLimitedPastBookingUpdate:!0});u[d.CustomerCustomFieldValue.cls]=c("customFieldValues",{isLimitedPastBookingUpdate:!0});u[d.BookingCustomFieldValue.cls].canUpdate=function(){return this.permissions.canEditCustomFieldValues&&G.call(this,this.booking,!0)};u[d.CustomerCustomFieldValue.cls].canUpdate=function(){return this.permissions.canEditCustomFieldValues&&G.call(this,
this.booking,!0)};u[d.Refund.cls]=c("refunds",{isLimitedPastBookingUpdate:!0});u[d.Refund.cls]=c("refunds",{isLimitedPastBookingUpdate:!0});u[d.Refund.cls].canUpdate=f("viewAmounts",u[d.Refund.cls].canUpdate);u[d.Refund.cls].canCreate=f("viewAmounts",u[d.Refund.cls].canCreate);u[d.LineItem.cls]=c("lineItems",{isLimitedPastBookingUpdate:!0});u[d.LineItem.cls].canUpdate=f("viewAmounts",u[d.LineItem.cls].canUpdate);u[d.LineItem.cls].canCreate=f("viewAmounts",u[d.LineItem.cls].canCreate);u[d.LineItem.cls].canRemove=
f("viewAmounts",u[d.LineItem.cls].canRemove);u[d.LineItem.cls].canReportOn=function(){return this.permissions.canViewLineItems};u[d.Payment.cls]=c("payments",{isLimitedPastBookingUpdate:!0});u[d.Payment.cls].canCreatePartial=f("viewAmounts","canSkipPayment");u[d.Payment.cls].canCreateWithoutCVC=function(){return y()||this.permissions.canCreateCreditCardPaymentsWithoutCvv};u[d.Payment.cls].canCreateWithoutCardholdersName="canSkipCardholderInfo";u[d.Payment.cls].canCreateWithoutPostalCode="canSkipPostalCode";
u[d.Payment.cls].canCreateWithoutCountryCode="canSkipPostalCode";u[d.Payment.cls].canCreateCreditCard=f("viewAmounts","canCreateCreditCardPayments");u[d.Payment.cls].canCreateInStore=f("viewAmounts","canCreateInStorePayments");u[d.Payment.cls].canCreateStoredValueCard=f("viewAmounts","canCreateStoredValueCardPayments");u[d.Payment.cls].canCreateDeferred="canCreateDeferredPayments";u[d.Payment.cls].canCreateAffiliate=function(){return this.permissions.canCreateAffiliatePayments?!0:this.booking?q(this.booking):
!1};u[d.TicketLayout.cls]=w("ticketLayouts",!0);u[d.SupportedLanguage.cls]=w("supportedLanguages");u[d.Translation.cls]=w("translations");u[d.Location.cls]=w("locations");u[d.Location.cls].canView="canEditLocations";u[d.Location.cls].canViewSensitive="canEditLocations";u[d.Location.cls].canList="canEditLocations";u[d.Report.cls]=w("reports");u[d.Report.cls].canViewAccountsType="canViewAccounting";u[d.Report.cls].canViewEscrowType="canViewAccounting";u[d.Report.cls].canViewFundsType="canViewAccounting";
u[d.Report.cls].canViewPayoutsType="canViewAccounting";u[d.Report.cls].canViewTransfersType="canViewAccounting";u[d.Report.cls].canViewInvoicesType="canViewInvoices";u[d.Report.cls].canViewInvoiceableBookingsType="canEditInvoices";u[d.Report.cls].canViewAdvancedType="canViewAdvancedReport";u[d.Report.cls].canViewAgentsSummaryType="canViewAgentsSummaryReport";u[d.Report.cls].canViewBookingTypesSummaryType="canViewBookingTypesSummaryReport";u[d.Report.cls].canViewBookingsType="canViewBookingsReport";
u[d.Report.cls].canViewCampaignsSummaryType="canViewCampaignsSummaryReport";u[d.Report.cls].canViewContactsType="canViewContactsReport";u[d.Report.cls].canViewCrewSummaryType="canViewCrewSummaryReport";u[d.Report.cls].canViewCustomFieldSummaryType="canViewCustomFieldSummaryReport";u[d.Report.cls].canViewCustomerTypesSummaryType="canViewCustomerTypesSummaryReport";u[d.Report.cls].canViewDesksSummaryType="canViewDesksSummaryReport";u[d.Report.cls].canViewItemsSummaryType="canViewItemsSummaryReport";
u[d.Report.cls].canViewLineItemsSummaryType="canViewLineItemsSummaryReport";u[d.Report.cls].canViewLodgingsSummaryType="canViewLodgingsSummaryReport";u[d.Report.cls].canViewPaymentsType="canViewPaymentsReport";u[d.Report.cls].canViewDisputesType="canViewDisputesReport";u[d.Report.cls].canViewPickupLocationsSummaryType="canViewPickupLocationsSummaryReport";u[d.Report.cls].canViewRevenueSummaryType="canViewRevenueSummaryReport";u[d.Report.cls].canViewUsersSummaryType="canViewUsersSummaryReport";u[d.Report.cls].canViewCompaniesType=
"canViewCompaniesReport";u[d.Report.cls].canViewInProgressReportsType="canViewInProgressReportsReport";u[d.Report.cls].canViewTransactionsType="canViewTransactionsReport";u[d.Report.cls].canViewVolumeType="canViewVolumeReport";u[d.Report.cls].canReport=function(){return!!this.group};e.slipstream("isReadonlyEnabled")&&(u[d.Report.cls].canView=_.never,u[d.Report.cls].canList=_.never,u[d.Report.cls].canCreate=_.never,u[d.Report.cls].canUpdate=_.never,u[d.Report.cls].canRemove=_.never,u[d.Report.cls].canViewBookingTypesSummaryType=
_.never,u[d.Report.cls].canViewAdvancedType=_.never,u[d.Report.cls].canViewPayoutsType=_.never,u[d.Report.cls].canViewItemsSummaryType=_.never,u[d.Report.cls].canViewRevenueSummaryType=_.never,u[d.Report.cls].canReport=_.never);u[d.ViatorMapping.cls]=w("viator");u[d.Resource.cls]=w("resources");u[d.Resource.cls].canListAssociatedItems="canListAssociatedItems";u[d.Requirement.cls]=w("resources");u[d.RequirementGroup.cls]=w("resources");u[d.CustomerPrototypeRequirement.cls]=w("resources");u[d.CustomerTypeRequirement.cls]=
w("resources");u[d.ResourceRequirement.cls]=w("resources");u[d.ResourceOverride.cls]=w("resources");u[d.SeatMap.cls]=w("resources");u[d.SeatGroup.cls]=w("resources");u[d.SeatZone.cls]=w("resources");u[d.ResourceUse.cls]=c("resources",{permissionOverrides:{canCreate:"canEditResourceUses",canUpdate:"canEditResourceUses",canRemove:"canEditResourceUses"}});u[d.ResourceUse.cls].canList=_.super(u[d.ResourceUse.cls].canList,function(){return!this.booking?this.permissions.canViewResources:this.super()});
u[d.AnalyticsService.cls]=w("analyticsServices",!0);u[d.CancellationPolicy.cls]=w("cancellationPolicies",!0);u[d.CancellationPolicy.cls].canListAssociatedItems="canListAssociatedItems";u[d.CancellationRule.cls]=w("cancellationPolicies",!0);u[d.BookingRestriction.cls]=w("bookingRestrictions",!0);u[d.BookingRestriction.cls].canListAssociatedItems="canListAssociatedItems";a.canBookWithNoFee=function(a,b){return L.currentUser.isAuthenticated};c=function(a){return _.super(a,function(){return _.isNumber(this.group.conditions&&
this.group.conditions.maxCompanyTier)?!1:this.super()})};f=function(){return!y()?!1:this.permissions.canEditReseller};u[d.ResellerApp.cls]=w("reseller");u[d.ResellerApp.cls].canList=c(u[d.ResellerApp.cls].canList);u[d.ResellerAppCompany.cls]=w("reseller");u[d.ResellerCompany.cls]=w("reseller");u[d.ResellerCompany.cls].canList=c(u[d.ResellerCompany.cls].canList);u[d.ResellerAppRequest.cls]=w("accounting");u[d.ResellerAppRequest.cls].canUpdate=f;u[d.ResellerAppRequest.cls].canRemove=f;u[d.ResellerCompanyMapping.cls]=
w("reseller");u[d.ResellerCompanyMapping.cls].canCreate=f;u[d.ResellerCompanyMapping.cls].canList=f;u[d.ResellerCompanyMapping.cls].canRemove=f;u[d.ResellerItem.cls]=w("reseller");u[d.ResellerItemMapping.cls]=w("reseller");u[d.ResellerCustomerType.cls]=w("reseller");u[d.ResellerCustomerTypeMapping.cls]=w("reseller");u[d.ResellerOption.cls]=w("reseller");u[d.ResellerOptionMapping.cls]=w("reseller");u[d.ResellerKey.cls]=w("reseller");u[d.Order.cls].canCancelEligible=function(){return this.permissions.canCancelEligibleBookings&&
!this.can("cancel")};(c=e.slipstream("currentUser"))?c.isAuthenticated=!0:c=t;f=function(a){var b=function(){return L.currentUser.isAuthenticated?L.currentUser.username+"@"+L.currentUser.company.shortname:"anonymous"};return{get:function(d){return a.get(b()+":"+d)},set:function(d,c){return a.set(b()+":"+d,c)},del:function(d){return a.del(b()+":"+d)},clear:function(){if(a.key&&a.length)for(var d=b(),c,e,f=0;f<a.length;f++)e=a.key(f),c=e.split(":",1)[0],c===d&&a.del(e);else a.clear()}}};var L={permissions:a,
storage:f(m),sessionStorage:f(l),currentUser:c,isCompanyUser:function(a,b){b=b||L.currentUser;return!a||!b?!1:b.company===a},isAuthenticatedForAdminCompany:y,isAuthenticatedForAdminCompanyAsDeveloper:function(){return y()&&_.contains(n,L.currentUser.username)},relatedCompanies:function(){return!L.currentUser.isAuthenticated?[]:_.sortBy(_.unique(_.append(_.pluck(d.GroupOverride.companyLevelOverrides(L.currentUser.company.relatedGroupOverrides),"company"),_.pluck(L.currentUser.relatedGroupOverrides,
"company"))),"name")},login:function(a,b){var d=e.login({},a,b);return d.$promise.then(function(){L.currentUser=d;L.currentUser.isAuthenticated=!0;g.broadcast("auth.login")})},logout:function(){L.storage.clear();L.sessionStorage.clear();L.currentUser=t;var a=b.post(k.api.logout);g.broadcast("auth.logout");return a}};return window.$$auth=L}]);h.run(["$rootScope","$window","auth",function(b,a,c){b.auth=c;a.$$auth=c}])})();angular.module("book",["book.directives","book.services"]);
(function(){var h=angular.module("book.directives","book.services cart clientOptions.services db.services lib.services lightframe.services plusbook.services prices.services rebook.services tracking.services".split(" "));h.controller("ngBookCtrl",["$scope","$attrs","$rootScope","$q","analytics","auth","autofill","cart","clientOptions","controllers","db","flows","lightframe","localization","models","navigation","plusbook","priceSheets","postBook","rebook","resourceUseData","tracking","tracking.geo",
function(a,b,f,e,g,d,l,m,k,n,h,p,r,t,v,y,q,B,u,z,C,F,x){var w=this;w.availability=a.$eval(b.ngBook);w.partners=a.$eval(b.ngBookPartners);w.item=w.availability.item;w.isShowingHiddenCustomFields=!1;w.isAvailabilityInCart=!1;w.resourceUseData=C(y.getPk("select-resource"));w.pricesCtrl=a.pricesCtrl;h.slipstream("isDebug")&&(window.$$pop=function(b,d){a.$safeApply(function(){var a=b?b.replace(" ","-"):"z";w.newBooking["contact-name"]=_.capitalize(b||"zach");w.newBooking["contact-email"]=a+"@fareharbor.com";
w.newBooking["contact-phone"]="4158881212";w.newBooking["payments-payment-cardNumber"]="4242424242424242";w.newBooking["payments-payment-cardholdersName"]="Zach Snow";w.newBooking["payments-payment-cardExpiryMonth"]="12";w.newBooking["payments-payment-cardExpiryYear"]="2023";w.newBooking["payments-payment-cardCvc"]="123";w.newBooking["payments-payment-postalCode"]="12345";w.newBooking["payments-payment-countryCode"]="US";_.extend(w.newBooking,d)})});w.attachControl=function(a,b){w[a]=b;b.bookCtrl=
w};var G=e.defer();w.autofillingComplete=G.promise;w.isAutofillingComplete=!1;w.autofillingComplete.then(function(){w.isAutofillingComplete=!0});w.bookCountsCtrlDeferred=e.defer();var M=w.bookCountsCtrlDeferred.promise;w.visibleCustomFieldInstances=function(a,b){return _.filter(a,function(a){return w.isVisibleWhenBooking(a,b)})};w.anyVisibleCustomFieldInstances=function(a,b){return!!w.visibleCustomFieldInstances(a,b).length};w.visibleCustomerTypeRates=function(){return _.filter(w.availability.customerTypeRates,
function(a){return w.pricesCtrl.totalPricing(a).visibility.isVisible})};w.canOverbook=d.permissions.can("overbook",w.availability);b=d.permissions.can("create",v.Booking,w.availability.company);e=_.find(w.partners,function(a){return a.company===w.availability.company});w.currentUserCanCreateAsAffiliate=e&&b;w.currentUserCanCreateAsCompany=d.currentUser.isAuthenticated&&b&&!w.currentUserCanCreateAsAffiliate;w.newBooking={explicitGross:"","contact-isSubscribed":!1,"contact-language":d.currentUser.isAuthenticated?
w.availability.company.language:null,"terms-isAccepted":!1,sendNotification:z.currentBooking?w.availability.company.companyFeatures.isSendRebookedEmailDefault:w.availability.company.companyFeatures.isSendConfirmationEmailDefault,isSmsEnabled:!1,isDemo:w.availability.company.isDemoModeEnabled,onlineBookingReference:k.onlineBookingReference||"",clientUuid:_.uuid()};w.newBookingOptions={};z.currentBooking&&(_.extend(w.newBooking,{explicitGross:null!==z.currentBooking.explicitGross?z.currentBooking.explicitGross:
"",note:z.currentBooking.note}),w.isShowingHiddenCustomFields=d.permissions.can("bookHiddenFields",v.Booking,w.availability.company));w.newBooking["terms-isAccepted"]=w.canOverbook;w.newBooking["affiliation-affiliation"]="";w.currentUserCanCreateAsAffiliate?(w.newBooking["affiliation-affiliation"]=e.pk,w.newBookingOptions.currentAffiliation=e,w.newBooking["affiliation-isBlockable"]=!0):!d.currentUser.isAuthenticated&&(k.asnCharterCompany&&w.availability.company.shortname===k.asnCharterCompany)&&(w.newBooking["affiliation-affiliateCompanyShortname"]=
k.asnAffiliateCompany,w.newBooking["affiliation-voucher-voucherNumber"]=k.asnVoucherNumber);var K=z.currentBooking||q.currentSourceBooking,H=m.search(w.availability),L=_.last(m.entries),E;E=K?B.rebookingEffectiveSheets(w.availability,K):w.newBookingOptions.currentAffiliation?B.affiliationEffectiveSheets(w.availability,w.newBookingOptions.currentAffiliation):B.effectiveSheets(w.availability);w.effectiveSheetsRequest=E.$promise;w.effectiveSheetsRequest.then(function(){w.totalSheetOrSchedule=E.totalSchedule||
E.totalSheet;w.invoiceSheetOrSchedule=E.invoiceSchedule||E.invoiceSheet;w.pricesCtrl.updateSheets({totalSheet:E.totalSheet,invoiceSheet:E.invoiceSheet}).then(function(){K?M.then(function(){l.autofillFromBooking(K,w.newBooking,w.availability,w.visibleCustomerTypeRates(),w.bookCountsCtrl.incrementCount,w.newBookingOptions);G.resolve()}):q.currentContact?(l.autofillFromContact(q.currentContact,w.newBooking),G.resolve()):H?(w.isAvailabilityInCart=!0,_.extend(w.newBooking,H.model),G.resolve()):L?M.then(function(){l.autofillFromCartEntry(L,
w.availability,w.newBooking,w.visibleCustomerTypeRates(),w.bookCountsCtrl.isAutofillable,w.bookCountsCtrl.changeCount);G.resolve()}):G.resolve()})});w.availability.company.affiliatesCount&&w.currentUserCanCreateAsCompany&&w.autofillingComplete.then(function(){a.$watch("bookCtrl.newBookingOptions.currentAffiliation",function(a,b){if(a!==b&&(a||b)){w.effectiveSheetsRequest&&w.effectiveSheetsRequest.cancel();var d=a?B.affiliationEffectiveSheets(w.availability,a):B.effectiveSheets(w.availability);w.effectiveSheetsRequest=
d.$promise;w.effectiveSheetsRequest.then(function(a){a!==h.CANCELLED&&(w.pricesCtrl.updateSheets({totalSheet:d.totalSheet,invoiceSheet:d.invoiceSheet}),w.totalSheetOrSchedule=d.totalSchedule||d.totalSheet,w.invoiceSheetOrSchedule=d.invoiceSchedule||d.invoiceSheet)})}})});var N=!1;w.reflectASN=function(){N=!1;if(!w.newBooking["affiliation-affiliateCompanyShortname"]){var a=_.unique(_.choose(w.newBookingOptions.prevalidity||{},function(a){if(a&&a.isValid&&a.codeAffiliate)return a.codeAffiliate}));1===
a.length?(w.newBooking["affiliation-affiliateCompanyShortname"]=a[0].shortname,N=!0):1<a.length&&console.warn("ng-book: multiple code-based ASNs",a)}};w.restoreASN=function(){N&&(w.newBooking["affiliation-affiliateCompanyShortname"]="")};w.isAlreadyBooked=!1;w.isNavigateAwayAllowed=function(a){return!w.bookCardsCtrl||!w.bookCountsCtrl||w.isAlreadyBooked?!0:!a.$pristine||w.bookCardsCtrl.cards.length&&w.bookCountsCtrl.isTouched?!1:!0};var I=function(b,d){d=d||_.ignore;w.newBooking.selectedResourceRequirements=
w.resourceUseData.selectedResourceRequirementPks();w.newBooking["contact-email"]||(w.newBooking.sendNotification=!1);w.reflectASN();var c=h.availability.book({shortname:w.availability.company.shortname,itemPk:w.item.pk,availabilityPk:w.availability.pk},w.newBooking,b);c.$promise.then(function(){if(c.clientAction)w.paymentCtrl.completeClientAction(b,c).then(function(){I(b,d)},function(){F.track(a,"failed-booking",{company:w.availability.company.shortname,item:w.item.name,availability:w.availability.pk,
isLightframe:r.isLightframe(),clientAction:!0});w.restoreASN();w.paymentCtrl.restoreCard();b.$submitting=!1;d()});else{w.isAlreadyBooked=!0;z.stopRebooking();q.stopPlusbooking();var e;w.paymentCtrl.option()===w.paymentCtrl.EMV_OPTION&&(e={action:"add",option:w.paymentCtrl.EMV_OPTION,amount:w.paymentCtrl.amount()});var f=u.stopBooking(c),f=p.extendWithFlow(f),f=y.compose(f,e);c.isPending&&r.isLightframe()?(f=y.absoluteUrl(f),y.redirect(f)):y.navigate(f);b.$submitting=!0;e={company:w.availability.company.shortname,
item:w.item.name,availability:w.availability.pk,gross:c.costs.totalCost.total,customerCount:c.customerCount,isLightframe:r.isLightframe()};!1===x.isEU&&(e.booking=c.uuid,c.rebookedFrom&&(e.rebooking=c.rebookedFrom.uuid));F.track(a,"completed-booking",e);g.trackBooking(c);d()}},function(c,e){F.track(a,"failed-booking",{company:w.availability.company.shortname,item:w.item.name,availability:w.availability.pk,isLightframe:r.isLightframe()});w.restoreASN();w.paymentCtrl.restoreCard();b.$submitting=!1;
d()})};w.tokenizingCard=!1;w.submit=function(a){if(w.bookCardsCtrl.cards.length)if(a.$valid){a.$submitting=!0;w.paymentCtrl.saveCard();w.newBooking.type=w.paymentCtrl.isRedirectBasedPaymentOption()?v.Booking.PENDING_TYPE:v.Booking.COMPLETED_TYPE;z.currentBooking&&(w.newBooking.rebook=z.currentBooking.uuid,w.newBooking.isCancelEligible=d.permissions.can("cancelEligible",z.currentBooking)&&!d.permissions.can("cancel",z.currentBooking));q.currentContact&&(w.newBooking.plusbook=q.currentContact.pk);q.isOrderizing&&
(w.newBooking.orderizeOrder=q.currentOrder?q.currentOrder.pk:null,w.newBooking.orderizeBooking=q.currentBooking?q.currentBooking.pk:null);w.newBooking.isShowingHiddenCustomFields=w.isShowingHiddenCustomFields;var b=w.paymentCtrl.option();if(!z.currentBooking&&(b===w.paymentCtrl.CHARGE_OPTION||b===w.paymentCtrl.DEFER_OPTION))w.tokenizingCard=!0;f.$asyncApply(function(b){w.paymentCtrl.createToken(a,function(){w.tokenizingCard=!1;I(a,b)},function(){w.tokenizingCard=!1;a.$submitting=!1;b()})})}else console.error("book: attempting to submit invalid book form");
else console.error("book: attempting to submit empty book form")};w.showBookButton=function(a){var b;if(b=!a.$invalid){if(a=!a.$submitting)a=w.canOverbook?!0:w.bookCountsCtrl&&w.bookCountsCtrl.isBookable(),a=a&&w.paymentCtrl&&w.paymentCtrl.isCurrentOptionValid()&&w.paymentCtrl.isCurrentKindValid()&&!w.paymentCtrl.isAmountTooLow();b=a}return b};w.isVisibleWhenBooking=function(a,b,d){var c=!0,e=w.pricesCtrl.totalPricing(a);d=d?w.pricesCtrl.totalPricing(d):null;e.visibility.isVisible||(c=!1);d&&!d.visibility.isVisible&&
(c=!1);e.visibility.isHiddenWhenBooking&&!w.isShowingHiddenCustomFields&&(c=!1);d&&(d.visibility.isHiddenWhenBooking&&!w.isShowingHiddenCustomFields)&&(c=!1);v.CustomFieldInstance.isVisibleWhenBooking(a,function(a){return w.newBooking[v.Booking.customFieldInstanceKey(a,b)]})||(c=!1);c||delete w.newBooking[v.Booking.customFieldInstanceKey(a,b)];return c}}]);h.directive("ngBook",["$parse","rebook","events","controllers",function(a,b,f,e){return{restrict:"A",require:["^ngPrices","ngBook"],scope:!0,templateUrl:"book.book",
controller:"ngBookCtrl",compile:function(a,d){return{pre:function(a,b,d,c){a.bookCtrl=c[1];window.$$bookCtrl=a.bookCtrl},post:function(a,d,g){b.onEnterBookForm();a.$on("$destroy",function(){b.onExitBookForm()});f.on(a,"prices.ngPrices.updated",function(){a.bookCtrl.newBooking.totalSheet=a.bookCtrl.pricesCtrl.sheets.totalSheet.pk;a.bookCtrl.newBooking.invoiceSheet=a.bookCtrl.pricesCtrl.sheets.invoiceSheet?a.bookCtrl.pricesCtrl.sheets.invoiceSheet.pk:""});a.newBooking=a.bookCtrl.newBooking;a.newBookingOptions=
a.bookCtrl.newBookingOptions;e.affiliationController(a,{company:a.bookCtrl.availability.company,modelKey:"newBooking",affiliateModelKey:"newBookingOptions",prefix:"affiliation"})}}}}}]);h.directive("ngTaxesAndFees",function(){return{restrict:"A",templateUrl:"ng-taxes-and-fees",controllerAs:"taxesAndFeesCtrl",controller:["$attrs","$scope","db","parseAttrsForScope","require",function(a,b,f,e,g){g.inScope(b,"company","ng-taxes-and-fees");var d=this;a=e(a,b,{totals:"=",source:"=",isUserAuthenticated:"="},
"ngTaxesAndFees");_.extend(d,a);d.hasTax=function(){return!b.company.features.isCombinedTaxEnabled&&(d.totals.tax||!d.source.isNoTax)};var l=b.$watch(function(){if(_.isUndefined(d.totals.taxByType)||b.company.features.isCombinedTaxEnabled?0:d.isUserAuthenticated?b.company.features.isTaxTypeBreakdownEnabled:b.company.features.isOnlineBookFormTaxTypesEnabled&&b.company.features.isExtendedBreakdownEnabled)d.taxTypes=f.taxTypes({shortname:b.company.shortname}),l()});d.showTaxType=function(a){return _.isNumber(d.totals.taxByType[a.pk])&&
(d.totals.taxByType[a.pk]||!d.source.isNoTax)}}]}});h.directive("ngBookTotals",["$parse","auth","controllers","cost","costComputations","costs","events","models","paymentController","rebook","redeemStoredValueCardsController","require","toggles",function(a,b,f,e,g,d,l,m,k,n,h,p,r){return{require:["^ngBook","ngBookTotals"],controller:function(){var a=this,f=m.PriceSheet,k=m.PriceLine,l=function(b,d){var c=b.customField,e=m.Booking.customFieldInstanceKey(b,d),f=a.bookCtrl.newBooking[e]||"",g=a.bookCtrl.newBookingOptions.prevalidity||
{},k;if(c.type===m.CustomField.TRANSPORTATION_TYPE){if(k=parseInt(f,10),(e=_.find(c.transportationOptions,function(a){return a.pk===k}))&&!e.isSelfTransportation)return{isAlwaysPerCustomer:c.isAlwaysPerCustomer}}else if(c.type===m.CustomField.EXTENDED_OPTION_TYPE){if(k=parseInt(f,10),c=_.find(c.extendedOptions,function(a){return a.pk===k}))return{object:c,isAlwaysPerCustomer:c.isAlwaysPerCustomer}}else if(c.type===m.CustomField.MULTI_CAMPAIGN_TYPE){if((e=g[e])&&e.isValid&&e.pricedObject)return{object:e.pricedObject,
isAlwaysPerCustomer:e.pricedObject.isAlwaysPerCustomer}}else if(c.type===m.CustomField.CODE_TYPE){if((e=g[e])&&e.isValid)return{isAlwaysPerCustomer:c.isAlwaysPerCustomer}}else if(c.type===m.CustomField.NEW_TRANSPORTATION_TYPE){if(_.isObject(f)||(f=f?_.parseJSON(f):{}),f.route)return{isAlwaysPerCustomer:c.isAlwaysPerCustomer}}else if(c.type===m.CustomField.COUNT_TYPE){if(f=f||0,p.assert(_.isInteger(f),"expected count to be an integer: "+f),f)return{isAlwaysPerCustomer:c.isAlwaysPerCustomer,count:f}}else if(c.type===
m.CustomField.CARD_GENERATOR_TYPE){if(_.isObject(f)||(f=f?_.parseJSON(f):{}),f=f.amount||0,p.assert(_.isInteger(f),"expected card generator to be an integer: "+f),f)return{isAlwaysPerCustomer:c.isAlwaysPerCustomer,price:f}}else if(f)return{isAlwaysPerCustomer:c.isAlwaysPerCustomer}},h=function(a,b,d,c){a=_.clone(c(b.object||a));var l=a.taxes;_.isUndefined(b.price)||(a.price={modifierKind:m.PriceLine.OFFSET_MODIFIER_KIND,modifierType:m.PriceLine.ADJUST_MODIFIER_TYPE,offset:b.price,customTax:a.price.customTax,
taxInclusion:a.price.taxInclusion});var n=a.price;if(n.modifierType===k.NONE_MODIFIER_TYPE)return g.nonePriceCost(a);c=a.price;c.modifierKind===m.PriceLine.PERCENTAGE_MODIFIER_KIND?c=0>d.price?e.ZERO:e.mul(d,c.rate):c.modifierKind===m.PriceLine.OFFSET_MODIFIER_KIND?c=e(c.offset,c.offset,g.asTaxByType(a,c.offset)):(console.warn("ng-book-totals: invalid modifier kind",c,c.modifierKind),c=e.ZERO);_.isUndefined(b.count)||(c=e.mul(c,b.count));n.modifierType===k.SET_MODIFIER_TYPE&&(c=e.sub(c,d));if(n.modifierKind===
k.PERCENTAGE_MODIFIER_KIND)return l=l.taxability!==f.NONE_TAXABILITY?c.taxable:0,n=g.asTaxByType(a,l),n=g.adjustTax(a,d,n),d=e(c.price,l,n),d=g.applyCustomTax(a,d);if(k.isTaxIncluded(a))return g.applyTaxInclusion(a,c.price);b=_.roundHalfToEven((c.price||0)*a.sheetRate.sheetRate);l=l.taxability===f.NONE_TAXABILITY?0:l.taxability===f.PRO_RATE_TAXABILITY?b:c.price;n=g.asTaxByType(a,l);n=g.adjustTax(a,d,n);d=e(b,l,n);return d=g.applyCustomTax(a,d)},s=function(b,c,f,g){var k=c.totalCost,n=c.invoiceCost,
s=k,p=n,r=a.bookCtrl.newBookingOptions.totalCosts;_.forEach(b,function(b){if(!b.customField.isDisplayOnly){var d=b.customField.pricingType;d===m.CustomField.STACK_PRICING_TYPE?(k=s,n=p):d!==m.CustomField.CURRENT_PRICING_TYPE&&(d===m.CustomField.INITIAL_PRICING_TYPE?(k=c.totalCost,n=c.invoiceCost):d===m.CustomField.ZERO_PRICING_TYPE&&(n=k=e.NONE));var v=l(b,f);if(v&&(_.isUndefined(g)||v.isAlwaysPerCustomer===g)&&a.bookCtrl.isVisibleWhenBooking(b,f,v.object))d=h(b,v,k,a.bookCtrl.pricesCtrl.totalPricing),
d.feeable=b.customField.type===m.CustomField.CARD_GENERATOR_TYPE?m.StoredValueCard.calculateFeeable(b.company,d.feeable):d.feeable,v=h(b,v,n,a.bookCtrl.pricesCtrl.invoicePricing),v.feeable=b.customField.type===m.CustomField.CARD_GENERATOR_TYPE?m.StoredValueCard.calculateFeeable(b.company,v.feeable):v.feeable,b=m.Booking.customFieldInstanceKey(b,f),r[b]=e.add(d,r[b]||e.ZERO),k=e.add(k,d),n=e.add(n,v),s=e.add(s,d),p=e.add(p,v)}});return d(s,p)},z=function(){_.forEach(a.bookCtrl.bookCardsCtrl.cards,
function(b){var c=a.bookCtrl.pricesCtrl.totalPricing(b.customerTypeRate);if(c.visibility.isVisible){var e=g.asCost(c);b.isTaxIncluded=m.PriceLine.isTaxIncluded(c);c=a.bookCtrl.pricesCtrl.invoicePricing(b.customerTypeRate);c=g.asCost(c);e=d(e,c);e=s(b.customerPrototype.customFieldInstances,e,b);e=s(a.bookCtrl.bookBookingFieldsCtrl.customFieldInstances,e,null,!0);b.costs=d.clampAtZero(e)}})},C=function(){return n.currentBooking?d.sum(_.pluck(n.currentBooking.lineItems,"costs")):d.NONE},F=function(b){var d=
_.find(_.reversed(a.bookCtrl.availability.company.tieredFeeSchedule),function(a){return b>=a.cutoff});if(!d)throw Error("ng-book-totals: invalid tiered fee schedule");return d.rate},x=function(d,e){var f;f=b.currentUser.isAuthenticated?!b.permissions.canBookWithNoFee(a.bookCtrl.availability.company,a.bookCtrl.newBookingOptions.currentAffiliation?a.bookCtrl.newBookingOptions.currentAffiliation.affiliateCompany:null):!0;if(!f)return 0;f=a.bookCtrl.availability.company;if("no-fee"===f.feeType)return 0;
if("flat-fee"===f.feeType)return f.flatFee;var g;if("percentage-fee"===f.feeType)g=f.percentageFeeRate;else if("tiered-fee"===f.feeType)g=F(d);else throw Error("ng-book-totals: invalid fee type "+f.feeType);g=_.roundHalfToEven(d*g);g<f.minimumFee&&(g=!g&&a.bookCtrl.item.isFreeAllowed?0:!g&&e?0:f.minimumFee);return g};a.totals={price:0,tax:0,preBookingFeeTotal:0,bookingFee:0,total:0,finalTotal:0,invoice:0,explicit:null};a.unexpect=function(){r.toggle("changeExplicitGross",!1);a.bookCtrl.newBooking.explicitGross=
""};a.updateTotals=function(){if(a.bookCtrl.bookCardsCtrl&&a.bookCtrl.redeemStoredValueCardsCtrl){a.bookCtrl.newBookingOptions.totalCosts=_.clear(a.bookCtrl.newBookingOptions.totalCosts||{});z();var e;e=d.sum(_.pluck(a.bookCtrl.bookCardsCtrl.cards,"costs"));e=s(a.bookCtrl.bookBookingFieldsCtrl.customFieldInstances,e,null,!1);e=d.add(e,C());e=d.clampAtZero(e);var f=e.totalCost;e=e.invoiceCost;var k=f.tax,l=f.taxByType;a.bookCtrl.availability.company.features.isAggregateTaxEnabled&&(k=a.bookCtrl.pricesCtrl.totalPricing(a.bookCtrl.availability),
l=g.asTaxByType(k,f.taxable),k=_.sum(_.values(l)));var n=a.bookCtrl.redeemStoredValueCardsCtrl.totalApplied(),h=x(f.feeable,f.price),h=m.Booking.adjustBookingFee(h,f.price,k,n),n=f.price+k-n,p=n+h;a.totals.lineItems=C().totalCost.price;a.totals.price=f.price||0;a.totals.tax=k;a.totals.taxByType=l;a.totals.preBookingFeeTotal=n;a.totals.bookingFee=h;a.totals.total=p;a.totals.finalTotal=p;b.permissions.can("updateExplicitTotal",m.Booking,a.bookCtrl.availability.company)&&(""!==a.bookCtrl.newBooking.explicitGross?
(a.totals.bookingFee=0,a.totals.explicit=a.bookCtrl.newBooking.explicitGross,a.totals.finalTotal=a.totals.explicit):a.totals.explicit=null);a.bookCtrl.pricesCtrl.sheets.invoiceSheet&&e?(f=e.tax,a.bookCtrl.availability.company.features.isAggregateTaxEnabled&&(f=a.bookCtrl.pricesCtrl.invoicePricing(a.bookCtrl.availability),f=g.asTaxByType(f,e.taxable),f=_.sum(_.values(f))),a.totals.invoice=e.price+f):a.totals.invoice=null}};a.currentPrice=function(){return a.totals.price||0};a.currentTax=function(){return a.totals.tax||
0};a.currentGross=function(){return null!==a.totals.explicit?a.totals.explicit:a.totals.preBookingFeeTotal};a.isCustomFieldInstanceSelected=function(a,b){return!!l(a,b)}},compile:function(b,d){var c=a(d.ngBookTotalsCardPayments),e=a(d.ngBookTotalsInStorePaymentTypes);return{pre:function(a,b,d,c){a.bookTotalsCtrl=c[1];a.bookCtrl.attachControl("bookTotalsCtrl",a.bookTotalsCtrl)},post:function(a,b,d){b=c(a)||[];d=e(a)||[];h(a,{company:a.bookCtrl.availability.company,modelKey:"newBooking",price:a.bookTotalsCtrl.currentPrice,
tax:a.bookTotalsCtrl.currentTax,toggleName:"applyStoredValueCard",availability:a.bookCtrl.availability});a.bookCtrl.attachControl("redeemStoredValueCardsCtrl",a.redeemStoredValueCardsCtrl);a.$watch("redeemStoredValueCardsCtrl.storedValueCards.length",function(b){a.bookTotalsCtrl.updateTotals()});a.bookTotalsCtrl.updateTotals();a.$watch(function(){a.bookTotalsCtrl.updateTotals()});l.on(a,"lib.shared.PaymentCtrl.swipe",function(b,d){var c=_.trim(d.fullName);!a.bookCtrl.newBooking["contact-name"]&&c&&
(a.bookCtrl.newBooking["contact-name"]=c)});k(a,{modelKey:"newBooking",fieldPrefix:"payments-payment",company:a.bookCtrl.availability.company,gross:a.bookTotalsCtrl.currentGross,bookingFee:function(){return a.bookTotalsCtrl.totals.bookingFee},invoicePrice:function(){return a.bookTotalsCtrl.totals.invoice},invoiceRelationship:function(){return a.bookCtrl.pricesCtrl.sheets.invoiceSheet?a.bookCtrl.pricesCtrl.sheets.invoiceSheet.relationship:""},affiliation:function(){return a.bookCtrl.newBookingOptions.currentAffiliation},
swipe:a.bookCtrl.currentUserCanCreateAsCompany||a.bookCtrl.currentUserCanCreateAsAffiliate,isCompany:!!a.bookCtrl.currentUserCanCreateAsCompany,isAffiliate:!a.bookCtrl.currentUserCanCreateAsCompany&&!!a.bookCtrl.currentUserCanCreateAsAffiliate,isAnonymous:!a.bookCtrl.currentUserCanCreateAsCompany&&!a.bookCtrl.currentUserCanCreateAsAffiliate,isCardRequired:!!a.bookCtrl.item.isCardRequired,cardPayments:b,inStorePaymentTypes:d});f.splitPaymentController(a,{max:a.bookTotalsCtrl.currentGross,amount:function(b){_.isUndefined(b)||
(a.bookCtrl.newBooking["payments-payment-gross"]=b);return a.bookTotalsCtrl.currentGross()},customerCount:function(){return a.bookCtrl.bookCountsCtrl?a.bookCtrl.bookCountsCtrl.customerCount:0}});a.bookCtrl.attachControl("paymentCtrl",a.paymentCtrl)}}}}}]);h.directive("ngBookRedeem",[function(){return{restrict:"A",require:["^ngBook","ngBookRedeem"],templateUrl:"book.redeem"}}]);h.directive("ngBookCallToBook",["require",function(a){return{restrict:"A",require:["^ngBook","ngBookCallToBook"],scope:!0,
templateUrl:"book.callToBook",controller:function(){},link:{pre:function(a,b,e,g){a.bookCallToBookCtrl=g[1];a.bookCtrl.attachControl("bookCallToBookCtrl",a.bookCallToBookCtrl)}}}}]);h.directive("ngBookCounts",["$timeout","auth","db","events","models","plusbook","rebook",function(a,b,f,e,g,d,l){return{restrict:"A",require:["^ngBook","ngBookCounts"],scope:!0,templateUrl:"book.counts",controller:["$scope",function(b){var c=this;c.availabilityMaximumPartySize=null;c.remainingAvailabilityCapacity=0;c.customerCount=
0;c.availabilityCustomerCount=0;c.missingCount=0;c.isCompletelyFull=!1;c.isOverbooking=!1;c.remainingCustomerTypeRateCapacities={};c.status="initializing";c.unbookableReason="";c.liveCapacity={$fresh:!0};c.isTouched=!1;c.untouch=function(){a(function(){c.isTouched=!1})};b.$watch("bookCountsCtrl.bookCtrl.resourceUseData.selectedSplittableRequirementsResources",function(){c.liveUpdateCapacities()},!0);b.$watch("bookCountsCtrl.bookCtrl.resourceUseData.selectedNonSplittableRequirementsResources",function(){c.liveUpdateCapacities()},
!0);var e,h,p;c.liveUpdateCapacities=function(){var a=c.bookCtrl.pricesCtrl.sheets.totalSheet;if(a){b.customerTypeRateCounts=_.keyBy(c.visibleCustomerTypeRates,"pk",q);var d=c.bookCtrl.resourceUseData.selectedResourceRequirementPks(),g={shortname:c.bookCtrl.availability.item.company.shortname,itemPk:c.bookCtrl.availability.item.pk,availabilityPk:c.bookCtrl.availability.pk},a={customerTypeRateCounts:_.stringifyJSON(b.customerTypeRateCounts),selectedResourceRequirements:d,totalSheet:a?a.pk:"",rebooking:l.currentBooking?
l.currentBooking.pk:""};if(!angular.equals([g,a],[h,p])){h=g;p=a;e&&(e.cancel(),e=null);c.status="loading";var t=f.availability.liveCapacity(g,null,null,a);e=t.$promise;return e.then(function(a){a!==f.CANCELLED&&(_.extend(c.liveCapacity,t),c.liveCapacity.customerTypeRateCapacities=_.keyBy(c.liveCapacity.customerTypeRates,"uri","liveBookableCapacity"),c.liveCapacity.overbookedCustomerTypeRatesByUri=_.keyBy(c.liveCapacity.overbookedCustomerTypeRates,"uri"),e=null,c.status="success")},function(){e=null;
c.status="error"})}}};var r=function(){c.availabilityCustomerCount=c.bookCtrl.availability.customerCount;c.remainingAvailabilityCapacity=c.bookCtrl.availability.nonResourceBookableCapacity;l.currentBooking&&l.currentBooking.availability===c.bookCtrl.availability&&(c.availabilityCustomerCount-=l.currentBooking.customerCount,null!==c.bookCtrl.availability.capacity&&(c.remainingAvailabilityCapacity=Math.max(c.bookCtrl.availability.capacity-c.availabilityCustomerCount,0)));c.availabilityMaximumPartySize=
g.Availability.maximumPartySize(c.bookCtrl.availability);c.remainingAvailabilityCapacity=_.nullHighMin(c.remainingAvailabilityCapacity,c.availabilityMaximumPartySize);var a=!0;c.customerCount=0;_.forEach(c.customerTypeRates,function(b){var d=q(b);c.customerCount+=d;c.availabilityCustomerCount+=d;null!==c.remainingAvailabilityCapacity&&(c.remainingAvailabilityCapacity-=d);null!==b.capacity?(d=b.capacity-b.customerCount-d,l.currentBooking&&l.currentBooking.availability===c.bookCtrl.availability&&(d+=
_.filter(l.currentBooking.customers,function(a){return a.customerTypeRate===b}).length),c.remainingCustomerTypeRateCapacities[b.uri]=d,a=a&&0===d):(c.remainingCustomerTypeRateCapacities[b.uri]=null,a=!1)});c.isCompletelyFull=0===c.remainingAvailabilityCapacity||a;var b=_.some(c.customerTypeRates,function(a){var b=c.remainingCustomerTypeRateCapacities[a.uri];return null!==b&&0>b&&q(a)});c.isOverbooking=b||0>c.remainingAvailabilityCapacity},t=function(){if(c.bookCtrl.canOverbook)c.missingCount=0;else{var a=
0;_.forEach(c.visibleCustomerTypeRates,function(b){b.isExclusive||(a+=q(b))});if(a){var b=g.Availability.minimumPartySize(c.bookCtrl.availability);c.missingCount=Math.max(0,b-a)}else c.missingCount=0}},v=!0,y=function(){v=c.bookCtrl.canOverbook?!0:_.all(c.visibleCustomerTypeRates,function(a){var b=q(a),d=c.maxCount(a);return!(null!==d&&b>d||0<b&&b<c.minCount(a))})};c.isBookable=function(){return v&&!c.missingCount&&!c.isOverbooking&&c.liveCapacity.isBookable};c.remainingCustomerTypeRateBookableCapacity=
function(a){var b=c.remainingAvailabilityCapacity;null!==a.capacity&&(b=_.nullHighMin(b,c.remainingCustomerTypeRateCapacities[a.uri]));return b};var q=function(a){if(!c.bookCtrl.pricesCtrl.totalPricing(a).visibility.isVisible)return 0;a=g.Booking.customerTypeRateCountKey(a);return c.bookCtrl.newBooking[a]||0},B=function(a,b){if(!c.bookCtrl.pricesCtrl.totalPricing(a).visibility.isVisible)return console.warn("ng-book-counts: setting count of hidden customer type rate",a,b),b;var d=g.Booking.customerTypeRateCountKey(a);
return c.bookCtrl.newBooking[d]=b},u=function(a,b){var d=Math.max(q(a)+b,0);return B(a,d)};c.incrementCount=function(a){c.isTouched=!0;return u(a,1)};c.decrementCount=function(a){c.isTouched=!0;return u(a,-1)};c.maxCount=function(a){var b=c.remainingCustomerTypeRateBookableCapacity(a),d=q(a);null!==b&&(b+=d);"success"===c.status&&(b=_.nullHighMin(b,c.liveCapacity.customerTypeRateCapacities[a.uri]));b=_.nullHighMin(b,a.maximumPartySize);return _.nullHighMax(b,0)};c.minCount=function(a){var b=0;!c.bookCtrl.currentUserCanCreateAsCompany&&
(1===c.visibleCustomerTypeRates.length&&!c.visibleCustomerTypeRates[0].isExclusive)&&(b=Math.max(b,g.Availability.minimumPartySize(c.bookCtrl.availability)));a&&null!==a.minimumPartySize&&(b=Math.max(b,a.minimumPartySize));return b};c.customerTypeRateCount=function(a){return _.isUndefined(a)?_.sum(_.map(c.bookCtrl.availability.customerTypeRates,q)):q(a)};c.isAlreadyFull=function(a){if("success"!==c.status)return null!==a.capacity&&a.customerCount>=a.capacity;var b=c.liveCapacity.customerTypeRateCapacities[a.uri],
b=null!==b&&0>=b;0===a.maximumPartySize&&(b=!0);return b&&0===q(a)};c.isDisabledDueToPartySize=function(a){return null!==c.availabilityMaximumPartySize&&c.customerCount>=c.availabilityMaximumPartySize&&0===q(a)};c.isExclusivelyDisabled=function(a){return _.exists(c.bookCtrl.availability.customerTypeRates,function(b){var d=q(b);if(l.currentBooking&&l.currentBooking.availability===c.bookCtrl.availability)var e=_.sum(_.map(l.currentBooking.customers,function(a){return a.customerTypeRate===b?1:0})),d=
d-e;d=0<b.customerCount+d;if(b.isExclusive&&b!==a&&d||a.isExclusive&&b!==a&&d)return!0})};c.isCallToBook=function(a){return!c.bookCtrl.canOverbook&&g.Availability.isBookableEverByPhone(c.bookCtrl.availability)&&0===a.capacity};c.isAutofillable=function(a){return c.isCallToBook(a)||c.isExclusivelyDisabled(a)?!1:!0};c.countsTracker=0;var z=function(){r();t();var a=c.liveUpdateCapacities();if(!a)return!1;var b=function(){r();t();y();c.countsTracker++};a.then(b,b)};c.update=function(){c.customerTypeRates=
c.bookCtrl.availability.customerTypeRates;c.visibleCustomerTypeRates=c.bookCtrl.visibleCustomerTypeRates();z();if(!c.customerCount&&!l.currentBooking&&!d.currentSourceBooking&&1===c.visibleCustomerTypeRates.length){var a=_.first(c.visibleCustomerTypeRates),b=c.remainingCustomerTypeRateBookableCapacity(a);(1===a.capacity&&1<=b||null===a.capacity&&1===b)&&0===c.customerCount&&u(a,1)}};c.changeCount=function(a,b,d){c.isTouched=!0;B(a,b);d||z();return b};c.customerBreakdown=function(){var a=[];_.forEach(c.visibleCustomerTypeRates,
function(b){var d=c.customerTypeRateCount(b);d&&a.push({count:d,customerTypeRate:b})});return a}}],link:{pre:function(a,b,d,c){a.bookCountsCtrl=c[1];a.bookCtrl.attachControl("bookCountsCtrl",a.bookCountsCtrl)},post:function(a){a.bookCountsCtrl.update();_.forEach(a.bookCtrl.availability.customerTypeRates,function(b){a.$watch(function(){return a.bookCountsCtrl.customerTypeRateCount(b)},function(d,c){d=d||0;c=c||0;if(d||c)d===c&&(c=0),a.bookCountsCtrl.changeCount(b,d),a.bookCtrl.bookCardsCtrl.changeCount(b,
d,c)})});e.on(a,"prices.ngPrices.updated",function(){a.bookCountsCtrl.update()});a.bookCtrl.autofillingComplete.then(function(){a.bookCountsCtrl.untouch()});a.bookCtrl.bookCountsCtrlDeferred.resolve()}}}}]);h.directive("ngBookSelectCount",[function(){return{require:"^ngBookCounts",restrict:"A",controllerAs:"selectCountCtrl",controller:["$scope","$element","$attrs","$parse","require",function(a,b,f,e,g){g.inScope(a,"pricesCtrl","ngBookSelectCount");g.inScope(a,"bookCtrl","ngBookSelectCount");g.inScope(a,
"bookCountsCtrl","ngBookSelectCount");g.inScope(a,"customerTypeRate","ngBookSelectCount");if(!a.bookCountsCtrl.isCallToBook(a.customerTypeRate)){var d=e(f.ngBookSelectCount),l=this;l.options=[];var m=a.bookCtrl.canOverbook,k,n,h,p,r=a.$watch("bookCountsCtrl.status",function(){"success"!==a.bookCountsCtrl.status?l.options=[0]:(r(),a.$watch("bookCountsCtrl.countsTracker",function(){k=a.bookCountsCtrl.minCount(a.customerTypeRate);n=a.bookCountsCtrl.maxCount(a.customerTypeRate);h=a.bookCountsCtrl.customerTypeRateCount(a.customerTypeRate);
p=_.nullHighMax(n,h);l.maxCutoff=h>n?n:void 0;if("success"!==a.bookCountsCtrl.status)l.options=[0];else{var d=l.isAboveMax()||null!==p&&0<h&&k>p,e=l.isBelowMin(),f=a.bookCountsCtrl.isExclusivelyDisabled(a.customerTypeRate),g=!f&&a.bookCountsCtrl.isDisabledDueToPartySize(a.customerTypeRate);b.toggleClass("select-count-over-display-max ng-pseudo-invalid",d);b.toggleClass("select-count-below-display-min ng-pseudo-invalid",!d&&e);b.toggleClass("select-count-max-overrideable",m);b.toggleClass("select-count-max-not-overrideable",
!m);b.toggleClass("select-count-exclusively-disabled",f);b.toggleClass("select-count-party-size-disabled",g);b.toggleClass("is-already-full",!f&&!g&&a.bookCountsCtrl.isAlreadyFull(a.customerTypeRate));d=m?0:k;g=m?n:p;null===g&&(g=300);m&&(g+=25,h>=g&&(g=h+25));f&&!m&&(g=h);g=Math.min(g,300);f=_.range(d,g+1);e&&!m&&f.unshift(h);0!==f[0]&&f.unshift(0);_.overwrite(l.options,f)}}))});l.isAboveMax=function(){return null!==n&&h>n};l.isBelowMin=function(){return!!h&&h<k};l.optionGroup=function(a){return null!==
n&&a>n?m?T("Overbooking:"):T("Unavailable:"):a&&a<k?m?"":T("Unavailable:"):""};l.isDisabled=function(){return 1===l.options.length&&0===l.options[0]&&0===h};a.$watch(d,function(b){_.isUndefined(b)&&d.assign(a,0)})}}]}}]);var b=function(a,b,f,e){f=b.visibleCustomFieldInstances(f,e);e=_.filter(f,function(a){return b.pricesCtrl.totalPricing(a).visibility.isRequired});var g=_.filter(f,"customField.isDisplayOnly"),d={"custom-fields-count":f.length,"custom-fields-required-count":e.length,"custom-fields-display-only-count":g.length,
"custom-fields-titles-character-count":0,"custom-fields-descriptions-character-count":0,"custom-fields-required-titles-character-count":0,"custom-fields-required-descriptions-character-count":0};_.forEach(f,function(a){d["custom-fields-titles-character-count"]+=a.customField.title.length;d["custom-fields-descriptions-character-count"]+=a.customField.description.length});_.forEach(e,function(a){d["custom-fields-required-titles-character-count"]+=a.customField.title.length;d["custom-fields-required-descriptions-character-count"]+=
a.customField.description.length});return _.mapKeys(d,function(b,d){return a+"-"+d})};h.directive("ngBookCards",["events","models",function(a,c){return{restrict:"A",require:["^ngBook","ngBookCards"],scope:!0,templateUrl:"book.cards",controller:["$scope",function(f){var e=this;e.cards=[];e.canRemoveCard=function(a){if(e.bookCtrl.canOverbook)return!0;var b=0;!e.bookCtrl.currentUserCanCreateAsCompany&&1===e.bookCtrl.bookCountsCtrl.visibleCustomerTypeRates.length&&(b=Math.max(b,c.Availability.minimumPartySize(e.bookCtrl.availability)));
null!==a.customerTypeRate.minimumPartySize&&(b=Math.max(b,a.customerTypeRate.minimumPartySize));return a.index>=b};e.removeCard=function(a){var b=e.bookCtrl.newBookingOptions.prevalidity||{},d=e.bookCtrl.newBookingOptions.totalCosts||{},f=a.customerTypeRate.customerPrototype.customFieldInstances;_.overwriteWithout(e.cards,function(b){return b.key===a.key});_.forEach(f,function(f){f=c.Booking.customFieldInstanceKey(f,a);delete e.bookCtrl.newBooking[f];delete b[f];delete d[f]});var g={},l={},h={};_.forEach(e.cards,
function(m){m.customerTypeRate===a.customerTypeRate&&_.forEach(f,function(a){a=c.Booking.customFieldInstanceKey(a,m);h[a]=e.bookCtrl.newBooking[a];delete e.bookCtrl.newBooking[a];g[a]=b[a];delete b[a];l[a]=d[a];delete d[a]})});var y=0;_.forEach(e.cards,function(q){if(q.customerTypeRate===a.customerTypeRate){var B=m(y,q.customerTypeRate);y+=1;_.forEach(f,function(a){var f=c.Booking.customFieldInstanceKey(a,q);a=c.Booking.customFieldInstanceKey(a,B);e.bookCtrl.newBooking[a]=h[f];b[a]=g[f];d[a]=l[f]});
_.extend(q,B)}});e.bookCtrl.bookCountsCtrl.decrementCount(a.customerTypeRate)};var g=function(a,b,d){_.forEach(_.range(d,b),function(b){b=m(b,a);e.cards.push(b)})},d=function(a,b){var d=e.bookCtrl.newBookingOptions.prevalidity||{},f=e.bookCtrl.newBookingOptions.totalCosts||{},g=[],m=0;_.forEach(e.cards,function(l){l.customerTypeRate===a?m===b?_.forEach(l.customerPrototype.customFieldInstances,function(a){a=c.Booking.customFieldInstanceKey(a,l);delete e.bookCtrl.newBooking[a];delete d[a];delete f[a]}):
(g.push(l),m+=1):g.push(l)});_.overwrite(e.cards,g)},l=function(a){var d=b("customer-type",e.bookCtrl,a.customerTypeRate.customerPrototype.customFieldInstances,a);_.extend(a.customFieldTrackingData,d)},m=function(a,b){var d={key:b.pk.toString()+"-"+a.toString(),index:a,number:a+1,customerTypeRate:b,customerPrototype:b.customerPrototype,customerType:b.customerPrototype.customerType,customFieldTrackingData:{}};l(d);return d};a.on(f,"prices.ngPrices.updated",function(){_.forEach(e.cards,l)});e.changeCount=
function(a,b,c){b>c?g(a,b,c):b<c?d(a,b):b||d(a,0)};e.hasCustomFields=function(){return _.some(e.cards,function(a){return e.bookCtrl.anyVisibleCustomFieldInstances(a.customerPrototype.customFieldInstances,a)})};e.hasAnyCustomFields=function(){return _.some(e.bookCtrl.availability.customerTypeRates,function(a){return e.bookCtrl.anyVisibleCustomFieldInstances(a.customerPrototype.customFieldInstances)})}}],link:{pre:function(a,b,c,d){a.bookCardsCtrl=d[1];a.bookCtrl.attachControl("bookCardsCtrl",a.bookCardsCtrl)}}}}]);
h.directive("ngBookBookingFields",["events","require",function(a,c){return{restrict:"A",templateUrl:"book.bookingFields",require:["^ngBook","ngBookBookingFields"],scope:!0,controller:["$scope",function(c){var e=this;e.customFieldInstances=[];e.customFieldTrackingData={};e.updateCustomFieldInstances=function(a){e.customFieldInstances=a};a.on(c,"prices.ngPrices.updated",function(){var a=b("whole-booking",e.bookCtrl,e.customFieldInstances);_.extend(e.customFieldTrackingData,a)});e.hasCustomFields=e.hasAnyCustomFields=
function(){return e.bookCtrl.anyVisibleCustomFieldInstances(e.customFieldInstances)}}],link:{pre:function(a,b,c,d){a.bookBookingFieldsCtrl=d[1];a.bookCtrl.attachControl("bookBookingFieldsCtrl",a.bookBookingFieldsCtrl)},post:function(a,b,c,d){a.bookBookingFieldsCtrl.updateCustomFieldInstances(a.bookCtrl.availability.customFieldInstanceGroup?a.bookCtrl.availability.customFieldInstanceGroup.customFieldInstances:[])}}}}]);h.directive("ngBookField",["$parse","models","rebook",function(a,b,f){return{restrict:"A",
require:["^ngBook"],compile:function(e,g){var d=a(g.ngBookField),l=a(g.ngBookFieldCard);return function(a){var e=d(a),g=e.customField,h=l(a),p=b.Booking.customFieldInstanceKey(e,h);null!==e.effectiveDefaultValue&&!f.isCustomFieldPopulated(p)&&b.CustomField.isValidRawValue(e.customField,e.effectiveDefaultValue)&&(a.bookCtrl.newBooking[p]=e.effectiveDefaultValue);f.populatedCustomField(p);_.contains(["full name","name"],g.name.toLowerCase())&&a.$watch(function(){return a.bookCtrl.newBooking[p]},function(b,
d){var c=a.bookCtrl.newBooking["contact-name"];if(!c||c===d)a.bookCtrl.newBooking["contact-name"]=b})}}}}]);h.directive("ngBookFieldPreview",["$parse","models",function(a,b){return{restrict:"A",compile:function(f,e){var g=a(e.ngBookFieldPreview),d=a(e.ngBookFieldPreviewModel);return function(a){var e=g(a),f=e.customField||e||null;f&&null!==e.effectiveDefaultValue&&b.CustomField.isValidRawValue(f,e.effectiveDefaultValue)&&d.assign(a,e.effectiveDefaultValue)}}}}]);h.directive("ngBookNotification",["$compile",
"$parse","$templateCache","controllers","models","plusbook","rebook",function(a,b,f,e,g,d,l){return{restrict:"A",require:["?^ngBook","ngBookNotification"],scope:!0,controller:["$scope","$attrs",function(a,e){var f=this;f.isSubjectEditable=!1;var h=a.isSet(e.ngBookNotificationCart),p=b(e.ngBookNotification);f.update=function(){var b=h?g.Notification.ORDER_CONFIRMATION_TYPE:g.Notification.BOOKING_CONFIRMATION_TYPE,c=p(a);_.extend(c,{"notification-type":b,"notification-note":""});l.currentBooking?(b=
g.Notification.BOOKING_REBOOKED_TYPE,_.extend(c,{"notification-type":b,"notification-emails":l.currentBooking.contact.email,"contact-language":l.currentBooking.contact.language})):d.currentContact&&_.extend(c,{"notification-emails":d.currentContact.email,"contact-language":d.currentContact.language})};f.updateEmail=function(b){var d=p(a);d["notification-emails"]=b;b||(d.sendNotification=!1)};f.updatePhone=function(){var b=p(a),d=b["contact-phone"],c=b["contact-phoneCountry"];if(!d||!g.SmsNotification.isEligiblePhoneNumber(d,
c,a.company))b.isSmsEnabled=!1};a.$watch(function(){return p(a)["contact-email"]},function(a){f.updateEmail(a)});a.$watch(function(){return p(a)["contact-phone"]},function(){f.updatePhone()});a.$watch(function(){return p(a)["contact-phoneCountry"]},function(){f.updatePhone()});a.$on("$destroy",function(){p(a)["notification-emails"]=""})}],compile:function(b,d){var c=f.get("book.notification"),l=a(c);return{pre:function(a,b,d,c){a.bookNotificationCtrl=c[1]},post:function(a,b,d){a.bookNotificationCtrl.update();
a.isSet(d.ngBookNotificationAnonymous)||l(a,function(a){b.append(a)});a.bookCtrl&&(d=a.bookCtrl.newBookingOptions.currentAffiliation,e.cannedMessagesController(a,{modelKey:"newBooking",noteField:"notification-note",languageKey:"contact-language",types:g.CannedMessage.BOOKING_TYPES,company:d?d.affiliateCompany:void 0}))}}}}}]);h.directive("ngBookPolicies",["db",function(a){return{restrict:"A",templateUrl:"book.policies",require:["ngBookPolicies"],scope:!0,controller:["$scope","$attrs",function(b,f){var e=
this;e.company=b.$eval(f.ngBookPolicies);e.loadingPolicies=!1;e.showingCompanyPolicies=!1;e.showingFareHarborPolicies=!1;e.fareHarborTosSafeHtml="";e.showCompanyPolicies=function(){e.showingCompanyPolicies=!0;e.showingFareHarborPolicies=!1};e.showFareHarborPolicies=function(){e.showingCompanyPolicies=!1;e.showingFareHarborPolicies=!0;if(!e.fareHarborTosSafeHtml){var b=a.companies.admin();b.$promise.then(function(){e.fareHarborTosSafeHtml=b.tosSafeHtml},function(){e.fareHarborTosSafeHtml="Unable to load. Please refresh the page."})}};
e.hidePolicies=function(){e.showingCompanyPolicies=!1;e.showingFareHarborPolicies=!1}}],controllerAs:"bookPoliciesCtrl"}}]);h.directive("ngPrevalidateCustomField",["$parse","db","require","rebook",function(a,b,f,e){return{restrict:"A",require:"ngModel",compile:function(g,d){var l=a(d.ngModel),m=a(d.ngPrevalidateCustomField);return function(a,d,g,h){f.inScope(a,"customField");f.inScope(a,"customFieldPricing");a.prevalidity=null;var r=d.closest(".the-field"),t=function(b,d){var c=m(a);c.prevalidity=
c.prevalidity||{};c.prevalidity[g.name]=b;a.prevalidity=b;r.toggleClass("ng-prevalid",!(!b||!d));r.toggleClass("ng-preinvalid",!d);r.removeClass("ng-prevalidating");h.$setValidity("prevalidity",d)},v;d=_.debounce(_.bind(a.$safeApply,a,function(){var d=a.availability||(a.booking?a.booking.availability:null);if(a.customFieldPricing&&a.customFieldPricing.sheet&&d){r.addClass("ng-prevalidating");var f=l(a);v&&v.cancel&&(v.cancel(),v=null);f?(v=b.customField.prevalidate({shortname:a.customField.company.shortname,
customFieldPk:a.customField.pk,totalSheetPk:a.customFieldPricing.sheet.pk,availabilityPk:d.pk},{value:f,rebookingPk:e.currentBooking?e.currentBooking.pk:null},null,{},{ignoreInFlight:!0,ignoreCache:!0}).$promise,v.then(function(a){a!==b.CANCELLED&&(a=a.primaryData,t(a,a.isValid))},function(){t(null,!1)})):t(null,!0)}}),250);a.$watch(l,d);a.$watch(_.bind(_.propertyOf(a),a,"customFieldPricing.sheet"),d);d()}}}}]);h.controller("book.LiveCapacityCtrl",["$scope","$attrs","$q","db","rebook",function(a,
b,f,e,g){var d=this;d.status="loading";d.isLarge=""===b.ngLiveCapacityLarge||a.isLarge;b=e.availability({shortname:a.availability.item.company.shortname,itemPk:a.availability.item.pk,availabilityPk:a.availability.pk},null,null,null,{tagAlong:!0});d.liveCapacity=e.availability.liveCapacity({shortname:a.availability.item.company.shortname,itemPk:a.availability.item.pk,availabilityPk:a.availability.pk},null,null,{rebooking:g.currentBooking?g.currentBooking.pk:""});f.all({availability:b.$promise,liveCapacity:d.liveCapacity.$promise}).then(function(a){a.availability!==
e.CANCELLED&&a.liveCapacity!==e.CANCELLED&&(d.status="success")},function(){d.status="error"})}]);h.directive("ngLiveCapacity",[function(){return{restrict:"A",templateUrl:"book.liveCapacity",scope:{availability:"=ngLiveCapacity",isLarge:"=ngLiveCapacityLarge"},controller:"book.LiveCapacityCtrl",controllerAs:"liveCapacityCtrl"}}]);h.directive("ngStoredValueCardSearch",["$parse","db","require",function(a,b,f){return{restrict:"A",require:"ngModel",compile:function(e,g){var d=a(g.ngModel);return function(a,
e,g,n){f.inScope(a,"redeemCtrl");var h,p=function(b,d,c){h=null;a.redeemCtrl.update(b,d);a.redeemCtrl.status=c?"success":"not-found";n.$setValidity("search",!!d)};e=_.debounce(_.bind(a.$safeApply,a,function(){var e=d(a);h&&h.cancel&&(h.cancel(),h=null);if(e)if(e===a.redeemCtrl.storedValueCardNumber)p(e,a.redeemCtrl.storedValueCard,!!a.redeemCtrl.storedValueCard);else{a.redeemCtrl.status="loading";var f=b.storedValueCards.search({shortname:a.redeemCtrl.company.shortname},null,null,{q:e});h=f.$promise;
h.then(function(a){a!==b.CANCELLED&&p(e,f.storedValueCard,!0)},function(){p(e,null,!1)})}else p("",null,!0)}),250);a.$watch(d,_.ary(e,0))}}}}]);h.directive("ngCardGenerator",["$parse","auth","convert","models","toggles","rebook","require",function(a,b,f,e,g,d,l){return{restrict:"A",controller:["$scope","$attrs",function(b,c){var n=this;l.inScope(b,"customField","ng-card-generator");var h=a(c.ngCardGenerator);n.isSelected=!1;n.toggleValue="customAmount-"+b.$id;n.suggestedAmounts=e.CustomField.suggestedAmounts(b.customField);
var p=n.suggestedAmounts[0];n.selectedAmount="";n.selectAmount=function(a){n.selectedAmount=a||0;n.isSelected=!!a;g.toggle(n.toggleValue,!1)};n.minimumAmount=100;var r=n.suggestedAmounts[0],t="",v="",y=h(b),q;n.isAlreadyGenerated=!1;d.currentBooking?(y=y||{},q=y.amount||0,y.isAlreadyGenerated&&0<q?(n.isSelected=!0,n.selectedAmount=q,n.name=y.name||"",n.email=y.email||"",n.isAlreadyGenerated=!0):d.currentBooking.generatedStoredValueCards.length||(r=d.currentBooking.receipt.gross,t=d.currentBooking.contact.name,
v=d.currentBooking.contact.email)):_.isString(y)&&(y=_.parseJSON(y)||{},q=y.amount||0,n.isSelected=0<q,n.selectedAmount=q,n.name=y.name||"",n.email=y.email||"",_.contains(n.suggestedAmounts,n.selectedAmount)||(r=n.selectedAmount,n.defaultToOther=!0));b.$watch("customFieldPricing.visibility.isRequired",function(a){a&&(n.isSelected=!0,n.selectedAmount||n.selectAmount(p))});b.$watch("cardGeneratorCtrl.isSelected",function(a){a&&!n.selectedAmount?n.selectAmount(p):a||n.selectAmount()});b.$watch(_.bind(g.state,
g,n.toggleValue),function(a){a&&(n.selectedAmount=r,n.name=n.name||t,n.email=n.email||v)});b.$watch(function(){return{amount:n.selectedAmount,name:n.name,email:n.email,isAlreadyGenerated:n.isAlreadyGenerated}},function(a){h.assign(b,_.stringifyJSON(f.clientRequest(a)))},!0)}],controllerAs:"cardGeneratorCtrl"}}]);h.directive("ngItemRatings",["db","require",function(a,b){return{templateUrl:"book.itemRatings",scope:!0,controllerAs:"itemRatingsCtrl",controller:["$scope",function(f){b.inScope(f,"item",
"ngItemRatings");this.ratings=a.item.ratings({shortname:f.item.company.shortname,itemPk:f.item.pk})}]}}]);h.directive("ngItemRatingNudges",function(){return{templateUrl:"ng-item-rating-nudges",scope:!0,controllerAs:"itemRatingNudgesCtrl",controller:["$scope","db","require",function(a,b,f){f.inScope(a,"item","ngItemRatingNudges");this.ratings=b.item.ratings({shortname:a.item.company.shortname,itemPk:a.item.pk});this.MINIMUM_COUNT=b.slipstream("isDebug")?1:100}]}});h.directive("ngSuggestedItems",["db",
"models",function(a,b){return{templateUrl:"ngSuggestedItems",scope:!0,controllerAs:"suggestedItemsCtrl",controller:["$scope","$attrs",function(f,e){var g=this,d=f.$eval(e.ngSuggestedItems);g.flowNode=a.flowNode({shortname:d.company.shortname,flowNodePk:d.pk},null,null,null,{tagAlong:!0});var l=function(a){return _.reject(g.children,function(b){return _.contains(a,b.item)})};g.flowNode.$promise.then(function(){g.children=b.FlowNode.effectiveChildren(g.flowNode);var a;if(!g.flowNode.isSelectedItemsIncluded)if(e.ngSuggestedItemsCartEntries)f.$watchCollection(e.ngSuggestedItemsCartEntries,
function(a){a=_.pluck(a,"availability.item");g.children=l(a)});else if(e.ngSuggestedItemsBooking){a=f.$eval(e.ngSuggestedItemsBooking);var d=b.Booking.itemsInOrder(a);g.children=l(d)}g.notesSafeHtml=e.ngSuggestedItemsBooking?g.flowNode.postCheckoutNotesSafeHtml:g.flowNode.preCheckoutNotesSafeHtml;a?g.targetDate=a.availability.startAt:f.cart&&f.entry&&(g.targetDate=f.entry.availability.startAt)})}]}}]);h.directive("ngSuggestedItemsSlider",[function(){return{scope:!0,link:function(a,b){var f=b.find(".suggested-items-scroller"),
e,g,d,l=function(){e=f.scrollLeft();g=0<e;d=f[0].scrollWidth-e>f.outerWidth();b.find(".suggested-items-arrow-left").toggleClass("shown",g);b.find(".suggested-items-arrow-right").toggleClass("shown",d)};_.delay(l,100);f.scroll(_.debounce(l,100,{leading:!0}));a.$watch("dimensions.width",l);a.scroll=_.debounce(function(a){e=f.scrollLeft();var d=b.find(".suggested-item").outerWidth();f.animate({scrollLeft:"left"===a?e-d:e+d},150)},100,{leading:!0})}}}]);h.directive("ngBookNoisyInvalidFields",[function(){return{templateUrl:"book.noisy",
scope:!0,controllerAs:"bookNoisyInvalidFieldsCtrl",controller:["$scope","$attrs",function(a,b){var f=this;f.isShowingAllowed=!1;a.$watch(b.ngBookNoisyInvalidFields,function(a){f.isShowingAllowed=!!a})}]}}]);h.directive("ngBookResourceOverview",["navigation","require",function(a,b){return{templateUrl:"book.resourceOverview",scope:!0,require:["^ngBook","ngBookResourceOverview"],controllerAs:"resourceOverviewCtrl",controller:["$scope",function(a){var e=this;b.inScope(a,"bookCtrl","resourceOverviewCtrl");
b.inScope(a,"availability","resourceOverviewCtrl");a.bookCtrl.attachControl("resourceOverviewCtrl",e);e.$id=a.$id;e.resourceUseData=e.bookCtrl.resourceUseData;e.reset=function(){e.resourceUseData.clearSelections()};e.isOverusing=function(){return e.bookCtrl.bookCountsCtrl.liveCapacity.isOverusingResources};e.shouldShowResourcesDropdown=function(){return 0<e.useCount()&&0<e.bookCtrl.bookCountsCtrl.customerCount};e.useCount=function(){return parseFloat(_.sum(e.bookCtrl.bookCountsCtrl.liveCapacity.proposedResourceUseSummaries,
"totalUseCount").toFixed(2))};e.isPreselecting=e.resourceUseData.isPreselecting;e.resourceUseData.fetchApplicableRequirements(a.availability,e.bookCtrl.bookCountsCtrl.visibleCustomerTypeRates).then(function(a){e.requirements=a})}]}}]);h.directive("ngResourceUseTable",[function(){return{templateUrl:"resourceUseTable",scope:{resourceUses:"=",toResourceUses:"=",unsatisfiableResources:"="},controller:["$scope","models",function(a,b){var f=function(e,f){var d=b.ResourceUse.resourceUseSummaries(e,a.unsatisfiableResources),
l=b.ResourceUse.resourceUseSummaries(f,a.unsatisfiableResources),m=_.reduce(_.assign({},d,l),function(a,b,c){var e=d[c];b.originalUseCount=e?e.totalUseCount:0;e&&!(c in l)&&(b.totalUseCount=0);a[c]=b;return a},{});return _.sortBy(m,"resourceName")};a.resourceUseSummaries=f(a.resourceUses,a.toResourceUses);a.isShowOverused=function(){return _.isArray(a.unsatisfiableResources)};a.$watchGroup(["resourceUses","toResourceUses"],function(b){a.resourceUseSummaries=f(b[0],b[1])})}]}}]);h.directive("ngSelectedResources",
["db","models","navigation","require",function(a,b,f,e){return{templateUrl:"selectedResources",scope:{availability:"=",requirements:"=",reset:"&",selections:"="},controllerAs:"selectedResourcesCtrl",controller:["$scope",function(a){this.isUsingDefaults=function(b){var c=_.pluck(b.resourceRequirements,"pk");return b.isSplittable?!_.any(a.selections.selectedSplittableRequirementsResources,function(a,b){if(_.includes(c,parseInt(b))&&a)return!0}):!_.any(_.keys(a.selections.selectedNonSplittableRequirementsResources),
function(a){return parseInt(a)===b.pk})}}]}}]);h.directive("ngFlowBreadcrumbs",["$timeout","$q","require","flows","models",function(a,b,f,e,g){return{templateUrl:"ng-flow-breadcrumbs",controllerAs:"breadcrumbsCtrl",require:"ngFlowBreadcrumbs",controller:["$scope","$attrs",function(a,l){var m=this;f.inScope(a,"company","ngFlowBreadcrumbs");m.flowNode=a.$eval(l.ngFlowBreadcrumbs);m.item=a.$eval(l.ngFlowBreadcrumbsItem);m.clickCallback=a.$eval(l.ngFlowBreadcrumbsClickCallback)||_.ignore;var k=a.$eval(l.ngFlowBreadcrumbsMinBreadcrumbs)||
1;m.flowNode||(m.flowNode=e.currentFlowNodeFromCache(a.company.shortname));m.showBreadcrumbs=!1;m.showBackButton=!1;b.when(m.flowNode.$promise).then(function(){if(m.flowNode!==g.FlowNode.NO_FLOW&&(m.breadcrumbs=_.clone(m.flowNode.breadcrumbs),!g.FlowNode.singleItemRedirect(m.flowNode)&&m.item&&m.breadcrumbs.push(m.flowNode),m.showHomeButton=e.showInitialFlowNodeLink(m.flowNode),!(m.breadcrumbs.length<k)||m.showHomeButton))m.lastBreadcrumb=_.last(m.breadcrumbs),g.FlowNode.isSingleLevelFlow(m.flowNode)?
m.showBackButton=!0:m.showBreadcrumbs=!0})}],link:function(d,e,f,g){b.when(g.flowNode.$promise).then(function(){a(function(){var a=e.find(".js-breadcrumb-links");g.isOverflowing=a.length&&0<a.position().top})})}}}])})();
(function(){var h=angular.module("book.services",["auth.services","db.services","lib.services","tracking.services"]);h.factory("resourceUseData",["$q","auth","db","models",function(b,a,c,f){return function(a){var g={selectedSplittableRequirementsResources:{},selectedNonSplittableRequirementsResources:{}};g.isPreselecting=!!a;var d=function(a,b){return _.any(b.customerPrototypeRequirements,function(b){return _.any(a,function(a){return a.customerPrototype===b.customerPrototype})})},l=function(a,b){return 1<
b.resourceRequirements.length&&(b.type===f.Requirement.BOOKING_TYPE||d(a,b)||0===b.customerPrototypeRequirements.length)};g.clearSelections=function(){_.clear(g.selectedNonSplittableRequirementsResources);_.clear(g.selectedSplittableRequirementsResources)};var m,k;g.fetchApplicableRequirements=function(d,f){if(!d.requirementGroup)return b.when([]);m||(m=c.requirementGroup({shortname:d.company.shortname,requirementGroupPk:d.requirementGroup.pk}),k=m.$promise);return k.then(function(){var b=_.filter(m.requirements,
_.partial(l,f));a&&(_.forEach(b,function(b){_.forEach(b.resourceRequirements,function(d){d.resource.pk===a&&(b.isSplittable?g.selectedSplittableRequirementsResources[d.pk]=!0:g.selectedNonSplittableRequirementsResources[b.pk]=d.pk)})}),a=null,g.isPreselecting=!1);return b})};g.fetchReappliedBooking=function(a,b,d){var e=c.resourceUses.reapplyBookingResourceUses({shortname:a.availability.item.company.shortname,bookingUuid:a.uuid},{customerTypeRateCounts:_.stringifyJSON(b),selectedResourceRequirements:g.selectedResourceRequirementPks(),
isDryRun:!0,totalSheet:d});return e.$promise.then(function(){return e})};g.selectedResourceRequirementPks=function(){var a=_.values(g.selectedNonSplittableRequirementsResources);_.ref.append(a,_.choose(g.selectedSplittableRequirementsResources,function(a,b){if(a)return b}));return a.join(",")};return g}}]);h.factory("redeemController",["auth","models","require",function(b,a,c){return function(f,e){c.defined(e,"company","redeemController");c.defined(e,"amountDue","redeemController");f.redeemCtrl={status:"success",
storedValueCard:null,storedValueCardNumber:"",company:e.company,gross:"",amountDue:e.amountDue};f.redeemCtrl.isBalanceInsufficientDueToPermissions=function(){if(b.permissions.can("createPartial",a.Payment,f.redeemCtrl.company))return!1;var c=f.redeemCtrl.storedValueCard;return c&&c.availableBalance<f.redeemCtrl.amountDue()};f.redeemCtrl.max=function(){return f.redeemCtrl.storedValueCard?Math.min(f.redeemCtrl.amountDue(),f.redeemCtrl.storedValueCard.availableBalance):f.redeemCtrl.amountDue()};f.redeemCtrl.min=
function(){return 1};f.redeemCtrl.isValid=function(){return!f.redeemCtrl.storedValueCard||!f.redeemCtrl.storedValueCard.balance||0>=f.redeemCtrl.storedValueCard.availableBalance||f.redeemCtrl.isBalanceInsufficientDueToPermissions()?!1:!0};f.redeemCtrl.update=function(a,b){f.redeemCtrl.storedValueCardNumber=a;f.redeemCtrl.storedValueCard=b;if(f.redeemCtrl.storedValueCard){var c=f.redeemCtrl.storedValueCard.balance,c=Math.min(c,f.redeemCtrl.max()),c=Math.max(c,f.redeemCtrl.min());f.redeemCtrl.gross=
c}else f.redeemCtrl.gross=""};window.$$redeemCtrl=f.redeemCtrl}}]);h.factory("redeemStoredValueCardsController",["db","models","require","toggles","tracking",function(b,a,c,f,e){return function(g,d){c.defined(d,"company","redeemStoredValueCardsController");c.defined(d,"modelKey","redeemStoredValueCardsController");c.defined(d,"price","redeemStoredValueCardsController");c.defined(d,"tax","redeemStoredValueCardsController");c.defined(d,"toggleName","redeemStoredValueCardsController");var l=T("This gift card is already applied"),
m=T("This gift card has already been redeemed"),k=T("This gift card could not be applied. Please check that the information you entered is correct."),n=T("This gift card was not successfully applied, please try again");g.isSet(d.modelKey)||_.set(g,d.modelKey,{});g.redeemStoredValueCardsCtrl={currentStoredValueCardNumber:"",error:"",storedValueCards:[]};var h={},p=function(){g[d.modelKey]["payments-isRedeeming"]=g.redeemStoredValueCardsCtrl.isRedeeming();var a=g[d.modelKey],b;g.redeemStoredValueCardsCtrl.isRedeeming()?
(b=_.pluck(g.redeemStoredValueCardsCtrl.storedValueCards,"number"),b=_.stringifyJSON(b)):b="";a["payments-redeem-storedValueCardNumbers"]=b;g[d.modelKey]["payments-redeem-redeemAmounts"]=g.redeemStoredValueCardsCtrl.isRedeeming()?_.stringifyJSON(h):""},r=function(){_.clear(h);var a=d.price();c.assert(_.isNumber(a),"redeemStoredValueCardsController.updateAppliedAmounts: price must be a number");var b=d.tax();c.assert(_.isNumber(b),"redeemStoredValueCardsController.updateAppliedAmounts: tax must be a number");
var e=a+b,f=0;_.forEach(g.redeemStoredValueCardsCtrl.storedValueCards,function(a){var b=Math.min(e-f,a.balance);h[a.uri]=b;f+=b})},t=function(a,b){var c={company:d.company.shortname};d.availability&&(c.availability=d.availability.pk,c.item=d.availability.item.name);_.isUndefined(b)||(c=_.extend(c,b));e.track(g,a,c)};g.redeemStoredValueCardsCtrl.apply=function(c){c.$submitting=!0;g.redeemStoredValueCardsCtrl.error="";var e=g.redeemStoredValueCardsCtrl.currentStoredValueCardNumber,h=b.storedValueCards.search({shortname:d.company.shortname},
null,null,{q:e});h.$promise.then(function(){c.$submitting=!1;var a=h.storedValueCard;_.contains(g.redeemStoredValueCardsCtrl.storedValueCards,a)?g.redeemStoredValueCardsCtrl.error=l:a.balance?(g.redeemStoredValueCardsCtrl.storedValueCards.push(a),r(),p(),g.redeemStoredValueCardsCtrl.currentStoredValueCardNumber="",f.toggle(d.toggleName,!1),t("valid-gift-card")):g.redeemStoredValueCardsCtrl.error=m},function(b){c.$submitting=!1;404===(b?b.status:void 0)?(g.redeemStoredValueCardsCtrl.error=k,t("invalid-gift-card",
{number:e,isRegexMatch:a.StoredValueCard.isNumberValid(e)})):g.redeemStoredValueCardsCtrl.error=n})};g.redeemStoredValueCardsCtrl.unapply=function(a){_.ref.remove(g.redeemStoredValueCardsCtrl.storedValueCards,a);r();p()};g.redeemStoredValueCardsCtrl.cancel=function(){g.redeemStoredValueCardsCtrl.currentStoredValueCardNumber="";g.redeemStoredValueCardsCtrl.error="";f.toggle(d.toggleName,!1)};g.redeemStoredValueCardsCtrl.applied=function(a){return h[a.uri]||0};g.redeemStoredValueCardsCtrl.totalApplied=
function(){return _.sum(_.values(h))};g.redeemStoredValueCardsCtrl.isInvalid=function(){return!g.redeemStoredValueCardsCtrl.currentStoredValueCardNumber.trim()};g.redeemStoredValueCardsCtrl.isRedeeming=function(){return!!g.redeemStoredValueCardsCtrl.storedValueCards.length};g.$watch(d.price,function(){r();p()})}}]);h.factory("paymentController",["$q","$timeout","$window","auth","cardflight","db","emv","events","localization","models","native","navigation","processors","Raven","rebook","require",function(b,
a,c,f,e,g,d,l,m,k,n,h,p,r,t,v){var y={SKIP_KIND:"skip",DEFER_KIND:"defer",PARTIAL_KIND:"partial",FULL_KIND:"full"},q={NONE_OPTION:"",AFFILIATE_OPTION:"affiliate",IN_STORE_OPTION:"in-store",CHARGE_OPTION:"charge",EMV_OPTION:"emv",CARD_ON_FILE_OPTION:"card-on-file",FILE_OPTION:"file",IDEAL_OPTION:"ideal",SOFORT_OPTION:"sofort"},B=[q.IDEAL_OPTION,q.SOFORT_OPTION],u=[q.IDEAL_OPTION,q.SOFORT_OPTION],z="cardholdersName cardNumber cardExpiryMonth cardExpiryYear cardCvc postalCode countryCode cardLast4".split(" "),
C=["cardNumber","cardExpiryMonth","cardExpiryYear","cardCvc"],F=_.append(z,"tokenizationType cardOnFileName cardType cardToken gross bookingFee isCollectedByAffiliate option kind filePayment cardOnFile inStorePaymentType inStorePaymentNote isDemo note".split(" ")),x=function(c,r){v.defined(r,"modelKey");v.defined(r,"company");v.defined(r,"gross");v.defined(r,"bookingFee");v.defined(r,"invoicePrice");v.defined(r.company,"isDemoModeEnabled");r.isDemo=_.isUndefined(r.isDemo)?r.company.isDemoModeEnabled:
r.isDemo;v.defined(r,"isCompany");v.defined(r,"isAffiliate");v.defined(r,"isAnonymous");v.assert(r.isCompany||r.isAffiliate||r.isAnonymous,"paymentCtrl: expected creator type");v.assert(!r.booking||!r.order,"paymentCtrl: expected either booking, order, or none");r.isTakeRequired=r.isTakeRequired||!1;r.isInfoRequired=r.isInfoRequired||!1;r.isPostalCodeRequired=r.isPostalCodeRequired||!1;r.orderBookingGross=r.orderBookingGross||null;r.bookingGrosses=r.bookingGrosses||function(){return{}};c.paymentCtrl=
_.extend({card:{},company:r.company,booking:r.booking,order:r.order,target:r.booking||r.order||null,isAnonymous:r.isAnonymous,takenAmount:"",optionAndExtras:"",isPostalCodeRequired:r.isPostalCodeRequired},q,y);c[r.modelKey]=c[r.modelKey]||{};var x=function(a){return!r.fieldPrefix?a:r.fieldPrefix+"-"+a},K=function(a,b){var d=c[r.modelKey],e=x(a);_.isUndefined(b)||(d[e]=b);return d[e]},H=function(a){var b={};_.forEach(a,function(a,d){b[x(d)]=a});return b};_.forEach(F,function(a){c.paymentCtrl[a]=function(b){return K(a,
b)}});var L=function(){_.forEach(C,function(a){var b=K(a);_.isUndefined(b)||K(a,p.secretField(b))})},E=function(a){_.forEach(a,function(a,b){K(b,a)})},N=function(){return r.isAnonymous&&m.browser.ACCEPT_LANGUAGE_COUNTRY_CODE?m.browser.ACCEPT_LANGUAGE_COUNTRY_CODE:r.company.processorCountry};c.paymentCtrl.chargeDefaults=function(a){var b={cardNumber:"",cardExpiryMonth:"",cardExpiryYear:"",cardCvc:"",countryCode:N(),postalCode:"",isDemo:r.isDemo,tokenizationType:"stripe-js"};return _.extend(H(b),a||
{})};c.paymentCtrl.isCvcOverridden=!1;c.paymentCtrl.overrideCvc=function(){f.permissions.can("createWithoutCVC",k.Payment,r.company)&&(c.paymentCtrl.isCvcOverridden=!0)};c.paymentCtrl.swiping=!1;c.paymentCtrl.showingSwipe=r.swipe||!1;c.paymentCtrl.swiped=!1;c.paymentCtrl.testNative=function(){c.$safeApply(function(){l.broadcast("fareharbor.native.tokenizedCard",{token:"test_12345",last4:"4242",fullName:"Tommy O'Testerson",cardType:"unknown"})})};c.paymentCtrl.startSwiping=function(){n.isNative?n.broadcast("fareharbor.native.tokenizeCard",
{isDemo:K("isDemo")}):c.paymentCtrl.swiping=!0};c.paymentCtrl.stopSwiping=function(){c.paymentCtrl.swiping=!1;c.paymentCtrl.swiped=!1;c.paymentCtrl.cardToken("");c.paymentCtrl.cardType("");c.paymentCtrl.cardLast4("");c.paymentCtrl.tokenizationType("")};c.paymentCtrl.swipeComplete=function(a){c.paymentCtrl.stopSwiping();a&&(c.paymentCtrl.cardNumber(a.number),c.paymentCtrl.cardExpiryMonth(a.expiryMonth),c.paymentCtrl.cardExpiryYear(a.expiryYear),a.fullName&&c.paymentCtrl.cardholdersName(a.fullName),
l.broadcast("lib.shared.PaymentCtrl.swipe",a),c.paymentCtrl.swiped=!0)};l.on(c,"fareharbor.native.tokenizedCard",function(a,b){c.paymentCtrl.cardToken(b.token);c.paymentCtrl.cardLast4(b.last4);c.paymentCtrl.cardholdersName(b.fullName);c.paymentCtrl.cardType(b.cardType);c.paymentCtrl.tokenizationType("card-flight");l.broadcast("lib.shared.PaymentCtrl.swipe",{fullName:b.fullName});c.paymentCtrl.swiped=!0});l.on(c,"fareharbor.native.tokenizeCancelled",function(a,b){c.paymentCtrl.stopSwiping()});var I=
{};c.paymentCtrl.saveCard=function(){_.overwrite(I,_.pick(c[r.modelKey],_.map(z,x)))};c.paymentCtrl.restoreCard=function(){c.paymentCtrl.isPreselecting=!1;_.extend(c[r.modelKey],I)};var D=function(a,b){if(!a.all.$error||!a.all.$error.$tokenization)a.all.$error.$tokenization=[];!b&&(!a.all.$error.$tokenization.length&&!a.all.$error.$providerDeclined)&&(b=p.ERRORS.REFRESH_CARD);b&&a.all.$error.$tokenization.push(b)};c.paymentCtrl.completeClientAction=function(a,d){var e=d.clientAction.token,f=d.clientAction.isDefer;
delete d.clientAction;a.$submitting=!0;return p.get(c.paymentCtrl.company.defaultProcessorType).completeClientAction(r.company,e,f,r.isDemo).then(function(a){E(a)},function(d){D(a,d);return b.reject()})};c.paymentCtrl.createToken=function(a,g,l){J=!1;g=g||_.ignore;l=l||_.ignore;var m=p.get(c.paymentCtrl.company.defaultProcessorType);a.all||(a.all={});a.all.$error={$tokenization:[],$providerDeclined:!1};var n=function(){D(a);return l()};if(t.currentBooking||!ea()&&!P())return L(),_.contains(B,c.paymentCtrl.option())&&
E({processorType:m.PROCESSOR_TYPE}),g();if(P()){L();var h=function(){v.assert(0===c.paymentCtrl.bookingFee(),"paymentCtrl: expected no booking fee for EMV");var a=c.paymentCtrl.amount();return _.roundHalfToEven(c.paymentCtrl.company.processingFeeRate*a)+c.paymentCtrl.company.processingFlatFee};if(c.paymentCtrl.target){if(0!==c.paymentCtrl.bookingFee())return console.error("paymentCtrl: expected no booking fee"),D(a,p.ERRORS.REFRESH),n();var s=c.$on("$destroy",function(){d.cancel()});d.charge(c.paymentCtrl.company,
c.paymentCtrl.target,c.paymentCtrl.amount(),r.bookingGrosses(),h()).then(function(a){a=m.chargedCard(a);E(a);J=!0;"US"===c.paymentCtrl.company.country&&(J=!1);return g()},function(b){d.lastDecline()&&(a.all.$error.$providerDeclined=!0);b&&D(a,b);return n()}).finally(function(){c.$apply();s()})}else return L(),E({processorType:m.PROCESSOR_TYPE}),g()}else if(h=c.paymentCtrl.cardToken()){L();var q=b.defer();q.resolve(h);q=q.promise;e.isTestToken(h)&&(q=m.testToken(c.paymentCtrl.company,{testToken:h}));
q.then(function(a){a=m.tokenizedCard(a);E(a);return g()})}else{var u=c.paymentCtrl.cardNumber();if(c.paymentCtrl.isDemo()&&!k.Payment.isDemoCardNumber(u))return D(a,p.ERRORS.INVALID_DEMO_CARD_NUMBER),n();h={number:u,expirationMonth:c.paymentCtrl.cardExpiryMonth(),expirationYear:c.paymentCtrl.cardExpiryYear()};if(q=c.paymentCtrl.cardCvc())h.cvc=q;else if(!f.permissions.can("createWithoutCVC",k.Payment,c.paymentCtrl.company))return D(a,p.ERRORS.INVALID_SECURITY_CODE),n();if(q=c.paymentCtrl.cardholdersName())h.name=
q;var q=K("countryCode"),y=K("postalCode"),z=q&&y&&k.Payment.needsPostalCode(q);h.countryCode=q;z&&(h.postalCode=y);q=_.omit(c[r.modelKey],_.map(C,x));q={company:c.paymentCtrl.company.shortname,cardLast4:p.cardLast4(u),cardType:p.cardType(u),modelData:q,modelKey:r.modelKey};c.paymentCtrl.booking&&(q.bookingUri=c.paymentCtrl.booking.uri);c.paymentCtrl.order&&(q.orderUri=c.paymentCtrl.order.uri);m.tokenizeCard(c.paymentCtrl.company,h,r.isDemo,q).then(function(a){c.paymentCtrl.cardLast4(p.cardLast4(u));
c.paymentCtrl.cardType(p.cardType(u));c.paymentCtrl.tokenizationType()||c.paymentCtrl.tokenizationType("stripe-js");L();E(a);return g()},function(b){_.forEach(b,function(b){D(a,b)});return n()})}};c.paymentCtrl.affiliation=r.affiliation||_.constant(null);c.paymentCtrl.inStorePaymentTypes=_.isUndefined(r.inStorePaymentTypes)?[]:k.InStorePaymentType.isVisibleWhenCollectedByCharter(r.inStorePaymentTypes);c.paymentCtrl.affiliateInStorePaymentTypes=[];c.paymentCtrl.cardsOnFile=[];c.paymentCtrl.cardPayments=
_.toArray(r.cardPayments);c.paymentCtrl.cardTypeAbbreviation=function(){var a=c.paymentCtrl.cardType();a||(a=p.cardType(c.paymentCtrl.cardNumber()));return p.cardTypeAbbreviation(a)};c.paymentCtrl.invoicePrice=function(){return r.invoicePrice?r.invoicePrice():0};c.paymentCtrl.amountMax=function(){return r.gross()+r.bookingFee()};c.paymentCtrl.amountMin=function(){return c.paymentCtrl.needsCharge()?k.Payment.MIN_CHARGE_AMOUNT:1};c.paymentCtrl.orderAmountMin=function(){return 0};var Z=function(){var a=
c.paymentCtrl.affiliation(),b=r.invoiceRelationship?r.invoiceRelationship():"";return a&&c.paymentCtrl.isCollectedByAffiliate()&&b===k.InvoiceSheet.AFFILIATE_RELATIONSHIP&&(a=r.invoicePrice?r.invoicePrice():0)&&a<=c.paymentCtrl.amountMax()?{isInvoicePrice:!0,gross:a,bookingFee:0}:{isInvoicePrice:!1,gross:r.gross(),orderBookingGross:r.orderBookingGross,bookingFee:r.bookingFee()}};c.paymentCtrl.isDefaultAmountInvoicePrice=function(){return Z().isInvoicePrice};c.paymentCtrl.defaultAmount=function(){var a=
Z();return a.gross+a.bookingFee};c.paymentCtrl.defaultGross=function(){return Z().gross};c.paymentCtrl.defaultOrderBookingGross=function(a){return Z().orderBookingGross(a)};c.paymentCtrl.amount=function(){return c.paymentCtrl.gross()+c.paymentCtrl.bookingFee()};c.paymentCtrl.isAmountTooLow=function(){return c.paymentCtrl.needsCharge()?c.paymentCtrl.amount()<k.Payment.MIN_CHARGE_AMOUNT:c.paymentCtrl.needsPayment()?!c.paymentCtrl.amount():!1};c.paymentCtrl.monthName=function(){var a=parseInt(c.paymentCtrl.cardExpiryMonth(),
10)-1;return isNaN(a)?"":moment().month(a).format("MM - MMMM")};c.paymentCtrl.year=function(){return parseInt(c.paymentCtrl.cardExpiryYear(),10)};var ia=function(a){return a===c.paymentCtrl.PARTIAL_KIND||a===c.paymentCtrl.FULL_KIND};c.paymentCtrl.needsPayment=function(){return!c.paymentCtrl.isCurrentOptionValid()?!1:ia(c.paymentCtrl.kind())};var J=!1;c.paymentCtrl.needsReceipt=function(){return J};c.paymentCtrl.needsOption=function(){return!c.paymentCtrl.needsPayment()?!1:r.isAnonymous?_.any(B,function(a){return c.paymentCtrl.isOptionValid(a)}):
!c.paymentCtrl.isCollectedByAffiliate()||0<c.paymentCtrl.affiliateInStorePaymentTypes.length};c.paymentCtrl.needsCharge=function(){return _.contains([c.paymentCtrl.EMV_OPTION,c.paymentCtrl.IDEAL_OPTION,c.paymentCtrl.SOFORT_OPTION,c.paymentCtrl.CARD_ON_FILE_OPTION,c.paymentCtrl.FILE_OPTION,c.paymentCtrl.CHARGE_OPTION],c.paymentCtrl.option())};c.paymentCtrl.isRedirectBasedPaymentOption=function(){return _.contains(u,c.paymentCtrl.option())};c.paymentCtrl.needsInStorePaymentNote=function(a){return!a||
c.paymentCtrl.optionAndExtras!==a||!a.noteLabel?!1:!0};var ea=function(){if(!c.paymentCtrl.isCurrentKindValid())return!1;if(c.paymentCtrl.kind()===c.paymentCtrl.DEFER_KIND)return!0;if(c.paymentCtrl.needsPayment()){var a=c.paymentCtrl.option();if(a===c.paymentCtrl.CHARGE_OPTION||c.paymentCtrl.target&&a===c.paymentCtrl.EMV_OPTION)return!0}return!1},P=function(){return!c.paymentCtrl.isCurrentKindValid()?!1:c.paymentCtrl.option()===c.paymentCtrl.EMV_OPTION};c.paymentCtrl.needsCardFields=function(){return ea()&&
c.paymentCtrl.option()!==c.paymentCtrl.EMV_OPTION&&!c.paymentCtrl.isRedirectBasedPaymentOption()};c.paymentCtrl.needsChange=function(a){return c.paymentCtrl.optionAndExtras===a&&a.isLegalTender};var wa="file emv charge ideal sofort card-on-file in-store affiliate defer skip".split(" "),ja="file ideal sofort emv charge card-on-file in-store affiliate".split(" "),ba=["defer","skip"],S={};S.ideal={isValid:function(){return c.paymentCtrl.company.features.isIdealPaymentsEnabled&&!c.paymentCtrl.company.isDemoModeEnabled&&
r.isAnonymous&&0<c.paymentCtrl.amount()},kind:c.paymentCtrl.FULL_KIND,option:c.paymentCtrl.IDEAL_OPTION,isCollectedByAffiliate:!1};S.sofort={isValid:function(){return c.paymentCtrl.company.features.isSofortPaymentsEnabled&&!c.paymentCtrl.company.isDemoModeEnabled&&r.isAnonymous&&0<c.paymentCtrl.amount()},kind:c.paymentCtrl.FULL_KIND,option:c.paymentCtrl.SOFORT_OPTION,isCollectedByAffiliate:!1};S.file={isValid:function(){var a=0<c.paymentCtrl.amount(),b=0<c.paymentCtrl.cardPayments.length;return a&&
b&&f.permissions.can("createCreditCard",k.Payment,c.paymentCtrl.company)},kind:c.paymentCtrl.FULL_KIND,optionAndExtras:c.paymentCtrl.cardPayments[0],option:c.paymentCtrl.FILE_OPTION,isCollectedByAffiliate:!1,isTake:!0};S.emv={isValid:function(){return!r.isCompany||c.paymentCtrl.company.isDemoModeEnabled||!d.isConnected()?!1:0<c.paymentCtrl.amount()&&f.permissions.can("createCreditCard",k.Payment,c.paymentCtrl.company)&&f.permissions.can("skipPayment",k.Booking,c.paymentCtrl.company)},kind:c.paymentCtrl.FULL_KIND,
option:c.paymentCtrl.EMV_OPTION,isCollectedByAffiliate:!1,isTake:!0};S["card-on-file"]={isValid:function(){var a=0<c.paymentCtrl.amount(),b=0<c.paymentCtrl.cardsOnFile.length;return a&&b&&f.permissions.can("createCreditCard",k.Payment,c.paymentCtrl.company)},kind:c.paymentCtrl.FULL_KIND,optionAndExtras:c.paymentCtrl.cardsOnFile[0],option:c.paymentCtrl.CARD_ON_FILE_OPTION,isCollectedByAffiliate:!1,isTake:!0};S.charge={isValid:function(){var a=0<c.paymentCtrl.amount();return r.isAnonymous&&a?!0:a&&
f.permissions.can("createCreditCard",k.Payment,c.paymentCtrl.company)},kind:c.paymentCtrl.FULL_KIND,option:c.paymentCtrl.CHARGE_OPTION,isCollectedByAffiliate:!1,isTake:!0};S["in-store"]={isValid:function(){var a=0<c.paymentCtrl.amount(),b=0<c.paymentCtrl.inStorePaymentTypes.length;return a&&b&&f.permissions.can("createInStore",k.Payment,c.paymentCtrl.company)},kind:c.paymentCtrl.FULL_KIND,optionAndExtras:c.paymentCtrl.inStorePaymentTypes[0],option:c.paymentCtrl.IN_STORE_OPTION,isCollectedByAffiliate:!1,
isTake:!0};S.affiliate={isValid:function(){var a=!!c.paymentCtrl.affiliation(),b=0<c.paymentCtrl.amount();return a&&b&&f.permissions.can("createAffiliate",k.Payment,c.paymentCtrl.company)},kind:c.paymentCtrl.FULL_KIND,option:c.paymentCtrl.AFFILIATE_OPTION,optionAndExtras:function(){return _.first(c.paymentCtrl.affiliateInStorePaymentTypes)||c.paymentCtrl.AFFILIATE_OPTION},isCollectedByAffiliate:!0,isTake:!0};S.defer={isValid:function(){var a=0<c.paymentCtrl.amount();return r.isAnonymous&&!a&&r.isCardRequired||
r.isAffiliate&&!a?!0:f.permissions.can("createDeferred",k.Payment,c.paymentCtrl.company)},kind:c.paymentCtrl.DEFER_KIND,option:c.paymentCtrl.NONE_OPTION,isCollectedByAffiliate:!1,isInfo:!0};S.skip={isValid:function(){if(t.currentBooking)return!0;var a=0<c.paymentCtrl.amount();return(r.isAnonymous||r.isAffiliate)&&!a&&!r.isCardRequired||r.isCompany&&(!a&&!r.isCardRequired)&&!f.permissions.can("createDeferred",k.Payment,c.paymentCtrl.company)?!0:f.permissions.can("skipPayment",k.Booking,c.paymentCtrl.company)},
kind:c.paymentCtrl.SKIP_KIND,option:c.paymentCtrl.NONE_OPTION,isCollectedByAffiliate:!1};var ca=function(){var a="";r.isAnonymous?a=k.Company.TAKE_PAYMENT_PREFERENCE:(a=(a=c.paymentCtrl.affiliation())&&!a.isHidden?a.paymentPreference:c.paymentCtrl.company.paymentPreference,a===k.Affiliation.AFFILIATE_TAKE_PAYMENT_PREFERENCE&&r.isPreferAffiliateTakeIgnored&&(a=k.Company.TAKE_PAYMENT_PREFERENCE));switch(a){case k.Affiliation.AFFILIATE_TAKE_PAYMENT_PREFERENCE:return"affiliate";case k.Affiliation.CARD_ON_FILE_PAYMENT_PREFERENCE:return"card-on-file";
case k.Company.TAKE_PAYMENT_PREFERENCE:return"file";case k.Company.INFO_PAYMENT_PREFERENCE:return"defer";case k.Company.SKIP_PAYMENT_PREFERENCE:return"skip";default:return console.warn("paymentController: invalid preference",a),"file"}},la=function(a,b,d){if(t.currentBooking)return"skip"===a;if(_.contains(b,a)||d&&d.length&&!_.contains(d,a))return!1;b=S[a];return!b?(console.warn("paymentController: invalid stack",a),!1):r.isTakeRequired&&!b.isTake||r.isInfoRequired&&!b.isInfo?!1:b.isValid()},na=function(a,
b,d){var c=d?wa[0]:ca();a=a||[];b=b||[];console.info("paymentController: selecting stack",c);var e=_.indexOf(wa,c);0>e&&(console.warn("paymentController: invalid initial stack",c),e=0);c=_.slice(wa,e);if(c=_.find(c,function(d){return la(d,a,b)}))return console.info("paymentController: selected stack",c),c;if(!d)return console.info("paymentController: retrying from top"),na(a,b,!0);console.info("paymentController: no stack selected");return""},ka=function(a,b,d){console.info("paymentController: selecting default stack",
a,b,d);b=na(b,d);"file"===b&&r.isTakeRequired&&(b=S.emv.isValid()?"emv":S["card-on-file"].isValid()?"card-on-file":"charge");var e=b;(d=S[e])?(console.info("paymentController: applying stack",e),c.paymentCtrl.kind(d.kind),e=d.optionAndExtras||d.option,_.isFunction(e)&&(e=e()),c.paymentCtrl.optionAndExtras=e,c.paymentCtrl.option(d.option),c.paymentCtrl.isCollectedByAffiliate(d.isCollectedByAffiliate)):console.warn("paymentController: invalid stack",e);console.info("paymentController: selected default stack",
a,b)},U={},aa={},Q={};c.paymentCtrl.validKinds=U;c.paymentCtrl.validOptions=aa;c.paymentCtrl.validIsCollectedByAffiliates=Q;c.paymentCtrl.isAnyKindValid=function(){return _.any(U,function(a,b){return b&&a})};c.paymentCtrl.isAnyOptionValid=function(){return _.any(aa,function(a,b){return b&&a})};c.paymentCtrl.isKindValid=function(a){return U[a]||!1};c.paymentCtrl.isCurrentKindValid=function(){return c.paymentCtrl.isKindValid(c.paymentCtrl.kind())};c.paymentCtrl.isOptionValid=function(a){return aa[a]||
!1};c.paymentCtrl.isCurrentOptionValid=function(){return c.paymentCtrl.isOptionValid(c.paymentCtrl.option())};c.paymentCtrl.isCollectedByAffiliateValid=function(a){return Q[a]||!1};var Ga=function(){_.clear(U);_.clear(aa);_.clear(Q);_.forEach(wa,function(a){la(a)&&(a=S[a],U[a.kind]=!0,aa[a.option]=!0)});Q[!0]=aa[c.paymentCtrl.AFFILIATE_OPTION];Q[!1]=_.any([c.paymentCtrl.FILE_OPTION,c.paymentCtrl.CHARGE_OPTION,c.paymentCtrl.IN_STORE_OPTION],c.paymentCtrl.isOptionValid);c.paymentCtrl.isAnyOptionValid()||
(U[c.paymentCtrl.FULL_KIND]=!1,U[c.paymentCtrl.PARTIAL_KIND]=!1);c.paymentCtrl.needsPayment()?aa[c.paymentCtrl.NONE_OPTION]=!1:(_.clear(aa),aa[c.paymentCtrl.NONE_OPTION]=!0);c.paymentCtrl.isCollectedByAffiliate()?(aa[c.paymentCtrl.FILE_OPTION]=!1,aa[c.paymentCtrl.CARD_ON_FILE_OPTION]=!1,aa[c.paymentCtrl.CHARGE_OPTION]=!1,aa[c.paymentCtrl.IN_STORE_OPTION]=!1):aa[c.paymentCtrl.AFFILIATE_OPTION]=!1;U[c.paymentCtrl.FULL_KIND]&&f.permissions.can("createPartial",k.Payment,c.paymentCtrl.company)&&(U[c.paymentCtrl.PARTIAL_KIND]=
!0)},xa=function(){var a=c.paymentCtrl.affiliation();_.clear(c.paymentCtrl.affiliateInStorePaymentTypes);if(!a||!f.permissions.canList(k.InStorePaymentType,a.affiliateCompany))return b.when();var d=g.inStorePaymentTypes({shortname:a.affiliateCompany.shortname});return d.$promise.then(function(){_.overwrite(c.paymentCtrl.affiliateInStorePaymentTypes,k.InStorePaymentType.isVisibleWhenCollectedByAffiliate(d))})},ma=function(){var a=Z();c.paymentCtrl.gross(a.gross||0);c.paymentCtrl.bookingFee(a.bookingFee||
0)};window.$$paymentCtrl=c.paymentCtrl;f.permissions.can("createWithoutCountryCode",k.Payment,c.paymentCtrl.company)||c.paymentCtrl.countryCode(N());c.paymentCtrl.kind(c.paymentCtrl.SKIP_KIND);c.paymentCtrl.isCollectedByAffiliate(!1);c.paymentCtrl.isDemo(r.isDemo);c.paymentCtrl.gross(r.gross()||0);c.paymentCtrl.bookingFee(r.bookingFee()||0);ka("initial");Ga();c.$watch(_.ary(c.paymentCtrl.isCollectedByAffiliate,0),function(a,b){if(a!==b){var d=c.paymentCtrl.kind(),e=c.paymentCtrl.gross(),f=c.paymentCtrl.bookingFee();
ma();c.paymentCtrl.needsPayment()&&(ka("isCollectedByAffiliate",a?["file","emv","card-on-file","charge","in-store"]:["affiliate"],a?["affiliate"]:ja),d===c.paymentCtrl.PARTIAL_KIND&&c.paymentCtrl.kind()===c.paymentCtrl.FULL_KIND&&(c.paymentCtrl.kind(d),c.paymentCtrl.gross(e),c.paymentCtrl.bookingFee(f)))}Ga()});var da=function(a){_.overwrite(c.paymentCtrl.cardsOnFile,[]);if(!a||a.isHidden)return b.when();var d=g.affiliateCards;r.isAffiliate&&(d=g.partnerCards);var e=d({shortname:r.isAffiliate?a.affiliateCompany.shortname:
a.company.shortname,affiliationPk:a.pk});return e.$promise.then(function(){var b=_.sortBy(e,function(b){return b.company===a.company},function(a){return a.sortableIndex});_.overwrite(c.paymentCtrl.cardsOnFile,b);S["card-on-file"].optionAndExtras=c.paymentCtrl.cardsOnFile[0]},function(a){S["card-on-file"].optionAndExtras=null})};c.$watch(_.ary(c.paymentCtrl.affiliation,0),function(a,d){b.all([da(a),xa()]).finally(function(){console.info("paymentController: handling affiliation change after callback",
a,d);c.paymentCtrl.isPreselecting?console.warn("paymentController: avoid overwriting preselect"):(ma(),ka("affiliation"),Ga())})});c.$watch(c.paymentCtrl.amount,function(a,b){!!a!==!!b&&ka("amount");Ga()});c.$watch(_.ary(c.paymentCtrl.kind,0),function(a,b){a===c.paymentCtrl.SKIP_KIND&&c.paymentCtrl.note("");var d=ia(a),e=ia(b);a===c.paymentCtrl.SKIP_KIND?ka("kind",[],["skip"]):a===c.paymentCtrl.DEFER_KIND?ka("kind",[],["defer"]):d&&(ma(),e||(ka("kind",ba),a===c.paymentCtrl.PARTIAL_KIND&&c.paymentCtrl.kind()===
c.paymentCtrl.FULL_KIND&&c.paymentCtrl.kind(c.paymentCtrl.PARTIAL_KIND)));Ga()});c.$watch(_.ary(c.paymentCtrl.option,0),function(a,b){a&&a!==b&&c.paymentCtrl.isCollectedByAffiliate(a===c.paymentCtrl.AFFILIATE_OPTION)});c.$watch("paymentCtrl.optionAndExtras",function(a,b){c.paymentCtrl.filePayment("");c.paymentCtrl.cardOnFile("");c.paymentCtrl.inStorePaymentType("");_.isString(a)?c.paymentCtrl.option(a):a.cls===k.Payment.cls?(c.paymentCtrl.option(c.paymentCtrl.FILE_OPTION),c.paymentCtrl.filePayment(a.pk)):
a.cls===k.Card.cls?(c.paymentCtrl.option(c.paymentCtrl.CARD_ON_FILE_OPTION),c.paymentCtrl.cardOnFile(a.pk)):a.cls===k.InStorePaymentType.cls?(c.paymentCtrl.option(a.company===c.paymentCtrl.company?c.paymentCtrl.IN_STORE_OPTION:c.paymentCtrl.AFFILIATE_OPTION),c.paymentCtrl.inStorePaymentType(a.pk)):console.warn("paymentCtrl: invalid option and extras",a)});c.$watch(r.gross,function(a,b){c.paymentCtrl.gross(a||0);ma()});c.$watch(r.invoicePrice,function(){ma()});c.$watch(r.bookingFee,function(a,b){c.paymentCtrl.bookingFee(a||
0);ma()});var sa;c.paymentCtrl.form=function(a){if(_.isUndefined(a)){if(sa&&!sa.$invalid&&!sa.$submitting&&c.paymentCtrl.isCurrentKindValid()&&c.paymentCtrl.isCurrentOptionValid())return sa}else sa=a};c.paymentCtrl.isPreselecting=!1;c.paymentCtrl.preselect=function(){var d=h.getInt("amount");d&&(h.clear("amount",!0),d=0<d&&d<r.gross()?d:null);var e=h.get("option");e&&h.clear("option",!0);if(e||d){var f=b.defer(),g=function(){e&&c.paymentCtrl.option()!==e&&f.reject();d&&c.paymentCtrl.gross()!==d&&
f.reject();f.resolve()};console.info("paymentController: preselecting...");a(function(){a(function(){console.info("paymentController: preselecting isCollectedByAffiliate",e===c.paymentCtrl.AFFILIATE_OPTION);c.paymentCtrl.isCollectedByAffiliate(e===c.paymentCtrl.AFFILIATE_OPTION);a(function(){console.info("paymentController: preselecting option",e);c.paymentCtrl.isOptionValid(e)?(c.paymentCtrl.isPreselecting=!0,c.paymentCtrl.optionAndExtras=e,a(function(){d?(console.info("paymentController: preselecting partial kind"),
c.paymentCtrl.kind(c.paymentCtrl.PARTIAL_KIND),a(function(){console.info("paymentController: preselecting gross",d);c.paymentCtrl.gross(d);g()})):g()})):(console.info("paymentController: preselecting invalid option",e),f.reject())})})});return f.promise}};return c};_.forEach(q,function(a,b){x[b]=a});return x}]);h.factory("autofill",["models","rebook",function(b,a){var c={autofillFromCartEntry:function(a,c,g,d,l,m){var k=a.availability.item,n=c.item,h=[],p=_.clone(d);if(_.all(a.availability.customerTypeRates,
function(d){var c=b.Booking.customerTypeRateCountKey(d),c=a.model[c];if(!c)return!0;var e=b.CustomerTypeRate.find(p,d,k!==n);if(!e||!l(e))return!1;_.ref.remove(p,e);h.push({source:d,target:e,count:c});return!0})){_.forEach(h,function(a){m(a.target,a.count,!0)});_.forEach(h,function(d){var c=d.source,e=d.target,k=c.customerPrototype.customFieldInstances,l=e.customerPrototype.customFieldInstances;_.forEach(_.range(d.count),function(d){var m=_.clone(k);_.forEach(l,function(k){var l=b.CustomFieldInstance.find(m,
k);l&&(_.ref.remove(m,l),l=b.Booking.customFieldInstanceKey(l,c,d),l=b.CustomField.autofillValue(k,a.model[l],!0),_.isUndefined(l)||(k=b.Booking.customFieldInstanceKey(k,e,d),g[k]=l))})})});d=a.availability.customFieldInstanceGroup;c=(c=c.customFieldInstanceGroup)?c.customFieldInstances:[];var r=_.clone(d?d.customFieldInstances:[]);_.forEach(c,function(d){var c=b.CustomFieldInstance.find(r,d);c&&(_.ref.remove(r,c),c=b.Booking.customFieldInstanceKey(c),c=b.CustomField.autofillValue(d,a.model[c],!0),
_.isUndefined(c)||(d=b.Booking.customFieldInstanceKey(d),g[d]=c))})}},autofillAffiliationFromBooking:function(a,b,c){a.affiliation&&!a.affiliation.isHidden&&(b["affiliation-affiliation"]=a.affiliation.pk,b["affiliation-isBlockable"]=a.isBlockable,b["affiliation-voucher-voucherNumber"]=a.voucherNumber,a.agent&&(b["affiliation-voucher-agent"]=a.agent.pk),a.desk&&(b["affiliation-voucher-desk"]=a.desk.pk),c.currentAffiliation=a.affiliation)},autofillFromBooking:function(f,e,g,d,l,m){c.autofillAffiliationFromBooking(f,
e,m);var k={},n={};_.forEach(d,function(a){var b=a.customerPrototype,d=b.customerType;k[b.uri]=a;n[d.uri]=a});_.forEach(f.customers,function(d,c){var f=d.customerTypeRate.customerPrototype,g=f.customerType,m=k[f.uri];m||(m=n[g.uri]);if(m){var h=l(m);_.forEach(d.customFieldValues,function(d){var c=b.CustomFieldInstance.find(m.customerPrototype.customFieldInstances,d.customFieldInstance);c&&(d=b.CustomField.autofillValue(c,d.value),_.isUndefined(d)||(c=b.Booking.customFieldInstanceKey(c,m,h-1),e[c]=
d,a.addPopulatedCustomField(c)))})}else a.addNonRebookableCustomer(d)});var h=g.customFieldInstanceGroup?g.customFieldInstanceGroup.customFieldInstances:[];_.forEach(f.customFieldValues,function(d){var c=b.CustomFieldInstance.find(h,d.customFieldInstance);c&&(d=b.CustomField.autofillValue(c,d.value),_.isUndefined(d)||(c=b.Booking.customFieldInstanceKey(c),e[c]=d,a.addPopulatedCustomField(c)))});a.currentBooking===f&&(e.explicitGross=null!==f.explicitGross?f.explicitGross:"",e.note=f.note);c.autofillFromContact(f.contact,
e)},autofillFromContact:function(b,c){c["contact-name"]=b.name;c["contact-email"]=b.email;c["contact-phone"]=b.phone;c.sendNotification=a.currentBooking?b.company.companyFeatures.isSendRebookedEmailDefault:b.company.companyFeatures.isSendConfirmationEmailDefault}};return c}])})();angular.module("cache",["cache.services"]);
(function(){var h=angular.module("cache.services",["lib.services","urls.services"]);h.factory("cache",["moment","urls",function(b,a){var c=function(a,b){b=b||{};for(var c in a)a.hasOwnProperty(c)&&(b[c]=f(a[c]));return b},f=function(a){if(_.isArray(a)){for(var b=[],g=0,k=a.length;g<k;g++)b.push(f(a[g]));return b}return _.isModelObject(a)?e(a):_.isObject(a)?c(a):a},e=function(b,e){if(_.isUndefined(b)||null===b)return e&&delete g.cache[e],b;if(!_.isObject(b))return b;var f=b.uri;e=e||f;var k=g.cache[e];
f&&(e&&e!==f&&!_.isUndefined(k))&&(console.log("cache: overlapping uris",f,e),delete g.cache[e]);k=_.isUndefined(k)?{}:k;f&&(g.cache[f]=k,k.$url||(k.$url=a.populateForObject));f=c(b,k);f.$fresh=!1;return f},g={cache:{},read:function(a,b){if(_.isUndefined(a))throw Error("cache.read: invalid key");b&&(a="["+a+"]");var c=g.cache[a];_.isUndefined(c)&&(c=b?[]:{},c.uri=a,c.$fresh=!0,g.cache[a]=c);return c},update:e,clear:function(){g.cache={}},fresh:function(a){return!!a.$fresh},populate:f,reference:function(a){if(a.cls&&
a.uri)return{cls:a.cls,uri:a.uri}}};return window.$$cache=g}]);h.run(["$rootScope","cache","events",function(b,a,c){c.on(b,"auth.logout",function(){a.clear()})}])})();
(function(){var h=angular.module("cart",["cache","db","navigation"]);h.factory("cart",["$q","$rootScope","$timeout","cache","clientOptions","db","events","flows","navigation","require","persistentStorage","urls","xmessage",function(b,a,c,f,e,g,d,l,m,k,n,h,p){var r=function(a){return{company:a,entries:[],isNoTax:!1,isCardRequired:!0,totals:{price:0,tax:0,taxByType:{},total:0}}},t=function(){x.status="success";d.broadcast("cart.loaded")},v=function(a){a.totals.price=_.sum(a.entries,"totals.price");
a.totals.tax=_.sum(a.entries,"totals.tax");a.totals.bookingFee=_.sum(a.entries,"totals.bookingFee");var b=_.pluck(a.entries,"totals.taxByType");_.all(b)?a.totals.taxByType=_.reduce(b,_.sumObjectValues)||{}:a.totals.taxByType=void 0;a.isNoTax=_.all(a.entries,"availability.item.isNoTax");a.isCardRequired=_.any(a.entries,"isCardRequired")},y={},q=function(a,b,d,c,e){k.assert(!!b,"cart: expected availability");k.assert(!!d,"cart: expected breakdown");k.defined(c,"price","cart: expected total price");
k.defined(c,"tax","cart: expected total tax");k.defined(c,"bookingFee","cart: expected total total");k.assert(!!e,"cart: expected model");var f=a.company.shortname;y[f]=y[f]||{};var g=y[f][b.uri];g||(g={availability:b},y[f][b.uri]=g,a.entries.push(g));g.customerBreakdown=d;g.totals=c;g.isCardRequired=b.item.isCardRequired;g.model=e;v(a)},B=function(a,b){_.overwriteWithout(a.entries,function(a){return a.availability===b.availability});y[a.company.shortname]&&delete y[a.company.shortname][b.availability.uri];
v(a)},u=function(a){_.clear(a.entries);y[a.company.shortname]={};v(a)},z=function(a,d){try{var c=_.map(d.entries,function(a){var b=g.availability(a.availability,null,null,null,{tagAlong:!0});return b.$promise.then(function(){return{availability:b,storedEntry:a}},function(){return null})});return b.all(c).then(function(b){u(a);_.forEach(b,function(b){if(b){var d=b.availability;b=b.storedEntry;var c=_.choose(b.customerBreakdown,function(a){var b=f.read(a.customerTypeRate.uri);if(b)return{count:a.count,
customerTypeRate:b}});q(a,d,c,b.totals,b.model)}});console.info("cart: finished hydrating")})}catch(e){return console.warn("cart: unable to load cart",d,e),b.when(null)}},C=function(a){var b={};b.entries=_.map(a,function(a){var b=_.map(a.customerBreakdown,function(a){return{count:a.count,customerTypeRate:f.reference(a.customerTypeRate)}});return{availability:h.extract(a.availability),customerBreakdown:b,totals:a.totals,model:a.model}});return b},F=function(a){if(x.company){var b=C(x.entries);b?(console.info("cart: storing",
b),b=n.set("cart",b)):b=n.del("cart");a&&(b=b.then(function(){p.broadcast("fareharbor.cart.changed")}));return b}},x={status:"success",add:function(a,b,d,c){q(x,a,b,d,c);return F(!0)},remove:function(a){B(x,a);F(!0)},clear:function(){u(x);F(!0)},search:function(a){return(y[x.company.shortname]||{})[a.uri]||null},keepShoppingUrl:function(a){return l.initialFlowNode?l.initialUrl():a.$url(h.company.index)},permalinkUrl:function(a){a=h.populate(h.company.cart.permalink,{shortname:a.shortname,cartUuid:e.userIdentifier});
return l.extendWithFlow(a)},load:function(){if(x.company&&"loading"!==x.status)return x.status="loading",x.$promise=n.get("cart").then(function(a){if(a)return console.info("cart: hydrating...",a),z(x,a)}).then(t,t),x.$promise},allCompanies:{status:"success",carts:{},load:function(){x.allCompanies.status="loading";x.allCompanies.$promise=n.getForAllCompanies("cart").then(function(a){delete x.allCompanies.$promise;_.clear(x.allCompanies.carts);y={};var d=[];_.forEach(a,function(a){if(a.cart){var b=
a.company.shortname;x.allCompanies.carts[b]=r(a.company);console.info("cart: loading all...",a);d.push(z(x.allCompanies.carts[b],a.cart))}});return b.all(d).then(function(){x.company&&x.allCompanies.carts[x.company.shortname]?_.extend(x,x.allCompanies.carts[x.company.shortname]):_.extend(x,r());x.allCompanies.status="success"},function(){x.allCompanies.status="success"})});return x.allCompanies.$promise}}};_.extend(x,r(null));var w=function(a){a&&x.company!==a&&(console.info("cart: loading for new company",
a),F(),x.company=a,x.load())};w(m.currentCompany);d.on(a,"navigation.company.updated",function(a,b){w(b.company)});d.on(a,"persistentStorage.reIdentifiedUser",function(){m.currentCompany&&(x.company=m.currentCompany,x.load(),console.info("cart: loading for new user"))});return x}]);h.controller("cart.CartCtrl",["$scope","clientOptions","controllers","db","navigation","require",function(b,a,c,f,e,g){a.reflect("userIdentifier")}]);h.controller("cart.ViewCartCtrl",["$scope","cart",function(b,a){a.load()}]);
h.directive("ngCart",["analytics","cart","db","flows","lightframe","models","navigation","paymentController","tracking","tracking.geo","urls",function(b,a,c,f,e,g,d,l,m,k,n){return{templateUrl:"cart.cart",controller:["$scope","$attrs",function(h,p){c.slipstream("isDebug")&&(window.$$pop=function(a,b){h.$safeApply(function(){var d=a?a.replace(" ","-"):"z",c=_.capitalize(a||"zach");r.newOrder["contact-name"]=c;r.newOrder["contact-phone"]="4158881212";r.newOrder["contact-email"]=d+"@fareharbor.com";
r.newOrder["payments-payment-cardNumber"]="4242424242424242";r.newOrder["payments-payment-cardholdersName"]=c;r.newOrder["payments-payment-cardExpiryMonth"]="12";r.newOrder["payments-payment-cardExpiryYear"]="2023";r.newOrder["payments-payment-cardCvc"]="123";r.newOrder["payments-payment-postalCode"]="12345";r.newOrder["payments-payment-countryCode"]="US";_.extend(r.newOrder,b)})});var r=this,t={};r.setEntryValidity=function(a,b){var d=a.availability.uri;_.isUndefined(b)?delete t[d]:t[d]=!!b};r.addEntryController=
function(a){_.contains(r.entryCtrls,a)||r.entryCtrls.push(a)};r.removeEntryController=function(a){_.contains(r.entryCtrls,a)&&_.ref.remove(r.entryCtrls,a)};r.newOrder=h.newOrder={clientUuid:_.uuid()};r.company=h.$eval(p.ngCart);r.attachControl=function(a,b){r[a]=b;b.cartCtrl=r};r.showCompleteButton=function(b){return!b.$invalid&&!b.$submitting&&0<a.entries.length&&_.all(t)&&r.paymentCtrl&&r.paymentCtrl.isCurrentOptionValid()&&r.paymentCtrl.isCurrentKindValid()&&!r.paymentCtrl.isAmountTooLow()};var v=
!1;r.isNavigateAwayAllowed=function(a){return v?!0:!a.$pristine?!1:!0};var y=function(g,l){l=l||_.ignore;var p=_.extend({},r.newOrder);p.bookingCount=a.entries.length;_.forEach(a.entries,function(a,b){var d="booking"+b.toString()+"-";_.extendWithPrefix(d,p,a.model);p[d+"availability"]=a.availability.pk});console.info("cart: creating order",p);var t=c.orders.create({shortname:r.company.shortname},p,g);t.$promise.then(function(){if(t.clientAction)r.paymentCtrl.completeClientAction(g,t).then(function(){y(g,
l)},function(){m.track(h,"failed-order",{company:r.company.shortname,isLightframe:e.isLightframe(),clientAction:!0});r.paymentCtrl.restoreCard();g.$submitting=!1;l()});else{v=!0;var c=t.$url(n.company.order.index);1===t.contributingBookings.length?(c=t.contributingBookings[0],t.isPending?(c=c.$url(n.embeds.book.wait.booking),c=d.extendQuery(c,{status:"initial"})):c=c.$url(n.company.item.booking)):t.isPending&&(c=t.$url(n.embeds.book.wait.order),c=d.extendQuery(c,{status:"initial"}));c=f.extendWithFlow(c);
t.isPending&&e.isLightframe()?(c=d.absoluteUrl(c),d.redirect(c)):d.navigate(c);a.clear();g.$submitting=!0;c={company:r.company.shortname,total:t.contributingBookingCosts.totalCost.total,bookingCount:t.bookingCount,items:_.unique(_.map(t.contributingBookings,"item.name")),isLightframe:e.isLightframe()};!1===k.isEU&&(c.order=t.uuid);m.track(h,"completed-order",c);b.trackOrder(t);l()}},function(){m.track(h,"failed-order",{company:r.company.shortname,isLightframe:e.isLightframe()});r.paymentCtrl.restoreCard();
g.$submitting=!1;l()})};r.submit=function(b){if(a.entries.length)if(b.$valid){b.$submitting=!0;r.paymentCtrl.saveCard();var d=r.paymentCtrl.isRedirectBasedPaymentOption();r.newOrder.type=d?g.Order.PENDING_TYPE:g.Order.COMPLETED_TYPE;_.forEach(a.entries,function(a){a.model.type=d?g.Booking.PENDING_TYPE:g.Booking.COMPLETED_TYPE});var c=r.paymentCtrl.option();if(c===r.paymentCtrl.CHARGE_OPTION||c===r.paymentCtrl.DEFER_OPTION)r.tokenizingCard=!0;h.$asyncApply(function(a){r.paymentCtrl.createToken(b,function(){r.tokenizingCard=
!1;y(b,a)},function(){r.tokenizingCard=!1;b.$submitting=!1;a()})})}else console.error("cart: attempting to submit invalid order form");else console.error("cart: attempting to submit empty order form")};l(h,{modelKey:"newOrder",fieldPrefix:"payments-payment",company:r.company,gross:function(){return!r.cartTotalsCtrl?0:r.cartTotalsCtrl.totals.preBookingFeeTotal},bookingFee:function(){return!r.cartTotalsCtrl?0:r.cartTotalsCtrl.totals.bookingFee},invoicePrice:0,isAnonymous:!0,isAffiliate:!1,isCompany:!1,
isCardRequired:!!a.isCardRequired});r.attachControl("paymentCtrl",h.paymentCtrl)}],controllerAs:"cartCtrl"}}]);h.directive("ngCartEntry",["cart","db","navigation","urls",function(b,a,c,f){return{restrict:"A",require:"^ngCart",templateUrl:"cart.entry",controller:["$scope","$attrs",function(e,g){var d=this;d.status="loading";d.cartCtrl=e.cartCtrl;d.entry=e.$eval(g.ngCartEntry);d.total=_.sum([d.entry.totals.price,d.entry.totals.tax,d.entry.totals.bookingFee]);d.change=function(){var a=d.entry.availability.$url(f.company.item.book);
c.navigate(a)};d.remove=function(){b.remove(d.entry)};var l={};_.forEach(d.entry.customerBreakdown,function(a){l[a.customerTypeRate.pk]=a.count});var m=a.availability.liveCapacity({shortname:d.entry.availability.item.company.shortname,itemPk:d.entry.availability.item.pk,availabilityPk:d.entry.availability.pk},null,null,{customerTypeRateCounts:_.stringifyJSON(l),totalSheet:d.entry.model.totalSheet});m.$promise.then(function(){d.cartCtrl.setEntryValidity(d.entry,m.isBookable);d.status=d.entry.availability.isBookable&&
m.isBookable?"success":"error";d.isPossiblyBookable=d.entry.availability.isBookable},function(){d.cartCtrl.setEntryValidity(d.entry,!0);d.status="success"});e.$on("$destroy",function(){d.cartCtrl.setEntryValidity(d.entry)})}],controllerAs:"cartEntryCtrl"}}]);h.directive("ngCartTotals",["cart","models","redeemStoredValueCardsController",function(b,a,c){return{restrict:"A",require:"^ngCart",templateUrl:"cart.totals",controller:["$scope",function(f){var e=this;f.cartCtrl.attachControl("cartTotalsCtrl",
e);e.cartCtrl=f.cartCtrl;e.totals=_.extend({},b.totals);e.currentPrice=function(){return e.totals.price};e.currentTax=function(){return e.totals.tax};var g=function(a){return a.availability.uri},d=function(a){return a.totals.price+a.totals.tax},l=function(c){var e=f.redeemStoredValueCardsCtrl.storedValueCards;if(!e.length)return c;var l={};_.forEach(e,function(a){a=f.redeemStoredValueCardsCtrl.applied(a);a=_.prorate(a,b.entries,d,g);l=_.merge(l,a,_.add)});var m=0;_.forEach(b.entries,function(b){var d=
g(b);m+=a.Booking.adjustBookingFee(b.totals.bookingFee,b.totals.price,b.totals.tax,l[d])});return m},m=function(){_.extend(e.totals,b.totals);e.totals.bookingFee=l(e.totals.bookingFee);e.totals.preBookingFeeTotal=e.totals.price+e.totals.tax-f.redeemStoredValueCardsCtrl.totalApplied();e.totals.total=e.totals.preBookingFeeTotal+e.totals.bookingFee};f.$watchCollection("cart.entries",function(){m()});c(f,{company:e.cartCtrl.company,modelKey:"newOrder",price:e.currentPrice,tax:e.currentTax,toggleName:"applyStoredValueCard"});
f.cartCtrl.attachControl("redeemStoredValueCardsCtrl",f.redeemStoredValueCardsCtrl);f.$watch("redeemStoredValueCardsCtrl.storedValueCards.length",function(a){m()})}],controllerAs:"cartTotalsCtrl"}}]);h.directive("ngCartComplete",["cart",function(b){return{restrict:"A",require:"^ngCart",templateUrl:"cart.complete",controller:["$scope",function(a){}],controllerAs:"cartCompleteCtrl"}}]);h.directive("ngCartAdd",["cart","navigation","urls",function(b,a,c){return{restrict:"A",require:"^ngBook",templateUrl:"cart.add",
controller:["$scope",function(c){var e=this;e.isAdding=!1;e.isAvailabilityInCart=!!b.search(c.bookCtrl.availability);e.add=function(){e.isAdding=!0;var g={price:c.bookCtrl.bookTotalsCtrl.totals.price,tax:c.bookCtrl.bookTotalsCtrl.totals.tax,taxByType:c.bookCtrl.bookTotalsCtrl.totals.taxByType,bookingFee:c.bookCtrl.bookTotalsCtrl.totals.bookingFee};c.bookCtrl.reflectASN();c.bookCtrl.isAlreadyBooked=!0;b.add(c.bookCtrl.availability,c.bookCtrl.bookCountsCtrl.customerBreakdown(),g,c.bookCtrl.newBooking).then(function(){a.navigate(b.permalinkUrl(c.bookCtrl.item.company))},
function(){c.bookCtrl.restoreASN();e.isAdding=!1})}}],controllerAs:"cartAddCtrl"}}]);h.directive("ngCartSubmit",[function(){return{restrict:"A",require:"^ngCart",templateUrl:"cart.submit"}}]);h.run(["$rootScope","cart",function(b,a){b.cart=a;window.$$cart=a}])})();angular.module("db",["db.services"]);
(function(){var h=0;angular.module("db.services",["cache.services","lib.services"]).factory("db",["$http","$injector","$rootScope","$q","$window","cache","convert","flash","require","urls",function(b,a,c,f,e,g,d,l,m,k){var n=!1;angular.element(e).on("beforeunload",function(){n=!0});var s={},p=_.debounce(function(){n||l.warn("<b>"+T("Could not reach FareHarbor.")+"</b> "+T("Please check your internet connection."))},2E3,!0),r=function(a){_.isUndefined(a)&&(a="<b>"+T("That didn't work.")+"</b> "+T("Please try again."));
a&&l.error(a)},t=_.debounce(function(a){l.error("<b>"+interpolate(T("Too many %(errorType)s."),{errorType:a})+"</b> "+T("Please wait a few minutes and try again. If you continue to receive this message please contact")+' <a href="mailto:support@fareharbor.com" target="_blank">support@fareharbor.com</a>.')},2E3,!0),v=_.debounce(function(){l.error("<b>"+T("FareHarbor will be right back.")+"</b> "+T("Please wait a few minutes and try again."))},2E3,!0),y=function(a,b,d){return d?_.map(a,function(a){return g.update(a)}):
g.update(a,b)},q=function(a){var c={},e={isDelete404Success:!0},n=a.formName||a.key+"Form";return function(q,z,x,C,I){var w=_.extend({},e,a,I),F=!1!==w.flashError,D,Z;if(_.isString(q))D=q;else{var G={};_.extend(G,w.defaultParams||{},q);D=k.populate(w.url,G)}Z=D;if(_.isUndefined(D))return console.warn("db: invalid endpoint",w.url,G),z=w.isArray?[]:{},z.$promise=f.reject(null),z.$promise.cancel=_.ignore,z;C&&(D+="?"+Od(d.clientRequest(C)),C=null);w.ignoreQueryParamsInCacheUri||(Z=D);var K=h+=1;console.log("db: endpoint",
D,K);if((q=c[D])&&!w.ignoreInFlight){if(w.tagAlong)return console.log("db: tagging along",D,K),q.value;"GET"===w.method&&"GET"===q.method&&(console.log("db: already in flight, cancelling",D,K),q.timeout.promise.cancelled=!0,q.timeout.resolve())}var M;M=w.ignoreCache?w.isArray?[]:{}:g.read(Z,w.isArray);var H=function(a){a.data&&w.sideKeys&&_.forEach(w.sideKeys,function(b){var d=a.data[b];d&&(a[b]=y(d,null,_.isArray(d)))})},J=_.identity;w.key&&(J=w.isArray?function(a){console.log("db: success",D,K);
if(M.$requestId!==K)return console.log("db: out of order",D,M.$requestId,K),a;var b=_.isFunction(w.key)?w.key(a):w.key;_.overwrite(M,y(a.data[b],null,!0));M.$fresh=!1;a.data?(a.primaryData=a.data[b]=M,H(a)):a.primaryData=null;x&&u(x,n)(a,M);return a}:function(a){console.log("db: success",D,K);if(M.$requestId!==K)return console.warn("db: out of order",D,M.$requestId,K),a;var b=_.isFunction(w.key)?w.key(a):w.key,d=a.data[b],d=w.ignoreCache?y(d):y(d,Z);a.data?(a.primaryData=a.data[b]=d,H(a)):a.primaryData=
null;x&&u(x,n)(a,d);return a});var P;x&&(P=B(x,n));q=function(a){return function(b){b=a(b);console.log("db: complete",D,K);w.ignoreInFlight||(c[D]=null);x&&(x.$submitting=!1);M.$requestId===K&&(delete M.$requestId,delete M.$promise);return b}};x&&(x.$submitting=!0);C=f.defer();var E=b({method:w.method,url:D,data:z||{},timeout:C.promise}).then(q(J),q(function(a){console.log("db: error",D,K,a);var b=a.status;if(500===b)return l.error("<b>"+T("Whoops, an internal error has occurred.")+"</b> "+T("FareHarbor has been notified. Please wait a few minutes and try again.")),
f.reject(a);if(503===b)return v(),f.reject(a);if(403===b)return F&&l.error("<b>"+T("Not allowed.")+"</b> "+interpolate(T("Please <a %(href)s>log in</a> as a different user or request permission from your administrator."),{href:'href="/login/"'})),f.reject(a);if(420===b)return t("connections"),f.reject(a);if(429===b)return t("requests"),f.reject(a);if(324===b)return p(),f.reject(a);if(0===b){if(a.config.timeout&&a.config.timeout.cancelled)return s;p();return f.reject(a)}if(400===b)return P?P(a,b):
F&&r(a.data.errorMessage||w.errorMessage),f.reject(a);if(404===b){if(w.isDelete404Success&&"DELETE"===w.method)return console.log("db: treating 404 as success",D,K),J(a)}else r(a.data.errorMessage||w.errorMessage),console.error("db: unknown error",a,b);return f.reject(a)}));m.assert(!E.success&&!E.error,"db: disallow $http promise interface");w.ignoreInFlight||(c[D]={timeout:C,value:M,requestId:K,method:w.method,uri:D});M.$requestId=K;M.$promise=E;M.$promise.timeout=C;M.$promise.cancel=function(){E.timeout?
(E.timeout.promise.cancelled=!0,E.timeout.resolve(),c[D]=null,console.log("db: cancelled",D,K)):console.warn("db: cancellation failed",D,K)};return M}},B=function(a,b){return function(d){var c=d.data[b];_.forEach(c,function(b,d){a[d]||(a[d]={$error:{}});var c=a[d];b&&b.length?c.$error.$server=b:c.$error={}});a.$errorCallbacks&&_.forEach(a.$errorCallbacks,function(a){a(c)})}},u=function(a,b){return function(b,d){_.forEach(a,function(a,b){a&&a.$error&&delete a.$error.$server});a.$successCallbacks&&
_.forEach(a.$successCallbacks,function(a){a(d)})}},z=function(a,b){b||(b=a+"s");var d=q({method:"GET",url:k.api[b],isArray:!0,key:b});d.create=q({method:"POST",url:k.api[b],key:a});return d},C=function(a){var b=q({method:"GET",url:k.api[a],key:a});b.update=q({method:"PUT",url:k.api[a],key:a});b.remove=q({method:"DELETE",url:k.api[a],formName:"disableForm"});return b},F=function(a,b,d){var c={};c[b]=_.isUndefined(d)?"yes":d;return function(b,d,e,f,g){f=_.extend({},c,f);return a(b,d,e,f,g)}},x=function(a){return F(a,
"pickable")},w=q({method:"POST",url:k.api.login,key:"user",formName:"loginForm"}),G={};G.password=q({method:"POST",url:k.api.forgotPassword,formName:"forgotPasswordForm"});G.password.reset=q({method:"POST",url:k.api.resetPassword,formName:"resetPasswordForm"});G.credentials=q({method:"POST",url:k.api.forgotCredentials,formName:"forgotCredentialsForm"});var M=q({method:"GET",url:k.api.reportTest,key:"report"}),K=q({method:"GET",url:k.api.companies,isArray:!0,key:"companies"});K.pickable=x(K);K.jump=
F(K,"jump");K.full=F(K,"full");K.create=q({method:"POST",url:k.api.companies,key:"company"});K.admin=q({method:"GET",url:k.api.company,key:"company",defaultParams:{shortname:"admin"}});K.report=q({method:"GET",url:k.api.reportCompanies,key:"report"});var H=q({method:"GET",url:k.api.company,key:"company"});H.update=q({method:"PUT",url:k.api.company,key:"company"});H.remove=q({method:"DELETE",url:k.api.company});H.styles={};H.styles.update=q({method:"PUT",url:k.api.companyStyles,key:"styles",formName:"companyStylesForm"});
H.adminNotes={};H.adminNotes.update=q({method:"PUT",url:k.api.companyAdminNotes,key:"adminNotes",formName:"companyAdminNotesForm"});H.accounts=q({method:"GET",url:k.api.companyAccounts,key:"accounts"});H.accounts.report=q({method:"GET",url:k.api.reportAccounts,key:"report"});H.nags={};H.nags.update=q({method:"PUT",url:k.api.companyNags,key:"companyNags",formName:"companyNagsForm"});H.companyFeatures={};H.companyFeatures.update=q({method:"PUT",url:k.api.companyFeatures,key:"companyFeatures",formName:"companyFeaturesForm"});
H.refundReserve={};H.refundReserve.update=q({method:"PUT",url:k.api.refundReserve,key:"companyFeatures",formName:"refundReserveForm"});H.itemColorsFeature={};H.itemColorsFeature.update=q({method:"PUT",url:k.api.companyItemColorsFeature,key:"companyItemColorsFeature",formName:"companyItemColorsFeatureForm"});H.contactInformation={};H.contactInformation.update=q({method:"PUT",url:k.api.companyContactInformation,key:"contactInformation",formName:"companyContactInformationForm"});H.taxInformation={};
H.taxInformation.update=q({method:"PUT",url:k.api.companyTaxInformation,key:"taxInformation",formName:"companyTaxInformationForm"});H.extendedTaxInformation={};H.extendedTaxInformation.update=q({method:"PUT",url:k.api.companyExtendedTaxInformation,key:"extendedTaxInformation",formName:"companyExtendedTaxInformationForm"});H.tosAcceptance={};H.tosAcceptance.update=q({method:"PUT",url:k.api.companyTosAcceptance,key:"tosAcceptance",formName:"companyTosAcceptanceForm"});H.processorOnboard={};H.processorOnboard.update=
q({method:"PUT",url:k.api.processorOnboard,key:"processorOnboard",formName:"processorOnboardForm"});H.escrowReport=q({method:"GET",url:k.api.reportEscrow,key:"report"});H.profile={};H.profile.update=q({method:"PUT",url:k.api.companyProfile,key:"profile",formName:"companyProfileForm"});H.payments={};H.payments.update=q({method:"PUT",url:k.api.companyPayments,key:"payments",formName:"companyPaymentsForm"});H.manifestSettings={};H.manifestSettings.update=q({method:"PUT",url:k.api.companyManifestSettings,
key:"manifestSettings",formName:"manifestSettingsForm"});H.images=q({method:"GET",url:k.api.companyImages,key:"images",isArray:!0});H.images.create=q({method:"POST",url:k.api.companyImages,key:"image"});H.image={};H.image.update=q({method:"PUT",url:k.api.companyImage,key:"image"});H.image.remove=q({method:"DELETE",url:k.api.companyImage});H.activities={};H.activities.all=q({method:"GET",url:k.api.allActivities,isArray:!0,key:"activities"});H.activities.system=q({method:"GET",url:k.api.systemActivities,
isArray:!0,key:"activities"});H.activities.admin=F(H.activities.system,"admin");H.calendar=q({method:"GET",url:k.api.companyCalendar,key:"calendar"});H.summaryReport={};H.summaryReport.items=q({method:"GET",url:k.api.reportItemsSummary,key:"report"});H.summaryReport.users=q({method:"GET",url:k.api.reportUsersSummary,key:"report"});H.summaryReport.bookingTypes=q({method:"GET",url:k.api.reportBookingTypesSummary,key:"report"});H.summaryReport.customerTypes=q({method:"GET",url:k.api.reportCustomerTypesSummary,
key:"report"});H.summaryReport.customField=q({method:"GET",url:k.api.reportCustomFieldSummary,key:"report"});H.summaryReport.lodgings=q({method:"GET",url:k.api.reportLodgingsSummary,key:"report"});H.summaryReport.pickups=q({method:"GET",url:k.api.reportPickupsSummary,key:"report"});H.summaryReport.crew=q({method:"GET",url:k.api.reportCrewSummary,key:"report"});H.summaryReport.agents=q({method:"GET",url:k.api.reportAgentsSummary,key:"report"});H.summaryReport.desks=q({method:"GET",url:k.api.reportDesksSummary,
key:"report"});H.summaryReport.campaigns=q({method:"GET",url:k.api.reportCampaignsSummary,key:"report"});H.summaryReport.revenue=q({method:"GET",url:k.api.reportRevenueSummary,key:"report"});H.advancedReport=q({method:"POST",url:k.api.reportAdvanced,key:"report"});var L=z("group"),E=C("group");E.duplicate=q({method:"POST",url:k.api.duplicateGroup,key:"group",formName:"duplicateGroupForm"});E.remove=q({method:"DELETE",url:k.api.group,formName:"disableForm"});var N=z("groupOverride");N.related=q({method:"GET",
url:k.api.relatedGroupOverrides,isArray:!0,key:"groupOverrides"});var I=C("groupOverride");I.activities=q({method:"GET",url:k.api.groupOverrideActivities,isArray:!0,key:"activities"});var D=z("bankAccount"),Z=C("bankAccount");Z.remove=q({method:"DELETE",url:k.api.bankAccount,key:"bankAccount"});Z.verify=q({method:"PUT",url:k.api.verifyBankAccount,key:"verifiedBankAccount",formName:"verifyBankAccountForm"});var ia=z("card"),J=C("card");J.remove=q({method:"DELETE",url:k.api.card,key:"disableForm"});
var ea=q({method:"GET",url:k.api.cardAffiliations,isArray:!0,key:"cardAffiliations"});ea.create=q({method:"POST",url:k.api.cardAffiliations,isArray:!0,key:"cardAffiliations",form:"cardAffiliationsForm"});var P=z("customManifest"),wa=C("customManifest"),ja=z("customCalendar"),ba=C("customCalendar"),S=z("customReport"),ca=C("customReport"),la=q({method:"GET",url:k.api.users,isArray:!0,key:"users"});la.pickable=x(la);la.all=q({method:"GET",url:k.api.allUsers,isArray:!0,key:"users"});la.related=q({method:"GET",
url:k.api.relatedUsers,isArray:!0,key:"users"});la.create=q({method:"POST",url:k.api.users,key:"user",formName:"createUserForm"});var na=q({method:"GET",url:k.api.user,key:"user"});na.update=q({method:"PUT",url:k.api.user,key:"user",formName:"updateUserForm"});na.remove=q({method:"DELETE",url:k.api.user});na.activities=q({method:"GET",url:k.api.userActivities,isArray:!0,key:"activities"});na.subscriptions=q({method:"GET",url:k.api.userSubscriptions,isArray:!0,key:"subscriptions"});na.itemSubscriptions=
q({method:"GET",url:k.api.userItemSubscriptions,isArray:!0,key:"subscriptions"});na.itemSubscriptions.update=q({method:"POST",url:k.api.userItemSubscriptions,isArray:!0,key:"subscriptions"});na.overview=q({method:"GET",url:k.api.userOverview,key:"overview"});na.nags={};na.nags.update=q({method:"PUT",url:k.api.userNags,key:"userNags",formName:"userNagsForm"});var ka=z("item");ka.pickable=x(ka);ka.public=F(ka,"public");ka.all=q({method:"GET",url:k.api.allItems,isArray:!0,key:"items"});ka.calendar=q({method:"GET",
url:k.api.itemsCalendar,key:"calendar"});var U=C("item");U.color=q({method:"PUT",url:k.api.itemColor,key:"color",formName:"updateItemColorForm"});U.calendar=q({method:"GET",url:k.api.itemCalendar,key:"calendar"});U.duplicate=q({method:"POST",url:k.api.duplicateItem,key:"item"});U.subscriptions=q({method:"GET",url:k.api.itemSubscriptions,isArray:!0,key:"subscriptions"});U.images=q({method:"GET",url:k.api.itemImages,key:"images",isArray:!0});U.images.create=q({method:"POST",url:k.api.itemImages,key:"image"});
U.image={};U.image.update=q({method:"PUT",url:k.api.itemImage,key:"image"});U.image.remove=q({method:"DELETE",url:k.api.itemImage});U.viatorSettings={};U.viatorSettings.update=q({method:"PUT",url:k.api.viatorSettings,key:"viatorSettings",formName:"viatorSettingsForm"});U.viatorMappings=z("viatorMapping");U.viatorMapping=C("viatorMapping");U.reviewExpressSettings={};U.reviewExpressSettings.update=q({method:"PUT",url:k.api.reviewExpressSettings,key:"reviewExpressSettings",form:"reviewExpressSettingsForm"});
U.picthriveSettings={};U.picthriveSettings.update=q({method:"PUT",url:k.api.picthriveSettings,key:"picthriveSettings",formName:"picthriveSettingsForm"});U.ratings=q({method:"GET",url:k.api.itemRatings,key:"ratings"});U.flowPages=q({method:"GET",isArray:!0,url:k.api.itemFlowPages,key:"flowNodes"});U.flowPages.full=F(U.flowPages,"full");U.futureAvailabilityCount=q({method:"GET",url:k.api.futureAvailabilityCount,key:"futureAvailabilityCount"});var aa=C("flowNode"),Q=function(){return a.get("flows").wrapEndpoint(aa).apply(null,
arguments)};Q.update=aa.update;Q.remove=aa.remove;var Ga=q({method:"GET",url:k.api.defaultFlowPage,key:"defaultFlowPage"});Q.withDescendants=F(q({method:"GET",url:k.api.flowNode,key:"flowNode",ignoreQueryParamsInCacheUri:!0}),"descendants");Q.duplicate=q({method:"POST",url:k.api.duplicateFlowNode,key:"flowNode"});var xa=z("flowNode");xa.multi=q({method:"POST",url:k.api.flowNodes,isArray:!0,key:"flowNodes",formName:"flowNodeForm"});xa.root=F(xa,"root");xa.root.create=F(xa.create,"root");xa.pages=F(xa,
"pages");var ma=q({method:"GET",url:k.api.affiliates,isArray:!0,key:"affiliations"});ma.all=q({method:"GET",url:k.api.allAffiliates,isArray:!0,key:"affiliations"});ma.pickable=x(ma);ma.create=q({method:"POST",url:k.api.affiliates,key:"affiliation",formName:"createAffiliationForm"});var da=q({method:"GET",url:k.api.affiliate,key:"affiliation"});da.update=q({method:"PUT",url:k.api.affiliate,key:"affiliation",formName:"updateAffiliationForm"});da.remove=q({method:"DELETE",url:k.api.affiliate,formName:"disableForm"});
var sa=q({method:"GET",url:k.api.affiliateCards,key:"cards",isArray:!0,flashError:!1}),W=q({method:"GET",url:k.api.affiliateCardAffiliations,key:"cardAffiliations",isArray:!0,flashError:!1}),Ba=q({method:"GET",url:k.api.partners,isArray:!0,key:"affiliations"});Ba.all=F(Ba,"all");Ba.pickable=x(Ba);var Za=q({method:"GET",url:k.api.partner,key:"partner"});Za.remove=q({method:"DELETE",url:k.api.partner,formName:"disableForm"});var ta=q({method:"GET",url:k.api.partnerCards,key:"cards",isArray:!0,flashError:!1}),
Yb=q({method:"GET",url:k.api.partnerCardAffiliations,key:"cardAffiliations",isArray:!0,flashError:!1}),Cb=z("agent");Cb.all=q({method:"GET",url:k.api.allAgents,isArray:!0,key:"agents"});var Db=C("agent"),Ca=z("desk");Ca.all=q({method:"GET",url:k.api.allDesks,isArray:!0,key:"desks"});var Ka=C("desk"),Ya=z("hotel"),xc=C("hotel"),Eb=z("lodging");Eb.duplicate=q({method:"POST",url:k.api.duplicateLodgingsAcrossCompanies,formName:"duplicateLodgingsAcrossCompaniesForm",key:"lodgings",isArray:!0});var $a=
C("lodging"),Xa=z("preferredPickup"),ra=C("preferredPickup"),ga=z("pickup");ga.duplicate=q({method:"POST",url:k.api.duplicatePickupsAcrossCompanies,formName:"duplicatePickupsAcrossCompaniesForm",key:"pickups",isArray:!0});var ya=C("pickup"),Ab=z("route");Ab.pickable=x(Ab);Ab.duplicate=q({method:"POST",url:k.api.duplicateRoutesAcrossCompanies,formName:"duplicateRoutesAcrossCompaniesForm",key:"routes",isArray:!0});var Bb=C("route");Bb.items=q({method:"GET",url:k.api.routeItems,isArray:!0,key:"items"});
Bb.duplicate=q({method:"POST",url:k.api.duplicateRoute,key:"route",formName:"duplicateRouteForm"});var qf=z("stop"),hd=C("stop"),wc={};wc.searchByDate=q({method:"GET",url:k.api.searchRunsByDate,isArray:!0,key:"runs"});wc.manifest=q({method:"GET",url:k.api.runsManifest,isArray:!0,key:"runs"});var id=q({method:"GET",url:k.api.campaigns,isArray:!0,key:"campaigns"});id.create=q({method:"POST",url:k.api.campaigns,key:"campaign"});var Gb=q({method:"GET",url:k.api.campaign,key:"campaign"});Gb.update=q({method:"PUT",
url:k.api.campaign,key:"campaign"});Gb.remove=q({method:"DELETE",url:k.api.campaign,formName:"disableForm"});Gb.customFields=q({method:"GET",url:k.api.campaignCustomFields,isArray:!0,key:"customFields"});var Qd=q({method:"GET",url:k.api.campaignValidityRules,isArray:!0,key:"campaignValidityRules"});Qd.create=q({method:"POST",url:k.api.campaignValidityRules,key:"campaignValidityRule",formName:"createCampaignValidityRuleForm"});var Rd=q({method:"GET",url:k.api.campaignValidityRule,key:"campaignValidityRule"});
Rd.remove=q({method:"DELETE",url:k.api.campaignValidityRule,formName:"disableForm"});var La=q({method:"GET",url:k.api.codes,isArray:!0,key:"codes"});La.create=q({method:"POST",url:k.api.codes,key:"codes",isArray:!0,formName:"createCodesForm"});La.byTag={};La.byTag.clear=q({method:"DELETE",url:k.api.codesByTag});var ab=q({method:"GET",url:k.api.code,key:"code"});ab.update=q({method:"PUT",url:k.api.code,key:"code",formName:"updateCodeForm"});ab.remove=q({method:"DELETE",url:k.api.code});var yc=z("storedValueType"),
vf=C("storedValueType"),Da=q({method:"GET",url:k.api.storedValueCards,isArray:!0,key:"storedValueCards"});Da.create=q({method:"POST",url:k.api.storedValueCards,key:"storedValueCards",isArray:!0,formName:"createStoredValueCardsForm"});Da.search=q({method:"GET",url:k.api.searchStoredValueCardsByNumber,key:"searchResult"});var nb=C("storedValueCard");nb.payments=q({method:"GET",url:k.api.storedValueCardPayments,isArray:!0,key:"payments"});nb.notifications={};nb.notifications.create=q({method:"POST",
url:k.api.storedValueCardNotifications,isArray:!0,key:"notifications",formName:"storedValueCardNotificationForm"});var zc=z("storedValueAdjustment"),jd=C("storedValueAdjustment");delete jd.update;delete jd.remove;var wf=z("resellerCompany","resellerCompanies"),xf=C("resellerCompany"),yf=z("resellerCompanyMapping"),zf=C("resellerCompanyMapping"),Af=z("resellerItem"),Bf=C("resellerItem"),Sd=z("resellerItemMapping"),Cf=C("resellerItemMapping"),Td=z("resellerCustomerType"),Df=C("resellerCustomerType"),
Ef=z("resellerCustomerTypeMapping"),Ff=C("resellerCustomerTypeMapping"),Gf=z("resellerOption"),Hf=C("resellerOption"),If=z("resellerOptionMapping"),kd=C("resellerOptionMapping"),Ud=q({method:"GET",url:k.api.resellerUnmappedItems,isArray:!0,key:"items"}),Ac=q({method:"GET",url:k.api.resellerUnmappedCustomerPrototypes,isArray:!0,key:"customerPrototypes"}),ld=z("resellerKey"),Vd=C("resellerKey"),Jf=z("resellerApp"),ob=C("resellerApp"),Hb=z("resellerAppRequest"),Ib=C("resellerAppRequest");Hb.refresh=
F(Hb,"refresh");var md=z("resellerAppCompany","resellerAppCompanies"),Bc=C("resellerAppCompany"),Jb=q({method:"GET",url:k.api.customFields,isArray:!0,key:"customFields"});Jb.all=q({method:"GET",url:k.api.allCustomFields,isArray:!0,key:"customFields"});Jb.create=q({method:"POST",url:k.api.customFields,key:"customField",formName:"createCustomFieldForm"});var bb=q({method:"GET",url:k.api.customField,key:"customField"});bb.items=q({method:"GET",url:k.api.customFieldItems,key:"items",isArray:!0});bb.duplicate=
q({method:"POST",url:k.api.duplicateCustomField,key:"customField",formName:"duplicateCustomFieldForm"});bb.prevalidate=q({method:"POST",url:k.api.prevalidateCustomField,key:"prevalidity",formName:"prevalidateCustomFieldForm",flashError:!1});bb.update=q({method:"PUT",url:k.api.customField,key:"customField",formName:"updateCustomFieldForm"});bb.remove=q({method:"DELETE",url:k.api.customField,formName:"disableForm"});var Zb={};Zb.create=q({method:"POST",url:k.api.transportationOptions,key:"transportationOption"});
var $b={};$b.update=q({method:"PUT",url:k.api.transportationOption,key:"transportationOption"});$b.remove=q({method:"DELETE",url:k.api.transportationOption});var Kb={};Kb.create=q({method:"POST",url:k.api.extendedOptions,key:"extendedOption",formName:"createExtendedOptionForm"});var Cc={};Cc.update=q({method:"PUT",url:k.api.extendedOption,key:"extendedOption",formName:"updateExtendedOptionForm"});Cc.remove=q({method:"DELETE",url:k.api.extendedOption,key:"extendedOption",formName:"disableForm"});var nd=
{};nd.create=q({method:"POST",url:k.api.connectedCampaigns,key:"connectedCampaign",formName:"createConnectedCampaignForm"});var Wd={};Wd.remove=q({method:"DELETE",url:k.api.connectedCampaign});var pb={};pb.create=q({method:"POST",url:k.api.generatingCampaigns,key:"generatingCampaign",formName:"generatingCampaignForm"});var Dc={};Dc.update=q({method:"PUT",url:k.api.generatingCampaign,key:"generatingCampaign",formName:"generatingCampaignForm"});Dc.remove=q({method:"DELETE",url:k.api.generatingCampaign});
var Ec=C("customFieldInstanceGroup"),ac=z("customFieldInstanceGroup");ac.multi=q({method:"POST",url:k.api.customFieldInstanceGroupsMulti,isArray:!0,key:"customFieldInstanceGroups",formName:"customFieldInstanceGroupsForm"});Ec.remove=q({method:"DELETE",url:k.api.customFieldInstanceGroup,key:"customFieldInstanceGroup",formName:"disableForm"});Ec.duplicate=q({method:"POST",url:k.api.duplicateCustomFieldInstanceGroup,key:"customFieldInstanceGroup",formName:"duplicateForm"});var Xd=C("customFieldInstance"),
Yd=z("customFieldInstance");Yd.multi=q({method:"POST",url:k.api.customFieldInstancesMulti,isArray:!0,key:"customFieldInstances",formName:"customFieldInstancesForm"});var Zd=C("customFieldInstanceCondition"),Kf=z("customFieldInstanceCondition"),Lf=C("supportedLanguage"),$d=z("supportedLanguage"),ae=q({method:"GET",url:k.api.translations,key:"translations"}),be=q({method:"GET",url:k.api.translationsForModel,key:"translationsForModel",isArray:!0}),Fc=q({method:"GET",url:k.api.translationsForField,key:"translationsAndSourceField"});
Fc.update=q({method:"POST",url:k.api.translationsForField,key:"updatedTranslations",formName:"translationsForFieldForm",isArray:!0});var ce=q({method:"GET",url:k.api.understoodLanguages,key:"understoodLanguages"}),de=q({method:"GET",url:k.api.translationsForSubfield,key:"translationsAndSourceField"});de.update=q({method:"POST",url:k.api.translationsForSubfield,key:"updatedTranslations",formName:"translationsForFieldForm",isArray:!0});var ee=q({method:"GET",url:k.api.roles,isArray:!0,key:"roles"});
ee.create=q({method:"POST",url:k.api.roles,key:"role"});var Gc=q({method:"GET",url:k.api.role,key:"role"});Gc.update=q({method:"PUT",url:k.api.role,key:"role"});Gc.remove=q({method:"DELETE",url:k.api.role});var ib=q({method:"GET",url:k.api.crewMembers,isArray:!0,key:"crewMembers"});ib.create=q({method:"POST",url:k.api.crewMembers,key:"crewMember"});var Hc=q({method:"GET",url:k.api.crewMember,key:"crewMember"});Hc.update=q({method:"PUT",url:k.api.crewMember,key:"crewMember"});Hc.remove=q({method:"DELETE",
url:k.api.crewMember,key:"crewMember"});var od=C("customerType");od.items=q({method:"GET",url:k.api.customerTypeItems,key:"items",isArray:!0});var fe=z("customerType");fe.all=q({method:"GET",url:k.api.allCustomerTypes,isArray:!0,key:"customerTypes"});var ge=C("customerPrototype");ge.duplicate=q({method:"POST",url:k.api.duplicateCustomerPrototype,key:"customerPrototype",formName:"duplicateForm"});var Ic=z("customerPrototype");Ic.all=q({method:"GET",url:k.api.allCustomerPrototypes,isArray:!0,key:"customerPrototypes"});
Ic.multi=q({method:"POST",url:k.api.customerPrototypesMulti,isArray:!0,key:"customerPrototypes",formName:"customerPrototypesForm"});var he=C("checkinStatus","checkinStatuses"),ie=z("checkinStatus","checkinStatuses");he.updateBookings=q({method:"PUT",url:k.api.checkinStatusForBookings,key:"bookings",isArray:!0,formName:"updateCheckinStatusForBookingsForm"});var je=z("cannedMessage"),cb=C("cannedMessage");cb.items=q({method:"GET",url:k.api.cannedMessageItems,key:"items",isArray:!0});var Ea={};Ea.next=
q({method:"GET",url:k.api.nextAvailability,key:"availability"});Ea.update=q({method:"POST",url:k.api.updateAvailabilities,formName:"updateAvailabilitiesForm",key:"updateAvailabilities"});Ea.updateByItem=q({method:"POST",url:k.api.updateItemAvailabilities,formName:"updateAvailabilitiesForm",key:"updateAvailabilities"});Ea.byDate=q({method:"GET",url:k.api.availabilitiesByDate,isArray:!0,key:"availabilities"});Ea.byTag={};Ea.byTag.clear=q({method:"DELETE",url:k.api.availabilitiesByTag,formName:"disableForm"});
Ea.futureCount=q({method:"GET",url:k.api.futureAvailabilityCount,key:"futureAvailabilityCount"});Ea.searchByDate=q({method:"GET",url:k.api.searchAvailabilitiesByDate,isArray:!0,key:"availabilities"});Ea.searchByPk=q({method:"GET",url:k.api.searchAvailabilitiesByPk,isArray:!0,key:"availabilities"});Ea.manifest=q({method:"GET",url:k.api.availabilitiesManifest,isArray:!0,key:"availabilities",sideKeys:["bookings","crewMembers"]});Ea.manifestSelectable=q({method:"GET",url:k.api.manifestSelectableAvailabilities,
isArray:!0,key:"availabilities"});Ea.searchByUpcoming=q({method:"GET",url:k.api.searchAvailabilitiesByUpcoming,isArray:!0,key:"availabilities"});Ea.rule=q({method:"POST",url:k.api.rule,key:"createdAvailabilities",formName:"ruleForm"});var Ha=q({method:"GET",url:k.api.availability,key:"availability"});Ha.update=q({method:"PUT",url:k.api.availability,key:"availability",formName:"updateAvailabilityForm"});Ha.status={};Ha.status.update=q({method:"PUT",url:k.api.availabilityStatus,key:"availabilityStatus",
formName:"updateAvailabilityStatusForm"});Ha.book=q({method:"POST",url:k.api.book,key:"booking",formName:"bookForm"});Ha.liveCapacity=q({method:"GET",url:k.api.availabilityLiveCapacity,key:"liveCapacity",formName:"liveCapacityForm"});Ha.resourceUses=q({method:"GET",url:k.api.availabilityResourceUses,key:"resourceUses",isArray:!0});Ha.remove=q({method:"DELETE",url:k.api.availability,formName:"disableForm"});Ha.notifications=q({method:"POST",url:k.api.notifications,formName:"notificationsForm"});Ha.note=
{};Ha.note=q({method:"PUT",url:k.api.availabilityNote,key:"note",formName:"updateAvailabilityNoteForm"});Ha.smsNotifications={};Ha.smsNotifications.create=q({method:"POST",url:k.api.smsNotifications,formName:"smsNotificationsForm"});Ha.checkinStatuses=q({method:"GET",url:k.api.availabilityCheckinStatuses,isArray:!0,key:"bookings"});var Lb={};Lb.create=q({method:"POST",url:k.api.customerTypeRates,key:"customerTypeRate"});var Jc={};Jc.remove=q({method:"DELETE",url:k.api.customerTypeRate,formName:"disableForm"});
Jc.update=q({method:"PUT",url:k.api.customerTypeRate,key:"customerTypeRate"});var pd=z("block"),ke=C("block"),bc={};bc.availability=q({method:"GET",url:k.api.subjectsAvailability,key:"subjects"});bc.booking=q({method:"GET",url:k.api.subjectsBooking,key:"subjects"});bc.order=q({method:"GET",url:k.api.subjectsOrder,key:"subjects"});var Kc=C("contact");Kc.bookings={};Kc.bookings.update=q({method:"PUT",url:k.api.contactBookings,key:"modified"});var Lc={};Lc.report=q({method:"GET",url:k.api.reportContacts,
key:"report"});var le=q({method:"GET",url:k.api.contactPayments,isArray:!0,key:"payments"}),cc=q({method:"GET",url:k.api.order,key:"order"}),me=q({method:"GET",url:k.api.order,key:"order",ignoreQueryParamsInCacheUri:!0});cc.wait=F(me,"wait");cc.notification=q({method:"POST",url:k.api.orderNotification,formName:"orderNotificationForm"});cc.cancel=q({method:"POST",url:k.api.orderCancellation,key:"order",formName:"cancelOrderBookingsForm"});var Mc={};Mc.create=q({method:"POST",url:k.api.orders,key:"order",
formName:"orderForm"});var dc=q({method:"GET",url:k.api.orderPayments,isArray:!0,key:"payments"});dc.create=q({method:"POST",url:k.api.orderPayments,key:"payments"});dc.refund=q({method:"POST",url:k.api.orderRefunds,isArray:!0,key:"payments"});var jb=q({method:"GET",url:k.api.bookings,isArray:!0,key:"bookings"});jb.byContact=q({method:"GET",url:k.api.bookingsByContact,isArray:!0,key:"bookings"});jb.searchByQuery=q({method:"GET",url:k.api.searchBookingsByQuery,isArray:!0,key:"bookings"});jb.searchByNew=
q({method:"GET",url:k.api.searchBookingsByNew,isArray:!0,key:"bookings"});jb.report=q({method:"GET",url:k.api.reportBookings,key:"report"});jb.invoiceableReport=q({method:"GET",url:k.api.reportInvoiceableBookings,key:"report"});jb.manifest=q({method:"GET",url:k.api.bookingsManifest,isArray:!0,key:"bookings"});jb.searchByUuid=q({method:"GET",url:k.api.searchBookingsByUuid,isArray:!0,key:"bookings"});var qa=q({method:"GET",url:k.api.booking,key:"booking"}),ne=q({method:"GET",url:k.api.booking,key:"booking",
ignoreQueryParamsInCacheUri:!0});qa.wait=F(ne,"wait");qa.byPk=q({method:"GET",url:k.api.bookingByPk,key:"booking",ignoreCache:!0});qa.reprice=q({method:"PUT",url:k.api.repriceBooking,key:"repricing",formName:"repriceBookingForm"});qa.notification=q({method:"POST",url:k.api.notification,formName:"notificationForm"});qa.smsNotification=q({method:"POST",url:k.api.smsNotification,formName:"smsNotificationForm"});qa.cancel=q({method:"DELETE",url:k.api.booking,key:"booking",formName:"cancelBookingForm"});
qa.note={};qa.note.update=q({method:"PUT",url:k.api.bookingNote,key:"note",formName:"updateBookingNoteForm"});qa.explicitGross={};qa.explicitGross.update=q({method:"PUT",url:k.api.bookingExplicitGross,key:"explicitGross",formName:"updateBookingExplicitGrossForm"});qa.explicitInvoicePrice={};qa.explicitInvoicePrice.update=q({method:"PUT",url:k.api.bookingExplicitInvoicePrice,key:"explicitInvoicePrice",formName:"updateBookingExplicitInvoicePriceForm"});qa.notificationOptions={};qa.notificationOptions.update=
q({method:"PUT",url:k.api.bookingNotificationOptions,key:"notificationOptions",formName:"updateBookingNotificationOptionsForm"});qa.affiliation={};qa.affiliation.update=q({method:"PUT",url:k.api.affiliation,key:"affiliation"});qa.checkinStatus={};qa.checkinStatus.update=q({method:"PUT",url:k.api.bookingCheckinStatus,key:"bookingCheckinStatus",formName:"updateBookingCheckinStatusForm"});qa.effectiveCancellationRule=q({method:"GET",url:k.api.bookingEffectiveCancellationRule,key:"cancellationRule"});
var qd={checkinStatus:{}};qd.checkinStatus.update=q({method:"PUT",url:k.api.customerCheckinStatus,key:"customerCheckinStatus",formName:"updateCustomerCheckinStatusForm"});var ec={};ec.find=q({method:"GET",url:k.api.searchCustomersByEncodedPk,key:"booking"});var rd={};rd.update=q({method:"PUT",url:k.api.bookingCustomFieldValue,key:"customFieldValue"});var Nc={};Nc.update=q({method:"PUT",url:k.api.customerCustomFieldValue,key:"customFieldValue"});var Ja=z("report");Ja.recent=q({method:"GET",url:k.api.recentReports,
key:"reports",isArray:!0});Ja.inProgress=q({method:"GET",url:k.api.inProgressReports,key:"reports",isArray:!0});Ja.volumeOverview=q({method:"GET",url:k.api.volumeOverviewReport,key:"volume"});Ja.dailyVolumeOverview=q({method:"GET",url:k.api.dailyVolumeOverviewReport,key:"dailyVolume"});Ja.paymentOverview=q({method:"GET",url:k.api.paymentOverviewReport,key:"paymentOverview"});Ja.itemsSummaryOverview=q({method:"GET",url:k.api.itemsSummaryOverviewReport,key:"itemsSummary"});Ja.nextPayoutOverview=q({method:"GET",
url:k.api.nextPayoutOverviewReport,key:"nextPayout"});Ja.report=q({method:"GET",url:k.api.reportReports,key:"report"});var Oa=C("report");Oa.rerun=Oa.update;delete Oa.update;Oa.cancel=q({method:"DELETE",url:k.api.report,formName:"disableForm",key:"report"});delete Oa.remove;Oa.objects=q({method:"POST",url:k.api.reportObjects,key:"objects",isArray:!1});var Oc=z("invoice");Oc.report=q({method:"GET",url:k.api.reportInvoices,key:"report"});Oc.partnerInvoice=q({method:"GET",url:k.api.partnerInvoice,key:"invoice"});
var Mb=C("invoice");Mb.uploads=q({method:"GET",url:k.api.invoiceUploads,isArray:!0,key:"uploads"});Mb.uploads.create=q({method:"POST",url:k.api.invoiceUploads,key:"upload"});Mb.notifications={};Mb.notifications.create=q({method:"POST",url:k.api.invoiceNotifications,isArray:!0,key:"notifications",formName:"invoiceNotificationForm"});Mb.uuid=q({method:"GET",url:k.api.uuidInvoice,key:"invoice"});var fc={};fc.create=q({method:"POST",url:k.api.lineItems,key:"lineItem"});fc.report=q({method:"GET",url:k.api.reportLineItems,
key:"report"});var Pc=q({method:"GET",url:k.api.lineItem,key:"lineItem"});Pc.remove=q({method:"DELETE",url:k.api.lineItem});Pc.update=q({method:"PUT",url:k.api.lineItem,key:"lineItem"});var oe=z("tagGroup"),Mf=C("tagGroup"),sd={};sd.create=q({method:"POST",url:k.api.tags,key:"tag"});var gc={};gc.update=q({method:"PUT",url:k.api.tag,key:"tag"});gc.remove=q({method:"DELETE",url:k.api.tag,formName:"disableForm"});var td=q({method:"GET",url:k.api.objectTags,key:"objectTags",isArray:!0});td.update=q({method:"PUT",
url:k.api.objectTags,key:"objectTags",isArray:!0});var qb=q({method:"GET",url:k.api.payments,isArray:!0,key:"payments"});qb.related=q({method:"GET",url:k.api.relatedPayments,isArray:!0,key:"payments"});qb.create=q({method:"POST",url:k.api.payments,key:"payment"});qb.refund=q({method:"POST",url:k.api.refunds,isArray:!0,key:"payments"});qb.report=q({method:"GET",url:k.api.reportPayments,key:"report"});qb.volumeReport=q({method:"GET",url:k.api.reportVolume,key:"report"});var ud=q({method:"GET",url:k.api.paymentFees,
isArray:!0,key:"payments"});ud.update=q({method:"POST",url:k.api.paymentFees,key:"payments"});var pe=z("inStorePaymentType");pe.all=q({method:"GET",url:k.api.allInStorePaymentTypes,isArray:!0,key:"inStorePaymentTypes"});var Nb=C("inStorePaymentType"),Ob=z("emvDevice"),vd=C("emvDevice");vd.authenticate=q({method:"POST",url:k.api.retrieveConnectionToken,key:"activation",formName:"retrieve_connection_token_form",flashError:!1});vd.createInteractionToken=q({method:"POST",url:k.api.createInteractionToken,
key:"tokenId",formName:"emv_device_create_payment_intent_form",flashError:!1});var wd={custom:{}};wd.custom.create=q({method:"POST",url:k.api.customRefunds,key:"refund",formName:"customRefundForm"});var Pb={};Pb.report=q({method:"GET",url:k.api.reportDisputes,key:"report"});var qe=q({method:"GET",url:k.api.payouts,isArray:!0,key:"payouts"});qe.report=q({method:"GET",url:k.api.reportPayouts,key:"report"});var hc=q({method:"GET",url:k.api.payout,key:"payout"});hc.retry=q({method:"PUT",url:k.api.payoutRetry,
key:"payoutRetry"});var ic=q({method:"GET",url:k.api.transfers,isArray:!0,key:"transfers"});ic.create=q({method:"POST",url:k.api.transfers,key:"transfer"});var xd=q({method:"GET",url:k.api.transfer,key:"transfer"}),jc={};jc.create=q({method:"POST",url:k.api.oneTimeTransfer,formName:"transferAndUploadDelegateForm",key:"oneTimeTransfer"});var kc=q({method:"GET",url:k.api.upcomingRefundReserveAmount,key:"upcomingRefundReserveAmount"}),Qb=q({method:"GET",url:k.api.uploads,isArray:!0,key:"uploads"});Qb.create=
q({method:"POST",url:k.api.uploads,key:"upload"});var re=q({method:"GET",url:k.api.upload,key:"upload"}),Qc=q({method:"GET",url:k.api.funds,isArray:!0,key:"funds"});Qc.report=q({method:"GET",url:k.api.reportFunds,key:"report"});var Nf=q({method:"GET",url:k.api.fund,key:"fund"}),se=q({method:"GET",url:k.api.adjustments,isArray:!0,key:"adjustments"});se.create=q({method:"POST",url:k.api.adjustments,key:"adjustment"});var Of=q({method:"GET",url:k.api.adjustment,key:"adjustment"}),yd={};yd.report=q({method:"GET",
url:k.api.reportTransactions,key:"report"});var rb=q({method:"GET",url:k.api.activities,isArray:!0,key:"activities"});rb.notes={};rb.notes.create=q({method:"POST",url:k.api.notes,key:"activity",formName:"noteForm"});var Rc=q({method:"GET",url:k.api.activity,key:"activity"});Rc.update=q({method:"PUT",url:k.api.activity,key:"activity"});var te=q({method:"PUT",url:k.api.reorder,key:"reorder"}),Ta=q({method:"GET",url:k.api.waivers,isArray:!0,key:"waivers"});Ta.create=q({method:"POST",url:k.api.waivers,
key:"waiver"});var Sc=q({method:"GET",url:k.api.waiver,key:"waiver"});Sc.update=q({method:"PUT",url:k.api.waiver,key:"waiver"});Sc.remove=q({method:"DELETE",url:k.api.waiver,formName:"disableForm"});var kb={};kb.create=q({method:"POST",url:k.api.connectedWaivers,key:"connectedWaiver",formName:"createConnectedWaiverForm"});var lc={};lc.remove=q({method:"DELETE",url:k.api.connectedWaiver});var ue={};ue.remove=q({method:"DELETE",url:k.api.waiverInstance,key:"waiverInstance"});var Tc=z("totalSchedule");
Tc.online=F(Tc,"online");var Uc=C("totalSchedule"),Pf=z("totalScheduleEntry","totalScheduleEntries"),Qf=C("totalScheduleEntry"),Rf=z("totalScheduleEntryRule"),Sf=C("totalScheduleEntryRule"),Tf=z("invoiceSchedule"),zd=C("invoiceSchedule"),Uf=z("invoiceScheduleEntry","invoiceScheduleEntries"),ve=C("invoiceScheduleEntry"),we=z("invoiceScheduleEntryRule"),xe=C("invoiceScheduleEntryRule");Uc.duplicate=q({method:"POST",url:k.api.duplicateTotalSchedule,key:"totalSchedule",formName:"duplicateTotalScheduleForm"});
Uc.affiliations=q({method:"GET",isArray:!0,url:k.api.totalScheduleAffiliations,key:"affiliations"});zd.duplicate=q({method:"POST",url:k.api.duplicateInvoiceSchedule,key:"invoiceSchedule",formName:"duplicateInvoiceScheduleForm"});zd.affiliations=q({method:"GET",isArray:!0,url:k.api.invoiceScheduleAffiliations,key:"affiliations"});var ye=q({method:"GET",url:k.api.effectiveSheets,key:"effectiveSheets"}),Vf=q({method:"GET",url:k.api.affiliationEffectiveSheets,key:"effectiveSheets"}),Wf=q({method:"GET",
url:k.api.rebookingEffectiveSheets,key:"effectiveSheets"}),Xf=q({method:"GET",url:k.api.totalScheduleEffectiveSheet,key:"effectiveSheets"}),ze=q({method:"GET",url:k.api.invoiceScheduleEffectiveSheet,key:"effectiveSheets"}),db=z("totalSheet");db.all=F(db,"all");db.nonBase=F(db,"nonBase");db.online=F(db,"online");db.bases=F(db,"bases");var sb=C("totalSheet");sb.duplicate=q({method:"POST",url:k.api.duplicateTotalSheet,key:"totalSheet",formName:"duplicateSheetForm"});sb.pricing=q({method:"GET",url:k.api.totalPricing,
key:"effectivePricings",isArray:!0});sb.pricing.update=q({method:"PUT",url:k.api.totalPricing,key:"effectivePricings",isArray:!0,formName:"priceLineForm"});sb.pricing.stack=q({method:"GET",url:k.api.totalStack,key:"lines",isArray:!0});sb.schedules=q({method:"GET",isArray:!0,url:k.api.totalSheetSchedules,key:"totalSchedules"});sb.affiliations=q({method:"GET",isArray:!0,url:k.api.totalSheetAffiliations,key:"affiliations"});var mc=z("invoiceSheet");mc.all=F(mc,"all");mc.nonBase=F(mc,"nonBase");var tb=
C("invoiceSheet");tb.duplicate=q({method:"POST",url:k.api.duplicateInvoiceSheet,key:"invoiceSheet",formName:"duplicateSheetForm"});tb.pricing=q({method:"GET",url:k.api.invoicePricing,key:"effectivePricings",isArray:!0});tb.pricing.update=q({method:"PUT",url:k.api.invoicePricing,key:"effectivePricings",isArray:!0,formName:"priceLineForm"});tb.pricing.stack=q({method:"GET",url:k.api.invoiceStack,key:"lines",isArray:!0});tb.schedules=q({method:"GET",isArray:!0,url:k.api.invoiceSheetSchedules,key:"invoiceSchedules"});
tb.affiliations=q({method:"GET",isArray:!0,url:k.api.invoiceSheetAffiliations,key:"affiliations"});var Vc={};Vc.channels=q({method:"GET",url:k.pusher.channels,key:"channels",isArray:!0});Vc.members=q({method:"POST",url:k.pusher.members,key:"channels",isArray:!0});var ub=z("taxType");ub.all=F(ub,"all");var nc=C("taxType"),Pa=C("location");Pa.items=q({method:"GET",url:k.api.locationItems,key:"items",isArray:!0});var Ae=z("location");Ae.createPrimary=q({method:"POST",url:k.api.primaryLocation,key:"location"});
var Be=z("resource");Be.manifest=q({method:"GET",url:k.api.resourcesManifest,key:"resources",isArray:!0});var Wc=C("resource");Wc.items=q({method:"GET",url:k.api.resourceItems,key:"items",isArray:!0});Wc.requirementGroups=q({method:"GET",url:k.api.resourceRequirementGroups,key:"requirementGroups",isArray:!0});Wc.availabilities=q({method:"GET",url:k.api.resourceAvailabilities,key:"availabilities",isArray:!0});var Xc={};Xc.byDate=q({method:"GET",url:k.api.resourceUsesByDate,key:"resourceUses",isArray:!0});
Xc.calendar=q({method:"GET",url:k.api.resourceUsesCalendar,key:"calendar"});Xc.reapplyBookingResourceUses=q({method:"POST",url:k.api.reapplyBookingResourceUses,key:"reappliedBookingResourceUses",formName:"reapplyBookingResourceUsesForm"});var Ad=q({method:"GET",url:k.api.itemRequirementGroups,isArray:!0,key:"requirementGroups"});Ad.create=q({method:"POST",url:k.api.itemRequirementGroups,key:"requirementGroup"});var Ce=z("requirementGroup"),De=C("requirementGroup");De.duplicate=q({method:"POST",url:k.api.duplicateRequirementGroup,
key:"requirementGroup",formName:"duplicateRequirementGroupForm"});var Bd=z("requirement"),Cd=C("requirement"),Yf=z("resourceRequirement"),Ee=C("resourceRequirement");Ee.update=q({method:"PUT",url:k.api.resourceRequirement,key:"resourceRequirement",sideKeys:["newResourceRequirement"]});var Zf=C("resourceUse"),Yc=q({method:"GET",url:k.api.resourceOverride,key:"resourceOverride"});Yc.update=q({method:"PUT",url:k.api.resourceOverride,key:"resourceOverride",formName:"resourceOverrideForm"});Yc.remove=
q({method:"DELETE",url:k.api.resourceOverride,formName:"disableForm"});Yc.rule=q({method:"POST",url:k.api.resourceOverrideRule,isArray:!0,key:"resourceOverrides",formName:"resourceOverrideRuleForm"});var Zc={byTag:{}};Zc.byTag.clear=q({method:"DELETE",url:k.api.resourceOverridesByTag,formName:"disableForm"});Zc.byDate=q({method:"GET",url:k.api.resourceOverridesByDate,key:"resourceOverrides",isArray:!0});var $f=z("seatMap"),Fe=C("seatMap");Fe.update=q({method:"PUT",url:k.api.seatMap,key:"seatMap",
sideKeys:["seatPks"]});var Dd=z("seatGroup"),Ge=C("seatGroup"),He=z("seatZone"),Ie=C("seatZone"),ag=z("ticketLayout"),bg=C("ticketLayout"),Je=z("analyticsService"),Ke=C("analyticsService"),Le=z("cancellationPolicy","cancellationPolicies"),oc=C("cancellationPolicy"),Ed=z("cancellationRule"),cg=C("cancellationRule");oc.affiliations=q({method:"GET",isArray:!0,url:k.api.cancellationPolicyAffiliations,key:"affiliations"});oc.items=q({method:"GET",isArray:!0,url:k.api.cancellationPolicyItems,key:"items"});
var dg=z("bookingRestriction"),Fd=C("bookingRestriction");Fd.items=q({method:"GET",isArray:!0,url:k.api.bookingRestrictionItems,key:"items"});var Gd=q({method:"GET",isArray:!0,url:k.api.persistentStore,key:"persistentStores"});Gd.remove=q({method:"DELETE",url:k.api.persistentStore});var $c=q({method:"GET",url:k.api.persistentStoreForCompany,key:"persistentStore"});$c.remove=q({method:"DELETE",url:k.api.persistentStoreForCompany});var ad=q({method:"GET",url:k.api.persistentStoreItem,key:"value"});
ad.update=q({method:"PUT",url:k.api.persistentStoreItem,key:"value",formName:"persistentStoreForm"});ad.remove=q({method:"DELETE",url:k.api.persistentStoreItem});var Rb=q({method:"GET",url:k.api.taskResult,key:"taskResult"}),bd=q({method:"GET",formName:"noForm",key:function(a){return _.keys(a.data)[0]}}),eg=q({method:"GET",url:k.api.version,key:"version"}),pc=function(a,b){return encodeURIComponent(a).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%2F/gi,
"/").replace(/%20/g,b?"%20":"+")},Hd=function(a,b){b=_.isBoolean(b)?b?"yes":"no":b;return pc(a,!0)+"="+pc(b,!0)},Od=function(a){var b=[];_.forEach(a,function(a,d){_.isArray(a)?_.forEach(a,function(a){b.push(Hd(d,a))}):b.push(Hd(d,a))});return b.join("&")};return{CANCELLED:s,toKeyValue:Od,login:w,forgot:G,companies:K,company:H,users:la,user:na,groups:L,group:E,groupOverrides:N,groupOverride:I,contacts:Lc,contact:Kc,contactPayments:le,customManifests:P,customManifest:wa,customCalendars:ja,customCalendar:ba,
customReports:S,customReport:ca,items:ka,item:U,flowNodes:xa,flowNode:Q,defaultFlowPage:function(){return a.get("flows").wrapEndpoint(Ga,!0).apply(null,arguments)},activities:rb,activity:Rc,affiliates:ma,affiliate:da,affiliateCards:sa,affiliateCardAffiliations:W,partners:Ba,partner:Za,partnerCards:ta,partnerCardAffiliations:Yb,agents:Cb,agent:Db,desks:Ca,desk:Ka,cannedMessages:je,cannedMessage:cb,customerPrototypes:Ic,customerPrototype:ge,customerTypes:fe,customerType:od,checkinStatuses:ie,checkinStatus:he,
customFields:Jb,customField:bb,transportationOptions:Zb,transportationOption:$b,extendedOptions:Kb,extendedOption:Cc,connectedCampaigns:nd,connectedCampaign:Wd,generatingCampaigns:pb,generatingCampaign:Dc,customFieldInstances:Yd,customFieldInstance:Xd,customFieldInstanceConditions:Kf,customFieldInstanceCondition:Zd,customFieldInstanceGroups:ac,customFieldInstanceGroup:Ec,customerCustomFieldValue:Nc,bookingCustomFieldValue:rd,availabilities:Ea,availability:Ha,customerTypeRates:Lb,customerTypeRate:Jc,
subjects:bc,blocks:pd,block:ke,orders:Mc,order:cc,orderPayments:dc,bookings:jb,booking:qa,customer:qd,customers:ec,lineItems:fc,lineItem:Pc,payments:qb,disputes:Pb,refunds:wd,paymentFees:ud,inStorePaymentTypes:pe,inStorePaymentType:Nb,emvDevices:Ob,emvDevice:vd,bankAccounts:D,bankAccount:Z,cards:ia,card:J,cardAffiliations:ea,supportedLanguages:$d,supportedLanguage:Lf,translations:ae,translationsForModel:be,translationsForField:Fc,understoodLanguages:ce,translationsForSubfield:de,reports:Ja,report:Oa,
campaigns:id,campaign:Gb,campaignValidityRules:Qd,campaignValidityRule:Rd,codes:La,code:ab,storedValueTypes:yc,storedValueType:vf,storedValueCards:Da,storedValueCard:nb,storedValueAdjustments:zc,storedValueAdjustment:jd,resellerCompanies:wf,resellerCompany:xf,resellerCompanyMappings:yf,resellerCompanyMapping:zf,resellerItems:Af,resellerItem:Bf,resellerItemMappings:Sd,resellerItemMapping:Cf,resellerCustomerTypes:Td,resellerCustomerType:Df,resellerCustomerTypeMappings:Ef,resellerCustomerTypeMapping:Ff,
resellerOptions:Gf,resellerOption:Hf,resellerOptionMappings:If,resellerOptionMapping:kd,resellerUnmappedItems:Ud,resellerUnmappedCustomerPrototypes:Ac,resellerKeys:ld,resellerKey:Vd,resellerApps:Jf,resellerApp:ob,resellerAppRequest:Ib,resellerAppRequests:Hb,resellerAppCompany:Bc,resellerAppCompanies:md,reorder:te,refresh:function(a,b){m.assert(a,"db.refresh: expected uri");return bd(a,null,null,null,b)},slipstream:function(a,b){b=b||{};if(window.slipstream&&window.slipstream[a]){var c=window.slipstream[a],
e=b.doNotConvert||!1;return _.isObject(c)?(c=e?c:d.serverResponse(c),y(c,null,_.isArray(c))):c}},payouts:qe,payout:hc,transfers:ic,transfer:xd,uploads:Qb,upload:re,oneTimeTransfer:jc,upcomingRefundReserveAmount:kc,adjustments:se,adjustment:Of,transactions:yd,funds:Qc,fund:Nf,roles:ee,role:Gc,crewMembers:ib,crewMember:Hc,hotels:Ya,hotel:xc,lodgings:Eb,lodging:$a,pickups:ga,pickup:ya,routes:Ab,route:Bb,stops:qf,stop:hd,runs:wc,preferredPickups:Xa,preferredPickup:ra,testReport:M,invoices:Oc,invoice:Mb,
totalSchedules:Tc,totalSchedule:Uc,totalScheduleEntries:Pf,totalScheduleEntry:Qf,totalScheduleEntryRules:Rf,totalScheduleEntryRule:Sf,invoiceScheduleEntryRules:we,invoiceScheduleEntryRule:xe,invoiceSchedules:Tf,invoiceSchedule:zd,invoiceScheduleEntries:Uf,invoiceScheduleEntry:ve,effectiveSheets:ye,affiliationEffectiveSheets:Vf,rebookingEffectiveSheets:Wf,totalScheduleEffectiveSheet:Xf,invoiceScheduleEffectiveSheet:ze,totalSheets:db,totalSheet:sb,invoiceSheets:mc,invoiceSheet:tb,taxTypes:ub,taxType:nc,
locations:Ae,location:Pa,waivers:Ta,waiver:Sc,connectedWaivers:kb,connectedWaiver:lc,waiverInstance:ue,resources:Be,resource:Wc,resourceUses:Xc,requirementGroups:function(a){var b=Ad(a),d=Ce(a);return f.all([b.$promise,d.$promise]).then(function(){return b.concat(d)})},requirementGroup:De,companyRequirementGroups:Ce,itemRequirementGroups:Ad,requirements:Bd,requirement:Cd,resourceRequirements:Yf,resourceRequirement:Ee,resourceUse:Zf,resourceOverride:Yc,resourceOverrides:Zc,seatMaps:$f,seatMap:Fe,seatGroups:Dd,
seatGroup:Ge,seatZones:He,seatZone:Ie,ticketLayouts:ag,ticketLayout:bg,analyticsServices:Je,analyticsService:Ke,cancellationPolicies:Le,cancellationPolicy:oc,cancellationRules:Ed,cancellationRule:cg,bookingRestrictions:dg,bookingRestriction:Fd,persistentStore:Gd,persistentStoreForCompany:$c,persistentStoreItem:ad,tagGroups:oe,tagGroup:Mf,tags:sd,tag:gc,objectTags:td,taskResult:Rb,version:eg,serverResponse:y,formErrorHandler:B,errorStatus:function(a){return 0===a&&!n?"disconnect":404===a?"not-found":
403===a?"forbidden":"error"},pusher:Vc,searchEndpoint:function(a,b){return function(d){return a(b,null,null,{q:d})}}}}])})();angular.module("prices",["prices.directives","prices.services"]);
(function(){var h=angular.module("prices.directives",[]);h.directive("ngCosts",["$parse","require",function(b,a){return{restrict:"A",templateUrl:"prices.costs",scope:!0,compile:function(c,f){var e=b(f.ngCosts),g=b(f.ngCostsCompany);return function(b,c,f){b.$watch(e,function(c){b.costs=c;a.assert(b.costs,"ng-costs: invalid costs "+f.ngCosts)});b.$watch(g,function(c){b.company=c;a.assert(b.company,"ng-costs: invalid company "+f.ngCostsCompany)})}}}}]);h.directive("ngPrice",["$parse",function(b){return{restrict:"A",
templateUrl:"prices.price",scope:!0,compile:function(a,c){var f=b(c.ngPrice),e=b(c.ngPriceCompany),g=b(c.ngPriceCount);return function(a,b,c){a.$watchCollection(function(){return{effectivePricing:f(a),company:e(a),count:g(a)}},function(b){_.extend(a,b)})}}}}]);h.directive("ngPrices",["$q","auth","db","events","models","prices","require",function(b,a,c,f,e,g,d){return{restrict:"A",scope:!0,controller:function(){var a=this;a.sheets={};a.status="initializing";var m={},k={},n=function(a,b){_.forEach(b,
function(b){b.forObject&&(a[b.forObject.uri]=b)})},h=null,p=null,r=null,t=null,v=function(){if(!a.sheets.totalSheet||!a.object)return console.warn("ng-prices: attempting to refresh without total sheet or object",a.sheets.totalSheet,a.object),b.when();var d=[],e;a.sheets.totalSheet!==h&&(r&&r.cancel&&r.cancel(),e=g.pricing(a.object,a.sheets.totalSheet),r=e.$promise,d.push(r));h=a.sheets.totalSheet;var v;a.sheets.invoiceSheet&&a.sheets.invoiceSheet!==p&&(t&&r.cancel&&t.cancel(),v=g.pricing(a.object,
a.sheets.invoiceSheet),t=v.$promise,d.push(t));p=a.sheets.invoiceSheet;if(!d.length)return f.broadcast("prices.ngPrices.updated"),b.all([r,t]);a.status="initializing"===a.status?"initializing":"loading";return b.all(d).then(function(b){var d=b[0]===c.CANCELLED;b=b[1]===c.CANCELLED;e&&!d&&(m={},n(m,e));v&&!b&&(k={},n(k,v));f.broadcast("prices.ngPrices.updated");a.status="success"},function(){console.warn("ng-prices: unable to retrieve pricing",arguments);m={};k={};p=h=null;f.broadcast("prices.ngPrices.updated");
a.status="error"})};a.updateObject=function(b){a.object=b;v()};a.updateSheets=function(b){d.assert(!!b,"ng-prices: expected sheets",b);a.sheets=b;return v()};a.updateTotalSheet=function(b){d.assert(!!b,"ng-prices: expected total sheet",b);a.sheets=_.extend({},a.sheets,{totalSheet:b});return v()};a.updateInvoiceSheet=function(b){a.sheets=_.extend({},a.sheets,{invoiceSheet:b});return v()};a.totalPricing=function(a){return!a||!a.uri?(console.warn("ng-prices: totalPricing: invalid object"),e.PriceLine.NONE_PRICING):
m[a.uri]||e.PriceLine.NONE_PRICING};a.invoicePricing=function(a){return!a||!a.uri?(console.warn("ng-pricing: invoicePricing: invalid object"),e.PriceLine.NONE_PRICING):k[a.uri]||e.PriceLine.NONE_PRICING}},link:{pre:function(a,b,d,c){a.pricesCtrl=c},post:function(a,b,c){b=a.$eval(c.ngPrices);d.assert(b,"ng-prices: no object specified");a.pricesCtrl.updateObject(b)}}}}]);h.directive("ngPricesNone",["models",function(b){return{restrict:"A",scope:!0,controller:function(){this.totalPricing=this.invoicePricing=
function(){return b.PriceLine.NONE_PRICING}},controllerAs:"pricesCtrl"}}]);h.directive("ngPricesStatic",[function(){return{restrict:"A",scope:!0,require:"^ngPrices",link:function(b,a,c,f){a=b.$eval(c.ngPricesStaticTotalSheet);b=b.$eval(c.ngPricesStaticInvoiceSheet);(a||b)&&f.updateSheets({totalSheet:a,invoiceSheet:b})}}}]);h.directive("ngPricesNavigation",["$q","auth","db","models",function(b,a,c,f){return{restrict:"A",scope:!0,templateUrl:"ng-prices-navigation",require:["^ngPrices","^ngBook"],controllerAs:"pricesNavigationCtrl",
controller:["$scope",function(a){var g=this,d=a.pricesCtrl,l=a.bookCtrl,m=l.availability.company.shortname;if(!l.totalSheetsAndSchedules){var k=c.totalSheets.nonBase({shortname:m}),n=c.totalSchedules({shortname:m});g.totalPromises=b.all([k.$promise,n.$promise]).then(function(){l.totalSheetsAndSchedules=_.append(k,n)})}if(!l.invoiceSheetsAndSchedules){var h=c.invoiceSheets.nonBase({shortname:m}),p=c.invoiceSchedules({shortname:m});g.invoicePromises=b.all([h.$promise,p.$promise]).then(function(){l.invoiceSheetsAndSchedules=
_.append(h,p)})}a.$watch("bookCtrl.totalSheetOrSchedule",function(a,b){if(a!==b)if(l.effectiveSheetsRequest&&l.effectiveSheetsRequest!==g.invoiceSheetRequest&&l.effectiveSheetsRequest.cancel(),l.totalSheetOrSchedule.cls===f.TotalSchedule.cls){var e=c.totalScheduleEffectiveSheet({shortname:m,availabilityPk:l.availability.pk,totalSchedulePk:l.totalSheetOrSchedule.pk});l.effectiveSheetsRequest=e.$promise;g.totalSheetRequest=e.$promise;l.effectiveSheetsRequest.then(function(a){a!==c.CANCELLED&&d.updateTotalSheet(e.totalSheet)})}else d.updateTotalSheet(l.totalSheetOrSchedule)});
a.$watch("bookCtrl.invoiceSheetOrSchedule",function(a,b){if(a!==b)if(l.effectiveSheetsRequest&&l.effectiveSheetsRequest!==g.totalSheetRequest&&l.effectiveSheetsRequest.cancel(),l.invoiceSheetOrSchedule&&l.invoiceSheetOrSchedule.cls===f.InvoiceSchedule.cls){var e=c.invoiceScheduleEffectiveSheet({shortname:m,availabilityPk:l.availability.pk,invoiceSchedulePk:l.invoiceSheetOrSchedule.pk});l.effectiveSheetsRequest=e.$promise;g.invoiceSheetRequest=e.$promise;g.invoiceSheetRequest.then(function(a){a!==
c.CANCELLED&&d.updateInvoiceSheet(e.invoiceSheet)})}else d.updateInvoiceSheet(l.invoiceSheetOrSchedule)})}]}}]);h.directive("ngPricesExtendedOptions",["$filter","$parse","auth","events","localization","models","require",function(b,a,c,f,e,g,d){var l=b("amount"),m=b("currencySymbol"),k=b("percentage");return{require:["ngPricesExtendedOptions","?^ngBook"],scope:!0,controller:["$scope","$attrs",function(a,b){var d=this;d.customField=null;d.pricedObject=null;d.options=[];d.isForcedOption=!1;var f=a.$eval(b.ngPricesExtendedOptionsCurrency),
h=_.constant(m(f)),v=_.constant(e.current().PERCENT_SYMBOL);d.refresh=function(){_.clear(d.options);var a=d.bookCtrl&&!d.bookCtrl.isShowingHiddenCustomFields,b=!1;_.forEach(d.customField.extendedOptions,function(c){var e=d.pricesCtrl.totalPricing(c);if(e.visibility.isVisible&&(!a||!e.visibility.isHiddenWhenBooking))d.options.push({pk:c.pk,extendedOption:c,classes:c.isPrivate?"private":""}),!b&&!d.customField.isPricingHidden&&(b=g.PriceLine.showOffset(e)||g.PriceLine.showRate(e))});d.isImpossibleOption=
!d.options.length&&d.pricesCtrl.totalPricing(d.pricedObject).visibility.isRequired;d.isImpossibleOption&&d.model.assign("");d.isForcedOption=1===d.options.length&&d.pricesCtrl.totalPricing(d.pricedObject).visibility.isRequired;d.isForcedOption&&d.model.assign(d.options[0].pk);_.forEach(d.options,function(c){var e=c.extendedOption,f=d.pricesCtrl.totalPricing(e);if(f.visibility.isVisible&&(!a||!f.visibility.isHiddenWhenBooking)){var k="";b&&(f.price.modifierKind===g.PriceLine.OFFSET_MODIFIER_KIND?k+=
h(g.PriceLine.effectiveOffset(f))+" - ":f.price.modifierKind===g.PriceLine.PERCENTAGE_MODIFIER_KIND&&(k+=v(f.price.rate)+" - "));k+=e.name;c.label=k}})};d.update=function(a,b,e){d.model=a;d.customField=b;d.pricedObject=e||b;c.permissions.can("viewAmounts",d.customField.company)&&(h=_.partial(l,_,f),v=k);d.refresh()}}],compile:function(b,c){var e=a(c.ngPricesExtendedOptions),k=a(c.ngPricesExtendedOptionsField),m=a(c.ngPricesExtendedOptionsInstance);return{pre:function(a,b,c,e){d.inScope(a,"pricesCtrl",
"prices.ngPricesExtendedOptions");a.pricesExtendedOptionsCtrl=e[0];a.pricesExtendedOptionsCtrl.pricesCtrl=a.pricesCtrl},post:function(a,b,c,l){var n=l[1]||null;a.pricesExtendedOptionsCtrl.bookCtrl=n;b=a.$model(e);var h=k(a);c=m(a)||null;d.assert(h.type===g.CustomField.EXTENDED_OPTION_TYPE,"prices.ngPricesExtendedOptions");a.pricesExtendedOptionsCtrl.update(b,h,c);a.$watch(function(){return _.pluck(h.extendedOptions,"pk")},function(){a.pricesExtendedOptionsCtrl.refresh()},!0);f.on(a,"pricing.ngPricing.updated",
function(){a.pricesExtendedOptionsCtrl.refresh()});f.on(a,"prices.ngPrices.updated",function(){a.pricesExtendedOptionsCtrl.refresh()});n&&a.$watch(function(){return n.isShowingHiddenCustomFields},function(){a.pricesExtendedOptionsCtrl.refresh()})}}}}}])})();
(function(){var h=angular.module("prices.services",[]);h.factory("cost",["require",function(b){var a=function(a,f,e){b.assert(3===arguments.length,"cost: expected all arguments");return{price:a,tax:_.sum(_.values(e||{})),taxable:f,feeable:a||0,taxByType:e||{}}};a.ZERO=a(0,0,{});a.NONE=a(null,0,{});a.add=function(a,b){var e=(a.price||0)+(b.price||0);null===a.price&&null===b.price&&(e=null);var g=_.sumObjectValues(a.taxByType,b.taxByType);return{price:e,tax:_.sum(_.values(g)),taxable:a.taxable+b.taxable,
feeable:a.feeable+b.feeable,taxByType:g}};a.sub=function(a,b){var e=(a.price||0)-(b.price||0);null===a.price&&null===b.price&&(e=null);var g=_.subtractObjectValues(a.taxByType,b.taxByType);return{price:e,tax:_.sum(_.values(g)),taxable:a.taxable-b.taxable,feeable:a.feeable-b.feeable,taxByType:g}};a.eq=function(a,b){return a.price===b.price&&a.tax===b.tax&&a.taxable===b.taxable&&a.feeable===b.feeable&&_.isEqual(a.taxByType,b.taxByType)};a.clampAtZero=function(a){var b=_.mapValues(a.taxByType,function(a){return Math.max(0,
a)});return{price:null===a.price?null:Math.max(0,a.price),tax:_.sum(_.values(b)),taxable:Math.max(0,a.taxable),feeable:Math.max(0,a.feeable),taxByType:b}};a.mul=function(a,b){var e=_.mapObject(a.taxByType,function(a){return _.roundHalfToEven(a*b)});return{price:null===a.price?null:_.roundHalfToEven(a.price*b),tax:_.sum(_.values(e)),taxable:_.roundHalfToEven(a.taxable*b),feeable:_.roundHalfToEven(a.feeable*b),taxByType:e}};a.sum=function(b){var f=a.NONE;_.forEach(b,function(b){f=a.add(f,b)});return f};
return a}]);h.factory("costs",["cost",function(b){var a=function(a,b){return{totalCost:a,invoiceCost:b}};a.NONE=a(b.NONE,b.NONE);a.ZERO=a(b.ZERO,b.ZERO);a.add=function(a,f){return{totalCost:b.add(a.totalCost,f.totalCost),invoiceCost:b.add(a.invoiceCost,f.invoiceCost)}};a.sub=function(a,f){return{totalCost:b.sub(a.totalCost,f.totalCost),invoiceCost:b.sub(a.invoiceCost,f.invoiceCost)}};a.mul=function(a,f){return{totalCost:b.sub(a.totalCost,f),invoiceCost:b.sub(a.invoiceCost,f)}};a.clampAtZero=function(a){return{totalCost:b.clampAtZero(a.totalCost),
invoiceCost:b.clampAtZero(a.invoiceCost)}};a.sum=function(b){var f=a.NONE;_.forEach(b,function(b){b&&(f=a.add(f,b))});return f};return a}]);h.factory("costComputations",["cost","models","require",function(b,a,c){var f=a.PriceLine,e=a.PriceSheet,g={asCost:function(a){if(a.price.modifierType===f.NONE_MODIFIER_TYPE)return g.nonePriceCost(a);if(f.isTaxIncluded(a))return g.applyTaxInclusion(a,a.price.offset);var c=f.effectiveOffset(a),m=e.taxable(a);return g.applyCustomTax(a,b(c,m,g.asTaxByType(a,m)))},
applyCustomTax:function(a,c){var g=a.price.customTax,k=a.taxes;if(g===f.NO_CUSTOM_TAX)return c;var n;g===f.ALWAYS_CUSTOM_TAX?n=c.price:k.taxability===e.NONE_TAXABILITY?n=0:g===f.ONLY_TAXED_CUSTOM_TAX?n=c.taxable:g===f.ALL_CUSTOM_TAX&&(n=c.price);g=_.mapValues(_.extend(k.offsetsByType,k.ratesByType),_.constant(n));return b(0,0,g)},applyTaxInclusion:function(a,c){var f=a.sheetRate.sheetRate,g=_.roundHalfToEven(c*f),n=_.clone(a.taxes.offsetsByType||{});0>c&&(n=_.mapValues(n,function(a){return-1*a}));
var h=_.clone(n),p=_.mapValues(h,function(a){return _.roundHalfToEven(a*f)}),r=c-_.sum(_.values(h)),n=g-_.sum(_.values(p)),t=_.sum(_.values(a.taxes.ratesByType)),v=_.roundHalfToEven(r/(1+t)),y=r-v,r=_.roundHalfToEven(v*f),q=n-r;_.forEach(a.taxes.ratesByType,function(a,b){var d=t?a/t:0;h[b]=_.roundHalfToEven(y*d);p[b]=_.roundHalfToEven(q*d)});var v=v+(c-(v+_.sum(_.values(h)))),r=r+(g-(r+_.sum(_.values(p)))),B,u;a.taxes.taxability==e.FULL_TAXABILITY?(u=h,B=v):a.taxes.taxability==e.PRO_RATE_TAXABILITY&&
(u=p,B=r);return b(r,B,u)},asTaxByType:function(a,b){var c=a.taxes,f;f=c.taxability==e.NONE_TAXABILITY?_.mapObject(c.offsetsByType,_.constant(0)):c.taxability==e.FULL_TAXABILITY?_.clone(c.offsetsByType):_.mapObject(c.offsetsByType,function(b){return _.roundHalfToEven(b*a.sheetRate.sheetRate)});0>b&&(f=_.mapObject(f,function(a){return-1*a}));return f=_.extend(f,_.mapObject(c.ratesByType,function(a){return _.roundHalfToEven(a*b)}))},nonePriceCost:function(a){c.assert(a.price.modifierType===f.NONE_MODIFIER_TYPE,
"nonePriceCost: expected none price modifier");a=g.asTaxByType(a,0);return!_.any(_.values(a))?b.NONE:b(0,0,a)},adjustTax:function(a,b,c){var k=a.price;if(a.taxes.taxability===e.NONE_TAXABILITY)return c;if(k.modifierType===f.SET_MODIFIER_TYPE){var n;k.modifierKind===f.PERCENTAGE_MODIFIER_KIND?n=(b.price||0)*k.rate:k.modifierKind===f.OFFSET_MODIFIER_KIND?n=k.offset:console.warn("costComputations: invalid price modifierKind",k.modifierKind);a=g.asTaxByType(a,n);_.isEqual(_.sumObjectValues(b.taxByType,
c),a)||(console.info("costComputations: adjusting tax",b.taxByType,c,a),c=_.subtractObjectValues(a,b.taxByType))}return c},costPreview:function(d){if(d.price.modifierType===a.PriceLine.NONE_MODIFIER_TYPE)return g.nonePriceCost(d);if(d.price.modifierKind===f.PERCENTAGE_MODIFIER_KIND)return null;if(a.PriceLine.isTaxIncluded(d))return g.applyTaxInclusion(d,d.price.offset);var c=_.roundHalfToEven(d.price.offset*d.sheetRate.sheetRate),e=a.PriceSheet.taxable(d);return d.price.customTax!==a.PriceLine.NO_CUSTOM_TAX?
g.applyCustomTax(d,{price:c,taxable:e}):b(c,e,g.asTaxByType(d,e))}};return g}]);h.factory("prices",["auth","db","models","require","urls",function(b,a,c,f,e){var g=function(a,b){return _.extend(e.extract(b),{objectCls:a.cls,objectPk:a.pk})};b={pricing:function(b,c){var e=a[_.uncapitalize(c.cls)].pricing,f=_.rest(arguments,2);f.unshift(g(b,c));return e.apply(a,f)}};b.pricing.update=function(b,c){var e=a[_.uncapitalize(c.cls)].pricing.update,f=_.rest(arguments,2);f.unshift(g(b,c));return e.apply(a,
f)};b.pricing.stack=function(b,c){var e=a[_.uncapitalize(c.cls)].pricing.stack,f=_.rest(arguments,2);f.unshift(g(b,c));return e.apply(a,f)};return b}]);h.factory("priceSheets",["clientOptions","db",function(b,a){return{effectiveSheets:function(c){var f={};b.defaultTotalSheetPk?f.clientOptionSheetPk=b.defaultTotalSheetPk:b.defaultTotalSchedulePk&&(f.clientOptionSchedulePk=b.defaultTotalSchedulePk);return a.effectiveSheets({shortname:c.company.shortname,availabilityPk:c.pk},{},{},f)},affiliationEffectiveSheets:function(b,
f){return a.affiliationEffectiveSheets({shortname:b.company.shortname,availabilityPk:b.pk,affiliationPk:f.pk})},rebookingEffectiveSheets:function(b,f){return a.rebookingEffectiveSheets({shortname:b.company.shortname,availabilityPk:b.pk,bookingUuid:f.uuid})}}}])})();angular.module("urls",["urls.services"]);
(function(){var h=angular.module("urls.services",["lib.services"]);h.factory("urls",["models","require",function(b,a){var c={},f=function(a,b){var e=a,f,g,h;for(h in b)if(b.hasOwnProperty(h)){var p=b[h];h&&void 0!==p&&(g=":"+h+"(?:\\([^\\)/]+\\))?",(f=c[g])||(f=c[g]=RegExp(g)),e=e.replace(f,p))}if(-1===e.indexOf(":"))return e},e={Company:function(a){return{shortname:a.shortname,canonical:{company:"company.index",dashboard:"dashboard.index"}}},Hotel:function(a){return{shortname:a.company.shortname,
hotelPk:a.pk}},Lodging:function(a){return{shortname:a.company.shortname,lodgingPk:a.pk}},PreferredPickup:function(a){return{shortname:a.company.shortname,lodgingPk:a.lodging.pk,preferredPickupPk:a.pk}},Route:function(a){return{shortname:a.company.shortname,routePk:a.pk,canonical:{dashboard:"dashboard.settings.routes.route"}}},Run:function(a){return{shortname:a.company.shortname,routePk:a.route.pk,runPk:a.run.pk}},Stop:function(a){return{shortname:a.company.shortname,routePk:a.route.pk,stopPk:a.pk}},
Pickup:function(a){return{shortname:a.company.shortname,pickupPk:a.pk}},User:function(a){return{username:a.username,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.permissions.user.index"}}},CustomManifest:function(a){return{customManifestPk:a.pk,shortname:a.company.shortname}},CustomCalendar:function(a){return{customCalendarPk:a.pk,shortname:a.company.shortname}},CustomReport:function(a){return{customReportPk:a.pk,shortname:a.company.shortname}},Image:function(a){return{imagePk:a.pk,
itemPk:a.item?a.item.pk:void 0,shortname:a.company.shortname,canonical:{dashboard:"dashboard.items.item.index"}}},Resource:function(a){return{resourcePk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.resources.resource.index"}}},ResourceOverride:function(a){return{resourceOverridePk:a.pk,resourcePk:a.resource.pk,shortname:a.resource.company.shortname,canonical:{dashboard:"dashboard.resources.resource.uses.index"}}},SeatMap:function(a){return{seatMapPk:a.pk,shortname:a.company.shortname,
canonical:{dashboard:"dashboard.settings.seating.seatMap.layout.index"}}},SeatGroup:function(a){return{seatGroupPk:a.pk,seatMapPk:a.seatMap.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.seating.seatMap.layout.seatGroup"}}},SeatZone:function(a){return{seatZonePk:a.pk,seatMapPk:a.seatMap.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.seating.seatMap.seatZones.seatZone"}}},Seat:function(a){return{seatPks:a.pk,seatMapPk:a.seatMap.pk,shortname:a.company.shortname,
canonical:{dashboard:"dashboard.settings.seating.seatMap.layout.seats"}}},TagGroup:function(a){return{tagGroupPk:a.pk,shortname:a.company.shortname}},Tag:function(a){return{tagPk:a.pk,tagGroupPk:a.tagGroup.pk,shortname:a.tagGroup.company.shortname}},Item:function(a){return{itemPk:a.pk,shortname:a.company.shortname,canonical:{company:"company.item.index",dashboard:"dashboard.items.item.index"}}},FlowNode:function(a){return{flowNodePk:a.pk,shortname:a.company.shortname,canonical:{company:"company.flowNode.index",
dashboard:"dashboard.settings.flows.flowNode.index"}}},CustomerPrototype:function(a){return{customerPrototypePk:a.pk,itemPk:a.item.pk,shortname:a.item.company.shortname,canonical:{dashboard:"dashboard.items.item.prices.customerTypes"}}},Availability:function(a){return{availabilityPk:a.pk,itemPk:a.item.pk,shortname:a.item.company.shortname,date:a.startAt?a.startAt.format("YYYY-MM-DD"):void 0,canonical:{company:"company.item.availability",dashboard:"dashboard.overlay.availability.index"}}},Block:function(a){return{blockPk:a.pk,
shortname:a.company.shortname}},Contact:function(a){return{contactPk:a.pk,shortname:a.company.shortname}},Order:function(a){return{contactPk:a.contact.pk,orderUuid:a.uuid,shortname:a.company.shortname,canonical:{dashboard:"dashboard.overlay.contact.order",company:"company.order.index"}}},Booking:function(a){return{bookingUuid:a.uuid,itemPk:a.item.pk,contactPk:a.contact.pk,shortname:a.company.shortname,affiliateShortname:a.affiliation?a.affiliation.affiliateCompany.shortname:void 0,canonical:{company:"company.item.booking",
dashboard:"dashboard.overlay.contact.booking"}}},Campaign:function(a){return{campaignPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.campaigns.campaign.index"}}},CampaignValidityRule:function(a){return{campaignValidityRulePk:a.pk,campaignPk:a.campaign.pk,shortname:a.campaign.company.shortname,canonical:{dashboard:"dashboard.settings.campaigns.campaign.settings"}}},Code:function(a){return{codePk:a.pk,campaignPk:a.campaign.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.campaigns.campaign.code"}}},
StoredValueType:function(a){return{storedValueTypePk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.storedValue.storedValueType"}}},StoredValueCard:function(a){return{storedValueCardPk:a.pk,storedValueCardNumber:a.number,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.storedValue.storedValueCard.index"}}},StoredValueAdjustment:function(a){return{storedValueAdjustmentPk:a.pk,storedValueCardPk:a.storedValueCard.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.storedValue.storedValueCard.storedValueAdjustment"}}},
Customer:function(a){return{customerPk:a.pk,bookingUuid:a.booking.uuid,shortname:a.company.shortname}},CheckinStatus:function(a){return{checkinStatusPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.checkinStatuses"}}},CustomerType:function(a){return{customerTypePk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.customerTypes.customerType"}}},CustomerTypeRate:function(a){return{customerTypeRatePk:a.pk,shortname:a.company.shortname}},CannedMessage:function(a){return{cannedMessagePk:a.pk,
shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.cannedMessages.cannedMessage"}}},InStorePaymentType:function(a){return{inStorePaymentTypePk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.payments.inStorePaymentTypes"}}},TaxType:function(a){return{taxTypePk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.payments.taxTypes.taxType"}}},EmvDevice:function(a){return{inStorePaymentTypePk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.payments.emvDevices"}}},
BankAccount:function(a){return{bankAccountPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.payments.bankAccounts"}}},Card:function(a){return{cardPk:a.pk,shortname:a.company.shortname}},CardAffiliation:function(a){return{cardAffiliationPk:a.pk,shortname:a.company.shortname}},Payment:function(a){return{paymentPk:a.pk,contactPk:a.booking.contact.pk,bookingUuid:a.booking.uuid,itemPk:a.item.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.overlay.contact.booking"}}},
Refund:function(a){return{refundPk:a.pk}},LegacyTransfer:function(a){return{transferPk:a.pk,shortname:a.company.shortname}},LegacyTransaction:function(a){return{transactionPk:a.pk}},Account:function(a){return{accountPk:a.pk,shortname:a.company.shortname}},Payout:function(a){return{payoutPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.reports.payouts.payout"}}},Transfer:function(a){return{transferPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.reports.accounts.transfer"}}},
Upload:function(a){return{uploadPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.reports.accounts.upload"}}},Adjustment:function(a){return{adjustmentPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.reports.transactions.adjustment"}}},Transaction:function(a){return{transactionPk:a.pk,shortname:b.Company.ADMIN_SHORTNAME}},LineItem:function(a){return{lineItemPk:a.pk,contactPk:a.booking.contact.pk,bookingUuid:a.booking.uuid,itemPk:a.item.pk,shortname:a.company.shortname,
canonical:{dashboard:"dashboard.overlay.contact.booking"}}},Agent:function(a){return{agentPk:a.pk,shortname:a.company.shortname}},Desk:function(a){return{deskPk:a.pk,shortname:a.company.shortname}},Role:function(a){return{rolePk:a.pk,shortname:a.company.shortname}},CrewMember:function(a){return{crewMemberPk:a.pk,availabilityPk:a.availability.pk,itemPk:a.availability.item.pk,shortname:a.company.shortname}},CustomField:function(a){return{customFieldPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.customFields.customField"}}},
TransportationOption:function(a){return{transportationOptionPk:a.pk,customFieldPk:a.customField.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.customFields.customField"}}},ExtendedOption:function(a){return{extendedOptionPk:a.pk,customFieldPk:a.customField.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.customFields.customField"}}},ConnectedCampaign:function(a){return{connectedCampaignPk:a.pk,customFieldPk:a.customField.pk,shortname:a.company.shortname,
canonical:{dashboard:"dashboard.settings.customFields.customField"}}},ConnectedWaiver:function(a){return{connectedWaiverPk:a.pk,customFieldPk:a.customField.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.customFields.customField"}}},GeneratingCampaign:function(a){return{generatingCampaignPk:a.pk,customFieldPk:a.customField.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.customFields.customField"}}},CustomFieldInstance:function(a){return{customFieldInstancePk:a.pk,
itemPk:a.item.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.items.item.prices.index"}}},CustomFieldInstanceCondition:function(a){return{customFieldInstanceConditionPk:a.pk,customFieldInstancePk:a.customFieldInstance.pk,itemPk:a.customFieldInstance.item.pk,shortname:a.customFieldInstance.company.shortname,canonical:{dashboard:"dashboard.items.item.prices.index"}}},CustomFieldInstanceGroup:function(a){return{customFieldInstanceGroupPk:a.pk,itemPk:a.item.pk,shortname:a.company.shortname,
canonical:{dashboard:"dashboard.items.item.prices.fieldGroups"}}},RequirementGroup:function(a){return{requirementGroupPk:a.pk,shortname:a.company.shortname,itemPk:a.isItemLevel?a.item.pk:null,canonical:{dashboard:a.isItemLevel?"dashboard.items.item.prices.resources":"dashboard.settings.requirementGroups.requirementGroup"}}},Requirement:function(a){return{requirementPk:a.pk,requirementGroupPk:a.requirementGroup.pk,itemPk:a.requirementGroup.isItemLevel?a.requirementGroup.item.pk:null,shortname:a.requirementGroup.company.shortname,
canonical:{dashboard:"dashboard.items.item.prices.resources"}}},CustomerPrototypeRequirement:function(a){return{customerPrototypeRequirementPk:a.pk,requirementPk:a.requirement.pk,requirementGroupPk:a.requirement.requirementGroup.pk,itemPk:a.requirement.requirementGroup.isItemLevel?a.requirement.requirementGroup.item.pk:null,shortname:a.requirement.requirementGroup.company.shortname,canonical:{dashboard:"dashboard.items.item.prices.resources"}}},ResourceRequirement:function(a){return{resourceRequirementPk:a.pk,
requirementPk:a.requirement.pk,requirementGroupPk:a.requirement.requirementGroup.pk,itemPk:a.requirement.requirementGroup.isItemLevel?a.requirement.requirementGroup.item.pk:null,shortname:a.requirement.requirementGroup.company.shortname,canonical:{dashboard:"dashboard.items.item.prices.resources"}}},CustomerCustomFieldValue:function(a){return{customerCustomFieldValuePk:a.pk,contactPk:a.booking.contact.pk,bookingUuid:a.booking.uuid,shortname:a.company.shortname,canonical:{dashboard:"dashboard.overlay.contact.booking"}}},
BookingCustomFieldValue:function(a){return{bookingCustomFieldValuePk:a.pk,contactPk:a.booking.contact.pk,bookingUuid:a.booking.uuid,shortname:a.company.shortname,canonical:{dashboard:"dashboard.overlay.contact.booking"}}},Group:function(a){return{groupPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.permissions.group"}}},GroupOverride:function(a){return{groupOverridePk:a.pk,shortname:a.company.shortname}},ResourceUse:function(a){return{resourceUsePk:a.pk,customerPk:a.customer.pk,
contactPk:a.booking.contact.pk,bookingUuid:a.customer.booking.uuid,canonical:{dashboard:"dashboard.overlay.contact.booking"}}},Affiliation:function(a){return{affiliationPk:a.pk,shortname:a.company.shortname,affiliateShortname:a.affiliateCompany.shortname}},Activity:function(a){return{activityPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.overlay.activity.index"}}},Notification:function(a){return{notificationPk:a.pk,shortname:a.company.shortname,contactPk:a.booking?a.booking.contact.pk:
void 0,bookingUuid:a.booking?a.booking.uuid:void 0,availabilityPk:a.availability?a.availability.pk:void 0,canonical:{dashboard:"dashboard.overlay.contact.booking"}}},SmsNotification:function(a){return{smsNotificationPk:a.pk,shortname:a.company.shortname,contactPk:a.booking?a.booking.contact.pk:void 0,bookingUuid:a.booking?a.booking.uuid:void 0,availabilityPk:a.availability?a.availability.pk:void 0,canonical:{dashboard:"dashboard.overlay.contact.booking"}}},Subscription:function(a){return{subscriptionPk:a.pk,
shortname:a.company.shortname}},Invoice:function(a){return{invoicePk:a.pk,invoiceUuid:a.uuid,shortname:a.company.shortname,affiliateShortname:a.affiliation?a.affiliation.affiliateCompany.shortname:void 0}},InvoiceEntry:function(a){return{invoiceEntryPk:a.pk,invoicePk:a.invoice.pk,shortname:a.company.shortname}},Report:function(a){return{reportPk:a.pk,shortname:a.company.shortname,modelSlug:a.type===b.Report.ADVANCED_TYPE?b.Report.MODELS[a.options.modelName].slug:void 0,canonical:{dashboard:"dashboard.reports.advanced.permalink"}}},
ViatorMapping:function(a){return{viatorMappingPk:a.pk,shortname:a.company.shortname,itemPk:a.item.pk}},Waiver:function(a){return{waiverPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.waivers.waiver.index"}}},WaiverInstance:function(a){return{waiverPk:a.waiver.pk,waiverInstancePk:a.waiverInstance.pk,shortname:a.company.shortname}},TotalSchedule:function(a){return{shortname:a.company.shortname,totalSchedulePk:a.pk,canonical:{dashboard:"dashboard.settings.pricing.totalSchedules.index"}}},
TotalScheduleEntry:function(a){return{shortname:a.company.shortname,totalSchedulePk:a.schedule.pk,totalScheduleEntryPk:a.pk,canonical:{dashboard:"dashboard.settings.pricing.totalSchedules.entry.index"}}},TotalScheduleEntryRule:function(a){return{shortname:a.company.shortname,totalSchedulePk:a.entry.schedule.pk,totalScheduleEntryPk:a.entry.pk,totalScheduleEntryRulePk:a.pk,canonical:{dashboard:"dashboard.settings.pricing.totalSchedules.entry.index"}}},InvoiceSchedule:function(a){return{shortname:a.company.shortname,
invoiceSchedulePk:a.pk,canonical:{dashboard:"dashboard.settings.pricing.invoiceSchedules.index"}}},InvoiceScheduleEntry:function(a){return{shortname:a.company.shortname,invoiceSchedulePk:a.schedule.pk,invoiceScheduleEntryPk:a.pk,canonical:{dashboard:"dashboard.settings.pricing.invoiceSchedules.entry.index"}}},InvoiceScheduleEntryRule:function(a){return{shortname:a.company.shortname,invoiceSchedulePk:a.entry.schedule.pk,invoiceScheduleEntryPk:a.entry.pk,invoiceScheduleEntryRulePk:a.pk,canonical:{dashboard:"dashboard.settings.pricing.invoiceSchedules.entry.index"}}},
TotalSheet:function(a){return{totalSheetPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.pricing.totalSheet"}}},InvoiceSheet:function(a){return{invoiceSheetPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.pricing.invoiceSheet"}}},SupportedLanguage:function(a){return{languagePk:a.pk,shortname:a.company.shortname,modelName:b.Translation.modelNameForUrl(a.modelName),canonical:{dashboard:"dashboard.settings.translations.language.translations.index"}}},
Translation:function(a){return{translationPk:a.pk,supportedLanguagePk:a.supportedLanguage.pk,shortname:a.company.shortname}},Location:function(a){return{locationPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.locations.location"}}},ResellerCompany:function(a){return{resellerCompanyPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.reseller.company.index"}}},ResellerCompanyMapping:function(a){return{resellerCompanyMappingPk:a.pk,resellerCompanyPk:a.resellerCompany.pk,
shortname:a.resellerCompany.company.shortname,canonical:{dashboard:"dashboard.settings.reseller.company.index"}}},ResellerItem:function(a){return{resellerItemPk:a.pk,resellerCompanyPk:a.resellerCompany.pk,shortname:a.resellerCompany.company.shortname,canonical:{dashboard:"dashboard.settings.reseller.item.index"}}},ResellerItemMapping:function(a){return{resellerItemMappingPk:a.pk,resellerItemPk:a.resellerItem.pk,resellerCompanyPk:a.resellerItem.resellerCompany.pk,shortname:a.resellerItem.resellerCompany.company.shortname,
canonical:{dashboard:"dashboard.settings.reseller.item.index"}}},ResellerCustomerType:function(a){return{resellerCustomerTypePk:a.pk,resellerItemPk:a.resellerItem.pk,resellerCompanyPk:a.resellerItem.resellerCompany.pk,shortname:a.resellerItem.resellerCompany.company.shortname,canonical:{dashboard:"dashboard.settings.reseller.customerType.index"}}},ResellerCustomerTypeMapping:function(a){return{resellerCustomerTypeMappingPk:a.pk,resellerCustomerTypePk:a.resellerCustomerType.pk,resellerItemPk:a.resellerCustomerType.resellerItem.pk,
resellerCompanyPk:a.resellerCustomerType.resellerItem.resellerCompany.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.reseller.customerType.index"}}},ResellerOption:function(a){return{resellerOptionPk:a.pk,resellerItemPk:a.resellerItem.pk,resellerCompanyPk:a.resellerItem.resellerCompany.pk,shortname:a.resellerItem.resellerCompany.company.shortname,canonical:{dashboard:"dashboard.settings.reseller.option.index"}}},ResellerOptionMapping:function(a){return{resellerOptionMappingPk:a.pk,
resellerOptionPk:a.resellerOption.pk,resellerItemPk:a.resellerOption.resellerItem.pk,resellerCompanyPk:a.resellerOption.resellerItem.resellerCompany.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.reseller.option.index"}}},ResellerKey:function(a){return{resellerKeyPk:a.pk,username:a.user.username,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.permissions.user.apiKeys.apiKey"}}},ResellerApp:function(a){return{resellerAppPk:a.pk,shortname:a.company.shortname,
canonical:{dashboard:"dashboard.settings.reseller.apps.app.index"}}},ResellerAppRequest:function(a){return{resellerAppRequestPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.connect"}}},ResellerAppCompany:function(a){return{resellerAppCompanyPk:a.pk,resellerAppPk:a.resellerApp.pk,shortname:a.resellerApp.company.shortname}},AnalyticsService:function(a){return{analyticsServicePk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.analyticsServices.analyticsService"}}},
CancellationPolicy:function(a){return{cancellationPolicyPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.cancellationPolicy.index"}}},CancellationRule:function(a){return{cancellationPolicyPk:a.cancellationPolicy.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.cancellationPolicy.index"}}},BookingRestriction:function(a){return{bookingRestrictionPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.bookingRestrictions.bookingRestriction"}}},
TicketLayout:function(a){return{ticketLayoutPk:a.pk,shortname:a.company.shortname,canonical:{dashboard:"dashboard.settings.ticketLayouts.index"}}}},g={populate:f,populateForObject:function(a){a=a||"";var b;if(this.$urls){if(b=this.$urls[a])return b}else this.$urls={},this.$params=g.extract(this);if(a)b=f(a,this.$params);else{if(!this.$params.canonical)return"";b=this.$params.canonical.dashboard||this.$params.canonical.company;if(!b)return"";b=f(_.getDotted(g,b),this.$params)}return this.$urls[a]=
b},extract:function(b){a.assert(b,"urls: unable to extract from object",b);a.defined(e,b.cls,"urls: unable to extract cls",b);return e[b.cls](b)},calendarUrls:function(a){return{index:a,month:a+":year/:month/",day:a+":year/:month/:day/",agenda:a+":year/:month/:day/",grid:a+":year/:month/:day/",timeline:a+":year/:month/:day/"}},dayUrlForCompany:function(a,c){return f(a.features.isDayViewEnabled?g.dashboard.bookings.day.date:g.dashboard.bookings.timeline.date+"?timeline-type="+b.Company.AVAILABILITY_TIMELINE,
{shortname:a.shortname,date:c.format("YYYY-MM-DD")})},legacyManifest:"/:shortname/manifest/",company:{index:"/:shortname/",login:"/:shortname/login/",about:"/:shortname/about/",faq:"/:shortname/faq/",policies:"/:shortname/policies/",items:{index:"/:shortname/items/",calendar:"/:shortname/items/calendar/"},item:{index:"/:shortname/items/:itemPk(pk)/",calendar:"/:shortname/items/:itemPk(pk)/calendar/",month:"/:shortname/items/:itemPk(pk)/calendar/:year/:month/",date:"/:shortname/items/:itemPk(pk)/date/:date/",
availability:"/:shortname/items/:itemPk(pk)/availability/:availabilityPk/",book:"/:shortname/items/:itemPk(pk)/availability/:availabilityPk/book/",booking:"/:shortname/items/:itemPk(pk)/booking/:bookingUuid/"},storedValueCard:{index:"/:shortname/gift-cards/:storedValueCardNumber/"},cart:{index:"/:shortname/cart/",permalink:"/:shortname/cart/?u=:cartUuid"},order:{index:"/:shortname/orders/:orderUuid/"},invoice:{index:"/:shortname/invoices/:invoiceUuid/"},flowNode:{index:"/:shortname/items/?flow=:flowNodePk",
calendar:"/:shortname/items/calendar/?flow=:flowNodePk"}},dashboard:{index:"/:shortname/dashboard/",overlay:{index:"/:shortname/dashboard/@overlay=/",item:{index:"/:shortname/dashboard/@overlay=/items/:itemPk/",date:"/:shortname/dashboard/@overlay=/items/:itemPk/date/:date/"},availability:{index:"/:shortname/dashboard/@overlay=/items/:itemPk/availabilities/:availabilityPk/",bookings:{index:"/:shortname/dashboard/@overlay=/items/:itemPk/availabilities/:availabilityPk/bookings/",cancelled:"/:shortname/dashboard/@overlay=/items/:itemPk/availabilities/:availabilityPk/bookings/cancelled/"},
message:"/:shortname/dashboard/@overlay=/items/:itemPk/availabilities/:availabilityPk/message/",settings:"/:shortname/dashboard/@overlay=/items/:itemPk/availabilities/:availabilityPk/settings/",prices:"/:shortname/dashboard/@overlay=/items/:itemPk/availabilities/:availabilityPk/prices/",integrations:"/:shortname/dashboard/@overlay=/items/:itemPk/availabilities/:availabilityPk/integrations/"},contact:{index:"/:shortname/dashboard/@overlay=/contacts/:contactPk/",booking:"/:shortname/dashboard/@overlay=/contacts/:contactPk/bookings/:bookingUuid/",
order:"/:shortname/dashboard/@overlay=/contacts/:contactPk/orders/:orderUuid/"},deprecatedBooking:{index:"/:shortname/dashboard/@overlay=/bookings/:bookingUuid/"},activity:{index:"/:shortname/dashboard/@overlay=/activities/:activityPk/"},translation:{index:"/:shortname/dashboard/@overlayTop=/translations/:objectType/:objectId/:objectField/"},close:"/:shortname/dashboard/@overlay"},translationsOverlay:{index:"/:shortname/dashboard/@translations-overlay=/",forSubfield:"/:shortname/dashboard/@translations-overlay=/for-field/:objectType/:objectId/:objectField/:subfield/",
forField:"/:shortname/dashboard/@translations-overlay=/for-field/:objectType/:objectId/:objectField/",close:"/:shortname/dashboard/@translations-overlay"},admin:{index:"/:shortname/dashboard/admin/"},manifest:{index:"/:shortname/dashboard/manifest/",date:"/:shortname/dashboard/manifest/date/:date/",bookings:"/:shortname/dashboard/manifest/date/:date/bookings/",availabilities:"/:shortname/dashboard/manifest/date/:date/availabilities/",items:"/:shortname/dashboard/manifest/date/:date/items/",runs:"/:shortname/dashboard/manifest/date/:date/runs/",
resources:"/:shortname/dashboard/manifest/date/:date/resources/"},bookings:{index:"/:shortname/dashboard/bookings/",calendar:"/:shortname/dashboard/bookings/calendar/",day:{index:"/:shortname/dashboard/bookings/day/",date:"/:shortname/dashboard/bookings/day/:date/"},grid:{index:"/:shortname/dashboard/bookings/grid/",date:"/:shortname/dashboard/bookings/grid/:date/"},timeline:{index:"/:shortname/dashboard/bookings/timeline/",date:"/:shortname/dashboard/bookings/timeline/:date/"},agenda:{index:"/:shortname/dashboard/bookings/agenda/",
date:"/:shortname/dashboard/bookings/agenda/:date/"},booking:{deprecatedPermalink:"/:shortname/dashboard/bookings/:bookingUuid/view/",deprecatedAffiliatePermalink:"/:affiliateShortname/dashboard/bookings/network/:shortname/:bookingUuid/"},contact:{index:"/:shortname/dashboard/bookings/contacts/:contactPk/",order:"/:shortname/dashboard/bookings/contacts/:contactPk/orders/:orderUuid/view/",booking:"/:shortname/dashboard/bookings/contacts/:contactPk/bookings/:bookingUuid/view/",affiliateContactPermalink:"/:affiliateShortname/dashboard/bookings/network/:shortname/contacts/:contactPk/",
affiliateBookingPermalink:"/:affiliateShortname/dashboard/bookings/network/:shortname/contacts/:contactPk/bookings/:bookingUuid/",affiliateOrderPermalink:"/:affiliateShortname/dashboard/bookings/network/:shortname/contacts/:contactPk/orders/:orderUuid/"}},reports:{index:"/:shortname/dashboard/reports/",type:"/:shortname/dashboard/reports/:type/",invoices:{index:"/:shortname/dashboard/reports/invoices/",create:{index:"/:shortname/dashboard/reports/invoices/create/",permalink:"/:shortname/dashboard/reports/invoices/create/report/:reportPk/"},
permalink:"/:shortname/dashboard/reports/invoices/report/:reportPk/",invoice:{index:"/:shortname/dashboard/reports/invoices/invoice/:invoicePk/",multi:"/:shortname/dashboard/reports/invoices/invoices/:invoicePks(pks)/",notification:"/:shortname/dashboard/reports/invoices/invoice/:invoicePk/notification/",upload:"/:shortname/dashboard/reports/invoices/invoice/:invoicePk/upload/",receiveSignUp:"/:shortname/dashboard/reports/invoices/invoice/:invoicePk/receive-sign-up/"},partnerInvoice:{index:"/:affiliateShortname/dashboard/reports/invoices/partner-invoice/:invoicePk/",
notification:"/:affiliateShortname/dashboard/reports/invoices/partner-invoice/:invoicePk/notification/",upload:"/:affiliateShortname/dashboard/reports/invoices/partner-invoice/:invoicePk/upload/",receiveSignUp:"/:affiliateShortname/dashboard/reports/invoices/partner-invoice/:invoicePk/receive-sign-up/"}},test:{index:"/:shortname/dashboard/reports/test/",permalink:"/:shortname/dashboard/reports/test/report/:reportPk/"},reports:{index:"/:shortname/dashboard/reports/reports/"},accounts:{index:"/:shortname/dashboard/reports/accounts/",
permalink:"/:shortname/dashboard/reports/accounts/report/:reportPk/",transfer:"/:shortname/dashboard/reports/accounts/transfer/:transferPk/",upload:"/:shortname/dashboard/reports/accounts/upload/:uploadPk/"},customersRedirect:{index:"/:shortname/dashboard/reports/customers/"},contacts:{index:"/:shortname/dashboard/reports/contacts/",permalink:"/:shortname/dashboard/reports/contacts/report/:reportPk/"},bookings:{index:"/:shortname/dashboard/reports/bookings/",permalink:"/:shortname/dashboard/reports/bookings/report/:reportPk/"},
companies:{index:"/:shortname/dashboard/reports/companies/",permalink:"/:shortname/dashboard/reports/companies/report/:reportPk/"},payments:{index:"/:shortname/dashboard/reports/payments/",permalink:"/:shortname/dashboard/reports/payments/report/:reportPk/"},disputes:{index:"/:shortname/dashboard/reports/disputes/",permalink:"/:shortname/dashboard/reports/disputes/report/:reportPk/"},lineItems:{index:"/:shortname/dashboard/reports/line-items/",permalink:"/:shortname/dashboard/reports/line-items/report/:reportPk/"},
payouts:{index:"/:shortname/dashboard/reports/payouts/",permalink:"/:shortname/dashboard/reports/payouts/report/:reportPk/",payout:"/:shortname/dashboard/reports/payouts/payout/:payoutPk/"},escrow:{index:"/:shortname/dashboard/reports/future-payouts/",permalink:"/:shortname/dashboard/reports/future-payouts/report/:reportPk/"},volume:{index:"/:shortname/dashboard/reports/volume/",permalink:"/:shortname/dashboard/reports/volume/report/:reportPk/"},transactions:{index:"/:shortname/dashboard/reports/transactions/",
permalink:"/:shortname/dashboard/reports/transactions/report/:reportPk/",adjustment:"/:shortname/dashboard/reports/transactions/:adjustmentPk/"},bookingTypesSummary:{index:"/:shortname/dashboard/reports/booking-types-summary/",permalink:"/:shortname/dashboard/reports/booking-types-summary/report/:reportPk/"},crewSummary:{index:"/:shortname/dashboard/reports/crew-summary/",permalink:"/:shortname/dashboard/reports/crew-summary/report/:reportPk/"},customerTypesSummary:{index:"/:shortname/dashboard/reports/customer-types-summary/",
permalink:"/:shortname/dashboard/reports/customer-types-summary/report/:reportPk/"},customFieldSummary:{index:"/:shortname/dashboard/reports/custom-field-summary/",permalink:"/:shortname/dashboard/reports/custom-field-summary/report/:reportPk/"},itemsSummary:{index:"/:shortname/dashboard/reports/items-summary/",permalink:"/:shortname/dashboard/reports/items-summary/report/:reportPk/"},lodgingsSummary:{index:"/:shortname/dashboard/reports/lodging-summary/",permalink:"/:shortname/dashboard/reports/lodging-summary/report/:reportPk/"},
pickupsSummary:{index:"/:shortname/dashboard/reports/pickups-summary/",permalink:"/:shortname/dashboard/reports/pickups-summary/report/:reportPk/"},usersSummary:{index:"/:shortname/dashboard/reports/users-summary/",permalink:"/:shortname/dashboard/reports/users-summary/report/:reportPk/"},agentsSummary:{index:"/:shortname/dashboard/reports/agents-summary/",permalink:"/:shortname/dashboard/reports/agents-summary/report/:reportPk/"},desksSummary:{index:"/:shortname/dashboard/reports/desks-summary/",
permalink:"/:shortname/dashboard/reports/desks-summary/report/:reportPk/"},campaignsSummary:{index:"/:shortname/dashboard/reports/campaigns-summary/",permalink:"/:shortname/dashboard/reports/campaigns-summary/report/:reportPk/"},revenueSummary:{index:"/:shortname/dashboard/reports/revenue-summary/",permalink:"/:shortname/dashboard/reports/revenue-summary/report/:reportPk/"},advanced:{redirect:"/:shortname/dashboard/reports/advanced/",index:"/:shortname/dashboard/reports/advanced/:modelSlug/",permalink:"/:shortname/dashboard/reports/advanced/:modelSlug/:reportPk/"}},
items:{index:"/:shortname/dashboard/items/",grid:"/:shortname/dashboard/items/grid/",list:"/:shortname/dashboard/items/list/",item:{index:"/:shortname/dashboard/items/:itemPk/",activity:"/:shortname/dashboard/items/:itemPk/activity/",calendar:"/:shortname/dashboard/items/:itemPk/calendar/",prices:{index:"/:shortname/dashboard/items/:itemPk/prices/",customerTypes:"/:shortname/dashboard/items/:itemPk/prices/customer-types/",fieldGroups:"/:shortname/dashboard/items/:itemPk/prices/field-groups/",resources:"/:shortname/dashboard/items/:itemPk/prices/resources/"},
embeds:"/:shortname/dashboard/items/:itemPk/embeds/",onlineBooking:"/:shortname/dashboard/items/:itemPk/online-booking/",suggestedItems:"/:shortname/dashboard/items/:itemPk/suggested-items/",info:{index:"/:shortname/dashboard/items/:itemPk/info/",notes:"/:shortname/dashboard/items/:itemPk/info/notes/",basic:"/:shortname/dashboard/items/:itemPk/info/basic/",photos:"/:shortname/dashboard/items/:itemPk/info/photos/",advanced:"/:shortname/dashboard/items/:itemPk/info/advanced/",tags:"/:shortname/dashboard/items/:itemPk/info/tags/"},
notifications:{index:"/:shortname/dashboard/items/:itemPk/notifications/",internal:"/:shortname/dashboard/items/:itemPk/notifications/internal/",external:"/:shortname/dashboard/items/:itemPk/notifications/external/"},integrations:{index:"/:shortname/dashboard/items/:itemPk/integrations/",subscribe:"/:shortname/dashboard/items/:itemPk/integrations/subscribe/",reviewExpress:"/:shortname/dashboard/items/:itemPk/integrations/review-express/",viator:"/:shortname/dashboard/items/:itemPk/integrations/viator/",
picthrive:"/:shortname/dashboard/items/:itemPk/integrations/picthrive/"}}},resources:{index:"/:shortname/dashboard/resources/",resource:{index:"/:shortname/dashboard/resources/:resourcePk/",settings:"/:shortname/dashboard/resources/:resourcePk/settings/",uses:{index:"/:shortname/dashboard/resources/:resourcePk/uses/",overview:"/:shortname/dashboard/resources/:resourcePk/uses/overview/",day:"/:shortname/dashboard/resources/:resourcePk/uses/date/:date/"}}},settings:{index:"/:shortname/dashboard/settings/",
actions:"/:shortname/dashboard/settings/actions/",advanced:"/:shortname/dashboard/settings/advanced/",payments:{index:"/:shortname/dashboard/settings/payments/",cards:{index:"/:shortname/dashboard/settings/payments/cards/",card:{index:"/:shortname/dashboard/settings/payments/cards/:cardPk/",settings:"/:shortname/dashboard/settings/payments/cards/:cardPk/settings/"}},inStorePaymentTypes:"/:shortname/dashboard/settings/payments/payment-types/",taxTypes:{index:"/:shortname/dashboard/settings/payments/tax-types/",
taxType:"/:shortname/dashboard/settings/payments/tax-types/:taxTypePk"},emvDevices:"/:shortname/dashboard/settings/payments/emv-devices/",bankAccounts:"/:shortname/dashboard/settings/payments/bank-accounts/",refundReserve:"/:shortname/dashboard/settings/payments/refund-reserve/"},profile:{index:"/:shortname/dashboard/settings/profile/",style:"/:shortname/dashboard/settings/profile/style/",slideshow:"/:shortname/dashboard/settings/profile/slideshow/",pages:"/:shortname/dashboard/settings/profile/pages/"},
info:{index:"/:shortname/dashboard/settings/info/",notesAndPolicies:"/:shortname/dashboard/settings/info/notes/",contact:"/:shortname/dashboard/settings/info/contact/",socialMedia:"/:shortname/dashboard/settings/info/social-media/",advanced:"/:shortname/dashboard/settings/info/advanced/",tags:"/:shortname/dashboard/settings/info/tags/"},cancellationPolicies:"/:shortname/dashboard/settings/cancellation-policies/",cancellationPolicy:{index:"/:shortname/dashboard/settings/cancellation-policies/:cancellationPolicyPk/",
settings:"/:shortname/dashboard/settings/cancellation-policies/:cancellationPolicyPk/settings/"},tagGroups:{index:"/:shortname/dashboard/settings/tag-groups/",tagGroup:{index:"/:shortname/dashboard/settings/tag-groups/:tagGroupPk/",settings:"/:shortname/dashboard/settings/tag-groups/:tagGroupPk/settings/",tag:"/:shortname/dashboard/settings/tag-groups/:tagGroupPk/tags/:tagPk/"}},seating:{index:"/:shortname/dashboard/settings/seat-maps/",seatMap:{index:"/:shortname/dashboard/settings/seat-maps/:seatMapPk/",
layout:{index:"/:shortname/dashboard/settings/seat-maps/:seatMapPk/layout/",seatGroup:"/:shortname/dashboard/settings/seat-maps/:seatMapPk/layout/seat-groups/:seatGroupPk/",duplicate:"/:shortname/dashboard/settings/seat-maps/:seatMapPk/layout/seats/:seatPks(pks)/duplicate/",seats:"/:shortname/dashboard/settings/seat-maps/:seatMapPk/layout/seats/:seatPks(pks)/","new":"/:shortname/dashboard/settings/seat-maps/:seatMapPk/layout/new/:seatGroupPk/:xCoord/:yCoord/"},seatZones:{index:"/:shortname/dashboard/settings/seat-maps/:seatMapPk/seat-zones/",
seatZone:"/:shortname/dashboard/settings/seat-maps/:seatMapPk/seat-zones/:seatZonePk/"},settings:"/:shortname/dashboard/settings/seat-maps/:seatMapPk/settings/",activity:"/:shortname/dashboard/settings/seat-maps/:seatMapPk/activity/"}},permissions:{index:"/:shortname/dashboard/settings/permissions/",groups:"/:shortname/dashboard/settings/permissions/groups/",group:"/:shortname/dashboard/settings/permissions/groups/:groupPk/",groupOverrides:"/:shortname/dashboard/settings/permissions/outside-users/",
groupOverride:"/:shortname/dashboard/settings/permissions/outside-users/:groupOverridePk/",users:"/:shortname/dashboard/settings/permissions/users/",user:{index:"/:shortname/dashboard/settings/permissions/users/:username/",settings:"/:shortname/dashboard/settings/permissions/users/:username/settings/",apiKeys:{index:"/:shortname/dashboard/settings/permissions/users/:username/api-keys/",apiKey:"/:shortname/dashboard/settings/permissions/users/:username/api-keys/:resellerKeyPk/"}}},agents:{index:"/:shortname/dashboard/settings/agents/",
agent:"/:shortname/dashboard/settings/agents/:agentPk/"},desks:{index:"/:shortname/dashboard/settings/desks/",desk:"/:shortname/dashboard/settings/desks/:deskPk/"},campaigns:{index:"/:shortname/dashboard/settings/campaigns/",campaign:{index:"/:shortname/dashboard/settings/campaigns/:campaignPk/",settings:"/:shortname/dashboard/settings/campaigns/:campaignPk/settings/",code:"/:shortname/dashboard/settings/campaigns/:campaignPk/codes/:codePk/"}},checkinStatuses:"/:shortname/dashboard/settings/check-in/",
customerTypes:{index:"/:shortname/dashboard/settings/customer-types/",customerType:"/:shortname/dashboard/settings/customer-types/:customerTypePk/"},requirementGroups:{index:"/:shortname/dashboard/settings/requirement-groups/",requirementGroup:"/:shortname/dashboard/settings/requirement-groups/:requirementGroupPk"},customFields:{index:"/:shortname/dashboard/settings/custom-fields/",type:"/:shortname/dashboard/settings/custom-fields/type/:type/",customField:"/:shortname/dashboard/settings/custom-fields/:customFieldPk(pk)/"},
cannedMessages:{index:"/:shortname/dashboard/settings/canned-messages/",cannedMessage:"/:shortname/dashboard/settings/canned-messages/:cannedMessagePk/"},network:{index:"/:shortname/dashboard/settings/network/",affiliates:{index:"/:shortname/dashboard/settings/network/affiliates/",affiliate:{index:"/:shortname/dashboard/settings/network/affiliates/:affiliationPk/",cards:"/:shortname/dashboard/settings/network/affiliates/:affiliationPk/cards/"}},partners:{index:"/:shortname/dashboard/settings/network/partners/",
partner:{index:"/:affiliateShortname/dashboard/settings/network/partners/:affiliationPk/",cards:"/:affiliateShortname/dashboard/settings/network/partners/:affiliationPk/cards/"}}},hotels:{index:"/:shortname/dashboard/settings/hotels/",hotel:"/:shortname/dashboard/settings/hotels/:hotelPk/"},lodgings:{index:"/:shortname/dashboard/settings/lodgings/",lodging:"/:shortname/dashboard/settings/lodgings/:lodgingPk/"},pickups:{index:"/:shortname/dashboard/settings/pickups/",pickup:"/:shortname/dashboard/settings/pickups/:pickupPk/"},
routes:{index:"/:shortname/dashboard/settings/routes/",route:"/:shortname/dashboard/settings/routes/:routePk/"},translations:{index:"/:shortname/dashboard/settings/languages/",language:{index:"/:shortname/dashboard/settings/languages/:languagePk/",settings:"/:shortname/dashboard/settings/languages/:languagePk/settings/",translations:{index:"/:shortname/dashboard/settings/languages/:languagePk/translations/",forModel:"/:shortname/dashboard/settings/languages/:languagePk/translations/:modelName/"}}},
pricing:{index:"/:shortname/dashboard/settings/pricing/",sheets:"/:shortname/dashboard/settings/pricing/sheets/",totalSheet:"/:shortname/dashboard/settings/pricing/total-sheets/:totalSheetPk/",invoiceSheet:"/:shortname/dashboard/settings/pricing/invoice-sheets/:invoiceSheetPk/",schedules:"/:shortname/dashboard/settings/pricing/schedules/",totalSchedules:{index:"/:shortname/dashboard/settings/pricing/total-schedules/:totalSchedulePk/",settings:"/:shortname/dashboard/settings/pricing/total-schedules/:totalSchedulePk/settings/",
entry:{index:"/:shortname/dashboard/settings/pricing/total-schedules/:totalSchedulePk/entries/:totalScheduleEntryPk/",settings:"/:shortname/dashboard/settings/pricing/total-schedules/:totalSchedulePk/entries/:totalScheduleEntryPk/settings/"}},invoiceSchedules:{index:"/:shortname/dashboard/settings/pricing/invoice-schedules/:invoiceSchedulePk/",settings:"/:shortname/dashboard/settings/pricing/invoice-schedules/:invoiceSchedulePk/settings/",entry:{index:"/:shortname/dashboard/settings/pricing/invoice-schedules/:invoiceSchedulePk/entries/:invoiceScheduleEntryPk/",
settings:"/:shortname/dashboard/settings/pricing/invoice-schedules/:invoiceSchedulePk/entries/:invoiceScheduleEntryPk/settings/"}},overview:"/:shortname/dashboard/settings/pricing/overview/"},activity:{index:"/:shortname/dashboard/settings/activity/",company:"/:shortname/dashboard/settings/activity/company/"},embeds:"/:shortname/dashboard/settings/embeds/",connect:"/:shortname/dashboard/settings/connect/",integrations:{index:"/:shortname/dashboard/settings/integrations/",subscribe:"/:shortname/dashboard/settings/integrations/subscribe/"},
reseller:{index:"/:shortname/dashboard/settings/integrations/channels/",requests:"/:shortname/dashboard/settings/integrations/channels/requests/",company:{index:"/:shortname/dashboard/settings/integrations/channels/:resellerCompanyPk/",settings:"/:shortname/dashboard/settings/integrations/channels/:resellerCompanyPk/settings/"},item:{index:"/:shortname/dashboard/settings/integrations/channels/:resellerCompanyPk/items/:resellerItemPk/",settings:"/:shortname/dashboard/settings/integrations/channels/:resellerCompanyPk/items/:resellerItemPk/settings/"},
customerType:{index:"/:shortname/dashboard/settings/integrations/channels/:resellerCompanyPk/items/:resellerItemPk/customer-types/:resellerCustomerTypePk/",settings:"/:shortname/dashboard/settings/integrations/channels/:resellerCompanyPk/items/:resellerItemPk/customer-types/:resellerCustomerTypePk/settings/"},option:{index:"/:shortname/dashboard/settings/integrations/channels/:resellerCompanyPk/items/:resellerItemPk/options/:resellerOptionPk/",settings:"/:shortname/dashboard/settings/integrations/channels/:resellerCompanyPk/items/:resellerItemPk/options/:resellerOptionPk/settings/"},
apps:{index:"/:shortname/dashboard/settings/integrations/apps/",app:{index:"/:shortname/dashboard/settings/integrations/apps/:resellerAppPk/",settings:"/:shortname/dashboard/settings/integrations/apps/:resellerAppPk/settings/"}}},waivers:{index:"/:shortname/dashboard/settings/waivers/",waiver:{index:"/:shortname/dashboard/settings/waivers/:waiverPk/"}},locations:{index:"/:shortname/dashboard/settings/locations/",settings:"/:shortname/dashboard/settings/locations/settings/",location:"/:shortname/dashboard/settings/locations/location/:locationPk/"},
storedValue:{index:"/:shortname/dashboard/settings/gift-cards/",storedValueTypes:"/:shortname/dashboard/settings/gift-cards/types/",storedValueType:"/:shortname/dashboard/settings/gift-cards/types/:storedValueTypePk/",storedValueCards:"/:shortname/dashboard/settings/gift-cards/cards/",storedValueCard:{index:"/:shortname/dashboard/settings/gift-cards/cards/:storedValueCardPk/",settings:"/:shortname/dashboard/settings/gift-cards/cards/:storedValueCardPk/settings/",storedValueAdjustment:"/:shortname/dashboard/settings/gift-cards/cards/:storedValueCardPk/adjustments/:storedValueAdjustmentPk/"}},
analyticsServices:{index:"/:shortname/dashboard/settings/analytics/",analyticsService:"/:shortname/dashboard/settings/analytics/:analyticsServicePk/"},flows:{index:"/:shortname/dashboard/settings/flows/",flowNode:{index:"/:shortname/dashboard/settings/flows/:flowNodePk/"}},ticketLayouts:{index:"/:shortname/dashboard/settings/ticket-layouts/",ticketLayout:{index:"/:shortname/dashboard/settings/ticket-layouts/:ticketLayoutPk/"}},suggestedItems:"/:shortname/dashboard/settings/suggested-items/",bookingRestrictions:{index:"/:shortname/dashboard/settings/booking-restrictions/",
bookingRestriction:"/:shortname/dashboard/settings/booking-restrictions/:bookingRestrictionPk/"}}},root:{index:"/",login:"/login/",forgot:{index:"/forgot/",password:"/forgot/password/",resetPassword:"/forgot/password/reset/",credentials:"/forgot/credentials/"},version:"/version/",help:"/help/"},email:{bookingNotification:"/email/:type/:shortname/bookings/:bookingUuid/",orderNotification:"/email/:type/:shortname/orders/:orderUuid/",invoicePaymentRequest:"/email/:type/:shortname/invoice/:invoicePk/"},
embeds:{calendar:{index:"/embeds/calendar/:shortname/",all:"/embeds/calendar/:shortname/all/",items:"/embeds/calendar/:shortname/items/:itemPks(pks)/"},cart:{index:"/embeds/cart/"},checkin:{index:"/embeds/checkin/",company:{index:"/embeds/checkin/:shortname/",booking:{index:"/embeds/checkin/:shortname/bookings/:bookingUuid/",customer:"/embeds/checkin/:shortname/bookings/:bookingUuid/customers/:customerPk/"}},qr:"/:encodedCustomerPk"},book:{index:"/embeds/book/:shortname/",storedValueCard:{index:"/embeds/book/:shortname/gift-cards/:storedValueCardNumber/"},
items:{index:"/embeds/book/:shortname/items/",calendar:"/embeds/book/:shortname/items/calendar/"},item:{index:"/embeds/book/:shortname/items/:itemPk(pk)/",calendar:"/embeds/book/:shortname/items/:itemPk(pk)/calendar/",month:"/embeds/book/:shortname/items/:itemPk(pk)/calendar/:year/:month/",date:"/embeds/book/:shortname/items/:itemPk(pk)/date/:date/",availability:"/embeds/book/:shortname/items/:itemPk(pk)/availability/:availabilityPk/",book:"/embeds/book/:shortname/items/:itemPk(pk)/availability/:availabilityPk/book/",
booking:"/embeds/book/:shortname/items/:itemPk(pk)/booking/:bookingUuid/"},cart:{index:"/embeds/book/:shortname/cart/",permalink:"/embeds/book/:shortname/cart/?u=:cartUuid"},order:{index:"/embeds/book/:shortname/orders/:orderUuid/"},flowNode:{index:"/embeds/book/:shortname/items/?flow=:flowNodePk",calendar:"/embeds/book/:shortname/items/calendar/?flow=:flowNodePk"},wait:{index:"/embeds/book/:shortname/pending/",order:"/embeds/book/:shortname/pending/orders/:orderUuid/",booking:"/embeds/book/:shortname/pending/bookings/:bookingUuid/"}},
partners:{index:"/embeds/partners/",company:"/embeds/partners/:shortname/"},items:{index:"/embeds/items/:shortname/"},analytics:{booking:"/embeds/a/:shortname/booking/:bookingUuid/"}},pusher:{auth:"/realtime/auth/",channels:"/realtime/:shortname/channels/",members:"/realtime/:shortname/members/"},api:{login:"/api/v1/login/",logout:"/api/v1/logout/",forgotPassword:"/api/v1/forgot/password/",resetPassword:"/api/v1/forgot/password/reset/",forgotCredentials:"/api/v1/forgot/credentials/",companies:"/api/v1/companies/",
company:"/api/v1/companies/:shortname/",providerLogin:"/api/v1/companies/:shortname/login/provider/",companyNags:"/api/v1/companies/:shortname/nags/",companyFeatures:"/api/v1/companies/:shortname/features/",refundReserve:"/api/v1/companies/:shortname/refund-reserve/",companyItemColorsFeature:"/api/v1/companies/:shortname/item-colors-feature/",companyProfile:"/api/v1/companies/:shortname/profile/",companyContactInformation:"/api/v1/companies/:shortname/contact-information/",companyTaxInformation:"/api/v1/companies/:shortname/tax-information/",
companyExtendedTaxInformation:"/api/v1/companies/:shortname/tax-information/extended/",processorOnboard:"/api/v1/companies/:shortname/tax-information/onboard/",companyTosAcceptance:"/api/v1/companies/:shortname/tos/",companyAccounts:"/api/v1/companies/:shortname/accounts/",companyStyles:"/api/v1/companies/:shortname/styles/",companyAdminNotes:"/api/v1/companies/:shortname/admin-notes/",companyPayments:"/api/v1/companies/:shortname/payments/",companyManifestSettings:"/api/v1/companies/:shortname/manifest-settings/",
companyCalendar:"/api/v1/companies/:shortname/calendar/:year/:month/",companyImages:"/api/v1/companies/:shortname/images/",companyImage:"/api/v1/companies/:shortname/images/:imagePk/",tagGroups:"/api/v1/companies/:shortname/tag-groups/",tagGroup:"/api/v1/companies/:shortname/tag-groups/:tagGroupPk/",tags:"/api/v1/companies/:shortname/tag-groups/:tagGroupPk/tags/",tag:"/api/v1/companies/:shortname/tag-groups/:tagGroupPk/tags/:tagPk/",objectTags:"/api/v1/companies/:shortname/tags/:objectCls/:objectPk/",
inStorePaymentTypes:"/api/v1/companies/:shortname/in-store-payment-types/",taxTypes:"/api/v1/companies/:shortname/tax-types/",taxType:"/api/v1/companies/:shortname/tax-types/:taxTypePk/",allInStorePaymentTypes:"/api/v1/companies/:shortname/in-store-payment-types/all/",inStorePaymentType:"/api/v1/companies/:shortname/in-store-payment-types/:inStorePaymentTypePk/",emvDevices:"/api/v1/companies/:shortname/emv-devices/",emvDevice:"/api/v1/companies/:shortname/emv-devices/:emvDevicePk/",retrieveConnectionToken:"/api/v1/companies/:shortname/emv-devices/connection-token/",
createInteractionToken:"/api/v1/companies/:shortname/emv-devices/emv-interaction-token/",bankAccounts:"/api/v1/companies/:shortname/bank-accounts/",bankAccount:"/api/v1/companies/:shortname/bank-accounts/:bankAccountPk/",cards:"/api/v1/companies/:shortname/cards/",card:"/api/v1/companies/:shortname/cards/:cardPk/",cardAffiliations:"/api/v1/companies/:shortname/cards/:cardPk/card-affiliations/",verifyBankAccount:"/api/v1/companies/:shortname/bank-accounts/:bankAccountPk/verify/",hotels:"/api/v1/companies/:shortname/hotels/",
hotel:"/api/v1/companies/:shortname/hotels/:hotelPk/",lodgings:"/api/v1/companies/:shortname/lodgings/",duplicateLodgingsAcrossCompanies:"/api/v1/companies/:shortname/lodgings/duplicate/",lodging:"/api/v1/companies/:shortname/lodgings/:lodgingPk/",preferredPickups:"/api/v1/companies/:shortname/lodgings/:lodgingPk/preferred-pickups/",preferredPickup:"/api/v1/companies/:shortname/lodgings/:lodgingPk/preferred-pickups/:preferredPickupPk/",pickups:"/api/v1/companies/:shortname/pickups/",duplicatePickupsAcrossCompanies:"/api/v1/companies/:shortname/pickups/duplicate/",
pickup:"/api/v1/companies/:shortname/pickups/:pickupPk/",routes:"/api/v1/companies/:shortname/routes/",duplicateRoutesAcrossCompanies:"/api/v1/companies/:shortname/routes/duplicate/",route:"/api/v1/companies/:shortname/routes/:routePk/",routeItems:"/api/v1/companies/:shortname/routes/:routePk/items/",duplicateRoute:"/api/v1/companies/:shortname/routes/:routePk/duplicate/",stops:"/api/v1/companies/:shortname/routes/:routePk/stops/",stop:"/api/v1/companies/:shortname/routes/:routePk/stops/:stopPk/",
customManifests:"/api/v1/companies/:shortname/custom-manifests/",customManifest:"/api/v1/companies/:shortname/custom-manifests/:customManifestPk/",customCalendars:"/api/v1/companies/:shortname/custom-calendars/",customCalendar:"/api/v1/companies/:shortname/custom-calendars/:customCalendarPk/",customReports:"/api/v1/companies/:shortname/custom-reports/",customReport:"/api/v1/companies/:shortname/custom-reports/:customReportPk/",users:"/api/v1/companies/:shortname/users/",allUsers:"/api/v1/companies/:shortname/users/all/",
relatedUsers:"/api/v1/companies/:shortname/users/related/",user:"/api/v1/companies/:shortname/users/:username/",userNags:"/api/v1/companies/:shortname/users/:username/nags/",userActivities:"/api/v1/companies/:shortname/users/:username/activities/",userSubscriptions:"/api/v1/companies/:shortname/users/:username/subscriptions/",userItemSubscriptions:"/api/v1/companies/:shortname/users/:username/subscriptions/items/:itemPk/",userOverview:"/api/v1/companies/:shortname/users/:username/overview/",reorder:"/api/v1/companies/:shortname/reorder/:objectCls/:objectPk/",
activities:"/api/v1/companies/:shortname/activities/:activityObjectCls/:activityObjectPks/",activity:"/api/v1/companies/:shortname/activities/:activityPk(pk)/",allActivities:"/api/v1/companies/:shortname/activities/all/",systemActivities:"/api/v1/companies/:shortname/activities/system/",notes:"/api/v1/companies/:shortname/activities/:activityObjectCls/:activityObjectPk/notes/",items:"/api/v1/companies/:shortname/items/",allItems:"/api/v1/companies/:shortname/items/all/",item:"/api/v1/companies/:shortname/items/:itemPk/",
itemColor:"/api/v1/companies/:shortname/items/:itemPk/color/",duplicateItem:"/api/v1/companies/:shortname/items/:itemPk/duplicate/",itemCalendar:"/api/v1/companies/:shortname/items/:itemPk/calendar/:year/:month/",itemSubscriptions:"/api/v1/companies/:shortname/items/:itemPk/subscriptions/",itemImages:"/api/v1/companies/:shortname/items/:itemPk/images/",itemImage:"/api/v1/companies/:shortname/items/:itemPk/images/:imagePk/",itemRatings:"/api/v1/companies/:shortname/items/:itemPk/ratings/",itemFlowPages:"/api/v1/companies/:shortname/items/:itemPk/flow-nodes/",
itemsCalendar:"/api/v1/companies/:shortname/items/:itemPks(pks)/calendar/:year/:month/",flowNodes:"/api/v1/companies/:shortname/flow-nodes/",flowNode:"/api/v1/companies/:shortname/flow-nodes/:flowNodePk/",defaultFlowPage:"/api/v1/companies/:shortname/flow-nodes/default/",duplicateFlowNode:"/api/v1/companies/:shortname/flow-nodes/:flowNodePk/duplicate/",cannedMessages:"/api/v1/companies/:shortname/canned-messages/",cannedMessage:"/api/v1/companies/:shortname/canned-messages/:cannedMessagePk/",cannedMessageItems:"/api/v1/companies/:shortname/canned-messages/:cannedMessagePk/items/",
allCustomerTypes:"/api/v1/companies/:shortname/customer-types/all/",customerTypes:"/api/v1/companies/:shortname/customer-types/",customerType:"/api/v1/companies/:shortname/customer-types/:customerTypePk/",customerTypeItems:"/api/v1/companies/:shortname/customer-types/:customerTypePk/items/",customerPrototypes:"/api/v1/companies/:shortname/items/:itemPk/customer-prototypes/",customerPrototype:"/api/v1/companies/:shortname/items/:itemPk/customer-prototypes/:customerPrototypePk/",duplicateCustomerPrototype:"/api/v1/companies/:shortname/items/:itemPk/customer-prototypes/:customerPrototypePk/duplicate/",
allCustomerPrototypes:"/api/v1/companies/:shortname/items/:itemPk/customer-prototypes/all/",customerPrototypesMulti:"/api/v1/companies/:shortname/items/customer-prototypes/multi/",checkinStatuses:"/api/v1/companies/:shortname/checkin-statuses/",checkinStatus:"/api/v1/companies/:shortname/checkin-statuses/:checkinStatusPk/",checkinStatusForBookings:"/api/v1/companies/:shortname/checkin-statuses/bookings/",roles:"/api/v1/companies/:shortname/roles/",role:"/api/v1/companies/:shortname/roles/:rolePk/",
crewMembers:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/crew-members/",crewMember:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/crew-members/:crewMemberPk/",customFields:"/api/v1/companies/:shortname/custom-fields/",allCustomFields:"/api/v1/companies/:shortname/custom-fields/all/",customField:"/api/v1/companies/:shortname/custom-fields/:customFieldPk/",customFieldItems:"/api/v1/companies/:shortname/custom-fields/:customFieldPk/items/",duplicateCustomField:"/api/v1/companies/:shortname/custom-fields/:customFieldPk/duplicate/",
prevalidateCustomField:"/api/v1/companies/:shortname/custom-fields/:customFieldPk/prevalidate/total-sheets/:totalSheetPk/availabilities/:availabilityPk/",transportationOptions:"/api/v1/companies/:shortname/custom-fields/:customFieldPk/transportation-options/",transportationOption:"/api/v1/companies/:shortname/custom-fields/:customFieldPk/transportation-options/:transportationOptionPk/",extendedOptions:"/api/v1/companies/:shortname/custom-fields/:customFieldPk/extended-options/",extendedOption:"/api/v1/companies/:shortname/custom-fields/:customFieldPk/extended-options/:extendedOptionPk/",
connectedCampaigns:"/api/v1/companies/:shortname/custom-fields/:customFieldPk/connected-campaigns/",connectedCampaign:"/api/v1/companies/:shortname/custom-fields/:customFieldPk/connected-campaigns/:connectedCampaignPk/",generatingCampaigns:"/api/v1/companies/:shortname/custom-fields/:customFieldPk/generating-campaigns/",generatingCampaign:"/api/v1/companies/:shortname/custom-fields/:customFieldPk/generating-campaigns/:generatingCampaignPk/",campaigns:"/api/v1/companies/:shortname/campaigns/",campaign:"/api/v1/companies/:shortname/campaigns/:campaignPk/",
campaignValidityRules:"/api/v1/companies/:shortname/campaigns/:campaignPk/campaign-validity-rules/",campaignValidityRule:"/api/v1/companies/:shortname/campaigns/:campaignPk/campaign-validity-rules/:campaignValidityRulePk/",campaignCustomFields:"/api/v1/companies/:shortname/campaigns/:campaignPk/custom-fields/",storedValueTypes:"/api/v1/companies/:shortname/stored-value-types/",storedValueType:"/api/v1/companies/:shortname/stored-value-types/:storedValueTypePk/",storedValueCards:"/api/v1/companies/:shortname/stored-value-cards/",
storedValueCard:"/api/v1/companies/:shortname/stored-value-cards/:storedValueCardPk/",storedValueCardPayments:"/api/v1/companies/:shortname/stored-value-cards/:storedValueCardPk/payments/",storedValueCardNotifications:"/api/v1/companies/:shortname/stored-value-cards/notifications/?q=:storedValueCardNumber",searchStoredValueCardsByNumber:"/api/v1/companies/:shortname/stored-value-cards/search/",storedValueAdjustments:"/api/v1/companies/:shortname/stored-value-cards/:storedValueCardPk/adjustments/",
storedValueAdjustment:"/api/v1/companies/:shortname/stored-value-cards/:storedValueCardPk/adjustments/:storedValueAdjustmentPk/",codes:"/api/v1/companies/:shortname/campaigns/:campaignPk/codes/",code:"/api/v1/companies/:shortname/campaigns/:campaignPk/codes/:codePk/",codesByTag:"/api/v1/companies/:shortname/campaigns/:campaignPk/codes/:tag/",allAffiliates:"/api/v1/companies/:shortname/affiliates/all/",affiliates:"/api/v1/companies/:shortname/affiliates/",affiliate:"/api/v1/companies/:shortname/affiliates/:affiliationPk/",
affiliateCards:"api/v1/companies/:shortname/affiliates/:affiliationPk/cards/",affiliateCardAffiliations:"/api/v1/companies/:shortname/affiliates/:affiliationPk/card-affiliations/",partners:"/api/v1/companies/:shortname/partners/",partner:"/api/v1/companies/:affiliateShortname/partners/:affiliationPk/",partnerCards:"/api/v1/companies/:shortname/partners/:affiliationPk/cards/",partnerCardAffiliations:"/api/v1/companies/:shortname/partners/:affiliationPk/card-affiliations/",allAgents:"/api/v1/companies/:shortname/agents/all/",
agents:"/api/v1/companies/:shortname/agents/",agent:"/api/v1/companies/:shortname/agents/:agentPk/",allDesks:"/api/v1/companies/:shortname/desks/all/",desks:"/api/v1/companies/:shortname/desks/",desk:"/api/v1/companies/:shortname/desks/:deskPk/",customFieldInstances:"/api/v1/companies/:shortname/items/:itemPk/custom-field-instances/",customFieldInstancesMulti:"/api/v1/companies/:shortname/items/custom-field-instances/multi/",customFieldInstance:"/api/v1/companies/:shortname/items/:itemPk/custom-field-instances/:customFieldInstancePk/",
customFieldInstanceConditions:"/api/v1/companies/:shortname/items/:itemPk/custom-field-instances/:customFieldInstancePk/conditions/",customFieldInstanceCondition:"/api/v1/companies/:shortname/items/:itemPk/custom-field-instances/:customFieldInstancePk/conditions/:customFieldInstanceConditionPk/",customFieldInstanceGroups:"/api/v1/companies/:shortname/items/:itemPk/custom-field-instance-groups/",customFieldInstanceGroup:"/api/v1/companies/:shortname/items/:itemPk/custom-field-instance-groups/:customFieldInstanceGroupPk/",
customFieldInstanceGroupsMulti:"/api/v1/companies/:shortname/items/custom-field-instance-groups/multi/",duplicateCustomFieldInstanceGroup:"/api/v1/companies/:shortname/items/:itemPk/custom-field-instance-groups/:customFieldInstanceGroupPk/duplicate/",supportedLanguages:"/api/v1/companies/:shortname/supported-languages/",supportedLanguage:"/api/v1/companies/:shortname/supported-languages/:languagePk/",translationsForModel:"/api/v1/companies/:shortname/supported-languages/:languagePk/translations/:modelName/",
translationsForField:"/api/v1/companies/:shortname/translations/:objectType/:objectId/:objectField/",understoodLanguages:"/api/v1/companies/:shortname/understood-languages/",translationsForSubfield:"/api/v1/companies/:shortname/translations/:objectType/:objectId/:objectField/:subfield/",nextAvailability:"/api/v1/companies/:shortname/items/:itemPk/availabilities/next/",futureAvailabilityCount:"/api/v1/companies/:shortname/:objectType/:objectPk/availabilities/future/count/",availabilitiesByDate:"/api/v1/companies/:shortname/items/:itemPk/availabilities/date/:date/",
availabilitiesByResource:"/api/v1/companies/:shortname/items/:itemPk/availabilities/date/:date/resource/:resourcePk/",availabilitiesByTag:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:tag/",availability:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/",availabilityStatus:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/status/",availabilityLiveCapacity:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/live/",
availabilityResourceUses:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/resource-uses/",updateItemAvailabilities:"/api/v1/companies/:shortname/items/:itemPk/availabilities/update/",updateAvailabilities:"/api/v1/companies/:shortname/availabilities/update/",availabilityNote:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/note/",availabilityCheckinStatuses:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/checkin-statuses/",
sendConfirmations:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/send-confirmations/",notifications:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/notifications/",smsNotifications:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/sms-notifications/",subjectsBooking:"/api/v1/companies/:shortname/subjects/:type/bookings/:bookingUuid/:language/",subjectsOrder:"/api/v1/companies/:shortname/subjects/:type/orders/:orderUuid/:language/",
subjectsAvailability:"/api/v1/companies/:shortname/subjects/:type/availabilities/:availabilityPk/:languages/",customerTypeRates:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/customer-type-rates/",customerTypeRate:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/customer-type-rates/:customerTypeRatePk/",blocks:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/blocks/",block:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/blocks/:blockPk/",
rule:"/api/v1/companies/:shortname/items/:itemPk/availabilities/rule/",orders:"/api/v1/companies/:shortname/orders/",order:"/api/v1/companies/:shortname/orders/:orderUuid/",orderPayments:"/api/v1/companies/:shortname/orders/:orderUuid/payments/",orderNotification:"/api/v1/companies/:shortname/orders/:orderUuid/notification/",orderCancellation:"/api/v1/companies/:shortname/orders/:orderUuid/cancel/",book:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/book/",bookings:"/api/v1/companies/:shortname/items/:itemPk/availabilities/:availabilityPk/bookings/",
booking:"/api/v1/companies/:shortname/bookings/:bookingUuid/",bookingByPk:"/api/v1/companies/:shortname/bookings/:bookingPk/",repriceBooking:"/api/v1/companies/:shortname/bookings/:bookingUuid/reprice/",bookingCheckinStatus:"/api/v1/companies/:shortname/bookings/:bookingUuid/checkin-status/",customerCheckinStatus:"/api/v1/companies/:shortname/bookings/:bookingUuid/customers/:customerPk/checkin-status/",bookingNote:"/api/v1/companies/:shortname/bookings/:bookingUuid/note/",bookingExplicitGross:"/api/v1/companies/:shortname/bookings/:bookingUuid/explicit-gross/",
bookingExplicitInvoicePrice:"/api/v1/companies/:shortname/bookings/:bookingUuid/explicit-invoice-price/",bookingNotificationOptions:"/api/v1/companies/:shortname/bookings/:bookingUuid/notification-options/",bookingEffectiveCancellationRule:"/api/v1/companies/:shortname/bookings/:bookingUuid/effective-cancellation-rule/",searchCustomersByEncodedPk:"/embeds/redirect/checkin/:encodedPk/",contact:"/api/v1/companies/:shortname/contacts/:contactPk/",contactBookings:"/api/v1/companies/:shortname/contacts/:contactPk/bookings/",
contactPayments:"/api/v1/companies/:shortname/contacts/:contactPk/payments/",affiliation:"/api/v1/companies/:shortname/bookings/:bookingUuid/affiliation/",notification:"/api/v1/companies/:shortname/bookings/:bookingUuid/notification/",smsNotification:"/api/v1/companies/:shortname/bookings/:bookingUuid/sms-notifications/",lineItems:"/api/v1/companies/:shortname/bookings/:bookingUuid/line-items/",lineItem:"/api/v1/companies/:shortname/bookings/:bookingUuid/line-items/:lineItemPk/",customerCustomFieldValue:"/api/v1/companies/:shortname/bookings/:bookingUuid/customers/custom-field-values/:customerCustomFieldValuePk/",
bookingCustomFieldValue:"/api/v1/companies/:shortname/bookings/:bookingUuid/custom-field-values/:bookingCustomFieldValuePk/",payments:"/api/v1/companies/:shortname/bookings/:bookingUuid/payments/",relatedPayments:"/api/v1/companies/:shortname/bookings/:bookingUuid/payments/related/",refunds:"/api/v1/companies/:shortname/bookings/:bookingUuid/refunds/",orderRefunds:"/api/v1/companies/:shortname/orders/:orderUuid/refunds/",customRefunds:"/api/v1/companies/:shortname/bookings/:bookingUuid/refunds/custom/",
availabilitiesManifest:"/api/v1/companies/:shortname/manifest/availabilities/date/:date/",bookingsManifest:"/api/v1/companies/:shortname/manifest/bookings/date/:date/",runsManifest:"/api/v1/companies/:shortname/manifest/runs/date/:date/",resourcesManifest:"/api/v1/companies/:shortname/manifest/resources/date/:date/",manifestSelectableAvailabilities:"/api/v1/companies/:shortname/manifest/selectable-availabilities/date/:date/",searchAvailabilitiesByDate:"/api/v1/companies/:shortname/search/items/:itemPks(pks)/availabilities/date/:date/",
searchAvailabilitiesByUpcoming:"/api/v1/companies/:shortname/search/availabilities/upcoming/:filter",searchAvailabilitiesByPk:"/api/v1/companies/:shortname/search/availabilities/:availabilityPks/",searchBookingsByQuery:"/api/v1/companies/:shortname/search/bookings/query/:filter",searchBookingsByNew:"/api/v1/companies/:shortname/search/bookings/new/:filter",searchBookingsByUuid:"/api/v1/companies/:shortname/search/bookings/:bookingUuids/",searchRunsByDate:"/api/v1/companies/:shortname/search/runs/date/:date/",
bookingsByContact:"/api/v1/companies/:shortname/search/bookings/contact/:contactPk/",invoices:"/api/v1/companies/:shortname/invoices/",invoice:"/api/v1/companies/:shortname/invoices/:invoicePk/",uuidInvoice:"/api/v1/companies/:shortname/invoices/uuid/:invoiceUuid/",invoiceNotifications:"/api/v1/companies/:shortname/invoices/:invoicePk/notifications/",invoiceUploads:"/api/v1/companies/:shortname/invoices/:invoicePk/uploads/",partnerInvoice:"/api/v1/companies/:shortname/invoices/partner-invoices/:invoicePk/",
groups:"/api/v1/companies/:shortname/groups/",group:"/api/v1/companies/:shortname/groups/:groupPk/",duplicateGroup:"/api/v1/companies/:shortname/groups/:groupPk/duplicate/",groupOverrides:"/api/v1/companies/:shortname/group-overrides/",groupOverride:"/api/v1/companies/:shortname/group-overrides/:groupOverridePk/",groupOverrideActivities:"/api/v1/companies/:shortname/group-overrides/:groupOverridePk/activities/",relatedGroupOverrides:"/api/v1/companies/:shortname/group-overrides/related/",reports:"/api/v1/companies/:shortname/reports/",
recentReports:"/api/v1/companies/:shortname/reports/recent/",inProgressReports:"/api/v1/companies/:shortname/reports/in-progress/",volumeOverviewReport:"/api/v1/companies/:shortname/reports/volume-overview/",dailyVolumeOverviewReport:"/api/v1/companies/:shortname/reports/daily-volume-overview/",paymentOverviewReport:"/api/v1/companies/:shortname/reports/payment-overview/",itemsSummaryOverviewReport:"/api/v1/companies/:shortname/reports/items-summary-overview/",nextPayoutOverviewReport:"/api/v1/companies/:shortname/reports/next-payout-overview/",
report:"/api/v1/companies/:shortname/reports/:reportPk(pk)/",reportObjects:"/api/v1/companies/:shortname/reports/:reportPk(pk)/objects/",reportReports:"/api/v1/companies/:shortname/reports/reports/",reportContacts:"/api/v1/companies/:shortname/reports/contacts/",reportBookings:"/api/v1/companies/:shortname/reports/bookings/",reportInvoiceableBookings:"/api/v1/companies/:shortname/reports/invoiceable-bookings/",reportTest:"/api/v1/companies/:shortname/reports/test/",reportLineItems:"/api/v1/companies/:shortname/reports/line-items/",
reportPayments:"/api/v1/companies/:shortname/reports/payments/",reportDisputes:"/api/v1/companies/:shortname/reports/disputes/",reportPayouts:"/api/v1/companies/:shortname/reports/payouts/",reportInvoices:"/api/v1/companies/:shortname/reports/invoices/",reportAccounts:"/api/v1/companies/:shortname/reports/accounts/",reportTransactions:"/api/v1/companies/:shortname/reports/transactions/",reportEscrow:"/api/v1/companies/:shortname/reports/escrow/",reportVolume:"/api/v1/companies/:shortname/reports/volume/",
reportCompanies:"/api/v1/companies/:shortname/reports/companies/",reportItemsSummary:"/api/v1/companies/:shortname/reports/summary/items/",reportUsersSummary:"/api/v1/companies/:shortname/reports/summary/users/",reportBookingTypesSummary:"/api/v1/companies/:shortname/reports/summary/booking-types/",reportCustomerTypesSummary:"/api/v1/companies/:shortname/reports/summary/customer-types/",reportCustomFieldSummary:"/api/v1/companies/:shortname/reports/summary/custom-field/",reportLodgingsSummary:"/api/v1/companies/:shortname/reports/summary/lodgings/",
reportPickupsSummary:"/api/v1/companies/:shortname/reports/summary/pickups/",reportCrewSummary:"/api/v1/companies/:shortname/reports/summary/crew/",reportAgentsSummary:"/api/v1/companies/:shortname/reports/summary/agents/",reportDesksSummary:"/api/v1/companies/:shortname/reports/summary/desks/",reportCampaignsSummary:"/api/v1/companies/:shortname/reports/summary/campaigns/",reportRevenueSummary:"/api/v1/companies/:shortname/reports/summary/revenue/",reportAdvanced:"/api/v1/companies/:shortname/reports/advanced/",
viatorSettings:"/api/v1/companies/:shortname/items/:itemPk/viator-settings/",viatorMappings:"/api/v1/companies/:shortname/items/:itemPk/viator-mappings/",viatorMapping:"/api/v1/companies/:shortname/items/:itemPk/viator-mappings/:viatorMappingPk/",reviewExpressSettings:"/api/v1/companies/:shortname/items/:itemPk/review-express-settings/",picthriveSettings:"/api/v1/companies/:shortname/items/:itemPk/picthrive-settings/",payouts:"/api/v1/companies/:shortname/payouts/",payout:"/api/v1/companies/:shortname/payouts/:payoutPk/",
payoutRetry:"/api/v1/companies/:shortname/payouts/:payoutPk/retry/",transfers:"/api/v1/companies/:shortname/transfers/",transfer:"/api/v1/companies/:shortname/transfers/:transferPk/",oneTimeTransfer:"/api/v1/companies/:shortname/one-time-transfer/",upcomingRefundReserveAmount:"/api/v1/companies/:shortname/upcoming-refund-reserve-amount/",uploads:"/api/v1/companies/:shortname/uploads/",upload:"/api/v1/companies/:shortname/uploads/:uploadPk/",adjustments:"/api/v1/companies/:shortname/adjustments/",
adjustment:"/api/v1/companies/:shortname/adjustments/:adjustmentPk/",waivers:"/api/v1/companies/:shortname/waivers/",waiver:"/api/v1/companies/:shortname/waivers/:waiverPk/",waiverInstance:"/api/v1/companies/:shortname/waivers/:waiverPk/waiver-instances/:waiverInstancePk/",connectedWaivers:"/api/v1/companies/:shortname/custom-fields/:customFieldPk/connected-waivers/",connectedWaiver:"/api/v1/companies/:shortname/custom-fields/:customFieldPk/connected-waivers/:connectedWaiverPk/",locations:"/api/v1/companies/:shortname/locations/",
location:"/api/v1/companies/:shortname/locations/:locationPk/",locationItems:"/api/v1/companies/:shortname/locations/:locationPk/items/",primaryLocation:"/api/v1/companies/:shortname/locations/primary/",totalSchedules:"/api/v1/companies/:shortname/total-schedules/",totalSchedule:"/api/v1/companies/:shortname/total-schedules/:totalSchedulePk/",totalScheduleAffiliations:"/api/v1/companies/:shortname/total-schedules/:totalSchedulePk/affiliations/",duplicateTotalSchedule:"/api/v1/companies/:shortname/total-schedules/:totalSchedulePk/duplicate/",
totalScheduleEntries:"/api/v1/companies/:shortname/total-schedules/:totalSchedulePk/entries/",totalScheduleEntry:"/api/v1/companies/:shortname/total-schedules/:totalSchedulePk/entries/:totalScheduleEntryPk/",totalScheduleEntryRules:"/api/v1/companies/:shortname/total-schedules/:totalSchedulePk/entries/:totalScheduleEntryPk/rules/",totalScheduleEntryRule:"/api/v1/companies/:shortname/total-schedules/:totalSchedulePk/entries/:totalScheduleEntryPk/rules/:totalScheduleEntryRulePk/",invoiceSchedules:"/api/v1/companies/:shortname/invoice-schedules/",
invoiceSchedule:"/api/v1/companies/:shortname/invoice-schedules/:invoiceSchedulePk/",invoiceScheduleAffiliations:"/api/v1/companies/:shortname/invoice-schedules/:invoiceSchedulePk/affiliations/",duplicateInvoiceSchedule:"/api/v1/companies/:shortname/invoice-schedules/:invoiceSchedulePk/duplicate/",invoiceScheduleEntries:"/api/v1/companies/:shortname/invoice-schedules/:invoiceSchedulePk/entries/",invoiceScheduleEntry:"/api/v1/companies/:shortname/invoice-schedules/:invoiceSchedulePk/entries/:invoiceScheduleEntryPk/",
invoiceScheduleEntryRules:"/api/v1/companies/:shortname/invoice-schedules/:invoiceSchedulePk/entries/:invoiceScheduleEntryPk/rules/",invoiceScheduleEntryRule:"/api/v1/companies/:shortname/invoice-schedules/:invoiceSchedulePk/entries/:invoiceScheduleEntryPk/rules/:invoiceScheduleEntryRulePk/",effectiveSheets:"/api/v1/companies/:shortname/availabilities/:availabilityPk/effective-sheets/",affiliationEffectiveSheets:"/api/v1/companies/:shortname/availabilities/:availabilityPk/affiliations/:affiliationPk/effective-sheets/",
rebookingEffectiveSheets:"/api/v1/companies/:shortname/availabilities/:availabilityPk/bookings/:bookingUuid/effective-sheets/",totalScheduleEffectiveSheet:"/api/v1/companies/:shortname/availabilities/:availabilityPk/total-schedules/:totalSchedulePk/effective-sheets/",invoiceScheduleEffectiveSheet:"/api/v1/companies/:shortname/availabilities/:availabilityPk/invoice-schedules/:invoiceSchedulePk/effective-sheets/",totalSheets:"/api/v1/companies/:shortname/total-sheets/",totalSheet:"/api/v1/companies/:shortname/total-sheets/:totalSheetPk/",
totalSheetSchedules:"/api/v1/companies/:shortname/total-sheets/:totalSheetPk/schedules/",totalSheetAffiliations:"/api/v1/companies/:shortname/total-sheets/:totalSheetPk/affiliations/",duplicateTotalSheet:"/api/v1/companies/:shortname/total-sheets/:totalSheetPk/duplicate/",totalPricing:"/api/v1/companies/:shortname/total-sheets/:totalSheetPk/pricing/:objectCls/:objectPk/",totalStack:"/api/v1/companies/:shortname/total-sheets/:totalSheetPk/pricing/:objectCls/:objectPk/stack/",invoiceSheets:"/api/v1/companies/:shortname/invoice-sheets/",
invoiceSheet:"/api/v1/companies/:shortname/invoice-sheets/:invoiceSheetPk/",invoiceSheetSchedules:"/api/v1/companies/:shortname/invoice-sheets/:invoiceSheetPk/schedules/",invoiceSheetAffiliations:"/api/v1/companies/:shortname/invoice-sheets/:invoiceSheetPk/affiliations/",duplicateInvoiceSheet:"/api/v1/companies/:shortname/invoice-sheets/:invoiceSheetPk/duplicate/",invoicePricing:"/api/v1/companies/:shortname/invoice-sheets/:invoiceSheetPk/pricing/:objectCls/:objectPk/",invoiceStack:"/api/v1/companies/:shortname/invoice-sheets/:invoiceSheetPk/pricing/:objectCls/:objectPk/stack/",
resources:"/api/v1/companies/:shortname/resources/",resource:"/api/v1/companies/:shortname/resources/:resourcePk/",resourceItems:"/api/v1/companies/:shortname/resources/:resourcePk/items/",resourceRequirementGroups:"/api/v1/companies/:shortname/resources/:resourcePk/requirement-groups/",resourceAvailabilities:"/api/v1/companies/:shortname/resources/:resourcePk/availabilities/date/:date/",resourceUsesByDate:"/api/v1/companies/:shortname/resources/:resourcePk/resource-uses/:date/",resourceUsesCalendar:"/api/v1/companies/:shortname/resources/:resourcePk/resource-uses/calendar/:year/:month/",
reapplyBookingResourceUses:"/api/v1/companies/:shortname/bookings/:bookingUuid/reapply-resource-uses/",requirementGroups:"/api/v1/companies/:shortname/requirement-groups/",itemRequirementGroups:"/api/v1/companies/:shortname/items/:itemPk/requirement-groups/",requirementGroup:"/api/v1/companies/:shortname/requirement-groups/:requirementGroupPk/",duplicateRequirementGroup:"/api/v1/companies/:shortname/requirement-groups/:requirementGroupPk/duplicate/",requirements:"/api/v1/companies/:shortname/requirement-groups/:requirementGroupPk/requirements/",
requirement:"/api/v1/companies/:shortname/requirement-groups/:requirementGroupPk/requirements/:requirementPk/",resourceRequirements:"/api/v1/companies/:shortname/requirement-groups/:requirementGroupPk/requirements/:requirementPk/resource-requirements/",resourceRequirement:"/api/v1/companies/:shortname/requirement-groups/:requirementGroupPk/requirements/:requirementPk/resource-requirements/:resourceRequirementPk/",resourceUse:"/api/v1/companies/:shortname/bookings/:bookingUuid/resource-uses/:resourceUsePk/",
resourceOverride:"/api/v1/companies/:shortname/resources/:resourcePk/resource-overrides/:resourceOverridePk/",resourceOverrideRule:"/api/v1/companies/:shortname/resources/:resourcePk/resource-override-rule/",resourceOverridesByTag:"/api/v1/companies/:shortname/resources/:resourcePk/resource-overrides/:tag/",resourceOverridesByDate:"/api/v1/companies/:shortname/resources/:resourcePk/resource-overrides/:date/",seatMaps:"/api/v1/companies/:shortname/seat-maps/",seatMap:"/api/v1/companies/:shortname/seat-maps/:seatMapPk/",
seatGroups:"/api/v1/companies/:shortname/seat-maps/:seatMapPk/seat-groups/",seatGroup:"/api/v1/companies/:shortname/seat-maps/:seatMapPk/seat-groups/:seatGroupPk/",seatZones:"/api/v1/companies/:shortname/seat-maps/:seatMapPk/seat-zones/",seatZone:"/api/v1/companies/:shortname/seat-maps/:seatMapPk/seat-zones/:seatZonePk/",resellerCompanies:"/api/v1/companies/:shortname/reseller-companies/",resellerCompany:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/",resellerCompanyMappings:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-company-mappings/",
resellerCompanyMapping:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-company-mappings/:resellerCompanyMappingPk/",resellerItems:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-items/",resellerItem:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-items/:resellerItemPk/",resellerItemMappings:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-items/:resellerItemPk/reseller-item-mappings/",
resellerItemMapping:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-items/:resellerItemPk/reseller-item-mappings/:resellerItemMappingPk",resellerCustomerTypes:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-items/:resellerItemPk/reseller-customer-types/",resellerCustomerType:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-items/:resellerItemPk/reseller-customer-types/:resellerCustomerTypePk/",resellerCustomerTypeMappings:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-items/:resellerItemPk/reseller-customer-types/:resellerCustomerTypePk/reseller-customer-type-mappings/",
resellerCustomerTypeMapping:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-items/:resellerItemPk/reseller-customer-types/:resellerCustomerTypePk/reseller-customer-type-mappings/:resellerCustomerTypeMappingPk/",resellerOptions:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-items/:resellerItemPk/reseller-options/",resellerOption:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-items/:resellerItemPk/reseller-options/:resellerOptionPk/",
resellerOptionMappings:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-items/:resellerItemPk/reseller-options/:resellerOptionPk/reseller-option-mappings/",resellerOptionMapping:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-items/:resellerItemPk/reseller-options/:resellerOptionPk/reseller-option-mappings/:resellerOptionMappingPk/",resellerUnmappedItems:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-items/:resellerItemPk/unmapped/items/",
resellerUnmappedCustomerPrototypes:"/api/v1/companies/:shortname/reseller-companies/:resellerCompanyPk/reseller-items/:resellerItemPk/reseller-customer-types/:resellerCustomerTypePk/unmapped/customer-prototypes/",resellerKeys:"/api/v1/companies/:shortname/users/:username/reseller-keys/",resellerKey:"/api/v1/companies/:shortname/reseller-keys/:resellerKeyPk/",resellerApps:"/api/v1/companies/:shortname/reseller-apps/",resellerApp:"/api/v1/companies/:shortname/reseller-apps/:resellerAppPk/",resellerAppRequests:"/api/v1/companies/:shortname/reseller-app-requests/",
resellerAppRequest:"/api/v1/companies/:shortname/reseller-app-requests/:resellerAppRequestPk/",resellerAppCompanies:"/api/v1/companies/:shortname/reseller-apps/:resellerAppPk/reseller-app-companies/",resellerAppCompany:"/api/v1/companies/:shortname/reseller-apps/:resellerAppPk/reseller-app-companies/:resellerAppCompanyPk",ticketLayouts:"/api/v1/companies/:shortname/ticket-layouts/",ticketLayout:"/api/v1/companies/:shortname/ticket-layouts/:ticketLayoutPk/",analyticsServices:"/api/v1/companies/:shortname/a-services/",
analyticsService:"/api/v1/companies/:shortname/a-services/:analyticsServicePk/",cancellationPolicies:"/api/v1/companies/:shortname/cancellation-policies/",cancellationPolicy:"/api/v1/companies/:shortname/cancellation-policies/:cancellationPolicyPk/",cancellationRules:"/api/v1/companies/:shortname/cancellation-policies/:cancellationPolicyPk/cancellation-rules/",cancellationRule:"/api/v1/companies/:shortname/cancellation-policies/:cancellationPolicyPk/cancellation-rules/:cancellationRulePk/",cancellationPolicyAffiliations:"/api/v1/companies/:shortname/cancellation-policies/:cancellationPolicyPk/affiliations/",
cancellationPolicyItems:"/api/v1/companies/:shortname/cancellation-policies/:cancellationPolicyPk/items/",bookingRestrictions:"/api/v1/companies/:shortname/booking-restrictions/",bookingRestriction:"/api/v1/companies/:shortname/booking-restrictions/:bookingRestrictionPk/",bookingRestrictionItems:"/api/v1/companies/:shortname/booking-restrictions/:bookingRestrictionPk/items/",persistentStore:"/api/v1/persistence/:identifier/",persistentStoreForCompany:"/api/v1/persistence/:identifier/:shortname/",
persistentStoreItem:"/api/v1/persistence/:identifier/:shortname/:key/",taskResult:"/api/v1/task-result/:taskId/",version:"/api/v1/version/"}};return g}]);h.run(["$rootScope","urls",function(b,a){b.urls=a}])})();angular.module("clientOptions",["clientOptions.services"]);
(function(){var h=angular.module("clientOptions.services",["db","lib","navigation"]);h.factory("clientOptions",["$rootScope","$sniffer","auth","db","events","models","navigation","storage","urls",function(b,a,c,f,e,g,d,l,m){m=/^(?:https?:\/\/)?(?:[a-z0-9\-_]+\.[a-z0-9\-_]+)+.*/i;var k=[{query:"u",key:"userIdentifier",reflect:!l.isPersistent(),reflectExternal:function(){return c.currentUser.isAuthenticated?!1:!0}},{query:"asn",key:"asnAffiliateCompany",reflect:!0},{query:"asn-ref",key:"asnVoucherNumber",
reflect:!0},{query:"sheet",key:"defaultTotalSheetPk",reflect:!0,type:"int"},{query:"schedule",key:"defaultTotalSchedulePk",reflect:!0,type:"int"},{query:"full-items",key:"isFullItemsEnabled",reflect:!0,type:"yes-no"},{query:"kiosk",key:"isKioskModeEnabled",isSlipstream:!0,type:"yes-no"},{query:"ref",key:"onlineBookingReference",reflect:!0},{query:"referrer",key:"referrerUrl",pattern:m},{query:"back",key:"backUrl",pattern:m,decode:!0},{query:"preview"},{query:"site-tags",key:"trackingSiteTags",onlyIfDefined:!0,
decode:!0},{query:"page-tags",key:"trackingPageTags",onlyIfDefined:!0,decode:!0},{query:"button-tags",key:"trackingButtonTags",onlyIfDefined:!0,decode:!0},{query:"from-ssl",key:"trackingIsFromSsl",type:"yes-no",onlyIfDefined:!0},{query:"from-embed",key:"trackingFromEmbed",onlyIfDefined:!0},{query:g.FlowNode.FLOW_QUERY,key:"flowNode",reflect:!0,isUpdatedOnLocationChange:!0,isAuthenticatedAllowed:!0},{query:g.FlowNode.IS_SUGGESTED_QUERY,key:"isInSuggestedItems",reflect:!0,type:"yes-no",isUpdatedOnLocationChange:!0},
{query:"bookable-only",key:"isBookableOnly",type:"yes-no"}],n=_.filter(k,"isUpdatedOnLocationChange"),h=function(a){a=a||_.always;var b={};_.forEach(k,function(c){if(a(c)&&c.key){var d=v[c.key];_.isUndefined(d)||("yes-no"===c.type?d&&(b[c.query]="yes"):"int"===c.type?_.isFinite(d)&&(b[c.query]=d):d&&(b[c.query]=d))}});return b},p=function(){return h(function(a){return!!a.reflect})},r=function(){var a=h(function(a){return _.isFunction(a.reflectExternal)?a.reflectExternal():!!a.reflectExternal});return _.mapKeys(a,
function(a,b){return"fh-"+b})};b.$on("$locationChangeSuccess",function(){_.forEach(n,y);var a=p();_.forEach(a,function(a,b){d.set(b,a,!0)})});e.on(b,"navigation.company.updated",function(){d.currentCompany&&(v.asnCharterCompany?v.asnCharterCompany!==d.currentCompany.shortname&&(v.asnCharterCompany="",v.asnAffiliateCompany="",v.asnVoucherNumber=""):v.asnCharterCompany=d.currentCompany.shortname)});b=f.slipstream("domain");var t=f.slipstream("protocol")+"://"+b,v={reflect:function(a){var b=_.find(k,
"key",a).query;d.set(b,v[a],!0)},extendUrl:function(a){return d.compose(a,h(),!0)},reflectUrl:function(a){var b;if("/"===a.charAt(0)||0===a.indexOf(t))b=p();else if(0===a.indexOf("http"))b=r();else return a;return d.compose(a,b,!0)},reflectUrlsInHrefs:function(a){a.on("mousedown","a",function(){var a=$(this);a.attr("href",v.reflectUrl(a.attr("href")))})}},y=function(b){var e=d.get(b.query)||"";!e&&b.isSlipstream&&(e=f.slipstream(b.query)||"");c.currentUser.isAuthenticated&&!b.isAuthenticatedAllowed&&
(e="");b.pattern&&!b.pattern.test(e)&&(e="");if(!b.onlyIfDefined||e)"int"===b.type?(e=parseInt(e,10),e=isNaN(e)?null:e):"yes-no"===b.type&&(e="yes"===e),a.history&&!b.isUpdatedOnLocationChange&&d.clear(b.query,!0),b.decode&&(e=decodeURIComponent(e)),b.key&&(v[b.key]=e)};_.forEach(k,y);c.currentUser.isAuthenticated||(v.asnAffiliateCompany=v.asnAffiliateCompany||f.slipstream("asnAffiliateCompany")||"");v.asnAffiliateCompany||(v.asnAffiliateCompany="",v.asnVoucherNumber="");return v}]);h.run(["$rootScope",
"clientOptions",function(b,a){b.clientOptions=a}])})();angular.module("rebook",["rebook.services","rebook.controllers"]);
(function(){var h=angular.module("rebook.services",[]);h.factory("rebook",["$rootScope","events","navigation",function(b,a,c){var f={currentBooking:null,nonRebookableCustomers:[],populatedCustomFields:{},rebook:function(b,g){a.broadcast("rebook.start");f.currentBooking=b;g=g||c.startBookingUrl(b,b.contact);c.navigate(g)},stopRebooking:function(){f.currentBooking=null},addNonRebookableCustomer:function(a){f.nonRebookableCustomers.push(a)},isCustomerNonRebookable:function(a){return-1<f.nonRebookableCustomers.indexOf(a)},
addPopulatedCustomField:function(a){f.populatedCustomFields[a]=!0},isCustomFieldPopulated:function(a){return f.populatedCustomFields[a]},populatedCustomField:function(a){delete f.populatedCustomFields[a]},onEnterBookForm:function(){f.populatedCustomFields={};f.nonRebookableCustomers=[]},onExitBookForm:function(){f.populatedCustomFields={};f.nonRebookableCustomers=[]}};a.on(b,"auth.logout",function(){f.stopRebooking()});a.on(b,"plusbook.start",function(){f.stopRebooking()});return f}]);h.run(["$rootScope",
"rebook",function(b,a){b.rebook=a}])})();
(function(){var h=angular.module("rebook.controllers",[]);h.controller("rebook.CurrentRebookCtrl",["$scope","$filter","navigation","rebook","sonar","urls",function(b,a,c,f,e,g){b.tracker=_.tracker();b.$watch("rebook.currentBooking.pk",function(){b.tracker.modified()});b.stopRebooking=function(){var d=f.currentBooking,d=d?a("bookingUrl")(d):c.currentCompany.$url(g.dashboard.bookings.index);c.pathEquals(d)?f.stopRebooking():(b.$once("$locationChangeComplete",function(a,b){b&&f.stopRebooking()}),c.navigate(d));
e.watch(b,f.currentBooking,"updated",function(){e.get(f.currentBooking.uri).$promise.then(function(){f.currentBooking.isCancelled?f.stopRebooking():b.tracker.modified()})})};return b}]);h.controller("rebook.BookingCtrl",["$scope","db","require",function(b,a,c){c.inScope(b,"booking");if(_.isUndefined(b.booking.customers)||_.isUndefined(b.booking.customFieldValues))b.booking=a.booking({shortname:b.booking.availability.item.company.shortname,itemPk:b.booking.availability.item.pk,bookingUuid:b.booking.uuid})}])})();
angular.module("plusbook",["plusbook.services","plusbook.controllers"]);
(function(){var h=angular.module("plusbook.services",[]);h.factory("plusbook",["$rootScope","auth","db","events","models","navigation","urls",function(b,a,c,f,e,g,d){var l=function(b){m.sourceUrl=g.url;b?m.currentSourceBooking=b:m.currentBooking?m.currentSourceBooking=m.currentBooking:m.currentOrder?m.currentSourceBooking=m.currentOrder.allBookings[0]||null:m.currentContact&&(a.permissions.can("viewDashboardSection",m.currentContact.company)?m.currentSourceBooking=m.currentContact.relatedBookings[0]||
null:(b=_.filter(m.currentContact.relatedBookings,function(b){return!b.affiliation||b.affiliation.affiliateCompany!==g.currentCompany?!1:a.permissions.can("viewDashboardSection",b.affiliation.affiliateCompany)}),m.currentSourceBooking=b[0]||null));m.currentSourceBooking&&c.booking({shortname:m.currentSourceBooking.company.shortname,bookingUuid:m.currentSourceBooking.uuid});g.navigate(g.startBookingUrl(m.currentSourceBooking,m.currentContact))},m={isPlusbooking:!1,currentContact:null,isOrderizing:!1,
currentOrder:null,currentBooking:null,currentSourceBooking:null,sourceUrl:"",orderize:function(a){f.broadcast("plusbook.start");m.stopPlusbooking();m.isOrderizing=!0;var b;if(a.cls===e.Order.cls)m.currentOrder=a,m.currentBooking=null,m.currentContact=a.contact;else if(a.cls===e.Booking.cls)m.currentOrder=a.order,m.currentBooking=a.order?null:a,m.currentContact=a.contact,b=a;else{console.error("plusbook: invalid orderize object",a);return}l(b)},plusbook:function(a,b){f.broadcast("plusbook.start");
m.stopPlusbooking();m.currentBooking=null;m.currentOrder=null;m.isPlusbooking=!0;m.currentContact=a;l(b)},stopPlusbooking:function(){var b=_.get(m.currentSourceBooking,"affiliation.affiliateCompany");b&&b===a.currentUser.company&&a.storage.set("currentPartnerSelection",m.currentSourceBooking.company.uri);m.isOrderizing=!1;m.isPlusbooking=!1;m.currentContact=null;m.currentObject=null;m.currentBooking=null;m.currentSourceBooking=null;m.sourceUrl=""}};f.on(b,"auth.logout",function(){m.stopPlusbooking()});
f.on(b,"rebook.start",function(){m.stopPlusbooking()});return m}]);h.run(["$rootScope","plusbook",function(b,a){b.plusbook=a}])})();
(function(){var h=angular.module("plusbook.controllers",[]);h.controller("plusbook.CurrentPlusbookCtrl",["$scope","$filter","models","navigation","plusbook","urls",function(b,a,c,f,e,g){b.stopPlusbooking=function(){var a=e.sourceUrl;e.stopPlusbooking();f.navigate(a)}}]);h.controller("plusbook.ContactCtrl",["$scope","controllers","db","plusbook","require",function(b,a,c,f,e){e.notNull(f,"currentContact");b.contact=c.contact({shortname:f.currentContact.company.shortname,contactPk:f.currentContact.pk});
return a.dataController(b,{stale:[b.contact],promises:[b.contact.$promise]})}])})();angular.module("heartbeat",["heartbeat.services","heartbeat.controllers"]);
(function(){angular.module("heartbeat.services",[]).factory("heartbeat",["$http","$rootScope","db","flash",function(h,b,a,c){var f="version";"local"===a.slipstream.configuration&&(f="commit");var e=function(c){b.$apply(function(){var b=a.version();b.$promise.then(function(){g.currentVersion=b[f]||"";var a=g,e;if("version"===f){if(!(e=g.needsUpgrade)){e=g.currentVersion;var n=g.initialVersion;e=e.split(".");n=n.split(".");e=3!==e.length?!1:3!==n.length||_.int(e[0])>_.int(n[0])||_.int(e[0])===_.int(n[0])&&
(_.int(e[1])>_.int(n[1])||_.int(e[1])===_.int(n[1])&&_.int(e[2])>_.int(n[2]))?!0:!1}}else e=g.needsUpgrade||g.initialVersion!==g.currentVersion;a.needsUpgrade=e;g.needsFailover=!!b.failover;c()},function(){c()})})};h=(a.slipstream("version")||{})[f]||"";var g={initialVersion:h,currentVersion:h,needsUpgrade:!1,needsFailover:!1,listen:function(a){var b;a.$on("$destroy",function(){b&&clearTimeout(b)});b=setTimeout(function k(){e(function(){b=setTimeout(k,6E4)})},6E4)}};return window.$$heartbeat=g}])})();
(function(){angular.module("heartbeat.controllers",[]).controller("heartbeat.UpgradeCtrl",["$scope","$timeout","heartbeat","navigation",function(h,b,a,c){var f=!1,e=0;a.listen(h);h.isDismissAllowed=!0;h.needsUpgrade=function(){return a.needsUpgrade&&!f};h.dismiss=function(){f=!0;e+=1;h.isDismissAllowed=3>e;setTimeout(function(){h.$apply(function(){f=!1})},6E5)};h.upgrade=function(){c.reload()};h.needsFailover=function(){return a.needsFailover}}])})();
angular.module("flash",["flash.controllers","flash.directives","flash.services"]);(function(){angular.module("flash.controllers",["flash.services"]).controller("flash.FlashesCtrl",["$scope","flash",function(h,b){h.remove=function(a){b.remove(a)};h.flashes=b.all();return h}])})();
(function(){var h=angular.module("flash.directives",["flash.services"]);h.directive("ngFlashFormSuccess",["$interpolate","flash",function(b,a){return{require:["form"],link:function(c,f,e,g){f=g[0];var d=e.ngFlashFormSuccessType||"success";e=e.$$element.attr(e.$attr.ngFlashFormSuccess);var l=b(e);f.$successCallbacks.push(function(b){var e=c.$new();e.$object=b;if(b=l(e))a[d](b)})}}}]);h.directive("ngFlashFormError",["$interpolate","flash",function(b,a){return{require:["form"],link:function(c,f,e,g){f=
g[0];var d=e.ngFlashFormErrorType||"error";e=e.$$element.attr(e.$attr.ngFlashFormError);var l=b(e);f.$errorCallbacks.push(function(b){var e=c.$new();e.$errors=b;if(b=l(e))a[d](b)})}}}]);h.directive("ngFlashMessage",["$timeout","flash","parseAttrsForScope",function(b,a,c){var f={};return{restrict:"A",link:function(e,g,d){var l=c(d,e,{ngFlashDelay:"=",ngFlashDuration:"=",ngFlashMessage:"@",ngFlashOnce:"=",ngFlashType:"@"});if(!l.ngFlashOnce||!f[l.ngFlashMessage]){var m=b(function(){var b=_.trim(l.ngFlashMessage);
_.isEmpty(b)||(l.ngFlashOnce&&(f[l.ngFlashMessage]=!0),a.add(b,l.ngFlashType||"info",l.ngFlashDuration))},l.ngFlashDelay||0);e.$on("$destroy",function(){b.cancel(m)})}}}}])})();
(function(){var h=angular.module("flash.services",[]);h.factory("flash",["$rootScope",function(b){var a=[],c={add:function(f,e,g){e=e||c.levels.info;var d={message:f,level:e,timeout:g||8E3};a.push(d);d.timeout&&setTimeout(function(){b.$apply(function(){c.remove(d)})},d.timeout)},remove:function(b){_.overwriteWithout(a,_.isReferenceEqualTo(b))},all:function(){return a},clear:function(){_.overwrite(a,[])},levels:{debug:"debug",info:"info",warn:"warn",error:"error",success:"success"},errorHandler:function(a,
b,g){return function(){c.error(a,b||c.levels.error,g)}}};_.forEach(c.levels,function(a,b){c[b]=function(b,d){c.add(b,a,d)}});return c}]);h.run(["$rootScope","flash",function(b,a){b.flash=a}])})();
(function(){var h=angular.module("seating",["lib"]);h.factory("grid",[function(){var b={seatOffset:function(a){return{left:29*a.xCoord+1,top:29*a.yCoord+1}},seatDimensions:function(a){var b=a.width;a=a.height;return{width:28*b+1*(b-1),height:28*a+1*(a-1)}},getPosition:function(a,b){var e=Math.max(a-1,0)/29,g=Math.max(b-1,0)/29;return{x:parseInt(e,10),y:parseInt(g,10)}},hoverOffset:function(a){return{left:29*(a.x||0)+1,top:29*(a.y||0)+1}}},a={width:320,height:320};b.getMinimumGridDimensions=function(c){if(!c.length)return a;
var f=_.max(c,function(a){return a.xCoord+a.width});c=_.max(c,function(a){return a.yCoord+a.height});f=b.seatOffset(f).left+29*f.width+290;c=b.seatOffset(c).top+29*c.height+290;return{width:f,height:c}};return b}]);h.directive("ngSeatMapBuilder",["events","grid","models","require",function(b,a,c,f){return{link:function(e,g){f.inScope(e,"seatMap","ngSeatMapBuilder");var d=g.find(".seat-hover-indicator");g.mousemove(function(b){b.target===g[0]&&(b=a.getPosition(b.offsetX,b.offsetY),b=a.hoverOffset(b),
d.css(b).show())});g.mouseleave(function(){d.hide()});g.click(function(f){var g=$(f.target).data("seat"),l;g||(l=f.offsetX,g=f.offsetY,f.target===d[0]&&(l+=f.target.offsetLeft,g+=f.target.offsetTop),l=a.getPosition(l,g),g=c.Seat.defaultSeat(l.x,l.y),g=c.Seat.getOverlappingSeat(g,e.seatMap.seats));g?(f.altKey?b.broadcast("ngSeat.seatAltClicked",g):b.broadcast("ngSeat.seatClicked",g),e.$safeApply()):f.altKey||(b.broadcast("ngSeatMapBuilder.positionClicked",l.x,l.y),e.$safeApply())});var l=function(){g.css(a.getMinimumGridDimensions(e.seatMap.seats))};
_.forEach("dashboard.settings.seating.CreateSeatCtrl.createdSeat dashboard.settings.seating.CreateSeatCtrl.editedSeat dashboard.settings.seating.CreateSeatCtrl.removedSeats dashboard.settings.seating.EditSeatsCtrl.editedSeats dashboard.settings.seating.EditSeatsCtrl.removedSeats dashboard.settings.seating.MoveSeatsCtrl.movedSeats dashboard.settings.seating.DuplicateSeatCtrl.createdSeats".split(" "),function(a){b.on(e,a,l)});l()}}}]);h.directive("ngSeat",["events","grid","require",function(b,a,c){return{link:function(a,
b,g){c.inScope(a,"seat","ngSeat");c.inScope(a,"seatZonesByPk","ngSeat");var d=a.$eval(g.ngSeat),l=/seat-color-\S+/g,m=function(b,c){var e;e=(e=a.seatZonesByPk[d.seatZonePk])?e.color:"";return c.match(l)?c.replace(l,"seat-color-"+e):c+" seat-color-"+e};d.$style=function(){var a=d.width||1,c=d.height||1,f=d.yCoord+1,g=d.xCoord+1;b.css({"-ms-grid-column":g.toString(),"-ms-grid-column-span":a.toString(),"-ms-grid-row":f.toString(),"-ms-grid-row-span":c.toString(),"grid-area":[f,g,f+c,g+a].join("/")});
b.attr("class",m);b.text(d.isNameVisible?d.name:"");b.toggleClass("seat--tall",d.width<d.height);b.toggleClass("seat--wide",3<=d.width||3<=d.height);b.toggleClass("seat--huge",5<=d.width||5<=d.height);b.toggleClass("open",0!==d.capacity);b.toggleClass("closed",0===d.capacity);d.$toggleSelected()};d.$toggleSelected=function(){var c=!d.pk||!!a.selectedSeatPks[d.pk],g=!c&&!!a.selectedSeatGroupPks[d.$addingToGroup||d.seatGroupPk];b.toggleClass("selected",c);b.toggleClass("group-active",g)};d.$style();
b.data("seat",d);a.$on("$destroy",function(){delete d.$style;delete d.$toggleSelected})}}}])})();angular.module("tracking",["tracking.directives","tracking.services"]);
(function(){var h=angular.module("tracking.services",["clientOptions.services"]);h.factory("tracking.geo",[function(){var b=!1,a=[],c=function(){b=!0;_.forEach(a,function(a){a()});a=[];console.info("geo: complete")},f={isEU:null,then:function(c){b?c():a.push(c)},geolocate:function(){var a;try{a=localStorage.getItem("isEU")}catch(b){}a="true"===a?!0:"false"===a?!1:null;null!==a?(f.isEU=a,console.info("geo: cached isEU",a),c()):(console.info("geo: locating..."),window.geoip2.country(function(a){f.isEU=
_.get(a,"country.is_in_european_union",!1);if(null!==f.isEU)try{localStorage.setItem("isEU",f.isEU.toString())}catch(b){}console.info("geo: located isEU",f.isEU);c()},function(a){console.warn("geo: unable to load",a);c()}))}};return f}]);h.factory("tracking.iframes",["navigation","urls",function(b,a){var c={},f=$('<div class="a-embed-iframes-container"></div>');return{requestForBooking:function(a,b,d){c[b.uuid]||(c[b.uuid]=[]);c[b.uuid].push({servicePk:a.pk,uniqueType:d?a.type:null})},loadForBooking:function(e){var g=
[],d={};_.forEach(c[e.uuid],function(a){var b=0;a.uniqueType&&(_.isUndefined(d[a.uniqueType])?d[a.uniqueType]=0:b=++d[a.uniqueType]);g[b]||(g[b]=[]);g[b].push(a)});var l=e.$url(a.embeds.analytics.booking);console.info("analytics: removing iframes");f.detach().empty();_.forEach(g,function(a){a={"selected-services":_.pluck(a,"servicePk").join(",")};a=b.compose(l,a);console.info("analytics: enqueuing iframe",a);var c=$('<iframe class="a-embed-iframe"></iframe>');c.attr("src",a);f.append(c)});console.info("analytics: loading iframes");
$("body").append(f);delete c[e.uuid]}}}]);h.factory("tracking.pixels",[function(){return{load:function(b){console.info("analytics: loading pixel",b);var a=$('<img class="a-pixel-img" width="1" height="1"/>');a.on("load",function(){console.info("analytics: loaded pixel",b);a.remove()});$("body").append(a);a.attr("src",b)}}}]);h.factory("analytics",["$location","$window","auth","clientOptions","db","models","navigation","optimizely","persistentStorage","tracking","tracking.geo","tracking.iframes","tracking.pixels",
"urls",function(b,a,c,f,e,g,d,l,m,k,n,h,p,r){var t=e.slipstream("googleAnalyticsFhMeIds"),v={source:"campaignSource",campaign:"campaignName",medium:"campaignMedium",term:"campaignKeyword",content:"campaignContent"},y=function(a,b){var c=d.get(a)||b||"";d.clear(a,!0);return c};b=function(a){a=a||"utm";a+="_";var b={};_.forEach(v,function(c,d){b[d]=y(a+d)});if(_.any(b))return b};var q=function(a){return _.reduce(a.split(";"),function(a,b){var c=b.split(",");2===c.length&&(c[0]&&c[1])&&(a[c[0]]=c[1]);
return a},{})},B=function(a,b){var c="analytics: "+a+" ("+b+"):";return function(){var a=_.toArray(arguments);a.unshift(c);console.info.apply(window.console,a)}},u={},z=q(y("ga"));_.any(z)&&console.info("analytics: Google: received cross-domain link identifiers:",z);a._gaTracker||console.info("analytics: Google: tracking disabled");u[g.AnalyticsService.GOOGLE_ANALYTICS_TYPE]=function(b,c,d){if(!a._gaTracker)return this;var e=b.googleAnalyticsUa,f=B("Google",e),g=!_.isUndefined(c),k;k=g?c:"company_"+
b.company.shortname.replace(/[-]+/g,"_")+"_"+b.company.pk.toString()+"_"+b.pk.toString();var l=function(a){return k?k+"."+a:a};if(!d){c={name:k};if(z[e])f("cross-domain link succeeded"),c.clientId=z[e],c.storage="none";else{if(b.isCrossDomainOnly)return f("not reporting; no cross-domain link"),this;f("no cross-domain link")}a._gaTracker("create",e,"auto",c);a._gaTracker(l("require"),"ecommerce");a._gaTracker(l("set"),"anonymizeIp",!0)}f("enabling tracking and ecommerce integration");this.setUserId=
function(b){if(!(n.isEU||null===n.isEU)){var c=l("set");f(c,"userId",b);a._gaTracker(c,"userId",b)}};this.trackView=function(b){var c=l("send");f("tracking",c,"pageview",b);var d={page:b},e=/[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}/gi;b.match(e)&&(d.page=b.replace(e,"ID"),d.title=T("Confirmation"));a._gaTracker(l("set"),"page",d.page);a._gaTracker(c,"pageview",d)};this.trackUtm=function(b){var c=l("set");_.forEach(v,function(d,e){var g=b[e];g&&(g=g.toString(),f("tracking",
c,d,g),a._gaTracker(c,d,g))})};this.trackBooking=function(b){var c=b.pk.toString();if(n.isEU||null===n.isEU)c=_.uuid();var d={id:c,affiliation:b.company.affiliation?b.company.affiliation.affiliateCompany.shortname:"FareHarbor",currency:b.company.processorCurrency.toUpperCase(),revenue:(b.costs.totalCost.total/100).toFixed(2),shipping:"0.00",tax:(b.costs.totalCost.tax/100).toFixed(2)},e={};_.forEach(b.customers,function(a){var d=a.customerTypeRate.uri;e[d]||(e[d]={id:c,name:b.availability.item.name,
sku:a.customerTypeRate.customerPrototype.customerType.plural,price:(a.costs.totalCost.price/100).toFixed(2),quantity:0},g&&(e[d].category=b.company.shortname));e[d].quantity+=1});var k=_.values(e);f("tracking booking",d,k);a._gaTracker(l("ecommerce:addTransaction"),d);_.forEach(k,function(b){a._gaTracker(l("ecommerce:addItem"),b)});a._gaTracker(l("ecommerce:send"))}};var C={account:y("o-aid"),project:y("o-pid"),user:y("o-uid"),experiments:q(y("o-x"))};_.any(_.omit(C,"experiments"))&&console.info("analytics: Optimizely: received cross-domain link identifiers:",
C);u[g.AnalyticsService.OPTIMIZELY_TYPE]=function(a){var b=a.optimizelyAccount,c=a.optimizelyProject,e=B("Optimizley","account: "+b+", project: "+c);if(!_.every(C)||!_.any(C.experiments))return e("not reporting; no cross-domain link or no active experiments"),this;var f=c!==C.project;if(b!==C.account||f)return e("not reporting; no cross-domain link"),this;e("enabling");this.trackBooking=function(f){var g={a:c,d:b,n:a.optimizelyEventKey,g:a.optimizelyGoals,u:C.user,v:f.receipt.gross,time:f.createdAt.unix()};
_.forEach(C.experiments,function(a,b){g["x"+b]=a});var k="http://"+c+".log.optimizely.com/event";e("tracking booking",f);p.load(d.compose(k,g))}};var F={pixel:y("fb-pix")};_.any(F)&&console.info("analytics: Facebook: received cross-domain link identifiers",F);u[g.AnalyticsService.FACEBOOK_TYPE]=function(a){var b=B("Facebook",a.facebookPixel);if(a.isCrossDomainOnly){if(a.facebookPixel!==F.pixel)return b("not reporting; no cross-domain link"),this;b("cross-domain link succeeded")}b("enabling");this.trackBooking=
function(c){b("intitializing booking tracking",c);h.requestForBooking(a,c,!0)}};var x={advertiser:y("ad-adv"),pixel:y("ad-pix")};_.any(x)&&console.info("analytics: Adroll: received cross-domain link identifiers",x);u[g.AnalyticsService.ADROLL_TYPE]=function(a){var b=B("Adroll","advertiser: "+a.adrollAdvertiser+", pixel: "+a.adrollPixel);if(a.isCrossDomainOnly){var c=a.adrollPixel===x.pixel;if(a.adrollAdvertiser!==x.advertiser||!c)return b("not reporting; no cross-domain link"),this;b("cross-domain link succeeded")}b("enabling");
this.trackBooking=function(c){b("intitializing booking tracking",c);h.requestForBooking(a,c,!0)}};u[g.AnalyticsService.CUSTOM_CODE_TYPE]=function(a){var b=B("Custom Code","#"+a.pk);this.trackBooking=function(c){b("intitializing booking tracking");h.requestForBooking(a,c)}};var w=u[g.AnalyticsService.GOOGLE_ANALYTICS_TYPE],G={ANONYMOUS:new w({googleAnalyticsUa:e.slipstream("googleAnalyticsAnonymousId")},"anonymous",!0),ADMIN:new w({googleAnalyticsUa:e.slipstream("googleAnalyticsAdminId")},"admin",
!0),COMPANY:new w({googleAnalyticsUa:e.slipstream("googleAnalyticsCompanyId")},"company",!0),EVERYONE:new w({googleAnalyticsUa:e.slipstream("googleAnalyticsId")},"",!0)},M=_.map(t,function(a,b){return new w({googleAnalyticsUa:a,isCrossDomainOnly:!0},"fh_dotme_"+b)}),K=M.concat(G.ANONYMOUS);if((t=b("fh"))&&(!c.currentUser.isAuthenticated&&"/"!==d.path)&&G.ANONYMOUS.trackUtm)console.info("analytics: tracking FareHarbor utm",t),G.ANONYMOUS.trackUtm(t);var H=function(a,b){var c=_.rest(arguments,2);n.then(function(){_.forEach(a,
function(a){a[b]&&a[b].apply(a,c)})})};H(G,"setUserId",m.getIdentifier());var L=b(),E=[],N={},I=function(a){E=[];if(a)if(N[a.shortname])E=N[a.shortname];else{var b=e.analyticsServices({shortname:a.shortname},null,null,null,{flashError:!1});b.$promise.then(function(){_.forEach(b,function(a){u[a.type]?(a=new u[a.type](a),E.push(a)):console.error("analytics: invalid service type:",a.type,"(#",a.pk,")")});N[a.shortname]=E;L&&(H(E,"trackUtm",L),L=null)},function(){console.error("analytics: unable to load services")})}},
D=function(){var a=!d.pathStartsWith(r.company.login),b=!d.pathStartsWith(r.dashboard.index),c=f.asnAffiliateCompany,c=!c||c!==g.Company.CALL_CENTER_SHORTNAME;return a&&b&&c},Z=function(a){0===a.indexOf("/#!")&&(a=a.substr(3));return a},ia,J,ea={trackCompany:function(a){I(a);k.extendSessionProperties({"current-company":a?a.shortname:null});J&&D()&&(a=Z(J),H(E,"trackView",a))},trackView:function(a){if(a)if(a===ia)console.info("analytics: not re-tracking",a);else{ia=a;a=Z(a);console.info("analytics: tracking view",
a);var b=[];c.currentUser.isAuthenticated?c.currentUser.company.isAdmin?b.push(G.ADMIN):b.push(G.COMPANY):("/"!==a&&b.push(G.ANONYMOUS),D()&&(J=a,b=b.concat(M).concat(E)));b.push(G.EVERYONE);H(b,"trackView",a)}else console.warn("analytics: invalid url, not tracking",a)},trackBooking:function(a){if(!c.currentUser.isAuthenticated){console.info("analytics: tracking booking",a);var b=K;D()&&(b=b.concat(E),l.trackBooking(a));H(b,"trackBooking",a);h.loadForBooking(a)}},trackOrder:function(a){c.currentUser.isAuthenticated||
_.forEach(a.contributingBookings,function(a){ea.trackBooking(a)})}};return ea}]);h.factory("tracking",["$rootScope","auth","clientOptions","db",function(b,a,c,f){var e=f.slipstream("isMixpanelEnabled"),g=f.slipstream("isDebug"),d=!1,l=moment(window.$$loadTime),m=function(){var a=moment();return{"elapsed-time-seconds":_.roundHalfToEven(a.diff(l)/1E3,2),"local-time-decimal":parseFloat(a.format("H.mm")),"local-day-of-week":a.format("dddd"),"local-date":a.format("YYYY-MM-DDTHH:mm:ss")}},k=_.mapValues({track:"track",
identify:"identify",register:"register",unregister:"unregister",name:"name_tag"},function(b,c){return function(){if(e){var d=window.mixpanel||{},f;a.currentUser.isAuthenticated?a.currentUser.company.isAdmin||(f=d.company):f=d.anonymous;if(f)if(d=b,_.isString(b)&&(d=f[b]),d){if(console.info("tracking: mixpanel."+c,_.toArray(arguments)),!g)try{return d.apply(f,arguments)}catch(k){console.error("tracking: mixpanel."+c,"exception",k)}}else console.error("tracking: mixpanel."+c,"invalid method");else console.info("tracking: mixpanel."+
c,_.toArray(arguments),"skipping: no library for user")}else console.info("tracking: mixpanel."+c,_.toArray(arguments),"skipping: disabled")}}),n={isIdentified:function(a){_.isUndefined(a)||(d=a);return d},identify:k.identify,name:k.name,initialView:function(b){!a.currentUser.isAuthenticated&&!n.sessionProperties["initial-view"]&&(console.log("tracking: setting initial view:",b),n.extendSessionProperties({"initial-view":b}))},sessionProperties:{configuration:f.slipstream("configuration"),whitelisted:f.slipstream("isWhitelisted")},
extendProperties:k.register,extendSessionProperties:function(a){_.extend(n.sessionProperties,a)},extendScopeProperties:function(a,b){Object.defineProperty(b,"$parentPersistentTrackingProperties",{value:a.$persistentTrackingProperties,enumerable:!1});a.$persistentTrackingProperties=b},track:function(a,c,d,e){a=a||b;d=[d];for(a=a.$persistentTrackingProperties;a;)d.push(a),a=a.$parentPersistentTrackingProperties;d.push(n.sessionProperties);d.push(m());d.reverse();d.unshift({});a=_.extend.apply(_,d);
k.track(c,a,e)},trackEmbed:function(b){if(!a.currentUser.isAuthenticated){var d={"embed-type":b};_.isUndefined(c.trackingFromEmbed)||(d["from-embed-type"]=c.trackingFromEmbed);b=function(a,b){var e=c[a];e&&(e=_.filter(_.map(e.split(","),_.compose(_.camelCase,$.trim))),e.length&&(d[b]=e))};b("trackingSiteTags","site-tags");b("trackingPageTags","page-tags");b("trackingButtonTags","button-tags");_.isUndefined(c.trackingIsFromSsl)||(d["from-ssl"]=c.trackingIsFromSsl);n.extendSessionProperties(d);console.log("tracking: set up embed tracking",
d)}}};return n}]);h.factory("labs",["$window","db","navigation","storage",function(b,a,c,f){var e=function(a){a=a||c.currentCompany;return a.features.isLabsEnabled};return{initialize:function(){var a=f.get("fhLabsExperiments")||{},c=f.get("fhLabsData")||{};b.fhLabsExperiments=_.extend({},b.fhLabsExperiments);b.fhLabsData=_.extend({},b.fhLabsData);_.isEmpty(a)||(console.info("labs: Using experiment assignments from local storage",a),b.fhLabsExperiments=_.extend(b.fhLabsExperiments,a));_.isEmpty(c)||
(console.info("labs: Using labs data from local storage",c),b.fhLabsData=_.extend(b.fhLabsData,c));b.$$overrideFhLabsExperiment=function(a,c){b.fhLabsExperiments[a]=c;f.set("fhLabsExperiments",b.fhLabsExperiments)};b.$$overrideFhLabsData=function(a,c){b.fhLabsExperiments[a]=c;f.set("fhLabsData",b.fhLabsExperiments)};console.info("labs: service active")},data:function(a){return b.fhLabsData[a]},isInVariation:function(a,c){if(!e())return!1;var f=b.fhLabsExperiments[a];return c?_.isString(f)&&f===c:
_.isString(f)&&"control"!==f},isInControl:function(a){return!e()||"control"===b.fhLabsExperiments[a]},isLabsEnabled:e}}]);h.factory("optimizely",["$window","tracking",function(b,a){return{initialize:function(){if(!b.optimizely||!b.optimizely.activate)console.warn("optimizely: not loaded");else{console.info("optimizely: activating experiments");b.optimizely.activate();console.info("optimizely: all experiments",b.optimizely.allExperiments);console.info("optimizely: active experiments",b.optimizely.activeExperiments);
var c={};_.forEach(b.optimizely.activeExperiments,function(a){c["optimizely "+b.optimizely.allExperiments[a].name]=b.optimizely.allVariations[b.optimizely.variationIdsMap[a]].name});a.extendSessionProperties(c)}},trackBooking:function(a){console.info("optimizely: tracking booking with revenue",a.receipt.bookingFee);b.optimizely&&(b.optimizely.push(["trackEvent","booked"]),b.optimizely.push(["trackEvent","bookingFee",{revenue:a.receipt.bookingFee}]))}}}]);h.run(["$rootScope","auth","events","labs",
"optimizely","persistentStorage","tracking","tracking.geo",function(b,a,c,f,e,g,d,l){b.optimizely=e;b.labs=f;l.geolocate();e.initialize();f.initialize();var m=function(){a.currentUser.isAuthenticated?(d.isIdentified(!0),d.identify(a.currentUser.identifier),d.extendProperties({company:a.currentUser.company.shortname,userType:a.currentUser.type}),d.name(a.currentUser.identifier)):(d.isIdentified(!1),d.identify(g.getIdentifier()),d.extendProperties({company:null,userType:"anonymous"}),d.name("Guest"))};
c.on(b,"auth.login",function(){m()});c.on(b,"auth.logout",function(){m()});m()}])})();
(function(){var h=angular.module("tracking.directives",[]),b=function(a,b){h.directive(a,["$injector","$parse","d","models","navigation","tracking","tracking.geo",function(f,e,g,d,l,m,k){_.isArray(b)&&(b=f.invoke(b));var n=b.require||[],h={Company:function(a){return{company:a.shortname}},Item:function(a){return{item:a.name,company:a.company.shortname}},FlowNode:function(a){var b={company:a.company.shortname,"flow-page":a.unicode,"flow-page-block-count":d.FlowNode.effectiveChildren(a).length,"flow-page-includes-calendar":d.FlowNode.isCalendarIncluded(a),
"flow-page-breadcrumb-count":a.breadcrumbs?a.breadcrumbs.length:void 0,"flow-page-breadcrumbs":_.pluck(a.breadcrumbs,"name").join(",")};a.item&&_.extend(b,h.Item(a.item));return b},Availability:function(a){return{availability:a.pk,item:a.item.name,company:a.company.shortname}},CustomerType:function(a){return{"customer-type":a.plural,company:a.company.shortname}},CustomerPrototype:function(a){return{"customer-prototype":a.name,"customer-type":a.customerType.plural,company:a.company.shortname}},CustomerTypeRate:function(a){return{item:a.availability.item.name,
availability:a.availability.pk,"customer-prototype":a.customerPrototype.name,"customer-type":a.customerPrototype.customerType.plural,company:a.company.shortname}},Booking:function(a){var b={gross:a.costs.totalCost.total,customerCount:a.customerCount,company:a.company.shortname};!1===k.isEU&&(b.booking=a.uuid);return b}},p=function(a){if(a&&a.cls){var b=h[a.cls];if(b)return b(a)}},r={ngMxDataCompany:p,ngMxDataItem:p,ngMxDataItems:function(a){return{items:_.pluck(a,"name").join(",")}},ngMxDataFlowNode:p,
ngMxDataAvailability:p,ngMxDataBooking:p,ngMxDataCustomerType:p,ngMxDataCustomerTypeRate:p,ngMxDataUrl:function(){return{url:l.url}}};return{restrict:"A",require:n,compile:function(d,k){var l=k.ngMxWhen?e(k.ngMxWhen):_.always,h=b.compile?g.safeInvoke(f,b.compile)(d,k):g.safeInvoke(f,b.link);return function(d,e,f,g){var k=!1,s=function(e,g){if(!1===e)console.log("tracking: mx() cancelled tracking");else{_.isObject(e)&&(g=e,e=void 0);var n=e||f[a];if(n)if(l(d)){if(!b.once||!k){k=!0;var h={};_.forEach(r,
function(a,b){_.extend(h,a(d.$eval(f[b])||null))});_.extend(h,d.$eval(f.ngMxData));_.forEach(g,function(a,b){_.isObject(a)?_.extend(h,p(a)):h[b]=a});m.track(d,n,h)}}else console.log("tracking: ng-mx-when cancelled tracking",n);else console.warn("tracking: invalid action",a)}};h&&(e=[d,e,f],n.length&&e.push(g),e.push(s),h.apply(null,e))}}}}])};h.directive("ngMxScopeData",["tracking",function(a){return{priority:1,restrict:"A",scope:!0,link:{pre:function(b,f,e){if(!e.ngMxWhen||b.$eval(e.ngMxWhen))f=
b.$eval(e.ngMxScopeData),a.extendScopeProperties(b,f)}}}}]);b("ngMxView",{once:!0,link:["tracking",function(a){return function(b,f,e,g){_.isUndefined(e.ngMxViewInitial)||a.initialView(e.ngMxViewInitial||e.ngMxView);g()}}]});b("ngMxClick",{link:function(a,b,f,e){b.on("click",function(){a.$apply(function(){e()})})}});b("ngMxChange",{require:"ngModel",compile:["$parse",function(a){return function(b,f){var e=f.ngMxChangeWhen?a(f.ngMxChangeWhen):_.always;return function(a,b,c,f,k){a.$watch(function(){return f.$modelValue},
function(b,c){b!==c&&e(a,{$value:b,$oldValue:c})&&k({"new-value":b,"old-value":c})})}}}]});b("ngMxForm",{require:"form",link:function(a,b,f,e,g){a=f.ngMxForm.split(",");var d=a[0]||"",d=d.trim(),l=a[1]||"",l=l.trim(),m=function(a){var b={};_.forEach(a,function(a,c){a.length&&(b[c]=a)});return JSON.stringify(b)};e.$successCallbacks||(e.$successCallbacks=[]);e.$successCallbacks.push(function(a){g(d,{object:a})});l&&(e.$errorCallbacks||(e.$errorCallbacks=[]),e.$errorCallbacks.push(function(a){g(l,{formErrors:m(a)})}))}});
b("ngMxFormValid",{require:"^form",link:[function(){return function(a,b,f,e,g){var d,l=a.$watch(function(){d||(d=setTimeout(function(){d=null;var e=b.find("[ng-model]");if(e.length){var f=b.find("[ng-mx-form-valid-async]"),n=b.find("[ng-mx-form-valid-async-success]");if(f.length===n.length){var h=_.map(e,function(a){return angular.element(a).controller("ngModel")});_.all(h,"$valid")&&(l(),a.$apply(function(){g({"form-was-edited":_.any(h,"$dirty")})}))}}}))})}}]})})();angular.module("native",["native.services"]);
(function(){var h=angular.module("native.services",[]);h.factory("native",["$rootScope","$window","auth","db","events",function(b,a,c,f,e){var g={STRONG_SUCCESS_INDICATION:"fareharbor.native.indicate.strongSuccessIndication",WEAK_SUCCESS_INDICATION:"fareharbor.native.indicate.weakSuccessIndication",STRONG_ERROR_INDICATION:"fareharbor.native.indicate.strongErrorIndication",WEAK_ERROR_INDICATION:"fareharbor.native.indicate.weakErrorIndication"},d=f.slipstream("isNative")||!1,l=f.slipstream("nativeClient")||
"",m=f.slipstream("nativeClientVersion")||"",k=f.slipstream("isDebug"),n=f.slipstream("domain"),h=f.slipstream("protocol"),p={isNative:d,client:l,version:m,broadcast:function(b,c){console.info("native: triggering",b,c);a.webkit&&a.webkit.messageHandlers&&a.webkit.messageHandlers.fareharbor?(c=_.extend({type:b},c),a.webkit.messageHandlers.fareharbor.postMessage(c)):console.warn("native: native client unavailable")},indicate:function(a){a=a||g.WEAK_SUCCESS_INDICATION;p.broadcast("fareharbor.native.indicate",
{indication:a})},print:function(a){var b={};if(a){var c=["<!DOCTYPE html>",'<html class="native-print">',"<head>",'<meta name="viewport" content="initial-scale=1.0" />'];_.forEach($('head link[type="text/css"][href^="/"]'),function(a){a=$(a).attr("href");a=_.startsWith(a,"//")?h+":"+a:h+"://"+n+a;c.push('<link rel="stylesheet" href="'+a+'" type="text/css">')});c.push("</head>");c.push("<body>");c.push(a.outerHTML);c.push("</body>");c.push("</html>");b.html=c.join("\n")}console.info("native: print",
b);p.broadcast("fareharbor.native.print",b)}};_.extend(p,g);e.on(b,"auth.logout",function(){p.broadcast("fareharbor.native.loggedOut")});c.currentUser.isAuthenticated||p.broadcast("fareharbor.native.logOut");a.FH={nativeEvent:function(a){b.$apply(function(){e.broadcast(a.type,a)})}};p.broadcast("fareharbor.native.ready");e.on(b,"fareharbor.native.inApp",function(a,b){p.isNative=!0;p.client=b.client||p.client||"unknown";p.version=b.version||p.version||"unknown"});if(k)e.on(b,"fareharbor.native.test",
function(b,c){a.confirm("fareharbor.native.test triggered; respond?")&&p.broadcast("fareharbor.native.testSucceeded",{number:42})});return p}]);h.run(["$rootScope","native",function(b,a){b.native=a}])})();angular.module("navigation",["navigation.services","navigation.directives"]);
(function(){var h=angular.module("navigation.directives",["clientOptions.services","lib.services"]);h.directive("ngNavigationActive",["d","navigation",function(a,b){return{restrict:"A",link:function(f,e,g){var d=f.isSet(g.ngNavigationExact)?b.pathEquals:b.pathStartsWith,l,m=function(){var a=l();a?_.isString(a)?e.toggleClass("current",!!d(a)):_.isArray(a)?e.toggleClass("current",_.any(a,function(b){return!b?(console.warn("ng-navigation-active: empty url in list",b,a,g.ngNavigationActive,g.ngHref),
!1):!!d(b)})):console.warn("ng-navigation-active: invalid url",a,g.ngNavigationActive,g.ngHref):(console.warn("ng-navigation-active: no url",a,g.ngNavigationActive,g.ngHref),e.removeClass("current"))};if(g.ngNavigationActive)l=a.watcher(f,g.ngNavigationActive,"",m,!0);else if(g.ngHref)l=a.observer(g,"ngHref","",m);else{console.warn("invalid use of ng-navigation-active");return}b.watch(f,m);m()}}}]);var b=function(a,b){h.directive(a,["$injector","$parse","navigation",function(f,e,g){var d=f.invoke(b);
return{transclude:"element",priority:1E3,terminal:!0,restrict:"A",compile:function(b,c,f){b=a+"When";var g=c[b]?e(c[b]):null;return function(a,b,c){var e=d(a,b,c),l,m,h=function(c){m&&m.$destroy();m=a.$new();m.route={bindings:c};f(m,function(a){l&&l.remove();b.after(a);l=a})},B;a.$watch(function(){return g&&!g(a)?!1:(B=e())?JSON.stringify(B):!1},function(b,d){c.ngThen&&(a[c.ngThen]=!!b);b&&d?h(B):b?h(B):d&&(m&&m.$destroy(),l&&(l.remove(),l=null))})}}}}])};b("ngNavigationSpec",["$parse","navigation",
function(a,b){var f={prefix:"pathStartsWith",path:"pathEquals"};return function(e,g,d){var l=_.bind(a(d.ngNavigationSpec),null,e),m=function(a){return b[f[a[0]]](a[1])};return function(){var a=l();return _.chooseFirst(a,m)}}}]);b("ngNavigationPrefix",["$parse","navigation",function(a,b){return function(f,e,g){var d=_.bind(a(g.ngNavigationPrefix),null,f),l=function(a){if(!a)throw Error("ng-navigation-prefix: invalid paths: "+g.ngNavigationPrefix);return b.pathStartsWith(a)};return function(){var a=
d();if(_.isUndefined(a))throw Error("ng-navigation-prefix: undefined paths: "+g.ngNavigationPrefix);_.isArray(a)||(a=[a]);if(!a.length)throw Error("ng-navigation-prefix: empty paths: "+g.ngNavigationPrefix);return _.chooseFirst(a,l)}}}]);b("ngNavigationPath",["$parse","navigation",function(a,b){return function(f,e,g){var d=_.bind(a(g.ngNavigationPath),null,f),l=function(a){if(!a)throw Error("ng-navigation-path: invalid paths: "+g.ngNavigationPath);return b.pathEquals(a)};return function(){var a=d();
if(_.isUndefined(a))throw Error("ng-navigation-path: undefined paths: "+g.ngNavigationPath);_.isArray(a)||(a=[a]);if(!a.length)throw Error("ng-navigation-path: empty paths: "+g.ngNavigationPath);return _.chooseFirst(a,l)}}}]);b("ngNavigationSection",["navigation",function(a){var b={root:"inRootSection",company:"inCompanySection",manifest:"inManifestSection",dashboard:"inDashboardSection"};return function(f,e,g){return function(){return a[b[g.ngNavigationSection]]()}}}]);b("ngNavigationInvoiceLogin",
["navigation","urls",function(a,b){var f=b.dashboard.reports.invoices.partnerInvoice.index,e=function(b){var c=a.get("next");return!c?!1:a.parseQuery(c).source===b};return function(b,c,l){return function(){return a.nextPathEquals(f)&&(e("uuid-invoice")||e("email"))}}}]);h.directive("ngConfirmNavigateAway",["$parse","$rootScope","$window","navigation",function(a,b,f,e){return{restrict:"A",require:"form",compile:function(b,c){var l=c.ngConfirmNavigateAwayWhen?a(c.ngConfirmNavigateAwayWhen):null;return function(a,
b,c,d){b=e.url;var g=e.stripQuery(b),h=e.parseQuery(b);if(!f.slipstream.isEmbedded||f.slipstream.isBookEmbed){var t=function(){return c.ngConfirmNavigateAway?c.ngConfirmNavigateAway:T("Your changes will be lost.")},v=function(b){if(l)return l(a,{$url:b});b=!_.isUndefined(b)?e.stripPrefix(b):"";var c=e.stripQuery(b);g!==c?b=!0:(b=e.parseQuery(b),b=!_.isEmpty(h)&&!_.isEqual(h,b)?!0:!1);return b&&d.$dirty},y=function(){if(v())return t()};a.$on("$locationChangeStart",function(a,b){v(b)&&!f.confirm(T("Are you sure you want to leave this page?")+
" "+t())&&a.preventDefault()});var q=angular.element(f);q.on("beforeunload",y);a.$on("$destroy",function(){q.off("beforeunload",y)})}}}}}]);h.config(["$provide",function(a){a.decorator("ngHrefDirective",["$delegate",function(a){a.shift();return a}])}]);h.directive("ngHref",["$browser","$location","$parse","clientOptions","d","navigation",function(a,b,f,e,g,d){return{restrict:"A",link:function(a,b,c){var f=!1,h=function(){var a=p();f&&(a=d.multiUrl(a));a=e.reflectUrl(a);c.$set("href",a)},p=g.observer(c,
"ngHref","",function(b){!f&&d.parseMultiUrl(b)?(f=!0,d.watch(a,h)):h()})}}}]);b=function(a,b){return h.directive(a,["d","navigation",function(f,e){return{restrict:"A",link:function(g,d,l){var m=g.isSet(l[a+"Strict"]),k=f.observer(l,a);d.on("click",function(a){var f=$(a.target),l=k();if(l&&b.test(a)&&!a.defaultPrevented&&(!m||d.is(f)))if(!f.is("a")||d.is(f))g.$apply(function(){e.navigate(l)}),b.preventDefault&&a.preventDefault()})}}}])};b("ngNavigate",{test:function(a){return!a.shiftKey&&!a.controlKey&&
!a.metaKey&&!a.altKey}});b("ngShiftNavigate",{test:function(a){return a.shiftKey&&!a.controlKey&&!a.metaKey&&!a.altKey}});b("ngControlNavigate",{test:function(a){return!a.shiftKey&&a.ctrlKey&&!a.metaKey&&!a.altKey}});b("ngMetaNavigate",{test:function(a){return!a.shiftKey&&!a.controlKey&&a.metaKey&&!a.altKey}});b("ngAltNavigate",{test:function(a){return!a.shiftKey&&!a.controlKey&&!a.metaKey&&a.altKey},preventDefault:!0});b("ngShiftOrAltNavigate",{test:function(a){return(a.shiftKey||a.altKey)&&!a.controlKey&&
!a.metaKey}});h.directive("ngRedirect",["navigation",function(a){return{restrict:"A",link:function(b,f,e){f=b.$eval(e.ngRedirect);b=b.$eval(e.ngRedirectMode)||"";if(!f)throw Error("ng-redirect: no url: "+e.ngRedirect);a.redirect(f,b)}}}]);h.directive("ngReload",["navigation",function(a){return{restrict:"A",link:function(b,f,e){a.reload()}}}]);h.directive("ngReloadRoot",["$location","$window","navigation","urls",function(a,b,f,e){return{restrict:"A",link:function(){var g=f.compose(e.root.index,a.search());
b.location.replace(g)}}}])})();
(function(){var h=angular.module("navigation.services",["auth.services","db.services","lib.services","urls.services"]);h.factory("navigation",["$rootScope","$browser","$injector","$location","$timeout","$window","auth","db","events","models","urls",function(b,a,c,f,e,g,d,l,m,k,n){l.slipstream("isDebug");var h=l.slipstream("protocol"),p=l.slipstream("domain"),r=a.baseHref();"/"===r[r.length-1]&&(r=r.slice(0,r.length-1));var t=function(a){return!r&&"/embeds/"===a.slice(0,8)||!r&&"/"!==a.slice(0,1)?
!1:a.slice(0,r.length)===r},v=function(a){return!t(a)?r+a:a},y="_top"===$("base").attr("target"),q=function(a,b){var c=g;y&&(c=g.top);b?c.location.replace(a):c.location.assign(a)},B={admin:"admin-section",company:"company-section",dashboard:"dashboard-section",root:"root-section"};B.all=_.values(B).join(" ");var u=function(a,b){b?($("body").removeClass(B.all),$("body").addClass(B[a])):$("body").removeClass(B[a])},z={glob:"([a-zA-Z0-9-_.]+)",slug:"([a-z0-9-_.]+)",path:"([a-z-/]+)",pk:"([0-9]+)",pks:"(([0-9]+)(,[0-9]+)*)"},
C=function(a,b,c){a=a.replace(/\//g,"\\/");a=a.replace(/:(\w+)(\((\w+)\))?/g,function(a,b,d,e){c.push(b);return d?z[e]:z.glob});return RegExp("^"+a+(b?"$":""))},F={},x=function(a,b){if(!a)throw Error("navigation: matcher not given path");if(!_.isString(a))throw console.error("navigation: matcher not given a string path",a,b),Error("navigation: matcher not given string path");var c=a+(b?"$":""),d=F[c];if(d)return d;var e=[],g,k=E.parseMultiUrl(a);if(k&&k.multiPath){g=C(k.path,!1,e);var l=[],m=C(k.multiPath,
b,l),d=function(){var a=f.search()[k.key];if(_.isUndefined(a))return!1;a=a||"/";"/"!==a[a.length-1]&&(a+="/");var b=E.path;"/"!==b[b.length-1]&&(b+="/");b=_.toArray(g.exec(b));if(!b.length)return!1;a=_.toArray(m.exec(a));if(!a.length)return!1;var c={};_.forEach(_.rest(b),function(a,b){c[e[b]]=a});_.forEach(_.rest(a),function(a,b){c[l[b]]=a});return c}}else g=C(a,b,e),d=function(){var a=E.path;"/"!==a[a.length-1]&&(a+="/");a=_.toArray(g.exec(a));if(!a.length)return!1;var b={};_.forEach(_.rest(a),function(a,
c){b[e[c]]=a});return b};return F[c]=d},w={};k=function(a,b){return function(c,d){var e=a+c;if(!d&&!_.isUndefined(w[e]))return w[e];var f=b(c);return w[e]=f}};var G=function(a,b){return function(){if(!_.isUndefined(w[a]))return w[a];var c=b();return w[a]=c}},M=function(a){try{return decodeURIComponent(a)}catch(b){}},K=function(a){var b={},c,d;_.forEach((a||"").split("&"),function(a){a&&(c=a.replace(/\+/g,"%20").split("="),d=M(c[0]),_.isUndefined(d)||(a=!_.isUndefined(c[1])?M(c[1]):!0,Object.hasOwnProperty.call(b,
d)?_.isArray(b[d])?b[d].push(a):b[d]=[b[d],a]:b[d]=a))});return b},H=function(a){var b=a.replace("%3F","?");return _.contains(b,"?")?b.split("?")[0]:a},L=function(a){return a&&(a=a.replace("%3F","?"),_.contains(a,"?"))?(a=a.split("?")[1],K(a)):{}},E={base:r,url:v(f.url()||"/"),path:v(f.path()||"/"),compose:function(a,b,c){c&&(b=_.pick(b,function(b,c){return!RegExp("[&\\?]"+c+"=").test(a)}));if(b=l.toKeyValue(b)){c="";var d=a.indexOf("#");-1!==d&&(c=a.slice(d),a=a.slice(0,d));return _.contains(a,"?")?
a+"&"+b+c:a+"?"+b+c}return a},parseQuery:L,stripQuery:H,stripPrefix:function(a){return a.replace(/^https?:\/\/[^\/]+/,"")},extendQuery:function(a,b){var c=E.parseQuery(a);_.extend(c,b);a=H(a);return E.compose(a,c)},pathStartsWith:k("pathStartsWith",function(a){return x(a)()}),pathEquals:k("pathEquals",function(a){return x(a,!0)()}),nextPathEquals:k("nextPathEquals",function(a){a=C(a,!0,[]);var b=f.search().next;if(_.isUndefined(b))return!1;b=H(b);return(a=a.exec(b))&&a.length}),inCompanySection:G("inCompanySection",
function(){var a,b=!E.inRootSection()&&!E.inDashboardSection()&&!E.inLegacyManifestSection()&&!!(a=E.pathStartsWith(n.company.index));u("company",b);return a}),inDashboardSection:G("inDashboardSection",function(){var a,b=!E.inRootSection()&&!!(a=E.pathStartsWith(n.dashboard.index));u("dashboard",b);return a}),inLegacyManifestSection:G("inLegacyManifestSection",function(){var a,b=!E.inRootSection()&&!!(a=E.pathStartsWith(n.legacyManifest));u("dashboard",b);return a}),inRootSection:G("inRootSection",
function(){var a=!1;_.forEach(n.root,function(b){a=b===n.root.index?a||E.pathEquals(b):_.isObject(b)?a||E.pathStartsWith(b.index):a||E.pathStartsWith(b)});u("root",a);return a}),reload:function(){b.$evalAsync(function(){location.reload(!0)})},redirect:function(a,b,c){if(f.$$replace)e(_.bind(E.redirect,E,a,b,c));else if(a=E.multiUrl(a||"/",b||"extend"),!t(a)||c)q(a,!0);else return a=t(a)?a.slice(r.length):a,f.replace(),f.url(a),a},navigate:function(a,b,c){a=E.multiUrl(a||"/",b||"replace");if(!t(a)||
c)q(a);else return a=t(a)?a.slice(r.length):a,f.url(a),a},forceNavigate:function(a){return b.$apply(function(){return E.navigate(a)})},open:function(a,b,c){c&&(c.stopPropagation(),c.preventDefault());b=_.extend({},{status:1,scrollbars:1,resizable:1},b);b=_.map(b,function(a,b){return b+"="+a}).join(",");g.open(a,"$$window",b)},get:function(a){return f.search()[a]},set:function(a,b,c){c&&f.replace();return f.search(a,b)},clear:function(a,b){b&&f.replace();return f.search(a,null)},getInt:function(a){a=
_.int(this.get(a));if(!isNaN(a))return a},getPk:function(a){a=E.getInt(a);if(!_.isUndefined(a)&&!(0>=a))return a},getPks:function(a){return _.splitPks(this.get(a))},parseMultiUrl:function(a){if(_.isUndefined(a))console.warn("navigation: invalid multi-url",a);else if(!/^(https?|ftp|mailto|tel)/.test(a)){var b=_.split(a,"@",2);if(2===b.length&&(a=b[0],b=b[1])){var b=_.split(b,"=",2),c=b[0],d=b[1]||"",e={},b=_.split(d,"?",2);2===b.length&&(d=b[0],e=K(b[1]));return{path:a,key:c,multiPath:d,search:e}}}},
multiUrl:function(a,b,c){if(!a)throw Error("navigation: bad url to multi");b=b||"replace";var d=E.parseMultiUrl(a),e={};d&&(b="extend",d.multiPath&&(e[d.key]=d.multiPath),_.extend(e,d.search));"extend"===b&&(e=_.extend({},f.search(),e),d&&!d.multiPath&&delete e[d.key]);d&&(a=d.path,c?a=c:E.pathStartsWith(d.path)&&(a=E.path));return E.compose(a,e)},watch:function(a,b,c){var d=function(){a.$safeApply(function(){b(E.path,E.url)})},e=function(a,b){if(_.isObject(c)&&c.search)if(a===b)d();else{var e=c.search,
f=L(a),g=L(b);e&&(f=_.pick(f,e),g=_.pick(g,e));_.isEqual(f,g)||d()}else d()};return"path"===c?a.$watch(function(){var a=E.parseMultiUrl(E.url);return a?a.path:E.path},d):"multiPath"===c?a.$watch(function(){var a=E.parseMultiUrl(E.url);return a?a.key+"="+a.multiPath:""},d):a.$watch(function(){return E.url},e)},currentCompany:null,updateCurrentCompany:function(a,b){var d=c.get("analytics");E.currentCompany=b;d.trackCompany(E.currentCompany);m.broadcast("navigation.company.updated",{company:E.currentCompany});
a.$on("$destroy",function(){E.currentCompany=null;d.trackCompany(null);m.broadcast("navigation.company.updated",{company:E.currentCompany})})},isCurrentCompany:function(a){return E.currentCompany&&_.isUriEqual(E.currentCompany,a)},absoluteUrl:function(a){a=_.isUndefined(a)?E.url:v(a);return h+"://"+p+a},loginRedirectUrl:function(a){var b;b=E.currentCompany?E.currentCompany.$url(n.company.login):n.root.login;var c=E.path,d=_.extend({},f.search());delete d.next;var d=E.compose(c,d),e={};/\/login\//g.test(c)||
(e.next=d,a&&(e.require="yes"));return E.compose(b,e)},startBookingUrl:function(a,b){if(!a)return b.company.$url(n.dashboard.bookings.index);var c=a.availability.startAt,e=a.company,f=moment().startOf("day");0>c.diff(f)&&(c=f);a.affiliation&&a.affiliation.affiliateCompany===d.currentUser.company&&(d.storage.set("currentPartnerSelection",a.company.uri),e=a.affiliation.affiliateCompany);if(E.pathStartsWith(n.dashboard.bookings.day.index))f=n.dashboard.bookings.day.date;else if(E.pathStartsWith(n.dashboard.bookings.agenda.index))f=
n.dashboard.bookings.agenda.date;else if(E.pathStartsWith(n.dashboard.bookings.calendar))f=n.calendarUrls(n.dashboard.bookings.calendar).month;else if(E.pathStartsWith(n.dashboard.bookings.grid.index))f=n.dashboard.bookings.grid.date;else if(E.pathStartsWith(n.dashboard.bookings.timeline.index))f=n.dashboard.bookings.timeline.date;else return E.compose(n.populate(n.dashboard.bookings.index,{shortname:e.shortname}),{date:c.format("YYYY-MM-DD")});return n.populate(f,{shortname:e.shortname,year:c.format("YYYY"),
month:c.format("MM"),date:c.format("YYYY-MM-DD")})}},N=!0;b.$on("$locationChangeStart",function(a){b.$evalAsync(function(){b.$broadcast("$locationChangeComplete",!a.defaultPrevented);a.defaultPrevented&&b.$broadcast("$locationChangeCancelled")})});b.$on("$locationChangeSuccess",function(b,d,g){d=d?E.stripPrefix(d):"/";d=v(d);g=g?E.stripPrefix(g):"/";g=v(g);b=f.path();b=v(b||"/");"/"!==b[b.length-1]?E.redirect(E.compose(b+"/",f.search())):(w={},E.url=d,E.path=b,(d!==g||N)&&e(function(){console.info("navigation: navigation complete",
E.url,d);a.notifyWhenNoOutstandingRequests(function(){E.url===d&&c.get("analytics").trackView(d)})}),N=!1)});g.$$navigation=E;g.$$location=f;return E}]);h.run(["$rootScope","navigation",function(b,a){b.navigation=a}])})();angular.module("lightframe",["lightframe.services"]);
(function(){var h=angular.module("lightframe.services",[]);h.factory("lightframe",["$browser","$sniffer","$window","clientOptions","navigation","xmessage",function(b,a,c,f,e,g){b="";var d=!1,l=!1,m=null,k={};a=function(a){try{a=decodeURIComponent(a),k=JSON.parse(a)||{},m=k.parentUrl||null}catch(b){}};/^fareharbor-embed:/.test(c.name)?(a(window.name.substr(17)),b=k.embedId||"",d=k.isLightframed||!1):/^fareharbor-lightframe/.test(c.name)&&(a(window.name.substr(22)),l=!0);var n={embedId:b,isLightframe:function(){return c.top!==
c&&l},isEmbed:function(){return c.top!==c&&n.embedId},isLightframed:function(){return n.isEmbed()&&d},parentUrl:function(){return m},isParentInsecure:function(){return!1},broadcast:function(a,b){b=_.extend({embedId:n.embedId},b);g.broadcast(a,b)},updateHeight:function(a){n.isEmbed()&&a&&n.broadcast("fareharbor.height",{height:a})},open:function(a){a=f.extendUrl(a);n.isEmbed()?n.broadcast("fareharbor.open",{url:a}):c.top.location.href=c.location.protocol+"//"+c.location.hostname+(c.location.port?":"+
c.location.port:"")+a},close:function(){n.broadcast("fareharbor.close")},ready:function(){n.broadcast("fareharbor.ready")},isDirectAccess:function(){return c.top===c},listenForTouch:function(){var a=function(){n.broadcast("fareharbor.touchDetected")};window.addEventListener("touchstart",function r(){a();window.removeEventListener("touchstart",r)},!1);window.addEventListener("pointerdown",function t(b){"touch"==b.pointerType&&(a(),window.removeEventListener("pointerdown",t))},!1)}};return n}]);h.run(["$rootScope",
"lightframe",function(b,a){b.lightframe=a;b.isLightframe=a.isLightframe();a.ready();a.listenForTouch()}])})();angular.module("root",["root.controllers"]);(function(){angular.module("root.controllers",[]).controller("root.IndexCtrl",["$scope",function(h){}])})();angular.module("company",["company.item","company.invoice","company.directives","company.controllers"]);
(function(){var h=angular.module("company.controllers",[]);h.controller("company.IndexCtrl",["$scope","$rootScope","$injector","auth","controllers","db","navigation","tracking","urls",function(b,a,c,f,e,g,d,l,m){d.watch(b,function(){b.showFullNavigation=!d.pathEquals(m.company.storedValueCard.index)&&!d.pathEquals(m.company.order.index)&&!d.pathStartsWith(m.company.item.index)||d.pathEquals(m.company.item.index)||d.pathStartsWith(m.company.item.calendar)});b.company=g.company({shortname:b.route.bindings.shortname});
l.trackEmbed("shortname-page");e.dataController(b,{promises:[b.company.$promise],successCallback:function(){d.updateCurrentCompany(b,b.company)}})}]);h.controller("company.ImagesCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","company.ImagesCtrl");b.images=c.company.images({shortname:b.company.shortname});a.dataController(b,{promises:[b.images.$promise],stale:[b.images]})}]);h.controller("company.ItemsCtrl",["$scope","controllers","db","flows","models","require",
function(b,a,c,f,e,g){g.inScope(b,"company","company.ItemsCtrl");c=f.initialize(b.company.shortname);a.dataController(b,{promises:[c],successCallback:function(){b.singleItem=e.FlowNode.singleItemRedirect(f.initialFlowNode)}})}]);h.controller("company.HeaderCtrl",["$scope","auth","controllers","navigation",function(b,a,c,f){return c.headerController(b,{companyFn:function(){return a.permissions.can("viewDashboardSection",f.currentCompany)?f.currentCompany:a.currentUser.company}})}]);h.controller("company.AboutCtrl",
["$scope","require",function(b,a){a.inScope(b,"company")}]);h.controller("company.TosCtrl",["$scope","require",function(b,a){a.inScope(b,"company")}]);h.controller("company.FAQCtrl",["$scope","require",function(b,a){a.inScope(b,"company")}]);h.controller("company.StoredValueCardCtrl",["$scope","controllers","db","navigation","require",function(b,a,c,f,e){e.inScope(b,"company","company.StoredValueCardCtrl");var g=c.storedValueCards.search({shortname:b.company.shortname},null,null,{q:b.route.bindings.storedValueCardNumber});
a.dataController(b,{promises:[g.$promise],successCallback:function(){b.balanceAccurateAt=moment();b.storedValueCard=g.storedValueCard}})}]);h.controller("company.ViewStoredValueCardCtrl",["$scope","$sniffer","events","navigation","require",function(b,a,c,f,e){e.inScope(b,"storedValueCard","company.ViewStoredValueCardCtrl");var g="yes"===f.get("edit");a.history&&f.clear("edit",!0);a=f.get("message");_.isString(a)||(a="");b.viewStoredValueCardCtrl={note:a,needsEditCapability:function(){return g},wasEmailSentSuccesfully:!1};
c.on(b,"company.StoredValueCardNotificationCtrl.sent",function(){b.viewStoredValueCardCtrl.wasEmailSentSuccesfully=!0})}]);h.controller("company.StoredValueCardNotificationCtrl",["$filter","$scope","controllers","db","events","models","navigation","require","toggles",function(b,a,c,f,e,g,d,l,m){l.inScope(a,"company","company.StoredValueCardNotificationCtrl");l.inScope(a,"storedValueCard","company.StoredValueCardNotificationCtrl");a.isSubjectEditable=!0;b="";a.viewStoredValueCardCtrl&&(b=a.viewStoredValueCardCtrl.note||
"",a.$watch("notification.note",function(b){a.viewStoredValueCardCtrl.note=b}));d=a.storedValueCard.fromName?interpolate(T("%(personName)s sent you a gift for %(companyName)s"),{personName:a.storedValueCard.fromName,companyName:a.company.name}):interpolate(T("Your gift for %(companyName)s"),{companyName:a.company.name});c.createController(a,{modelKey:"notification",create:f.storedValueCard.notifications.create,params:function(){return{shortname:a.company.shortname,storedValueCardNumber:a.storedValueCard.number}},
successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");e.broadcast("company.StoredValueCardNotificationCtrl.sent");m.toggle("sendCard",!1)},defaultModel:{emails:a.storedValueCard.contact?a.storedValueCard.contact.email||"":"",subject:d,type:g.Notification.STORED_VALUE_CARD_TYPE,note:b}})}]);h.controller("company.OrderCtrl",["$scope","$q","controllers","db","localization","models","navigation","require",function(b,a,c,f,e,g,d,l){l.inScope(b,"company","company.OrderCtrl");
b.order=f.order({shortname:b.company.shortname,orderUuid:b.route.bindings.orderUuid});c.dataController(b,{promises:[b.order.$promise],successCallback:function(){b.contact=b.order.contact;var c=_.unique(_.pluck(b.order.contributingBookings,"availability.item")),c=_.map(c,function(a){return f.item({shortname:a.company.shortname,itemPk:a.pk}).$promise});return a.all(c).catch(_.ignore)}})}]);h.controller("company.ViewOrderCtrl",["$scope","$sniffer","db","events","navigation","require",function(b,a,c,
f,e,g){g.inScope(b,"order","company.ViewOrderCtrl");b.order.company.features.isTaxTypeBreakdownEnabled&&(b.taxTypes=c.taxTypes.all({shortname:b.order.company.shortname}))}]);h.controller("company.FlowPageCtrl",["$scope","controllers","db","flows","require","models","navigation","urls",function(b,a,c,f,e,g,d,l){e.inScope(b,"company","company.FlowPageCtrl");g=f.currentFlowNodePk();d.pathStartsWith(l.dashboard.settings.flows.flowNode.index)?e.inScope(b,"flowNode","company.FlowPageCtrl"):f.isOnInitialFlowNode()?
b.flowNode=f.initialFlowNode:b.flowNode=c.flowNode({shortname:b.company.shortname,flowNodePk:g},null,null,null,{tagAlong:!0});a.dataController(b,{promises:[b.flowNode.$promise]})}]);h.controller("company.FlowPageCalendarCtrl",["$scope","flows","require","urls",function(b,a,c,f){c.inScope(b,"flowNode");return a.calendarController(b,b.flowNode,{url:b.company.$url(f.company.items.calendar)})}]);h.controller("company.shared.ItemMediumCtrl",["$scope","navigation","require",function(b,a,c){c.notNull(a,
"currentCompany","company.shared.ItemMediumCtrl");c.inScope(b,"item","company.shared.ItemMediumCtrl")}]);h.controller("company.shared.AvailabilitySmallCtrl",["$scope","require",function(b,a){a.inScope(b,"availability");return b}]);h.controller("company.shared.CompanyCalendarCtrl",["$scope","availabilityCalendarController","clientOptions","db","require","urls",function(b,a,c,f,e,g){e.inScope(b,"company");return a(b,{url:b.company.$url(g.company.items.calendar),company:b.company,endpoint:f.company.calendar,
params:{shortname:b.company.shortname},queryParams:{allowGrouped:"yes",bookableOnly:c.isBookableOnly?"yes":"no"}})}]);h.controller("company.shared.ItemCalendarCtrl",["$scope","availabilityCalendarController","clientOptions","db","require","urls",function(b,a,c,f,e,g){e.inScope(b,"item");a(b,{url:b.item.$url(g.company.item.calendar),company:b.item.company,endpoint:f.item.calendar,params:{shortname:b.item.company.shortname,itemPk:b.item.pk},queryParams:{allowGrouped:"yes",bookableOnly:c.isBookableOnly?
"yes":"no"}})}])})();
(function(){angular.module("company.directives",[]).directive("ngTranslationToggle",function(){return{restrict:"A",templateUrl:"ng-translation-toggle",controllerAs:"translationToggleCtrl",controller:["$browser","$scope","$timeout","db","models","navigation","require","toggles","translate",function(h,b,a,c,f,e,g,d,l){var m=this;g.inScope(b,"company","ngTranslationToggle");b.translate=l;m.FLYOUT_TOGGLE_KEY="translateFlyout";m.STATE_LOADING="loading";m.STATE_COMPANY="company";m.STATE_GOOGLE="google";
m.previewLanguage=c.slipstream("previewLanguage");m.activeLanguage=c.slipstream("targetLanguage");m.state=m.STATE_LOADING;m.setState=function(a){m.state=a};m.display=function(a){return f.SupportedLanguage.displayLocal(a)};m.urlForLanguageCode=function(a){return e.extendQuery(e.url,{language:a})};m.loadingIndicatorForLanguage=function(b){m.newTargetLanguage=b;a(function(){m.newTargetLanguage=!1},5E3)};m.isActiveLanguageInList=function(){return _.contains(m.fullLanguages,m.activeLanguage)||_.contains(m.partialLanguages,
m.activeLanguage)};b.$watch(function(){return d.state(m.FLYOUT_TOGGLE_KEY)},function(a){a&&(m.newTargetLanguage=!1,m.understoodLanguages||(m.understoodLanguages=c.understoodLanguages({shortname:b.company.shortname}),m.understoodLanguages.$promise.then(function(){m.showCompanyLanguages=1<m.understoodLanguages.full.length+m.understoodLanguages.partial.length;m.state=m.showCompanyLanguages?m.STATE_COMPANY:m.STATE_GOOGLE;m.fullLanguages=m.understoodLanguages.full;m.partialLanguages=m.understoodLanguages.partial;
m.isActiveLanguageInList()||(m.activeLanguage=c.slipstream("contentLanguage"),!m.isActiveLanguageInList()&&!m.previewLanguage&&m.fullLanguages.unshift(m.activeLanguage))})))})}]}})})();angular.module("company.item",["company.item.controllers"]);
(function(){var h=angular.module("company.item.controllers",[]);h.controller("company.item.IndexCtrl",["$scope","controllers","db","require","urls",function(b,a,c,f,e){f.inScope(b,"company","company.item.IndexCtrl");f=b.route.bindings.itemPk;b.item=c.item({shortname:b.company.shortname,itemPk:f});b.images=c.item.images({shortname:b.company.shortname,itemPk:f});var g;b.isRetailAvailable=!1;return a.dataController(b,{promises:[b.item.$promise,b.images.$promise],stale:[b.item,b.images],successCallback:function(){b.item.isRetail&&
!g&&(g=c.availabilities.next({shortname:b.item.company.shortname,itemPk:b.item.pk}),g.$promise.then(function(){b.isRetailAvailable=!0;b.buyNowUrl=e.populate(e.company.item.book,{shortname:b.item.company.shortname,itemPk:b.item.pk,availabilityPk:g.pk})}))}})}]);h.controller("company.item.DateCtrl",["$scope","clientOptions","controllers","db","require","urls",function(b,a,c,f,e,g){e.inScope(b,"company","company.item.DateCtrl");e.inScope(b,"item","company.item.DateCtrl");b.date=moment(b.route.bindings.date,
"YYYY-MM-DD");b.availabilities=f.availabilities.byDate({shortname:b.company.shortname,itemPk:b.item.pk,date:b.date.format("YYYY-MM-DD")},null,null,{bookableOnly:a.isBookableOnly?"yes":"no"});b.nextDate=b.date.clone().add(1,"days");b.nextUrl=g.populate(g.company.item.date,{shortname:b.company.shortname,itemPk:b.item.pk,date:b.nextDate.format("YYYY-MM-DD")});b.nextAvailabilities=f.availabilities.byDate({shortname:b.company.shortname,itemPk:b.item.pk,date:b.nextDate.format("YYYY-MM-DD")},null,null,{bookableOnly:a.isBookableOnly?
"yes":"no"});b.previousDate=b.date.clone().subtract(1,"days");b.previousUrl=g.populate(g.company.item.date,{shortname:b.company.shortname,itemPk:b.item.pk,date:b.previousDate.format("YYYY-MM-DD")});b.previousAvailabilities=f.availabilities.byDate({shortname:b.company.shortname,itemPk:b.item.pk,date:b.previousDate.format("YYYY-MM-DD")},null,null,{bookableOnly:a.isBookableOnly?"yes":"no"});b.forwardDate=b.date.clone().add(3,"days");b.forwardUrl=g.populate(g.company.item.date,{shortname:b.company.shortname,
itemPk:b.item.pk,date:b.forwardDate.format("YYYY-MM-DD")});b.backwardDate=b.date.clone().subtract(3,"days");b.backwardUrl=g.populate(g.company.item.date,{shortname:b.company.shortname,itemPk:b.item.pk,date:b.backwardDate.format("YYYY-MM-DD")});return c.dataController(b,{promises:[b.availabilities.$promise,b.nextAvailabilities.$promise,b.previousAvailabilities.$promise]})}]);h.controller("company.item.ShareConfirmationCtrl",["$scope","controllers","db","models","require","toggles",function(b,a,c,f,
e,g){e.inScope(b,"company","company.item.ShareConfirmationCtrl");e.assert(b.booking||b.order,"company.item.ShareConfirmationCtrl");var d,l;e={modelKey:"data"};b.booking?(e.target=b.booking,d=c.booking.notification,c=b.booking.contact.language,f=f.Notification.BOOKING_SHARE_TYPE,l={shortname:b.booking.company.shortname,bookingUuid:b.booking.uuid}):(e.target=b.order,d=c.order.notification,c=b.order.contact.language,f=f.Notification.ORDER_SHARE_TYPE,l={shortname:b.order.company.shortname,orderUuid:b.order.uuid});
b.sentConfirmation=!1;b.data={emails:"",note:"",type:f,subject:"",language:c};a.emailSubjectsController(b,e);b.sendConfirmation=function(a){a.$submitting=!0;d(l,b.data,a).$promise.then(function(){a.$submitting=!1;b.sentConfirmation=!0},function(){a.$submitting=!1})};b.resetSendConfirmation=function(){b.sentConfirmation=!1;delete b.data.emails;delete b.data.note;g.toggle("sendEmailForm",!1)}}]);h.controller("company.item.CancelBookingCtrl",["$scope","$filter","auth","controllers","db","events","flash",
"models","moment","navigation","require","urls",function(b,a,c,f,e,g,d,l,m,k,n,h){n.inScope(b,"booking","company.item.CancelBookingCtrl");b.submitting=!1;b.cancelBookingData={isCancelEligible:!0,isOnline:!0};b.submit=function(a){b.submitting=!0;var c=e.booking.cancel({bookingUuid:b.booking.uuid,shortname:b.booking.company.shortname},b.cancelBookingData,a);c.$promise.then(function(){b.submitting=!1;k.navigate(c.$url(h.company.item.booking))},function(){b.submitting=!1})};var p=null;a=[];b.booking.company.features.isCancellationPoliciesEnabled&&
(p=e.booking.effectiveCancellationRule({bookingUuid:b.booking.uuid,shortname:b.booking.company.shortname}),p.$promise.then(function(a){b.maximumCancellationCutoffAt=a.data&&a.data.maximumCancellationCutoffAt}),a.push(p.$promise));b.booking.effectiveCancellationRule=null;f.dataController(b,{promises:a,successCallback:function(){b.booking.effectiveCancellationRule=p;b.payments=_.filter(b.booking.payments,"isRefundable");b.cancelBookingData.refundGross=0;b.refundAmount=0;p&&p.isCancellationAllowed&&
(b.cancelBookingData.refundGross=_.sum(b.payments,function(a){return _.roundHalfToEven(a.receipt.gross*(a.isCollectedByAffiliate?p.affiliateRefundPercentage:p.charterRefundPercentage))}),b.refundAmount=_.sum(b.payments,function(a){var b=a.isCollectedByAffiliate?p.affiliateRefundPercentage:p.charterRefundPercentage;return _.roundHalfToEven(1===b?a.receipt.total:a.receipt.gross*b)}))}})}]);h.controller("company.item.BookingCtrl",["$scope","auth","controllers","db","localization","models","require",
function(b,a,c,f,e,g,d){d.inScope(b,"company","company.item.BookingCtrl");d.inScope(b,"item","company.item.BookingCtrl");a=b.route.bindings.bookingUuid;b.selectedCustomFields=[];var l=function(){var a={},c=function(b){var c=b.customFieldInstance.customField;c.type!==g.CustomField.CODE_GENERATOR_TYPE&&b.isSelected&&c.bookingNotes&&(a[c.uri]=c)};_.forEach(b.booking.customFieldValues,c);_.forEach(b.booking.customers,function(a){_.forEach(a.customFieldValues,c)});b.selectedCustomFields=_.sortBy(_.values(a),
function(a){return a.name})};b.booking=f.booking({shortname:b.company.shortname,bookingUuid:a});return c.dataController(b,{promises:[b.booking.$promise],successCallback:function(){l();b.company.features.isTaxTypeBreakdownEnabled&&(b.taxTypes=f.taxTypes.all({shortname:b.company.shortname}))}})}]);h.controller("company.item.AvailabilityCtrl",["$scope","controllers","db","flash","navigation","require","urls",function(b,a,c,f,e,g,d){g.inScope(b,"company","company.item.AvailabilityCtrl");g.inScope(b,"company",
"company.item.AvailabilityCtrl");b.availability=c.availability({shortname:b.company.shortname,itemPk:b.route.bindings.itemPk,availabilityPk:b.route.bindings.availabilityPk},null,null,null,{tagAlong:!0});a.dataController(b,{promises:[b.availability.$promise],successCallback:function(){b.item=b.availability.item;if(!b.item){var a=T("Activity not found."),c=T("Please choose another activity.");f.error("<b>"+a+"</b> "+c);e.redirect(b.availability.company.$url(d.company.items.index))}}})}]);h.controller("company.item.BookCtrl",
["$scope","auth","cart","controllers","db","models","plusbook","require",function(b,a,c,f,e,g,d,l){l.inScope(b,"company","company.item.BookCtrl");l.defined(b.company,"isDemoModeEnabled","company.item.BookCtrl");l.inScope(b,"availability","company.item.BookCtrl");b.inStorePaymentTypes=[];a.permissions.can("createInStore",g.Payment,b.company)&&a.permissions.canList(g.InStorePaymentType,b.company)&&(b.inStorePaymentTypes=e.inStorePaymentTypes({shortname:b.company.shortname}));b.relatedCardPayments=[];
d.currentContact&&(b.relatedCardPayments=e.contactPayments({shortname:b.company.shortname,contactPk:d.currentContact.pk}));b.partners=[];a.currentUser.isAuthenticated&&(!a.permissions.canList(g.Affiliation,b.company)&&a.permissions.canList(g.Affiliation,a.currentUser.company))&&(b.partners=e.partners.pickable({shortname:a.currentUser.company.shortname}));return f.dataController(b,{promises:[b.partners.$promise,b.inStorePaymentTypes.$promise,b.relatedCardPayments.$promise,c.$promise]})}])})();
angular.module("company.invoice",["company.invoice.controllers"]);
(function(){angular.module("company.invoice.controllers",[]).controller("company.invoice.UuidInvoiceCtrl",["$scope","auth","controllers","db","navigation","require","urls",function(h,b,a,c,f,e,g){e.inScope(h,"company","company.invoice.UuidInvoiceCtrl");c=c.invoice.uuid;h.invoice=c({shortname:h.company.shortname,invoiceUuid:h.route.bindings.invoiceUuid});a.dataController(h,{promises:[h.invoice.$promise],successCallback:function(){b.permissions.can("viewDashboardSection",h.invoice.company)?f.redirect(h.invoice.$url(g.dashboard.reports.invoices.invoice.index)):
h.invoice.affiliation&&b.permissions.can("viewDashboardSection",h.invoice.affiliation.affiliateCompany)&&f.redirect(h.invoice.$url(g.dashboard.reports.invoices.partnerInvoice.index))}})}])})();
(function(h){h.Jcrop=function(b,a){function c(a){return Math.round(a)+"px"}function f(a){a=h(a).offset();return[a.left,a.top]}function e(a){return[a.pageX-w[0],a.pageY-w[1]]}function g(a){"object"!==typeof a&&(a={});x=h.extend(x,a);h.each(["onChange","onSelect","onRelease","onDblClick"],function(a,b){"function"!==typeof x[b]&&(x[b]=function(){})})}function d(a,b,c){w=f(N);Ba.setCursor("move"===a?a:a+"-resize");if("move"===a)return Ba.activateHandlers(m(b),r,c);b=da.getFixed();var d=k(a),e=da.getCorner(k(d));
da.setPressed(da.getCorner(d));da.setCurrent(e);Ba.activateHandlers(l(a,b),r,c)}function l(a,b){return function(c){if(x.aspectRatio)switch(a){case "e":c[1]=b.y+1;break;case "w":c[1]=b.y+1;break;case "n":c[0]=b.x+1;break;case "s":c[0]=b.x+1}else switch(a){case "e":c[1]=b.y2;break;case "w":c[1]=b.y2;break;case "n":c[0]=b.x2;break;case "s":c[0]=b.x2}da.setCurrent(c);W.update()}}function m(a){var b=a;Za.watchKeys();return function(a){da.moveOffset([a[0]-b[0],a[1]-b[1]]);b=a;W.update()}}function k(a){switch(a){case "n":return"sw";
case "s":return"nw";case "e":return"nw";case "w":return"ne";case "ne":return"sw";case "nw":return"se";case "se":return"nw";case "sw":return"ne"}}function n(a){return function(b){if(x.disabled||"move"===a&&!x.allowMove)return!1;w=f(N);Q=!0;d(a,e(b));b.stopPropagation();b.preventDefault();return!1}}function s(a,b,c){var d=a.width(),e=a.height();d>b&&0<b&&(d=b,e=b/a.width()*a.height());e>c&&0<c&&(e=c,d=c/a.height()*a.width());U=a.width()/d;aa=a.height()/e;a.width(d).height(e)}function p(a){return{x:a.x*
U,y:a.y*aa,x2:a.x2*U,y2:a.y2*aa,w:a.w*U,h:a.h*aa}}function r(a){a=da.getFixed();a.w>x.minSelect[0]&&a.h>x.minSelect[1]?(W.enableHandles(),W.done()):W.release();Ba.setCursor(x.allowSelect?"crosshair":"default")}function t(a){if(x.disabled||!x.allowSelect)return!1;Q=!0;w=f(N);W.disableHandles();Ba.setCursor("crosshair");var b=e(a);da.setPressed(b);W.update();Ba.activateHandlers(v,r,"touch"===a.type.substring(0,5));Za.watchKeys();a.stopPropagation();a.preventDefault();return!1}function v(a){da.setCurrent(a);
W.update()}function y(){var a=h("<div></div>").addClass(x.baseClass+"-tracker");M&&a.css({opacity:0,backgroundColor:"white"});return a}function q(a){B([a[0]/U,a[1]/aa,a[2]/U,a[3]/aa]);x.onSelect.call(ta,p(da.getFixed()));W.enableHandles()}function B(a){da.setPressed([a[0],a[1]]);da.setCurrent([a[2],a[3]]);W.update()}function u(){x.disabled=!0;W.disableHandles();W.setCursor("default");Ba.setCursor("default")}function z(){x.disabled=!1;F()}function C(a,b,c){b=b||x.bgColor;x.bgFade&&h.fx.step.hasOwnProperty("backgroundColor")&&
x.fadeTime&&!c?a.animate({backgroundColor:b},{queue:!1,duration:x.fadeTime}):a.css("backgroundColor",b)}function F(a){x.allowResize?a?W.enableOnly():W.enableHandles():W.disableHandles();Ba.setCursor(x.allowSelect?"crosshair":"default");W.setCursor(x.allowMove?"move":"default");x.hasOwnProperty("trueSize")&&(U=x.trueSize[0]/I,aa=x.trueSize[1]/D);x.hasOwnProperty("setSelect")&&(q(x.setSelect),W.done(),delete x.setSelect);sa.refresh();x.bgColor!=ba&&(C(x.shade?sa.getShades():Z,x.shade?x.shadeColor||
x.bgColor:x.bgColor),ba=x.bgColor);S!=x.bgOpacity&&(S=x.bgOpacity,x.shade?sa.refresh():W.setBgOpacity(S));ca=x.maxSize[0]||0;la=x.maxSize[1]||0;na=x.minSize[0]||0;ka=x.minSize[1]||0;x.hasOwnProperty("outerImage")&&(N.attr("src",x.outerImage),delete x.outerImage);W.refresh()}var x=h.extend({},h.Jcrop.defaults),w,G=navigator.userAgent.toLowerCase(),M=/msie/.test(G),K=/msie [1-6]\./.test(G);"object"!==typeof b&&(b=h(b)[0]);"object"!==typeof a&&(a={});g(a);var G={border:"none",visibility:"visible",margin:0,
padding:0,position:"absolute",top:0,left:0},H=h(b),L=!0;if("IMG"==b.tagName){if(0!=H[0].width&&0!=H[0].height)H.width(H[0].width),H.height(H[0].height);else{var E=new Image;E.src=H[0].src;H.width(E.width);H.height(E.height)}var N=H.clone().removeAttr("id").css(G).show();N.width(H.width());N.height(H.height());H.after(N).hide()}else N=H.css(G).show(),L=!1,null===x.shade&&(x.shade=!0);s(N,x.boxWidth,x.boxHeight);var I=N.width(),D=N.height(),Z=h("<div />").width(I).height(D).addClass(x.baseClass+"-holder").css({position:"relative",
backgroundColor:x.bgColor}).insertAfter(H).append(N);x.addClass&&Z.addClass(x.addClass);var ia=h("<div />"),J=h("<div />").width("100%").height("100%").css({zIndex:310,position:"absolute",overflow:"hidden"}),ea=h("<div />").width("100%").height("100%").css("zIndex",320),P=h("<div />").css({position:"absolute",zIndex:600}).dblclick(function(){var a=da.getFixed();x.onDblClick.call(ta,a)}).insertBefore(N).append(J,ea);L&&(ia=h("<img />").attr("src",N.attr("src")).css(G).width(I).height(D),J.append(ia));
K&&P.css({overflowY:"hidden"});var wa=x.boundary,ja=y().width(I+2*wa).height(D+2*wa).css({position:"absolute",top:c(-wa),left:c(-wa),zIndex:290}).mousedown(t),ba=x.bgColor,S=x.bgOpacity,ca,la,na,ka,U,aa,Q,Ga,xa;w=f(N);var ma=function(){function a(){var b={},c=["touchstart","touchmove","touchend"],d=document.createElement("div"),e;try{for(e=0;e<c.length;e++){var f=c[e],f="on"+f,g=f in d;g||(d.setAttribute(f,"return;"),g="function"==typeof d[f]);b[c[e]]=g}return b.touchstart&&b.touchend&&b.touchmove}catch(k){return!1}}
var b;b=!0===x.touchSupport||!1===x.touchSupport?x.touchSupport:a();return{createDragger:function(a){return function(b){if(x.disabled||"move"===a&&!x.allowMove)return!1;w=f(N);Q=!0;d(a,e(ma.cfilter(b)),!0);b.stopPropagation();b.preventDefault();return!1}},newSelection:function(a){return t(ma.cfilter(a))},cfilter:function(a){a.pageX=a.originalEvent.changedTouches[0].pageX;a.pageY=a.originalEvent.changedTouches[0].pageY;return a},isSupported:a,support:b}}(),da=function(){function a(){if(!x.aspectRatio){var b=
g-e,l=k-f;ca&&Math.abs(b)>ca&&(g=0<b?e+ca:e-ca);la&&Math.abs(l)>la&&(k=0<l?f+la:f-la);ka/aa&&Math.abs(l)<ka/aa&&(k=0<l?f+ka/aa:f-ka/aa);na/U&&Math.abs(b)<na/U&&(g=0<b?e+na/U:e-na/U);0>e&&(g-=e,e-=e);0>f&&(k-=f,f-=f);0>g&&(e-=g,g-=g);0>k&&(f-=k,k-=k);g>I&&(b=g-I,e-=b,g-=b);k>D&&(b=k-D,f-=b,k-=b);e>I&&(b=e-D,k-=b,f-=b);f>D&&(b=f-D,k-=b,f-=b);return d(c(e,f,g,k))}var b=x.aspectRatio,l=x.minSize[0]/U,m=x.maxSize[0]/U,n=g-e,h=k-f,p=Math.abs(n),s=Math.abs(h);0===m&&(m=10*I);p/s<b?(p=k,s*=b,s=0>n?e-s:s+
e,0>s?(s=0,p=Math.abs((s-e)/b),p=0>h?f-p:p+f):s>I&&(s=I,p=Math.abs((s-e)/b),p=0>h?f-p:p+f)):(s=g,p/=b,p=0>h?f-p:f+p,0>p?(p=0,s=Math.abs((p-f)*b),s=0>n?e-s:s+e):p>D&&(p=D,s=Math.abs(p-f)*b,s=0>n?e-s:s+e));s>e?(s-e<l?s=e+l:s-e>m&&(s=e+m),p=p>f?f+(s-e)/b:f-(s-e)/b):s<e&&(e-s<l?s=e-l:e-s>m&&(s=e-m),p=p>f?f+(e-s)/b:f-(e-s)/b);0>s?(e-=s,s=0):s>I&&(e-=s-I,s=I);0>p?(f-=p,p=0):p>D&&(f-=p-D,p=D);return d(c(e,f,s,p))}function b(a){0>a[0]&&(a[0]=0);0>a[1]&&(a[1]=0);a[0]>I&&(a[0]=I);a[1]>D&&(a[1]=D);return[Math.round(a[0]),
Math.round(a[1])]}function c(a,b,d,e){var f=a,g=d,k=b,l=e;d<a&&(f=d,g=a);e<b&&(k=e,l=b);return[f,k,g,l]}function d(a){return{x:a[0],y:a[1],x2:a[2],y2:a[3],w:a[2]-a[0],h:a[3]-a[1]}}var e=0,f=0,g=0,k=0,l,m;return{flipCoords:c,setPressed:function(a){a=b(a);g=e=a[0];k=f=a[1]},setCurrent:function(a){a=b(a);l=a[0]-g;m=a[1]-k;g=a[0];k=a[1]},getOffset:function(){return[l,m]},moveOffset:function(a){var b=a[0];a=a[1];0>e+b&&(b-=b+e);0>f+a&&(a-=a+f);D<k+a&&(a+=D-(k+a));I<g+b&&(b+=I-(g+b));e+=b;g+=b;f+=a;k+=
a},getCorner:function(b){var c=a();switch(b){case "ne":return[c.x2,c.y];case "nw":return[c.x,c.y];case "se":return[c.x2,c.y2];case "sw":return[c.x,c.y2]}},getFixed:a}}(),sa=function(){function a(){return b(da.getFixed())}function b(a){p.top.css({left:c(a.x),width:c(a.w),height:c(a.y)});p.bottom.css({top:c(a.y2),left:c(a.x),width:c(a.w),height:c(D-a.y2)});p.right.css({left:c(a.x2),width:c(I-a.x2)});p.left.css({width:c(a.x)})}function d(){return h("<div />").css({position:"absolute",backgroundColor:x.shadeColor||
x.bgColor}).appendTo(n)}function e(){m||(m=!0,n.insertBefore(N),a(),W.setBgOpacity(1,0,1),ia.hide(),f(x.shadeColor||x.bgColor,1),W.isAwake()?k(x.bgOpacity,1):k(1,1))}function f(a,b){C(l(),a,b)}function g(){m&&(n.remove(),ia.show(),m=!1,W.isAwake()?W.setBgOpacity(x.bgOpacity,1,1):(W.setBgOpacity(1,1,1),W.disableHandles()),C(Z,0,1))}function k(a,b){m&&(x.bgFade&&!b?n.animate({opacity:1-a},{queue:!1,duration:x.fadeTime}):n.css({opacity:1-a}))}function l(){return n.children()}var m=!1,n=h("<div />").css({position:"absolute",
zIndex:240,opacity:0}),p={top:d(),left:d().height(D),right:d().height(D),bottom:d()};return{update:a,updateRaw:b,getShades:l,setBgColor:f,enable:e,disable:g,resize:function(a,b){p.left.css({height:c(b)});p.right.css({height:c(b)})},refresh:function(){x.shade?e():g();W.isAwake()&&k(x.bgOpacity)},opacity:k}}(),W=function(){function a(b,c){var d=h("<div />").mousedown(n(b)).css({cursor:b+"-resize",position:"absolute",zIndex:c}).addClass("ord-"+b);ma.support&&d.bind("touchstart.jcrop",ma.createDragger(b));
ea.append(d);return d}function b(c){var d;for(d=0;d<c.length;d++)a(c[d],r++).addClass("jcrop-dragbar")}function d(a){var b,c;for(c=0;c<a.length;c++){switch(a[c]){case "n":b="hline";break;case "s":b="hline bottom";break;case "e":b="vline right";break;case "w":b="vline"}var e=v,f=a[c],g=b,g=h("<div />").css({position:"absolute",opacity:x.borderOpacity}).addClass(x.baseClass+"-"+g);J.append(g);e[f]=g}}function e(b){var c;for(c=0;c<b.length;c++){var d=u,f=b[c],g=x.handleSize,k=a(b[c],r++).css({opacity:x.handleOpacity}).addClass(x.baseClass+
"-handle");g&&k.width(g).height(g);d[f]=k}}function f(){var a=da.getFixed();da.setPressed([a.x,a.y]);da.setCurrent([a.x2,a.y2]);g()}function g(a){if(t)return k(a)}function k(a){var b=da.getFixed(),d=b.h;P.width(Math.round(b.w)).height(Math.round(d));var d=b.x,e=b.y;x.shade||ia.css({top:c(-e),left:c(-d)});P.css({top:c(e),left:c(d)});x.shade&&sa.updateRaw(b);t||(P.show(),x.shade?sa.opacity(S):l(S,!0),t=!0);a?x.onSelect.call(ta,p(b)):x.onChange.call(ta,p(b))}function l(a,b,c){if(t||b)x.bgFade&&!c?N.animate({opacity:a},
{queue:!1,duration:x.fadeTime}):N.css("opacity",a)}function m(){z=!0;if(x.allowResize)return ea.show(),!0}function s(){z=!1;ea.hide()}function q(a){a?(Ga=!0,s()):(Ga=!1,m())}var t,r=370,v={},u={},z=!1;x.dragEdges&&h.isArray(x.createDragbars)&&b(x.createDragbars);h.isArray(x.createHandles)&&e(x.createHandles);x.drawBorders&&h.isArray(x.createBorders)&&d(x.createBorders);h(document).bind("touchstart.jcrop-ios",function(a){h(a.currentTarget).hasClass("jcrop-tracker")&&a.stopPropagation()});var B=y().mousedown(n("move")).css({cursor:"move",
position:"absolute",zIndex:360});ma.support&&B.bind("touchstart.jcrop",ma.createDragger("move"));J.append(B);s();return{updateVisible:g,update:k,release:function(){s();P.hide();x.shade?sa.opacity(1):l(1);t=!1;x.onRelease.call(ta)},refresh:f,isAwake:function(){return t},setCursor:function(a){B.css("cursor",a)},enableHandles:m,enableOnly:function(){z=!0},showHandles:function(){z&&ea.show()},disableHandles:s,animMode:q,setBgOpacity:l,done:function(){q(!1);f()}}}(),Ba=function(){function a(b){f(e(b));
return!1}function b(a){a.preventDefault();a.stopPropagation();Q&&(Q=!1,g(e(a)),W.isAwake()&&x.onSelect.call(ta,p(da.getFixed())),ja.css({zIndex:290}),h(document).unbind(".jcrop"),f=function(){},g=function(){});return!1}function c(a){f(e(ma.cfilter(a)));return!1}function d(a){return b(ma.cfilter(a))}var f=function(){},g=function(){},k=x.trackDocument;k||ja.mousemove(a).mouseup(b).mouseout(b);N.before(ja);return{activateHandlers:function(e,l,m){Q=!0;f=e;g=l;ja.css({zIndex:450});m?h(document).bind("touchmove.jcrop",
c).bind("touchend.jcrop",d):k&&h(document).bind("mousemove.jcrop",a).bind("mouseup.jcrop",b);return!1},setCursor:function(a){ja.css("cursor",a)}}}(),Za=function(){function a(b){d.hide()}function b(a,c,d){x.allowMove&&(da.moveOffset([c,d]),W.updateVisible(!0));a.preventDefault();a.stopPropagation()}function c(a){if(a.ctrlKey||a.metaKey)return!0;var d=(xa=a.shiftKey?!0:!1)?10:1;switch(a.keyCode){case 37:b(a,-d,0);break;case 39:b(a,d,0);break;case 38:b(a,0,-d);break;case 40:b(a,0,d);break;case 27:x.allowSelect&&
W.release();break;case 9:return!0}return!1}var d=h('<input type="radio" />').css({position:"fixed",left:"-120px",width:"12px"}).addClass("jcrop-keymgr"),e=h("<div />").css({position:"absolute",overflow:"hidden"}).append(d);x.keySupport&&(d.keydown(c).blur(a),K||!x.fixedSupport?(d.css({position:"absolute",left:"-20px"}),e.append(d).insertBefore(N)):d.insertBefore(N));return{watchKeys:function(){x.keySupport&&(d.show(),d.focus())}}}();ma.support&&ja.bind("touchstart.jcrop",ma.newSelection);ea.hide();
F(!0);var ta={setImage:function(a,b){W.release();u();var c=new Image;c.onload=function(){var d=c.height,e=x.boxWidth,f=x.boxHeight;N.width(c.width).height(d);N.attr("src",a);ia.attr("src",a);s(N,e,f);I=N.width();D=N.height();ia.width(I).height(D);ja.width(I+2*wa).height(D+2*wa);Z.width(I).height(D);sa.resize(I,D);z();"function"===typeof b&&b.call(ta)};c.src=a},animateTo:function(a,b){var c=a[0]/U,d=a[1]/aa,e=a[2]/U,f=a[3]/aa;if(!Ga){var g=da.flipCoords(c,d,e,f),k=da.getFixed(),l=[k.x,k.y,k.x2,k.y2],
m=x.animationDelay,n=g[0]-l[0],h=g[1]-l[1],p=g[2]-l[2],s=g[3]-l[3],q=0,t=x.swingSpeed,c=l[0],d=l[1],e=l[2],f=l[3];W.animMode(!0);var r=function(){return function(){q+=(100-q)/t;l[0]=Math.round(c+q/100*n);l[1]=Math.round(d+q/100*h);l[2]=Math.round(e+q/100*p);l[3]=Math.round(f+q/100*s);99.8<=q&&(q=100);100>q?(B(l),window.setTimeout(r,m)):(W.done(),W.animMode(!1),"function"===typeof b&&b.call(ta))}}();window.setTimeout(r,m)}},setSelect:q,setOptions:function(a){g(a);F()},tellSelect:function(){return p(da.getFixed())},
tellScaled:function(){return da.getFixed()},setClass:function(a){Z.removeClass().addClass(x.baseClass+"-holder").addClass(a)},disable:u,enable:z,cancel:function(){W.done();Ba.activateHandlers(null,null)},release:W.release,destroy:function(){Z.remove();H.show();H.css("visibility","visible");h(b).removeData("Jcrop")},focus:Za.watchKeys,getBounds:function(){return[I*U,D*aa]},getWidgetSize:function(){return[I,D]},getScaleFactor:function(){return[U,aa]},getOptions:function(){return x},ui:{holder:Z,selection:P}};
M&&Z.bind("selectstart",function(){return!1});H.data("Jcrop",ta);return ta};h.fn.Jcrop=function(b,a){var c;this.each(function(){if(h(this).data("Jcrop")){if("api"===b)return h(this).data("Jcrop");h(this).data("Jcrop").setOptions(b)}else"IMG"==this.tagName?h.Jcrop.Loader(this,function(){h(this).css({display:"block",visibility:"hidden"});c=h.Jcrop(this,b);h.isFunction(a)&&a.call(c)}):(h(this).css({display:"block",visibility:"hidden"}),c=h.Jcrop(this,b),h.isFunction(a)&&a.call(c))});return this};h.Jcrop.Loader=
function(b,a,c){function f(){g.complete?(e.unbind(".jcloader"),h.isFunction(a)&&a.call(g)):window.setTimeout(f,50)}var e=h(b),g=e[0];e.bind("load.jcloader",f).bind("error.jcloader",function(a){e.unbind(".jcloader");h.isFunction(c)&&c.call(g)});g.complete&&h.isFunction(a)&&(e.unbind(".jcloader"),a.call(g))};h.Jcrop.defaults={allowSelect:!0,allowMove:!0,allowResize:!0,trackDocument:!0,baseClass:"jcrop",addClass:null,bgColor:"black",bgOpacity:0.6,bgFade:!1,borderOpacity:0.4,handleOpacity:0.5,handleSize:null,
aspectRatio:0,keySupport:!0,createHandles:"n s e w nw ne se sw".split(" "),createDragbars:["n","s","e","w"],createBorders:["n","s","e","w"],drawBorders:!0,dragEdges:!0,fixedSupport:!0,touchSupport:null,shade:null,boxWidth:0,boxHeight:0,boundary:2,fadeTime:400,animationDelay:20,swingSpeed:3,minSelect:[0,0],maxSize:[0,0],minSize:[0,0],onChange:function(){},onSelect:function(){},onDblClick:function(){},onRelease:function(){}}})(jQuery);
var JsDiff=function(){function h(a){for(var b=[],c=0;c<a.length;c++)a[c]&&b.push(a[c]);return b}function b(a){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");return a=a.replace(/"/g,"&quot;")}var a=function(a){this.ignoreWhitespace=a};a.prototype={diff:function(a,b){if(b===a)return[{value:b}];if(!b)return[{value:a,removed:!0}];if(!a)return[{value:b,added:!0}];b=this.tokenize(b);a=this.tokenize(a);var c=b.length,d=a.length,e=c+d,f=[{newPos:-1,components:[]}],g=this.extractCommon(f[0],
b,a,0);if(f[0].newPos+1>=c&&g+1>=d)return f[0].components;for(var h=1;h<=e;h++)for(var v=-1*h;v<=h;v+=2){var y;y=f[v-1];var q=f[v+1],g=(q?q.newPos:0)-v;y&&(f[v-1]=void 0);var B=y&&y.newPos+1<c,u=q&&0<=g&&g<d;if(!B&&!u)f[v]=void 0;else{!B||u&&y.newPos<q.newPos?(y={newPos:q.newPos,components:q.components.slice(0)},this.pushComponent(y.components,a[g],void 0,!0)):(y={newPos:y.newPos,components:y.components.slice(0)},y.newPos++,this.pushComponent(y.components,b[y.newPos],!0,void 0));g=this.extractCommon(y,
b,a,v);if(y.newPos+1>=c&&g+1>=d)return y.components;f[v]=y}}},pushComponent:function(a,b,c,d){var e=a[a.length-1];e&&e.added===c&&e.removed===d?a[a.length-1]={value:this.join(e.value,b),added:c,removed:d}:a.push({value:b,added:c,removed:d})},extractCommon:function(a,b,c,d){var e=b.length,f=c.length,g=a.newPos;for(d=g-d;g+1<e&&d+1<f&&this.equals(b[g+1],c[d+1]);)g++,d++,this.pushComponent(a.components,b[g],void 0,void 0);a.newPos=g;return d},equals:function(a,b){var c=/\S/;return this.ignoreWhitespace&&
!c.test(a)&&!c.test(b)?!0:a===b},join:function(a,b){return a+b},tokenize:function(a){return a}};var c=new a,f=new a(!0),e=new a;f.tokenize=e.tokenize=function(a){return h(a.split(/(\s+|\b)/))};var g=new a(!0);g.tokenize=function(a){return h(a.split(/([{}:;,]|\s+)/))};var d=new a;d.tokenize=function(a){var b=[];a=a.split(/^/m);for(var c=0;c<a.length;c++){var d=a[c],e=a[c-1];"\n"==d&&e&&"\r"===e[e.length-1]?b[b.length-1]+="\n":d&&b.push(d)}return b};return{Diff:a,diffChars:function(a,b){return c.diff(a,
b)},diffWords:function(a,b){return f.diff(a,b)},diffWordsWithSpace:function(a,b){return e.diff(a,b)},diffLines:function(a,b){return d.diff(a,b)},diffCss:function(a,b){return g.diff(a,b)},createPatch:function(a,b,c,e,f){function g(a){return a.map(function(a){return" "+a})}function h(a,b,c){var d=v[v.length-2],e=b===v.length-2;b=b===v.length-3&&(c.added!==d.added||c.removed!==d.removed);!/\n$/.test(c.value)&&(e||b)&&a.push("\\ No newline at end of file")}var t=[];t.push("Index: "+a);t.push("===================================================================");
t.push("--- "+a+("undefined"===typeof e?"":"\t"+e));t.push("+++ "+a+("undefined"===typeof f?"":"\t"+f));var v=d.diff(b,c);v[v.length-1].value||v.pop();v.push({value:"",lines:[]});b=a=0;c=[];f=e=1;for(var y=0;y<v.length;y++){var q=v[y],B=q.lines||q.value.replace(/\n$/,"").split("\n");q.lines=B;if(q.added||q.removed){if(!a){var u=v[y-1];a=e;b=f;u&&(c=g(u.lines.slice(-4)),a-=c.length,b-=c.length)}c.push.apply(c,B.map(function(a){return(q.added?"+":"-")+a}));h(c,y,q);q.added?f+=B.length:e+=B.length}else a&&
(8>=B.length&&y<v.length-2?c.push.apply(c,g(B)):(u=Math.min(B.length,4),t.push("@@ -"+a+","+(e-a+u)+" +"+b+","+(f-b+u)+" @@"),t.push.apply(t,c),t.push.apply(t,g(B.slice(0,u))),4>=B.length&&h(t,y,q),b=a=0,c=[])),e+=B.length,f+=B.length}return t.join("\n")+"\n"},applyPatch:function(a,b){for(var c=b.split("\n"),d=[],e=!1,f=!1,g="I"===c[0][0]?4:0;g<c.length;g++)if("@"===c[g][0]){var h=c[g].split(/@@ -(\d+),(\d+) \+(\d+),(\d+) @@/);d.unshift({start:h[3],oldlength:h[2],oldlines:[],newlength:h[4],newlines:[]})}else"+"===
c[g][0]?d[0].newlines.push(c[g].substr(1)):"-"===c[g][0]?d[0].oldlines.push(c[g].substr(1)):" "===c[g][0]?(d[0].newlines.push(c[g].substr(1)),d[0].oldlines.push(c[g].substr(1))):"\\"===c[g][0]&&("+"===c[g-1][0]?e=!0:"-"===c[g-1][0]&&(f=!0));c=a.split("\n");for(g=d.length-1;0<=g;g--){for(var h=d[g],v=0;v<h.oldlength;v++)if(c[h.start-1+v]!==h.oldlines[v])return!1;Array.prototype.splice.apply(c,[h.start-1,+h.oldlength].concat(h.newlines))}if(e)for(;!c[c.length-1];)c.pop();else f&&c.push("");return c.join("\n")},
convertChangesToXML:function(a){for(var c=[],d=0;d<a.length;d++){var e=a[d];e.added?c.push("<ins>"):e.removed&&c.push("<del>");c.push(b(e.value));e.added?c.push("</ins>"):e.removed&&c.push("</del>")}return c.join("")},convertChangesToDMP:function(a){for(var b=[],c,d=0;d<a.length;d++)c=a[d],b.push([c.added?1:c.removed?-1:0,c.value]);return b}}}();"undefined"!==typeof module&&(module.exports=JsDiff);
!function(){function h(a,b){return a<b?-1:a>b?1:a>=b?0:NaN}function b(a){return null!=a&&!isNaN(a)}function a(a){return{left:function(b,c,d,e){3>arguments.length&&(d=0);4>arguments.length&&(e=b.length);for(;d<e;){var f=d+e>>>1;0>a(b[f],c)?d=f+1:e=f}return d},right:function(b,c,d,e){3>arguments.length&&(d=0);4>arguments.length&&(e=b.length);for(;d<e;){var f=d+e>>>1;0<a(b[f],c)?e=f:d=f+1}return d}}}function c(a){return a.length}function f(a,b){try{for(var c in b)Object.defineProperty(a.prototype,c,
{value:b[c],enumerable:!1})}catch(d){a.prototype=b}}function e(){}function g(a){return qc+a in this}function d(){var a=[];this.forEach(function(b){a.push(b)});return a}function l(){var a=0,b;for(b in this)b.charCodeAt(0)===Oe&&++a;return a}function m(){for(var a in this)if(a.charCodeAt(0)===Oe)return!1;return!0}function k(){}function n(a,b,c){return function(){var d=c.apply(b,arguments);return d===b?a:d}}function s(a,b){if(b in a)return b;b=b.charAt(0).toUpperCase()+b.substring(1);for(var c=0,d=Ng.length;c<
d;++c){var e=Ng[c]+b;if(e in a)return e}}function p(){}function r(){}function t(a){function b(){for(var d=c,e=-1,f=d.length,g;++e<f;)(g=d[e].on)&&g.apply(this,arguments);return a}var c=[],d=new e;b.on=function(b,e){var f=d.get(b),g;if(2>arguments.length)return f&&f.on;f&&(f.on=null,c=c.slice(0,g=c.indexOf(f)).concat(c.slice(g+1)),d.remove(b));e&&c.push(d.set(b,{on:e}));return a};return b}function v(){A.event.preventDefault()}function y(){for(var a=A.event,b;b=a.sourceEvent;)a=b;return a}function q(a){for(var b=
new r,c=0,d=arguments.length;++c<d;)b[arguments[c]]=t(b);b.of=function(c,d){return function(e){try{var f=e.sourceEvent=A.event;e.target=a;A.event=e;b[e.type].apply(c,d)}finally{A.event=f}}};return b}function B(a){Pe(a,fa);return a}function u(a){return"function"===typeof a?a:function(){return fg(a,this)}}function z(a){return"function"===typeof a?a:function(){return gg(a,this)}}function C(a,b){function c(){this.removeAttribute(a)}function d(){this.removeAttributeNS(a.space,a.local)}function e(){this.setAttribute(a,
b)}function f(){this.setAttributeNS(a.space,a.local,b)}function g(){var c=b.apply(this,arguments);null==c?this.removeAttribute(a):this.setAttribute(a,c)}function k(){var c=b.apply(this,arguments);null==c?this.removeAttributeNS(a.space,a.local):this.setAttributeNS(a.space,a.local,c)}a=A.ns.qualify(a);return null==b?a.local?d:c:"function"===typeof b?a.local?k:g:a.local?f:e}function F(a){return a.trim().replace(/\s+/g," ")}function x(a){return RegExp("(?:^|\\s+)"+A.requote(a)+"(?:\\s+|$)","g")}function w(a,
b){function c(){for(var d=-1;++d<e;)a[d](this,b)}function d(){for(var c=-1,f=b.apply(this,arguments);++c<e;)a[c](this,f)}a=a.trim().split(/^|\s+/).map(G);var e=a.length;return"function"===typeof b?d:c}function G(a){var b=x(a);return function(c,d){if(e=c.classList)return d?e.add(a):e.remove(a);var e=c.getAttribute("class")||"";d?(b.lastIndex=0,b.test(e)||c.setAttribute("class",F(e+" "+a))):c.setAttribute("class",F(e.replace(b," ")))}}function M(a,b,c){function d(){this.style.removeProperty(a)}function e(){this.style.setProperty(a,
b,c)}function f(){var d=b.apply(this,arguments);null==d?this.style.removeProperty(a):this.style.setProperty(a,d,c)}return null==b?d:"function"===typeof b?f:e}function K(a,b){function c(){delete this[a]}function d(){this[a]=b}function e(){var c=b.apply(this,arguments);null==c?delete this[a]:this[a]=c}return null==b?c:"function"===typeof b?e:d}function H(a){return"function"===typeof a?a:(a=A.ns.qualify(a)).local?function(){return this.ownerDocument.createElementNS(a.space,a.local)}:function(){return this.ownerDocument.createElementNS(this.namespaceURI,
a)}}function L(a){return function(){return Og(this,a)}}function E(a){arguments.length||(a=h);return function(b,c){return b&&c?a(b.__data__,c.__data__):!b-!c}}function N(a,b){for(var c=0,d=a.length;c<d;c++)for(var e=a[c],f=0,g=e.length,k;f<g;f++)(k=e[f])&&b(k,f,c);return a}function I(a){Pe(a,vb);return a}function D(a){var b,c;return function(d,e,f){d=a[f].update;var g=d.length;f!=c&&(c=f,b=0);for(e>=b&&(b=e+1);!(e=d[b])&&++b<g;);return e}}function Z(){var a=this.__transition__;a&&++a.active}function ia(a,
b,c){function d(){var b=this[g];b&&(this.removeEventListener(a,b,b.$),delete this[g])}function e(){var f=l(b,Sb(arguments));d.call(this);this.addEventListener(a,this[g]=f,f.$=c);f._=b}function f(){var b=RegExp("^__on([^.]+)"+A.requote(a)+"$"),c,d;for(d in this)if(c=d.match(b)){var e=this[d];this.removeEventListener(c[1],e,e.$);delete this[d]}}var g="__on"+a,k=a.indexOf("."),l=J;0<k&&(a=a.substring(0,k));var m=ig.get(a);m&&(a=m,l=ea);return k?b?e:d:b?p:f}function J(a,b){return function(c){var d=A.event;
A.event=c;b[0]=this.__data__;try{a.apply(this,b)}finally{A.event=d}}}function ea(a,b){var c=J(a,b);return function(a){var b=a.relatedTarget;(!b||b!==this&&!(b.compareDocumentPosition(this)&8))&&c.call(this,a)}}function P(){var a=".dragsuppress-"+ ++Hh,b="click"+a,c=A.select(Qa).on("touchmove"+a,v).on("dragstart"+a,v).on("selectstart"+a,v);if(Id){var d=Tb.style,e=d[Id];d[Id]="none"}return function(f){c.on(a,null);Id&&(d[Id]=e);if(f){var g=function(){c.on(b,null)};c.on(b,function(){v();g()},!0);setTimeout(g,
0)}}}function wa(a,b){b.changedTouches&&(b=b.changedTouches[0]);var c=a.ownerSVGElement||a;if(c.createSVGPoint)return c=c.createSVGPoint(),c.x=b.clientX,c.y=b.clientY,c=c.matrixTransform(a.getScreenCTM().inverse()),[c.x,c.y];c=a.getBoundingClientRect();return[b.clientX-c.left-a.clientLeft,b.clientY-c.top-a.clientTop]}function ja(){return A.event.changedTouches[0].identifier}function ba(){return A.event.target}function S(){return Qa}function ca(a,b,c){return(b[0]-a[0])*(c[1]-a[1])-(b[1]-a[1])*(c[0]-
a[0])}function la(a){return 1<a?Fa:-1>a?-Fa:Math.asin(a)}function na(a){return((a=Math.exp(a))+1/a)/2}function ka(a){return(a=Math.sin(a/2))*a}function U(){}function aa(a,b,c){return new Q(a,b,c)}function Q(a,b,c){this.h=a;this.s=b;this.l=c}function Ga(a,b,c){function d(a){360<a?a-=360:0>a&&(a+=360);return 60>a?e+(f-e)*a/60:180>a?f:240>a?e+(f-e)*(240-a)/60:e}var e,f;a=isNaN(a)?0:0>(a%=360)?a+360:a;b=isNaN(b)?0:0>b?0:1<b?1:b;c=0>c?0:1<c?1:c;f=0.5>=c?c*(1+b):c+b-c*b;e=2*c-f;return Ca(Math.round(255*
d(a+120)),Math.round(255*d(a)),Math.round(255*d(a-120)))}function xa(a,b,c){return new ma(a,b,c)}function ma(a,b,c){this.h=a;this.c=b;this.l=c}function da(a,b,c){isNaN(a)&&(a=0);isNaN(b)&&(b=0);return sa(c,Math.cos(a*=X)*b,Math.sin(a)*b)}function sa(a,b,c){return new W(a,b,c)}function W(a,b,c){this.l=a;this.a=b;this.b=c}function Ba(a,b,c){a=(a+16)/116;c=a-c/200;b=ta(a+b/500)*Pg;a=ta(a)*Qg;c=ta(c)*Rg;return Ca(Cb(3.2404542*b-1.5371385*a-0.4985314*c),Cb(-0.969266*b+1.8760108*a+0.041556*c),Cb(0.0556434*
b-0.2040259*a+1.0572252*c))}function Za(a,b,c){return 0<a?xa(Math.atan2(c,b)*pa,Math.sqrt(b*b+c*c),a):xa(NaN,NaN,a)}function ta(a){return 0.206893034<a?a*a*a:(a-4/29)/7.787037}function Yb(a){return 0.008856<a?Math.pow(a,1/3):7.787037*a+4/29}function Cb(a){return Math.round(255*(0.00304>=a?12.92*a:1.055*Math.pow(a,1/2.4)-0.055))}function Db(a){return Ca(a>>16,a>>8&255,a&255)+""}function Ca(a,b,c){return new Ka(a,b,c)}function Ka(a,b,c){this.r=a;this.g=b;this.b=c}function Ya(a){return 16>a?"0"+Math.max(0,
a).toString(16):Math.min(255,a).toString(16)}function xc(a,b,c){var d=0,e=0,f=0,g,k;if(g=/([a-z]+)\((.*)\)/i.exec(a))switch(k=g[2].split(","),g[1]){case "hsl":return c(parseFloat(k[0]),parseFloat(k[1])/100,parseFloat(k[2])/100);case "rgb":return b(ra(k[0]),ra(k[1]),ra(k[2]))}if(c=Re.get(a))return b(c.r,c.g,c.b);if(null!=a&&"#"===a.charAt(0)&&!isNaN(c=parseInt(a.substring(1),16)))4===a.length?(d=(c&3840)>>4,d|=d>>4,e=c&240,e|=e>>4,f=c&15,f|=f<<4):7===a.length&&(d=(c&16711680)>>16,e=(c&65280)>>8,f=
c&255);return b(d,e,f)}function Eb(a,b,c){var d=Math.min(a/=255,b/=255,c/=255),e=Math.max(a,b,c),f=e-d,g=(e+d)/2;f?(d=0.5>g?f/(e+d):f/(2-e-d),a=60*(a==e?(b-c)/f+(b<c?6:0):b==e?(c-a)/f+2:(a-b)/f+4)):(a=NaN,d=0<g&&1>g?0:a);return aa(a,d,g)}function $a(a,b,c){a=Xa(a);b=Xa(b);c=Xa(c);var d=Yb((0.4124564*a+0.3575761*b+0.1804375*c)/Pg),e=Yb((0.2126729*a+0.7151522*b+0.072175*c)/Qg);a=Yb((0.0193339*a+0.119192*b+0.9503041*c)/Rg);return sa(116*e-16,500*(d-e),200*(e-a))}function Xa(a){return 0.04045>=(a/=255)?
a/12.92:Math.pow((a+0.055)/1.055,2.4)}function ra(a){var b=parseFloat(a);return"%"===a.charAt(a.length-1)?Math.round(2.55*b):b}function ga(a){return"function"===typeof a?a:function(){return a}}function ya(a){return a}function Ab(a){return function(b,c,d){2===arguments.length&&"function"===typeof c&&(d=c,c=null);return Bb(b,c,a,d)}}function Bb(a,b,c,d){function e(){var a=l.status,b;if(!a&&l.responseText||200<=a&&300>a||304===a){try{b=c.call(f,l)}catch(d){g.error.call(f,d);return}g.load.call(f,b)}else g.error.call(f,
l)}var f={},g=A.dispatch("beforesend","progress","load","error"),k={},l=new XMLHttpRequest,m=null;Qa.XDomainRequest&&(!("withCredentials"in l)&&/^(http(s)?:)?\/\//.test(a))&&(l=new XDomainRequest);"onload"in l?l.onload=l.onerror=e:l.onreadystatechange=function(){3<l.readyState&&e()};l.onprogress=function(a){var b=A.event;A.event=a;try{g.progress.call(f,l)}finally{A.event=b}};f.header=function(a,b){a=(a+"").toLowerCase();if(2>arguments.length)return k[a];null==b?delete k[a]:k[a]=b+"";return f};f.mimeType=
function(a){if(!arguments.length)return b;b=null==a?null:a+"";return f};f.responseType=function(a){if(!arguments.length)return m;m=a;return f};f.response=function(a){c=a;return f};["get","post"].forEach(function(a){f[a]=function(){return f.send.apply(f,[a].concat(Sb(arguments)))}});f.send=function(c,d,e){2===arguments.length&&"function"===typeof d&&(e=d,d=null);l.open(c,a,!0);null!=b&&!("accept"in k)&&(k.accept=b+",*/*");if(l.setRequestHeader)for(var n in k)l.setRequestHeader(n,k[n]);null!=b&&l.overrideMimeType&&
l.overrideMimeType(b);null!=m&&(l.responseType=m);if(null!=e)f.on("error",e).on("load",function(a){e(null,a)});g.beforesend.call(f,l);l.send(null==d?null:d);return f};f.abort=function(){l.abort();return f};A.rebind(f,g,"on");return null==d?f:f.get(qf(d))}function qf(a){return 1===a.length?function(b,c){a(null==b?c:null)}:a}function hd(){var a=wc(),a=id()-a;24<a?(isFinite(a)&&(clearTimeout(Se),Se=setTimeout(hd,a)),Te=0):(Te=1,Sg(hd))}function wc(){var a=Date.now();for(wb=Ue;wb;)a>=wb.t&&(wb.f=wb.c(a-
wb.t)),wb=wb.n;return a}function id(){for(var a,b=Ue,c=Infinity;b;)b.f?b=a?a.n=b.n:Ue=b.n:(b.t<c&&(c=b.t),b=(a=b).n);Ve=a;return c}function Gb(a,b){return b-(a?Math.ceil(Math.log(a)/Math.LN10):1)}function Qd(a){var b=a.decimal,c=a.thousands,d=a.grouping,e=a.currency,f=d?function(a){for(var b=a.length,e=[],f=0,g=d[0];0<b&&0<g;)e.push(a.substring(b-=g,b+g)),g=d[f=(f+1)%d.length];return e.reverse().join(c)}:ya;return function(a){a=Tg.exec(a);var c=a[1]||" ",d=a[2]||">",g=a[3]||"",k=a[4]||"",l=a[5],ha=
+a[6],m=a[7],n=a[8],h=a[9],za=1,p="",s="",q=!1;n&&(n=+n.substring(1));if(l||"0"===c&&"="===d)l=c="0",d="=",m&&(ha-=Math.floor((ha-1)/4));switch(h){case "n":m=!0;h="g";break;case "%":za=100;s="%";h="f";break;case "p":za=100;s="%";h="r";break;case "b":case "o":case "x":case "X":"#"===k&&(p="0"+h.toLowerCase());case "c":case "d":q=!0;n=0;break;case "s":za=-1,h="r"}"$"===k&&(p=e[0],s=e[1]);"r"==h&&!n&&(h="g");if(null!=n)if("g"==h)n=Math.max(1,Math.min(21,n));else if("e"==h||"f"==h)n=Math.max(0,Math.min(20,
n));var h=Ih.get(h)||Rd,t=l&&m;return function(a){var e=s;if(q&&a%1)return"";var k=0>a||0===a&&0>1/a?(a=-a,"-"):g;0>za?(e=A.formatPrefix(a,n),a=e.scale(a),e=e.symbol+s):a*=za;a=h(a,n);var r=a.lastIndexOf("."),v=0>r?a:a.substring(0,r);a=0>r?"":b+a.substring(r+1);!l&&m&&(v=f(v));var r=p.length+v.length+a.length+(t?0:k.length),oa=r<ha?Array(r=ha-r+1).join(c):"";t&&(v=f(oa+v));k+=p;a=v+a;return("<"===d?k+a+oa:">"===d?oa+k+a:"^"===d?oa.substring(0,r>>=1)+k+a+oa.substring(r):k+(t?a:oa+a))+e}}}function Rd(a){return a+
""}function La(){this._=new Date(1<arguments.length?Date.UTC.apply(this,arguments):arguments[0])}function ab(a,b,c){function d(b){var c=a(b),e=f(c,1);return b-c<e-b?c:e}function e(c){b(c=a(new Ia(c-1)),1);return c}function f(a,c){b(a=new Ia(+a),c);return a}function g(a,d,f){a=e(a);var k=[];if(1<f)for(;a<d;)c(a)%f||k.push(new Date(+a)),b(a,1);else for(;a<d;)k.push(new Date(+a)),b(a,1);return k}a.floor=a;a.round=d;a.ceil=e;a.offset=f;a.range=g;var k=a.utc=yc(a);k.floor=k;k.round=yc(d);k.ceil=yc(e);
k.offset=yc(f);k.range=function(a,b,c){try{Ia=La;var d=new La;d._=a;return g(d,b,c)}finally{Ia=Date}};return a}function yc(a){return function(b,c){try{Ia=La;var d=new La;d._=b;return a(d,c)._}finally{Ia=Date}}}function vf(a){function b(a){function d(b){for(var c=[],f=-1,g=0,k,l;++f<e;)if(37===a.charCodeAt(f)){c.push(a.substring(g,f));if(null!=(k=Ug[g=a.charAt(++f)]))g=a.charAt(++f);if(l=z[g])g=l(b,null==k?"e"===g?" ":"0":k);c.push(g);g=f+1}c.push(a.substring(g,f));return c.join("")}var e=a.length;
d.parse=function(b){var d={y:1900,m:0,d:1,H:0,M:0,S:0,L:0,Z:null};if(c(d,a,b,0)!=b.length)return null;"p"in d&&(d.H=d.H%12+12*d.p);b=null!=d.Z&&Ia!==La;var e=new (b?La:Ia);"j"in d?e.setFullYear(d.y,0,d.j):"w"in d&&("W"in d||"U"in d)?(e.setFullYear(d.y,0,1),e.setFullYear(d.y,0,"W"in d?(d.w+6)%7+7*d.W-(e.getDay()+5)%7:d.w+7*d.U-(e.getDay()+6)%7)):e.setFullYear(d.y,d.m,d.d);e.setHours(d.H+Math.floor(d.Z/100),d.M+d.Z%100,d.S,d.L);return b?e._:e};d.toString=function(){return a};return d}function c(a,b,
d,e){for(var f,g=0,k=b.length,l=d.length;g<k;){if(e>=l)return-1;f=b.charCodeAt(g++);if(37===f){if(f=b.charAt(g++),f=B[f in Ug?b.charAt(g++):f],!f||0>(e=f(a,d,e)))return-1}else if(f!=d.charCodeAt(e++))return-1}return e}var d=a.dateTime,e=a.date,f=a.time,g=a.periods,k=a.days,l=a.shortDays,m=a.months,n=a.shortMonths;b.utc=function(a){function c(a){try{Ia=La;var b=new Ia;b._=a;return d(b)}finally{Ia=Date}}var d=b(a);c.parse=function(a){try{Ia=La;var b=d.parse(a);return b&&b._}finally{Ia=Date}};c.toString=
d.toString;return c};b.multi=b.utc.multi=If;var h=A.map(),p=nb(k),s=zc(k),q=nb(l),t=zc(l),r=nb(m),v=zc(m),u=nb(n),y=zc(n);g.forEach(function(a,b){h.set(a.toLowerCase(),b)});var z={a:function(a){return l[a.getDay()]},A:function(a){return k[a.getDay()]},b:function(a){return n[a.getMonth()]},B:function(a){return m[a.getMonth()]},c:b(d),d:function(a,b){return Da(a.getDate(),b,2)},e:function(a,b){return Da(a.getDate(),b,2)},H:function(a,b){return Da(a.getHours(),b,2)},I:function(a,b){return Da(a.getHours()%
12||12,b,2)},j:function(a,b){return Da(1+R.dayOfYear(a),b,3)},L:function(a,b){return Da(a.getMilliseconds(),b,3)},m:function(a,b){return Da(a.getMonth()+1,b,2)},M:function(a,b){return Da(a.getMinutes(),b,2)},p:function(a){return g[+(12<=a.getHours())]},S:function(a,b){return Da(a.getSeconds(),b,2)},U:function(a,b){return Da(R.sundayOfYear(a),b,2)},w:function(a){return a.getDay()},W:function(a,b){return Da(R.mondayOfYear(a),b,2)},x:b(e),X:b(f),y:function(a,b){return Da(a.getFullYear()%100,b,2)},Y:function(a,
b){return Da(a.getFullYear()%1E4,b,4)},Z:Gf,"%":function(){return"%"}},B={a:function(a,b,c){q.lastIndex=0;return(b=q.exec(b.substring(c)))?(a.w=t.get(b[0].toLowerCase()),c+b[0].length):-1},A:function(a,b,c){p.lastIndex=0;return(b=p.exec(b.substring(c)))?(a.w=s.get(b[0].toLowerCase()),c+b[0].length):-1},b:function(a,b,c){u.lastIndex=0;return(b=u.exec(b.substring(c)))?(a.m=y.get(b[0].toLowerCase()),c+b[0].length):-1},B:function(a,b,c){r.lastIndex=0;return(b=r.exec(b.substring(c)))?(a.m=v.get(b[0].toLowerCase()),
c+b[0].length):-1},c:function(a,b,d){return c(a,z.c.toString(),b,d)},d:Sd,e:Sd,H:Td,I:Td,j:Cf,L:Ff,m:Bf,M:Df,p:function(a,b,c){b=h.get(b.substring(c,c+=2).toLowerCase());return null==b?-1:(a.p=b,c)},S:Ef,U:wf,w:jd,W:xf,x:function(a,b,d){return c(a,z.x.toString(),b,d)},X:function(a,b,d){return c(a,z.X.toString(),b,d)},y:zf,Y:yf,Z:Af,"%":Hf};return b}function Da(a,b,c){var d=0>a?"-":"";a=(d?-a:a)+"";var e=a.length;return d+(e<c?Array(c-e+1).join(b)+a:a)}function nb(a){return RegExp("^(?:"+a.map(A.requote).join("|")+
")","i")}function zc(a){for(var b=new e,c=-1,d=a.length;++c<d;)b.set(a[c].toLowerCase(),c);return b}function jd(a,b,c){ua.lastIndex=0;return(b=ua.exec(b.substring(c,c+1)))?(a.w=+b[0],c+b[0].length):-1}function wf(a,b,c){ua.lastIndex=0;return(b=ua.exec(b.substring(c)))?(a.U=+b[0],c+b[0].length):-1}function xf(a,b,c){ua.lastIndex=0;return(b=ua.exec(b.substring(c)))?(a.W=+b[0],c+b[0].length):-1}function yf(a,b,c){ua.lastIndex=0;return(b=ua.exec(b.substring(c,c+4)))?(a.y=+b[0],c+b[0].length):-1}function zf(a,
b,c){ua.lastIndex=0;return(b=ua.exec(b.substring(c,c+2)))?(a.y=+b[0]+(68<+b[0]?1900:2E3),c+b[0].length):-1}function Af(a,b,c){return/^[+-]\d{4}$/.test(b=b.substring(c,c+5))?(a.Z=-b,c+5):-1}function Bf(a,b,c){ua.lastIndex=0;return(b=ua.exec(b.substring(c,c+2)))?(a.m=b[0]-1,c+b[0].length):-1}function Sd(a,b,c){ua.lastIndex=0;return(b=ua.exec(b.substring(c,c+2)))?(a.d=+b[0],c+b[0].length):-1}function Cf(a,b,c){ua.lastIndex=0;return(b=ua.exec(b.substring(c,c+3)))?(a.j=+b[0],c+b[0].length):-1}function Td(a,
b,c){ua.lastIndex=0;return(b=ua.exec(b.substring(c,c+2)))?(a.H=+b[0],c+b[0].length):-1}function Df(a,b,c){ua.lastIndex=0;return(b=ua.exec(b.substring(c,c+2)))?(a.M=+b[0],c+b[0].length):-1}function Ef(a,b,c){ua.lastIndex=0;return(b=ua.exec(b.substring(c,c+2)))?(a.S=+b[0],c+b[0].length):-1}function Ff(a,b,c){ua.lastIndex=0;return(b=ua.exec(b.substring(c,c+3)))?(a.L=+b[0],c+b[0].length):-1}function Gf(a){var b=a.getTimezoneOffset();a=0<b?"-":"+";var c=~~(Y(b)/60),b=Y(b)%60;return a+Da(c,"0",2)+Da(b,
"0",2)}function Hf(a,b,c){Vg.lastIndex=0;return(a=Vg.exec(b.substring(c,c+1)))?c+a[0].length:-1}function If(a){for(var b=a.length,c=-1;++c<b;)a[c][0]=this(a[c][0]);return function(b){for(var c=0,d=a[c];!d[1](b);)d=a[++c];return d[0](b)}}function kd(){}function Ud(a,b,c){var d=c.s=a+b,e=d-a;c.t=a-(d-e)+(b-e)}function Ac(a,b){if(a&&Wg.hasOwnProperty(a.type))Wg[a.type](a,b)}function ld(a,b,c){var d=-1;c=a.length-c;var e;for(b.lineStart();++d<c;)e=a[d],b.point(e[0],e[1],e[2]);b.lineEnd()}function Vd(a,
b){var c=-1,d=a.length;for(b.polygonStart();++c<d;)ld(a[c],b,1);b.polygonEnd()}function Jf(){function a(b,c){b*=X;c=c*X/2+V/4;var g=b-d,k=0<=g?1:-1,l=k*g,g=Math.cos(c),m=Math.sin(c),ha=f*m,n=e*g+ha*Math.cos(l),k=ha*k*Math.sin(l);rc.add(Math.atan2(k,n));d=b;e=g;f=m}var b,c,d,e,f;Ra.point=function(g,k){Ra.point=a;d=(b=g)*X;e=Math.cos(k=(c=k)*X/2+V/4);f=Math.sin(k)};Ra.lineEnd=function(){a(b,c)}}function ob(a){var b=a[0];a=a[1];var c=Math.cos(a);return[c*Math.cos(b),c*Math.sin(b),Math.sin(a)]}function Hb(a,
b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]}function Ib(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]}function md(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2]}function Bc(a,b){return[a[0]*b,a[1]*b,a[2]*b]}function Jb(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=b;a[1]/=b;a[2]/=b}function bb(a){return[Math.atan2(a[1],a[0]),la(a[2])]}function Zb(a,b){return Y(a[0]-b[0])<O&&Y(a[1]-b[1])<O}function $b(a,b){a*=X;var c=Math.cos(b*=X);Kb(c*Math.cos(a),c*Math.sin(a),Math.sin(b))}
function Kb(a,b,c){++Jd;xb+=(a-xb)/Jd;yb+=(b-yb)/Jd;lb+=(c-lb)/Jd}function Cc(){function a(e,f){e*=X;var g=Math.cos(f*=X),k=g*Math.cos(e),g=g*Math.sin(e),l=Math.sin(f),m=Math.atan2(Math.sqrt((m=c*l-d*g)*m+(m=d*k-b*l)*m+(m=b*g-c*k)*m),b*k+c*g+d*l);cd+=m;Ua+=m*(b+(b=k));Va+=m*(c+(c=g));Ma+=m*(d+(d=l));Kb(b,c,d)}var b,c,d;fb.point=function(e,f){e*=X;var g=Math.cos(f*=X);b=g*Math.cos(e);c=g*Math.sin(e);d=Math.sin(f);fb.point=a;Kb(b,c,d)}}function nd(){fb.point=$b}function Wd(){function a(b,c){b*=X;var g=
Math.cos(c*=X),k=g*Math.cos(b),g=g*Math.sin(b),l=Math.sin(c),m=e*l-f*g,ha=f*k-d*l,n=d*g-e*k,h=Math.sqrt(m*m+ha*ha+n*n),va=d*k+e*g+f*l,p=h&&-(1<va?0:-1>va?V:Math.acos(va))/h,h=Math.atan2(h,va);Ub+=p*m;Vb+=p*ha;mb+=p*n;cd+=h;Ua+=h*(d+(d=k));Va+=h*(e+(e=g));Ma+=h*(f+(f=l));Kb(d,e,f)}var b,c,d,e,f;fb.point=function(g,k){b=g;c=k;fb.point=a;g*=X;var l=Math.cos(k*=X);d=l*Math.cos(g);e=l*Math.sin(g);f=Math.sin(k);Kb(d,e,f)};fb.lineEnd=function(){a(b,c);fb.lineEnd=nd;fb.point=$b}}function pb(){return!0}function Dc(a,
b,c,d,e){var f=[],g=[];a.forEach(function(a){if(!(0>=(b=a.length-1))){var b,c=a[0],d=a[b];if(Zb(c,d)){e.lineStart();for(d=0;d<b;++d)e.point((c=a[d])[0],c[1]);e.lineEnd()}else b=new ac(c,a,null,!0),c=new ac(c,null,b,!1),b.o=c,f.push(b),g.push(c),b=new ac(d,a,null,!1),c=new ac(d,null,b,!0),b.o=c,f.push(b),g.push(c)}});g.sort(b);Ec(f);Ec(g);if(f.length){a=0;b=c;for(c=g.length;a<c;++a)g[a].e=b=!b;b=f[0];for(var k,l;;){for(var m=b,n=!0;m.v;)if((m=m.n)===b)return;k=m.z;e.lineStart();do{m.v=m.o.v=!0;if(m.e){if(n){a=
0;for(c=k.length;a<c;++a)e.point((l=k[a])[0],l[1])}else d(m.x,m.n.x,1,e);m=m.n}else{if(n){k=m.p.z;for(a=k.length-1;0<=a;--a)e.point((l=k[a])[0],l[1])}else d(m.x,m.p.x,-1,e);m=m.p}m=m.o;k=m.z;n=!n}while(!m.v);e.lineEnd()}}}function Ec(a){if(b=a.length){for(var b,c=0,d=a[0],e;++c<b;)d.n=e=a[c],e.p=d,d=e;d.n=e=a[0];e.p=d}}function ac(a,b,c,d){this.x=a;this.z=b;this.o=c;this.e=d;this.v=!1;this.n=this.p=null}function Xd(a,b,c,d){return function(e,f){function g(b,c){var d=e(b,c);a(b=d[0],c=d[1])&&f.point(b,
c)}function k(a,b){var c=e(a,b);s.point(c[0],c[1])}function l(){t.point=k;s.lineStart()}function m(){t.point=g;s.lineEnd()}function n(a,b){B.push([a,b]);var c=e(a,b);u.point(c[0],c[1])}function h(){u.lineStart();B=[]}function p(){n(B[0][0],B[0][1]);u.lineEnd();var a=u.clean(),b=v.buffer(),c=b.length;B.pop();z.push(B);B=null;if(c)if(a&1){var a=b[0],c=a.length-1,b=-1,d;if(0<c){y||(f.polygonStart(),y=!0);for(f.lineStart();++b<c;)f.point((d=a[b])[0],d[1]);f.lineEnd()}}else 1<c&&a&2&&b.push(b.pop().concat(b.shift())),
r.push(b.filter(Yd))}var s=b(f),q=e.invert(d[0],d[1]),t={point:g,lineStart:l,lineEnd:m,polygonStart:function(){t.point=n;t.lineStart=h;t.lineEnd=p;r=[];z=[]},polygonEnd:function(){t.point=g;t.lineStart=l;t.lineEnd=m;r=A.merge(r);var a,b=q;a=z;var d=b[0],e=b[1],k=[Math.sin(d),-Math.cos(d),0],ha=0,n=0;rc.reset();for(var h=0,va=a.length;h<va;++h){var p=a[h],s=p.length;if(s)for(var v=p[0],oa=v[0],b=v[1]/2+V/4,u=Math.sin(b),Me=Math.cos(b),eb=1;;){eb===s&&(eb=0);var b=p[eb],B=b[0],x=b[1]/2+V/4,w=Math.sin(x),
x=Math.cos(x),C=B-oa,F=0<=C?1:-1,hg=F*C,Qe=hg>V,u=u*w;rc.add(Math.atan2(u*F*Math.sin(hg),Me*x+u*Math.cos(hg)));ha+=Qe?C+F*Sa:C;if(Qe^oa>=d^B>=d&&(v=Ib(ob(v),ob(b)),Jb(v),oa=Ib(k,v),Jb(oa),oa=(Qe^0<=C?-1:1)*la(oa[2]),e>oa||e===oa&&(v[0]||v[1])))n+=Qe^0<=C?1:-1;if(!eb++)break;oa=B;u=w;Me=x;v=b}}a=(ha<-O||ha<O&&0>rc)^n&1;r.length?(y||(f.polygonStart(),y=!0),Dc(r,Kf,a,c,f)):a&&(y||(f.polygonStart(),y=!0),f.lineStart(),c(null,null,1,f),f.lineEnd());y&&(f.polygonEnd(),y=!1);r=z=null},sphere:function(){f.polygonStart();
f.lineStart();c(null,null,1,f);f.lineEnd();f.polygonEnd()}},r,v=Zd(),u=b(v),y=!1,z,B;return t}}function Yd(a){return 1<a.length}function Zd(){var a=[],b;return{lineStart:function(){a.push(b=[])},point:function(a,c){b.push([a,c])},lineEnd:p,buffer:function(){var c=a;a=[];b=null;return c},rejoin:function(){1<a.length&&a.push(a.pop().concat(a.shift()))}}}function Kf(a,b){return(0>(a=a.x)[0]?a[1]-Fa-O:Fa-a[1])-(0>(b=b.x)[0]?b[1]-Fa-O:Fa-b[1])}function Lf(a){function b(a,c){return Math.cos(a)*Math.cos(c)>
e}function c(a,b,d){var f=ob(a),g=ob(b),k=[1,0,0],g=Ib(f,g),l=Hb(g,g),f=g[0],m=l-f*f;if(!m)return!d&&a;l=e*l/m;m=-e*f/m;f=Ib(k,g);k=Bc(k,l);g=Bc(g,m);md(k,g);g=Hb(k,f);l=Hb(f,f);m=g*g-l*(Hb(k,k)-1);if(!(0>m)){var ha=Math.sqrt(m),m=Bc(f,(-g-ha)/l);md(m,k);m=bb(m);if(!d)return m;d=a[0];var n=b[0];a=a[1];b=b[1];var h;n<d&&(h=d,d=n,n=h);var va=n-d,p=Y(va-V)<O,s=p||va<O;!p&&b<a&&(h=a,a=b,b=h);if(s?p?0<a+b^m[1]<(Y(m[0]-d)<O?a:b):a<=m[1]&&m[1]<=b:va>V^(d<=m[0]&&m[0]<=n))return b=Bc(f,(-g+ha)/l),md(b,k),
[m,bb(b)]}}function d(b,c){var e=f?a:V-a,g=0;b<-e?g|=1:b>e&&(g|=2);c<-e?g|=4:c>e&&(g|=8);return g}var e=Math.cos(a),f=0<e,g=Y(e)>O,k=Lc(a,6*X);return Xd(b,function(a){var e,k,l,m,ha;return{lineStart:function(){m=l=!1;ha=1},point:function(n,h){var p=[n,h],s,q=b(n,h),t=f?q?0:d(n,h):q?d(n+(0>n?V:-V),h):0;!e&&(m=l=q)&&a.lineStart();if(q!==l&&(s=c(e,p),Zb(e,s)||Zb(p,s)))p[0]+=O,p[1]+=O,q=b(p[0],p[1]);if(q!==l)ha=0,q?(a.lineStart(),s=c(p,e),a.point(s[0],s[1])):(s=c(e,p),a.point(s[0],s[1]),a.lineEnd()),
e=s;else if(g&&e&&f^q){var r;if(!(t&k)&&(r=c(p,e,!0)))ha=0,f?(a.lineStart(),a.point(r[0][0],r[0][1]),a.point(r[1][0],r[1][1]),a.lineEnd()):(a.point(r[1][0],r[1][1]),a.lineEnd(),a.lineStart(),a.point(r[0][0],r[0][1]))}q&&(!e||!Zb(e,p))&&a.point(p[0],p[1]);e=p;l=q;k=t},lineEnd:function(){l&&a.lineEnd();e=null},clean:function(){return ha|(m&&l)<<1}}},k,f?[0,-a]:[-V,a-V])}function $d(a,b,c,d){return function(e){var f=e.a,g=e.b,k=f.x,f=f.y,l=0,m=1,n=g.x-k,g=g.y-f,h;h=a-k;if(n||!(0<h)){h/=n;if(0>n){if(h<
l)return;h<m&&(m=h)}else if(0<n){if(h>m)return;h>l&&(l=h)}h=c-k;if(n||!(0>h)){h/=n;if(0>n){if(h>m)return;h>l&&(l=h)}else if(0<n){if(h<l)return;h<m&&(m=h)}h=b-f;if(g||!(0<h)){h/=g;if(0>g){if(h<l)return;h<m&&(m=h)}else if(0<g){if(h>m)return;h>l&&(l=h)}h=d-f;if(g||!(0>h)){h/=g;if(0>g){if(h>m)return;h>l&&(l=h)}else if(0<g){if(h<l)return;h<m&&(m=h)}0<l&&(e.a={x:k+l*n,y:f+l*g});1>m&&(e.b={x:k+m*n,y:f+m*g});return e}}}}}}function ae(a,b,c,d){function e(d,f){return Y(d[0]-a)<O?0<f?0:3:Y(d[0]-c)<O?0<f?2:1:
Y(d[1]-b)<O?0<f?1:0:0<f?3:2}function f(a,b){return g(a.x,b.x)}function g(a,b){var c=e(a,1),d=e(b,1);return c!==d?c-d:0===c?b[1]-a[1]:1===c?a[0]-b[0]:2===c?a[1]-b[1]:b[0]-a[0]}return function(k){function l(f,k,m,n){var h=0,p=0;if(null==f||(h=e(f,m))!==(p=e(k,m))||0>g(f,k)^0<m){do n.point(0===h||3===h?a:c,1<h?d:b);while((h=(h+m+4)%4)!==p)}else n.point(k[0],k[1])}function m(e,f){a<=e&&(e<=c&&b<=f&&f<=d)&&k.point(e,f)}function n(e,f){e=Math.max(-We,Math.min(We,e));f=Math.max(-We,Math.min(We,f));var g=
a<=e&&e<=c&&b<=f&&f<=d;t&&r.push([e,f]);if(C)u=e,y=f,z=g,C=!1,g&&(k.lineStart(),k.point(e,f));else if(g&&w)k.point(e,f);else{var l={a:{x:B,y:x},b:{x:e,y:f}};s(l)?(w||(k.lineStart(),k.point(l.a.x,l.a.y)),k.point(l.b.x,l.b.y),g||k.lineEnd(),F=!1):g&&(k.lineStart(),k.point(e,f),F=!1)}B=e;x=f;w=g}var h=k,p=Zd(),s=$d(a,b,c,d),q,t,r,v={point:m,lineStart:function(){v.point=n;t&&t.push(r=[]);C=!0;w=!1;B=x=NaN},lineEnd:function(){q&&(n(u,y),z&&w&&p.rejoin(),q.push(p.buffer()));v.point=m;w&&k.lineEnd()},polygonStart:function(){k=
p;q=[];t=[];F=!0},polygonEnd:function(){k=h;q=A.merge(q);var b;b=[a,d];for(var c=0,e=t.length,g=b[1],m=0;m<e;++m)for(var n=1,va=t[m],p=va.length,s=va[0],za;n<p;++n)za=va[n],s[1]<=g?za[1]>g&&0<ca(s,za,b)&&++c:za[1]<=g&&0>ca(s,za,b)&&--c,s=za;b=0!==c;c=F&&b;e=q.length;if(c||e)k.polygonStart(),c&&(k.lineStart(),l(null,null,1,k),k.lineEnd()),e&&Dc(q,f,b,l,k),k.polygonEnd();q=t=r=null}},u,y,z,B,x,w,C,F;return v}}function be(a,b){function c(d,e){return d=a(d,e),b(d[0],d[1])}a.invert&&b.invert&&(c.invert=
function(c,d){return c=b.invert(c,d),c&&a.invert(c[0],c[1])});return c}function Fc(a){var b=0,c=V/3,d=Ea(a);a=d(b,c);a.parallels=function(a){return!arguments.length?[180*(b/V),180*(c/V)]:d(b=a[0]*V/180,c=a[1]*V/180)};return a}function ce(a,b){function c(a,b){var d=Math.sqrt(f-2*e*Math.sin(b))/e;return[d*Math.sin(a*=e),g-d*Math.cos(a)]}var d=Math.sin(a),e=(d+Math.sin(b))/2,f=1+d*(2*e-d),g=Math.sqrt(f)/e;c.invert=function(a,b){var c=g-b;return[Math.atan2(a,c)/e,la((f-(a*a+c*c)*e*e)/(2*e))]};return c}
function de(){function a(b,c){Xe+=e*b-d*c;d=b;e=c}var b,c,d,e;Wb.point=function(f,g){Wb.point=a;b=d=f;c=e=g};Wb.lineEnd=function(){a(b,c)}}function ee(){function a(b,c){g.push("M",b,",",c,f)}function b(a,d){g.push("M",a,",",d);k.point=c}function c(a,b){g.push("L",a,",",b)}function d(){k.point=a}function e(){g.push("Z")}var f=Gc(4.5),g=[],k={point:a,lineStart:function(){k.point=b},lineEnd:d,polygonStart:function(){k.lineEnd=e},polygonEnd:function(){k.lineEnd=d;k.point=a},pointRadius:function(a){f=
Gc(a);return k},result:function(){if(g.length){var a=g.join("");g=[];return a}}};return k}function Gc(a){return"m0,"+a+"a"+a+","+a+" 0 1,1 0,"+-2*a+"a"+a+","+a+" 0 1,1 0,"+2*a+"z"}function ib(a,b){xb+=a;yb+=b;++lb}function Hc(){function a(d,e){var f=d-b,g=e-c,f=Math.sqrt(f*f+g*g);Ua+=f*(b+d)/2;Va+=f*(c+e)/2;Ma+=f;ib(b=d,c=e)}var b,c;gb.point=function(d,e){gb.point=a;ib(b=d,c=e)}}function od(){gb.point=ib}function fe(){function a(b,c){var f=b-d,g=c-e,f=Math.sqrt(f*f+g*g);Ua+=f*(d+b)/2;Va+=f*(e+c)/
2;Ma+=f;f=e*b-d*c;Ub+=f*(d+b);Vb+=f*(e+c);mb+=3*f;ib(d=b,e=c)}var b,c,d,e;gb.point=function(f,g){gb.point=a;ib(b=d=f,c=e=g)};gb.lineEnd=function(){a(b,c)}}function ge(a){function b(c,d){a.moveTo(c,d);a.arc(c,d,g,0,Sa)}function c(b,e){a.moveTo(b,e);k.point=d}function d(b,c){a.lineTo(b,c)}function e(){k.point=b}function f(){a.closePath()}var g=4.5,k={point:b,lineStart:function(){k.point=c},lineEnd:e,polygonStart:function(){k.lineEnd=f},polygonEnd:function(){k.lineEnd=e;k.point=b},pointRadius:function(a){g=
a;return k},result:p};return k}function Ic(a){function b(a){return(k?d:c)(a)}function c(b){return je(b,function(c,d){c=a(c,d);b.point(c[0],c[1])})}function d(b){function c(d,e){d=a(d,e);b.point(d[0],d[1])}function f(){v=NaN;z.point=g;b.lineStart()}function g(c,d){var f=ob([c,d]),l=a(c,d);e(v,u,za,oa,y,Ne,v=l[0],u=l[1],za=c,oa=f[0],y=f[1],Ne=f[2],k,b);b.point(v,u)}function l(){z.point=c;b.lineEnd()}function m(){f();z.point=n;z.lineEnd=h}function n(a,b){g(va=a,b);p=v;s=u;q=oa;t=y;r=Ne;z.point=g}function h(){e(v,
u,za,oa,y,Ne,p,s,va,q,t,r,k,b);z.lineEnd=l;l()}var va,p,s,q,t,r,za,v,u,oa,y,Ne,z={point:c,lineStart:f,lineEnd:l,polygonStart:function(){b.polygonStart();z.lineStart=m},polygonEnd:function(){b.polygonEnd();z.lineStart=f}};return z}function e(b,c,d,k,l,m,n,h,va,p,s,q,t,r){var za=n-b,v=h-c,u=za*za+v*v;if(u>4*f&&t--){var oa=k+p,y=l+s,z=m+q,B=Math.sqrt(oa*oa+y*y+z*z),eb=Math.asin(z/=B),x=Y(Y(z)-1)<O||Y(d-va)<O?(d+va)/2:Math.atan2(y,oa),w=a(x,eb),eb=w[0],w=w[1],C=eb-b,F=w-c,I=v*C-za*F;if(I*I/u>f||0.3<Y((za*
C+v*F)/u-0.5)||k*p+l*s+m*q<g)e(b,c,d,k,l,m,eb,w,x,oa/=B,y/=B,z,t,r),r.point(eb,w),e(eb,w,x,oa,y,z,n,h,va,p,s,q,t,r)}}var f=0.5,g=Math.cos(30*X),k=16;b.precision=function(a){if(!arguments.length)return Math.sqrt(f);k=0<(f=a*a)&&16;return b};return b}function he(a){var b=Ic(function(b,c){return a([b*pa,c*pa])});return function(a){return Ha(b(a))}}function ie(a){this.stream=a}function je(a,b){return{point:b,sphere:function(){a.sphere()},lineStart:function(){a.lineStart()},lineEnd:function(){a.lineEnd()},
polygonStart:function(){a.polygonStart()},polygonEnd:function(){a.polygonEnd()}}}function cb(a){return Ea(function(){return a})()}function Ea(a){function b(a){a=k(a[0]*X,a[1]*X);return[a[0]*m+v,u-a[1]*m]}function c(a){return(a=k.invert((a[0]-v)/m,(u-a[1])/m))&&[a[0]*pa,a[1]*pa]}function d(){k=be(g=pd(q,t,r),f);var a=f(p,s);v=n-a[0]*m;u=h+a[1]*m;return e()}function e(){w&&(w.valid=!1,w=null);return b}var f,g,k,l=Ic(function(a,b){a=f(a,b);return[a[0]*m+v,u-a[1]*m]}),m=150,n=480,h=250,p=0,s=0,q=0,t=
0,r=0,v,u,y=Xg,z=ya,B=null,x=null,w;b.stream=function(a){w&&(w.valid=!1);w=Ha(y(g,l(z(a))));w.valid=!0;return w};b.clipAngle=function(a){if(!arguments.length)return B;y=null==a?(B=a,Xg):Lf((B=+a)*X);return e()};b.clipExtent=function(a){if(!arguments.length)return x;z=(x=a)?ae(a[0][0],a[0][1],a[1][0],a[1][1]):ya;return e()};b.scale=function(a){if(!arguments.length)return m;m=+a;return d()};b.translate=function(a){if(!arguments.length)return[n,h];n=+a[0];h=+a[1];return d()};b.center=function(a){if(!arguments.length)return[p*
pa,s*pa];p=a[0]%360*X;s=a[1]%360*X;return d()};b.rotate=function(a){if(!arguments.length)return[q*pa,t*pa,r*pa];q=a[0]%360*X;t=a[1]%360*X;r=2<a.length?a[2]%360*X:0;return d()};A.rebind(b,l,"precision");return function(){f=a.apply(this,arguments);b.invert=f.invert&&c;return d()}}function Ha(a){return je(a,function(b,c){a.point(b*X,c*X)})}function Lb(a,b){return[a,b]}function Jc(a,b){return[a>V?a-Sa:a<-V?a+Sa:a,b]}function pd(a,b,c){return a?b||c?be(bc(a),Kc(b,c)):bc(a):b||c?Kc(b,c):Jc}function ke(a){return function(b,
c){return b+=a,[b>V?b-Sa:b<-V?b+Sa:b,c]}}function bc(a){var b=ke(a);b.invert=ke(-a);return b}function Kc(a,b){function c(a,b){var k=Math.cos(b),l=Math.cos(a)*k,k=Math.sin(a)*k,m=Math.sin(b),ha=m*d+l*e;return[Math.atan2(k*f-ha*g,l*d-m*e),la(ha*f+k*g)]}var d=Math.cos(a),e=Math.sin(a),f=Math.cos(b),g=Math.sin(b);c.invert=function(a,b){var c=Math.cos(b),k=Math.cos(a)*c,c=Math.sin(a)*c,l=Math.sin(b),m=l*f-c*g;return[Math.atan2(c*f+l*g,k*d+m*e),la(m*d-k*e)]};return c}function Lc(a,b){var c=Math.cos(a),
d=Math.sin(a);return function(e,f,g,k){var l=g*b;if(null!=e){if(e=le(c,e),f=le(c,f),0<g?e<f:e>f)e+=g*Sa}else e=a+g*Sa,f=a-0.5*l;for(var m;0<g?e>f:e<f;e-=l)k.point((m=bb([c,-d*Math.cos(e),-d*Math.sin(e)]))[0],m[1])}}function le(a,b){var c=ob(b);c[0]-=a;Jb(c);var d=1<-c[1]?0:-1>-c[1]?V:Math.acos(-c[1]);return((0>-c[2]?-d:d)+2*Math.PI-O)%(2*Math.PI)}function cc(a,b,c){var d=A.range(a,b-O,c).concat(b);return function(a){return d.map(function(b){return[a,b]})}}function me(a,b,c){var d=A.range(a,b-O,c).concat(b);
return function(a){return d.map(function(b){return[b,a]})}}function Mc(a){return a.source}function dc(a){return a.target}function jb(a,b,c,d){var e=Math.cos(b),f=Math.sin(b),g=Math.cos(d),k=Math.sin(d),l=e*Math.cos(a),m=e*Math.sin(a),n=g*Math.cos(c),h=g*Math.sin(c),p=2*Math.asin(Math.sqrt(ka(d-b)+e*g*ka(c-a))),s=1/Math.sin(p);c=p?function(a){var b=Math.sin(a*=p)*s,c=Math.sin(p-a)*s;a=c*l+b*n;var d=c*m+b*h,b=c*f+b*k;return[Math.atan2(d,a)*pa,Math.atan2(b,Math.sqrt(a*a+d*d))*pa]}:function(){return[a*
pa,b*pa]};c.distance=p;return c}function qa(a,b){function c(b,d){var e=Math.cos(b),f=Math.cos(d),e=a(e*f);return[e*f*Math.sin(b),e*Math.sin(d)]}c.invert=function(a,c){var d=Math.sqrt(a*a+c*c),e=b(d),f=Math.sin(e),e=Math.cos(e);return[Math.atan2(a*f,d*e),Math.asin(d&&c*f/d)]};return c}function ne(a,b){function c(a,b){0<f?b<-Fa+O&&(b=-Fa+O):b>Fa-O&&(b=Fa-O);var d=f/Math.pow(Math.tan(V/4+b/2),e);return[d*Math.sin(e*a),f-d*Math.cos(e*a)]}var d=Math.cos(a),e=a===b?Math.sin(a):Math.log(d/Math.cos(b))/Math.log(Math.tan(V/
4+b/2)/Math.tan(V/4+a/2)),f=d*Math.pow(Math.tan(V/4+a/2),e)/e;if(!e)return ec;c.invert=function(a,b){var c=f-b,d=(0<e?1:0>e?-1:0)*Math.sqrt(a*a+c*c);return[Math.atan2(a,c)/e,2*Math.atan(Math.pow(f/d,1/e))-Fa]};return c}function qd(a,b){function c(a,b){var d=f-b;return[d*Math.sin(e*a),f-d*Math.cos(e*a)]}var d=Math.cos(a),e=a===b?Math.sin(a):(d-Math.cos(b))/(b-a),f=d/e+a;if(Y(e)<O)return Lb;c.invert=function(a,b){var c=f-b;return[Math.atan2(a,c)/e,f-(0<e?1:0>e?-1:0)*Math.sqrt(a*a+c*c)]};return c}function ec(a,
b){return[a,Math.log(Math.tan(V/4+b/2))]}function rd(a){var b=cb(a),c=b.scale,d=b.translate,e=b.clipExtent,f;b.scale=function(){var a=c.apply(b,arguments);return a===b?f?b.clipExtent(null):b:a};b.translate=function(){var a=d.apply(b,arguments);return a===b?f?b.clipExtent(null):b:a};b.clipExtent=function(a){var g=e.apply(b,arguments);if(g===b){if(f=null==a){var k=V*c(),l=d();e([[l[0]-k,l[1]-k],[l[0]+k,l[1]+k]])}}else f&&(g=null);return g};return b.clipExtent(null)}function Nc(a,b){return[Math.log(Math.tan(V/
4+b/2)),-a]}function Ja(a){return a[0]}function Oa(a){return a[1]}function Oc(a){for(var b=a.length,c=[0,1],d=2,e=2;e<b;e++){for(;1<d&&0>=ca(a[c[d-2]],a[c[d-1]],a[e]);)--d;c[d++]=e}return c.slice(0,d)}function Mb(a,b){return a[0]-b[0]||a[1]-b[1]}function fc(a,b,c){return(c[0]-b[0])*(a[1]-b[1])<(c[1]-b[1])*(a[0]-b[0])}function Pc(a,b,c,d){var e=a[0],f=c[0],g=b[0]-e,k=d[0]-f;a=a[1];c=c[1];b=b[1]-a;d=d[1]-c;f=(k*(a-c)-d*(e-f))/(d*g-k*b);return[e+f*g,a+f*b]}function oe(a){var b=a[0];a=a[a.length-1];return!(b[0]-
a[0]||b[1]-a[1])}function Mf(){jc(this);this.edge=this.site=this.circle=null}function sd(a){var b=Yg.pop()||new Mf;b.site=a;return b}function gc(a){Ob(a);dd.remove(a);Yg.push(a);jc(a)}function td(a,b){var c=a.site,d=c.x,e=c.y,f=e-b;if(!f)return d;var g=a.P;if(!g)return-Infinity;var c=g.site,g=c.x,c=c.y,k=c-b;if(!k)return g;var l=g-d,m=1/f-1/k,n=l/k;return m?(-n+Math.sqrt(n*n-2*m*(l*l/(-2*k)-c+k/2+e-f/2)))/m+d:(d+g)/2}function qb(a){this.site=a;this.edges=[]}function ud(a,b){return b.angle-a.angle}
function pe(){jc(this);this.x=this.y=this.arc=this.site=this.cy=null}function Nb(a){var b=a.P,c=a.N;if(b&&c){var d=b.site,b=a.site,e=c.site;if(d!==e){var c=b.x,f=b.y,g=d.x-c,k=d.y-f,d=e.x-c,e=e.y-f,l=2*(g*e-k*d);if(!(l>=-jg)){var m=g*g+k*k,n=d*d+e*e,k=(e*m-k*n)/l,g=(g*n-d*m)/l,e=g+f,f=Zg.pop()||new pe;f.arc=a;f.site=b;f.x=k+c;f.y=e+Math.sqrt(k*k+g*g);f.cy=e;a.circle=f;a=null;for(b=Kd._;b;)if(f.y<b.y||f.y===b.y&&f.x<=b.x)if(b.L)b=b.L;else{a=b.P;break}else if(b.R)b=b.R;else{a=b;break}Kd.insert(a,f);
a||(kg=f)}}}}function Ob(a){var b=a.circle;b&&(b.P||(kg=b.N),Kd.remove(b),Zg.push(b),jc(b),a.circle=null)}function vd(a,b){var c=a.b;if(c)return!0;var d=a.a,c=b[0][0],e=b[1][0],f=b[0][1],g=b[1][1],k=a.l,l=a.r,m=k.x,k=k.y,n=l.x,l=l.y,h=(m+n)/2,p;if(l===k){if(h<c||h>=e)return;if(m>n){if(d){if(d.y>=g)return}else d={x:h,y:f};c={x:h,y:g}}else{if(d){if(d.y<f)return}else d={x:h,y:g};c={x:h,y:f}}}else if(p=(m-n)/(l-k),h=(k+l)/2-p*h,-1>p||1<p)if(m>n){if(d){if(d.y>=g)return}else d={x:(f-h)/p,y:f};c={x:(g-h)/
p,y:g}}else{if(d){if(d.y<f)return}else d={x:(g-h)/p,y:g};c={x:(f-h)/p,y:f}}else if(k<l){if(d){if(d.x>=e)return}else d={x:c,y:p*c+h};c={x:e,y:p*e+h}}else{if(d){if(d.x<c)return}else d={x:e,y:p*e+h};c={x:c,y:p*c+h}}a.a=d;a.b=c;return!0}function wd(a,b){this.l=a;this.r=b;this.a=this.b=null}function Pb(a,b,c,d){var e=new wd(a,b);ed.push(e);c&&hc(e,a,b,c);d&&hc(e,b,a,d);sc[a.i].edges.push(new ic(e,a,b));sc[b.i].edges.push(new ic(e,b,a));return e}function qe(a,b,c){a=new wd(a,null);a.a=b;a.b=c;ed.push(a);
return a}function hc(a,b,c,d){!a.a&&!a.b?(a.a=d,a.l=b,a.r=c):a.l===c?a.b=d:a.a=d}function ic(a,b,c){var d=a.a,e=a.b;this.edge=a;this.site=b;this.angle=c?Math.atan2(c.y-b.y,c.x-b.x):a.l===b?Math.atan2(e.x-d.x,d.y-e.y):Math.atan2(d.x-e.x,e.y-d.y)}function xd(){this._=null}function jc(a){a.U=a.C=a.L=a.R=a.P=a.N=null}function kc(a,b){var c=b.R,d=b.U;d?d.L===b?d.L=c:d.R=c:a._=c;c.U=d;b.U=c;b.R=c.L;b.R&&(b.R.U=b);c.L=b}function Qb(a,b){var c=b.L,d=b.U;d?d.L===b?d.L=c:d.R=c:a._=c;c.U=d;b.U=c;b.L=c.R;b.L&&
(b.L.U=b);c.R=b}function re(a){for(;a.L;)a=a.L;return a}function Qc(a,b){var c=a.sort(Nf).pop(),d,e,f;ed=[];sc=Array(a.length);dd=new xd;for(Kd=new xd;;)if(f=kg,c&&(!f||c.y<f.y||c.y===f.y&&c.x<f.x)){if(c.x!==d||c.y!==e){sc[c.i]=new qb(c);d=c;for(var g=d.x,k=d.y,l=f=e=void 0,m=void 0,n=dd._;n;)if(l=td(n,k)-g,l>O)n=n.L;else{var m=g,h;var p=n;h=k;var s=p.N;s?h=td(s,h):(p=p.site,h=p.y===h?p.x:Infinity);m-=h;if(m>O){if(!n.R){e=n;break}n=n.R}else{l>-O?(e=n.P,f=n):m>-O?(e=n,f=n.N):e=f=n;break}}g=sd(d);dd.insert(e,
g);if(e||f)if(e===f)Ob(e),f=sd(e.site),dd.insert(g,f),g.edge=f.edge=Pb(e.site,g.site),Nb(e),Nb(f);else if(f){Ob(e);Ob(f);k=e.site;n=k.x;m=k.y;h=d.x-n;var p=d.y-m,l=f.site,s=l.x-n,q=l.y-m,t=2*(h*q-p*s),r=h*h+p*p,v=s*s+q*q,n={x:(q*r-p*v)/t+n,y:(h*v-s*r)/t+m};hc(f.edge,k,l,n);g.edge=Pb(k,d,null,n);f.edge=Pb(d,l,null,n);Nb(e);Nb(f)}else g.edge=Pb(e.site,g.site);d=c.x;e=c.y}c=a.pop()}else if(f){l=f.arc;f=l.circle;k=f.x;n=f.cy;f={x:k,y:n};h=l.P;m=l.N;g=[l];gc(l);for(l=h;l.circle&&Y(k-l.circle.x)<O&&Y(n-
l.circle.cy)<O;)h=l.P,g.unshift(l),gc(l),l=h;g.unshift(l);Ob(l);for(h=m;h.circle&&Y(k-h.circle.x)<O&&Y(n-h.circle.cy)<O;)m=h.N,g.push(h),gc(h),h=m;g.push(h);Ob(h);k=g.length;n=void 0;for(n=1;n<k;++n)h=g[n],l=g[n-1],hc(h.edge,l.site,h.site,f);l=g[0];h=g[k-1];h.edge=Pb(l.site,h.site,null,f);Nb(l);Nb(h)}else break;if(b){c=ed;d=$d(b[0][0],b[0][1],b[1][0],b[1][1]);for(e=c.length;e--;)if(f=c[e],!vd(f,b)||!d(f)||Y(f.a.x-f.b.x)<O&&Y(f.a.y-f.b.y)<O)f.a=f.b=null,c.splice(e,1);c=b[0][0];d=b[1][0];e=b[0][1];
f=b[1][1];n=sc;for(m=n.length;m--;)if((h=n[m])&&h.prepare()){s=h.edges;q=s.length;for(p=0;p<q;)if(t=s[p].end(),k=t.x,l=t.y,r=s[++p%q].start(),g=r.x,r=r.y,Y(k-g)>O||Y(l-r)>O)s.splice(p,0,new ic(qe(h.site,t,Y(k-c)<O&&f-l>O?{x:c,y:Y(g-c)<O?r:f}:Y(l-f)<O&&d-k>O?{x:Y(r-f)<O?g:d,y:f}:Y(k-d)<O&&l-e>O?{x:d,y:Y(g-d)<O?r:e}:Y(l-e)<O&&k-c>O?{x:Y(r-e)<O?g:c,y:e}:null),h.site,null)),++q}}c={cells:sc,edges:ed};dd=Kd=ed=sc=null;return c}function Nf(a,b){return b.y-a.y||b.x-a.x}function se(a){return a.x}function Of(a){return a.y}
function yd(){return{leaf:!0,nodes:[],point:null,x:null,y:null}}function rb(a,b,c,d,e,f){if(!a(b,c,d,e,f)){var g=0.5*(c+e),k=0.5*(d+f);b=b.nodes;b[0]&&rb(a,b[0],c,d,g,k);b[1]&&rb(a,b[1],g,d,e,k);b[2]&&rb(a,b[2],c,k,g,f);b[3]&&rb(a,b[3],g,k,e,f)}}function Rc(a,b){a=A.rgb(a);b=A.rgb(b);var c=a.r,d=a.g,e=a.b,f=b.r-c,g=b.g-d,k=b.b-e;return function(a){return"#"+Ya(Math.round(c+f*a))+Ya(Math.round(d+g*a))+Ya(Math.round(e+k*a))}}function te(a,b){var c={},d={},e;for(e in a)e in b?c[e]=kb(a[e],b[e]):d[e]=
a[e];for(e in b)e in a||(d[e]=b[e]);return function(a){for(e in c)d[e]=c[e](a);return d}}function Ta(a,b){b-=a=+a;return function(c){return a+b*c}}function Sc(a,b){var c=lg.lastIndex=mg.lastIndex=0,d,e,f,g=-1,k=[],l=[];a+="";for(b+="";(d=lg.exec(a))&&(e=mg.exec(b));){if((f=e.index)>c)f=b.substring(c,f),k[g]?k[g]+=f:k[++g]=f;(d=d[0])===(e=e[0])?k[g]?k[g]+=e:k[++g]=e:(k[++g]=null,l.push({i:g,x:Ta(d,e)}));c=mg.lastIndex}c<b.length&&(f=b.substring(c),k[g]?k[g]+=f:k[++g]=f);return 2>k.length?l[0]?(b=l[0].x,
function(a){return b(a)+""}):function(){return b}:(b=l.length,function(a){for(var c=0,d;c<b;++c)k[(d=l[c]).i]=d.x(a);return k.join("")})}function kb(a,b){for(var c=A.interpolators.length,d;0<=--c&&!(d=A.interpolators[c](a,b)););return d}function lc(a,b){var c=[],d=[],e=a.length,f=b.length,g=Math.min(a.length,b.length),k;for(k=0;k<g;++k)c.push(kb(a[k],b[k]));for(;k<e;++k)d[k]=a[k];for(;k<f;++k)d[k]=b[k];return function(a){for(k=0;k<g;++k)d[k]=c[k](a);return d}}function ue(a){return function(b){return 0>=
b?0:1<=b?1:a(b)}}function Tc(a){return function(b){return 1-a(1-b)}}function Uc(a){return function(b){return 0.5*(0.5>b?a(2*b):2-a(2-2*b))}}function Pf(a){return a*a}function Qf(a){return a*a*a}function Rf(a){if(0>=a)return 0;if(1<=a)return 1;var b=a*a,c=b*a;return 4*(0.5>a?c:3*(a-b)+c-0.75)}function Sf(a){return 1-Math.cos(a*Fa)}function Tf(a){return Math.pow(2,10*(a-1))}function zd(a){return 1-Math.sqrt(1-a*a)}function Uf(a){return a<1/2.75?7.5625*a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+0.75:a<2.5/
2.75?7.5625*(a-=2.25/2.75)*a+0.9375:7.5625*(a-=2.625/2.75)*a+0.984375}function ve(a,b){b-=a;return function(c){return Math.round(a+b*c)}}function we(a){var b=[a.a,a.b],c=[a.c,a.d],d=xe(b),e=b[0]*c[0]+b[1]*c[1],f=-e;c[0]+=f*b[0];c[1]+=f*b[1];f=xe(c)||0;b[0]*c[1]<c[0]*b[1]&&(b[0]*=-1,b[1]*=-1,d*=-1,e*=-1);this.rotate=(d?Math.atan2(b[1],b[0]):Math.atan2(-c[0],c[1]))*pa;this.translate=[a.e,a.f];this.scale=[d,f];this.skew=f?Math.atan2(e,f)*pa:0}function xe(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]);b&&(a[0]/=
b,a[1]/=b);return b}function ye(a,b){var c=[],d=[],e,f=A.transform(a),g=A.transform(b),k=f.translate,l=g.translate,m=f.rotate,n=g.rotate,h=f.skew,p=g.skew,f=f.scale,g=g.scale;k[0]!=l[0]||k[1]!=l[1]?(c.push("translate(",null,",",null,")"),d.push({i:1,x:Ta(k[0],l[0])},{i:3,x:Ta(k[1],l[1])})):l[0]||l[1]?c.push("translate("+l+")"):c.push("");m!=n?(180<m-n?n+=360:180<n-m&&(m+=360),d.push({i:c.push(c.pop()+"rotate(",null,")")-2,x:Ta(m,n)})):n&&c.push(c.pop()+"rotate("+n+")");h!=p?d.push({i:c.push(c.pop()+
"skewX(",null,")")-2,x:Ta(h,p)}):p&&c.push(c.pop()+"skewX("+p+")");f[0]!=g[0]||f[1]!=g[1]?(e=c.push(c.pop()+"scale(",null,",",null,")"),d.push({i:e-4,x:Ta(f[0],g[0])},{i:e-2,x:Ta(f[1],g[1])})):(1!=g[0]||1!=g[1])&&c.push(c.pop()+"scale("+g+")");e=d.length;return function(a){for(var b=-1,f;++b<e;)c[(f=d[b]).i]=f.x(a);return c.join("")}}function Vf(a,b){b=b-(a=+a)?1/(b-a):0;return function(c){return(c-a)*b}}function Wf(a,b){b=b-(a=+a)?1/(b-a):0;return function(c){return Math.max(0,Math.min(1,(c-a)*b))}}
function Xf(a){var b=a.source;a=a.target;var c;var d=a;if(b===d)c=b;else{c=ze(b);for(var d=ze(d),e=c.pop(),f=d.pop(),g=null;e===f;)g=e,e=c.pop(),f=d.pop();c=g}for(d=[b];b!==c;)b=b.parent,d.push(b);for(b=d.length;a!==c;)d.splice(b,0,a),a=a.parent;return d}function ze(a){for(var b=[],c=a.parent;null!=c;)b.push(a),a=c,c=c.parent;b.push(a);return b}function db(a){a.fixed|=2}function sb(a){a.fixed&=-7}function mc(a){a.fixed|=4;a.px=a.x;a.py=a.y}function tb(a){a.fixed&=-5}function Vc(a,b,c){var d=0,e=0;
a.charge=0;if(!a.leaf)for(var f=a.nodes,g=f.length,k=-1,l;++k<g;)l=f[k],null!=l&&(Vc(l,b,c),a.charge+=l.charge,d+=l.charge*l.cx,e+=l.charge*l.cy);a.point&&(a.leaf||(a.point.x+=Math.random()-0.5,a.point.y+=Math.random()-0.5),b*=c[a.point.index],a.charge+=a.pointCharge=b,d+=b*a.point.x,e+=b*a.point.y);a.cx=d/a.charge;a.cy=e/a.charge}function ub(a,b){A.rebind(a,b,"sort","children","value");a.nodes=a;a.links=Xc;return a}function nc(a,b){for(var c=[a];null!=(a=c.pop());)if(b(a),(e=a.children)&&(d=e.length))for(var d,
e;0<=--d;)c.push(e[d])}function Pa(a,b){for(var c=[a],d=[];null!=(a=c.pop());)if(d.push(a),(g=a.children)&&(f=g.length))for(var e=-1,f,g;++e<f;)c.push(g[e]);for(;null!=(a=d.pop());)b(a)}function Ae(a){return a.children}function Be(a){return a.value}function Wc(a,b){return b.value-a.value}function Xc(a){return A.merge(a.map(function(a){return(a.children||[]).map(function(b){return{source:a,target:b}})}))}function Ad(a){return a.x}function Ce(a){return a.y}function De(a,b,c){a.y0=b;a.y=c}function Bd(a){return A.range(a.length)}
function Cd(a){var b=-1;a=a[0].length;for(var c=[];++b<a;)c[b]=0;return c}function Yf(a){for(var b=1,c=0,d=a[0][1],e,f=a.length;b<f;++b)if((e=a[b][1])>d)c=b,d=e;return c}function Ee(a){return a.reduce(Zf,0)}function Zf(a,b){return a+b[1]}function Yc(a,b){return Zc(a,Math.ceil(Math.log(b.length)/Math.LN2+1))}function Zc(a,b){for(var c=-1,d=+a[0],e=(a[1]-d)/b,f=[];++c<=b;)f[c]=e*c+d;return f}function $f(a){return[A.min(a),A.max(a)]}function Fe(a,b){return a.value-b.value}function Dd(a,b){var c=a._pack_next;
a._pack_next=b;b._pack_prev=a;b._pack_next=c;c._pack_prev=b}function Ge(a,b){a._pack_next=b;b._pack_prev=a}function He(a,b){var c=b.x-a.x,d=b.y-a.y,e=a.r+b.r;return 0.999*e*e>c*c+d*d}function Ie(a){function b(a){d=Math.min(a.x-a.r,d);e=Math.max(a.x+a.r,e);f=Math.min(a.y-a.r,f);g=Math.max(a.y+a.r,g)}if((c=a.children)&&(s=c.length)){var c,d=Infinity,e=-Infinity,f=Infinity,g=-Infinity,k,l,m,n,h,p,s;c.forEach(ag);k=c[0];k.x=-k.r;k.y=0;b(k);if(1<s&&(l=c[1],l.x=l.r,l.y=0,b(l),2<s)){m=c[2];Ke(k,l,m);b(m);
Dd(k,m);k._pack_prev=m;Dd(m,l);l=k._pack_next;for(n=3;n<s;n++){Ke(k,l,m=c[n]);var q=0,t=1,r=1;for(h=l._pack_next;h!==l;h=h._pack_next,t++)if(He(h,m)){q=1;break}if(1==q)for(p=k._pack_prev;p!==h._pack_prev&&!He(p,m);p=p._pack_prev,r++);q?(t<r||t==r&&l.r<k.r?Ge(k,l=h):Ge(k=p,l),n--):(Dd(k,m),l=m,b(m))}}k=(d+e)/2;l=(f+g)/2;for(n=h=0;n<s;n++)m=c[n],m.x-=k,m.y-=l,h=Math.max(h,m.r+Math.sqrt(m.x*m.x+m.y*m.y));a.r=h;c.forEach(bg)}}function ag(a){a._pack_next=a._pack_prev=a}function bg(a){delete a._pack_next;
delete a._pack_prev}function Je(a,b,c,d){var e=a.children;a.x=b+=d*a.x;a.y=c+=d*a.y;a.r*=d;if(e){a=-1;for(var f=e.length;++a<f;)Je(e[a],b,c,d)}}function Ke(a,b,c){var d=a.r+c.r,e=b.x-a.x,f=b.y-a.y;if(d&&(e||f)){var g=b.r+c.r,k=e*e+f*f,g=g*g,d=d*d;b=0.5+(d-g)/(2*k);g=Math.sqrt(Math.max(0,2*g*(d+k)-(d-=k)*d-g*g))/(2*k);c.x=a.x+b*e+g*f;c.y=a.y+b*f-g*e}else c.x=a.x+d,c.y=a.y}function Le(a,b){return a.parent==b.parent?1:2}function oc(a){var b=a.children;return b.length?b[0]:a.t}function Ed(a){var b=a.children,
c;return(c=b.length)?b[c-1]:a.t}function cg(a){return 1+A.max(a,function(a){return a.y})}function dg(a){return a.reduce(function(a,b){return a+b.x},0)/a.length}function Fd(a){var b=a.children;return b&&b.length?Fd(b[0]):a}function Gd(a){var b=a.children,c;return b&&(c=b.length)?Gd(b[c-1]):a}function $c(a){return{x:a.x,y:a.y,dx:a.dx,dy:a.dy}}function ad(a,b){var c=a.x+b[3],d=a.y+b[0],e=a.dx-b[1]-b[3],f=a.dy-b[0]-b[2];0>e&&(c+=e/2,e=0);0>f&&(d+=f/2,f=0);return{x:c,y:d,dx:e,dy:f}}function Rb(a){var b=
a[0];a=a[a.length-1];return b<a?[b,a]:[a,b]}function bd(a){return a.rangeExtent?a.rangeExtent():Rb(a.range())}function eg(a,b,c,d){var e=c(a[0],a[1]),f=d(b[0],b[1]);return function(a){return f(e(a))}}function pc(a,b){var c=0,d=a.length-1,e=a[c],f=a[d],g;f<e&&(g=c,c=d,d=g,g=e,e=f,f=g);a[c]=b.floor(e);a[d]=b.ceil(f);return a}function Hd(a){return a?{floor:function(b){return Math.floor(b/a)*a},ceil:function(b){return Math.ceil(b/a)*a}}:Jh}function Od(a,b,c,d){var e=[],f=[],g=0,k=Math.min(a.length,b.length)-
1;a[k]<a[0]&&(a=a.slice().reverse(),b=b.slice().reverse());for(;++g<=k;)e.push(c(a[g-1],a[g])),f.push(d(b[g-1],b[g]));return function(b){var c=A.bisect(a,b,1,k)-1;return f[c](e[c](b))}}function Cg(a,b,c,d){function e(){var l=2<Math.min(a.length,b.length)?Od:eg,m=d?Wf:Vf;g=l(a,b,m,c);k=l(b,a,m,kb);return f}function f(a){return g(a)}var g,k;f.invert=function(a){return k(a)};f.domain=function(b){if(!arguments.length)return a;a=b.map(Number);return e()};f.range=function(a){if(!arguments.length)return b;
b=a;return e()};f.rangeRound=function(a){return f.range(a).interpolate(ve)};f.clamp=function(a){if(!arguments.length)return d;d=a;return e()};f.interpolate=function(a){if(!arguments.length)return c;c=a;return e()};f.ticks=function(b){return A.range.apply(A,Fb(a,b))};f.tickFormat=function(b,c){return sf(a,b,c)};f.nice=function(b){pc(a,Hd(Fb(a,b)[2]));return e()};f.copy=function(){return Cg(a,b,c,d)};return e()}function rf(a,b){return A.rebind(a,b,"range","rangeRound","interpolate","clamp")}function Fb(a,
b){null==b&&(b=10);var c=Rb(a),d=c[1]-c[0],e=Math.pow(10,Math.floor(Math.log(d/b)/Math.LN10)),d=b/d*e;0.15>=d?e*=10:0.35>=d?e*=5:0.75>=d&&(e*=2);c[0]=Math.ceil(c[0]/e)*e;c[1]=Math.floor(c[1]/e)*e+0.5*e;c[2]=e;return c}function sf(a,b,c){a=Fb(a,b);if(c){b=Tg.exec(c);b.shift();if("s"===b[8]){var d=A.formatPrefix(Math.max(Y(a[0]),Y(a[1])));b[7]||(b[7]="."+Md(d.scale(a[2])));b[8]="f";c=A.format(b.join(""));return function(a){return c(d.scale(a))+d.symbol}}b[7]||(b[7]="."+Eh(b[8],a));c=b.join("")}else c=
",."+Md(a[2])+"f";return A.format(c)}function Md(a){return-Math.floor(Math.log(a)/Math.LN10+0.01)}function Eh(a,b){var c=Md(b[2]);return a in Kh?Math.abs(c-Md(Math.max(Y(b[0]),Y(b[1]))))+ +("e"!==a):c-2*("%"===a)}function Dg(a,b,c,d){function e(a){return(c?Math.log(0>a?0:a):-Math.log(0<a?0:-a))/Math.log(b)}function f(a){return c?Math.pow(b,a):-Math.pow(b,-a)}function g(b){return a(e(b))}g.invert=function(b){return f(a.invert(b))};g.domain=function(b){if(!arguments.length)return d;c=0<=b[0];a.domain((d=
b.map(Number)).map(e));return g};g.base=function(c){if(!arguments.length)return b;b=+c;a.domain(d.map(e));return g};g.nice=function(){var b=pc(d.map(e),c?Math:Lh);a.domain(b);d=b.map(f);return g};g.ticks=function(){var a=Rb(d),g=[],k=a[0],a=a[1],l=Math.floor(e(k)),m=Math.ceil(e(a)),n=b%1?2:b;if(isFinite(m-l)){if(c){for(;l<m;l++)for(var h=1;h<n;h++)g.push(f(l)*h);g.push(f(l))}else for(g.push(f(l));l++<m;)for(h=n-1;0<h;h--)g.push(f(l)*h);for(l=0;g[l]<k;l++);for(m=g.length;g[m-1]>a;m--);g=g.slice(l,
m)}return g};g.tickFormat=function(a,b){if(!arguments.length)return $g;2>arguments.length?b=$g:"function"!==typeof b&&(b=A.format(b));var d=Math.max(0.1,a/g.ticks().length),k=c?(l=1E-12,Math.ceil):(l=-1E-12,Math.floor),l;return function(a){return a/f(k(e(a)+l))<=d?b(a):""}};g.copy=function(){return Dg(a.copy(),b,c,d)};return rf(g,a)}function Eg(a,b,c){function d(b){return a(e(b))}var e=Nd(b),f=Nd(1/b);d.invert=function(b){return f(a.invert(b))};d.domain=function(b){if(!arguments.length)return c;a.domain((c=
b.map(Number)).map(e));return d};d.ticks=function(a){return A.range.apply(A,Fb(c,a))};d.tickFormat=function(a,b){return sf(c,a,b)};d.nice=function(a){return d.domain(pc(c,Hd(Fb(c,a)[2])))};d.exponent=function(g){if(!arguments.length)return b;e=Nd(b=g);f=Nd(1/b);a.domain(c.map(e));return d};d.copy=function(){return Eg(a.copy(),b,c)};return rf(d,a)}function Nd(a){return function(b){return 0>b?-Math.pow(-b,a):Math.pow(b,a)}}function Fg(a,b){function c(d){return g[((f.get(d)||("range"===b.t?f.set(d,a.push(d)):
NaN))-1)%g.length]}function d(b,c){return A.range(a.length).map(function(a){return b+c*a})}var f,g,k;c.domain=function(d){if(!arguments.length)return a;a=[];f=new e;for(var g=-1,k=d.length,l;++g<k;)f.has(l=d[g])||f.set(l,a.push(l));return c[b.t].apply(c,b.a)};c.range=function(a){if(!arguments.length)return g;g=a;k=0;b={t:"range",a:arguments};return c};c.rangePoints=function(e,f){2>arguments.length&&(f=0);var l=e[0],m=e[1],n=(m-l)/(Math.max(1,a.length-1)+f);g=d(2>a.length?(l+m)/2:l+n*f/2,n);k=0;b=
{t:"rangePoints",a:arguments};return c};c.rangeBands=function(e,f,l){2>arguments.length&&(f=0);3>arguments.length&&(l=f);var m=e[1]<e[0],n=e[m-0],h=(e[1-m]-n)/(a.length-f+2*l);g=d(n+h*l,h);m&&g.reverse();k=h*(1-f);b={t:"rangeBands",a:arguments};return c};c.rangeRoundBands=function(e,f,l){2>arguments.length&&(f=0);3>arguments.length&&(l=f);var m=e[1]<e[0],n=e[m-0],h=e[1-m],p=Math.floor((h-n)/(a.length-f+2*l));g=d(n+Math.round((h-n-(a.length-f)*p)/2),p);m&&g.reverse();k=Math.round(p*(1-f));b={t:"rangeRoundBands",
a:arguments};return c};c.rangeBand=function(){return k};c.rangeExtent=function(){return Rb(b.a[0])};c.copy=function(){return Fg(a,b)};return c.domain(a)}function Gg(a,c){function d(){var b=0,g=c.length;for(f=[];++b<g;)f[b-1]=A.quantile(a,b/g);return e}function e(a){if(!isNaN(a=+a))return c[A.bisect(f,a)]}var f;e.domain=function(c){if(!arguments.length)return a;a=c.filter(b).sort(h);return d()};e.range=function(a){if(!arguments.length)return c;c=a;return d()};e.quantiles=function(){return f};e.invertExtent=
function(b){b=c.indexOf(b);return 0>b?[NaN,NaN]:[0<b?f[b-1]:a[0],b<f.length?f[b]:a[a.length-1]]};e.copy=function(){return Gg(a,c)};return d()}function Hg(a,b,c){function d(b){return c[Math.max(0,Math.min(g,Math.floor(f*(b-a))))]}function e(){f=c.length/(b-a);g=c.length-1;return d}var f,g;d.domain=function(c){if(!arguments.length)return[a,b];a=+c[0];b=+c[c.length-1];return e()};d.range=function(a){if(!arguments.length)return c;c=a;return e()};d.invertExtent=function(b){b=c.indexOf(b);b=0>b?NaN:b/f+
a;return[b,b+1/f]};d.copy=function(){return Hg(a,b,c)};return e()}function Ig(a,b){function c(d){if(d<=d)return b[A.bisect(a,d)]}c.domain=function(b){if(!arguments.length)return a;a=b;return c};c.range=function(a){if(!arguments.length)return b;b=a;return c};c.invertExtent=function(c){c=b.indexOf(c);return[a[c-1],a[c]]};c.copy=function(){return Ig(a,b)};return c}function Jg(a){function b(a){return+a}b.invert=b;b.domain=b.range=function(c){if(!arguments.length)return a;a=c.map(b);return b};b.ticks=
function(b){return A.range.apply(A,Fb(a,b))};b.tickFormat=function(b,c){return sf(a,b,c)};b.copy=function(){return Jg(a)};return b}function Fh(a){return a.innerRadius}function Gh(a){return a.outerRadius}function Kg(a){return a.startAngle}function Lg(a){return a.endAngle}function Mg(a){function b(g){function l(){m.push("M",f(a(n),k))}for(var m=[],n=[],h=-1,p=g.length,s,q=ga(c),t=ga(d);++h<p;)e.call(this,s=g[h],h)?n.push([+q.call(this,s,h),+t.call(this,s,h)]):n.length&&(l(),n=[]);n.length&&l();return m.length?
m.join(""):null}var c=Ja,d=Oa,e=pb,f=Na,g=f.key,k=0.7;b.x=function(a){if(!arguments.length)return c;c=a;return b};b.y=function(a){if(!arguments.length)return d;d=a;return b};b.defined=function(a){if(!arguments.length)return e;e=a;return b};b.interpolate=function(a){if(!arguments.length)return g;g="function"===typeof a?f=a:(f=ng.get(a)||Na).key;return b};b.tension=function(a){if(!arguments.length)return k;k=a;return b};return b}function Na(a){return a.join("L")}function tf(a){for(var b=0,c=a.length,
d=a[0],e=[d[0],",",d[1]];++b<c;)e.push("V",(d=a[b])[1],"H",d[0]);return e.join("")}function uf(a){for(var b=0,c=a.length,d=a[0],e=[d[0],",",d[1]];++b<c;)e.push("H",(d=a[b])[0],"V",d[1]);return e.join("")}function Pd(a,b){if(1>b.length||a.length!=b.length&&a.length!=b.length+2)return Na(a);var c=a.length!=b.length,d="",e=a[0],f=a[1],g=b[0],k=g,l=1;c&&(d+="Q"+(f[0]-2*g[0]/3)+","+(f[1]-2*g[1]/3)+","+f[0]+","+f[1],e=a[1],l=2);if(1<b.length){k=b[1];f=a[l];l++;d+="C"+(e[0]+g[0])+","+(e[1]+g[1])+","+(f[0]-
k[0])+","+(f[1]-k[1])+","+f[0]+","+f[1];for(e=2;e<b.length;e++,l++)f=a[l],k=b[e],d+="S"+(f[0]-k[0])+","+(f[1]-k[1])+","+f[0]+","+f[1]}c&&(c=a[l],d+="Q"+(f[0]+2*k[0]/3)+","+(f[1]+2*k[1]/3)+","+c[0]+","+c[1]);return d}function og(a,b){for(var c=[],d=(1-b)/2,e,f=a[0],g=a[1],k=1,l=a.length;++k<l;)e=f,f=g,g=a[k],c.push([d*(g[0]-e[0]),d*(g[1]-e[1])]);return c}function ah(a){if(3>a.length)return Na(a);var b=1,c=a.length,d=a[0],e=d[0],f=d[1],g=[e,e,e,(d=a[1])[0]],k=[f,f,f,d[1]],e=[e,",",f,"L",Wa(Xb,g),",",
Wa(Xb,k)];for(a.push(a[c-1]);++b<=c;)d=a[b],g.shift(),g.push(d[0]),k.shift(),k.push(d[1]),pg(e,g,k);a.pop();e.push("L",d);return e.join("")}function Wa(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]}function pg(a,b,c){a.push("C",Wa(bh,b),",",Wa(bh,c),",",Wa(ch,b),",",Wa(ch,c),",",Wa(Xb,b),",",Wa(Xb,c))}function qg(a,b){return(b[1]-a[1])/(b[0]-a[0])}function dh(a){for(var b,c=-1,d=a.length,e,f;++c<d;)b=a[c],e=b[0],f=b[1]+tc,b[0]=e*Math.cos(f),b[1]=e*Math.sin(f);return a}function eh(a){function b(l){function p(){s.push("M",
k(a(t),h),n,m(a(q.reverse()),h),"Z")}for(var s=[],q=[],t=[],r=-1,v=l.length,u,y=ga(c),va=ga(e),z=c===d?function(){return x}:ga(d),B=e===f?function(){return w}:ga(f),x,w;++r<v;)g.call(this,u=l[r],r)?(q.push([x=+y.call(this,u,r),w=+va.call(this,u,r)]),t.push([+z.call(this,u,r),+B.call(this,u,r)])):q.length&&(p(),q=[],t=[]);q.length&&p();return s.length?s.join(""):null}var c=Ja,d=Ja,e=0,f=Oa,g=pb,k=Na,l=k.key,m=k,n="L",h=0.7;b.x=function(a){if(!arguments.length)return d;c=d=a;return b};b.x0=function(a){if(!arguments.length)return c;
c=a;return b};b.x1=function(a){if(!arguments.length)return d;d=a;return b};b.y=function(a){if(!arguments.length)return f;e=f=a;return b};b.y0=function(a){if(!arguments.length)return e;e=a;return b};b.y1=function(a){if(!arguments.length)return f;f=a;return b};b.defined=function(a){if(!arguments.length)return g;g=a;return b};b.interpolate=function(a){if(!arguments.length)return l;l="function"===typeof a?k=a:(k=ng.get(a)||Na).key;m=k.reverse||k;n=k.closed?"M":"L";return b};b.tension=function(a){if(!arguments.length)return h;
h=a;return b};return b}function Mh(a){return a.radius}function fh(a){return[a.x,a.y]}function Nh(a){return function(){var b=a.apply(this,arguments),c=b[0],b=b[1]+tc;return[c*Math.cos(b),c*Math.sin(b)]}}function Oh(){return 64}function Ph(){return"circle"}function gh(a){a=Math.sqrt(a/V);return"M0,"+a+"A"+a+","+a+" 0 1,1 0,"+-a+"A"+a+","+a+" 0 1,1 0,"+a+"Z"}function Ld(a,b){Pe(a,Aa);a.id=b;return a}function rg(a,b,c,d){var e=a.id;return N(a,"function"===typeof c?function(a,f,g){a.__transition__[e].tween.set(b,
d(c.call(a,a.__data__,f,g)))}:(c=d(c),function(a){a.__transition__[e].tween.set(b,c)}))}function Qh(a){null==a&&(a="");return function(){this.textContent=a}}function Ye(a,b,c,d){var f=a.__transition__||(a.__transition__={active:0,count:0}),g=f[c];if(!g){var k=d.time,g=f[c]={tween:new e,time:k,ease:d.ease,delay:d.delay,duration:d.duration};++f.count;A.timer(function(d){function e(d){if(f.active>c)return m();f.active=c;g.event&&g.event.start.call(a,n,b);g.tween.forEach(function(c,d){(d=d.call(a,n,b))&&
t.push(d)});A.timer(function(){q.c=l(d||1)?pb:l;return 1},0,k)}function l(d){if(f.active!==c)return m();d/=s;for(var e=h(d),k=t.length;0<k;)t[--k].call(a,e);if(1<=d)return g.event&&g.event.end.call(a,n,b),m()}function m(){--f.count?delete f[c]:delete a.__transition__;return 1}var n=a.__data__,h=g.ease,p=g.delay,s=g.duration,q=wb,t=[];q.t=p+k;if(p<=d)return e(d-p);q.c=e},0,k)}}function hh(a,b){a.attr("transform",function(a){return"translate("+b(a)+",0)"})}function ih(a,b){a.attr("transform",function(a){return"translate(0,"+
b(a)+")"})}function sg(a){return a.toISOString()}function tg(a,b,c){function d(b){return a(b)}function e(a,c){var d=(a[1]-a[0])/c,f=A.bisect(Ze,d);return f==Ze.length?[b.year,Fb(a.map(function(a){return a/31536E6}),c)[2]]:!f?[Rh,Fb(a,c)[2]]:b[d/Ze[f-1]<Ze[f]/d?f-1:f]}d.invert=function(b){return uc(a.invert(b))};d.domain=function(b){if(!arguments.length)return a.domain().map(uc);a.domain(b);return d};d.nice=function(a,b){function c(d){return!isNaN(d)&&!a.range(d,uc(+d+1),b).length}var f=d.domain(),
g=Rb(f);if(g=null==a?e(g,10):"number"===typeof a&&e(g,a))a=g[0],b=g[1];return d.domain(pc(f,1<b?{floor:function(b){for(;c(b=a.floor(b));)b=uc(b-1);return b},ceil:function(b){for(;c(b=a.ceil(b));)b=uc(+b+1);return b}}:a))};d.ticks=function(a,b){var c=Rb(d.domain()),f=null==a?e(c,10):"number"===typeof a?e(c,a):!a.range&&[{range:a},b];f&&(a=f[0],b=f[1]);return a.range(c[0],uc(+c[1]+1),1>b?1:b)};d.tickFormat=function(){return c};d.copy=function(){return tg(a.copy(),b,c)};return rf(d,a)}function uc(a){return new Date(a)}
function Sh(a){return JSON.parse(a.responseText)}function Th(a){var b=hb.createRange();b.selectNode(hb.body);return b.createContextualFragment(a.responseText)}var A={version:"3.4.8"};Date.now||(Date.now=function(){return+new Date});var jh=[].slice,Sb=function(a){return jh.call(a)},hb=document,Tb=hb.documentElement,Qa=window;try{Sb(Tb.childNodes)[0].nodeType}catch(si){Sb=function(a){for(var b=a.length,c=Array(b);b--;)c[b]=a[b];return c}}try{hb.createElement("div").style.setProperty("opacity",0,"")}catch(ti){var $e=
Qa.Element.prototype,Uh=$e.setAttribute,Vh=$e.setAttributeNS,kh=Qa.CSSStyleDeclaration.prototype,Wh=kh.setProperty;$e.setAttribute=function(a,b){Uh.call(this,a,b+"")};$e.setAttributeNS=function(a,b,c){Vh.call(this,a,b,c+"")};kh.setProperty=function(a,b,c){Wh.call(this,a,b+"",c)}}A.ascending=h;A.descending=function(a,b){return b<a?-1:b>a?1:b>=a?0:NaN};A.min=function(a,b){var c=-1,d=a.length,e,f;if(1===arguments.length){for(;++c<d&&!(null!=(e=a[c])&&e<=e);)e=void 0;for(;++c<d;)if(null!=(f=a[c])&&e>
f)e=f}else{for(;++c<d&&!(null!=(e=b.call(a,a[c],c))&&e<=e);)e=void 0;for(;++c<d;)if(null!=(f=b.call(a,a[c],c))&&e>f)e=f}return e};A.max=function(a,b){var c=-1,d=a.length,e,f;if(1===arguments.length){for(;++c<d&&!(null!=(e=a[c])&&e<=e);)e=void 0;for(;++c<d;)if(null!=(f=a[c])&&f>e)e=f}else{for(;++c<d&&!(null!=(e=b.call(a,a[c],c))&&e<=e);)e=void 0;for(;++c<d;)if(null!=(f=b.call(a,a[c],c))&&f>e)e=f}return e};A.extent=function(a,b){var c=-1,d=a.length,e,f,g;if(1===arguments.length){for(;++c<d&&!(null!=
(e=g=a[c])&&e<=e);)e=g=void 0;for(;++c<d;)if(null!=(f=a[c]))e>f&&(e=f),g<f&&(g=f)}else{for(;++c<d&&!(null!=(e=g=b.call(a,a[c],c))&&e<=e);)e=void 0;for(;++c<d;)if(null!=(f=b.call(a,a[c],c)))e>f&&(e=f),g<f&&(g=f)}return[e,g]};A.sum=function(a,b){var c=0,d=a.length,e,f=-1;if(1===arguments.length)for(;++f<d;){if(!isNaN(e=+a[f]))c+=e}else for(;++f<d;)if(!isNaN(e=+b.call(a,a[f],f)))c+=e;return c};A.mean=function(a,c){var d=0,e=a.length,f,g=-1,k=e;if(1===arguments.length)for(;++g<e;)b(f=a[g])?d+=f:--k;else for(;++g<
e;)b(f=c.call(a,a[g],g))?d+=f:--k;return k?d/k:void 0};A.quantile=function(a,b){var c=(a.length-1)*b+1,d=Math.floor(c),e=+a[d-1];return(c-=d)?e+c*(a[d]-e):e};A.median=function(a,c){1<arguments.length&&(a=a.map(c));a=a.filter(b);return a.length?A.quantile(a.sort(h),0.5):void 0};var lh=a(h);A.bisectLeft=lh.left;A.bisect=A.bisectRight=lh.right;A.bisector=function(b){return a(1===b.length?function(a,c){return h(b(a),c)}:b)};A.shuffle=function(a){for(var b=a.length,c,d;b;)d=Math.random()*b--|0,c=a[b],
a[b]=a[d],a[d]=c;return a};A.permute=function(a,b){for(var c=b.length,d=Array(c);c--;)d[c]=a[b[c]];return d};A.pairs=function(a){for(var b=0,c=a.length-1,d=a[0],e=Array(0>c?0:c);b<c;)e[b]=[d,d=a[++b]];return e};A.zip=function(){if(!(f=arguments.length))return[];for(var a=-1,b=A.min(arguments,c),d=Array(b);++a<b;)for(var e=-1,f,g=d[a]=Array(f);++e<f;)g[e]=arguments[e][a];return d};A.transpose=function(a){return A.zip.apply(A,a)};A.keys=function(a){var b=[],c;for(c in a)b.push(c);return b};A.values=
function(a){var b=[],c;for(c in a)b.push(a[c]);return b};A.entries=function(a){var b=[],c;for(c in a)b.push({key:c,value:a[c]});return b};A.merge=function(a){var b=a.length,c;c=-1;for(var d=0,e,f;++c<b;)d+=a[c].length;for(e=Array(d);0<=--b;){f=a[b];for(c=f.length;0<=--c;)e[--d]=f[c]}return e};var Y=Math.abs;A.range=function(a,b,c){3>arguments.length&&(c=1,2>arguments.length&&(b=a,a=0));if(Infinity===(b-a)/c)throw Error("infinite range");var d=[],e;e=Y(c);for(var f=1;e*f%1;)f*=10;e=f;var f=-1,g;a*=
e;b*=e;c*=e;if(0>c)for(;(g=a+c*++f)>b;)d.push(g/e);else for(;(g=a+c*++f)<b;)d.push(g/e);return d};A.map=function(a){var b=new e;if(a instanceof e)a.forEach(function(a,c){b.set(a,c)});else for(var c in a)b.set(c,a[c]);return b};f(e,{has:g,get:function(a){return this[qc+a]},set:function(a,b){return this[qc+a]=b},remove:function(a){a=qc+a;return a in this&&delete this[a]},keys:d,values:function(){var a=[];this.forEach(function(b,c){a.push(c)});return a},entries:function(){var a=[];this.forEach(function(b,
c){a.push({key:b,value:c})});return a},size:l,empty:m,forEach:function(a){for(var b in this)b.charCodeAt(0)===Oe&&a.call(this,b.substring(1),this[b])}});var qc="\x00",Oe=qc.charCodeAt(0);A.nest=function(){function a(b,f,l){if(l>=d.length)return k?k.call(c,f):g?f.sort(g):f;for(var m=-1,n=f.length,h=d[l++],p,s,q=new e,t;++m<n;)(t=q.get(p=h(s=f[m])))?t.push(s):q.set(p,[s]);b?(s=b(),f=function(c,d){s.set(c,a(b,d,l))}):(s={},f=function(c,d){s[c]=a(b,d,l)});q.forEach(f);return s}function b(a,c){if(c>=d.length)return a;
var e=[],g=f[c++];a.forEach(function(a,d){e.push({key:a,values:b(d,c)})});return g?e.sort(function(a,b){return g(a.key,b.key)}):e}var c={},d=[],f=[],g,k;c.map=function(b,c){return a(c,b,0)};c.entries=function(c){return b(a(A.map,c,0),0)};c.key=function(a){d.push(a);return c};c.sortKeys=function(a){f[d.length-1]=a;return c};c.sortValues=function(a){g=a;return c};c.rollup=function(a){k=a;return c};return c};A.set=function(a){var b=new k;if(a)for(var c=0,d=a.length;c<d;++c)b.add(a[c]);return b};f(k,
{has:g,add:function(a){this[qc+a]=!0;return a},remove:function(a){a=qc+a;return a in this&&delete this[a]},values:d,size:l,empty:m,forEach:function(a){for(var b in this)b.charCodeAt(0)===Oe&&a.call(this,b.substring(1))}});A.behavior={};A.rebind=function(a,b){for(var c=1,d=arguments.length,e;++c<d;)a[e=arguments[c]]=n(a,b,b[e]);return a};var Ng="webkit ms moz Moz o O".split(" ");A.dispatch=function(){for(var a=new r,b=-1,c=arguments.length;++b<c;)a[arguments[b]]=t(a);return a};r.prototype.on=function(a,
b){var c=a.indexOf("."),d="";0<=c&&(d=a.substring(c+1),a=a.substring(0,c));if(a)return 2>arguments.length?this[a].on(d):this[a].on(d,b);if(2===arguments.length){if(null==b)for(a in this)if(this.hasOwnProperty(a))this[a].on(d,null);return this}};A.event=null;A.requote=function(a){return a.replace(Xh,"\\$&")};var Xh=/[\\\^\$\*\+\?\|\[\]\(\)\.\{\}]/g,Pe={}.__proto__?function(a,b){a.__proto__=b}:function(a,b){for(var c in b)a[c]=b[c]},fg=function(a,b){return b.querySelector(a)},gg=function(a,b){return b.querySelectorAll(a)},
Yh=Tb[s(Tb,"matchesSelector")],Og=function(a,b){return Yh.call(a,b)};"function"===typeof Sizzle&&(fg=function(a,b){return Sizzle(a,b)[0]||null},gg=Sizzle,Og=Sizzle.matchesSelector);A.selection=function(){return mh};var fa=A.selection.prototype=[];fa.select=function(a){var b=[],c,d,e,f;a=u(a);for(var g=-1,k=this.length;++g<k;){b.push(c=[]);c.parentNode=(e=this[g]).parentNode;for(var l=-1,m=e.length;++l<m;)(f=e[l])?(c.push(d=a.call(f,f.__data__,l,g)),d&&"__data__"in f&&(d.__data__=f.__data__)):c.push(null)}return B(b)};
fa.selectAll=function(a){var b=[],c,d;a=z(a);for(var e=-1,f=this.length;++e<f;)for(var g=this[e],k=-1,l=g.length;++k<l;)if(d=g[k])b.push(c=Sb(a.call(d,d.__data__,k,e))),c.parentNode=d;return B(b)};var ug={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};A.ns={prefix:ug,qualify:function(a){var b=a.indexOf(":"),c=a;0<=b&&(c=a.substring(0,b),a=a.substring(b+1));
return ug.hasOwnProperty(c)?{space:ug[c],local:a}:a}};fa.attr=function(a,b){if(2>arguments.length){if("string"===typeof a){var c=this.node();a=A.ns.qualify(a);return a.local?c.getAttributeNS(a.space,a.local):c.getAttribute(a)}for(b in a)this.each(C(b,a[b]));return this}return this.each(C(a,b))};fa.classed=function(a,b){if(2>arguments.length){if("string"===typeof a){var c=this.node(),d=(a=a.trim().split(/^|\s+/)).length,e=-1;if(b=c.classList)for(;++e<d;){if(!b.contains(a[e]))return!1}else for(b=c.getAttribute("class");++e<
d;)if(!x(a[e]).test(b))return!1;return!0}for(b in a)this.each(w(b,a[b]));return this}return this.each(w(a,b))};fa.style=function(a,b,c){var d=arguments.length;if(3>d){if("string"!==typeof a){2>d&&(b="");for(c in a)this.each(M(c,a[c],b));return this}if(2>d)return Qa.getComputedStyle(this.node(),null).getPropertyValue(a);c=""}return this.each(M(a,b,c))};fa.property=function(a,b){if(2>arguments.length){if("string"===typeof a)return this.node()[a];for(b in a)this.each(K(b,a[b]));return this}return this.each(K(a,
b))};fa.text=function(a){return arguments.length?this.each("function"===typeof a?function(){var b=a.apply(this,arguments);this.textContent=null==b?"":b}:null==a?function(){this.textContent=""}:function(){this.textContent=a}):this.node().textContent};fa.html=function(a){return arguments.length?this.each("function"===typeof a?function(){var b=a.apply(this,arguments);this.innerHTML=null==b?"":b}:null==a?function(){this.innerHTML=""}:function(){this.innerHTML=a}):this.node().innerHTML};fa.append=function(a){a=
H(a);return this.select(function(){return this.appendChild(a.apply(this,arguments))})};fa.insert=function(a,b){a=H(a);b=u(b);return this.select(function(){return this.insertBefore(a.apply(this,arguments),b.apply(this,arguments)||null)})};fa.remove=function(){return this.each(function(){var a=this.parentNode;a&&a.removeChild(this)})};fa.data=function(a,b){function c(a,d){var f,g=a.length,k=d.length,h=Math.min(g,k),p=Array(k),s=Array(k),q=Array(g),t,r;if(b){var h=new e,ha=new e,v=[],u;for(f=-1;++f<
g;)u=b.call(t=a[f],t.__data__,f),h.has(u)?q[f]=t:h.set(u,t),v.push(u);for(f=-1;++f<k;)u=b.call(d,r=d[f],f),(t=h.get(u))?(p[f]=t,t.__data__=r):ha.has(u)||(s[f]={__data__:r}),ha.set(u,r),h.remove(u);for(f=-1;++f<g;)h.has(v[f])&&(q[f]=a[f])}else{for(f=-1;++f<h;)t=a[f],r=d[f],t?(t.__data__=r,p[f]=t):s[f]={__data__:r};for(;f<k;++f)s[f]={__data__:d[f]};for(;f<g;++f)q[f]=a[f]}s.update=p;s.parentNode=p.parentNode=q.parentNode=a.parentNode;l.push(s);m.push(p);n.push(q)}var d=-1,f=this.length,g,k;if(!arguments.length){for(a=
Array(f=(g=this[0]).length);++d<f;)if(k=g[d])a[d]=k.__data__;return a}var l=I([]),m=B([]),n=B([]);if("function"===typeof a)for(;++d<f;)c(g=this[d],a.call(g,g.parentNode.__data__,d));else for(;++d<f;)c(g=this[d],a);m.enter=function(){return l};m.exit=function(){return n};return m};fa.datum=function(a){return arguments.length?this.property("__data__",a):this.property("__data__")};fa.filter=function(a){var b=[],c,d,e;"function"!==typeof a&&(a=L(a));for(var f=0,g=this.length;f<g;f++){b.push(c=[]);c.parentNode=
(d=this[f]).parentNode;for(var k=0,l=d.length;k<l;k++)(e=d[k])&&a.call(e,e.__data__,k,f)&&c.push(e)}return B(b)};fa.order=function(){for(var a=-1,b=this.length;++a<b;)for(var c=this[a],d=c.length-1,e=c[d],f;0<=--d;)if(f=c[d])e&&e!==f.nextSibling&&e.parentNode.insertBefore(f,e),e=f;return this};fa.sort=function(a){a=E.apply(this,arguments);for(var b=-1,c=this.length;++b<c;)this[b].sort(a);return this.order()};fa.each=function(a){return N(this,function(b,c,d){a.call(b,b.__data__,c,d)})};fa.call=function(a){var b=
Sb(arguments);a.apply(b[0]=this,b);return this};fa.empty=function(){return!this.node()};fa.node=function(){for(var a=0,b=this.length;a<b;a++)for(var c=this[a],d=0,e=c.length;d<e;d++){var f=c[d];if(f)return f}return null};fa.size=function(){var a=0;this.each(function(){++a});return a};var vb=[];A.selection.enter=I;A.selection.enter.prototype=vb;vb.append=fa.append;vb.empty=fa.empty;vb.node=fa.node;vb.call=fa.call;vb.size=fa.size;vb.select=function(a){for(var b=[],c,d,e,f,g,k=-1,l=this.length;++k<l;){e=
(f=this[k]).update;b.push(c=[]);c.parentNode=f.parentNode;for(var m=-1,n=f.length;++m<n;)(g=f[m])?(c.push(e[m]=d=a.call(f.parentNode,g.__data__,m,k)),d.__data__=g.__data__):c.push(null)}return B(b)};vb.insert=function(a,b){2>arguments.length&&(b=D(this));return fa.insert.call(this,a,b)};fa.transition=function(){for(var a=vc||++nh,b=[],c,d,e=af||{time:Date.now(),ease:Rf,delay:0,duration:250},f=-1,g=this.length;++f<g;){b.push(c=[]);for(var k=this[f],l=-1,m=k.length;++l<m;)(d=k[l])&&Ye(d,l,a,e),c.push(d)}return Ld(b,
a)};fa.interrupt=function(){return this.each(Z)};A.select=function(a){a=["string"===typeof a?fg(a,hb):a];a.parentNode=Tb;return B([a])};A.selectAll=function(a){a=Sb("string"===typeof a?gg(a,hb):a);a.parentNode=Tb;return B([a])};var mh=A.select(Tb);fa.on=function(a,b,c){var d=arguments.length;if(3>d){if("string"!==typeof a){2>d&&(b=!1);for(c in a)this.each(ia(c,a[c],b));return this}if(2>d)return(d=this.node()["__on"+a])&&d._;c=!1}return this.each(ia(a,b,c))};var ig=A.map({mouseenter:"mouseover",mouseleave:"mouseout"});
ig.forEach(function(a){"on"+a in hb&&ig.remove(a)});var Id="onselectstart"in hb?null:s(Tb.style,"userSelect"),Hh=0;A.mouse=function(a){return wa(a,y())};A.touches=function(a,b){2>arguments.length&&(b=y().touches);return b?Sb(b).map(function(b){var c=wa(a,b);c.identifier=b.identifier;return c}):[]};A.behavior.drag=function(){function a(){this.on("mousedown.drag",e).on("touchstart.drag",f)}function b(a,e,f,g,k){return function(){var b=A.event.target,l=this.parentNode,m=c.of(this,arguments),n=0,h=a(),
p=".drag"+(null==h?"":"-"+h),s,q=A.select(f()).on(g+p,function(){var a=e(l,h),b,c;a&&(b=a[0]-r[0],c=a[1]-r[1],n|=b|c,r=a,m({type:"drag",x:a[0]+s[0],y:a[1]+s[1],dx:b,dy:c}))}).on(k+p,function(){e(l,h)&&(q.on(g+p,null).on(k+p,null),t(n&&A.event.target===b),m({type:"dragend"}))}),t=P(),r=e(l,h);d?(s=d.apply(this,arguments),s=[s.x-r[0],s.y-r[1]]):s=[0,0];m({type:"dragstart"})}}var c=q(a,"drag","dragstart","dragend"),d=null,e=b(p,A.mouse,S,"mousemove","mouseup"),f=b(ja,A.touch,ba,"touchmove","touchend");
a.origin=function(b){if(!arguments.length)return d;d=b;return a};return A.rebind(a,c,"on")};var V=Math.PI,Sa=2*V,Fa=V/2,O=1E-6,jg=O*O,X=V/180,pa=180/V,bf=Math.SQRT2,vg=2;A.interpolateZoom=function(a,b){function c(a){var b=a*q;if(s){a=na(p);var g=f/(vg*n),m,h=bf*b+p;m=((h=Math.exp(2*h))-1)/(h+1);m*=a;var t=p,h=((t=Math.exp(t))-1/t)/2,g=g*(m-h);return[d+g*k,e+g*l,f*a/na(bf*b+p)]}return[d+a*k,e+a*l,f*Math.exp(bf*b)]}var d=a[0],e=a[1],f=a[2],g=b[2],k=b[0]-d,l=b[1]-e,m=k*k+l*l,n=Math.sqrt(m),h=(g*g-f*
f+4*m)/(2*f*vg*n),m=(g*g-f*f-4*m)/(2*g*vg*n),p=Math.log(Math.sqrt(h*h+1)-h),s=Math.log(Math.sqrt(m*m+1)-m)-p,q=(s||Math.log(g/f))/bf;c.duration=1E3*q;return c};A.behavior.zoom=function(){function a(b){b.on(z,l).on(Zh+".zoom",n).on(B,h).on("dblclick.zoom",p).on(C,m)}function b(a){return[(a[0]-s.x)/s.k,(a[1]-s.y)/s.k]}function c(a){s.k=Math.max(y[0],Math.min(y[1],a))}function d(a,b){b=[b[0]*s.k+s.x,b[1]*s.k+s.y];s.x+=a[0]-b[0];s.y+=a[1]-b[1]}function e(){G&&G.domain(K.range().map(function(a){return(a-
s.x)/s.k}).map(K.invert));D&&D.domain(M.range().map(function(a){return(a-s.y)/s.k}).map(M.invert))}function f(a){a({type:"zoomstart"})}function g(a){e();a({type:"zoom",scale:s.k,translate:[s.x,s.y]})}function k(a){a({type:"zoomend"})}function l(){var a=this,c=A.event.target,e=I.of(a,arguments),m=0,n=A.select(Qa).on(B,function(){m=1;d(A.mouse(a),p);g(e)}).on(x,function(){n.on(B,Qa===a?h:null).on(x,null);s(m&&A.event.target===c);k(e)}),p=b(A.mouse(a)),s=P();Z.call(a);f(e)}function m(){function a(){var c=
A.touches(p);ha=s.k;c.forEach(function(a){a.identifier in t&&(t[a.identifier]=b(a))});return c}function e(){var b=A.event.target;A.select(b).on(y,n).on(B,h);x.push(b);for(var b=A.event.changedTouches,f=0,k=b.length;f<k;++f)t[b[f].identifier]=null;k=a();f=Date.now();1===k.length?(500>f-F&&(b=k[0],k=t[b.identifier],c(2*s.k),d(b,k),v(),g(q)),F=f):1<k.length&&(b=k[0],k=k[1],f=b[0]-k[0],b=b[1]-k[1],r=f*f+b*b)}function n(){for(var a=A.touches(p),b,e,f,k,l=0,m=a.length;l<m;++l,k=null)if(f=a[l],k=t[f.identifier]){if(e)break;
b=f;e=k}if(k){var h=(h=f[0]-b[0])*h+(h=f[1]-b[1])*h,a=r&&Math.sqrt(h/r);b=[(b[0]+f[0])/2,(b[1]+f[1])/2];e=[(e[0]+k[0])/2,(e[1]+k[1])/2];c(a*ha)}F=null;d(b,e);g(q)}function h(){if(A.event.touches.length){for(var b=A.event.changedTouches,c=0,d=b.length;c<d;++c)delete t[b[c].identifier];for(var e in t)return void a()}A.selectAll(x).on(u,null);w.on(z,l).on(C,m);Me();k(q)}var p=this,q=I.of(p,arguments),t={},r=0,ha,u=".zoom-"+A.event.changedTouches[0].identifier,y="touchmove"+u,B="touchend"+u,x=[],w=A.select(p).on(z,
null).on(C,e),Me=P();Z.call(p);e();f(q)}function n(){var a=I.of(this,arguments);w?clearTimeout(w):(Z.call(this),f(a));w=setTimeout(function(){w=null;k(a)},50);v();var e=r||A.mouse(this);t||(t=b(e));c(Math.pow(2,0.002*cf())*s.k);d(e,t);g(a)}function h(){t=null}function p(){var a=I.of(this,arguments),e=A.mouse(this),l=b(e),m=Math.log(s.k)/Math.LN2;f(a);c(Math.pow(2,A.event.shiftKey?Math.ceil(m)-1:Math.floor(m)+1));d(e,l);g(a);k(a)}var s={x:0,y:0,k:1},t,r,u=[960,500],y=oh,z="mousedown.zoom",B="mousemove.zoom",
x="mouseup.zoom",w,C="touchstart.zoom",F,I=q(a,"zoomstart","zoom","zoomend"),K,G,M,D;a.event=function(a){a.each(function(){var a=I.of(this,arguments),b=s;vc?A.select(this).transition().each("start.zoom",function(){s=this.__chart__||{x:0,y:0,k:1};f(a)}).tween("zoom:zoom",function(){var c=u[0],d=c/2,e=u[1]/2,f=A.interpolateZoom([(d-s.x)/s.k,(e-s.y)/s.k,c/s.k],[(d-b.x)/b.k,(e-b.y)/b.k,c/b.k]);return function(b){b=f(b);var k=c/b[2];this.__chart__=s={x:d-b[0]*k,y:e-b[1]*k,k:k};g(a)}}).each("end.zoom",
function(){k(a)}):(this.__chart__=s,f(a),g(a),k(a))})};a.translate=function(b){if(!arguments.length)return[s.x,s.y];s={x:+b[0],y:+b[1],k:s.k};e();return a};a.scale=function(b){if(!arguments.length)return s.k;s={x:s.x,y:s.y,k:+b};e();return a};a.scaleExtent=function(b){if(!arguments.length)return y;y=null==b?oh:[+b[0],+b[1]];return a};a.center=function(b){if(!arguments.length)return r;r=b&&[+b[0],+b[1]];return a};a.size=function(b){if(!arguments.length)return u;u=b&&[+b[0],+b[1]];return a};a.x=function(b){if(!arguments.length)return G;
G=b;K=b.copy();s={x:0,y:0,k:1};return a};a.y=function(b){if(!arguments.length)return D;D=b;M=b.copy();s={x:0,y:0,k:1};return a};return A.rebind(a,I,"on")};var oh=[0,Infinity],cf,Zh="onwheel"in hb?(cf=function(){return-A.event.deltaY*(A.event.deltaMode?120:1)},"wheel"):"onmousewheel"in hb?(cf=function(){return A.event.wheelDelta},"mousewheel"):(cf=function(){return-A.event.detail},"MozMousePixelScroll");U.prototype.toString=function(){return this.rgb()+""};A.hsl=function(a,b,c){return 1===arguments.length?
a instanceof Q?aa(a.h,a.s,a.l):xc(""+a,Eb,aa):aa(+a,+b,+c)};var wg=Q.prototype=new U;wg.brighter=function(a){a=Math.pow(0.7,arguments.length?a:1);return aa(this.h,this.s,this.l/a)};wg.darker=function(a){a=Math.pow(0.7,arguments.length?a:1);return aa(this.h,this.s,a*this.l)};wg.rgb=function(){return Ga(this.h,this.s,this.l)};A.hcl=function(a,b,c){return 1===arguments.length?a instanceof ma?xa(a.h,a.c,a.l):a instanceof W?Za(a.l,a.a,a.b):Za((a=$a((a=A.rgb(a)).r,a.g,a.b)).l,a.a,a.b):xa(+a,+b,+c)};var xg=
ma.prototype=new U;xg.brighter=function(a){return xa(this.h,this.c,Math.min(100,this.l+df*(arguments.length?a:1)))};xg.darker=function(a){return xa(this.h,this.c,Math.max(0,this.l-df*(arguments.length?a:1)))};xg.rgb=function(){return da(this.h,this.c,this.l).rgb()};A.lab=function(a,b,c){return 1===arguments.length?a instanceof W?sa(a.l,a.a,a.b):a instanceof ma?da(a.l,a.c,a.h):$a((a=A.rgb(a)).r,a.g,a.b):sa(+a,+b,+c)};var df=18,Pg=0.95047,Qg=1,Rg=1.08883,yg=W.prototype=new U;yg.brighter=function(a){return sa(Math.min(100,
this.l+df*(arguments.length?a:1)),this.a,this.b)};yg.darker=function(a){return sa(Math.max(0,this.l-df*(arguments.length?a:1)),this.a,this.b)};yg.rgb=function(){return Ba(this.l,this.a,this.b)};A.rgb=function(a,b,c){return 1===arguments.length?a instanceof Ka?Ca(a.r,a.g,a.b):xc(""+a,Ca,Ga):Ca(~~a,~~b,~~c)};var ef=Ka.prototype=new U;ef.brighter=function(a){a=Math.pow(0.7,arguments.length?a:1);var b=this.r,c=this.g,d=this.b;if(!b&&!c&&!d)return Ca(30,30,30);b&&30>b&&(b=30);c&&30>c&&(c=30);d&&30>d&&
(d=30);return Ca(Math.min(255,~~(b/a)),Math.min(255,~~(c/a)),Math.min(255,~~(d/a)))};ef.darker=function(a){a=Math.pow(0.7,arguments.length?a:1);return Ca(~~(a*this.r),~~(a*this.g),~~(a*this.b))};ef.hsl=function(){return Eb(this.r,this.g,this.b)};ef.toString=function(){return"#"+Ya(this.r)+Ya(this.g)+Ya(this.b)};var Re=A.map({aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,
brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,
darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,
lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,
mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,
red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074});Re.forEach(function(a,b){Re.set(a,
Ca(b>>16,b>>8&255,b&255))});A.functor=ga;A.xhr=Ab(ya);A.dsv=function(a,b){function c(a,f,g){3>arguments.length&&(g=f,f=null);var k=Bb(a,b,null==f?d:e(f),g);k.row=function(a){return arguments.length?k.response(null==(f=a)?d:e(a)):f};return k}function d(a){return c.parse(a.responseText)}function e(a){return function(b){return c.parse(b.responseText,a)}}function f(b){return b.map(g).join(a)}function g(a){return l.test(a)?'"'+a.replace(/\"/g,'""')+'"':a}var l=RegExp('["'+a+"\n]"),m=a.charCodeAt(0);c.parse=
function(a,b){var d;return c.parseRows(a,function(a,c){if(d)return d(a,c-1);var e=new Function("d","return {"+a.map(function(a,b){return JSON.stringify(a)+": d["+b+"]"}).join(",")+"}");d=b?function(a,c){return b(e(a),c)}:e})};c.parseRows=function(a,b){function c(){if(k>=g)return e;if(h)return h=!1,d;var b=k;if(34===a.charCodeAt(b)){for(var f=b;f++<g;)if(34===a.charCodeAt(f)){if(34!==a.charCodeAt(f+1))break;++f}k=f+2;var l=a.charCodeAt(f+1);13===l?(h=!0,10===a.charCodeAt(f+2)&&++k):10===l&&(h=!0);
return a.substring(b+1,f).replace(/""/g,'"')}for(;k<g;){l=a.charCodeAt(k++);f=1;if(10===l)h=!0;else if(13===l)h=!0,10===a.charCodeAt(k)&&(++k,++f);else if(l!==m)continue;return a.substring(b,k-f)}return a.substring(b)}for(var d={},e={},f=[],g=a.length,k=0,l=0,n,h;(n=c())!==e;){for(var p=[];n!==d&&n!==e;)p.push(n),n=c();(!b||(p=b(p,l++)))&&f.push(p)}return f};c.format=function(b){if(Array.isArray(b[0]))return c.formatRows(b);var d=new k,e=[];b.forEach(function(a){for(var b in a)d.has(b)||e.push(d.add(b))});
return[e.map(g).join(a)].concat(b.map(function(b){return e.map(function(a){return g(b[a])}).join(a)})).join("\n")};c.formatRows=function(a){return a.map(f).join("\n")};return c};A.csv=A.dsv(",","text/csv");A.tsv=A.dsv("\t","text/tab-separated-values");A.touch=function(a,b,c){3>arguments.length&&(c=b,b=y().changedTouches);if(b)for(var d=0,e=b.length,f;d<e;++d)if((f=b[d]).identifier===c)return wa(a,f)};var Ue,Ve,Te,Se,wb,Sg=Qa[s(Qa,"requestAnimationFrame")]||function(a){setTimeout(a,17)};A.timer=function(a,
b,c){var d=arguments.length;2>d&&(b=0);3>d&&(c=Date.now());d={c:a,t:c+b,f:!1,n:null};Ve?Ve.n=d:Ue=d;Ve=d;Te||(Se=clearTimeout(Se),Te=1,Sg(hd))};A.timer.flush=function(){wc();id()};A.round=function(a,b){return b?Math.round(a*(b=Math.pow(10,b)))/b:Math.round(a)};var $h="y z a f p n \u00b5 m  k M G T P E Z Y".split(" ").map(function(a,b){var c=Math.pow(10,3*Y(8-b));return{scale:8<b?function(a){return a/c}:function(a){return a*c},symbol:a}});A.formatPrefix=function(a,b){var c=0;a&&(0>a&&(a*=-1),b&&(a=
A.round(a,Gb(a,b))),c=1+Math.floor(1E-12+Math.log(a)/Math.LN10),c=Math.max(-24,Math.min(24,3*Math.floor((c-1)/3))));return $h[8+c/3]};var Tg=/(?:([^{])?([<>=^]))?([+\- ])?([$#])?(0)?(\d+)?(,)?(\.-?\d+)?([a-z%])?/i,Ih=A.map({b:function(a){return a.toString(2)},c:function(a){return String.fromCharCode(a)},o:function(a){return a.toString(8)},x:function(a){return a.toString(16)},X:function(a){return a.toString(16).toUpperCase()},g:function(a,b){return a.toPrecision(b)},e:function(a,b){return a.toExponential(b)},
f:function(a,b){return a.toFixed(b)},r:function(a,b){return(a=A.round(a,Gb(a,b))).toFixed(Math.max(0,Math.min(20,Gb(a*(1+1E-15),b))))}}),R=A.time={},Ia=Date;La.prototype={getDate:function(){return this._.getUTCDate()},getDay:function(){return this._.getUTCDay()},getFullYear:function(){return this._.getUTCFullYear()},getHours:function(){return this._.getUTCHours()},getMilliseconds:function(){return this._.getUTCMilliseconds()},getMinutes:function(){return this._.getUTCMinutes()},getMonth:function(){return this._.getUTCMonth()},
getSeconds:function(){return this._.getUTCSeconds()},getTime:function(){return this._.getTime()},getTimezoneOffset:function(){return 0},valueOf:function(){return this._.valueOf()},setDate:function(){zb.setUTCDate.apply(this._,arguments)},setDay:function(){zb.setUTCDay.apply(this._,arguments)},setFullYear:function(){zb.setUTCFullYear.apply(this._,arguments)},setHours:function(){zb.setUTCHours.apply(this._,arguments)},setMilliseconds:function(){zb.setUTCMilliseconds.apply(this._,arguments)},setMinutes:function(){zb.setUTCMinutes.apply(this._,
arguments)},setMonth:function(){zb.setUTCMonth.apply(this._,arguments)},setSeconds:function(){zb.setUTCSeconds.apply(this._,arguments)},setTime:function(){zb.setTime.apply(this._,arguments)}};var zb=Date.prototype;R.year=ab(function(a){a=R.day(a);a.setMonth(0,1);return a},function(a,b){a.setFullYear(a.getFullYear()+b)},function(a){return a.getFullYear()});R.years=R.year.range;R.years.utc=R.year.utc.range;R.day=ab(function(a){var b=new Ia(2E3,0);b.setFullYear(a.getFullYear(),a.getMonth(),a.getDate());
return b},function(a,b){a.setDate(a.getDate()+b)},function(a){return a.getDate()-1});R.days=R.day.range;R.days.utc=R.day.utc.range;R.dayOfYear=function(a){var b=R.year(a);return Math.floor((a-b-6E4*(a.getTimezoneOffset()-b.getTimezoneOffset()))/864E5)};"sunday monday tuesday wednesday thursday friday saturday".split(" ").forEach(function(a,b){b=7-b;var c=R[a]=ab(function(a){(a=R.day(a)).setDate(a.getDate()-(a.getDay()+b)%7);return a},function(a,b){a.setDate(a.getDate()+7*Math.floor(b))},function(a){var c=
R.year(a).getDay();return Math.floor((R.dayOfYear(a)+(c+b)%7)/7)-(c!==b)});R[a+"s"]=c.range;R[a+"s"].utc=c.utc.range;R[a+"OfYear"]=function(a){var c=R.year(a).getDay();return Math.floor((R.dayOfYear(a)+(c+b)%7)/7)}});R.week=R.sunday;R.weeks=R.sunday.range;R.weeks.utc=R.sunday.utc.range;R.weekOfYear=R.sundayOfYear;var Ug={"-":"",_:" ","0":"0"},ua=/^\s*\d+/,Vg=/^%/;A.locale=function(a){return{numberFormat:Qd(a),timeFormat:vf(a)}};var ph=A.locale({decimal:".",thousands:",",grouping:[3],currency:["$",
""],dateTime:"%a %b %e %X %Y",date:"%m/%d/%Y",time:"%H:%M:%S",periods:["AM","PM"],days:"Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),shortDays:"Sun Mon Tue Wed Thu Fri Sat".split(" "),months:"January February March April May June July August September October November December".split(" "),shortMonths:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ")});A.format=ph.numberFormat;A.geo={};kd.prototype={s:0,t:0,add:function(a){Ud(a,this.t,ff);Ud(ff.s,this.s,this);this.s?
this.t+=ff.t:this.s=ff.t},reset:function(){this.s=this.t=0},valueOf:function(){return this.s}};var ff=new kd;A.geo.stream=function(a,b){if(a&&qh.hasOwnProperty(a.type))qh[a.type](a,b);else Ac(a,b)};var qh={Feature:function(a,b){Ac(a.geometry,b)},FeatureCollection:function(a,b){for(var c=a.features,d=-1,e=c.length;++d<e;)Ac(c[d].geometry,b)}},Wg={Sphere:function(a,b){b.sphere()},Point:function(a,b){a=a.coordinates;b.point(a[0],a[1],a[2])},MultiPoint:function(a,b){for(var c=a.coordinates,d=-1,e=c.length;++d<
e;)a=c[d],b.point(a[0],a[1],a[2])},LineString:function(a,b){ld(a.coordinates,b,0)},MultiLineString:function(a,b){for(var c=a.coordinates,d=-1,e=c.length;++d<e;)ld(c[d],b,0)},Polygon:function(a,b){Vd(a.coordinates,b)},MultiPolygon:function(a,b){for(var c=a.coordinates,d=-1,e=c.length;++d<e;)Vd(c[d],b)},GeometryCollection:function(a,b){for(var c=a.geometries,d=-1,e=c.length;++d<e;)Ac(c[d],b)}};A.geo.area=function(a){fd=0;A.geo.stream(a,Ra);return fd};var fd,rc=new kd,Ra={sphere:function(){fd+=4*V},
point:p,lineStart:p,lineEnd:p,polygonStart:function(){rc.reset();Ra.lineStart=Jf},polygonEnd:function(){var a=2*rc;fd+=0>a?4*V+a:a;Ra.lineStart=Ra.lineEnd=Ra.point=p}};A.geo.bounds=function(){function a(b,c){y.push(z=[n=b,p=b]);c<h&&(h=c);c>s&&(s=c)}function b(c,d){var e=ob([c*X,d*X]);if(v){var f=Ib(v,e),f=Ib([f[1],-f[0],0],f);Jb(f);var f=bb(f),g=c-q,l=0<g?1:-1,m=f[0]*pa*l,g=180<Y(g);g^(l*q<m&&m<l*c)?(f=f[1]*pa,f>s&&(s=f)):(m=(m+360)%360-180,g^(l*q<m&&m<l*c))?(f=-f[1]*pa,f<h&&(h=f)):(d<h&&(h=d),d>
s&&(s=d));g?c<q?k(n,c)>k(n,p)&&(p=c):k(c,p)>k(n,p)&&(n=c):p>=n?(c<n&&(n=c),c>p&&(p=c)):c>q?k(n,c)>k(n,p)&&(p=c):k(c,p)>k(n,p)&&(n=c)}else a(c,d);v=e;q=c}function c(){B.point=b}function d(){z[0]=n;z[1]=p;B.point=a;v=null}function e(a,c){if(v){var d=a-q;u+=180<Y(d)?d+(0<d?360:-360):d}else t=a,r=c;Ra.point(a,c);b(a,c)}function f(){Ra.lineStart()}function g(){e(t,r);Ra.lineEnd();Y(u)>O&&(n=-(p=180));z[0]=n;z[1]=p;v=null}function k(a,b){return 0>(b-=a)?b+360:b}function l(a,b){return a[0]-b[0]}function m(a,
b){return b[0]<=b[1]?b[0]<=a&&a<=b[1]:a<b[0]||b[1]<a}var n,h,p,s,q,t,r,v,u,y,z,B={point:a,lineStart:c,lineEnd:d,polygonStart:function(){B.point=e;B.lineStart=f;B.lineEnd=g;u=0;Ra.polygonStart()},polygonEnd:function(){Ra.polygonEnd();B.point=a;B.lineStart=c;B.lineEnd=d;0>rc?(n=-(p=180),h=-(s=90)):u>O?s=90:u<-O&&(h=-90);z[0]=n;z[1]=p}};return function(a){s=p=-(n=h=Infinity);y=[];A.geo.stream(a,B);if(a=y.length){y.sort(l);for(var b=1,c=y[0],d,e=[c];b<a;++b)d=y[b],m(d[0],c)||m(d[1],c)?(k(c[0],d[1])>k(c[0],
c[1])&&(c[1]=d[1]),k(d[0],c[1])>k(c[0],c[1])&&(c[0]=d[0])):e.push(c=d);var f=-Infinity,g;a=e.length-1;b=0;for(c=e[a];b<=a;c=d,++b)if(d=e[b],(g=k(c[1],d[0]))>f)f=g,n=d[0],p=c[1]}y=z=null;return Infinity===n||Infinity===h?[[NaN,NaN],[NaN,NaN]]:[[n,h],[p,s]]}}();A.geo.centroid=function(a){Jd=cd=xb=yb=lb=Ua=Va=Ma=Ub=Vb=mb=0;A.geo.stream(a,fb);a=Ub;var b=Vb,c=mb,d=a*a+b*b+c*c;return d<jg&&(a=Ua,b=Va,c=Ma,cd<O&&(a=xb,b=yb,c=lb),d=a*a+b*b+c*c,d<jg)?[NaN,NaN]:[Math.atan2(b,a)*pa,la(c/Math.sqrt(d))*pa]};var Jd,
cd,xb,yb,lb,Ua,Va,Ma,Ub,Vb,mb,fb={sphere:p,point:$b,lineStart:Cc,lineEnd:nd,polygonStart:function(){fb.lineStart=Wd},polygonEnd:function(){fb.lineStart=Cc}},Xg=Xd(pb,function(a){var b=NaN,c=NaN,d=NaN,e;return{lineStart:function(){a.lineStart();e=1},point:function(f,g){var k=0<f?V:-V,l=Y(f-b);if(Y(l-V)<O)a.point(b,c=0<(c+g)/2?Fa:-Fa),a.point(d,c),a.lineEnd(),a.lineStart(),a.point(k,c),a.point(f,c),e=0;else if(d!==k&&l>=V){Y(b-d)<O&&(b-=d*O);Y(f-k)<O&&(f-=k*O);var l=b,m=c,n=f,h,p,s=Math.sin(l-n);c=
Y(s)>O?Math.atan((Math.sin(m)*(p=Math.cos(g))*Math.sin(n)-Math.sin(g)*(h=Math.cos(m))*Math.sin(l))/(h*p*s)):(m+g)/2;a.point(d,c);a.lineEnd();a.lineStart();a.point(k,c);e=0}a.point(b=f,c=g);d=k},lineEnd:function(){a.lineEnd();b=c=NaN},clean:function(){return 2-e}}},function(a,b,c,d){null==a?(c*=Fa,d.point(-V,c),d.point(0,c),d.point(V,c),d.point(V,0),d.point(V,-c),d.point(0,-c),d.point(-V,-c),d.point(-V,0),d.point(-V,c)):Y(a[0]-b[0])>O?(a=a[0]<b[0]?V:-V,c=c*a/2,d.point(-a,c),d.point(0,c),d.point(a,
c)):d.point(b[0],b[1])},[-V,-V/2]),We=1E9;A.geo.clipExtent=function(){var a,b,c,d,e,f,g={stream:function(a){e&&(e.valid=!1);e=f(a);e.valid=!0;return e},extent:function(k){if(!arguments.length)return[[a,b],[c,d]];f=ae(a=+k[0][0],b=+k[0][1],c=+k[1][0],d=+k[1][1]);e&&(e.valid=!1,e=null);return g}};return g.extent([[0,0],[960,500]])};(A.geo.conicEqualArea=function(){return Fc(ce)}).raw=ce;A.geo.albers=function(){return A.geo.conicEqualArea().rotate([96,0]).center([-0.6,38.7]).parallels([29.5,45.5]).scale(1070)};
A.geo.albersUsa=function(){function a(b){var c=b[0];b=b[1];e=null;(g(c,b),e)||(k(c,b),e)||l(c,b);return e}var b=A.geo.albers(),c=A.geo.conicEqualArea().rotate([154,0]).center([-2,58.5]).parallels([55,65]),d=A.geo.conicEqualArea().rotate([157,0]).center([-3,19.9]).parallels([8,18]),e,f={point:function(a,b){e=[a,b]}},g,k,l;a.invert=function(a){var e=b.scale(),f=b.translate(),g=(a[0]-f[0])/e,e=(a[1]-f[1])/e;return(0.12<=e&&0.234>e&&-0.425<=g&&-0.214>g?c:0.166<=e&&0.234>e&&-0.214<=g&&-0.115>g?d:b).invert(a)};
a.stream=function(a){var e=b.stream(a),f=c.stream(a),g=d.stream(a);return{point:function(a,b){e.point(a,b);f.point(a,b);g.point(a,b)},sphere:function(){e.sphere();f.sphere();g.sphere()},lineStart:function(){e.lineStart();f.lineStart();g.lineStart()},lineEnd:function(){e.lineEnd();f.lineEnd();g.lineEnd()},polygonStart:function(){e.polygonStart();f.polygonStart();g.polygonStart()},polygonEnd:function(){e.polygonEnd();f.polygonEnd();g.polygonEnd()}}};a.precision=function(e){if(!arguments.length)return b.precision();
b.precision(e);c.precision(e);d.precision(e);return a};a.scale=function(e){if(!arguments.length)return b.scale();b.scale(e);c.scale(0.35*e);d.scale(e);return a.translate(b.translate())};a.translate=function(e){if(!arguments.length)return b.translate();var m=b.scale(),n=+e[0],h=+e[1];g=b.translate(e).clipExtent([[n-0.455*m,h-0.238*m],[n+0.455*m,h+0.238*m]]).stream(f).point;k=c.translate([n-0.307*m,h+0.201*m]).clipExtent([[n-0.425*m+O,h+0.12*m+O],[n-0.214*m-O,h+0.234*m-O]]).stream(f).point;l=d.translate([n-
0.205*m,h+0.212*m]).clipExtent([[n-0.214*m+O,h+0.166*m+O],[n-0.115*m-O,h+0.234*m-O]]).stream(f).point;return a};return a.scale(1070)};var gf,Xe,Wb={point:p,lineStart:p,lineEnd:p,polygonStart:function(){Xe=0;Wb.lineStart=de},polygonEnd:function(){Wb.lineStart=Wb.lineEnd=Wb.point=p;gf+=Y(Xe/2)}},hf,jf,kf,lf,ai={point:function(a,b){a<hf&&(hf=a);a>kf&&(kf=a);b<jf&&(jf=b);b>lf&&(lf=b)},lineStart:p,lineEnd:p,polygonStart:p,polygonEnd:p},gb={point:ib,lineStart:Hc,lineEnd:od,polygonStart:function(){gb.lineStart=
fe},polygonEnd:function(){gb.point=ib;gb.lineStart=Hc;gb.lineEnd=od}};A.geo.path=function(){function a(b){if(b){"function"===typeof c&&g.pointRadius(+c.apply(this,arguments));if(!k||!k.valid)k=f(g);A.geo.stream(b,k)}return g.result()}function b(){k=null;return a}var c=4.5,d,e,f,g,k;a.area=function(a){gf=0;A.geo.stream(a,f(Wb));return gf};a.centroid=function(a){xb=yb=lb=Ua=Va=Ma=Ub=Vb=mb=0;A.geo.stream(a,f(gb));return mb?[Ub/mb,Vb/mb]:Ma?[Ua/Ma,Va/Ma]:lb?[xb/lb,yb/lb]:[NaN,NaN]};a.bounds=function(a){kf=
lf=-(hf=jf=Infinity);A.geo.stream(a,f(ai));return[[hf,jf],[kf,lf]]};a.projection=function(a){if(!arguments.length)return d;f=(d=a)?a.stream||he(a):ya;return b()};a.context=function(a){if(!arguments.length)return e;g=null==(e=a)?new ee:new ge(a);"function"!==typeof c&&g.pointRadius(c);return b()};a.pointRadius=function(b){if(!arguments.length)return c;c="function"===typeof b?b:(g.pointRadius(+b),+b);return a};return a.projection(A.geo.albersUsa()).context(null)};A.geo.transform=function(a){return{stream:function(b){b=
new ie(b);for(var c in a)b[c]=a[c];return b}}};ie.prototype={point:function(a,b){this.stream.point(a,b)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};A.geo.projection=cb;A.geo.projectionMutator=Ea;(A.geo.equirectangular=function(){return cb(Lb)}).raw=Lb.invert=Lb;A.geo.rotation=function(a){function b(c){c=a(c[0]*X,c[1]*
X);return c[0]*=pa,c[1]*=pa,c}a=pd(a[0]%360*X,a[1]*X,2<a.length?a[2]*X:0);b.invert=function(b){b=a.invert(b[0]*X,b[1]*X);return b[0]*=pa,b[1]*=pa,b};return b};Jc.invert=Lb;A.geo.circle=function(){function a(){var c="function"===typeof b?b.apply(this,arguments):b,d=pd(-c[0]*X,-c[1]*X,0).invert,f=[];e(null,null,1,{point:function(a,b){f.push(a=d(a,b));a[0]*=pa;a[1]*=pa}});return{type:"Polygon",coordinates:[f]}}var b=[0,0],c,d=6,e;a.origin=function(c){if(!arguments.length)return b;b=c;return a};a.angle=
function(b){if(!arguments.length)return c;e=Lc((c=+b)*X,d*X);return a};a.precision=function(b){if(!arguments.length)return d;e=Lc(c*X,(d=+b)*X);return a};return a.angle(90)};A.geo.distance=function(a,b){var c=(b[0]-a[0])*X,d=a[1]*X,e=b[1]*X,f=Math.sin(c),c=Math.cos(c),g=Math.sin(d),d=Math.cos(d),k=Math.sin(e),e=Math.cos(e),l;return Math.atan2(Math.sqrt((l=e*f)*l+(l=d*k-g*e*c)*l),g*k+d*e*c)};A.geo.graticule=function(){function a(){return{type:"MultiLineString",coordinates:b()}}function b(){return A.range(Math.ceil(f/
p)*p,e,p).map(r).concat(A.range(Math.ceil(m/s)*s,l,s).map(v)).concat(A.range(Math.ceil(d/n)*n,c,n).filter(function(a){return Y(a%p)>O}).map(q)).concat(A.range(Math.ceil(k/h)*h,g,h).filter(function(a){return Y(a%s)>O}).map(t))}var c,d,e,f,g,k,l,m,n=10,h=n,p=90,s=360,q,t,r,v,u=2.5;a.lines=function(){return b().map(function(a){return{type:"LineString",coordinates:a}})};a.outline=function(){return{type:"Polygon",coordinates:[r(f).concat(v(l).slice(1),r(e).reverse().slice(1),v(m).reverse().slice(1))]}};
a.extent=function(b){return!arguments.length?a.minorExtent():a.majorExtent(b).minorExtent(b)};a.majorExtent=function(b){if(!arguments.length)return[[f,m],[e,l]];f=+b[0][0];e=+b[1][0];m=+b[0][1];l=+b[1][1];f>e&&(b=f,f=e,e=b);m>l&&(b=m,m=l,l=b);return a.precision(u)};a.minorExtent=function(b){if(!arguments.length)return[[d,k],[c,g]];d=+b[0][0];c=+b[1][0];k=+b[0][1];g=+b[1][1];d>c&&(b=d,d=c,c=b);k>g&&(b=k,k=g,g=b);return a.precision(u)};a.step=function(b){return!arguments.length?a.minorStep():a.majorStep(b).minorStep(b)};
a.majorStep=function(b){if(!arguments.length)return[p,s];p=+b[0];s=+b[1];return a};a.minorStep=function(b){if(!arguments.length)return[n,h];n=+b[0];h=+b[1];return a};a.precision=function(b){if(!arguments.length)return u;u=+b;q=cc(k,g,90);t=me(d,c,u);r=cc(m,l,90);v=me(f,e,u);return a};return a.majorExtent([[-180,-90+O],[180,90-O]]).minorExtent([[-180,-80-O],[180,80+O]])};A.geo.greatArc=function(){function a(){return{type:"LineString",coordinates:[c||b.apply(this,arguments),e||d.apply(this,arguments)]}}
var b=Mc,c,d=dc,e;a.distance=function(){return A.geo.distance(c||b.apply(this,arguments),e||d.apply(this,arguments))};a.source=function(d){if(!arguments.length)return b;b=d;c="function"===typeof d?null:d;return a};a.target=function(b){if(!arguments.length)return d;d=b;e="function"===typeof b?null:b;return a};a.precision=function(){return arguments.length?a:0};return a};A.geo.interpolate=function(a,b){return jb(a[0]*X,a[1]*X,b[0]*X,b[1]*X)};A.geo.length=function(a){mf=0;A.geo.stream(a,gd);return mf};
var mf,gd={sphere:p,point:p,lineStart:function(){function a(e,f){var g=Math.sin(f*=X),k=Math.cos(f),l=Y((e*=X)-b),m=Math.cos(l);mf+=Math.atan2(Math.sqrt((l=k*Math.sin(l))*l+(l=d*g-c*k*m)*l),c*g+d*k*m);b=e;c=g;d=k}var b,c,d;gd.point=function(e,f){b=e*X;c=Math.sin(f*=X);d=Math.cos(f);gd.point=a};gd.lineEnd=function(){gd.point=gd.lineEnd=p}},lineEnd:p,polygonStart:p,polygonEnd:p},rh=qa(function(a){return Math.sqrt(2/(1+a))},function(a){return 2*Math.asin(a/2)});(A.geo.azimuthalEqualArea=function(){return cb(rh)}).raw=
rh;var sh=qa(function(a){return(a=Math.acos(a))&&a/Math.sin(a)},ya);(A.geo.azimuthalEquidistant=function(){return cb(sh)}).raw=sh;(A.geo.conicConformal=function(){return Fc(ne)}).raw=ne;(A.geo.conicEquidistant=function(){return Fc(qd)}).raw=qd;var th=qa(function(a){return 1/a},Math.atan);(A.geo.gnomonic=function(){return cb(th)}).raw=th;ec.invert=function(a,b){return[a,2*Math.atan(Math.exp(b))-Fa]};(A.geo.mercator=function(){return rd(ec)}).raw=ec;var uh=qa(function(){return 1},Math.asin);(A.geo.orthographic=
function(){return cb(uh)}).raw=uh;var vh=qa(function(a){return 1/(1+a)},function(a){return 2*Math.atan(a)});(A.geo.stereographic=function(){return cb(vh)}).raw=vh;Nc.invert=function(a,b){return[-b,2*Math.atan(Math.exp(a))-Fa]};(A.geo.transverseMercator=function(){var a=rd(Nc),b=a.center,c=a.rotate;a.center=function(a){return a?b([-a[1],a[0]]):(a=b(),[-a[1],a[0]])};a.rotate=function(a){return a?c([a[0],a[1],2<a.length?a[2]+90:90]):(a=c(),[a[0],a[1],a[2]-90])};return a.rotate([0,0])}).raw=Nc;A.geom=
{};A.geom.hull=function(a){function b(a){if(3>a.length)return[];var e=ga(c),f=ga(d),g,k=a.length,l=[],m=[];for(g=0;g<k;g++)l.push([+e.call(this,a[g],g),+f.call(this,a[g],g),g]);l.sort(Mb);for(g=0;g<k;g++)m.push([l[g][0],-l[g][1]]);var e=Oc(l),m=Oc(m),f=m[0]===e[0],k=m[m.length-1]===e[e.length-1],n=[];for(g=e.length-1;0<=g;--g)n.push(a[l[e[g]][2]]);for(g=+f;g<m.length-k;++g)n.push(a[l[m[g]][2]]);return n}var c=Ja,d=Oa;if(arguments.length)return b(a);b.x=function(a){return arguments.length?(c=a,b):
c};b.y=function(a){return arguments.length?(d=a,b):d};return b};A.geom.polygon=function(a){Pe(a,nf);return a};var nf=A.geom.polygon.prototype=[];nf.area=function(){for(var a=-1,b=this.length,c,d=this[b-1],e=0;++a<b;)c=d,d=this[a],e+=c[1]*d[0]-c[0]*d[1];return 0.5*e};nf.centroid=function(a){var b=-1,c=this.length,d=0,e=0,f,g=this[c-1],k;for(arguments.length||(a=-1/(6*this.area()));++b<c;)f=g,g=this[b],k=f[0]*g[1]-g[0]*f[1],d+=(f[0]+g[0])*k,e+=(f[1]+g[1])*k;return[d*a,e*a]};nf.clip=function(a){for(var b,
c=oe(a),d=-1,e=this.length-oe(this),f,g,k=this[e-1],l,m,n;++d<e;){b=a.slice();a.length=0;l=this[d];m=b[(g=b.length-c)-1];for(f=-1;++f<g;)n=b[f],fc(n,k,l)?(fc(m,k,l)||a.push(Pc(m,n,k,l)),a.push(n)):fc(m,k,l)&&a.push(Pc(m,n,k,l)),m=n;c&&a.push(a[0]);k=l}return a};var ed,sc,dd,Yg=[],kg,Kd,Zg=[];qb.prototype.prepare=function(){for(var a=this.edges,b=a.length,c;b--;)c=a[b].edge,(!c.b||!c.a)&&a.splice(b,1);a.sort(ud);return a.length};ic.prototype={start:function(){return this.edge.l===this.site?this.edge.a:
this.edge.b},end:function(){return this.edge.l===this.site?this.edge.b:this.edge.a}};xd.prototype={insert:function(a,b){var c,d,e;if(a){b.P=a;if(b.N=a.N)a.N.P=b;a.N=b;if(a.R){for(a=a.R;a.L;)a=a.L;a.L=b}else a.R=b;c=a}else this._?(a=re(this._),b.P=null,b.N=a,a.P=a.L=b,c=a):(b.P=b.N=null,this._=b,c=null);b.L=b.R=null;b.U=c;b.C=!0;for(a=b;c&&c.C;)d=c.U,c===d.L?(e=d.R)&&e.C?(c.C=e.C=!1,d.C=!0,a=d):(a===c.R&&(kc(this,c),a=c,c=a.U),c.C=!1,d.C=!0,Qb(this,d)):(e=d.L)&&e.C?(c.C=e.C=!1,d.C=!0,a=d):(a===c.L&&
(Qb(this,c),a=c,c=a.U),c.C=!1,d.C=!0,kc(this,d)),c=a.U;this._.C=!1},remove:function(a){a.N&&(a.N.P=a.P);a.P&&(a.P.N=a.N);a.N=a.P=null;var b=a.U,c=a.L,d=a.R,e,f;e=c?d?re(d):c:d;b?b.L===a?b.L=e:b.R=e:this._=e;c&&d?(f=e.C,e.C=a.C,e.L=c,c.U=e,e!==d?(b=e.U,e.U=a.U,a=e.R,b.L=a,e.R=d,d.U=e):(e.U=b,b=e,a=e.R)):(f=a.C,a=e);a&&(a.U=b);if(!f)if(a&&a.C)a.C=!1;else{do{if(a===this._)break;if(a===b.L){if(a=b.R,a.C&&(a.C=!1,b.C=!0,kc(this,b),a=b.R),a.L&&a.L.C||a.R&&a.R.C){if(!a.R||!a.R.C)a.L.C=!1,a.C=!0,Qb(this,
a),a=b.R;a.C=b.C;b.C=a.R.C=!1;kc(this,b);a=this._;break}}else if(a=b.L,a.C&&(a.C=!1,b.C=!0,Qb(this,b),a=b.L),a.L&&a.L.C||a.R&&a.R.C){if(!a.L||!a.L.C)a.R.C=!1,a.C=!0,kc(this,a),a=b.L;a.C=b.C;b.C=a.L.C=!1;Qb(this,b);a=this._;break}a.C=!0;a=b;b=b.U}while(!a.C);a&&(a.C=!1)}}};A.geom.voronoi=function(a){function b(a){var d=Array(a.length),e=k[0][0],f=k[0][1],g=k[1][0],l=k[1][1];Qc(c(a),k).cells.forEach(function(b,c){var k=b.edges,m=b.site;(d[c]=k.length?k.map(function(a){a=a.start();return[a.x,a.y]}):
m.x>=e&&m.x<=g&&m.y>=f&&m.y<=l?[[e,l],[g,l],[g,f],[e,f]]:[]).point=a[c]});return d}function c(a){return a.map(function(a,b){return{x:Math.round(f(a,b)/O)*O,y:Math.round(g(a,b)/O)*O,i:b}})}var d=Ja,e=Oa,f=d,g=e,k=of;if(a)return b(a);b.links=function(a){return Qc(c(a)).edges.filter(function(a){return a.l&&a.r}).map(function(b){return{source:a[b.l.i],target:a[b.r.i]}})};b.triangles=function(a){var b=[];Qc(c(a)).cells.forEach(function(c,d){for(var e=c.site,f=c.edges.sort(ud),g=-1,k=f.length,l,m=f[k-1].edge,
m=m.l===e?m.r:m.l;++g<k;)l=m,m=f[g].edge,m=m.l===e?m.r:m.l,d<l.i&&(d<m.i&&0>(e.x-m.x)*(l.y-e.y)-(e.x-l.x)*(m.y-e.y))&&b.push([a[d],a[l.i],a[m.i]])});return b};b.x=function(a){return arguments.length?(f=ga(d=a),b):d};b.y=function(a){return arguments.length?(g=ga(e=a),b):e};b.clipExtent=function(a){if(!arguments.length)return k===of?null:k;k=null==a?of:a;return b};b.size=function(a){return!arguments.length?k===of?null:k&&k[1]:b.clipExtent(a&&[[0,0],a])};return b};var of=[[-1E6,-1E6],[1E6,1E6]];A.geom.delaunay=
function(a){return A.geom.voronoi().triangles(a)};A.geom.quadtree=function(a,b,c,d,e){function f(a){function m(a,b,c,d,e,f,g,k){if(!isNaN(c)&&!isNaN(d))if(a.leaf){var l=a.x,h=a.y;if(null!=l){if(!(0.01>Y(l-c)+Y(h-d))){var p=a.point;a.x=a.y=a.point=null;n(a,p,l,h,e,f,g,k)}n(a,b,c,d,e,f,g,k)}else a.x=c,a.y=d,a.point=b}else n(a,b,c,d,e,f,g,k)}function n(a,b,c,d,e,f,g,k){var l=0.5*(e+g),h=0.5*(f+k),p=c>=l,s=d>=h,q=(s<<1)+p;a.leaf=!1;a=a.nodes[q]||(a.nodes[q]=yd());p?e=l:g=l;s?f=h:k=h;m(a,b,c,d,e,f,g,k)}
var h,p=ga(g),s=ga(k),q,t,r,v,u,y,z,B;if(null!=b)u=b,y=c,z=d,B=e;else if(z=B=-(u=y=Infinity),q=[],t=[],v=a.length,l)for(r=0;r<v;++r)h=a[r],h.x<u&&(u=h.x),h.y<y&&(y=h.y),h.x>z&&(z=h.x),h.y>B&&(B=h.y),q.push(h.x),t.push(h.y);else for(r=0;r<v;++r){var x=+p(h=a[r],r);h=+s(h,r);x<u&&(u=x);h<y&&(y=h);x>z&&(z=x);h>B&&(B=h);q.push(x);t.push(h)}x=z-u;h=B-y;x>h?B=y+x:z=u+h;var w=yd();w.add=function(a){m(w,a,+p(a,++r),+s(a,r),u,y,z,B)};w.visit=function(a){rb(a,w,u,y,z,B)};r=-1;if(null==b){for(;++r<v;)m(w,a[r],
q[r],t[r],u,y,z,B);--r}else a.forEach(w.add);q=t=a=h=null;return w}var g=Ja,k=Oa,l;if(l=arguments.length)return g=se,k=Of,3===l&&(e=c,d=b,c=b=0),f(a);f.x=function(a){return arguments.length?(g=a,f):g};f.y=function(a){return arguments.length?(k=a,f):k};f.extent=function(a){if(!arguments.length)return null==b?null:[[b,c],[d,e]];null==a?b=c=d=e=null:(b=+a[0][0],c=+a[0][1],d=+a[1][0],e=+a[1][1]);return f};f.size=function(a){if(!arguments.length)return null==b?null:[d-b,e-c];null==a?b=c=d=e=null:(b=c=
0,d=+a[0],e=+a[1]);return f};return f};A.interpolateRgb=Rc;A.interpolateObject=te;A.interpolateNumber=Ta;A.interpolateString=Sc;var lg=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,mg=RegExp(lg.source,"g");A.interpolate=kb;A.interpolators=[function(a,b){var c=typeof b;return("string"===c?Re.has(b)||/^(#|rgb\(|hsl\()/.test(b)?Rc:Sc:b instanceof U?Rc:Array.isArray(b)?lc:"object"===c&&isNaN(b)?te:Ta)(a,b)}];A.interpolateArray=lc;var wh=function(){return ya},bi=A.map({linear:wh,poly:function(a){return function(b){return Math.pow(b,
a)}},quad:function(){return Pf},cubic:function(){return Qf},sin:function(){return Sf},exp:function(){return Tf},circle:function(){return zd},elastic:function(a,b){var c;2>arguments.length&&(b=0.45);arguments.length?c=b/Sa*Math.asin(1/a):(a=1,c=b/4);return function(d){return 1+a*Math.pow(2,-10*d)*Math.sin((d-c)*Sa/b)}},back:function(a){a||(a=1.70158);return function(b){return b*b*((a+1)*b-a)}},bounce:function(){return Uf}}),ci=A.map({"in":ya,out:Tc,"in-out":Uc,"out-in":function(a){return Uc(Tc(a))}});
A.ease=function(a){var b=a.indexOf("-"),c=0<=b?a.substring(0,b):a,b=0<=b?a.substring(b+1):"in",c=bi.get(c)||wh,b=ci.get(b)||ya;return ue(b(c.apply(null,jh.call(arguments,1))))};A.interpolateHcl=function(a,b){a=A.hcl(a);b=A.hcl(b);var c=a.h,d=a.c,e=a.l,f=b.h-c,g=b.c-d,k=b.l-e;isNaN(g)&&(g=0,d=isNaN(d)?b.c:d);isNaN(f)?(f=0,c=isNaN(c)?b.h:c):180<f?f-=360:-180>f&&(f+=360);return function(a){return da(c+f*a,d+g*a,e+k*a)+""}};A.interpolateHsl=function(a,b){a=A.hsl(a);b=A.hsl(b);var c=a.h,d=a.s,e=a.l,f=
b.h-c,g=b.s-d,k=b.l-e;isNaN(g)&&(g=0,d=isNaN(d)?b.s:d);isNaN(f)?(f=0,c=isNaN(c)?b.h:c):180<f?f-=360:-180>f&&(f+=360);return function(a){return Ga(c+f*a,d+g*a,e+k*a)+""}};A.interpolateLab=function(a,b){a=A.lab(a);b=A.lab(b);var c=a.l,d=a.a,e=a.b,f=b.l-c,g=b.a-d,k=b.b-e;return function(a){return Ba(c+f*a,d+g*a,e+k*a)+""}};A.interpolateRound=ve;A.transform=function(a){var b=hb.createElementNS(A.ns.prefix.svg,"g");return(A.transform=function(a){if(null!=a){b.setAttribute("transform",a);var c=b.transform.baseVal.consolidate()}return new we(c?
c.matrix:di)})(a)};we.prototype.toString=function(){return"translate("+this.translate+")rotate("+this.rotate+")skewX("+this.skew+")scale("+this.scale+")"};var di={a:1,b:0,c:0,d:1,e:0,f:0};A.interpolateTransform=ye;A.layout={};A.layout.bundle=function(){return function(a){for(var b=[],c=-1,d=a.length;++c<d;)b.push(Xf(a[c]));return b}};A.layout.chord=function(){function a(){var c={},h=[],p=A.range(g),s=[],q,t,r,v,u;d=[];e=[];q=0;for(v=-1;++v<g;){t=0;for(u=-1;++u<g;)t+=f[v][u];h.push(t);s.push(A.range(g));
q+=t}l&&p.sort(function(a,b){return l(h[a],h[b])});m&&s.forEach(function(a,b){a.sort(function(a,c){return m(f[b][a],f[b][c])})});q=(Sa-k*g)/q;t=0;for(v=-1;++v<g;){r=t;for(u=-1;++u<g;){var y=p[v],z=s[y][u],B=f[y][z],x=t,w=t+=B*q;c[y+"-"+z]={index:y,subindex:z,startAngle:x,endAngle:w,value:B}}e[y]={index:y,startAngle:r,endAngle:t,value:(t-r)/q};t+=k}for(v=-1;++v<g;)for(u=v-1;++u<g;)if(p=c[v+"-"+u],s=c[u+"-"+v],p.value||s.value)d.push(p.value<s.value?{source:s,target:p}:{source:p,target:s});n&&b()}function b(){d.sort(function(a,
b){return n((a.source.value+a.target.value)/2,(b.source.value+b.target.value)/2)})}var c={},d,e,f,g,k=0,l,m,n;c.matrix=function(a){if(!arguments.length)return f;g=(f=a)&&f.length;d=e=null;return c};c.padding=function(a){if(!arguments.length)return k;k=a;d=e=null;return c};c.sortGroups=function(a){if(!arguments.length)return l;l=a;d=e=null;return c};c.sortSubgroups=function(a){if(!arguments.length)return m;m=a;d=null;return c};c.sortChords=function(a){if(!arguments.length)return n;n=a;d&&b();return c};
c.chords=function(){d||a();return d};c.groups=function(){e||a();return e};return c};A.layout.force=function(){function a(b){return function(a,c,d,e){if(a.point!==b){d=a.cx-b.x;var f=a.cy-b.y;c=e-c;e=d*d+f*f;if(c*c/s<e)return e<h&&(c=a.charge/e,b.px-=d*c,b.py-=f*c),!0;a.point&&(e&&e<h)&&(c=a.pointCharge/e,b.px-=d*c,b.py-=f*c)}return!a.charge}}function b(a){a.px=A.event.x;a.py=A.event.y;c.resume()}var c={},d=A.dispatch("start","tick","end"),e=[1,1],f,g,k=0.9,l=ei,m=fi,n=-30,h=gi,p=0.1,s=0.64,q=[],t=
[],r,v,u;c.tick=function(){if(0.005>(g*=0.99))return d.end({type:"end",alpha:g=0}),!0;var b=q.length,c=t.length,f,l,m,h,s,y,z;for(f=0;f<c;++f)if(l=t[f],m=l.source,h=l.target,y=h.x-m.x,z=h.y-m.y,s=y*y+z*z)s=g*v[f]*((s=Math.sqrt(s))-r[f])/s,y*=s,z*=s,h.x-=y*(s=m.weight/(h.weight+m.weight)),h.y-=z*s,m.x+=y*(s=1-s),m.y+=z*s;if(s=g*p)if(y=e[0]/2,z=e[1]/2,f=-1,s)for(;++f<b;)l=q[f],l.x+=(y-l.x)*s,l.y+=(z-l.y)*s;if(n){Vc(c=A.geom.quadtree(q),g,u);for(f=-1;++f<b;)(l=q[f]).fixed||c.visit(a(l))}for(f=-1;++f<
b;)l=q[f],l.fixed?(l.x=l.px,l.y=l.py):(l.x-=(l.px-(l.px=l.x))*k,l.y-=(l.py-(l.py=l.y))*k);d.tick({type:"tick",alpha:g})};c.nodes=function(a){if(!arguments.length)return q;q=a;return c};c.links=function(a){if(!arguments.length)return t;t=a;return c};c.size=function(a){if(!arguments.length)return e;e=a;return c};c.linkDistance=function(a){if(!arguments.length)return l;l="function"===typeof a?a:+a;return c};c.distance=c.linkDistance;c.linkStrength=function(a){if(!arguments.length)return m;m="function"===
typeof a?a:+a;return c};c.friction=function(a){if(!arguments.length)return k;k=+a;return c};c.charge=function(a){if(!arguments.length)return n;n="function"===typeof a?a:+a;return c};c.chargeDistance=function(a){if(!arguments.length)return Math.sqrt(h);h=a*a;return c};c.gravity=function(a){if(!arguments.length)return p;p=+a;return c};c.theta=function(a){if(!arguments.length)return Math.sqrt(s);s=a*a;return c};c.alpha=function(a){if(!arguments.length)return g;a=+a;g?g=0<a?a:0:0<a&&(d.start({type:"start",
alpha:g=a}),A.timer(c.tick));return c};c.start=function(){function a(c,e){if(!h){h=Array(d);for(g=0;g<d;++g)h[g]=[];for(g=0;g<k;++g){var f=t[g];h[f.source.index].push(f.target);h[f.target.index].push(f.source)}}for(var f=h[b],g=-1,k=f.length,l;++g<k;)if(!isNaN(l=f[g][c]))return l;return Math.random()*e}var b,d=q.length,f=t.length,g=e[0],k=e[1],h,p;for(b=0;b<d;++b)(p=q[b]).index=b,p.weight=0;for(b=0;b<f;++b)p=t[b],"number"==typeof p.source&&(p.source=q[p.source]),"number"==typeof p.target&&(p.target=
q[p.target]),++p.source.weight,++p.target.weight;for(b=0;b<d;++b)p=q[b],isNaN(p.x)&&(p.x=a("x",g)),isNaN(p.y)&&(p.y=a("y",k)),isNaN(p.px)&&(p.px=p.x),isNaN(p.py)&&(p.py=p.y);r=[];if("function"===typeof l)for(b=0;b<f;++b)r[b]=+l.call(this,t[b],b);else for(b=0;b<f;++b)r[b]=l;v=[];if("function"===typeof m)for(b=0;b<f;++b)v[b]=+m.call(this,t[b],b);else for(b=0;b<f;++b)v[b]=m;u=[];if("function"===typeof n)for(b=0;b<d;++b)u[b]=+n.call(this,q[b],b);else for(b=0;b<d;++b)u[b]=n;return c.resume()};c.resume=
function(){return c.alpha(0.1)};c.stop=function(){return c.alpha(0)};c.drag=function(){f||(f=A.behavior.drag().origin(ya).on("dragstart.force",db).on("drag.force",b).on("dragend.force",sb));if(!arguments.length)return f;this.on("mouseover.force",mc).on("mouseout.force",tb).call(f)};return A.rebind(c,d,"on")};var ei=20,fi=1,gi=Infinity;A.layout.hierarchy=function(){function a(e){var f=[e],g=[],k;for(e.depth=0;null!=(k=f.pop());)if(g.push(k),(m=c.call(a,k,k.depth))&&(l=m.length)){for(var l,m,n;0<=--l;)f.push(n=
m[l]),n.parent=k,n.depth=k.depth+1;d&&(k.value=0);k.children=m}else d&&(k.value=+d.call(a,k,k.depth)||0),delete k.children;Pa(e,function(a){var c,e;b&&(c=a.children)&&c.sort(b);if(d&&(e=a.parent))e.value+=a.value});return g}var b=Wc,c=Ae,d=Be;a.sort=function(c){if(!arguments.length)return b;b=c;return a};a.children=function(b){if(!arguments.length)return c;c=b;return a};a.value=function(b){if(!arguments.length)return d;d=b;return a};a.revalue=function(b){d&&(nc(b,function(a){a.children&&(a.value=
0)}),Pa(b,function(b){var c;b.children||(b.value=+d.call(a,b,b.depth)||0);if(c=b.parent)c.value+=b.value}));return b};return a};A.layout.partition=function(){function a(b,c,d,e){var f=b.children;b.x=c;b.y=b.depth*e;b.dx=d;b.dy=e;if(f&&(k=f.length)){var g=-1,k,l;for(d=b.value?d/b.value:0;++g<k;)a(l=f[g],c,b=l.value*d,e),c+=b}}function b(a){a=a.children;var c=0;if(a&&(e=a.length))for(var d=-1,e;++d<e;)c=Math.max(c,b(a[d]));return 1+c}function c(f,g){var k=d.call(this,f,g);a(k[0],0,e[0],e[1]/b(k[0]));
return k}var d=A.layout.hierarchy(),e=[1,1];c.size=function(a){if(!arguments.length)return e;e=a;return c};return ub(c,d)};A.layout.pie=function(){function a(f){var g=f.map(function(c,d){return+b.call(a,c,d)}),k=+("function"===typeof d?d.apply(this,arguments):d),l=(("function"===typeof e?e.apply(this,arguments):e)-k)/A.sum(g),m=A.range(f.length);null!=c&&m.sort(c===xh?function(a,b){return g[b]-g[a]}:function(a,b){return c(f[a],f[b])});var n=[];m.forEach(function(a){var b;n[a]={data:f[a],value:b=g[a],
startAngle:k,endAngle:k+=b*l}});return n}var b=Number,c=xh,d=0,e=Sa;a.value=function(c){if(!arguments.length)return b;b=c;return a};a.sort=function(b){if(!arguments.length)return c;c=b;return a};a.startAngle=function(b){if(!arguments.length)return d;d=b;return a};a.endAngle=function(b){if(!arguments.length)return e;e=b;return a};return a};var xh={};A.layout.stack=function(){function a(k,l){var m=k.map(function(c,d){return b.call(a,c,d)}),n=m.map(function(b){return b.map(function(b,c){return[f.call(a,
b,c),g.call(a,b,c)]})}),h=c.call(a,n,l),m=A.permute(m,h),n=A.permute(n,h),h=d.call(a,n,l),p=m.length,s=m[0].length,q,t,r;for(t=0;t<s;++t){e.call(a,m[0][t],r=h[t],n[0][t][1]);for(q=1;q<p;++q)e.call(a,m[q][t],r+=n[q-1][t][1],n[q][t][1])}return k}var b=ya,c=Bd,d=Cd,e=De,f=Ad,g=Ce;a.values=function(c){if(!arguments.length)return b;b=c;return a};a.order=function(b){if(!arguments.length)return c;c="function"===typeof b?b:hi.get(b)||Bd;return a};a.offset=function(b){if(!arguments.length)return d;d="function"===
typeof b?b:ii.get(b)||Cd;return a};a.x=function(b){if(!arguments.length)return f;f=b;return a};a.y=function(b){if(!arguments.length)return g;g=b;return a};a.out=function(b){if(!arguments.length)return e;e=b;return a};return a};var hi=A.map({"inside-out":function(a){var b=a.length,c,d=a.map(Yf),e=a.map(Ee),f=A.range(b).sort(function(a,b){return d[a]-d[b]}),g=0,k=0,l=[],m=[];for(a=0;a<b;++a)c=f[a],g<k?(g+=e[c],l.push(c)):(k+=e[c],m.push(c));return m.reverse().concat(l)},reverse:function(a){return A.range(a.length).reverse()},
"default":Bd}),ii=A.map({silhouette:function(a){var b=a.length,c=a[0].length,d=[],e=0,f,g,k,l=[];for(g=0;g<c;++g){for(k=f=0;f<b;f++)k+=a[f][g][1];k>e&&(e=k);d.push(k)}for(g=0;g<c;++g)l[g]=(e-d[g])/2;return l},wiggle:function(a){var b=a.length,c=a[0],d=c.length,e,f,g,k,l,m,n,h,p,s=[];s[0]=h=p=0;for(f=1;f<d;++f){for(k=e=0;e<b;++e)k+=a[e][f][1];l=e=0;for(n=c[f][0]-c[f-1][0];e<b;++e){g=0;for(m=(a[e][f][1]-a[e][f-1][1])/(2*n);g<e;++g)m+=(a[g][f][1]-a[g][f-1][1])/n;l+=m*a[e][f][1]}s[f]=h-=k?l/k*n:0;h<p&&
(p=h)}for(f=0;f<d;++f)s[f]-=p;return s},expand:function(a){var b=a.length,c=a[0].length,d=1/b,e,f,g,k=[];for(f=0;f<c;++f){for(g=e=0;e<b;e++)g+=a[e][f][1];if(g)for(e=0;e<b;e++)a[e][f][1]/=g;else for(e=0;e<b;e++)a[e][f][1]=d}for(f=0;f<c;++f)k[f]=0;return k},zero:Cd});A.layout.histogram=function(){function a(f,g){var k=[],l=f.map(c,this),m=d.call(this,l,g),n=e.call(this,m,l,g),h;g=-1;for(var p=l.length,s=n.length-1,q=b?1:1/p;++g<s;)h=k[g]=[],h.dx=n[g+1]-(h.x=n[g]),h.y=0;if(0<s)for(g=-1;++g<p;)h=l[g],
h>=m[0]&&h<=m[1]&&(h=k[A.bisect(n,h,1,s)-1],h.y+=q,h.push(f[g]));return k}var b=!0,c=Number,d=$f,e=Yc;a.value=function(b){if(!arguments.length)return c;c=b;return a};a.range=function(b){if(!arguments.length)return d;d=ga(b);return a};a.bins=function(b){if(!arguments.length)return e;e="number"===typeof b?function(a){return Zc(a,b)}:ga(b);return a};a.frequency=function(c){if(!arguments.length)return b;b=!!c;return a};return a};A.layout.pack=function(){function a(f,g){var k=b.call(this,f,g),l=k[0],m=
d[0],n=d[1],h=null==e?Math.sqrt:"function"===typeof e?e:function(){return e};l.x=l.y=0;Pa(l,function(a){a.r=+h(a.value)});Pa(l,Ie);if(c){var p=c*(e?1:Math.max(2*l.r/m,2*l.r/n))/2;Pa(l,function(a){a.r+=p});Pa(l,Ie);Pa(l,function(a){a.r-=p})}Je(l,m/2,n/2,e?1:1/Math.max(2*l.r/m,2*l.r/n));return k}var b=A.layout.hierarchy().sort(Fe),c=0,d=[1,1],e;a.size=function(b){if(!arguments.length)return d;d=b;return a};a.radius=function(b){if(!arguments.length)return e;e=null==b||"function"===typeof b?b:+b;return a};
a.padding=function(b){if(!arguments.length)return c;c=+b;return a};return ub(a,b)};A.layout.tree=function(){function a(m,n){var h=f.call(this,m,n),p=h[0],s=b(p);Pa(s,c);s.parent.m=-s.z;nc(s,d);if(l)nc(p,e);else{var q=p,t=p,r=p;nc(p,function(a){a.x<q.x&&(q=a);a.x>t.x&&(t=a);a.depth>r.depth&&(r=a)});var v=g(q,t)/2-q.x,u=k[0]/(t.x+g(t,q)/2+v),y=k[1]/(r.depth||1);nc(p,function(a){a.x=(a.x+v)*u;a.y=a.depth*y})}return h}function b(a){a={A:null,children:[a]};for(var c=[a],d;null!=(d=c.pop());)for(var e=
d.children,f,g=0,k=e.length;g<k;++g)c.push((e[g]=f={_:e[g],parent:d,children:(f=e[g].children)&&f.slice()||[],A:null,a:null,z:0,m:0,c:0,s:0,t:null,i:g}).a=f);return a.children[0]}function c(a){var b=a.children,d=a.parent.children,e=a.i?d[a.i-1]:null;if(b.length){for(var f=0,k=0,l=a.children,m=l.length,n;0<=--m;)n=l[m],n.z+=f,n.m+=f,f+=n.s+(k+=n.c);b=(b[0].z+b[b.length-1].z)/2;e?(a.z=e.z+g(a._,e._),a.m=a.z-b):a.z=b}else e&&(a.z=e.z+g(a._,e._));b=a.parent;d=a.parent.A||d[0];if(e){k=f=a;l=f.parent.children[0];
m=f.m;n=k.m;for(var h=e.m,p=l.m,s;e=Ed(e),f=oc(f),e&&f;){l=oc(l);k=Ed(k);k.a=a;s=e.z+h-f.z-m+g(e._,f._);if(0<s){var q=e.a.parent===a.parent?e.a:d,t=a,r=s,v=r/(t.i-q.i);t.c-=v;t.s+=r;q.c+=v;t.z+=r;t.m+=r;m+=s;n+=s}h+=e.m;m+=f.m;p+=l.m;n+=k.m}e&&!Ed(k)&&(k.t=e,k.m+=h-n);f&&!oc(l)&&(l.t=f,l.m+=m-p,d=a)}b.A=d}function d(a){a._.x=a.z+a.parent.m;a.m+=a.parent.m}function e(a){a.x*=k[0];a.y=a.depth*k[1]}var f=A.layout.hierarchy().sort(null).value(null),g=Le,k=[1,1],l=null;a.separation=function(b){if(!arguments.length)return g;
g=b;return a};a.size=function(b){if(!arguments.length)return l?null:k;l=null==(k=b)?e:null;return a};a.nodeSize=function(b){if(!arguments.length)return l?k:null;l=null==(k=b)?null:e;return a};return ub(a,f)};A.layout.cluster=function(){function a(f,g){var k=b.call(this,f,g),l=k[0],m,n=0;Pa(l,function(a){var b=a.children;b&&b.length?(a.x=dg(b),a.y=cg(b)):(a.x=m?n+=c(a,m):0,a.y=0,m=a)});var h=Fd(l),p=Gd(l),s=h.x-c(h,p)/2,q=p.x+c(p,h)/2;Pa(l,e?function(a){a.x=(a.x-l.x)*d[0];a.y=(l.y-a.y)*d[1]}:function(a){a.x=
(a.x-s)/(q-s)*d[0];a.y=(1-(l.y?a.y/l.y:1))*d[1]});return k}var b=A.layout.hierarchy().sort(null).value(null),c=Le,d=[1,1],e=!1;a.separation=function(b){if(!arguments.length)return c;c=b;return a};a.size=function(b){if(!arguments.length)return e?null:d;e=null==(d=b);return a};a.nodeSize=function(b){if(!arguments.length)return e?d:null;e=null!=(d=b);return a};return ub(a,b)};A.layout.treemap=function(){function a(b,c){for(var d=-1,e=b.length,f,g;++d<e;)g=(f=b[d]).value*(0>c?0:c),f.area=isNaN(g)||0>=
g?0:g}function b(c){var e=c.children;if(e&&e.length){var f=m(c),g=[],k=e.slice(),l=Infinity,n,h="slice"===p?f.dx:"dice"===p?f.dy:"slice-dice"===p?c.depth&1?f.dy:f.dx:Math.min(f.dx,f.dy);a(k,f.dx*f.dy/c.value);for(g.area=0;0<(c=k.length);){g.push(c=k[c-1]);g.area+=c.area;if(!(c="squarify"!==p)){n=h;c=g.area;for(var q=void 0,t=0,r=Infinity,v=-1,u=g.length;++v<u;)if(q=g[v].area)q<r&&(r=q),q>t&&(t=q);c*=c;n*=n;c=(n=c?Math.max(n*t*s/c,c/(n*r*s)):Infinity)<=l}c?(k.pop(),l=n):(g.area-=g.pop().area,d(g,h,
f,!1),h=Math.min(f.dx,f.dy),g.length=g.area=0,l=Infinity)}g.length&&(d(g,h,f,!0),g.length=g.area=0);e.forEach(b)}}function c(b){var e=b.children;if(e&&e.length){var f=m(b),g=e.slice(),k=[];a(g,f.dx*f.dy/b.value);for(k.area=0;b=g.pop();)k.push(b),k.area+=b.area,null!=b.z&&(d(k,b.z?f.dx:f.dy,f,!g.length),k.length=k.area=0);e.forEach(c)}}function d(a,b,c,e){var f=-1,k=a.length,l=c.x,m=c.y,n=b?g(a.area/b):0,h;if(b==c.dx){if(e||n>c.dy)n=c.dy;for(;++f<k;)h=a[f],h.x=l,h.y=m,h.dy=n,l+=h.dx=Math.min(c.x+c.dx-
l,n?g(h.area/n):0);h.z=!0;h.dx+=c.x+c.dx-l;c.y+=n;c.dy-=n}else{if(e||n>c.dx)n=c.dx;for(;++f<k;)h=a[f],h.x=l,h.y=m,h.dx=n,m+=h.dy=Math.min(c.y+c.dy-m,n?g(h.area/n):0);h.z=!1;h.dy+=c.y+c.dy-m;c.x+=n;c.dx-=n}}function e(d){d=h||f(d);var g=d[0];g.x=0;g.y=0;g.dx=k[0];g.dy=k[1];h&&f.revalue(g);a([g],g.dx*g.dy/g.value);(h?c:b)(g);n&&(h=d);return d}var f=A.layout.hierarchy(),g=Math.round,k=[1,1],l=null,m=$c,n=!1,h,p="squarify",s=0.5*(1+Math.sqrt(5));e.size=function(a){if(!arguments.length)return k;k=a;return e};
e.padding=function(a){function b(c){var d=a.call(e,c,c.depth);return null==d?$c(c):ad(c,"number"===typeof d?[d,d,d,d]:d)}function c(b){return ad(b,a)}if(!arguments.length)return l;var d;m=null==(l=a)?$c:"function"===(d=typeof a)?b:"number"===d?(a=[a,a,a,a],c):c;return e};e.round=function(a){if(!arguments.length)return g!=Number;g=a?Math.round:Number;return e};e.sticky=function(a){if(!arguments.length)return n;n=a;h=null;return e};e.ratio=function(a){if(!arguments.length)return s;s=a;return e};e.mode=
function(a){if(!arguments.length)return p;p=a+"";return e};return ub(e,f)};A.random={normal:function(a,b){var c=arguments.length;2>c&&(b=1);1>c&&(a=0);return function(){var c,d;do c=2*Math.random()-1,d=2*Math.random()-1,d=c*c+d*d;while(!d||1<d);return a+b*c*Math.sqrt(-2*Math.log(d)/d)}},logNormal:function(){var a=A.random.normal.apply(A,arguments);return function(){return Math.exp(a())}},bates:function(a){var b=A.random.irwinHall(a);return function(){return b()/a}},irwinHall:function(a){return function(){for(var b=
0,c=0;c<a;c++)b+=Math.random();return b}}};A.scale={};var Jh={floor:ya,ceil:ya};A.scale.linear=function(){return Cg([0,1],[0,1],kb,!1)};var Kh={s:1,g:1,p:1,r:1,e:1};A.scale.log=function(){return Dg(A.scale.linear().domain([0,1]),10,!0,[1,10])};var $g=A.format(".0e"),Lh={floor:function(a){return-Math.ceil(-a)},ceil:function(a){return-Math.floor(-a)}};A.scale.pow=function(){return Eg(A.scale.linear(),1,[0,1])};A.scale.sqrt=function(){return A.scale.pow().exponent(0.5)};A.scale.ordinal=function(){return Fg([],
{t:"range",a:[[]]})};A.scale.category10=function(){return A.scale.ordinal().range(ji)};A.scale.category20=function(){return A.scale.ordinal().range(ki)};A.scale.category20b=function(){return A.scale.ordinal().range(li)};A.scale.category20c=function(){return A.scale.ordinal().range(mi)};var ji=[2062260,16744206,2924588,14034728,9725885,9197131,14907330,8355711,12369186,1556175].map(Db),ki=[2062260,11454440,16744206,16759672,2924588,10018698,14034728,16750742,9725885,12955861,9197131,12885140,14907330,
16234194,8355711,13092807,12369186,14408589,1556175,10410725].map(Db),li=[3750777,5395619,7040719,10264286,6519097,9216594,11915115,13556636,9202993,12426809,15186514,15190932,8666169,11356490,14049643,15177372,8077683,10834324,13528509,14589654].map(Db),mi=[3244733,7057110,10406625,13032431,15095053,16616764,16625259,16634018,3253076,7652470,10607003,13101504,7695281,10394312,12369372,14342891,6513507,9868950,12434877,14277081].map(Db);A.scale.quantile=function(){return Gg([],[])};A.scale.quantize=
function(){return Hg(0,1,[0,1])};A.scale.threshold=function(){return Ig([0.5],[0,1])};A.scale.identity=function(){return Jg([0,1])};A.svg={};A.svg.arc=function(){function a(){var f=b.apply(this,arguments),g=c.apply(this,arguments),k=d.apply(this,arguments)+tc,l=e.apply(this,arguments)+tc,m=(l<k&&(m=k,k=l,l=m),l-k),n=m<V?"0":"1",h=Math.cos(k),k=Math.sin(k),p=Math.cos(l),l=Math.sin(l);return m>=ni?f?"M0,"+g+"A"+g+","+g+" 0 1,1 0,"+-g+"A"+g+","+g+" 0 1,1 0,"+g+"M0,"+f+"A"+f+","+f+" 0 1,0 0,"+-f+"A"+
f+","+f+" 0 1,0 0,"+f+"Z":"M0,"+g+"A"+g+","+g+" 0 1,1 0,"+-g+"A"+g+","+g+" 0 1,1 0,"+g+"Z":f?"M"+g*h+","+g*k+"A"+g+","+g+" 0 "+n+",1 "+g*p+","+g*l+"L"+f*p+","+f*l+"A"+f+","+f+" 0 "+n+",0 "+f*h+","+f*k+"Z":"M"+g*h+","+g*k+"A"+g+","+g+" 0 "+n+",1 "+g*p+","+g*l+"L0,0Z"}var b=Fh,c=Gh,d=Kg,e=Lg;a.innerRadius=function(c){if(!arguments.length)return b;b=ga(c);return a};a.outerRadius=function(b){if(!arguments.length)return c;c=ga(b);return a};a.startAngle=function(b){if(!arguments.length)return d;d=ga(b);
return a};a.endAngle=function(b){if(!arguments.length)return e;e=ga(b);return a};a.centroid=function(){var a=(b.apply(this,arguments)+c.apply(this,arguments))/2,f=(d.apply(this,arguments)+e.apply(this,arguments))/2+tc;return[Math.cos(f)*a,Math.sin(f)*a]};return a};var tc=-Fa,ni=Sa-O;A.svg.line=function(){return Mg(ya)};var ng=A.map({linear:Na,"linear-closed":function(a){return Na(a)+"Z"},step:function(a){for(var b=0,c=a.length,d=a[0],e=[d[0],",",d[1]];++b<c;)e.push("H",(d[0]+(d=a[b])[0])/2,"V",d[1]);
1<c&&e.push("H",d[0]);return e.join("")},"step-before":tf,"step-after":uf,basis:ah,"basis-open":function(a){if(4>a.length)return Na(a);for(var b=[],c=-1,d=a.length,e,f=[0],g=[0];3>++c;)e=a[c],f.push(e[0]),g.push(e[1]);b.push(Wa(Xb,f)+","+Wa(Xb,g));for(--c;++c<d;)e=a[c],f.shift(),f.push(e[0]),g.shift(),g.push(e[1]),pg(b,f,g);return b.join("")},"basis-closed":function(a){for(var b,c=-1,d=a.length,e=d+4,f,g=[],k=[];4>++c;)f=a[c%d],g.push(f[0]),k.push(f[1]);b=[Wa(Xb,g),",",Wa(Xb,k)];for(--c;++c<e;)f=
a[c%d],g.shift(),g.push(f[0]),k.shift(),k.push(f[1]),pg(b,g,k);return b.join("")},bundle:function(a,b){var c=a.length-1;if(c)for(var d=a[0][0],e=a[0][1],f=a[c][0]-d,g=a[c][1]-e,k=-1,l,m;++k<=c;)l=a[k],m=k/c,l[0]=b*l[0]+(1-b)*(d+m*f),l[1]=b*l[1]+(1-b)*(e+m*g);return ah(a)},cardinal:function(a,b){return 3>a.length?Na(a):a[0]+Pd(a,og(a,b))},"cardinal-open":function(a,b){return 4>a.length?Na(a):a[1]+Pd(a.slice(1,a.length-1),og(a,b))},"cardinal-closed":function(a,b){return 3>a.length?Na(a):a[0]+Pd((a.push(a[0]),
a),og([a[a.length-2]].concat(a,[a[1]]),b))},monotone:function(a){if(3>a.length)a=Na(a);else{var b=a[0],c=[],d,e,f,g;d=0;e=a.length-1;var k=[];f=a[1];for(g=k[0]=qg(a[0],f);++d<e;)k[d]=(g+(g=qg(f,f=a[d+1])))/2;k[d]=g;for(var l=-1,m=a.length-1;++l<m;)d=qg(a[l],a[l+1]),Y(d)<O?k[l]=k[l+1]=0:(e=k[l]/d,f=k[l+1]/d,g=e*e+f*f,9<g&&(g=3*d/Math.sqrt(g),k[l]=g*e,k[l+1]=g*f));for(l=-1;++l<=m;)g=(a[Math.min(m,l+1)][0]-a[Math.max(0,l-1)][0])/(6*(1+k[l]*k[l])),c.push([g||0,k[l]*g||0]);a=b+Pd(a,c)}return a}});ng.forEach(function(a,
b){b.key=a;b.closed=/-closed$/.test(a)});var bh=[0,2/3,1/3,0],ch=[0,1/3,2/3,0],Xb=[0,1/6,2/3,1/6];A.svg.line.radial=function(){var a=Mg(dh);a.radius=a.x;delete a.x;a.angle=a.y;delete a.y;return a};tf.reverse=uf;uf.reverse=tf;A.svg.area=function(){return eh(ya)};A.svg.area.radial=function(){var a=eh(dh);a.radius=a.x;delete a.x;a.innerRadius=a.x0;delete a.x0;a.outerRadius=a.x1;delete a.x1;a.angle=a.y;delete a.y;a.startAngle=a.y0;delete a.y0;a.endAngle=a.y1;delete a.y1;return a};A.svg.chord=function(){function a(e,
f){var g=b(this,c,e,f),k=b(this,d,e,f);return"M"+g.p0+("A"+g.r+","+g.r+" 0 "+ +(g.a1-g.a0>V)+",1 "+g.p1)+(g.a0==k.a0&&g.a1==k.a1?"Q 0,0 "+g.p0:"Q 0,0 "+k.p0+("A"+k.r+","+k.r+" 0 "+ +(k.a1-k.a0>V)+",1 "+k.p1)+("Q 0,0 "+g.p0))+"Z"}function b(a,c,d,k){var l=c.call(a,d,k);c=e.call(a,l,k);d=f.call(a,l,k)+tc;a=g.call(a,l,k)+tc;return{r:c,a0:d,a1:a,p0:[c*Math.cos(d),c*Math.sin(d)],p1:[c*Math.cos(a),c*Math.sin(a)]}}var c=Mc,d=dc,e=Mh,f=Kg,g=Lg;a.radius=function(b){if(!arguments.length)return e;e=ga(b);return a};
a.source=function(b){if(!arguments.length)return c;c=ga(b);return a};a.target=function(b){if(!arguments.length)return d;d=ga(b);return a};a.startAngle=function(b){if(!arguments.length)return f;f=ga(b);return a};a.endAngle=function(b){if(!arguments.length)return g;g=ga(b);return a};return a};A.svg.diagonal=function(){function a(e,f){var g=b.call(this,e,f),k=c.call(this,e,f),l=(g.y+k.y)/2,g=[g,{x:g.x,y:l},{x:k.x,y:l},k],g=g.map(d);return"M"+g[0]+"C"+g[1]+" "+g[2]+" "+g[3]}var b=Mc,c=dc,d=fh;a.source=
function(c){if(!arguments.length)return b;b=ga(c);return a};a.target=function(b){if(!arguments.length)return c;c=ga(b);return a};a.projection=function(b){if(!arguments.length)return d;d=b;return a};return a};A.svg.diagonal.radial=function(){var a=A.svg.diagonal(),b=fh,c=a.projection;a.projection=function(a){return arguments.length?c(Nh(b=a)):b};return a};A.svg.symbol=function(){function a(d,e){return(yh.get(b.call(this,d,e))||gh)(c.call(this,d,e))}var b=Ph,c=Oh;a.type=function(c){if(!arguments.length)return b;
b=ga(c);return a};a.size=function(b){if(!arguments.length)return c;c=ga(b);return a};return a};var yh=A.map({circle:gh,cross:function(a){a=Math.sqrt(a/5)/2;return"M"+-3*a+","+-a+"H"+-a+"V"+-3*a+"H"+a+"V"+-a+"H"+3*a+"V"+a+"H"+a+"V"+3*a+"H"+-a+"V"+a+"H"+-3*a+"Z"},diamond:function(a){a=Math.sqrt(a/(2*zh));var b=a*zh;return"M0,"+-a+"L"+b+",0 0,"+a+" "+-b+",0Z"},square:function(a){a=Math.sqrt(a)/2;return"M"+-a+","+-a+"L"+a+","+-a+" "+a+","+a+" "+-a+","+a+"Z"},"triangle-down":function(a){a=Math.sqrt(a/
pf);var b=a*pf/2;return"M0,"+b+"L"+a+","+-b+" "+-a+","+-b+"Z"},"triangle-up":function(a){a=Math.sqrt(a/pf);var b=a*pf/2;return"M0,"+-b+"L"+a+","+b+" "+-a+","+b+"Z"}});A.svg.symbolTypes=yh.keys();var pf=Math.sqrt(3),zh=Math.tan(30*X),Aa=[],nh=0,vc,af;Aa.call=fa.call;Aa.empty=fa.empty;Aa.node=fa.node;Aa.size=fa.size;A.transition=function(a){return arguments.length?vc?a.transition():a:mh.transition()};A.transition.prototype=Aa;Aa.select=function(a){var b=this.id,c=[],d,e,f;a=u(a);for(var g=-1,k=this.length;++g<
k;){c.push(d=[]);for(var l=this[g],m=-1,n=l.length;++m<n;)(f=l[m])&&(e=a.call(f,f.__data__,m,g))?("__data__"in f&&(e.__data__=f.__data__),Ye(e,m,b,f.__transition__[b]),d.push(e)):d.push(null)}return Ld(c,b)};Aa.selectAll=function(a){var b=this.id,c=[],d,e,f,g;a=z(a);for(var k=-1,l=this.length;++k<l;)for(var m=this[k],n=-1,h=m.length;++n<h;)if(d=m[n]){g=d.__transition__[b];e=a.call(d,d.__data__,n,k);c.push(d=[]);for(var p=-1,s=e.length;++p<s;)(f=e[p])&&Ye(f,p,b,g),d.push(f)}return Ld(c,b)};Aa.filter=
function(a){var b=[],c,d,e;"function"!==typeof a&&(a=L(a));for(var f=0,g=this.length;f<g;f++){b.push(c=[]);d=this[f];for(var k=0,l=d.length;k<l;k++)(e=d[k])&&a.call(e,e.__data__,k,f)&&c.push(e)}return Ld(b,this.id)};Aa.tween=function(a,b){var c=this.id;return 2>arguments.length?this.node().__transition__[c].tween.get(a):N(this,null==b?function(b){b.__transition__[c].tween.remove(a)}:function(d){d.__transition__[c].tween.set(a,b)})};Aa.attr=function(a,b){function c(){this.removeAttribute(k)}function d(){this.removeAttributeNS(k.space,
k.local)}function e(a){return null==a?c:(a+="",function(){var b=this.getAttribute(k),c;return b!==a&&(c=g(b,a),function(a){this.setAttribute(k,c(a))})})}function f(a){return null==a?d:(a+="",function(){var b=this.getAttributeNS(k.space,k.local),c;return b!==a&&(c=g(b,a),function(a){this.setAttributeNS(k.space,k.local,c(a))})})}if(2>arguments.length){for(b in a)this.attr(b,a[b]);return this}var g="transform"==a?ye:kb,k=A.ns.qualify(a);return rg(this,"attr."+a,b,k.local?f:e)};Aa.attrTween=function(a,
b){function c(a,d){var f=b.call(this,a,d,this.getAttribute(e));return f&&function(a){this.setAttribute(e,f(a))}}function d(a,c){var f=b.call(this,a,c,this.getAttributeNS(e.space,e.local));return f&&function(a){this.setAttributeNS(e.space,e.local,f(a))}}var e=A.ns.qualify(a);return this.tween("attr."+a,e.local?d:c)};Aa.style=function(a,b,c){function d(){this.style.removeProperty(a)}var e=arguments.length;if(3>e){if("string"!==typeof a){2>e&&(b="");for(c in a)this.style(c,a[c],b);return this}c=""}return rg(this,
"style."+a,b,function(b){return null==b?d:(b+="",function(){var d=Qa.getComputedStyle(this,null).getPropertyValue(a),e;return d!==b&&(e=kb(d,b),function(b){this.style.setProperty(a,e(b),c)})})})};Aa.styleTween=function(a,b,c){3>arguments.length&&(c="");return this.tween("style."+a,function(d,e){var f=b.call(this,d,e,Qa.getComputedStyle(this,null).getPropertyValue(a));return f&&function(b){this.style.setProperty(a,f(b),c)}})};Aa.text=function(a){return rg(this,"text",a,Qh)};Aa.remove=function(){return this.each("end.transition",
function(){var a;2>this.__transition__.count&&(a=this.parentNode)&&a.removeChild(this)})};Aa.ease=function(a){var b=this.id;if(1>arguments.length)return this.node().__transition__[b].ease;"function"!==typeof a&&(a=A.ease.apply(A,arguments));return N(this,function(c){c.__transition__[b].ease=a})};Aa.delay=function(a){var b=this.id;return 1>arguments.length?this.node().__transition__[b].delay:N(this,"function"===typeof a?function(c,d,e){c.__transition__[b].delay=+a.call(c,c.__data__,d,e)}:(a=+a,function(c){c.__transition__[b].delay=
a}))};Aa.duration=function(a){var b=this.id;return 1>arguments.length?this.node().__transition__[b].duration:N(this,"function"===typeof a?function(c,d,e){c.__transition__[b].duration=Math.max(1,a.call(c,c.__data__,d,e))}:(a=Math.max(1,a),function(c){c.__transition__[b].duration=a}))};Aa.each=function(a,b){var c=this.id;if(2>arguments.length){var d=af,e=vc;vc=c;N(this,function(b,d,e){af=b.__transition__[c];a.call(b,b.__data__,d,e)});af=d;vc=e}else N(this,function(d){d=d.__transition__[c];(d.event||
(d.event=A.dispatch("start","end"))).on(a,b)});return this};Aa.transition=function(){for(var a=this.id,b=++nh,c=[],d,e,f,g,k=0,l=this.length;k<l;k++){c.push(d=[]);e=this[k];for(var m=0,n=e.length;m<n;m++){if(f=e[m])g=Object.create(f.__transition__[a]),g.delay+=g.duration,Ye(f,m,b,g);d.push(f)}}return Ld(c,b)};A.svg.axis=function(){function a(m){m.each(function(){var a=A.select(this),m=this.__chart__||b,n=this.__chart__=b.copy(),h=null==k?n.ticks?n.ticks.apply(n,g):n.domain():k,p=null==l?n.tickFormat?
n.tickFormat.apply(n,g):ya:l,s=a.selectAll(".tick").data(h,n),h=s.enter().insert("g",".domain").attr("class","tick").style("opacity",O),q=A.transition(s.exit()).style("opacity",O).remove(),t=A.transition(s.order()).style("opacity",1),r,v=bd(n),a=a.selectAll(".domain").data([0]),a=(a.enter().append("path").attr("class","domain"),A.transition(a));h.append("line");h.append("text");var u=h.select("line"),y=t.select("line"),p=s.select("text").text(p),s=h.select("text"),z=t.select("text");switch(c){case "bottom":r=
hh;u.attr("y2",d);s.attr("y",Math.max(d,0)+f);y.attr("x2",0).attr("y2",d);z.attr("x",0).attr("y",Math.max(d,0)+f);p.attr("dy",".71em").style("text-anchor","middle");a.attr("d","M"+v[0]+","+e+"V0H"+v[1]+"V"+e);break;case "top":r=hh;u.attr("y2",-d);s.attr("y",-(Math.max(d,0)+f));y.attr("x2",0).attr("y2",-d);z.attr("x",0).attr("y",-(Math.max(d,0)+f));p.attr("dy","0em").style("text-anchor","middle");a.attr("d","M"+v[0]+","+-e+"V0H"+v[1]+"V"+-e);break;case "left":r=ih;u.attr("x2",-d);s.attr("x",-(Math.max(d,
0)+f));y.attr("x2",-d).attr("y2",0);z.attr("x",-(Math.max(d,0)+f)).attr("y",0);p.attr("dy",".32em").style("text-anchor","end");a.attr("d","M"+-e+","+v[0]+"H0V"+v[1]+"H"+-e);break;case "right":r=ih,u.attr("x2",d),s.attr("x",Math.max(d,0)+f),y.attr("x2",d).attr("y2",0),z.attr("x",Math.max(d,0)+f).attr("y",0),p.attr("dy",".32em").style("text-anchor","start"),a.attr("d","M"+e+","+v[0]+"H0V"+v[1]+"H"+e)}if(n.rangeBand)var B=n,x=B.rangeBand()/2,m=n=function(a){return B(a)+x};else m.rangeBand?m=n:q.call(r,
n);h.call(r,m);t.call(r,n)})}var b=A.scale.linear(),c=Ah,d=6,e=6,f=3,g=[10],k=null,l;a.scale=function(c){if(!arguments.length)return b;b=c;return a};a.orient=function(b){if(!arguments.length)return c;c=b in oi?b+"":Ah;return a};a.ticks=function(){if(!arguments.length)return g;g=arguments;return a};a.tickValues=function(b){if(!arguments.length)return k;k=b;return a};a.tickFormat=function(b){if(!arguments.length)return l;l=b;return a};a.tickSize=function(b){var c=arguments.length;if(!c)return d;d=+b;
e=+arguments[c-1];return a};a.innerTickSize=function(b){if(!arguments.length)return d;d=+b;return a};a.outerTickSize=function(b){if(!arguments.length)return e;e=+b;return a};a.tickPadding=function(b){if(!arguments.length)return f;f=+b;return a};a.tickSubdivide=function(){return arguments.length&&a};return a};var Ah="bottom",oi={top:1,right:1,bottom:1,left:1};A.svg.brush=function(){function a(f){f.each(function(){var f=A.select(this).style("pointer-events","all").style("-webkit-tap-highlight-color",
"rgba(0,0,0,0)").on("mousedown.brush",e).on("touchstart.brush",e),l=f.selectAll(".background").data([0]);l.enter().append("rect").attr("class","background").style("visibility","hidden").style("cursor","crosshair");f.selectAll(".extent").data([0]).enter().append("rect").attr("class","extent").style("cursor","move");var m=f.selectAll(".resize").data(t,ya);m.exit().remove();m.enter().append("g").attr("class",function(a){return"resize "+a}).style("cursor",function(a){return pi[a]}).append("rect").attr("x",
function(a){return/[ew]$/.test(a)?-3:null}).attr("y",function(a){return/^[ns]/.test(a)?-3:null}).attr("width",6).attr("height",6).style("visibility","hidden");m.style("display",a.empty()?"none":null);f=A.transition(f);l=A.transition(l);g&&(m=bd(g),l.attr("x",m[0]).attr("width",m[1]-m[0]),c(f));k&&(m=bd(k),l.attr("y",m[0]).attr("height",m[1]-m[0]),d(f));b(f)})}function b(a){a.selectAll(".resize").attr("transform",function(a){return"translate("+l[+/e$/.test(a)]+","+m[+/^s/.test(a)]+")"})}function c(a){a.select(".extent").attr("x",
l[0]);a.selectAll(".extent,.n>rect,.s>rect").attr("width",l[1]-l[0])}function d(a){a.select(".extent").attr("y",m[0]);a.selectAll(".extent,.e>rect,.w>rect").attr("height",m[1]-m[0])}function e(){function q(){var a=A.mouse(u),e=!1;M&&(a[0]+=M[0],a[1]+=M[1]);F||(A.event.altKey?(G||(G=[(l[0]+l[1])/2,(m[0]+m[1])/2]),K[0]=l[+(a[0]<G[0])],K[1]=m[+(a[1]<G[1])]):G=null);w&&t(a,g,0)&&(c(B),e=!0);C&&t(a,k,1)&&(d(B),e=!0);e&&(b(B),z({type:"brush",mode:F?"move":"resize"}))}function t(a,b,c){var d=bd(b);b=d[0];
var e=d[1],d=K[c],f=c?m:l,g=f[1]-f[0];F&&(b-=d,e-=g+d);a=(c?s:p)?Math.max(b,Math.min(e,a[c])):a[c];F?b=(a+=d)+g:(G&&(d=Math.max(b,Math.min(e,2*G[c]-a))),d<a?(b=a,a=d):b=d);if(f[0]!=a||f[1]!=b)return c?h=null:n=null,f[0]=a,f[1]=b,!0}function r(){q();B.style("pointer-events","all").selectAll(".resize").style("display",a.empty()?"none":null);A.select("body").style("cursor",null);D.on("mousemove.brush",null).on("mouseup.brush",null).on("touchmove.brush",null).on("touchend.brush",null).on("keydown.brush",
null).on("keyup.brush",null);I();z({type:"brushend"})}var u=this,y=A.select(A.event.target),z=f.of(u,arguments),B=A.select(u),x=y.datum(),w=!/^(n|s)$/.test(x)&&g,C=!/^(e|w)$/.test(x)&&k,F=y.classed("extent"),I=P(),G,K=A.mouse(u),M,D=A.select(Qa).on("keydown.brush",function(){32==A.event.keyCode&&(F||(G=null,K[0]-=l[1],K[1]-=m[1],F=2),v())}).on("keyup.brush",function(){32==A.event.keyCode&&2==F&&(K[0]+=l[1],K[1]+=m[1],F=0,v())});if(A.event.changedTouches)D.on("touchmove.brush",q).on("touchend.brush",
r);else D.on("mousemove.brush",q).on("mouseup.brush",r);B.interrupt().selectAll("*").interrupt();if(F)K[0]=l[0]-K[0],K[1]=m[0]-K[1];else if(x){var Z=+/w$/.test(x),x=+/^n/.test(x);M=[l[1-Z]-K[0],m[1-x]-K[1]];K[0]=l[Z];K[1]=m[x]}else A.event.altKey&&(G=K.slice());B.style("pointer-events","none").selectAll(".resize").style("display",null);A.select("body").style("cursor",y.style("cursor"));z({type:"brushstart"});q()}var f=q(a,"brushstart","brush","brushend"),g=null,k=null,l=[0,0],m=[0,0],n,h,p=!0,s=!0,
t=zg[0];a.event=function(a){a.each(function(){var a=f.of(this,arguments),b={x:l,y:m,i:n,j:h},c=this.__chart__||b;this.__chart__=b;vc?A.select(this).transition().each("start.brush",function(){n=c.i;h=c.j;l=c.x;m=c.y;a({type:"brushstart"})}).tween("brush:brush",function(){var c=lc(l,b.x),d=lc(m,b.y);n=h=null;return function(e){l=b.x=c(e);m=b.y=d(e);a({type:"brush",mode:"resize"})}}).each("end.brush",function(){n=b.i;h=b.j;a({type:"brush",mode:"resize"});a({type:"brushend"})}):(a({type:"brushstart"}),
a({type:"brush",mode:"resize"}),a({type:"brushend"}))})};a.x=function(b){if(!arguments.length)return g;g=b;t=zg[!g<<1|!k];return a};a.y=function(b){if(!arguments.length)return k;k=b;t=zg[!g<<1|!k];return a};a.clamp=function(b){if(!arguments.length)return g&&k?[p,s]:g?p:k?s:null;g&&k?(p=!!b[0],s=!!b[1]):g?p=!!b:k&&(s=!!b);return a};a.extent=function(b){var c,d,e,f,p;if(!arguments.length)return g&&(n?(c=n[0],d=n[1]):(c=l[0],d=l[1],g.invert&&(c=g.invert(c),d=g.invert(d)),d<c&&(p=c,c=d,d=p))),k&&(h?(e=
h[0],f=h[1]):(e=m[0],f=m[1],k.invert&&(e=k.invert(e),f=k.invert(f)),f<e&&(p=e,e=f,f=p))),g&&k?[[c,e],[d,f]]:g?[c,d]:k&&[e,f];if(g&&(c=b[0],d=b[1],k&&(c=c[0],d=d[0]),n=[c,d],g.invert&&(c=g(c),d=g(d)),d<c&&(p=c,c=d,d=p),c!=l[0]||d!=l[1]))l=[c,d];if(k&&(e=b[0],f=b[1],g&&(e=e[1],f=f[1]),h=[e,f],k.invert&&(e=k(e),f=k(f)),f<e&&(p=e,e=f,f=p),e!=m[0]||f!=m[1]))m=[e,f];return a};a.clear=function(){a.empty()||(l=[0,0],m=[0,0],n=h=null);return a};a.empty=function(){return!!g&&l[0]==l[1]||!!k&&m[0]==m[1]};return A.rebind(a,
f,"on")};var pi={n:"ns-resize",e:"ew-resize",s:"ns-resize",w:"ew-resize",nw:"nwse-resize",ne:"nesw-resize",se:"nwse-resize",sw:"nesw-resize"},zg=["n e s w nw ne se sw".split(" "),["e","w"],["n","s"],[]],Ag=R.format=ph.timeFormat,Bh=Ag.utc,Ch=Bh("%Y-%m-%dT%H:%M:%S.%LZ");Ag.iso=Date.prototype.toISOString&&+new Date("2000-01-01T00:00:00.000Z")?sg:Ch;sg.parse=function(a){a=new Date(a);return isNaN(a)?null:a};sg.toString=Ch.toString;R.second=ab(function(a){return new Ia(1E3*Math.floor(a/1E3))},function(a,
b){a.setTime(a.getTime()+1E3*Math.floor(b))},function(a){return a.getSeconds()});R.seconds=R.second.range;R.seconds.utc=R.second.utc.range;R.minute=ab(function(a){return new Ia(6E4*Math.floor(a/6E4))},function(a,b){a.setTime(a.getTime()+6E4*Math.floor(b))},function(a){return a.getMinutes()});R.minutes=R.minute.range;R.minutes.utc=R.minute.utc.range;R.hour=ab(function(a){var b=a.getTimezoneOffset()/60;return new Ia(36E5*(Math.floor(a/36E5-b)+b))},function(a,b){a.setTime(a.getTime()+36E5*Math.floor(b))},
function(a){return a.getHours()});R.hours=R.hour.range;R.hours.utc=R.hour.utc.range;R.month=ab(function(a){a=R.day(a);a.setDate(1);return a},function(a,b){a.setMonth(a.getMonth()+b)},function(a){return a.getMonth()});R.months=R.month.range;R.months.utc=R.month.utc.range;var Ze=[1E3,5E3,15E3,3E4,6E4,3E5,9E5,18E5,36E5,108E5,216E5,432E5,864E5,1728E5,6048E5,2592E6,7776E6,31536E6],Bg=[[R.second,1],[R.second,5],[R.second,15],[R.second,30],[R.minute,1],[R.minute,5],[R.minute,15],[R.minute,30],[R.hour,1],
[R.hour,3],[R.hour,6],[R.hour,12],[R.day,1],[R.day,2],[R.week,1],[R.month,1],[R.month,3],[R.year,1]],qi=Ag.multi([[".%L",function(a){return a.getMilliseconds()}],[":%S",function(a){return a.getSeconds()}],["%I:%M",function(a){return a.getMinutes()}],["%I %p",function(a){return a.getHours()}],["%a %d",function(a){return a.getDay()&&1!=a.getDate()}],["%b %d",function(a){return 1!=a.getDate()}],["%B",function(a){return a.getMonth()}],["%Y",pb]]),Rh={range:function(a,b,c){return A.range(Math.ceil(a/c)*
c,+b,c).map(uc)},floor:ya,ceil:ya};Bg.year=R.year;R.scale=function(){return tg(A.scale.linear(),Bg,qi)};var Dh=Bg.map(function(a){return[a[0].utc,a[1]]}),ri=Bh.multi([[".%L",function(a){return a.getUTCMilliseconds()}],[":%S",function(a){return a.getUTCSeconds()}],["%I:%M",function(a){return a.getUTCMinutes()}],["%I %p",function(a){return a.getUTCHours()}],["%a %d",function(a){return a.getUTCDay()&&1!=a.getUTCDate()}],["%b %d",function(a){return 1!=a.getUTCDate()}],["%B",function(a){return a.getUTCMonth()}],
["%Y",pb]]);Dh.year=R.year.utc;R.scale.utc=function(){return tg(A.scale.linear(),Dh,ri)};A.text=Ab(function(a){return a.responseText});A.json=function(a,b){return Bb(a,"application/json",Sh,b)};A.html=function(a,b){return Bb(a,"text/html",Th,b)};A.xml=Ab(function(a){return a.responseXML});"function"===typeof define&&define.amd?define(A):"object"===typeof module&&module.exports?module.exports=A:this.d3=A}();
(function(h,b){"object"===typeof exports&&"object"===typeof module?module.exports=b():"function"===typeof define&&define.amd?define([],b):"object"===typeof exports?exports.Pusher=b():h.Pusher=b()})(this,function(){return function(h){function b(c){if(a[c])return a[c].exports;var f=a[c]={exports:{},id:c,loaded:!1};h[c].call(f.exports,f,f.exports,b);f.loaded=!0;return f.exports}var a={};b.m=h;b.c=a;b.p="";return b(0)}([function(h,b,a){b=a(1);h.exports=b["default"]},function(h,b,a){var c=a(2),f=a(9),
e=a(23),g=a(38),d=a(39),l=a(40),m=a(12),k=a(5),n=a(62),s=a(8),p=a(42);h=function(){function a(b,m){var h=this;if(null===b||void 0===b)throw"You must pass your app key when you instantiate Pusher.";m=m||{};this.key=b;this.config=f.extend(n.getGlobalConfig(),m.cluster?n.getClusterConfig(m.cluster):{},m);this.channels=p["default"].createChannels();this.global_emitter=new e["default"];this.sessionID=Math.floor(1E9*Math.random());this.timeline=new g["default"](this.key,this.sessionID,{cluster:this.config.cluster,
features:a.getClientFeatures(),params:this.config.timelineParams||{},limit:50,level:d["default"].INFO,version:k["default"].VERSION});this.config.disableStats||(this.timelineSender=p["default"].createTimelineSender(this.timeline,{host:this.config.statsHost,path:"/timeline/v2/"+c["default"].TimelineTransport.name}));this.connection=p["default"].createConnectionManager(this.key,f.extend({getStrategy:function(a){a=f.extend({},h.config,a);return l.build(c["default"].getDefaultStrategy(a),a)},timeline:this.timeline,
activityTimeout:this.config.activity_timeout,pongTimeout:this.config.pong_timeout,unavailableTimeout:this.config.unavailable_timeout},this.config,{encrypted:this.isEncrypted()}));this.connection.bind("connected",function(){h.subscribeAll();h.timelineSender&&h.timelineSender.send(h.connection.isEncrypted())});this.connection.bind("message",function(a){var b=0===a.event.indexOf("pusher_internal:");if(a.channel){var c=h.channel(a.channel);c&&c.handleEvent(a.event,a.data)}b||h.global_emitter.emit(a.event,
a.data)});this.connection.bind("connecting",function(){h.channels.disconnect()});this.connection.bind("disconnected",function(){h.channels.disconnect()});this.connection.bind("error",function(a){s["default"].warn("Error",a)});a.instances.push(this);this.timeline.info({instances:a.instances.length});a.isReady&&this.connect()}a.ready=function(){a.isReady=!0;for(var b=0,c=a.instances.length;b<c;b++)a.instances[b].connect()};a.log=function(b){a.logToConsole&&(window.console&&window.console.log)&&window.console.log(b)};
a.getClientFeatures=function(){return f.keys(f.filterObject({ws:c["default"].Transports.ws},function(a){return a.isSupported({})}))};a.prototype.channel=function(a){return this.channels.find(a)};a.prototype.allChannels=function(){return this.channels.all()};a.prototype.connect=function(){this.connection.connect();if(this.timelineSender&&!this.timelineSenderTimer){var a=this.connection.isEncrypted(),b=this.timelineSender;this.timelineSenderTimer=new m.PeriodicTimer(6E4,function(){b.send(a)})}};a.prototype.disconnect=
function(){this.connection.disconnect();this.timelineSenderTimer&&(this.timelineSenderTimer.ensureAborted(),this.timelineSenderTimer=null)};a.prototype.bind=function(a,b,c){this.global_emitter.bind(a,b,c);return this};a.prototype.unbind=function(a,b,c){this.global_emitter.unbind(a,b,c);return this};a.prototype.bind_global=function(a){this.global_emitter.bind_global(a);return this};a.prototype.unbind_global=function(a){this.global_emitter.unbind_global(a);return this};a.prototype.unbind_all=function(a){this.global_emitter.unbind_all();
return this};a.prototype.subscribeAll=function(){for(var a in this.channels.channels)this.channels.channels.hasOwnProperty(a)&&this.subscribe(a)};a.prototype.subscribe=function(a){a=this.channels.add(a,this);a.subscriptionPending&&a.subscriptionCancelled?a.reinstateSubscription():!a.subscriptionPending&&"connected"===this.connection.state&&a.subscribe();return a};a.prototype.unsubscribe=function(a){var b=this.channels.find(a);b&&b.subscriptionPending?b.cancelSubscription():(b=this.channels.remove(a))&&
"connected"===this.connection.state&&b.unsubscribe()};a.prototype.send_event=function(a,b,c){return this.connection.send_event(a,b,c)};a.prototype.isEncrypted=function(){return"https:"===c["default"].getProtocol()?!0:Boolean(this.config.encrypted)};a.instances=[];a.isReady=!1;a.logToConsole=!1;a.Runtime=c["default"];a.ScriptReceivers=c["default"].ScriptReceivers;a.DependenciesReceivers=c["default"].DependenciesReceivers;a.auth_callbacks=c["default"].auth_callbacks;return a}();b.__esModule=!0;b["default"]=
h;c["default"].setup(h)},function(h,b,a){var c=a(3),f=a(7),e=a(14),g=a(15),d=a(16);h=a(4);var l=a(17),m=a(18),k=a(25),n=a(26),s=a(27);a=a(28);a={nextAuthCallbackID:1,auth_callbacks:{},ScriptReceivers:h.ScriptReceivers,DependenciesReceivers:c.DependenciesReceivers,getDefaultStrategy:n["default"],Transports:m["default"],transportConnectionInitializer:s["default"],HTTPFactory:a["default"],TimelineTransport:l["default"],getXHRAPI:function(){return window.XMLHttpRequest},getWebSocketAPI:function(){return window.WebSocket||
window.MozWebSocket},setup:function(a){var b=this;window.Pusher=a;var d=function(){b.onDocumentBody(a.ready)};window.JSON?d():c.Dependencies.load("json2",{},d)},getDocument:function(){return document},getProtocol:function(){return this.getDocument().location.protocol},getAuthorizers:function(){return{ajax:f["default"],jsonp:e["default"]}},onDocumentBody:function(a){var b=this;document.body?a():setTimeout(function(){b.onDocumentBody(a)},0)},createJSONPRequest:function(a,b){return new d["default"](a,
b)},createScriptRequest:function(a){return new g["default"](a)},getLocalStorage:function(){try{return window.localStorage}catch(a){}},createXHR:function(){return this.getXHRAPI()?this.createXMLHttpRequest():this.createMicrosoftXHR()},createXMLHttpRequest:function(){return new (this.getXHRAPI())},createMicrosoftXHR:function(){return new ActiveXObject("Microsoft.XMLHTTP")},getNetwork:function(){return k.Network},createWebSocket:function(a){return new (this.getWebSocketAPI())(a)},createSocketRequest:function(a,
b){if(this.isXHRSupported())return this.HTTPFactory.createXHR(a,b);if(this.isXDRSupported(0===b.indexOf("https:")))return this.HTTPFactory.createXDR(a,b);throw"Cross-origin HTTP requests are not supported";},isXHRSupported:function(){var a=this.getXHRAPI();return Boolean(a)&&void 0!==(new a).withCredentials},isXDRSupported:function(a){a=a?"https:":"http:";var b=this.getProtocol();return Boolean(window.XDomainRequest)&&b===a},addUnloadListener:function(a){void 0!==window.addEventListener?window.addEventListener("unload",
a,!1):void 0!==window.attachEvent&&window.attachEvent("onunload",a)},removeUnloadListener:function(a){void 0!==window.addEventListener?window.removeEventListener("unload",a,!1):void 0!==window.detachEvent&&window.detachEvent("onunload",a)}};b.__esModule=!0;b["default"]=a},function(h,b,a){h=a(4);var c=a(5);a=a(6);b.DependenciesReceivers=new h.ScriptReceiverFactory("_pusher_dependencies","Pusher.DependenciesReceivers");b.Dependencies=new a["default"]({cdn_http:c["default"].cdn_http,cdn_https:c["default"].cdn_https,
version:c["default"].VERSION,suffix:c["default"].dependency_suffix,receivers:b.DependenciesReceivers})},function(h,b){var a=function(){function a(b,c){this.lastId=0;this.prefix=b;this.name=c}a.prototype.create=function(a){this.lastId++;var b=this.lastId,c=this.prefix+b,d=this.name+"["+b+"]",l=!1,m=function(){l||(a.apply(null,arguments),l=!0)};this[b]=m;return{number:b,id:c,name:d,callback:m}};a.prototype.remove=function(a){delete this[a.number]};return a}();b.ScriptReceiverFactory=a;b.ScriptReceivers=
new a("_pusher_script_","Pusher.ScriptReceivers")},function(h,b){b.__esModule=!0;b["default"]={VERSION:"4.1.0",PROTOCOL:7,host:"ws.pusherapp.com",ws_port:80,wss_port:443,sockjs_host:"sockjs.pusher.com",sockjs_http_port:80,sockjs_https_port:443,sockjs_path:"/pusher",stats_host:"stats.pusher.com",channel_auth_endpoint:"/pusher/auth",channel_auth_transport:"ajax",activity_timeout:12E4,pong_timeout:3E4,unavailable_timeout:1E4,cdn_http:"http://js.pusher.com",cdn_https:"https://js.pusher.com",dependency_suffix:""}},
function(h,b,a){var c=a(4),f=a(2);h=function(){function a(b){this.options=b;this.receivers=b.receivers||c.ScriptReceivers;this.loading={}}a.prototype.load=function(a,b,c){var e=this;if(e.loading[a]&&0<e.loading[a].length)e.loading[a].push(c);else{e.loading[a]=[c];var k=f["default"].createScriptRequest(e.getPath(a,b)),n=e.receivers.create(function(b){e.receivers.remove(n);if(e.loading[a]){var c=e.loading[a];delete e.loading[a];for(var d=function(a){a||k.cleanup()},f=0;f<c.length;f++)c[f](b,d)}});k.send(n)}};
a.prototype.getRoot=function(a){var b=f["default"].getDocument().location.protocol;return(a&&a.encrypted||"https:"===b?this.options.cdn_https:this.options.cdn_http).replace(/\/*$/,"")+"/"+this.options.version};a.prototype.getPath=function(a,b){return this.getRoot(b)+"/"+a+this.options.suffix+".js"};return a}();b.__esModule=!0;b["default"]=h},function(h,b,a){var c=a(8),f=a(2);b.__esModule=!0;b["default"]=function(a,b,d){var l;l=f["default"].createXHR();l.open("POST",this.options.authEndpoint,!0);l.setRequestHeader("Content-Type",
"application/x-www-form-urlencoded");for(var m in this.authOptions.headers)l.setRequestHeader(m,this.authOptions.headers[m]);l.onreadystatechange=function(){if(4===l.readyState)if(200===l.status){var a,b=!1;try{a=JSON.parse(l.responseText),b=!0}catch(e){d(!0,"JSON returned from webapp was invalid, yet status code was 200. Data was: "+l.responseText)}b&&d(!1,a)}else c["default"].warn("Couldn't get auth info from your webapp",l.status),d(!0,l.status)};l.send(this.composeQuery(b));return l}},function(h,
b,a){var c=a(9),f=a(1);b.__esModule=!0;b["default"]={debug:function(){for(var a=0;a<arguments.length;a++);f["default"].log&&f["default"].log(c.stringify.apply(this,arguments))},warn:function(){for(var a=0;a<arguments.length;a++);a=c.stringify.apply(this,arguments);window.console&&(window.console.warn?window.console.warn(a):window.console.log&&window.console.log(a));f["default"].log&&f["default"].log(a)}}},function(h,b,a){function c(a){for(var b=[],d=1;d<arguments.length;d++)b[d-1]=arguments[d];for(d=
0;d<b.length;d++){var e=b[d],f;for(f in e)a[f]=e[f]&&e[f].constructor&&e[f].constructor===Object?c(a[f]||{},e[f]):e[f]}return a}function f(a,b){for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&b(a[c],c,a)}function e(a,b){for(var c=[],d=0;d<a.length;d++)c.push(b(a[d],d,a,c));return c}function g(a,b){var c={};f(a,function(a,d){c[d]=b(a)});return c}function d(a,b){var c={};f(a,function(d,e){if(b&&b(d,e,a,c)||Boolean(d))c[e]=d});return c}function l(a){var b=[];f(a,function(a,c){b.push([c,a])});
return b}function m(a){return g(a,function(a){"object"===typeof a&&(a=n(a));return encodeURIComponent(s["default"](a.toString()))})}function k(a){var b=[],c=[];return function q(a,d){var e,f,g;switch(typeof a){case "object":if(!a)return null;for(e=0;e<b.length;e+=1)if(b[e]===a)return{$ref:c[e]};b.push(a);c.push(d);if("[object Array]"===Object.prototype.toString.apply(a)){g=[];for(e=0;e<a.length;e+=1)g[e]=q(a[e],d+"["+e+"]")}else for(f in g={},a)Object.prototype.hasOwnProperty.call(a,f)&&(g[f]=q(a[f],
d+"["+JSON.stringify(f)+"]"));return g;case "number":case "string":case "boolean":return a}}(a,"$")}function n(a){try{return JSON.stringify(a)}catch(b){return JSON.stringify(k(a))}}var s=a(10),p=a(11);b.extend=c;b.stringify=function(){for(var a=["Pusher"],b=0;b<arguments.length;b++)"string"===typeof arguments[b]?a.push(arguments[b]):a.push(n(arguments[b]));return a.join(" : ")};b.arrayIndexOf=function(a,b){var c=Array.prototype.indexOf;if(null===a)return-1;if(c&&a.indexOf===c)return a.indexOf(b);
for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1};b.objectApply=f;b.keys=function(a){var b=[];f(a,function(a,c){b.push(c)});return b};b.values=function(a){var b=[];f(a,function(a){b.push(a)});return b};b.apply=function(a,b,c){for(var d=0;d<a.length;d++)b.call(c||window,a[d],d,a)};b.map=e;b.mapObject=g;b.filter=function(a,b){b=b||function(a){return!!a};for(var c=[],d=0;d<a.length;d++)b(a[d],d,a,c)&&c.push(a[d]);return c};b.filterObject=d;b.flatten=l;b.any=function(a,b){for(var c=0;c<a.length;c++)if(b(a[c],
c,a))return!0;return!1};b.all=function(a,b){for(var c=0;c<a.length;c++)if(!b(a[c],c,a))return!1;return!0};b.encodeParamsObject=m;b.buildQueryString=function(a){a=d(a,function(a){return void 0!==a});return e(l(m(a)),p["default"].method("join","=")).join("&")};b.decycleObject=k;b.safeJSONStringify=n},function(h,b,a){b.__esModule=!0;b["default"]=function(a){return g(a.replace(/[^\x00-\x7F]/g,f))};var c=String.fromCharCode;for(h=0;64>h;h++)"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(h);
var f=function(a){var b=a.charCodeAt(0);return 128>b?a:2048>b?c(192|b>>>6)+c(128|b&63):c(224|b>>>12&15)+c(128|b>>>6&63)+c(128|b&63)},e=function(a){var b=[0,2,1][a.length%3];a=a.charCodeAt(0)<<16|(1<a.length?a.charCodeAt(1):0)<<8|(2<a.length?a.charCodeAt(2):0);return["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>18),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>12&63),2<=b?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>
6&63),1<=b?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a&63)].join("")},g=window.btoa||function(a){return a.replace(/[\s\S]{1,3}/g,e)}},function(h,b,a){var c=a(12);b.__esModule=!0;b["default"]={now:function(){return Date.now?Date.now():(new Date).valueOf()},defer:function(a){return new c.OneOffTimer(0,a)},method:function(a){for(var b=1;b<arguments.length;b++);var c=Array.prototype.slice.call(arguments,1);return function(b){return b[a].apply(b,c.concat(arguments))}}}},
function(h,b,a){function c(a){window.clearTimeout(a)}function f(a){window.clearInterval(a)}var e=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var e in b)b.hasOwnProperty(e)&&(a[e]=b[e]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};h=a(13);a=function(a){function b(d,e){a.call(this,setTimeout,c,d,function(a){e();return null})}e(b,a);return b}(h["default"]);b.OneOffTimer=a;h=function(a){function b(c,d){a.call(this,setInterval,f,c,function(a){d();return a})}
e(b,a);return b}(h["default"]);b.PeriodicTimer=h},function(h,b){var a=function(){function a(b,c,g,d){var l=this;this.clear=c;this.timer=b(function(){l.timer&&(l.timer=d(l.timer))},g)}a.prototype.isRunning=function(){return null!==this.timer};a.prototype.ensureAborted=function(){this.timer&&(this.clear(this.timer),this.timer=null)};return a}();b.__esModule=!0;b["default"]=a},function(h,b,a){var c=a(8);b.__esModule=!0;b["default"]=function(a,b,g){void 0!==this.authOptions.headers&&c["default"].warn("Warn",
"To send headers with the auth request, you must use AJAX, rather than JSONP.");var d=a.nextAuthCallbackID.toString();a.nextAuthCallbackID++;var l=a.getDocument(),m=l.createElement("script");a.auth_callbacks[d]=function(a){g(!1,a)};m.src=this.options.authEndpoint+"?callback="+encodeURIComponent("Pusher.auth_callbacks['"+d+"']")+"&"+this.composeQuery(b);a=l.getElementsByTagName("head")[0]||l.documentElement;a.insertBefore(m,a.firstChild)}},function(h,b){var a=function(){function a(b){this.src=b}a.prototype.send=
function(a){var b=this,c="Error loading "+b.src;b.script=document.createElement("script");b.script.id=a.id;b.script.src=b.src;b.script.type="text/javascript";b.script.charset="UTF-8";b.script.addEventListener?(b.script.onerror=function(){a.callback(c)},b.script.onload=function(){a.callback(null)}):b.script.onreadystatechange=function(){("loaded"===b.script.readyState||"complete"===b.script.readyState)&&a.callback(null)};void 0===b.script.async&&document.attachEvent&&/opera/i.test(navigator.userAgent)?
(b.errorScript=document.createElement("script"),b.errorScript.id=a.id+"_error",b.errorScript.text=a.name+"('"+c+"');",b.script.async=b.errorScript.async=!1):b.script.async=!0;var d=document.getElementsByTagName("head")[0];d.insertBefore(b.script,d.firstChild);b.errorScript&&d.insertBefore(b.errorScript,b.script.nextSibling)};a.prototype.cleanup=function(){this.script&&(this.script.onload=this.script.onerror=null,this.script.onreadystatechange=null);this.script&&this.script.parentNode&&this.script.parentNode.removeChild(this.script);
this.errorScript&&this.errorScript.parentNode&&this.errorScript.parentNode.removeChild(this.errorScript);this.errorScript=this.script=null};return a}();b.__esModule=!0;b["default"]=a},function(h,b,a){var c=a(9),f=a(2);h=function(){function a(b,c){this.url=b;this.data=c}a.prototype.send=function(a){if(!this.request){var b=c.buildQueryString(this.data);this.request=f["default"].createScriptRequest(this.url+"/"+a.number+"?"+b);this.request.send(a)}};a.prototype.cleanup=function(){this.request&&this.request.cleanup()};
return a}();b.__esModule=!0;b["default"]=h},function(h,b,a){var c=a(2),f=a(4);b.__esModule=!0;b["default"]={name:"jsonp",getAgent:function(a,b){return function(d,l){var m=c["default"].createJSONPRequest("http"+(b?"s":"")+"://"+(a.host||a.options.host)+a.options.path,d),k=c["default"].ScriptReceivers.create(function(b,c){f.ScriptReceivers.remove(k);m.cleanup();c&&c.host&&(a.host=c.host);l&&l(b,c)});m.send(k)}}}},function(h,b,a){h=a(19);var c=a(21),f=a(20),e=a(2),g=a(3);a=a(9);var f=new c["default"]({file:"sockjs",
urls:f.sockjs,handlesActivityChecks:!0,supportsPing:!1,isSupported:function(){return!0},isInitialized:function(){return void 0!==window.SockJS},getSocket:function(a,b){return new window.SockJS(a,null,{js_path:g.Dependencies.getPath("sockjs",{encrypted:b.encrypted}),ignore_null_origin:b.ignoreNullOrigin})},beforeOpen:function(a,b){a.send(JSON.stringify({path:b}))}}),d={isSupported:function(a){return e["default"].isXDRSupported(a.encrypted)}},l=new c["default"](a.extend({},h.streamingConfiguration,
d)),c=new c["default"](a.extend({},h.pollingConfiguration,d));h["default"].xdr_streaming=l;h["default"].xdr_polling=c;h["default"].sockjs=f;b.__esModule=!0;b["default"]=h["default"]},function(h,b,a){var c=a(20);h=a(21);var f=a(9),e=a(2);a=new h["default"]({urls:c.ws,handlesActivityChecks:!1,supportsPing:!1,isInitialized:function(){return Boolean(e["default"].getWebSocketAPI())},isSupported:function(){return Boolean(e["default"].getWebSocketAPI())},getSocket:function(a){return e["default"].createWebSocket(a)}});
c={urls:c.http,handlesActivityChecks:!1,supportsPing:!0,isInitialized:function(){return!0}};b.streamingConfiguration=f.extend({getSocket:function(a){return e["default"].HTTPFactory.createStreamingSocket(a)}},c);b.pollingConfiguration=f.extend({getSocket:function(a){return e["default"].HTTPFactory.createPollingSocket(a)}},c);var g={isSupported:function(){return e["default"].isXHRSupported()}},c=new h["default"](f.extend({},b.streamingConfiguration,g));h=new h["default"](f.extend({},b.pollingConfiguration,
g));h={ws:a,xhr_streaming:c,xhr_polling:h};b.__esModule=!0;b["default"]=h},function(h,b,a){function c(a,b,c){return a+(b.encrypted?"s":"")+"://"+(b.encrypted?b.hostEncrypted:b.hostUnencrypted)+c}function f(a,b){return"/app/"+a+("?protocol="+e["default"].PROTOCOL+"&client=js&version="+e["default"].VERSION+(b?"&"+b:""))}var e=a(5);b.ws={getInitial:function(a,b){return c("ws",b,f(a,"flash=false"))}};b.http={getInitial:function(a,b){var e=(b.httpPath||"/pusher")+f(a);return c("http",b,e)}};b.sockjs={getInitial:function(a,
b){return c("http",b,b.httpPath||"/pusher")},getPath:function(a,b){return f(a)}}},function(h,b,a){var c=a(22);h=function(){function a(b){this.hooks=b}a.prototype.isSupported=function(a){return this.hooks.isSupported(a)};a.prototype.createConnection=function(a,b,d,f){return new c["default"](this.hooks,a,b,d,f)};return a}();b.__esModule=!0;b["default"]=h},function(h,b,a){var c=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=
null===b?Object.create(b):(c.prototype=b.prototype,new c)},f=a(11),e=a(9);h=a(23);var g=a(8),d=a(2);a=function(a){function b(c,e,f,g,m){a.call(this);this.initialize=d["default"].transportConnectionInitializer;this.hooks=c;this.name=e;this.priority=f;this.key=g;this.options=m;this.state="new";this.timeline=m.timeline;this.activityTimeout=m.activityTimeout;this.id=this.timeline.generateUniqueID()}c(b,a);b.prototype.handlesActivityChecks=function(){return Boolean(this.hooks.handlesActivityChecks)};b.prototype.supportsPing=
function(){return Boolean(this.hooks.supportsPing)};b.prototype.connect=function(){var a=this;if(this.socket||"initialized"!==this.state)return!1;var b=this.hooks.urls.getInitial(this.key,this.options);try{this.socket=this.hooks.getSocket(b,this.options)}catch(c){return f["default"].defer(function(){a.onError(c);a.changeState("closed")}),!1}this.bindListeners();g["default"].debug("Connecting",{transport:this.name,url:b});this.changeState("connecting");return!0};b.prototype.close=function(){return this.socket?
(this.socket.close(),!0):!1};b.prototype.send=function(a){var b=this;return"open"===this.state?(f["default"].defer(function(){b.socket&&b.socket.send(a)}),!0):!1};b.prototype.ping=function(){"open"===this.state&&this.supportsPing()&&this.socket.ping()};b.prototype.onOpen=function(){this.hooks.beforeOpen&&this.hooks.beforeOpen(this.socket,this.hooks.urls.getPath(this.key,this.options));this.changeState("open");this.socket.onopen=void 0};b.prototype.onError=function(a){this.emit("error",{type:"WebSocketError",
error:a});this.timeline.error(this.buildTimelineMessage({error:a.toString()}))};b.prototype.onClose=function(a){a?this.changeState("closed",{code:a.code,reason:a.reason,wasClean:a.wasClean}):this.changeState("closed");this.unbindListeners();this.socket=void 0};b.prototype.onMessage=function(a){this.emit("message",a)};b.prototype.onActivity=function(){this.emit("activity")};b.prototype.bindListeners=function(){var a=this;this.socket.onopen=function(){a.onOpen()};this.socket.onerror=function(b){a.onError(b)};
this.socket.onclose=function(b){a.onClose(b)};this.socket.onmessage=function(b){a.onMessage(b)};this.supportsPing()&&(this.socket.onactivity=function(){a.onActivity()})};b.prototype.unbindListeners=function(){this.socket&&(this.socket.onopen=void 0,this.socket.onerror=void 0,this.socket.onclose=void 0,this.socket.onmessage=void 0,this.supportsPing()&&(this.socket.onactivity=void 0))};b.prototype.changeState=function(a,b){this.state=a;this.timeline.info(this.buildTimelineMessage({state:a,params:b}));
this.emit(a,b)};b.prototype.buildTimelineMessage=function(a){return e.extend({cid:this.id},a)};return b}(h["default"]);b.__esModule=!0;b["default"]=a},function(h,b,a){var c=a(9),f=a(24);h=function(){function a(b){this.callbacks=new f["default"];this.global_callbacks=[];this.failThrough=b}a.prototype.bind=function(a,b,c){this.callbacks.add(a,b,c);return this};a.prototype.bind_global=function(a){this.global_callbacks.push(a);return this};a.prototype.unbind=function(a,b,c){this.callbacks.remove(a,b,
c);return this};a.prototype.unbind_global=function(a){if(!a)return this.global_callbacks=[],this;this.global_callbacks=c.filter(this.global_callbacks||[],function(b){return b!==a});return this};a.prototype.unbind_all=function(){this.unbind();this.unbind_global();return this};a.prototype.emit=function(a,b){var c;for(c=0;c<this.global_callbacks.length;c++)this.global_callbacks[c](a,b);var e=this.callbacks.get(a);if(e&&0<e.length)for(c=0;c<e.length;c++)e[c].fn.call(e[c].context||window,b);else this.failThrough&&
this.failThrough(a,b);return this};return a}();b.__esModule=!0;b["default"]=h},function(h,b,a){var c=a(9);h=function(){function a(){this._callbacks={}}a.prototype.get=function(a){return this._callbacks["_"+a]};a.prototype.add=function(a,b,c){a="_"+a;this._callbacks[a]=this._callbacks[a]||[];this._callbacks[a].push({fn:b,context:c})};a.prototype.remove=function(a,b,d){!a&&!b&&!d?this._callbacks={}:(a=a?["_"+a]:c.keys(this._callbacks),b||d?this.removeCallback(a,b,d):this.removeAllCallbacks(a))};a.prototype.removeCallback=
function(a,b,d){c.apply(a,function(a){this._callbacks[a]=c.filter(this._callbacks[a]||[],function(a){return b&&b!==a.fn||d&&d!==a.context});0===this._callbacks[a].length&&delete this._callbacks[a]},this)};a.prototype.removeAllCallbacks=function(a){c.apply(a,function(a){delete this._callbacks[a]},this)};return a}();b.__esModule=!0;b["default"]=h},function(h,b,a){var c=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===
b?Object.create(b):(c.prototype=b.prototype,new c)};h=function(a){function b(){a.call(this);var c=this;void 0!==window.addEventListener&&(window.addEventListener("online",function(){c.emit("online")},!1),window.addEventListener("offline",function(){c.emit("offline")},!1))}c(b,a);b.prototype.isOnline=function(){return void 0===window.navigator.onLine?!0:window.navigator.onLine};return b}(a(23)["default"]);b.NetInfo=h;b.Network=new h},function(h,b){b.__esModule=!0;b["default"]=function(a){return[[":def",
"ws_options",{hostUnencrypted:a.wsHost+":"+a.wsPort,hostEncrypted:a.wsHost+":"+a.wssPort}],[":def","wss_options",[":extend",":ws_options",{encrypted:!0}]],[":def","sockjs_options",{hostUnencrypted:a.httpHost+":"+a.httpPort,hostEncrypted:a.httpHost+":"+a.httpsPort,httpPath:a.httpPath}],[":def","timeouts",{loop:!0,timeout:15E3,timeoutLimit:6E4}],[":def","ws_manager",[":transport_manager",{lives:2,minPingDelay:1E4,maxPingDelay:a.activity_timeout}]],[":def","streaming_manager",[":transport_manager",{lives:2,
minPingDelay:1E4,maxPingDelay:a.activity_timeout}]],[":def_transport","ws","ws",3,":ws_options",":ws_manager"],[":def_transport","wss","ws",3,":wss_options",":ws_manager"],[":def_transport","sockjs","sockjs",1,":sockjs_options"],[":def_transport","xhr_streaming","xhr_streaming",1,":sockjs_options",":streaming_manager"],[":def_transport","xdr_streaming","xdr_streaming",1,":sockjs_options",":streaming_manager"],[":def_transport","xhr_polling","xhr_polling",1,":sockjs_options"],[":def_transport","xdr_polling",
"xdr_polling",1,":sockjs_options"],[":def","ws_loop",[":sequential",":timeouts",":ws"]],[":def","wss_loop",[":sequential",":timeouts",":wss"]],[":def","sockjs_loop",[":sequential",":timeouts",":sockjs"]],[":def","streaming_loop",[":sequential",":timeouts",[":if",[":is_supported",":xhr_streaming"],":xhr_streaming",":xdr_streaming"]]],[":def","polling_loop",[":sequential",":timeouts",[":if",[":is_supported",":xhr_polling"],":xhr_polling",":xdr_polling"]]],[":def","http_loop",[":if",[":is_supported",
":streaming_loop"],[":best_connected_ever",":streaming_loop",[":delayed",4E3,[":polling_loop"]]],[":polling_loop"]]],[":def","http_fallback_loop",[":if",[":is_supported",":http_loop"],[":http_loop"],[":sockjs_loop"]]],[":def","strategy",[":cached",18E5,[":first_connected",[":if",[":is_supported",":ws"],a.encrypted?[":best_connected_ever",":ws_loop",[":delayed",2E3,[":http_fallback_loop"]]]:[":best_connected_ever",":ws_loop",[":delayed",2E3,[":wss_loop"]],[":delayed",5E3,[":http_fallback_loop"]]],
":http_fallback_loop"]]]]]}},function(h,b,a){var c=a(3);b.__esModule=!0;b["default"]=function(){var a=this;a.timeline.info(a.buildTimelineMessage({transport:a.name+(a.options.encrypted?"s":"")}));if(a.hooks.isInitialized())a.changeState("initialized");else if(a.hooks.file)a.changeState("initializing"),c.Dependencies.load(a.hooks.file,{encrypted:a.options.encrypted},function(b,c){if(a.hooks.isInitialized())a.changeState("initialized"),c(!0);else{if(b)a.onError(b);a.onClose();c(!1)}});else a.onClose()}},
function(h,b,a){var c=a(29);h=a(31);h["default"].createXDR=function(a,b){return this.createRequest(c["default"],a,b)};b.__esModule=!0;b["default"]=h["default"]},function(h,b,a){var c=a(30);b.__esModule=!0;b["default"]={getRequest:function(a){var b=new window.XDomainRequest;b.ontimeout=function(){a.emit("error",new c.RequestTimedOut);a.close()};b.onerror=function(b){a.emit("error",b);a.close()};b.onprogress=function(){if(b.responseText&&0<b.responseText.length)a.onChunk(200,b.responseText)};b.onload=
function(){if(b.responseText&&0<b.responseText.length)a.onChunk(200,b.responseText);a.emit("finished",200);a.close()};return b},abortRequest:function(a){a.ontimeout=a.onerror=a.onprogress=a.onload=null;a.abort()}}},function(h,b){var a=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},c=function(b){function c(){b.apply(this,arguments)}a(c,b);return c}(Error);b.BadEventName=
c;c=function(b){function c(){b.apply(this,arguments)}a(c,b);return c}(Error);b.RequestTimedOut=c;c=function(b){function c(){b.apply(this,arguments)}a(c,b);return c}(Error);b.TransportPriorityTooLow=c;c=function(b){function c(){b.apply(this,arguments)}a(c,b);return c}(Error);b.TransportClosed=c;c=function(b){function c(){b.apply(this,arguments)}a(c,b);return c}(Error);b.UnsupportedTransport=c;c=function(b){function c(){b.apply(this,arguments)}a(c,b);return c}(Error);b.UnsupportedStrategy=c},function(h,
b,a){var c=a(32),f=a(33),e=a(35),g=a(36),d=a(37);b.__esModule=!0;b["default"]={createStreamingSocket:function(a){return this.createSocket(e["default"],a)},createPollingSocket:function(a){return this.createSocket(g["default"],a)},createSocket:function(a,b){return new f["default"](a,b)},createXHR:function(a,b){return this.createRequest(d["default"],a,b)},createRequest:function(a,b,d){return new c["default"](a,b,d)}}},function(h,b,a){var c=this&&this.__extends||function(a,b){function c(){this.constructor=
a}for(var f in b)b.hasOwnProperty(f)&&(a[f]=b[f]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},f=a(2);h=function(a){function b(c,f,g){a.call(this);this.hooks=c;this.method=f;this.url=g}c(b,a);b.prototype.start=function(a){var b=this;this.position=0;this.xhr=this.hooks.getRequest(this);this.unloader=function(){b.close()};f["default"].addUnloadListener(this.unloader);this.xhr.open(this.method,this.url,!0);this.xhr.setRequestHeader&&this.xhr.setRequestHeader("Content-Type",
"application/json");this.xhr.send(a)};b.prototype.close=function(){this.unloader&&(f["default"].removeUnloadListener(this.unloader),this.unloader=null);this.xhr&&(this.hooks.abortRequest(this.xhr),this.xhr=null)};b.prototype.onChunk=function(a,b){for(;;){var c=this.advanceBuffer(b);if(c)this.emit("chunk",{status:a,data:c});else break}this.isBufferTooLong(b)&&this.emit("buffer_too_long")};b.prototype.advanceBuffer=function(a){a=a.slice(this.position);var b=a.indexOf("\n");return-1!==b?(this.position+=
b+1,a.slice(0,b)):null};b.prototype.isBufferTooLong=function(a){return this.position===a.length&&262144<a.length};return b}(a(23)["default"]);b.__esModule=!0;b["default"]=h},function(h,b,a){function c(a){var b=-1===a.indexOf("?")?"?":"&";return a+b+"t="+ +new Date+"&n="+d++}var f=a(34),e=a(11),g=a(2),d=1;h=function(){function a(b,c){this.hooks=b;var d=Math.floor(1E3*Math.random())+"/",e;e=[];for(var g=0;8>g;g++)e.push(Math.floor(32*Math.random()).toString(32));e=e.join("");this.session=d+e;d=/([^\?]*)\/*(\??.*)/.exec(c);
this.location={base:d[1],queryString:d[2]};this.readyState=f["default"].CONNECTING;this.openStream()}a.prototype.send=function(a){return this.sendRaw(JSON.stringify([a]))};a.prototype.ping=function(){this.hooks.sendHeartbeat(this)};a.prototype.close=function(a,b){this.onClose(a,b,!0)};a.prototype.sendRaw=function(a){if(this.readyState===f["default"].OPEN)try{return g["default"].createSocketRequest("POST",c(this.location.base+"/"+this.session+"/xhr_send")).start(a),!0}catch(b){return!1}else return!1};
a.prototype.reconnect=function(){this.closeStream();this.openStream()};a.prototype.onClose=function(a,b,c){this.closeStream();this.readyState=f["default"].CLOSED;if(this.onclose)this.onclose({code:a,reason:b,wasClean:c})};a.prototype.onChunk=function(a){if(200===a.status){if(this.readyState===f["default"].OPEN)this.onActivity();switch(a.data.slice(0,1)){case "o":a=JSON.parse(a.data.slice(1)||"{}");this.onOpen(a);break;case "a":a=JSON.parse(a.data.slice(1)||"[]");for(var b=0;b<a.length;b++)this.onEvent(a[b]);
break;case "m":a=JSON.parse(a.data.slice(1)||"null");this.onEvent(a);break;case "h":this.hooks.onHeartbeat(this);break;case "c":a=JSON.parse(a.data.slice(1)||"[]"),this.onClose(a[0],a[1],!0)}}};a.prototype.onOpen=function(a){if(this.readyState===f["default"].CONNECTING){if(a&&a.hostname){var b=this.location;a=a.hostname;var c=/(https?:\/\/)([^\/:]+)((\/|:)?.*)/.exec(this.location.base);b.base=c[1]+a+c[3]}this.readyState=f["default"].OPEN;if(this.onopen)this.onopen()}else this.onClose(1006,"Server lost session",
!0)};a.prototype.onEvent=function(a){if(this.readyState===f["default"].OPEN&&this.onmessage)this.onmessage({data:a})};a.prototype.onActivity=function(){if(this.onactivity)this.onactivity()};a.prototype.onError=function(a){if(this.onerror)this.onerror(a)};a.prototype.openStream=function(){var a=this;this.stream=g["default"].createSocketRequest("POST",c(this.hooks.getReceiveURL(this.location,this.session)));this.stream.bind("chunk",function(b){a.onChunk(b)});this.stream.bind("finished",function(b){a.hooks.onFinished(a,
b)});this.stream.bind("buffer_too_long",function(){a.reconnect()});try{this.stream.start()}catch(b){e["default"].defer(function(){a.onError(b);a.onClose(1006,"Could not start streaming",!1)})}};a.prototype.closeStream=function(){this.stream&&(this.stream.unbind_all(),this.stream.close(),this.stream=null)};return a}();b.__esModule=!0;b["default"]=h},function(h,b){var a,c=a||(a={});c[c.CONNECTING=0]="CONNECTING";c[c.OPEN=1]="OPEN";c[c.CLOSED=3]="CLOSED";b.__esModule=!0;b["default"]=a},function(h,b){b.__esModule=
!0;b["default"]={getReceiveURL:function(a,b){return a.base+"/"+b+"/xhr_streaming"+a.queryString},onHeartbeat:function(a){a.sendRaw("[]")},sendHeartbeat:function(a){a.sendRaw("[]")},onFinished:function(a,b){a.onClose(1006,"Connection interrupted ("+b+")",!1)}}},function(h,b){b.__esModule=!0;b["default"]={getReceiveURL:function(a,b){return a.base+"/"+b+"/xhr"+a.queryString},onHeartbeat:function(){},sendHeartbeat:function(a){a.sendRaw("[]")},onFinished:function(a,b){if(200===b)a.reconnect();else a.onClose(1006,
"Connection interrupted ("+b+")",!1)}}},function(h,b,a){var c=a(2);b.__esModule=!0;b["default"]={getRequest:function(a){var b=new (c["default"].getXHRAPI());b.onreadystatechange=b.onprogress=function(){switch(b.readyState){case 3:if(b.responseText&&0<b.responseText.length)a.onChunk(b.status,b.responseText);break;case 4:if(b.responseText&&0<b.responseText.length)a.onChunk(b.status,b.responseText);a.emit("finished",b.status);a.close()}};return b},abortRequest:function(a){a.onreadystatechange=null;a.abort()}}},
function(h,b,a){var c=a(9),f=a(11),e=a(39);h=function(){function a(b,c,e){this.key=b;this.session=c;this.events=[];this.options=e||{};this.uniqueID=this.sent=0}a.prototype.log=function(a,b){a<=this.options.level&&(this.events.push(c.extend({},b,{timestamp:f["default"].now()})),this.options.limit&&this.events.length>this.options.limit&&this.events.shift())};a.prototype.error=function(a){this.log(e["default"].ERROR,a)};a.prototype.info=function(a){this.log(e["default"].INFO,a)};a.prototype.debug=function(a){this.log(e["default"].DEBUG,
a)};a.prototype.isEmpty=function(){return 0===this.events.length};a.prototype.send=function(a,b){var e=this,f=c.extend({session:this.session,bundle:this.sent+1,key:this.key,lib:"js",version:this.options.version,cluster:this.options.cluster,features:this.options.features,timeline:this.events},this.options.params);this.events=[];a(f,function(a,c){a||e.sent++;b&&b(a,c)});return!0};a.prototype.generateUniqueID=function(){this.uniqueID++;return this.uniqueID};return a}();b.__esModule=!0;b["default"]=h},
function(h,b){var a,c=a||(a={});c[c.ERROR=3]="ERROR";c[c.INFO=6]="INFO";c[c.DEBUG=7]="DEBUG";b.__esModule=!0;b["default"]=a},function(h,b,a){function c(a){return function(b){return[a.apply(this,arguments),b]}}function f(a,b){if(0===a.length)return[[],b];var c=g(a[0],b),d=f(a.slice(1),c[1]);return[[c[0]].concat(d[0]),d[1]]}function e(a,b){if("string"===typeof a[0]&&":"===a[0].charAt(0)){var c=b[a[0].slice(1)];if(1<a.length){if("function"!==typeof c)throw"Calling non-function "+a[0];var e=[d.extend({},
b)].concat(d.map(a.slice(1),function(a){return g(a,d.extend({},b))[0]}));return c.apply(this,e)}return[c,b]}return f(a,b)}function g(a,b){if("string"===typeof a){var c;if("string"===typeof a&&":"===a.charAt(0)){c=b[a.slice(1)];if(void 0===c)throw"Undefined symbol "+a;c=[c,b]}else c=[a,b];return c}return"object"===typeof a&&a instanceof Array&&0<a.length?e(a,b):[a,b]}var d=a(9),l=a(11),m=a(41),k=a(30),n=a(55),s=a(56),p=a(57),r=a(58),t=a(59),v=a(60),y=a(61),q=a(2)["default"].Transports;b.build=function(a,
b){var c=d.extend({},u,b);return g(a,c)[1].strategy};var B={isSupported:function(){return!1},connect:function(a,b){var c=l["default"].defer(function(){b(new k.UnsupportedStrategy)});return{abort:function(){c.ensureAborted()},forceMinPriority:function(){}}}},u={extend:function(a,b,c){return[d.extend({},b,c),a]},def:function(a,b,c){if(void 0!==a[b])throw"Redefining symbol "+b;a[b]=c;return[void 0,a]},def_transport:function(a,b,c,e,f,g){var l=q[c];if(!l)throw new k.UnsupportedTransport(c);c=(!a.enabledTransports||
-1!==d.arrayIndexOf(a.enabledTransports,b))&&(!a.disabledTransports||-1===d.arrayIndexOf(a.disabledTransports,b))?new n["default"](b,e,g?g.getAssistant(l):l,d.extend({key:a.key,encrypted:a.encrypted,timeline:a.timeline,ignoreNullOrigin:a.ignoreNullOrigin},f)):B;e=a.def(a,b,c)[1];e.Transports=a.Transports||{};e.Transports[b]=c;return[void 0,e]},transport_manager:c(function(a,b){return new m["default"](b)}),sequential:c(function(a,b){var c=Array.prototype.slice.call(arguments,2);return new s["default"](c,
b)}),cached:c(function(a,b,c){return new r["default"](c,a.Transports,{ttl:b,timeline:a.timeline,encrypted:a.encrypted})}),first_connected:c(function(a,b){return new y["default"](b)}),best_connected_ever:c(function(){var a=Array.prototype.slice.call(arguments,1);return new p["default"](a)}),delayed:c(function(a,b,c){return new t["default"](c,{delay:b})}),"if":c(function(a,b,c,d){return new v["default"](b,c,d)}),is_supported:c(function(a,b){return function(){return b.isSupported()}})}},function(h,b,
a){var c=a(42);h=function(){function a(b){this.options=b||{};this.livesLeft=this.options.lives||Infinity}a.prototype.getAssistant=function(a){return c["default"].createAssistantToTheTransportManager(this,a,{minPingDelay:this.options.minPingDelay,maxPingDelay:this.options.maxPingDelay})};a.prototype.isAlive=function(){return 0<this.livesLeft};a.prototype.reportDeath=function(){this.livesLeft-=1};return a}();b.__esModule=!0;b["default"]=h},function(h,b,a){var c=a(43),f=a(44),e=a(47),g=a(48),d=a(49),
l=a(50),m=a(51),k=a(53),n=a(54);b.__esModule=!0;b["default"]={createChannels:function(){return new n["default"]},createConnectionManager:function(a,b){return new k["default"](a,b)},createChannel:function(a,b){return new m["default"](a,b)},createPrivateChannel:function(a,b){return new l["default"](a,b)},createPresenceChannel:function(a,b){return new d["default"](a,b)},createTimelineSender:function(a,b){return new g["default"](a,b)},createAuthorizer:function(a,b){return b.authorizer?b.authorizer(a,
b):new e["default"](a,b)},createHandshake:function(a,b){return new f["default"](a,b)},createAssistantToTheTransportManager:function(a,b,d){return new c["default"](a,b,d)}}},function(h,b,a){var c=a(11),f=a(9);h=function(){function a(b,c,e){this.manager=b;this.transport=c;this.minPingDelay=e.minPingDelay;this.maxPingDelay=e.maxPingDelay;this.pingDelay=void 0}a.prototype.createConnection=function(a,b,e,m){var k=this;m=f.extend({},m,{activityTimeout:this.pingDelay});var n=this.transport.createConnection(a,
b,e,m),h=null,p=function(){n.unbind("open",p);n.bind("closed",r);h=c["default"].now()},r=function(a){n.unbind("closed",r);1002===a.code||1003===a.code?k.manager.reportDeath():!a.wasClean&&h&&(a=c["default"].now()-h,a<2*k.maxPingDelay&&(k.manager.reportDeath(),k.pingDelay=Math.max(a/2,k.minPingDelay)))};n.bind("open",p);return n};a.prototype.isSupported=function(a){return this.manager.isAlive()&&this.transport.isSupported(a)};return a}();b.__esModule=!0;b["default"]=h},function(h,b,a){var c=a(9),f=
a(45),e=a(46);h=function(){function a(b,c){this.transport=b;this.callback=c;this.bindListeners()}a.prototype.close=function(){this.unbindListeners();this.transport.close()};a.prototype.bindListeners=function(){var a=this;this.onMessage=function(b){a.unbindListeners();var c;try{c=f.processHandshake(b)}catch(g){a.finish("error",{error:g});a.transport.close();return}"connected"===c.action?a.finish("connected",{connection:new e["default"](c.id,a.transport),activityTimeout:c.activityTimeout}):(a.finish(c.action,
{error:c.error}),a.transport.close())};this.onClosed=function(b){a.unbindListeners();var c=f.getCloseAction(b)||"backoff";b=f.getCloseError(b);a.finish(c,{error:b})};this.transport.bind("message",this.onMessage);this.transport.bind("closed",this.onClosed)};a.prototype.unbindListeners=function(){this.transport.unbind("message",this.onMessage);this.transport.unbind("closed",this.onClosed)};a.prototype.finish=function(a,b){this.callback(c.extend({transport:this.transport,action:a},b))};return a}();b.__esModule=
!0;b["default"]=h},function(h,b){b.decodeMessage=function(a){try{var b=JSON.parse(a.data);if("string"===typeof b.data)try{b.data=JSON.parse(b.data)}catch(f){if(!(f instanceof SyntaxError))throw f;}return b}catch(e){throw{type:"MessageParseError",error:e,data:a.data};}};b.encodeMessage=function(a){return JSON.stringify(a)};b.processHandshake=function(a){a=b.decodeMessage(a);if("pusher:connection_established"===a.event){if(!a.data.activity_timeout)throw"No activity timeout specified in handshake";return{action:"connected",
id:a.data.socket_id,activityTimeout:1E3*a.data.activity_timeout}}if("pusher:error"===a.event)return{action:this.getCloseAction(a.data),error:this.getCloseError(a.data)};throw"Invalid handshake";};b.getCloseAction=function(a){return 4E3>a.code?1002<=a.code&&1004>=a.code?"backoff":null:4E3===a.code?"ssl_only":4100>a.code?"refused":4200>a.code?"backoff":4300>a.code?"retry":"refused"};b.getCloseError=function(a){return 1E3!==a.code&&1001!==a.code?{type:"PusherError",data:{code:a.code,message:a.reason||
a.message}}:null}},function(h,b,a){var c=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var e in b)b.hasOwnProperty(e)&&(a[e]=b[e]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},f=a(9);h=a(23);var e=a(45),g=a(8);a=function(a){function b(c,e){a.call(this);this.id=c;this.transport=e;this.activityTimeout=e.activityTimeout;this.bindListeners()}c(b,a);b.prototype.handlesActivityChecks=function(){return this.transport.handlesActivityChecks()};b.prototype.send=
function(a){return this.transport.send(a)};b.prototype.send_event=function(a,b,c){a={event:a,data:b};c&&(a.channel=c);g["default"].debug("Event sent",a);return this.send(e.encodeMessage(a))};b.prototype.ping=function(){this.transport.supportsPing()?this.transport.ping():this.send_event("pusher:ping",{})};b.prototype.close=function(){this.transport.close()};b.prototype.bindListeners=function(){var a=this,b={message:function(b){var c;try{c=e.decodeMessage(b)}catch(d){a.emit("error",{type:"MessageParseError",
error:d,data:b.data})}if(void 0!==c){g["default"].debug("Event recd",c);switch(c.event){case "pusher:error":a.emit("error",{type:"PusherError",data:c.data});break;case "pusher:ping":a.emit("ping");break;case "pusher:pong":a.emit("pong")}a.emit("message",c)}},activity:function(){a.emit("activity")},error:function(b){a.emit("error",{type:"WebSocketError",error:b})},closed:function(b){c();b&&b.code&&a.handleCloseEvent(b);a.transport=null;a.emit("closed")}},c=function(){f.objectApply(b,function(b,c){a.transport.unbind(c,
b)})};f.objectApply(b,function(b,c){a.transport.bind(c,b)})};b.prototype.handleCloseEvent=function(a){var b=e.getCloseAction(a);(a=e.getCloseError(a))&&this.emit("error",a);b&&this.emit(b)};return b}(h["default"]);b.__esModule=!0;b["default"]=a},function(h,b,a){var c=a(2);h=function(){function a(b,f){this.channel=b;var d=f.authTransport;if("undefined"===typeof c["default"].getAuthorizers()[d])throw"'"+d+"' is not a recognized auth transport";this.type=d;this.options=f;this.authOptions=(f||{}).auth||
{}}a.prototype.composeQuery=function(a){a="socket_id="+encodeURIComponent(a)+"&channel_name="+encodeURIComponent(this.channel.name);for(var b in this.authOptions.params)a+="&"+encodeURIComponent(b)+"="+encodeURIComponent(this.authOptions.params[b]);return a};a.prototype.authorize=function(b,g){a.authorizers=a.authorizers||c["default"].getAuthorizers();return a.authorizers[this.type].call(this,c["default"],b,g)};return a}();b.__esModule=!0;b["default"]=h},function(h,b,a){var c=a(2);h=function(){function a(b,
c){this.timeline=b;this.options=c||{}}a.prototype.send=function(a,b){this.timeline.isEmpty()||this.timeline.send(c["default"].TimelineTransport.getAgent(this,a),b)};return a}();b.__esModule=!0;b["default"]=h},function(h,b,a){var c=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var e in b)b.hasOwnProperty(e)&&(a[e]=b[e]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},f=a(50),e=a(8),g=a(52);h=function(a){function b(c,e){a.call(this,c,e);this.members=
new g["default"]}c(b,a);b.prototype.authorize=function(b,c){var f=this;a.prototype.authorize.call(this,b,function(a,b){if(!a){if(void 0===b.channel_data){e["default"].warn("Invalid auth response for channel '"+f.name+"', expected 'channel_data' field");c("Invalid auth response");return}var d=JSON.parse(b.channel_data);f.members.setMyID(d.user_id)}c(a,b)})};b.prototype.handleEvent=function(a,b){switch(a){case "pusher_internal:subscription_succeeded":this.subscriptionPending=!1;this.subscribed=!0;this.subscriptionCancelled?
this.pusher.unsubscribe(this.name):(this.members.onSubscription(b),this.emit("pusher:subscription_succeeded",this.members));break;case "pusher_internal:member_added":var c=this.members.addMember(b);this.emit("pusher:member_added",c);break;case "pusher_internal:member_removed":(c=this.members.removeMember(b))&&this.emit("pusher:member_removed",c);break;default:f["default"].prototype.handleEvent.call(this,a,b)}};b.prototype.disconnect=function(){this.members.reset();a.prototype.disconnect.call(this)};
return b}(f["default"]);b.__esModule=!0;b["default"]=h},function(h,b,a){var c=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var f in b)b.hasOwnProperty(f)&&(a[f]=b[f]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},f=a(42);h=function(a){function b(){a.apply(this,arguments)}c(b,a);b.prototype.authorize=function(a,b){return f["default"].createAuthorizer(this,this.pusher.config).authorize(a,b)};return b}(a(51)["default"]);b.__esModule=!0;b["default"]=
h},function(h,b,a){var c=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var e in b)b.hasOwnProperty(e)&&(a[e]=b[e]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};h=a(23);var f=a(30),e=a(8);a=function(a){function b(c,d){a.call(this,function(a,b){e["default"].debug("No callbacks on "+c+" for "+a)});this.name=c;this.pusher=d;this.subscriptionCancelled=this.subscriptionPending=this.subscribed=!1}c(b,a);b.prototype.authorize=function(a,b){return b(!1,{})};
b.prototype.trigger=function(a,b){if(0!==a.indexOf("client-"))throw new f.BadEventName("Event '"+a+"' does not start with 'client-'");return this.pusher.send_event(a,b,this.name)};b.prototype.disconnect=function(){this.subscribed=!1};b.prototype.handleEvent=function(a,b){0===a.indexOf("pusher_internal:")?"pusher_internal:subscription_succeeded"===a&&(this.subscriptionPending=!1,this.subscribed=!0,this.subscriptionCancelled?this.pusher.unsubscribe(this.name):this.emit("pusher:subscription_succeeded",
b)):this.emit(a,b)};b.prototype.subscribe=function(){var a=this;this.subscribed||(this.subscriptionPending=!0,this.subscriptionCancelled=!1,this.authorize(this.pusher.connection.socket_id,function(b,c){b?a.handleEvent("pusher:subscription_error",c):a.pusher.send_event("pusher:subscribe",{auth:c.auth,channel_data:c.channel_data,channel:a.name})}))};b.prototype.unsubscribe=function(){this.subscribed=!1;this.pusher.send_event("pusher:unsubscribe",{channel:this.name})};b.prototype.cancelSubscription=
function(){this.subscriptionCancelled=!0};b.prototype.reinstateSubscription=function(){this.subscriptionCancelled=!1};return b}(h["default"]);b.__esModule=!0;b["default"]=a},function(h,b,a){var c=a(9);h=function(){function a(){this.reset()}a.prototype.get=function(a){return Object.prototype.hasOwnProperty.call(this.members,a)?{id:a,info:this.members[a]}:null};a.prototype.each=function(a){var b=this;c.objectApply(this.members,function(c,f){a(b.get(f))})};a.prototype.setMyID=function(a){this.myID=a};
a.prototype.onSubscription=function(a){this.members=a.presence.hash;this.count=a.presence.count;this.me=this.get(this.myID)};a.prototype.addMember=function(a){null===this.get(a.user_id)&&this.count++;this.members[a.user_id]=a.user_info;return this.get(a.user_id)};a.prototype.removeMember=function(a){var b=this.get(a.user_id);b&&(delete this.members[a.user_id],this.count--);return b};a.prototype.reset=function(){this.members={};this.count=0;this.me=this.myID=null};return a}();b.__esModule=!0;b["default"]=
h},function(h,b,a){var c=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};h=a(23);var f=a(12),e=a(8),g=a(9),d=a(2);a=function(a){function b(c,e){var f=this;a.call(this);this.key=c;this.options=e||{};this.state="initialized";this.connection=null;this.encrypted=!!e.encrypted;this.timeline=this.options.timeline;this.connectionCallbacks=this.buildConnectionCallbacks();
this.errorCallbacks=this.buildErrorCallbacks();this.handshakeCallbacks=this.buildHandshakeCallbacks(this.errorCallbacks);var g=d["default"].getNetwork();g.bind("online",function(){f.timeline.info({netinfo:"online"});("connecting"===f.state||"unavailable"===f.state)&&f.retryIn(0)});g.bind("offline",function(){f.timeline.info({netinfo:"offline"});f.connection&&f.sendActivityCheck()});this.updateStrategy()}c(b,a);b.prototype.connect=function(){!this.connection&&!this.runner&&(this.strategy.isSupported()?
(this.updateState("connecting"),this.startConnecting(),this.setUnavailableTimer()):this.updateState("failed"))};b.prototype.send=function(a){return this.connection?this.connection.send(a):!1};b.prototype.send_event=function(a,b,c){return this.connection?this.connection.send_event(a,b,c):!1};b.prototype.disconnect=function(){this.disconnectInternally();this.updateState("disconnected")};b.prototype.isEncrypted=function(){return this.encrypted};b.prototype.startConnecting=function(){var a=this,b=function(c,
d){c?a.runner=a.strategy.connect(0,b):"error"===d.action?(a.emit("error",{type:"HandshakeError",error:d.error}),a.timeline.error({handshakeError:d.error})):(a.abortConnecting(),a.handshakeCallbacks[d.action](d))};this.runner=this.strategy.connect(0,b)};b.prototype.abortConnecting=function(){this.runner&&(this.runner.abort(),this.runner=null)};b.prototype.disconnectInternally=function(){this.abortConnecting();this.clearRetryTimer();this.clearUnavailableTimer();this.connection&&this.abandonConnection().close()};
b.prototype.updateStrategy=function(){this.strategy=this.options.getStrategy({key:this.key,timeline:this.timeline,encrypted:this.encrypted})};b.prototype.retryIn=function(a){var b=this;this.timeline.info({action:"retry",delay:a});0<a&&this.emit("connecting_in",Math.round(a/1E3));this.retryTimer=new f.OneOffTimer(a||0,function(){b.disconnectInternally();b.connect()})};b.prototype.clearRetryTimer=function(){this.retryTimer&&(this.retryTimer.ensureAborted(),this.retryTimer=null)};b.prototype.setUnavailableTimer=
function(){var a=this;this.unavailableTimer=new f.OneOffTimer(this.options.unavailableTimeout,function(){a.updateState("unavailable")})};b.prototype.clearUnavailableTimer=function(){this.unavailableTimer&&this.unavailableTimer.ensureAborted()};b.prototype.sendActivityCheck=function(){var a=this;this.stopActivityCheck();this.connection.ping();this.activityTimer=new f.OneOffTimer(this.options.pongTimeout,function(){a.timeline.error({pong_timed_out:a.options.pongTimeout});a.retryIn(0)})};b.prototype.resetActivityCheck=
function(){var a=this;this.stopActivityCheck();this.connection.handlesActivityChecks()||(this.activityTimer=new f.OneOffTimer(this.activityTimeout,function(){a.sendActivityCheck()}))};b.prototype.stopActivityCheck=function(){this.activityTimer&&this.activityTimer.ensureAborted()};b.prototype.buildConnectionCallbacks=function(){var a=this;return{message:function(b){a.resetActivityCheck();a.emit("message",b)},ping:function(){a.send_event("pusher:pong",{})},activity:function(){a.resetActivityCheck()},
error:function(b){a.emit("error",{type:"WebSocketError",error:b})},closed:function(){a.abandonConnection();a.shouldRetry()&&a.retryIn(1E3)}}};b.prototype.buildHandshakeCallbacks=function(a){var b=this;return g.extend({},a,{connected:function(a){b.activityTimeout=Math.min(b.options.activityTimeout,a.activityTimeout,a.connection.activityTimeout||Infinity);b.clearUnavailableTimer();b.setConnection(a.connection);b.socket_id=b.connection.id;b.updateState("connected",{socket_id:b.socket_id})}})};b.prototype.buildErrorCallbacks=
function(){var a=this,b=function(b){return function(c){c.error&&a.emit("error",{type:"WebSocketError",error:c.error});b(c)}};return{ssl_only:b(function(){a.encrypted=!0;a.updateStrategy();a.retryIn(0)}),refused:b(function(){a.disconnect()}),backoff:b(function(){a.retryIn(1E3)}),retry:b(function(){a.retryIn(0)})}};b.prototype.setConnection=function(a){this.connection=a;for(var b in this.connectionCallbacks)this.connection.bind(b,this.connectionCallbacks[b]);this.resetActivityCheck()};b.prototype.abandonConnection=
function(){if(this.connection){this.stopActivityCheck();for(var a in this.connectionCallbacks)this.connection.unbind(a,this.connectionCallbacks[a]);a=this.connection;this.connection=null;return a}};b.prototype.updateState=function(a,b){var c=this.state;this.state=a;if(c!==a){var d=a;"connected"===d&&(d+=" with new socket ID "+b.socket_id);e["default"].debug("State changed",c+" -> "+d);this.timeline.info({state:a,params:b});this.emit("state_change",{previous:c,current:a});this.emit(a,b)}};b.prototype.shouldRetry=
function(){return"connecting"===this.state||"connected"===this.state};return b}(h["default"]);b.__esModule=!0;b["default"]=a},function(h,b,a){var c=a(9),f=a(42);h=function(){function a(){this.channels={}}a.prototype.add=function(a,b){if(!this.channels[a]){var c=this.channels,e;e=0===a.indexOf("private-")?f["default"].createPrivateChannel(a,b):0===a.indexOf("presence-")?f["default"].createPresenceChannel(a,b):f["default"].createChannel(a,b);c[a]=e}return this.channels[a]};a.prototype.all=function(){return c.values(this.channels)};
a.prototype.find=function(a){return this.channels[a]};a.prototype.remove=function(a){var b=this.channels[a];delete this.channels[a];return b};a.prototype.disconnect=function(){c.objectApply(this.channels,function(a){a.disconnect()})};return a}();b.__esModule=!0;b["default"]=h},function(h,b,a){function c(a,b){e["default"].defer(function(){b(a)});return{abort:function(){},forceMinPriority:function(){}}}var f=a(42),e=a(11),g=a(30),d=a(9);h=function(){function a(b,c,d,e){this.name=b;this.priority=c;this.transport=
d;this.options=e||{}}a.prototype.isSupported=function(){return this.transport.isSupported({encrypted:this.options.encrypted})};a.prototype.connect=function(a,b){var e=this;if(this.isSupported()){if(this.priority<a)return c(new g.TransportPriorityTooLow,b)}else return c(new g.UnsupportedStrategy,b);var l=!1,h=this.transport.createConnection(this.name,this.priority,this.options.key,this.options),r=null,t=function(){h.unbind("initialized",t);h.connect()},v=function(){r=f["default"].createHandshake(h,
function(a){l=!0;B();b(null,a)})},y=function(a){B();b(a)},q=function(){B();var a;a=d.safeJSONStringify(h);b(new g.TransportClosed(a))},B=function(){h.unbind("initialized",t);h.unbind("open",v);h.unbind("error",y);h.unbind("closed",q)};h.bind("initialized",t);h.bind("open",v);h.bind("error",y);h.bind("closed",q);h.initialize();return{abort:function(){l||(B(),r?r.close():h.close())},forceMinPriority:function(a){l||e.priority<a&&(r?r.close():h.close())}}};return a}();b.__esModule=!0;b["default"]=h},
function(h,b,a){var c=a(9),f=a(11),e=a(12);h=function(){function a(b,c){this.strategies=b;this.loop=Boolean(c.loop);this.failFast=Boolean(c.failFast);this.timeout=c.timeout;this.timeoutLimit=c.timeoutLimit}a.prototype.isSupported=function(){return c.any(this.strategies,f["default"].method("isSupported"))};a.prototype.connect=function(a,b){var c=this,e=this.strategies,f=0,g=this.timeout,h=null,r=function(t,v){v?b(null,v):(f+=1,c.loop&&(f%=e.length),f<e.length?(g&&(g*=2,c.timeoutLimit&&(g=Math.min(g,
c.timeoutLimit))),h=c.tryStrategy(e[f],a,{timeout:g,failFast:c.failFast},r)):b(!0))},h=this.tryStrategy(e[f],a,{timeout:g,failFast:this.failFast},r);return{abort:function(){h.abort()},forceMinPriority:function(b){a=b;h&&h.forceMinPriority(b)}}};a.prototype.tryStrategy=function(a,b,c,f){var g=null,h=null;0<c.timeout&&(g=new e.OneOffTimer(c.timeout,function(){h.abort();f(!0)}));h=a.connect(b,function(a,b){if(!a||!g||!g.isRunning()||c.failFast)g&&g.ensureAborted(),f(a,b)});return{abort:function(){g&&
g.ensureAborted();h.abort()},forceMinPriority:function(a){h.forceMinPriority(a)}}};return a}();b.__esModule=!0;b["default"]=h},function(h,b,a){function c(a,b,c){var d=g.map(a,function(a,d,e,f){return a.connect(b,c(d,f))});return{abort:function(){g.apply(d,e)},forceMinPriority:function(a){g.apply(d,function(b){b.forceMinPriority(a)})}}}function f(a){return g.all(a,function(a){return Boolean(a.error)})}function e(a){!a.error&&!a.aborted&&(a.abort(),a.aborted=!0)}var g=a(9),d=a(11);h=function(){function a(b){this.strategies=
b}a.prototype.isSupported=function(){return g.any(this.strategies,d["default"].method("isSupported"))};a.prototype.connect=function(a,b){return c(this.strategies,a,function(a,c){return function(d,e){(c[a].error=d)?f(c)&&b(!0):(g.apply(c,function(a){a.forceMinPriority(e.transport.priority)}),b(null,e))}})};return a}();b.__esModule=!0;b["default"]=h},function(h,b,a){function c(a){return"pusherTransport"+(a?"Encrypted":"Unencrypted")}function f(a){var b=d["default"].getLocalStorage();if(b)try{var f=
b[c(a)];if(f)return JSON.parse(f)}catch(g){e(a)}return null}function e(a){var b=d["default"].getLocalStorage();if(b)try{delete b[c(a)]}catch(e){}}var g=a(11),d=a(2),l=a(56),m=a(9);h=function(){function a(b,c,d){this.strategy=b;this.transports=c;this.ttl=d.ttl||18E5;this.encrypted=d.encrypted;this.timeline=d.timeline}a.prototype.isSupported=function(){return this.strategy.isSupported()};a.prototype.connect=function(a,b){var k=this.encrypted,h=f(k),t=[this.strategy];if(h&&h.timestamp+this.ttl>=g["default"].now()){var v=
this.transports[h.transport];v&&(this.timeline.info({cached:!0,transport:h.transport,latency:h.latency}),t.push(new l["default"]([v],{timeout:2*h.latency+1E3,failFast:!0})))}var y=g["default"].now(),q=t.pop().connect(a,function u(f,l){if(f)e(k),0<t.length?(y=g["default"].now(),q=t.pop().connect(a,u)):b(f);else{var h=l.transport.name,r=g["default"].now()-y,v=d["default"].getLocalStorage();if(v)try{v[c(k)]=m.safeJSONStringify({timestamp:g["default"].now(),transport:h,latency:r})}catch(G){}b(null,l)}});
return{abort:function(){q.abort()},forceMinPriority:function(b){a=b;q&&q.forceMinPriority(b)}}};return a}();b.__esModule=!0;b["default"]=h},function(h,b,a){var c=a(12);h=function(){function a(b,c){var d=c.delay;this.strategy=b;this.options={delay:d}}a.prototype.isSupported=function(){return this.strategy.isSupported()};a.prototype.connect=function(a,b){var d=this.strategy,f,m=new c.OneOffTimer(this.options.delay,function(){f=d.connect(a,b)});return{abort:function(){m.ensureAborted();f&&f.abort()},
forceMinPriority:function(b){a=b;f&&f.forceMinPriority(b)}}};return a}();b.__esModule=!0;b["default"]=h},function(h,b){var a=function(){function a(b,c,g){this.test=b;this.trueBranch=c;this.falseBranch=g}a.prototype.isSupported=function(){return(this.test()?this.trueBranch:this.falseBranch).isSupported()};a.prototype.connect=function(a,b){return(this.test()?this.trueBranch:this.falseBranch).connect(a,b)};return a}();b.__esModule=!0;b["default"]=a},function(h,b){var a=function(){function a(b){this.strategy=
b}a.prototype.isSupported=function(){return this.strategy.isSupported()};a.prototype.connect=function(a,b){var c=this.strategy.connect(a,function(a,f){f&&c.abort();b(a,f)});return c};return a}();b.__esModule=!0;b["default"]=a},function(h,b,a){var c=a(5);b.getGlobalConfig=function(){return{wsHost:c["default"].host,wsPort:c["default"].ws_port,wssPort:c["default"].wss_port,httpHost:c["default"].sockjs_host,httpPort:c["default"].sockjs_http_port,httpsPort:c["default"].sockjs_https_port,httpPath:c["default"].sockjs_path,
statsHost:c["default"].stats_host,authEndpoint:c["default"].channel_auth_endpoint,authTransport:c["default"].channel_auth_transport,activity_timeout:c["default"].activity_timeout,pong_timeout:c["default"].pong_timeout,unavailable_timeout:c["default"].unavailable_timeout}};b.getClusterConfig=function(a){return{wsHost:"ws-"+a+".pusher.com",httpHost:"sockjs-"+a+".pusher.com"}}}])});angular.module("manifest",["manifest.controllers","manifest.directives","manifest.services"]);
(function(){var h=angular.module("manifest.controllers",[]);h.controller("manifest.IndexCtrl",["$scope","$filter","auth","controllers","db","events","manifestController","models","navigation","scanning","urls",function(b,a,c,f,e,g,d,l,m,k,h){var s=a("lastNameFirst"),p=l.Company,r={};r[h.dashboard.manifest.availabilities]=p.MANIFEST_AVAILABILITIES_VIEW;r[h.dashboard.manifest.items]=p.MANIFEST_ITEMS_VIEW;r[h.dashboard.manifest.bookings]=p.MANIFEST_BOOKINGS_VIEW;r[h.dashboard.manifest.runs]=p.MANIFEST_RUNS_VIEW;
r[h.dashboard.manifest.resources]=p.MANIFEST_RESOURCES_VIEW;var t=_.invert(r);b.ALLOWED_FILTERS={};b.ALLOWED_FILTERS[p.MANIFEST_AVAILABILITIES_VIEW]=["availabilities","items"];b.ALLOWED_FILTERS[p.MANIFEST_ITEMS_VIEW]=["items"];b.ALLOWED_FILTERS[p.MANIFEST_BOOKINGS_VIEW]=["items"];b.ALLOWED_FILTERS[p.MANIFEST_RUNS_VIEW]=["routes"];b.ALLOWED_FILTERS[p.MANIFEST_RESOURCES_VIEW]=["resources"];var v=function(a){if(!a)return"";_.isPlainObject(a)&&(a=_.fromTrueKeys(a));return a.join(",")},y=function(){return _.find(r,
function(a,b){return m.pathStartsWith(b)})};b.urlForView=function(a,c,d){var e={shortname:b.company.shortname};a=t[a];d?e.date=d.format("YYYY-MM-DD"):(d=m.pathStartsWith(h.dashboard.manifest.date),e.date=d.date||moment().format("YYYY-MM-DD"));e=h.populate(a,e);c&&(c=_.mapValues(c,v),c=_.pick(c,_.identity),e=m.compose(e,c));return e};var q=function(a,c,d){var e=p.MANIFEST_AVAILABILITIES_VIEW;if(!c||!m.get("overlay")){var f=y(),g=a&&!a.settings.view,e=c&&f?f:g||!a?f||e:a.settings.view,f=b.ALLOWED_FILTERS[e],
k={};a&&(k=_.pick(a.settings,f));(c||g||d)&&_.extend(k,B(f));a=b.urlForView(e,k);if(a!==m.url)return a}},B=function(a){var b={};_.forEach(a,function(a){var c=m.getPks(a);!_.any(c)&&"routes"!==a&&(c=(c=m.url.match(a+"/([0-9]+)"))?_.splitPks(c[1]):void 0);_.any(c)&&(b[a]=c)});return b};b.manifestFilter={};b.manifest=d.emptyManifest();var u=null,z=!0;b.currentCustomManifest=null;b.CUSTOM_MANIFEST_VIEW_SETTINGS=["view","items","routes","resources"];var C=["items","resources","routes"];b.refreshCurrentCustomManifest=
function(){z=b.currentCustomManifest?_.all(b.manifestFilter,function(a,b){if("tableFilters"===b)return!0;var c=u[b];return"view"===b&&!c?!0:_.contains(C,b)?!c?!0:_.isEqualTrueKeys(a,c):(a||!1)===(c||!1)}):!0};b.isCustomManifestSelected=function(a){return b.currentCustomManifest===a};b.isCustomManifestDirty=function(a){return!z&&b.isCustomManifestSelected(a)};b.updateCurrentCustomManifest=function(a,d){var e="customManifest:"+b.company.shortname;a?(c.storage.set(e,a.uri),b.currentCustomManifest=a,
u=d):(c.storage.del(e),u=b.currentCustomManifest=null);z=!0};b.applyCustomManifest=function(a,c,d){var e={showToggle:!0,showBookingID:!0,showCustomerCount:!1,showContact:!0,showContactPhone:!0,showContactEmail:!1,showCheckin:!0,showCustomerBreakdown:!0,showLanguage:!1,showCreatedAt:!1,showOriginalCreatedAt:!1,showBookedBy:!1,showOriginalBookedBy:!1,showGross:!1,showPaidStatus:!0,showPaymentNotes:!0,showCreditCardPaymentNotes:!1,showCashPaymentNotes:!1,showVoucherPaymentNotes:!1,showCompanyCreditPaymentNotes:!1,
showItemShortName:!0,isBrokenOut:!1,autoScanningType:k.DEFAULT_AUTO_SCANNING_TYPE,invalidCheckinType:k.DEFAULT_INVALID_CHECKIN_TYPE,tableFilters:{},groupBy:"",usePageBreaks:!1,showWaiverBreakdown:!1,includeCustomFields:!0,showAvailabilityNote:!0,hideEmptyNoteField:!0};a&&(_.isUndefined(a.settings.showItemShortName)&&(a.settings.showItemShortName=!1),_.extend(e,a.settings));_.ref.pick(b.manifestFilter,b.CUSTOM_MANIFEST_VIEW_SETTINGS);_.forEach(e,function(a,c){_.isObject(a)?b.manifestFilter[c]=_.clone(a,
!0):b.manifestFilter[c]=a});b.updateCurrentCustomManifest(a,e);(a=q(a,c,d))&&(c||!y()?m.redirect(a,"replace"):m.navigate(a))};b.isAllCustomersOpen=!1;var F={},x={},w={};b.isManifestCustomersOpen=function(a){a=F[a];return!_.isUndefined(a)?a:b.isAllCustomersOpen};b.isGroupCustomersOpen=function(a,c){var d=x[(a.by||"none")+":"+c];return!_.isUndefined(d)?d:b.isManifestCustomersOpen(c)};b.isBookingCustomersOpen=function(a){a=w[a];return!_.isUndefined(a)?a:b.isAllCustomersOpen};b.toggleAllCustomers=function(){b.isAllCustomersOpen=
!b.isAllCustomersOpen;F={};x={};w={}};b.toggleManifestCustomers=function(a,c){var d=b.isManifestCustomersOpen(a);F[a]=!d;_.forEach(c,function(a){w[a.uri]=!d})};b.toggleGroupCustomers=function(a,c,d){var e=b.isGroupCustomersOpen(a,c);x[(a.by||"none")+":"+c]=!e;_.forEach(d,function(a){w[a.uri]=!e})};b.toggleBookingCustomers=function(a){var c=b.isBookingCustomersOpen(a);w[a]=!c};g.on(b,"dashboard.CustomFieldValueCtrl.updated",function(){g.broadcast("manifest.IndexCtrl.reconstruct")});b.$watch("manifestFilter.isBrokenOut",
function(a,b){a!==b&&g.broadcast("manifest.IndexCtrl.reconstruct")});b.$watch("manifestFilter.autoScanningType",function(a){a||(a=b.manifestFilter.autoScanningType=k.DEFAULT_AUTO_SCANNING_TYPE,b.currentCustomManifest&&(b.currentCustomManifest.settings.autoScanningType=a));k.autoScanningType=a});b.$watch("manifestFilter.invalidCheckinType",function(a){a||(a=b.manifestFilter.invalidCheckinType=k.DEFAULT_INVALID_CHECKIN_TYPE,b.currentCustomManifest&&(b.currentCustomManifest.settings.invalidCheckinType=
a));k.invalidCheckinType=a});b.manifestTracker=_.tracker();b.$watch("manifestFilter.includeCustomFields",function(a,c){a&&!_.isUndefined(c)?b.manifestTracker.modified():!a&&c&&b.manifestTracker.modified()});b.summarizeCustomerTypes=function(a,b){a=a||{};_.forEach(b.customers,function(b){b=b.customerTypeRate.customerPrototype.customerType;var c=a[b.uri]||{customerType:b,count:0};a[b.uri]=c;c.count+=1});return a};b.summarizeCustomerTypes.value={};b.summarizeCustomerTypes.initial=function(){_.forEach(b.summarizeCustomerTypes.value,
function(a){a.count=0});return b.summarizeCustomerTypes.value};b.checkedInCount=function(a){return _.sum(a.customers,function(a){return l.CheckinStatus.isCheckedIn(a.checkinStatus)?1:0})};b.summarizeCustomerCheckinStatuses=function(a,b){_.forEach(b.customers,function(b){var c=b.checkinStatus;b=c?c.uri:"none";c=a[b]||{checkinStatus:c,count:0};a[b]=c;c.count+=1});return a};b.summarizeCustomerCheckinStatuses.value={};b.summarizeCustomerCheckinStatuses.initial=function(){_.forEach(b.summarizeCustomerCheckinStatuses.value,
function(a){a.count=0});return b.summarizeCustomerCheckinStatuses.value};b.summarizeAnnotatedCustomFieldValues=function(a,b){if(!b)return a;_.forEach(b,function(b,c){if(_.isNumber(c)&&l.CustomField.isAggregatable(b.customFieldValue.customFieldInstance.customField)&&b.count){var d;d=b.customFieldValue.customFieldInstance.customField.type===l.CustomField.COUNT_TYPE?"count":b.key;var e;if(!(e=a[d]))e=b.customFieldValue.customFieldInstance.customField,e=e.type===l.CustomField.YES_NO_TYPE?"":e.type===
l.CustomField.COUNT_TYPE?"":b.displayValue,e={count:0,displayValue:e};a[d]=e;e.count+=b.count}});return a};b.summarizeAnnotatedCustomFieldValues.value={};b.summarizeAnnotatedCustomFieldValues.initial=function(a){var c=b.summarizeAnnotatedCustomFieldValues.value[a.uri]||{};b.summarizeAnnotatedCustomFieldValues.value[a.uri]=c;_.forEach(c,function(a){a.count=0});return c};b.summarizeResource=function(a,b){return _.sum(b[a.uri],function(a){return a.resourceUse.useCount||0})};b.sortByResource=b.summarizeResource;
b.summarizeStop=function(a,b){var c=b.stop;if(!b.stop)return a;var d=a[c.uri]||{count:0,stop:c};a[c.uri]=d;d.count+=b.customerCount;return a};b.summarizeStop.value={};b.summarizeStop.initial=function(){_.forEach(b.summarizeStop.value,function(a){a.count=0});return b.summarizeStop.value};b.sortSummarizedStops=function(a){a=_.values(a);return _.sortBy(a,function(a){return[b.sortableStopTime(a.stop),a.stop.pickup?a.stop.pickup.shortName:"",a.stop.pickup?a.stop.pickup.pk:0]})};b.summarizePayments=function(a,
c){_.forEach(c.payments,function(c){if(!b.manifestFilter.showAffiliatePaymentNotes&&c.type===l.Payment.AFFILIATE_TYPE||!b.manifestFilter.showCashPaymentNotes&&c.type===l.Payment.IN_STORE_TYPE||!b.manifestFilter.showCreditCardPaymentNotes&&c.isProcessorBasedType)return a;c.isCardOnFile&&(c.displayType=T("company card"));var d=a[c.displayType]||{displayType:c.displayType,isProcessorBasedType:c.isProcessorBasedType,prefix:c.prefix,gross:0,net:0};a[c.displayType]=d;d.gross+=c.receipt.gross;d.net+=c.receipt.net});
return a};b.summarizePayments.initial=function(){_.forEach(b.summarizePayments.value,function(a){a.gross=0;a.net=0});return b.summarizePayments.value};b.summarizePayments.value={};b.sortSummarizedPayments=function(a){return _.sortBy(_.values(a),function(a){return a.displayType})};b.sortByContactName=function(a){var c=a.contact.name;b.manifestFilter&&b.manifestFilter.isLastNameFirst&&(c=s(a.contact.name));return c.toLowerCase()};b.sortableStopTime=function(a){return a?moment(a.time,"HH:mm").unix():
0};b.sortByCheckin=function(a){var b=l.CheckinStatus.bookingCheckinStatus(a),b=l.CheckinStatus.checkinStatusSort(b);b.push(a.contact.name);return b};b.sortByCustomField=function(a,b,c){if(!b)return console.warn("manifest: no annotated custom fields",c.uri),"";b=b[a.uri];if(!b)return console.warn("manifest: no annotated custom fields",a),"";if(a.type===l.CustomField.COUNT_TYPE){if(1===b.length)return b[0].count||0}else if(a.type===l.CustomField.TRANSPORTATION_TYPE){if(1===b.length&&(a=b[0].transportationOption))return[!a.isSelfLodging,
-a.minutesBeforeStart,a.shortName||a.location]}else if(a.type===l.CustomField.YES_NO_TYPE&&1===b.length)return b[0].count||0;return _.pluck(b,"displayValue").join(" ")};b.sortByPaymentNotes=function(a){return a.affiliation&&b.manifestFilter.showAffiliatePaymentNotes?2:_.any(a.payments,function(a){return!a.isRefunded&&a.note})?1:3};b.filterableCheckinStatuses=[];b.filteredCheckinStatuses=function(a){return _.map(a.customers,function(a){return a.checkinStatus||l.CheckinStatus.EMPTY_CHECKIN_STATUS})};
var G=[l.CustomField.SHORT_TYPE,l.CustomField.LONG_TYPE,l.CustomField.YES_NO_TYPE,l.CustomField.EXTENDED_OPTION_TYPE],M=[l.CustomField.SHORT_TYPE,l.CustomField.LONG_TYPE,l.CustomField.EXTENDED_OPTION_TYPE],K=[l.CustomField.YES_NO_TYPE],H=[l.CustomField.COUNT_TYPE,l.CustomField.NUMBER_TYPE];b.isFilterableCustomField=function(a){return _.contains(G,a.type)};b.isStringFilterableCustomField=function(a){return _.contains(M,a.type)};b.isYesNoFilterableCustomField=function(a){return _.contains(K,a.type)};
b.isNumberFilterableCustomField=function(a){return _.contains(H,a.type)};b.filterCustomField=function(a,c,d){c=c[a.uri];if(!c)return null;c=c.customFieldValues;if(!c||!c.length)return null;if(b.isStringFilterableCustomField(a))return _.map(c,"displayValue").join(" ");if(b.isYesNoFilterableCustomField(a))return _.any(c,"value");if(b.isNumberFilterableCustomField(a))return _.sum(c,"value")};var L={},E=function(){_.clear(L)},N=function(a,b,c){_.forEach(a,function(a){a&&(a=_.get(a,b))&&c.push(a)})};b.filterSearch=
function(a){var b=new Date;L.$date&&5E3<b-L.$date&&(E(),L.$date=b);b=L[a.uri];if(_.isUndefined(b)){var c=["#"+a.pk,a.contact.name,a.contact.email,a.contact.phone,a.note],b=[a.user,a.originalUser];N(b,"name",c);N(b,"username",c);N(a.customFieldValues,"displayValue",c);N(a.payments,"note",c);N(a.payments,"processorBasedIdentifier",c);N(a.payments,"postalCode",c);_.forEach(a.waiverInstances,function(a){N(a.participants,"name",c);N(a.participants,"email",c)});b=c.join(" ").toLowerCase();L[a.uri]=b}return b};
g.on(b,"manifest.IndexCtrl.reconstruct",E);b.filterResource=function(a,b,c){b=b[a.uri];return!b?null:0<b.length};b.itemName=function(a,c){if(!a)return"";var d=b.manifestFilter.showItemShortName?a.shortName||a.name:a.name;a.isArchived&&!c&&(d+=" ("+T("archived")+")");return d};a=b.route.bindings.shortname;b.company=e.company({shortname:a});b.resources=e.resources({shortname:b.route.bindings.shortname});b.checkinStatuses=e.checkinStatuses({shortname:a},null,null,null,{tagAlong:!0});b.customFields=e.customFields({shortname:a},
null,null,null,{flashError:!0});b.customManifests=e.customManifests({shortname:m.currentCompany.shortname});return f.dataController(b,{promises:[b.company.$promise,b.checkinStatuses.$promise,b.resources.$promise,b.customManifests.$promise],successCallback:function(){b.canViewAmounts=c.permissions.can("viewAmounts",b.company);b.canViewInvoiceAmounts=c.permissions.can("viewInvoiceAmounts",b.company);b.filterableCheckinStatuses=_.append([l.CheckinStatus.EMPTY_CHECKIN_STATUS],b.checkinStatuses);var a=
!0;m.watch(b,function(d,e){if(a||!y()){var f=a,g,k=c.storage.get("customManifest:"+b.company.shortname);k&&(g=_.find(b.customManifests,{uri:k}));!g&&c.currentUser.defaultCustomManifest&&(g=_.find(b.customManifests,{uri:c.currentUser.defaultCustomManifest.uri}));g||(g=_.first(b.customManifests));b.applyCustomManifest(g,f)}a=!1;b.manifestFilter.view=y()})}})}]);h.controller("manifest.NavigationCtrl",["$scope","$filter","controllers","dates","db","events","models","navigation","require","urls",function(b,
a,c,f,e,g,d,l,m,k){m.inScope(b,"manifestFilter","manifest.NavigationCtrl");m.inScope(b,"company","manifest.NavigationCtrl");c=moment(b.route.bindings.date,"YYYY-MM-DD");a("timeRange");b.navigationCtrl={generatedDate:moment(),currentDate:c,selectedDate:c.format("YYYY-MM-DD")};b.getSingleSelectedFilter=function(a){a=b.manifestFilter[a];a=_.fromTrueKeys(a,_.int);return 1===a.length?a[0]:null};b.exportFilename=function(){var a=b.navigationCtrl.currentDate.format("MM-DD-YYYY"),c=b.company.shortname,c=
c+("-"+b.manifestFilter.view);return c+("-manifest-"+a+".csv")};var h=c.clone().add("days",-1),s=c.clone().add("days",1),p=moment().startOf("day"),r=function(a){var c=b.manifestFilter.view,d=_.pick(b.manifestFilter,b.ALLOWED_FILTERS[c]);return b.urlForView(c,d,a)};b.switchView=function(a){var c=_.pick(b.manifestFilter,b.ALLOWED_FILTERS[a]);a=b.urlForView(a,c);l.navigate(a)};b.switchToPreviousDate=function(){var a=r(h);l.navigate(a)};b.switchToToday=function(){var a=r(p);l.navigate(a)};b.switchToNextDate=
function(){var a=r(s);l.navigate(a)};b.$watch("navigationCtrl.selectedDate",function(a,b){if(a!==b){var c=moment(a),c=r(c);l.navigate(c)}})}]);h.controller("manifest.CustomManifestsCtrl",["$scope","auth","controllers","db","models","navigation","require",function(b,a,c,f,e,g,d){d.inScope(b,"customFields","manifest.CustomManifestsCtrl");d.inScope(b,"resources","manifest.CustomManifestsCtrl");d.inScope(b,"customManifests","manifest.CustomManifestsCtrl");d.inScope(b,"company","manifest.CustomManifestsCtrl");
d.inScope(b,"applyCustomManifest","manifest.CustomManifestsCtrl");a=function(){b.customManifestFields=_.filter(b.customFields,e.CustomField.isManifestField)};b.customFields.$promise?b.customFields.$promise.then(a):a();c.listController(b,{collectionKey:"customManifests",modelKey:"newCustomManifest",create:f.customManifests.create,submitCallback:function(){var a=_.clone(b.manifestFilter);b.newCustomManifest.isViewSaved||(a=_.omit(a,b.CUSTOM_MANIFEST_VIEW_SETTINGS));b.newCustomManifest.settings=_.stringifyJSON(a)},
successCallback:function(a){b.applyCustomManifest(a,!1,!0)},params:function(){return{shortname:b.company.shortname}},sortable:!0})}]);h.controller("manifest.AvailabilitiesCtrl",["$scope","$filter","controllers","db","events","localization","manifestController","navigation","require",function(b,a,c,f,e,g,d,l,m){m.notNull(l,"currentCompany","manifest.AvailabilitiesCtrl");a("timeRange");var k=b.route.bindings.date,h;l.watch(b,function(a,e){var g={},m=l.get("availabilities"),v=l.get("items");m&&(g.availabilityPks=
m);v&&(g.itemPks=v);b.manifestFilter.includeCustomFields||(g.skipCustomFields="yes");h&&h.cancel();h=f.availabilities.manifest({shortname:l.currentCompany.shortname,date:k},null,null,g).$promise;c.dataController(b,{promises:[h,b.customFields.$promise],successCallback:function(a){a=a[0];if(a!==f.CANCELLED){b.availabilities=a.primaryData;var c=a.bookings;a=a.crewMembers;_.forEach(b.availabilities,function(a){a.bookings=[];a.crewMembers=[]});_.forEach(c,function(a){a.availability.bookings.push(a)});
_.forEach(a,function(a){a.availability.crewMembers.push(a)});d.watch(b,{bookingsFn:function(){return c},newBookingFn:function(a,b){if(!_.contains(a.bookings,b))return a.bookings.push(b),!0},removeBookingFn:function(a){_.overwriteWithout(a.availability.bookings,a)},watch:b.availabilities})}}})},{search:["items","availabilities"]})}]);h.controller("manifest.RunsCtrl",["$scope","$filter","controllers","db","events","manifestController","navigation","require",function(b,a,c,f,e,g,d,l){l.notNull(d,"currentCompany");
var m=b.route.bindings.date,k;d.watch(b,function(a){a={};var e=d.get("routes");e&&(a.routePks=e);b.manifestFilter.includeCustomFields||(a.skipCustomFields="yes");k&&k.cancel();var l=f.runs.manifest({shortname:d.currentCompany.shortname,date:m},null,null,a);k=l.$promise;c.dataController(b,{promises:[l.$promise,b.customFields.$promise],successCallback:function(a){a[0]!==f.CANCELLED&&(b.runs=_.filter(l,function(a){return 0<a.bookings.length}),g.watch(b,{bookingsFn:function(){return _.append.apply(_,
_.pluck(b.runs,"bookings"))},newBookingFn:function(a,b){if(!_.contains(a.bookings,b))return a.bookings.push(b),!0},removeBookingFn:function(a){_.forEach(b.runs,function(b){_.overwriteWithout(b.bookings,a)})},watch:b.runs}))}})},{search:["routes"]})}]);h.controller("manifest.ItemsCtrl",["$scope","$filter","controllers","db","events","manifestController","navigation","require","urls",function(b,a,c,f,e,g,d,l,m){l.notNull(d,"currentCompany");var k=b.route.bindings.date,h;d.watch(b,function(a){var e=
{};if(a=d.get("items"))e.itemPks=a;b.manifestFilter.includeCustomFields||(e.skipCustomFields="yes");h&&h.cancel();h=f.availabilities.manifest({shortname:d.currentCompany.shortname,date:k},null,null,e).$promise;c.dataController(b,{promises:[h,b.customFields.$promise],successCallback:function(a){a=a[0];if(a!==f.CANCELLED){var c=a.primaryData,d=a.bookings;b.items=[];var l={};_.forEach(c,function(a){var c=l[a.item.uri];c?c.customerCount+=a.customerCount:(b.items.push(a.item),l[a.item.uri]={customerCount:a.customerCount})});
e.itemPks||(b.items=_.filter(b.items,function(a){return 0<l[a.uri].customerCount}));g.watch(b,{bookingsFn:function(){b.bookings={};_.forEach(d,function(a){var c=b.bookings[a.availability.item.uri]||[];c.push(a);b.bookings[a.availability.item.uri]=c});return d},newBookingFn:function(a,c){var d=b.bookings[c.availability.item.uri];if(d&&!_.contains(d,c))return d.push(c),!0},removeBookingFn:function(a){_.overwriteWithout(b.bookings[a.availability.item.uri],a)},watch:k})}}})},{search:["items"]})}]);h.controller("manifest.ResourcesCtrl",
["$scope","$filter","controllers","db","events","manifestController","navigation","require",function(b,a,c,f,e,g,d,l){l.notNull(d,"currentCompany","manifest.ResourcesCtrl");var m=b.route.bindings.date,k,h=f.availabilities.manifestSelectable({shortname:b.route.bindings.shortname,date:b.route.bindings.date});d.watch(b,function(a){a={};var e=d.get("resources");e&&(a.resourcePks=e);b.manifestFilter.includeCustomFields||(a.skipCustomFields="yes");k&&k.cancel();var l=f.resources.manifest({shortname:d.currentCompany.shortname,
date:m},null,null,a);k=l.$promise;c.dataController(b,{promises:[l.$promise,b.customFields.$promise,h.$promise],successCallback:function(a){a[0]!==f.CANCELLED&&(b.resources=_.filter(l,function(a){return 0<a.bookings.length}),g.watch(b,{bookingsFn:function(){return _.append.apply(_,_.pluck(b.resources,"bookings"))},newBookingFn:function(a,c){var d=!1;_.forEach(b.resources,function(a){_.any(c.resourceUses,function(b){return b.resourceRequirement.resource===a})&&!_.contains(a.bookings,c)&&(a.bookings.append(c),
d=!0)});return d},removeBookingFn:function(a){_.forEach(b.resources,function(b){_.overwriteWithout(b.bookings,a)})},watch:m}))}})},{search:["resources"]})}]);h.controller("manifest.BookingsCtrl",["$scope","$filter","controllers","db","events","manifestController","navigation","require",function(b,a,c,f,e,g,d,l){l.notNull(d,"currentCompany");var m=b.route.bindings.date,k;d.watch(b,function(a){a={};var e=d.get("items");e&&(a.itemPks=e);b.manifestFilter.includeCustomFields||(a.skipCustomFields="yes");
k&&k.cancel();b.bookings=f.bookings.manifest({shortname:b.company.shortname,date:m},null,null,a);k=b.bookings.$promise;return c.dataController(b,{promises:[b.bookings.$promise,b.customFields.$promise],successCallback:function(a){a[0]!==f.CANCELLED&&g.watch(b,{bookingsFn:function(){return b.bookings},newBookingFn:function(a,c){if(!_.contains(b.bookings,c))return b.bookings.push(c),!0},removeBookingFn:function(a){_.overwriteWithout(b.bookings,a)},watch:m})}})},{search:["items"]})}]);h.controller("manifest.shared.CustomManifestEditableCtrl",
["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"customManifests","manifest.shared.CustomManifestEditableCtrl");f.inScope(b,"customManifest","manifest.shared.CustomManifestEditableCtrl");f.inScope(b,"applyCustomManifest","manifest.shared.CustomManifestEditableCtrl");f.inScope(b,"currentCustomManifest","manifest.shared.CustomManifestEditableCtrl");f.inScope(b,"updateCurrentCustomManifest","manifest.shared.CustomManifestEditableCtrl");return a.editController(b,{collectionKey:"customManifests",
elementKey:"customManifest",modelKey:"editableCustomManifest",update:c.customManifest.update,remove:c.customManifest.remove,editCallback:function(){b.editableCustomManifest.isViewSaved=!!b.customManifest.settings.view},submitCallback:function(){var a;b.editableCustomManifest.overwriteSettings?(a=_.clone(b.manifestFilter),b.editableCustomManifest.isViewSaved||(a=_.omit(a,b.CUSTOM_MANIFEST_VIEW_SETTINGS))):a=b.customManifest.settings;b.editableCustomManifest.settings=_.stringifyJSON(a)},successCallback:function(){b.applyCustomManifest(b.customManifest,
!1,!0)},removeCallback:function(){b.currentCustomManifest===b.customManifest&&b.updateCurrentCustomManifest(null)},params:function(){return{shortname:b.customManifest.company.shortname,customManifestPk:b.customManifest.pk}}})}]);h.controller("manifest.shared.BookingCheckinStatusEditableCtrl",["$scope","checkin","events","models","navigation","require","urls",function(b,a,c,f,e,g,d){g.inScope(b,"booking","manifest.shared.BookingCheckinStatusEditableCtrl");g.inScope(b,"checkinStatuses","manifest.shared.BookingCheckinStatusEditableCtrl");
a.bookingCheckinStatusController(b,{booking:b.booking,checkinStatuses:b.checkinStatuses,mixedCheckinStatus:!0,successCallback:function(a){c.broadcast("manifest.shared.BookingCheckinStatusEditableCtrl.updated");a===f.CheckinStatus.MIXED_CHECKIN_STATUS&&e.navigate(b.booking.$url(d.dashboard.overlay.contact.booking))}})}]);h.controller("manifest.shared.CheckinSummaryCtrl",["$scope","auth","models","require",function(b,a,c,f){f.inScope(b,"$table","manifest.shared.CheckinSummaryCtrl");b.canCheckinGroup=
_.any(b.$table.collection,function(b){return a.permissions.can("updateCheckinStatus",c.Customer,b)})}])})();
(function(){angular.module("manifest.services",[]).factory("manifestController",["$filter","$q","db","events","models","require","sonar",function(h,b,a,c,f,e,g){var d=h("time"),l=function(a,b){var c={"default":[]},e={"default":[]},g={},l={},m=_.unique(a),h=function(a,b){_.forEach(a,function(a){var c=a.resourceRequirement.resource;_.forEach(b,function(a){-1===a.indexOf(c)&&a.push(c)})})},q=function(a,b){_.forEach(a,function(a){var c=a.customFieldInstance.customField;f.CustomField.isManifestField(c)&&
_.forEach(b,function(a){-1===a.indexOf(c)&&a.push(c)})})};_.forEach(m,function(a){var b=[],c=e[a.uri]||[];e[a.uri]=c;b.push(c);var c=a.availability.item,d=e[c.uri]||[];e[c.uri]=d;b.push(d);c=a.availability;d=e[c.uri]||[];e[c.uri]=d;b.push(d);if(c=a.run||null)d=e[c.uri]||[],e[c.uri]=d,b.push(d);b.push(e["default"]);h(a.resourceUses,b)});_.forEach(e["default"],function(a){e[a.uri]=e["default"]});_.forEach(m,function(a){var b=[],d=a.item,f=c[d.uri]||[];c[d.uri]=f;b.push(f);d=a.availability;f=c[d.uri]||
[];c[d.uri]=f;b.push(f);if(d=a.run||null)f=c[d.uri]||[],c[d.uri]=f,b.push(f);b.push(c["default"]);_.forEach(e[a.uri],function(a){var d=c[a.uri]||[];c[a.uri]=d;b.push(d)});q(a.customFieldValues,b);_.forEach(a.customers,function(a){q(a.customFieldValues,b)})});var B=function(a){g[a.uri]={};_.forEach(c["default"],function(c){var e={},k=[],l=[],m=function(a,c){l.push(a);var d;d=a.customFieldInstance.customField.type===f.CustomField.TRANSPORTATION_TYPE?a.transportationOption&&!a.transportationOption.isSelfTransportation?
a.transportationOption.value:T("Self transportation"):a.value?a.value.toString():"";var g;g=a.customFieldInstance.customField.type===f.CustomField.TRANSPORTATION_TYPE?a.transportationOption&&!a.transportationOption.isSelfTransportation?a.booking.customerCount:0:a.customFieldInstance.customField.type===f.CustomField.COUNT_TYPE?a.value:a.value?1:0;var m=f.CustomField.isAggregatable(a.customFieldInstance.customField),h=a.customer?a.customer.pk:a.pk;if(c||!m||b)k.push({customFieldValue:a,key:d,count:g,
displayValue:a.customFieldInstance.customField.type===f.CustomField.COUNT_TYPE&&!a.value?"":a.displayValue,transportationOption:a.transportationOption||null,isAggregated:!1,sortableIndex:h});else{if(!(m=e[d]))m=_.contains([f.CustomField.YES_NO_TYPE,f.CustomField.TRANSPORTATION_TYPE,f.CustomField.COUNT_TYPE],a.customFieldInstance.customField.type)?"":a.displayValue,m={customFieldValue:a,key:d,count:0,displayValue:m,transportationOption:null,isAggregated:!0,sortableIndex:h};h=m;g&&(h.count+=g,e[d]=
h)}};_.forEach(a.customFieldValues,function(a){a.customFieldInstance.customField===c&&m(a,!0)});_.forEach(a.customers,function(a){_.forEach(a.customFieldValues,function(a){a.customFieldInstance.customField===c&&m(a,!1)})});var h=_.append(_.values(e),k),h=_.sortBy(h,"sortableIndex");_.forEach(h,function(a){var b="",b=a.customFieldValue,c=b.transportationOption;if(c){var e=b.booking.availability.startAt.clone();e.subtract(c.minutesBeforeStart,"minutes");b=interpolate(T("%(time)s at %(name)s"),{time:d(e),
name:b.displayValue})}else b=a.isAggregated&&a.count?a.count.toString()+" "+a.displayValue:a.displayValue;a.renderedValue=b});g[a.uri][c.uri]=h;g[a.uri][c.uri].customFieldValues=l})};_.forEach(m,function(a){B(a)});var u={};_.forEach(m,function(a){var b=l[a.uri]||{};l[a.uri]=b;u[a.uri]={};_.forEach(e["default"],function(c){var d=b[c.uri]||[];b[c.uri]=d;u[a.uri][c.uri]=[];var e={};_.forEach(a.resourceUses,function(a){if(a.resourceRequirement.resource===c){d.push({resourceUse:a});var b=[a.startAt,a.endAt,
a.displayName].join("-");e[b]?e[b].useCount+=a.useCount:e[b]={useCount:a.useCount,startAt:a.startAt,endAt:a.endAt,displayName:a.displayName}}});_.forEach(e,function(b){u[a.uri][c.uri].push(b)})})});return{resources:e,annotatedResourceUses:l,customFields:c,annotatedCustomFieldValues:g,aggregatedResourceUses:u}},m=function(a,b){console.info("manifestController: constructing manifest",b);var c=l(b.bookings,!!b.isBrokenOut);_.overwrite(a.resources,c.resources);_.overwrite(a.annotatedResourceUses,c.annotatedResourceUses);
_.overwrite(a.aggregatedResourceUses,c.aggregatedResourceUses);_.overwrite(a.customFields,c.customFields);_.overwrite(a.annotatedCustomFieldValues,c.annotatedCustomFieldValues);_.clear(a.filterableResources);_.forEach(a.resources["default"],function(b){a.filterableResources[b.uri]=b});_.clear(a.filterableCustomFields);_.forEach(a.customFields["default"],function(b){f.CustomField.isManifestField(b)&&(a.filterableCustomFields[b.uri]=b)});_.overwrite(a.bookings,b.bookings);var d={};_.forEach(a.bookings,
function(b){var c=a.trackers[b.uri];c&&(d[b.uri]=c)});_.overwrite(a.trackers,d);return a};m.emptyManifest=function(){return{resources:{},annotatedResourceUses:{},aggregatedResourceUses:{},customFields:{},annotatedCustomFieldValues:{},filterableResources:{},filterableCustomFields:{},bookings:[],trackers:{}}};m.watch=function(d,f){e.defined(f,"bookingsFn","manifestController");e.defined(f,"newBookingFn","manifestController");e.defined(f,"watch","manifestController");e.inScope(d,"manifest","manifestController");
e.inScope(d,"manifestFilter","manifestController");var l=function(){m(d.manifest,{bookings:f.bookingsFn(),isBrokenOut:d.manifestFilter.isBrokenOut})},h=function(){console.log("manifestController: reconstructing...");l();d.$tableFilters&&d.$tableFilters.update()};d.manifest.deregister&&(console.log("manifestController: deregistering..."),d.manifest.deregister(),d.manifest.deregister=null);var r=c.on(d,"manifest.IndexCtrl.reconstruct",h),t=g.watch(d,f.watch,"bookings.created",function(c,d){console.log("manifestController: loading new booking");
return g.get(a.booking.byPk,{shortname:d.company,bookingPk:d.booking}).$promise.then(function(a){!0===f.newBookingFn(c,a)&&(console.log("manifestController: added new booking"),h(),q());b.reject()})}),v,y,q=function(){v&&v();y&&y();v=g.watch(d,d.manifest.bookings,"updated",function(a){console.log("manifestController: updated booking");return g.get(a.uri).$promise.then(function(a){a.isCancelled&&f.removeBookingFn(a);var b=d.manifest.trackers[a.uri]||_.tracker();b.modified();d.manifest.trackers[a.uri]=
b;h()})});y=g.watch(d,d.availabilities,"updated",function(b){console.log("manifestController: updated availability");return g.get(a.availability.checkinStatuses,{shortname:d.company.shortname,itemPk:b.item.pk,availabilityPk:b.pk}).$promise.then(function(){c.broadcast("ngGroupCheckin.update");h()})})};l();q();d.manifest.deregister=function(){r();t();v();y()}};return m}])})();
(function(){var h=angular.module("manifest.directives",[]);h.directive("ngGroupCheckin",["checkin","events","flash","models","require",function(a,b,f,e,g){return{restrict:"A",scope:!0,templateUrl:"dashboard.manifest.ngGroupCheckin",controllerAs:"groupCheckinCtrl",controller:["$scope","$timeout","$window","$attrs",function(d,f,m,k){g.inScope(d,"checkinStatuses","ngGroupCheckin");g.inScope(d,"company","ngGroupCheckin");g.inScope(d,"$table","ngGroupCheckin");k=k.ngGroupCheckinTableName||"$table";g.inScope(d,
k,"ngTable controller must be in scope");k=d[k];var h=k.collection,s=this,p=e.CheckinStatus.MIXED_CHECKIN_STATUS,r=e.CheckinStatus.EMPTY_CHECKIN_STATUS,t=function(){if(!h.length)return p;var a=h[0].customers[0].checkinStatus;return _.every(h,function(b){return _.every(b.customers,{checkinStatus:a})})?a?a:r:p},v=function(){s.ngModel=t().pk};v();k.watch(d,v);b.on(d,"manifest.shared.BookingCheckinStatusEditableCtrl.updated",function(){v()});b.on(d,"ngGroupCheckin.update",function(){v()});s.options=_.append([r],
d.checkinStatuses);s.ngModel===p.pk&&s.options.unshift(p);var y=_.keyBy(s.options,"pk"),q=function(b){if(!s.isProcessing){var c=d.$interpolate(interpolate(T("Are you sure you wish to update %(count)s bookings to %(checkInStatusName)s?"),{count:h.length,checkInStatusName:b.name}));m.confirm(c)?(b===r&&(b=null),s.isProcessing=!0,f(function(){a.updateBookings({bookings:h,checkinStatus:b,company:d.company});s.isProcessing=!1})):s.ngModel=t().pk}};d.$watch("groupCheckinCtrl.ngModel",function(a,b){if(a!==
b){var c=s.options[0]===p;a===p.pk?c||s.options.unshift(p):(c&&s.options.shift(p),a!==t().pk&&q(y[a]))}})}]}}]);var b=function(a,b){return _.filter(a,function(a){return!!b[a]})};h.controller("manifest.RouteFilterCtrl",["$scope","$q","db","navigation","require",function(a,c,f,e,g){g.inScope(a,"urlForView","manifest.RouteFilterCtrl");g.inScope(a,"manifestFilter","manifest.RouteFilterCtrl");g.inScope(a,"getSingleSelectedFilter","manifest.RouteFilterCtrl");var d=this;d.routes=f.routes.pickable({shortname:a.route.bindings.shortname});
d.runs=f.runs.searchByDate({shortname:a.route.bindings.shortname,date:a.route.bindings.date});var l=function(a){return d.showEmptyRoutes||d.runsByRoute[a.pk]};d.showEmptyRoutes=!1;d.toggleEmptyRoutes=function(){d.showEmptyRoutes=!d.showEmptyRoutes;d.visibleRoutes=_.filter(d.routes,l)};var m;d.promises=c.all([d.routes.$promise,d.runs.$promise]);d.promises.then(function(){d.runsByRoute=_.groupBy(d.runs,"route.pk");d.visibleRoutes=_.filter(d.routes,l);m=_.keyBy(d.routes,"pk");e.watch(a,function(){a.manifestFilter.routes=
_.toTrueKeys(b(e.getPks("routes"),m));var c;c=(c=a.getSingleSelectedFilter("routes"))&&_.findWhere(d.routes,{pk:c});d.currentRoute=c;d.numRoutes=_.sum(a.manifestFilter.routes)})});d.resetAll=function(){_.clear(a.manifestFilter.routes);d.updateRoutePksInUrl()};d.updateRoutePksInUrl=function(){var b=a.urlForView(a.manifestFilter.view,{routes:a.manifestFilter.routes});e.navigate(b)}}]);h.directive("ngManifestRouteFilter",[function(){return{restrict:"A",scope:!0,templateUrl:"ng-manifest-route-filter",
controller:"manifest.RouteFilterCtrl",controllerAs:"routeFilterCtrl"}}]);h.controller("manifest.ItemFilterCtrl",["$scope","$q","$timeout","db","models","navigation","require",function(a,c,f,e,g,d,l){l.inScope(a,"manifestFilter","manifest.ItemFilterCtrl");l.inScope(a,"getSingleSelectedFilter","manifest.ItemFilterCtrl");var m=this,k=e.items.pickable({shortname:a.route.bindings.shortname},null,null,{"include-archived":"yes"});m.availabilitiesWithBookings=e.availabilities.manifestSelectable({shortname:a.route.bindings.shortname,
date:a.route.bindings.date});var h=function(){var b=_.fromTrueKeys(m.selectedAvailabilities,_.int);b.length&&(a.manifestFilter.items||(a.manifestFilter.items={}),_.forEach(k,function(c){var d=_.pluck(m.availabilitiesByItem[c.pk],"pk");0<_.intersection(b,d).length&&(a.manifestFilter.items[c.pk]=!0)}))},s=function(){m.allVisibleItems=[];m.archivedVisibleItems=[];m.unarchivedVisibleItems=[];_.forEach(k,function(a){if(m.showEmptyItems||m.availabilitiesByItem[a.pk])m.allVisibleItems.push(a),(a.isArchived?
m.archivedVisibleItems:m.unarchivedVisibleItems).push(a)})};m.toggleEmptyItems=function(){m.showEmptyItems=!m.showEmptyItems;s()};var p,r;m.promises=[k.$promise,m.availabilitiesWithBookings.$promise];c.all(m.promises).then(function(){m.availabilitiesByItem=_.groupBy(m.availabilitiesWithBookings,"item.pk");s();p=_.keyBy(k,"pk");r=_.keyBy(m.availabilitiesWithBookings,"pk");d.watch(a,function(c){a.manifestFilter.items=_.toTrueKeys(b(d.getPks("items"),p));m.selectedAvailabilities=_.toTrueKeys(b(d.getPks("availabilities"),
r));h();c=(c=a.getSingleSelectedFilter("items"))&&_.findWhere(k,{pk:c});m.currentItem=c;m.numItems=_.sum(a.manifestFilter.items)})});var t=function(){var b=a.urlForView(a.manifestFilter.view,{items:a.manifestFilter.items,availabilities:m.selectedAvailabilities});d.navigate(b)};m.updateUrl=function(){f(t)};m.resetAll=function(){_.clear(a.manifestFilter.items);_.clear(m.selectedAvailabilities);m.updateUrl()}}]);h.directive("ngManifestItemFilter",[function(){return{restrict:"A",scope:!0,templateUrl:"ng-manifest-item-filter",
controller:"manifest.ItemFilterCtrl",controllerAs:"itemFilterCtrl"}}]);h.controller("manifest.ResourceFilterCtrl",["$scope","navigation","require",function(a,c,f){f.inScope(a,"resources","manifest.RunFilterCtrl");f.inScope(a,"manifestFilter","manifest.RunFilterCtrl");f.inScope(a,"getSingleSelectedFilter","manifest.RunFilterCtrl");var e=this,g=_.keyBy(a.resources,"pk");c.watch(a,function(){a.manifestFilter.resources=_.toTrueKeys(b(c.getPks("resources"),g));var d;d=(d=a.getSingleSelectedFilter("resources"))&&
_.findWhere(a.resources,{pk:d});e.currentResource=d;e.numResources=_.sum(a.manifestFilter.resources)});e.updateResourcePksInUrl=function(){var b=a.urlForView(a.manifestFilter.view,{resources:a.manifestFilter.resources});c.navigate(b)};e.resetAll=function(){_.clear(a.manifestFilter.resources);e.updateResourcePksInUrl()}}]);h.directive("ngManifestResourceFilter",[function(){return{restrict:"A",scope:!0,templateUrl:"ng-manifest-resource-filter",controller:"manifest.ResourceFilterCtrl",controllerAs:"resourceFilterCtrl"}}])})();
angular.module("dashboard.shared",["dashboard.services","dashboard.controllers","dashboard.directives"]);angular.module("dashboard","dashboard.admin dashboard.bookings dashboard.embedGenerator dashboard.items dashboard.flows dashboard.resources dashboard.pricing dashboard.reports dashboard.settings dashboard.shared".split(" "));
(function(){var h=angular.module("dashboard.controllers",[]);h.controller("dashboard.IndexCtrl",["$scope","$injector","auth","controllers","db","flash","models","navigation","urls",function(a,b,f,e,g,d,l,m,k){a.defaultDashboardTab=function(){return a.company.isCharter||a.company.isAffiliate?f.permissions.can("viewBookingsSection",a.company)?a.company.$url(k.dashboard.bookings.index):f.permissions.can("viewManifestSection",a.company)?a.company.$url(k.dashboard.manifest.index):f.permissions.canList(l.Report,
a.company)?a.company.$url(k.dashboard.reports.index):a.company.$url(k.dashboard.settings.index):a.company.isAdmin?f.permissions.can("viewAdminSection",a.company)?a.company.$url(k.dashboard.admin.index):a.company.$url(k.dashboard.settings.index):a.company.$url(k.dashboard.settings.index)};a.company=g.company({shortname:a.route.bindings.shortname});return e.dataController(a,{promises:[a.company.$promise],successCallback:function(){m.updateCurrentCompany(a,a.company);var b=f.storage.get("smartwaiverBookingUri");
b&&(f.storage.del("smartwaiverBookingUri"),m.redirect(b))}})}]);h.controller("dashboard.HeaderCtrl",["$scope","controllers","require","urls",function(a,b,f,e){f.inScope(a,"company");return b.headerController(a,{companyFn:function(){return a.company}})}]);h.controller("dashboard.shared.ImageMediumEditableCtrl",["$scope","controllers","db","require","filepicker","flash",function(a,b,f,e,g,d){e.inScope(a,"images");e.inScope(a,"image");a.image.item?(f=f.item.image,e=function(){return{shortname:a.image.company.shortname,
itemPk:a.image.item.pk,imagePk:a.image.pk}}):(f=f.company.image,e=function(){return{shortname:a.image.company.shortname,imagePk:a.image.pk}});a=b.editController(a,{collectionKey:"images",elementKey:"image",modelKey:"editableImage",update:f.update,remove:f.remove,editCallback:function(){a.editableImage.crop=_.clone(a.image.crop)},submitCallback:function(){a.image.crop=a.editableImage.crop;a.editableImage.crop=_.stringifyJSON(a.editableImage.crop)},params:e});var l=function(b,c){var d={fit:"crop",crop:[a.editableImage.crop.x,
a.editableImage.crop.y,a.editableImage.crop.width,a.editableImage.crop.height],format:"jpg",quality:100};g.stat({url:a.editableImage.imageUrl},function(e){e.url=a.editableImage.imageUrl;g.convert(e,d,function(a){b(a.url)},function(a){c()})},function(a){c()})};a.submit=function(b){b.$submitting=!0;l(function(c){a.editableImage.crop.url=c;a.editCtrl.submit(b)},function(){b.$submitting=!1;d.error(T("Please try again"))})};return a}]);h.controller("dashboard.shared.UserEditableCtrl",["$scope","controllers",
"dashboard.shared.subscriptionsController","db","events","models","navigation","require","urls",function(a,b,f,e,g,d,l,m,k){m.inScope(a,"user","dashboard.shared.UserEditableCtrl");m.inScope(a,"users","dashboard.shared.UserEditableCtrl");m.inScope(a,"groups","dashboard.shared.UserEditableCtrl");m.inScope(a,"partnerGroups","dashboard.shared.UserEditableCtrl");m.inScope(a,"customCalendars","dashboard.shared.UserEditableCtrl");m.inScope(a,"customManifests","dashboard.shared.UserEditableCtrl");a.changingPassword=
!1;a.changePassword=function(){a.changingPassword=!0;a.editableUser.password="";a.editableUser.verifyPassword=""};a.cancelPassword=function(){a.changingPassword=!1;a.editableUser.password="";a.editableUser.verifyPassword=""};a=b.imageUploadController(a,{elementKey:"user",modelKey:"editableUser",resetAfterSubmit:!1});a=f(a,{modelKey:"editableUser",prefix:"subscriptions",company:a.user.company});a.isReloadNeeded=!1;var h=a.user.username;return b.editController(a,{collectionKey:"users",elementKey:"user",
modelKey:"editableUser",get:e.user,update:e.user.update,editCallback:function(){a.imageUploadCtrl.image.edit();var b=_.filter(a.user.subscriptions,function(a){return _.isNull(a.item)});a.subscriptionsCtrl.edit(b);a.editableUser.defaultCustomCalendar=a.user.defaultCustomCalendar?a.user.defaultCustomCalendar.pk:"";a.editableUser.defaultCustomManifest=a.user.defaultCustomManifest?a.user.defaultCustomManifest.pk:"";a.editableUser.group=a.user.group?a.user.group.pk:"";a.editableUser.partnerGroup=a.user.partnerGroup?
a.user.partnerGroup.pk:"";a.editableUser.adminGroup=a.user.company.isAdmin&&a.user.adminGroup?a.user.adminGroup.pk:"";a.editableUser.isWelcomeSendable=!1;a.editableUser.isInactive=a.user.isInactive?"deactivated":"activated"},submitCallback:function(){a.imageUploadCtrl.image.cancelCrop()},successCallback:function(){a.isReloadNeeded=h!==a.user.username;if(a.isReloadNeeded){var b=k.populate(k.dashboard.settings.permissions.user.settings,{shortname:a.user.company.shortname,username:a.user.username});
a.imageUploadCtrl.image.submit().finally(function(){l.navigate(b,null,!0)})}else a.imageUploadCtrl.image.submit(),a.cancelPassword(),g.broadcast("dashboard.shared.ActivitiesCtrl.refresh");g.broadcast("dashboard.shared.UserEditableCtrl.success")},cancelCallback:a.imageUploadCtrl.image.cancel,removeCallback:function(){l.navigate(a.user.company.$url(k.dashboard.settings.permissions.users))},params:function(){return{shortname:a.user.company.shortname,username:a.user.username}},editing:!0,skipResetAfterError:!0})}]);
h.controller("dashboard.shared.GroupOverrideEditableCtrl",["$scope","controllers","dashboard.shared.subscriptionsController","db","events","models","navigation","require","urls",function(a,b,f,e,g,d,l,m,k){m.inScope(a,"groupOverride","dashboard.shared.GroupOverrideEditableCtrl");b.editController(a,{collectionKey:"groupOverrides",elementKey:"groupOverride",modelKey:"editableGroupOverride",update:e.groupOverride.update,remove:e.groupOverride.remove,editCallback:function(){a.editableGroupOverride.group=
a.groupOverride.group?a.groupOverride.group.pk:""},successCallback:function(){g.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){l.navigate(a.groupOverride.$url(k.dashboard.settings.permissions.groupOverrides))},params:function(){return{shortname:a.groupOverride.company.shortname,groupOverridePk:a.groupOverride.pk}},editing:!0,skipResetAfterError:!0})}]);h.controller("dashboard.shared.CannedMessageEditableCtrl",["$scope","db","require","controllers","events","flash",
"navigation","urls",function(a,b,f,e,g,d,l,m){f.inScope(a,"cannedMessage");f.inScope(a,"cannedMessages");return e.editController(a,{collectionKey:"cannedMessages",elementKey:"cannedMessage",modelKey:"editableCannedMessage",update:b.cannedMessage.update,remove:b.cannedMessage.remove,editing:!0,params:function(){return{shortname:a.cannedMessage.company.shortname,cannedMessagePk:a.cannedMessage.pk}},successCallback:function(){g.broadcast("dashboard.shared.CannedMessageEditableCtrl.updated");g.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},
removeCallback:function(){d.success(T("Deleted canned message"));l.navigate(a.cannedMessage.company.$url(m.dashboard.settings.cannedMessages.index))}})}]);h.controller("dashboard.shared.TagGroupEditableCtrl",["$scope","controllers","db","flash","navigation","require","urls",function(a,b,f,e,g,d,l){d.inScope(a,"tagGroup","dashboard.shared.TagGroupEditableCtrl");d.inScope(a,"tagGroups","dashboard.shared.TagGroupEditableCtrl");b.editController(a,{collectionKey:"tagGroups",elementKey:"tagGroup",modelKey:"editableTagGroup",
update:f.tagGroup.update,remove:f.tagGroup.remove,params:function(){return{shortname:a.tagGroup.company.shortname,tagGroupPk:a.tagGroup.pk}},removeCallback:function(){e.success(interpolate(T("Deleted %(tagGroupName)s"),{tagGroupName:a.tagGroup.name}));g.navigate(a.tagGroup.company.$url(l.dashboard.settings.tagGroups.index))},refreshActivities:!0,editing:!0})}]);h.controller("dashboard.shared.TagEditableCtrl",["$scope","controllers","db","events","flash","navigation","require","urls",function(a,b,
f,e,g,d,l,m){l.inScope(a,"tag","dashboard.shared.TagEditableCtrl");return b.editController(a,{elementKey:"tag",modelKey:"editableTag",update:f.tag.update,remove:f.tag.remove,params:function(){return{shortname:a.tag.tagGroup.company.shortname,tagGroupPk:a.tag.tagGroup.pk,tagPk:a.tag.pk}},removeCallback:function(){g.success(interpolate(T("Deleted %(tagName)s"),{tagName:a.tag.name}));d.redirect(a.tag.tagGroup.$url(m.dashboard.settings.tagGroups.tagGroup.index))},refreshActivities:!0,editing:!0})}]);
h.controller("dashboard.shared.ObjectTagsCtrl",["$scope","controllers","db","models","require",function(a,b,f,e,g){g.inScope(a,"company","dashboard.shared.ObjectTagsCtrl");g.inScope(a,"object","dashboard.shared.ObjectTagsCtrl");a.tagGroups=f.tagGroups({shortname:e.Company.ADMIN_SHORTNAME});var d=f.objectTags({shortname:a.object.company.shortname,objectCls:a.object.cls,objectPk:a.object.pk});a.editableObjectTags={};var l=function(){_.forEach(a.tagGroups,function(b){_.forEach(b.tags,function(b){a.editableObjectTags["tag_"+
b.pk]=_.contains(d,b)})})};b.dataController(a,{promises:[d.$promise,a.tagGroups.$promise],successCallback:function(){b.editController(a,{modelKey:"editableObjectTags",update:f.objectTags.update,params:function(){return{shortname:a.object.company.shortname,objectCls:a.object.cls,objectPk:a.object.pk}},successCallback:function(a){_.overwrite(d,a)},editCallback:l,refreshActivities:!0,editing:!0})}})}]);h.controller("dashboard.shared.CustomerTypeEditableCtrl",["$scope","controllers","db","events","flash",
"navigation","require","urls",function(a,b,f,e,g,d,l,m){l.inScope(a,"customerType","dashboard.shared.CustomerTypeEditableCtrl");l.inScope(a,"customerTypes","dashboard.shared.CustomerTypeEditableCtrl");return b.editController(a,{collectionKey:"customerTypes",elementKey:"customerType",modelKey:"editableCustomerType",update:f.customerType.update,remove:f.customerType.remove,params:function(){return{shortname:a.customerType.company.shortname,customerTypePk:a.customerType.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},
removeCallback:function(){g.success(interpolate(T("Deleted %(customerTypeName)s"),{customerTypeName:a.customerType.plural}));d.navigate(a.customerType.company.$url(m.dashboard.settings.customerTypes.index))},editing:!0})}]);h.controller("dashboard.shared.CheckinStatusEditableCtrl",["$scope","db","require","controllers",function(a,b,f,e){f.inScope(a,"checkinStatus");f.inScope(a,"checkinStatuses");f.inScope(a,"updateStatuses");return e.editController(a,{collectionKey:"checkinStatuses",elementKey:"checkinStatus",
modelKey:"editableCheckinStatus",update:b.checkinStatus.update,remove:b.checkinStatus.remove,removeCallback:function(){a.updateStatuses()},params:function(){return{shortname:a.checkinStatus.company.shortname,checkinStatusPk:a.checkinStatus.pk}},flashAfterRemove:!0})}]);h.controller("dashboard.shared.CustomerCheckinStatusEditable",["$scope","checkin","controllers","db","events","flash","require",function(a,b,f,e,g,d,l){l.inScope(a,"company","dashboard.shared.CustomerCheckinStatusEditableCtrl");l.inScope(a,
"customer","dashboard.shared.CustomerCheckinStatusEditableCtrl");a.checkinStatuses||(a.checkinStatuses=e.checkinStatuses({shortname:a.customer.booking.company.shortname},null,null,null,{tagAlong:!0}));a.editableCustomer={checkinStatus:a.customer.checkinStatus?a.customer.checkinStatus.pk:"",currentCheckinStatus:a.customer.checkinStatus};f.dataController(a,{promises:[a.checkinStatuses.$promise],successCallback:function(){a.checkinStatusesForCustomer=b.checkinStatusOptions(a,{checkinStatuses:a.checkinStatuses,
currentCheckinStatus:a.editableCustomer.currentCheckinStatus,watchValue:"customer.checkinStatus"});a.$watch("customer.checkinStatus",function(b,c){b!==c&&(b&&!_.contains(a.checkinStatuses,b)&&a.checkinStatuses.push(b),a.editableCustomer.checkinStatus=b?b.pk:"",a.editableCustomer.currentCheckinStatus=b)});a.$watch("editableCustomer.currentCheckinStatus",function(e,f){e!==f&&a.customer.checkinStatus!==e&&b.updateCustomer(a.customer,e).then(_.ignore,function(){d.error(T("Unable to update customer check-in"))})})}})}]);
h.controller("dashboard.shared.DuplicateCustomFieldCtrl",["$scope","dashboard.shared.duplicatingController","db","events","flash","require",function(a,b,f,e,g,d){d.inScope(a,"customField","dashboard.shared.DuplicateCustomFieldCtrl");b(a,{endpoint:f.customField.duplicate,params:{customFieldPk:a.customField.pk,shortname:a.customField.company.shortname},successCallback:function(b){a.customField.name?g.success(interpolate(T("Duplicated %(customFieldName)s"),{customFieldName:a.customField.name})):g.success(T("Duplicated field"));
e.broadcast("dashboard.shared.CustomFieldEditableCtrl.duplicated",{customField:b})}})}]);h.controller("dashboard.shared.CustomFieldEditableCtrl",["$scope","controllers","convert","db","events","models","navigation","require","toggles",function(a,b,f,e,g,d,l,m,k){m.inScope(a,"customField","dashboard.shared.CustomFieldEditableCtrl");m.inScope(a,"customFields","dashboard.shared.CustomFieldEditableCtrl");a.toggleValue="editCustomField-"+a.$id;g.on(a,"dashboard.shared.ExtendedOptionEditableCtrl.updated",
function(){g.broadcast("dashboard.shared.CustomFieldEditableCtrl.updated",{customField:a.customField})});a.$watch("customField.defaultValue",function(){a.editableCustomField.defaultValue=a.customField.defaultValue;a.editableCustomField.isDefaulted=!!a.customField.defaultValue});a.storedValueTypes=e.storedValueTypes({shortname:a.customField.company.shortname});a.editableCustomFieldOptions={};b.editController(a,{elementKey:"customField",modelKey:"editableCustomField",update:e.customField.update,params:function(){return{shortname:a.customField.company.shortname,
customFieldPk:a.customField.pk}},editCallback:function(){a.customField.type===d.CustomField.MULTI_CAMPAIGN_TYPE&&(a.editableCustomField.isCodeInputHiddenByDefault=!a.editableCustomField.isCodeInputShownByDefault);a.customField.type===d.CustomField.CARD_GENERATOR_TYPE&&(a.editableCustomField.storedValueType=a.customField.storedValueType.pk);a.editableCustomField.isDefaulted=null!==a.customField.defaultValue;a.editableCustomField.isDefaulted&&(a.editableCustomField.value=a.customField.defaultValue)},
submitCallback:function(){var b={isPricingHidden:a.editableCustomField.isPricingHidden,isLodgingRoomNumberHidden:a.editableCustomField.isLodgingRoomNumberHidden};a.customField.type===d.CustomField.COUNT_TYPE?_.extend(b,{min:a.editableCustomField.countMin,max:a.editableCustomField.countMax}):a.customField.type===d.CustomField.CARD_GENERATOR_TYPE?_.extend(b,{cardSuggestedAmount:a.editableCustomField.cardSuggestedAmount}):a.customField.type===d.CustomField.MULTI_CAMPAIGN_TYPE&&_.extend(b,{isCodeInputShownByDefault:!a.editableCustomField.isCodeInputHiddenByDefault,
codeToggleText:a.editableCustomField.codeToggleText});a.editableCustomField.parameters=_.stringifyJSON(f.clientRequest(b))},successCallback:function(){g.broadcast("dashboard.shared.ActivitiesCtrl.refresh");g.broadcast("dashboard.shared.CustomFieldEditableCtrl.updated",{customField:a.customField});k.toggle(a.toggleValue,!1)},cancelCallback:function(){k.toggle(a.toggleValue,!1)},editing:!0})}]);h.controller("dashboard.shared.CustomFieldInstanceEditableCtrl",["$scope","controllers","db","events","models",
"require",function(a,b,f,e,g,d){d.inScope(a,"customFieldInstance","dashboard.shared.CustomFieldInstanceEditableCtrl");a.editableCustomFieldInstanceOptions={};b.editController(a,{elementKey:"customFieldInstance",modelKey:"editableCustomFieldInstance",update:f.customFieldInstance.update,params:function(){return{shortname:a.customFieldInstance.company.shortname,itemPk:a.customFieldInstance.item.pk,customFieldInstancePk:a.customFieldInstance.pk}},editCallback:function(){a.editableCustomFieldInstance.customerPrototype=
a.customFieldInstance.customerPrototype?a.customFieldInstance.customerPrototype.pk:"";a.editableCustomFieldInstance.customFieldInstanceGroup=a.customFieldInstance.customFieldInstanceGroup?a.customFieldInstance.customFieldInstanceGroup.pk:"";a.editableCustomFieldInstance.customField=a.customFieldInstance.customField.pk;a.editableCustomFieldInstance.parent=a.customFieldInstance.parent?a.customFieldInstance.parent.pk:"";a.editableCustomFieldInstance.isDefaulted=null!==a.customFieldInstance.defaultValue;
a.editableCustomFieldInstance.isDefaulted&&(a.editableCustomFieldInstance.value=a.customFieldInstance.defaultValue)},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");e.broadcast("dashboard.shared.CustomFieldInstanceEditableCtrl.updated",{customFieldInstance:a.customFieldInstance})},removeCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}});a.$watch("editableCustomFieldInstance.isDefaulted",function(b,c){!_.isUndefined(c)&&!b&&delete a.editableCustomFieldInstance.value})}]);
h.controller("dashboard.shared.CustomFieldInstanceConditionsCtrl",["$scope","controllers","db","events","models","require",function(a,b,f,e,g,d){d.inScope(a,"customFieldInstance","dashboard.shared.CustomFieldInstanceConditionsCtrl");d.inScope(a,"customFieldInstances","dashboard.shared.CustomFieldInstanceConditionsCtrl");a.$watch("customFieldInstance.customFieldInstanceConditions",function(b){a.customFieldInstanceConditions=b});a.parentCustomFieldInstances=_.filter(a.customFieldInstances,function(b){return b!==
a.customFieldInstance&&g.CustomFieldInstanceCondition.isValidParent(b)});a.newCustomFieldInstanceCondition={};a.$watch("newCustomFieldInstanceCondition.parentCustomFieldInstance",function(){a.newCustomFieldInstanceCondition.type=g.CustomFieldInstanceCondition.SELECTED_TYPE;delete a.newCustomFieldInstanceCondition.value});b.listController(a,{collectionKey:"customFieldInstanceConditions",elementKey:"customFieldInstanceCondition",modelKey:"newCustomFieldInstanceCondition",create:f.customFieldInstanceConditions.create,
params:function(){return{shortname:a.customFieldInstance.company.shortname,itemPk:a.customFieldInstance.item.pk,customFieldInstancePk:a.customFieldInstance.pk}},defaultModel:{parentCustomFieldInstance:"",type:g.CustomFieldInstanceCondition.SELECTED_TYPE},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},submitCallback:function(){var b;a.newCustomFieldInstanceCondition.type===g.CustomFieldInstanceCondition.RANGE_TYPE&&(b={"properties-range_start":a.newCustomFieldInstanceCondition.rangeStart,
"properties-range_end":a.newCustomFieldInstanceCondition.rangeEnd});delete a.newCustomFieldInstanceCondition.rangeStart;delete a.newCustomFieldInstanceCondition.rangeEnd;return b}})}]);h.controller("dashboard.shared.CustomFieldInstanceConditionEditableCtrl",["$scope","controllers","db","events","models","require",function(a,b,f,e,g,d){d.inScope(a,"customFieldInstanceCondition","dashboard.shared.CustomFieldInstanceConditionEditableCtrl");d.inScope(a,"customFieldInstanceConditions","dashboard.shared.CustomFieldInstanceConditionEditableCtrl");
d.inScope(a,"parentCustomFieldInstances","dashboard.shared.CustomFieldInstanceConditionEditableCtrl");a.isUnmeetable=!1;_.contains(a.parentCustomFieldInstances,a.customFieldInstanceCondition.parentCustomFieldInstance)?_.contains([g.CustomFieldInstanceCondition.EXACT_TYPE,g.CustomFieldInstanceCondition.RANGE_TYPE],a.customFieldInstanceCondition.type)&&(a.isUnmeetable=!g.CustomField.isValidRawValue(a.customFieldInstanceCondition.parentCustomFieldInstance.customField,g.CustomFieldInstanceCondition.rawValue(a.customFieldInstanceCondition),
a.customFieldInstanceCondition.type)):a.isUnmeetable=!0;a.editableCustomFieldInstanceCondition={};a.editableCustomFieldInstanceConditionOptions={};a.$watch("editableCustomFieldInstanceCondition.parentCustomFieldInstance",function(b,c){_.isUndefined(c)||(a.editableCustomFieldInstanceCondition.type=g.CustomFieldInstanceCondition.SELECTED_TYPE,delete a.editableCustomFieldInstanceCondition.value)});b.editController(a,{collectionKey:"customFieldInstanceConditions",elementKey:"customFieldInstanceCondition",
modelKey:"editableCustomFieldInstanceCondition",update:f.customFieldInstanceCondition.update,remove:f.customFieldInstanceCondition.remove,params:function(){return{shortname:a.customFieldInstance.company.shortname,itemPk:a.customFieldInstance.item.pk,customFieldInstancePk:a.customFieldInstance.pk,customFieldInstanceConditionPk:a.customFieldInstanceCondition.pk}},editCallback:function(){a.editableCustomFieldInstanceCondition.parentCustomFieldInstance=a.customFieldInstanceCondition.parentCustomFieldInstance.pk;
a.editableCustomFieldInstanceCondition.value=a.customFieldInstanceCondition.exactValue;a.editableCustomFieldInstanceCondition.properties=a.customFieldInstanceCondition.properties},submitCallback:function(){var b;a.editableCustomFieldInstanceCondition.type===g.CustomFieldInstanceCondition.RANGE_TYPE&&(b={"properties-range_start":a.editableCustomFieldInstanceCondition.rangeStart,"properties-range_end":a.editableCustomFieldInstanceCondition.rangeEnd});delete a.editableCustomFieldInstanceCondition.rangeStart;
delete a.editableCustomFieldInstanceCondition.rangeEnd;delete a.editableCustomFieldInstanceCondition.properties;return b},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}})}]);h.controller("dashboard.shared.TransportationOptionMediumEditableCtrl",["$scope","db","events","require","controllers",function(a,b,f,e,g){e.inScope(a,"transportationOption");e.inScope(a,"transportationOptions");return g.editController(a,{collectionKey:"transportationOptions",elementKey:"transportationOption",
modelKey:"editableTransportationOption",update:b.transportationOption.update,remove:b.transportationOption.remove,params:function(){return{shortname:a.transportationOption.company.shortname,customFieldPk:a.transportationOption.customField.pk,transportationOptionPk:a.transportationOption.pk}},successCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}})}]);h.controller("dashboard.shared.ExtendedOptionEditableCtrl",["$scope","db","events","require","controllers",function(a,b,
f,e,g){e.inScope(a,"extendedOption");e.inScope(a,"extendedOptions");return g.editController(a,{collectionKey:"extendedOptions",elementKey:"extendedOption",modelKey:"editableExtendedOption",update:b.extendedOption.update,remove:b.extendedOption.remove,params:function(){return{shortname:a.extendedOption.company.shortname,customFieldPk:a.extendedOption.customField.pk,extendedOptionPk:a.extendedOption.pk}},successCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh");f.broadcast("dashboard.shared.ExtendedOptionEditableCtrl.updated")}})}]);
h.controller("dashboard.shared.ConnectedCampaignRemoveableCtrl",["$scope","controllers","db","events","require",function(a,b,f,e,g){g.inScope(a,"connectedCampaigns","dashboard.shared.ConnectedCampaignRemoveableCtrl");g.inScope(a,"connectedCampaign","dashboard.shared.ConnectedCampaignRemoveableCtrl");return b.removeController(a,{collectionKey:"connectedCampaigns",elementKey:"connectedCampaign",remove:f.connectedCampaign.remove,params:function(){return{shortname:a.connectedCampaign.company.shortname,
customFieldPk:a.connectedCampaign.customField.pk,connectedCampaignPk:a.connectedCampaign.pk}},removeCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}})}]);h.controller("dashboard.shared.GeneratingCampaignEditableCtrl",["$scope","controllers","db","events","require",function(a,b,f,e,g){g.inScope(a,"generatingCampaigns","dashboard.shared.GeneratingCampaignEditableCtrl");g.inScope(a,"generatingCampaign","dashboard.shared.GeneratingCampaignEditableCtrl");return b.editController(a,
{collectionKey:"generatingCampaigns",elementKey:"generatingCampaign",modelKey:"editableGeneratingCampaign",update:f.generatingCampaign.update,remove:f.generatingCampaign.remove,params:function(){return{shortname:a.generatingCampaign.company.shortname,customFieldPk:a.generatingCampaign.customField.pk,generatingCampaignPk:a.generatingCampaign.pk}},editCallback:function(){a.editableGeneratingCampaign.campaign=a.generatingCampaign.campaign.pk},removeCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}})}]);
h.controller("dashboard.shared.ItemMediumCtrl",["$scope","require",function(a,b){b.inScope(a,"item","dashboard.shared.ItemMediumCtrl");return a}]);h.controller("dashboard.shared.ItemColorEditableCtrl",["$scope","controllers","db","events","require",function(a,b,f,e,g){g.inScope(a,"item","dashboard.shared.ItemColorEditableCtrl");b.editController(a,{elementKey:"item",modelKey:"editableItem",update:f.item.color,params:function(){return{shortname:a.item.company.shortname,itemPk:a.item.pk}},successCallback:function(){e.broadcast("lib.shared.CalendarCtrl.refresh");
e.broadcast("dashboard.shared.ItemColorEditableCtrl.updated")},modelFields:["color"]})}]);h.controller("dashboard.shared.ItemEditableCtrl",["$scope","auth","controllers","db","models","navigation","require","urls",function(a,b,f,e,g,d,l,m){l.inScope(a,"item","dashboard.shared.ItemEditableCtrl");var k=a.item.company;a.currentOptions={};a=f.imageUploadController(a,{elementKey:"item",modelKey:"editableItem",resetAfterSubmit:!1});a.bookingRestrictions=e.bookingRestrictions({shortname:k.shortname});a.cannedMessages=
e.cannedMessages({shortname:k.shortname});a.locations=e.locations({shortname:k.shortname});k.features.isCancellationPoliciesEnabled&&b.permissions.canList(g.CancellationPolicy,k)?a.cancellationPolicies=e.cancellationPolicies({shortname:d.currentCompany.shortname}):a.cancellationPolicies=[];a.$watch("currentOptions.bookingRestriction",function(b){b&&b.pk&&_.forEach(g.BookingRestriction.RESTRICTION_FIELDS,function(c){a.editableItem[c]=b[c]})});a.currentSmsMessage=function(){return _.find(a.smsCannedMessages,
"pk",a.editableItem.smsReminderCannedMessage)};return f.dataController(a,{promises:[a.cannedMessages.$promise,a.cancellationPolicies.$promise,a.bookingRestrictions.$promise,a.locations.$promise],successCallback:function(){a.bookingRestrictions.length&&(a.bookingRestrictions=_.union([{pk:null,name:T("Custom settings:")}],a.bookingRestrictions));a.emailCannedMessages=_.filter(a.cannedMessages,"message");var b=_.filter(a.cannedMessages,"smsMessage");b.push({pk:-1,name:T("Custom"),type:g.CannedMessage.CUSTOM_TYPE,
displayType:T("Other")});a.smsCannedMessages=b;f.editController(a,{elementKey:"item",modelKey:"editableItem",update:e.item.update,remove:e.item.remove,editCallback:function(){a.editableItem.cancellationPolicy=_.getDotted(a.item,"cancellationPolicy.pk",null);a.editableItem.confirmationMessage=_.getDotted(a.item,"confirmationMessage.pk",null);a.editableItem.followUpMessage=_.getDotted(a.item,"followUpMessage.pk",null);a.editableItem.reminderMessage=_.getDotted(a.item,"reminderMessage.pk",null);a.editableItem.smsReminderCannedMessage=
_.getDotted(a.item,"smsReminderCannedMessage.pk",null);a.editableItem.smsReminderMessage&&null==a.editableItem.smsReminderCannedMessage&&(a.editableItem.smsReminderCannedMessage=-1);a.editableItem.preCheckoutFlowNode=_.getDotted(a.item,"preCheckoutFlowNode.pk",null);a.editableItem.postCheckoutFlowNode=_.getDotted(a.item,"postCheckoutFlowNode.pk",null);a.editableItem.preLocation=_.getDotted(a.item,"preLocation.pk",null);a.editableItem.primaryLocation=_.getDotted(a.item,"primaryLocation.pk",null);a.editableItem.startLocation=
_.getDotted(a.item,"startLocation.pk",null);a.editableItem.endLocation=_.getDotted(a.item,"endLocation.pk",null);a.editableItem.bookingRestriction=_.getDotted(a.item,"bookingRestriction.pk",null);_.extendWithPrefix("settings-",a.editableItem,a.item.settings);a.imageUploadCtrl.image.edit();a.item.isCustomPrimaryLocation||(a.editableItem.primaryLocation="default")},submitCallback:function(){"default"===a.editableItem.primaryLocation&&(a.editableItem.primaryLocation=null);var b=a.currentSmsMessage();
return b?b.type===g.CannedMessage.CUSTOM_TYPE?{smsReminderCannedMessage:null}:{smsReminderMessage:null}:{smsReminderCannedMessage:null,smsReminderMessage:null}},successCallback:a.imageUploadCtrl.image.submit,cancelCallback:a.imageUploadCtrl.image.cancel,removeCallback:function(){d.navigate(a.item.company.$url(m.dashboard.items.index))},params:function(){return{shortname:a.item.company.shortname,itemPk:a.item.pk}},editing:!0});var c=null;a.$watch("editableItem.isArchived",function(){a.editableItem.isArchived?
(c=a.editableItem.isPrivate,a.editableItem.isPrivate=!0):null!==c&&(a.editableItem.isPrivate=c)});a.primaryLocationOptions=[{pk:"default",name:T("Company default")+" ("+((k.defaultItemPrimaryLocation||{}).name||T("None selected"))+")",$url:function(){return k.$url(m.dashboard.settings.locations.settings)}}].concat(a.locations);a.$watch("editableItem.primaryLocation",function(b){a.editableItem.isCustomPrimaryLocation="default"!==b})}})}]);h.controller("dashboard.shared.DuplicateItemCtrl",["$scope",
"dashboard.shared.duplicatingController","db","events","flash","navigation","urls","require",function(a,b,f,e,g,d,l,m){m.inScope(a,"item","dashboard.shared.DuplicateItemCtrl");b(a,{endpoint:f.item.duplicate,params:{itemPk:a.item.pk,shortname:a.item.company.shortname},successCallback:function(b){b=l.populate(l.dashboard.items.item.index,{shortname:a.item.company.shortname,itemPk:b});d.navigate(b)}})}]);h.controller("dashboard.shared.CompanyEditableCtrl",["$scope","$timeout","$q","auth","controllers",
"db","flash","models","navigation","processors","require","urls",function(a,b,f,e,g,d,l,m,k,h,s,p){s.inScope(a,"company");e.permissions.canAdminUpdate(a.company)&&(a.users=d.users({shortname:m.Company.ADMIN_SHORTNAME}));a.pricingPromises=[];var r,t;e.permissions.canCreate(m.TotalSheet,a.company)&&(r=d.totalSheets.nonBase({shortname:a.company.shortname}),a.pricingPromises.push(r.$promise));e.permissions.canCreate(m.TotalSchedule,a.company)&&(t=d.totalSchedules({shortname:a.company.shortname}),a.pricingPromises.push(t.$promise));
a.pricingPromises.length&&f.all(a.pricingPromises).then(function(){var b=m.TotalSheet.onlineSheets(r),c=_.filter(t,m.TotalSchedule.isOnlineFallback);a.onlineSheetsAndSchedules=_.append(b,c);a.directSheetsAndSchedules=_.append(r,t)});var v=!1,y=!1,q=!1;a.options={};a.options.isTaxIncludedEnabled=null!==a.company.features.includedTaxRate;a.supportedDashboardBookingsViews=m.Company.dashboardBookingsViewChoices(!0);a.supportedCurrencyChoices=[];return g.editController(a,{collectionKey:"companies",elementKey:"company",
modelKey:"editableCompany",update:d.company.update,remove:d.company.remove,editCallback:function(){a.editableCompany.processingFeeRate=a.company.processingFeePercentage;a.editableCompany.percentageFeeRate=a.company.percentageFeePercentage;a.editableCompany.tieredFeeSchedule=_.stringifyJSON(a.company.tieredFeeSchedule);a.editableCompany.invoiceFeeRate=a.company.invoiceFeePercentage;a.editableCompany.invoiceFlatFee=a.company.invoiceFlatFee;a.editableCompany.salesperson=a.company.salesperson?a.company.salesperson.pk:
"";a.editableCompany.defaultOnlineTotalSheetOrSchedule=a.company.defaultOnlineTotalSheet?a.company.defaultOnlineTotalSheet.uri:a.company.defaultOnlineTotalSchedule.uri;a.editableCompany.defaultDirectTotalSheetOrSchedule=a.company.defaultDirectTotalSheet?a.company.defaultDirectTotalSheet.uri:a.company.defaultDirectTotalSchedule.uri;_.extendWithPrefix("features-",a.editableCompany,a.company.features);_.extendWithPrefix("companyFeatures-",a.editableCompany,a.company.companyFeatures);a.editableCompany["features-includedTaxRate"]=
a.company.includedTaxPercentage;a.editableCompany["features-idealProcessingFeeRate"]=a.company.idealProcessingFeePercentage;a.editableCompany["features-sofortProcessingFeeRate"]=a.company.sofortProcessingFeePercentage;a.editableCompany["companyFeatures-refundReserveRecurringTransferRate"]=a.company.refundReserveRecurringTransferPercentage;a.$watch("editableCompany['features-isDayViewEnabled']",function(b){a.supportedDashboardBookingsViews=m.Company.dashboardBookingsViewChoices(b);a.editableCompany.defaultDashboardBookingsView===
m.Company.DAY_VIEW&&(a.editableCompany.defaultDashboardBookingsView=m.Company.GRID_VIEW)});a.$watch("options.isTaxIncludedEnabled",function(b){b?null===a.editableCompany["features-includedTaxRate"]&&(b=m.Company.DEFAULT_INCLUDED_TAX_PERCENTAGE_BY_COUNTRY[a.editableCompany.processorCountry],_.isUndefined(b)||(a.editableCompany["features-includedTaxRate"]=b)):a.editableCompany["features-includedTaxRate"]=null});a.$watch("editableCompany.processorCountry",function(b,c){if(b){var d=h.supportedCurrencies(h.DEFAULT_PROCESSOR_TYPE,
a.editableCompany.processorCountry),d=m.Company.getCurrencyChoices(d);_.overwrite(a.supportedCurrencyChoices,d);d=_.map(a.supportedCurrencyChoices,function(a){return a[0]});_.contains(d,a.editableCompany.processorCurrency)||(a.editableCompany.processorCurrency=1===a.supportedCurrencyChoices.length?a.supportedCurrencyChoices[0][0]:"");b!==c&&(a.editableCompany["features-isScaEnabled"]=_.contains(m.Company.SCA_REQUIRED_PROCESSOR_COUNTRIES,a.editableCompany.processorCountry))}});a.$watch("editableCompany['features-isCombinedTaxEnabled']",
function(b){b&&(a.editableCompany["features-isExtendedBreakdownEnabled"]=!1)});a.$watch("editableCompany['features-isExtendedBreakdownEnabled']",function(b){b||(a.editableCompany["features-isOnlineBookFormTaxTypesEnabled"]=!1)})},submitCallback:function(){v=a.company.isDemoModeEnabled&&!a.editableCompany.isDemoModeEnabled;y=a.company.shortname!==a.editableCompany.shortname;q=!a.company.companyFeatures.isContentTranslationEnabled&&a.editableCompany["companyFeatures-isContentTranslationEnabled"]},successCallback:function(e){v&&
!a.company.isDemoModeEnabled&&l.success("<b>"+T("Disabling demo mode.")+"</b> "+T("This could take a while. You may keep using FareHarbor during this time."));y&&(l.info("<b>"+T("Changing shortname.")+"</b> "+T("Please wait...")),b(function(){delete e.$urls;delete e.$params;var a=e.$url(p.dashboard.settings.index);k.navigate(a,"replace",!0)},2E3));q&&d.supportedLanguages({shortname:a.company.shortname})},removeCallback:function(){k.navigate(e.currentUser.$url(p.dashboard.index))},cancelCallback:function(){a.options.searchTerm=
""},params:function(){return{shortname:a.company.shortname}},editing:!0})}]);h.controller("dashboard.shared.CompanyRecurringTransferEditableCtrl",["$scope","controllers","db","flash","models","require",function(a,b,f,e,g,d){d.inScope(a,"company","dashboard.shared.CompanyRecurringTransferEditableCtrl");var l=!0,m={};a.isProjectedRefundReserveRecurringTransferAmountLoaded=!1;return b.editController(a,{collectionKey:"companies",elementKey:"company",modelKey:"editableCompany",update:f.company.refundReserve.update,
editCallback:function(){if(l){_.forEach(a.company.companyFeatures,function(b,c){a.editableCompany["companyFeatures-"+c]=b});a.editableCompany["companyFeatures-refundReserveRecurringTransferRate"]=a.company.refundReserveRecurringTransferPercentage;a.editableCompany.refundReserve=a.company.companyFeatures.isRefundReserveRecurringTransferEnabled?"on":"off";var b=f.slipstream("currencies")[a.company.processorCurrency];a.transferTypeChoices=[[g.Company.REFUND_RESERVE_PERCENT_FORMAT,"%"],[g.Company.REFUND_RESERVE_AMOUNT_FORMAT,
b?b.symbol:"$"]]}else a.editableCompany=m},submitCallback:function(){m=a.editableCompany},successCallback:function(){e.success(T("Updated recurring transfer"));l=!0;a.actionsCtrl.reset();f.upcomingRefundReserveAmount({shortname:a.route.bindings.shortname}).$promise.then(function(b){a.company.projectedUpcomingRefundReserveRecurrentTransferAmount=b.data.upcomingRefundReserveAmount;a.isProjectedRefundReserveRecurringTransferAmountLoaded=!0})},errorCallback:function(){e.error(T("Error updating recurring transfer"));
l=!1},params:function(){return{shortname:a.company.shortname}},editing:!0,refreshActivities:!0,defaultModel:{"companyFeatures-refundReserve":a.company.companyFeatures.refundReserveRecurringTransferStatus?"on":"off"}})}]);h.controller("dashboard.shared.CompanyProfileEditableCtrl",["$scope","db","require","controllers",function(a,b,f,e){f.inScope(a,"company","dashboard.shared.CompanyProfileEditableCtrl");a.locations=b.locations({shortname:a.company.shortname});return e.editController(a,{elementKey:"company",
modelKey:"editableCompanyProfile",update:b.company.profile.update,params:function(){return{shortname:a.company.shortname}},editCallback:function(){a.editableCompanyProfile.preCheckoutFlowNode=_.get(a.company,"preCheckoutFlowNode.pk",null);a.editableCompanyProfile.postCheckoutFlowNode=_.get(a.company,"postCheckoutFlowNode.pk",null);a.editableCompanyProfile.primaryLocation=_.get(a.company,"primaryLocation.pk",null);a.editableCompanyProfile.defaultItemPrimaryLocation=_.get(a.company,"defaultItemPrimaryLocation.pk",
null)},editing:!0,refreshActivities:!0})}]);h.controller("dashboard.shared.CompanyContactInformationEditableCtrl",["$scope","db","require","controllers",function(a,b,f,e){f.inScope(a,"company");a=e.imageUploadController(a,{id:"logo",elementKey:"company",modelKey:"editableCompanyContactInformation"});a=e.imageUploadController(a,{id:"email",elementKey:"company",modelKey:"editableCompanyContactInformation",field:"imageEmailUrl"});return e.editController(a,{elementKey:"company",modelKey:"editableCompanyContactInformation",
update:b.company.contactInformation.update,editCallback:function(){a.imageUploadCtrl.logo.edit();a.imageUploadCtrl.email.edit()},submitCallback:function(){a.imageUploadCtrl.logo.submit();a.imageUploadCtrl.email.submit()},cancelCallback:function(){a.imageUploadCtrl.logo.cancel();a.imageUploadCtrl.email.cancel()},params:function(){return{shortname:a.company.shortname}},editing:!0,skipResetAfterError:!0})}]);h.controller("dashboard.shared.CompanyTaxInformationEditableCtrl",["$scope","db","events","models",
"processors","require","controllers",function(a,b,f,e,g,d,l){d.inScope(a,"company");var m=function(b){var c;b&&(a.editableCompanyTaxInformation.billingCountry=a.company.processorCountry,a.editableCompanyTaxInformation.personalCountry=a.company.processorCountry,b=g.verificationRequirements(a.editableCompanyTaxInformation.processorType,a.company.processorCountry,a.editableCompanyTaxInformation.entityType),c=g.requiredVerificationFields(a.editableCompanyTaxInformation.processorType,b));a.requiredFields=
c},k=function(){a.additionalOwnersCountRange=_.range(a.editableCompanyTaxInformation.additionalOwnersCount)};a.isTooYoung=function(){if(!a.editableCompanyTaxInformation.birthDate)return!1;var b=moment(a.editableCompanyTaxInformation.birthDate,"YYYY-MM-DD");return!b.isValid()?!0:18>moment().diff(b,"years")};return l.editController(a,{elementKey:"company",modelKey:"editableCompanyTaxInformation",update:b.company.taxInformation.update,editCallback:function(){a.editableCompanyTaxInformation.processorType=
g.DEFAULT_PROCESSOR_TYPE;a.editableCompanyTaxInformation.entityType||(a.editableCompanyTaxInformation.entityType=g.COMPANY_ENTITY_TYPE);m();a.$watch("editableCompanyTaxInformation.entityType",m);a.$watch("editableCompanyTaxInformation.additionalOwnersCount",k)},successCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},params:function(){return{shortname:a.company.shortname}},skipResetAfterError:!0})}]);h.controller("dashboard.shared.CompanyExtendedTaxInformationEditableCtrl",
["$scope","db","events","models","processors","require","controllers",function(a,b,f,e,g,d,l){d.inScope(a,"company");return l.editController(a,{elementKey:"company",modelKey:"editableCompanyExtendedTaxInformation",update:b.company.extendedTaxInformation.update,editCallback:function(){a.editableCompanyExtendedTaxInformation.processorType=g.DEFAULT_PROCESSOR_TYPE},successCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},params:function(){return{shortname:a.company.shortname}},
skipResetAfterError:!0})}]);h.controller("dashboard.shared.CompanyTosAcceptanceEditableCtrl",["$scope","db","events","models","processors","require","controllers",function(a,b,f,e,g,d,l){d.inScope(a,"company");return l.editController(a,{elementKey:"company",modelKey:"editableCompanyTosAcceptance",update:b.company.tosAcceptance.update,editCallback:function(){a.editableCompanyTosAcceptance.processorType=g.DEFAULT_PROCESSOR_TYPE},successCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},
params:function(){return{shortname:a.company.shortname}},skipResetAfterError:!0})}]);h.controller("dashboard.shared.CompanyStylesEditableCtrl",["$scope","db","require","controllers",function(a,b,f,e){f.inScope(a,"company");a=e.imageUploadController(a,{id:"background",elementKey:"company",modelKey:"editableCompanyStyles",field:"imageBackgroundUrl",width:5E3,height:5E3});return e.editController(a,{collectionKey:"companies",elementKey:"company",modelKey:"editableCompanyStyles",update:b.company.styles.update,
editCallback:a.imageUploadCtrl.background.edit,successCallback:a.imageUploadCtrl.background.submit,cancelCallback:a.imageUploadCtrl.background.cancel,params:function(){return{shortname:a.company.shortname}},editing:!0})}]);h.controller("dashboard.shared.CompanySlideshowEditableCtrl",["$scope","controllers","db","models","require",function(a,b,f,e,g){g.inScope(a,"company");a.images=f.company.images({shortname:a.company.shortname});return b.dataController(a,{promises:[a.images.$promise],successCallback:function(){b.imageUploadController(a,
{modelKey:"newImage"});b.listController(a,{collectionKey:"images",modelKey:"newImage",create:f.company.images.create,params:function(){return{shortname:a.company.shortname}},successCallback:a.imageUploadCtrl.image.submit,defaultModel:{gallery:e.Image.CAROUSEL_GALLERY},sortable:!0})}})}]);h.controller("dashboard.shared.CompanyPaymentsEditableCtrl",["$scope","db","events","require","controllers",function(a,b,f,e,g){e.inScope(a,"company");return a=g.editController(a,{elementKey:"company",modelKey:"editableCompanyPayments",
update:b.company.payments.update,params:function(){return{shortname:a.company.shortname}},successCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}})}]);h.controller("dashboard.shared.InStorePaymentTypeEditableCtrl",["$scope","db","require","controllers","events",function(a,b,f,e,g){f.inScope(a,"inStorePaymentType");f.inScope(a,"inStorePaymentTypes");return e.editController(a,{collectionKey:"inStorePaymentTypes",elementKey:"inStorePaymentType",modelKey:"editableInStorePaymentType",
update:b.inStorePaymentType.update,remove:b.inStorePaymentType.remove,params:function(){return{shortname:a.inStorePaymentType.company.shortname,inStorePaymentTypePk:a.inStorePaymentType.pk}},editCallback:function(){a.editableInStorePaymentType.isInStorePaymentNoteRequired=!!a.inStorePaymentType.noteLabel},refreshActivities:!0})}]);h.controller("dashboard.shared.EmvDeviceEditableCtrl",["$scope","db","events","models","require","controllers","flash","emv",function(a,b,f,e,g,d,l,m){g.inScope(a,"discoveredEmvDevice",
"dashboard.shared.EmvDeviceEditableCtrl");g.inScope(a,"discoveredEmvDevices","dashboard.shared.EmvDeviceEditableCtrl");var k=T("Unable to connect due to network issue. Please ensure your browser and device both have stable connections."),h=T("Unable to connect to device"),s=T("Unable to connect, reader is currently in use in another browser window.");a.selectThisDevice=function(){m?(a.discoveredEmvDevice.$submitting=!0,m.selectDevice(a.discoveredEmvDevice).then(function(){a.editCtrl.editing=!1;a.discoveredEmvDevice.$submitting=
!1;f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},function(b){a.discoveredEmvDevice.$submitting=!1;console.warn("Unable to connect to device:",b);b&&b.code===e.EmvDevice.CONNECT_READER_ERROR_CODE?b.message===e.EmvDevice.READER_IN_USE_ERROR_MESSAGE?l.error(s):l.error(k):l.error(h);a.$apply()})):(console.warn("Unable to connect to device: Emv not loaded."),l.error(h))};return d.editController(a,{elementKey:"emvDevice",modelKey:"editableEmvDevice",update:b.emvDevice.update,remove:b.emvDevice.remove,
params:function(){return{shortname:a.emvDevice.company.shortname,emvDevicePk:a.emvDevice.pk}},removeCallback:function(){m.discoverEmvDevices(a.company).then(function(b){_.overwrite(a.discoveredEmvDevices,b)})},refreshActivities:!0})}]);h.controller("dashboard.shared.AvailabilitySmallCtrl",["$scope","require",function(a,b){b.inScope(a,"availability","dashboard.shared.AvailabilitySmallCtrl");return a}]);var b=function(a,b){return h.controller(a,["$scope","controllers","db","events","require","controllers",
function(f,e,g,d,l){l.inScope(f,"availability",a);if(!f.availability.customerTypeRates||!f.availability.blocks)f.availability=g.availability({shortname:f.availability.company.shortname,itemPk:f.availability.item.pk,availabilityPk:f.availability.pk},null,null,null,{tagAlong:!0});f.needsCapacity=function(a,b){var c=a[b+"-total"];return 0===c||0<c};var m=function(){if(f.editableAvailability){f.editableAvailability.time=f.availability.startAt.format("HH:mm");var a=f.availability.endAt.diff(f.availability.startAt,
"hours",!0);f.editableAvailability.hours=_.round(a,2)}};l=function(){if(f.editableAvailability){var a=f.availability.startAt.format("YYYY-MM-DD");f.startTime=moment(a+" "+f.editableAvailability.time,"YYYY-MM-DD HH:mm");f.endTime=f.startTime.clone().add("hours",f.editableAvailability.hours)}};f.$watch("editableAvailability.time",l);f.$watch("editableAvailability.hours",l);d.on(f,"dashboard.shared.AvailabilityEditableCtrl.updated",function(a,b){f.editableAvailability&&_.extend(f.editableAvailability,
b.editableAvailability)});return e.dataController(f,{promises:[f.availability.$promise,f.allBookings.$promise],successCallback:function(){e.editController(f,{elementKey:"availability",modelKey:"editableAvailability",get:g.availability,remove:g.availability.remove,editing:b,editCallback:function(){m();f.editableAvailability.user=f.availability.user?f.availability.user.pk:"";f.editableAvailability.requirementGroup=f.availability.requirementGroup?f.availability.requirementGroup.pk:"";f.editableAvailability.customFieldInstanceGroup=
f.availability.customFieldInstanceGroup?f.availability.customFieldInstanceGroup.pk:"";f.editableAvailability.defaultRoute=f.availability.defaultRoute?f.availability.defaultRoute.pk:"";f.bookings=_.filter(f.allBookings,function(a){return!a.isCancelled})},successCallback:function(){d.broadcast("dashboard.shared.AvailabilityEditableCtrl.updated",{availability:f.availability,editableAvailability:f.editableAvailability})},removeCallback:function(){d.broadcast("dashboard.shared.AvailabilityEditableCtrl.removed",
{availability:f.availability})},params:function(){return{shortname:f.availability.company.shortname,itemPk:f.availability.item.pk,availabilityPk:f.availability.pk}}})}})}])};b("dashboard.shared.AvailabilityHeadlineCtrl",!1);b("dashboard.shared.AvailabilityEditableCtrl",!0);h.controller("dashboard.shared.AdvancedAvailabilitySettingsCtrl",["$scope","require","db",function(a,b,f){b.inScope(a,"availability","dashboard.shared.AdvancedAvailabilitySettingsCtrl");a.routes=f.routes.pickable({shortname:a.availability.company.shortname});
a.customFieldInstanceGroups=f.customFieldInstanceGroups({shortname:a.availability.company.shortname,itemPk:a.availability.item.pk});a.requirementGroups=[];f.requirementGroups({shortname:a.availability.company.shortname,itemPk:a.availability.item.pk}).then(function(b){a.requirementGroups=b})}]);h.controller("dashboard.shared.AvailabilityMediumCtrl",["$scope","require","urls",function(a,b,f){b.inScope(a,"availability","dashboard.shared.AvailabilityMediumCtrl");a.dayUrl=f.dayUrlForCompany(a.availability.company,
a.availability.startAt);return a}]);h.controller("dashboard.shared.AvailabilityStatsCtrl",["$scope","controllers","db","events","require",function(a,b,f,e,g){g.inScope(a,"availability");g=[];var d=function(){a.availability=f.availability({shortname:a.availability.company.shortname,itemPk:a.availability.item.pk,availabilityPk:a.availability.pk},null,null,null,{tagAlong:!0})};if(_.isUndefined(a.availability.bookableCapacity)||!a.availability.crewMembers||_.isUndefined(a.availability.blockCount)&&!a.availability.blocks)d(),
g=[a.availability];var l=function(b,c){c.availability===a.availability&&(d(),e.broadcast("lib.shared.CalendarCtrl.refresh"))};e.on(a,"dashboard.shared.BlocksCtrl.created",l);e.on(a,"dashboard.shared.BlockEditableCtrl.updated",l);e.on(a,"dashboard.shared.BlockEditableCtrl.removed",l);return b.dataController(a,{stale:g,promises:[a.availability.$promise]})}]);h.controller("dashboard.shared.ManifestBookingsReceiptCtrl",["$scope","controllers","db","models","navigation","require",function(a,b,f,e,g,d){d.inScope(a,
"company");d.inScope(a,"manifestObject");b={includeRefunds:"yes"};var l=a.manifestObject.cls;d=a.route.bindings.date;l===e.Availability.cls?(f=f.availabilities.manifest,b.availabilityPks=[a.manifestObject.pk],b.itemPks=[a.manifestObject.item.pk]):l===e.Item.cls?(f=f.availabilities.manifest,b.itemPks=[a.manifestObject.pk]):l===e.Resource.cls?(f=f.resources.manifest,b.resourcePks=[a.manifestObject.pk]):l===e.Run.cls?(f=f.runs.manifest,b.routePks=[a.manifestObject.route.pk]):f=f.bookings.manifest;a.receiptData=
f({shortname:g.currentCompany.shortname,date:d},null,null,b)}]);h.controller("dashboard.shared.AvailabilityNoteCtrl",["$scope","controllers","db","events","require","sonar",function(a,b,f,e,g,d){g.inScope(a,"availability","dashboard.shared.AvailabilityNoteCtrl");return b.editController(a,{elementKey:"availability",modelKey:"editableAvailability",update:f.availability.note,params:function(){return{shortname:a.availability.company.shortname,itemPk:a.availability.item.pk,availabilityPk:a.availability.pk}},
refreshActivities:!0})}]);h.controller("dashboard.shared.AllBookingsCtrl",["$scope","controllers","db","events","require","sonar",function(a,b,f,e,g,d){g.inScope(a,"allBookings");var l=function(){a.bookings=_.filter(a.allBookings,function(a){return!a.isCancelled});a.cancelledBookings=_.difference(a.allBookings,a.bookings)};e.on(a,"dashboard.shared.AvailabilityEditableCtrl.updated",function(a,b){l()});d.watch(a,a.availability,"bookings",function(b,c){return d.get(f.booking.byPk,{shortname:c.company,
bookingPk:c.booking}).$promise.then(function(b){_.contains(a.allBookings,b)||a.allBookings.push(b);l()})});return b.dataController(a,{stale:[a.allBookings],promises:[a.allBookings.$promise],successCallback:function(){l()}})}]);h.controller("dashboard.shared.AvailabilityCrewCtrl",["$scope","controllers","db","events","require",function(a,b,f,e,g){g.inScope(a,"availability");a.viewing="crew-members";a.viewRoles=function(){a.viewing="roles"};a.viewCrewMembers=function(){a.viewing="crew-members"}}]);
h.controller("dashboard.shared.CrewMembersCtrl",["$scope","auth","controllers","db","events","models","require",function(a,b,f,e,g,d,l){l.inScope(a,"availability");l=a.availability.company;var m=a.availability.item;a.crewMembers=e.crewMembers({shortname:l.shortname,itemPk:m.pk,availabilityPk:a.availability.pk});var k=b.permissions.canCreate(d.CrewMember,a.availability),h=k||b.permissions.can("createSelfAssignable",d.CrewMember,a.availability);a.showAddCrewMemberForm=h;a.allUsers=[];k&&b.permissions.canList(d.User,
a.availability.company)?a.allUsers=e.users({shortname:l.shortname}):h&&b.currentUser.company===a.availability.company&&(a.allUsers=[b.currentUser]);a.roles=[];b.permissions.canList(d.Role,a.availability)&&(a.roles=e.roles({shortname:l.shortname}));a.selectableRoles=a.roles;var s=[];b.permissions.canList(d.Subscription,m)&&(s=e.item.subscriptions({shortname:l.shortname,itemPk:m.pk}));a.isCrewChangeNotificationNeeded=function(b){return!d.Availability.isInPast(a.availability)&&b.email&&d.Subscription.isUserSubscribed(s,
b,d.Subscription.CREW_CHANGE_TYPE)};return f.dataController(a,{promises:[s.$promise,a.roles.$promise,a.crewMembers.$promise,a.allUsers.$promise],successCallback:function(){a.selectableUsers=d.User.getActive(a.allUsers);f.listController(a,{collectionKey:"crewMembers",modelKey:"newCrewMember",create:e.crewMembers.create,params:function(){return{shortname:a.availability.company.shortname,itemPk:a.availability.item.pk,availabilityPk:a.availability.pk}},successCallback:function(b){g.broadcast("dashboard.shared.ActivitiesCtrl.refresh",
{object:a.availability})},defaultModel:{user:"",role:"",note:""},sortable:!0})}})}]);h.controller("dashboard.shared.RolesCtrl",["$scope","controllers","db","events","require",function(a,b,f,e,g){g.inScope(a,"company");a.roles=f.roles({shortname:a.company.shortname});b.dataController(a,{promises:[a.roles.$promises],successCallback:function(){b.listController(a,{collectionKey:"roles",modelKey:"newRole",create:f.roles.create,params:function(){return{shortname:a.company.shortname}},defaultModel:{shortName:""}})}})}]);
h.controller("dashboard.shared.CrewMemberEditableCtrl",["$scope","db","events","models","require","controllers",function(a,b,f,e,g,d){g.inScope(a,"crewMember");g.inScope(a,"allUsers");var l=function(){a.selectableUsers=e.User.getActive(a.allUsers);a.crewMember.user.isInactive&&a.selectableUsers.push(a.crewMember.user)};l();return d.editController(a,{collectionKey:"crewMembers",elementKey:"crewMember",modelKey:"editableCrewMember",update:b.crewMember.update,remove:b.crewMember.remove,editCallback:function(){a.editableCrewMember.user=
a.crewMember.user.pk;a.editableCrewMember.role=a.crewMember.role?a.crewMember.role.pk:"";a.selectableRoles=_.clone(a.roles);a.crewMember.role&&!_.contains(a.selectableRoles,a.crewMember.role)&&a.selectableRoles.unshift(a.crewMember.role)},successCallback:function(){l();f.broadcast("dashboard.shared.ActivitiesCtrl.refresh",{object:a.crewMember.availability});f.broadcast("lib.shared.CalendarCtrl.refresh")},removeCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh",{object:a.crewMember.availability})},
params:function(){return{shortname:a.crewMember.company.shortname,itemPk:a.crewMember.availability.item.pk,availabilityPk:a.crewMember.availability.pk,crewMemberPk:a.crewMember.pk}}})}]);h.controller("dashboard.shared.RoleEditableCtrl",["$scope","db","events","require","controllers",function(a,b,f,e,g){e.inScope(a,"role");return g.editController(a,{collectionKey:"roles",elementKey:"role",modelKey:"editableRole",update:b.role.update,remove:b.role.remove,params:function(){return{shortname:a.role.company.shortname,
rolePk:a.role.pk}}})}]);h.controller("dashboard.shared.BlocksCtrl",["$scope","controllers","db","events","navigation","require",function(a,b,f,e,g,d){d.inScope(a,"availability","dashboard.shared.BlocksCtrl");a.availability=f.availability({shortname:a.availability.company.shortname,itemPk:a.availability.item.pk,availabilityPk:a.availability.pk},null,null,null,{tagAlong:!0});a.affiliations=f.affiliates.pickable({shortname:a.availability.company.shortname});return b.dataController(a,{promises:[a.availability.$promise,
a.affiliations.$promise],successCallback:function(){a.blocks=a.availability.blocks;b.listController(a,{collectionKey:"blocks",modelKey:"newBlock",create:f.blocks.create,params:function(){return{shortname:a.availability.company.shortname,itemPk:a.availability.item.pk,availabilityPk:a.availability.pk}},successCallback:function(){e.broadcast("dashboard.shared.BlocksCtrl.created",{availability:a.availability});e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}})}})}]);h.controller("dashboard.shared.BlockEditableCtrl",
["$scope","controllers","db","events","navigation","require",function(a,b,f,e,g,d){d.inScope(a,"availability","dashboard.shared.BlockEditableCtrl");d.inScope(a,"block","dashboard.shared.BlockEditableCtrl");d.inScope(a,"blocks","dashboard.shared.BlockEditableCtrl");return b.editController(a,{collectionKey:"blocks",elementKey:"block",modelKey:"editableBlock",remove:f.block.remove,removeCallback:function(){e.broadcast("dashboard.shared.BlockEditableCtrl.removed",{availability:a.availability});e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},
update:f.block.update,params:function(){return{shortname:a.availability.company.shortname,itemPk:a.availability.item.pk,availabilityPk:a.availability.pk,blockPk:a.block.pk}},successCallback:function(){e.broadcast("dashboard.shared.BlockEditableCtrl.updated",{availability:a.availability});e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}})}]);h.controller("dashboard.shared.CustomerTypeRateEditableCtrl",["$scope","db","events","require","controllers",function(a,b,f,e,g){e.inScope(a,"customerTypeRate",
"dashboard.shared.CustomerTypeRateEditableCtrl");return g.editController(a,{collectionKey:"customerTypeRates",elementKey:"customerTypeRate",modelKey:"editableCustomerTypeRate",update:b.customerTypeRate.update,remove:b.customerTypeRate.remove,successCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh",{object:a.customerTypeRate.availability})},removeCallback:function(){f.broadcast("dashboard.shared.CustomerTypeRateEditableCtrl.removed",{customerTypeRate:a.customerTypeRate});f.broadcast("dashboard.shared.ActivitiesCtrl.refresh",
{object:a.customerTypeRate.availability})},params:function(){return{shortname:a.customerTypeRate.company.shortname,itemPk:a.customerTypeRate.availability.item.pk,availabilityPk:a.customerTypeRate.availability.pk,customerTypeRatePk:a.customerTypeRate.pk}}})}]);h.controller("dashboard.shared.BookingMediumCtrl",["$scope","require",function(a,b){b.inScope(a,"booking","dashboard.shared.BookingMediumCtrl");return a}]);h.controller("dashboard.shared.ObjectActivitiesCtrl",["$scope","dashboard.shared.activitiesController",
"models",function(a,b,f){f=a.activityObject?_.contains([f.Item.cls,f.Resource.cls,f.Company.cls],a.activityObject.cls):!1;return b(a,{object:a.activityObject,isFilteringEnabled:f})}]);h.controller("dashboard.shared.UserActivitiesCtrl",["$scope","dashboard.shared.activitiesController","db","require",function(a,b,f,e){e.inScope(a,"user","dashboard.shared.UserActivitiesCtrl");return b(a,{get:f.user.activities,params:function(){return{shortname:a.user.company.shortname,username:a.user.username}},isFilteringEnabled:!0})}]);
h.controller("dashboard.shared.GroupOverrideActivitiesCtrl",["$scope","dashboard.shared.activitiesController","db","require",function(a,b,f,e){e.inScope(a,"groupOverride","dashboard.shared.GroupOverrideActivitiesCtrl");return b(a,{get:f.groupOverride.activities,params:function(){return{shortname:a.groupOverride.company.shortname,groupOverridePk:a.groupOverride.pk}},isFilteringEnabled:!0})}]);h.controller("dashboard.shared.AllActivitiesCtrl",["$scope","dashboard.shared.activitiesController","db","navigation",
"require",function(a,b,f,e,g){g.notNull(e,"currentCompany");return b(a,{get:f.company.activities.all,params:function(){return{shortname:e.currentCompany.shortname}}})}]);h.controller("dashboard.shared.ActivityCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){a.activity=f.activity({shortname:a.route.bindings.shortname,activityPk:a.route.bindings.activityPk});b.dataController(a,{promises:[a.activity.$promise]})}]);h.controller("dashboard.shared.ActivityNotesCtrl",["$scope",
"dashboard.shared.activitiesController","require",function(a,b,f){f.inScope(a,"activity","dashboard.shared.ActivityNotesCtrl");a.activityObject=a.activity;return b(a,{object:a.activity})}]);h.controller("dashboard.shared.LineItemCtrl",["$scope","controllers","db","events","require",function(a,b,f,e,g){g.inScope(a,"lineItems");g.inScope(a,"lineItem");return b.editController(a,{collectionKey:"lineItems",elementKey:"lineItem",modelKey:"editableLineItem",get:f.lineItem,params:function(){return{shortname:a.lineItem.company.shortname,
itemPk:a.lineItem.item.pk,bookingUuid:a.lineItem.booking.uuid,lineItemPk:a.lineItem.pk}},successCallback:function(){f.refresh(a.booking.uri,{tagAlong:!0});e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){f.refresh(a.booking.uri,{tagAlong:!0});e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}})}]);h.controller("dashboard.shared.ContactEditableCtrl",["$scope","db","controllers","events","require",function(a,b,f,e,g){g.inScope(a,"contact");return f.editController(a,
{elementKey:"contact",modelKey:"editableContact",update:b.contact.update,successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},params:function(){return{shortname:a.contact.company.shortname,contactPk:a.contact.pk}}})}]);h.controller("dashboard.shared.BookingAffiliationEditableCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");g.inScope(a,"booking");a.bookingHasCardOnFilePayment=_.any(a.booking.payments,function(a){return!a.isRefunded&&
a.isCardOnFile});a.editableAffiliation={};a.affiliation=a.booking.affiliation;a.affiliationOptions={};b.affiliationController(a,{modelKey:"editableAffiliation",booking:a.booking,affiliateModelKey:"affiliationOptions"})}]);h.controller("dashboard.shared.AffiliationEditableCtrl",["$scope","controllers","db","events","navigation","require","urls",function(a,b,f,e,g,d,l){d.inScope(a,"affiliation","dashboard.shared.AffiliationEditableCtrl");d.inScope(a,"invoiceSheetsAndSchedules","dashboard.shared.AffiliationEditableCtrl");
d.inScope(a,"totalSheetsAndSchedules","dashboard.shared.AffiliationEditableCtrl");d.inScope(a,"affiliateGroups","dashboard.shared.AffiliationEditableCtrl");d.inScope(a,"cancellationPolicies","dashboard.shared.AffiliationEditableCtrl");return b.editController(a,{elementKey:"affiliation",modelKey:"editableAffiliation",update:f.affiliate.update,remove:f.affiliate.remove,params:function(){return{shortname:a.affiliation.company.shortname,affiliationPk:a.affiliation.pk}},editCallback:function(){a.editableAffiliation.defaultTotalSheetOrSchedule=
a.affiliation.defaultTotalSheet?a.affiliation.defaultTotalSheet.uri:a.affiliation.defaultTotalSchedule?a.affiliation.defaultTotalSchedule.uri:"";a.editableAffiliation.defaultInvoiceSheetOrSchedule=a.affiliation.defaultInvoiceSheet?a.affiliation.defaultInvoiceSheet.uri:a.affiliation.defaultInvoiceSchedule?a.affiliation.defaultInvoiceSchedule.uri:"";a.editableAffiliation.isCustomInvoiceFee=null!==a.affiliation.invoiceFeeRate||null!==a.affiliation.invoiceFlatFee;a.editableAffiliation.invoiceFeeRate=
null!==a.affiliation.invoiceFeeRate?a.affiliation.invoiceFeePercentage:"";a.editableAffiliation.invoiceFlatFee=null!==a.affiliation.invoiceFlatFee?a.affiliation.invoiceFlatFee:"";a.editableAffiliation.affiliateGroup=a.affiliation.affiliateGroup?a.affiliation.affiliateGroup.pk:"";a.editableAffiliation.cancellationPolicy=a.affiliation.cancellationPolicy?a.affiliation.cancellationPolicy.pk:""},submitCallback:function(){a.editableAffiliation.isCustomInvoiceFee||(a.editableAffiliation.invoiceFeeRate="",
a.editableAffiliation.invoiceFlatFee="")},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");e.broadcast("auth.clearEffectiveGroupCache")},removeCallback:function(){g.navigate(a.affiliation.company.$url(l.dashboard.settings.network.affiliates.index));e.broadcast("auth.clearEffectiveGroupCache")},editing:!0})}]);b=function(a){return h.controller(a.name,["$scope","controllers","db","events","navigation","require",function(b,f,e,g,d,l){l.inScope(b,"customFieldValue");e=
a.isBookingLevel?e.bookingCustomFieldValue.update:e.customerCustomFieldValue.update;var m=a.isBookingLevel?b.customFieldValue.booking:b.customFieldValue.customer.booking,k=a.isBookingLevel?"bookingCustomFieldValuePk":"customerCustomFieldValuePk";b.customField=b.customFieldValue.customFieldInstance.customField;b.editableCustomFieldValueOptions={};return f.editController(b,{elementKey:"customFieldValue",modelKey:"editableCustomFieldValue",modelFields:["value"],update:e,params:function(){var a={shortname:b.customFieldValue.company.shortname,
bookingUuid:m.uuid};a[k]=b.customFieldValue.pk;return a},editCallback:function(){b.editableCustomFieldValue.value=_.clone(b.customFieldValue.value)},successCallback:function(){g.broadcast("dashboard.shared.ActivitiesCtrl.refresh");g.broadcast("dashboard.CustomFieldValueCtrl.updated")}})}])};b({name:"dashboard.shared.BookingCustomFieldValueEditableCtrl",isBookingLevel:!0});b({name:"dashboard.shared.CustomerCustomFieldValueEditableCtrl",isBookingLevel:!1});h.controller("dashboard.shared.CampaignMediumCtrl",
["$scope","require",function(a,b){b.inScope(a,"campaign");return a}]);h.controller("dashboard.shared.CampaignMediumEditableCtrl",["$scope","controllers","db","navigation","require","urls",function(a,b,f,e,g,d){g.inScope(a,"campaign");return b.editController(a,{collectionKey:"campaigns",elementKey:"campaign",modelKey:"editableCampaign",update:f.campaign.update,remove:f.campaign.remove,removeCallback:function(){e.navigate(a.campaign.company.$url(d.dashboard.settings.campaigns.index))},params:function(){return{shortname:a.campaign.company.shortname,
campaignPk:a.campaign.pk}},editing:!0,refreshActivities:!0})}]);h.controller("dashboard.shared.CodeEditableCtrl",["$scope","controllers","db","navigation","require","urls",function(a,b,f,e,g,d){g.inScope(a,"code","dashboard.shared.CodeEditableCtrl");a.affiliatesNgDropdownEndpoint=f.searchEndpoint(f.affiliates.pickable,{shortname:a.code.company.shortname});a.codeOptions={};return b.editController(a,{collectionKey:"codes",elementKey:"code",modelKey:"editableCode",update:f.code.update,remove:f.code.remove,
params:function(){return{shortname:a.code.company.shortname,campaignPk:a.code.campaign.pk,codePk:a.code.pk}},editCallback:function(){a.editableCode.affiliation=a.code.affiliation?a.code.affiliation.pk:"";a.codeOptions.currentAffiliation=a.code.affiliation},removeCallback:function(){e.navigate(a.code.$url(d.dashboard.settings.campaigns.campaign.index))},refreshActivities:!0})}]);h.controller("dashboard.shared.ItemCalendarCtrl",["$scope","availabilityCalendarController","db","navigation","require",
"urls",function(a,b,f,e,g,d){g.inScope(a,"item","dashboard.shared.ItemCalendarCtrl");g.inScope(a,"addAvailabilitiesOnDay","dashboard.shared.ItemCalendarCtrl");e=a.item.isArchived?_.ignore:a.addAvailabilitiesOnDay;return b(a,{url:a.item.$url(d.dashboard.items.item.calendar),company:a.item.company,isEmptyAllowed:!0,endpoint:f.item.calendar,params:{shortname:a.item.company.shortname,itemPk:a.item.pk},largeDaySelected:e,editDay:e,isEditable:!a.item.isArchived})}]);h.controller("dashboard.shared.CustomCalendarEditableCtrl",
["$scope","controllers","db","require",function(a,b,f,e){e.inScope(a,"customCalendars","dashboard.shared.CustomCalendarEditableCtrl");e.inScope(a,"customCalendar","dashboard.shared.CustomCalendarEditableCtrl");e.inScope(a,"currentCustomCalendar","dashboard.shared.CustomCalendarEditableCtrl");e.inScope(a,"applyCustomCalendar","dashboard.shared.CustomCalendarEditableCtrl");e.inScope(a,"updateCurrentCustomCalendar","dashboard.shared.CustomCalendarEditableCtrl");return b.editController(a,{collectionKey:"customCalendars",
elementKey:"customCalendar",modelKey:"editableCustomCalendar",update:f.customCalendar.update,remove:f.customCalendar.remove,submitCallback:function(){a.editableCustomCalendar.settings=_.stringifyJSON(a.editableCustomCalendar.overwriteSettings?a.calendarFilter:a.customCalendar.settings)},successCallback:function(){a.applyCustomCalendar(a.customCalendar,!0)},removeCallback:function(){a.currentCustomCalendar===a.customCalendar&&a.updateCurrentCustomCalendar(null)},params:function(){return{shortname:a.customCalendar.company.shortname,
customCalendarPk:a.customCalendar.pk}}})}]);h.controller("dashboard.shared.AgentEditableCtrl",["$scope","controllers","db","events","navigation","require","urls",function(a,b,f,e,g,d,l){d.inScope(a,"agent");d.inScope(a,"agents");return b.editController(a,{collectionKey:"agents",elementKey:"agent",modelKey:"editableAgent",get:f.agent,params:function(){return{shortname:a.agent.company.shortname,agentPk:a.agent.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){g.navigate(a.agent.company.$url(l.dashboard.settings.agents.index))}})}]);
h.controller("dashboard.shared.DeskEditableCtrl",["$scope","controllers","db","events","navigation","require","urls",function(a,b,f,e,g,d,l){d.inScope(a,"desk");d.inScope(a,"desks");return b.editController(a,{collectionKey:"desks",elementKey:"desk",modelKey:"editableDesk",get:f.desk,params:function(){return{shortname:a.desk.company.shortname,deskPk:a.desk.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){g.navigate(a.desk.$url(l.dashboard.settings.desks.index))}})}]);
h.controller("dashboard.shared.HotelEditableCtrl",["$scope","controllers","db","events","navigation","require","urls",function(a,b,f,e,g,d,l){d.inScope(a,"hotel");d.inScope(a,"hotels");return b.editController(a,{collectionKey:"hotels",elementKey:"hotel",modelKey:"editableHotel",get:f.hotel,params:function(){return{shortname:a.hotel.company.shortname,hotelPk:a.hotel.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){g.navigate(a.hotel.$url(l.dashboard.settings.hotels.index))},
editing:!0})}]);h.controller("dashboard.shared.LodgingEditableCtrl",["$scope","controllers","db","events","navigation","require","urls",function(a,b,f,e,g,d,l){d.inScope(a,"lodging");d.inScope(a,"lodgings");a.hotelsEndpoint=f.searchEndpoint(f.hotels,{shortname:a.lodging.company.shortname});a.hotelCtrl={currentHotel:a.lodging.hotel};b.editController(a,{collectionKey:"lodgings",elementKey:"lodging",modelKey:"editableLodging",update:f.lodging.update,remove:f.lodging.remove,params:function(){return{shortname:a.lodging.company.shortname,
lodgingPk:a.lodging.pk}},editCallback:function(){a.editableLodging.hotel=_.get(a.lodging,"hotel.pk",null)},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){g.navigate(a.lodging.$url(l.dashboard.settings.lodgings.index))}})}]);h.controller("dashboard.shared.BankAccountEditableCtrl",["$scope","controllers","db","events","flash","models","require",function(a,b,f,e,g,d,l){l.inScope(a,"bankAccounts");l.inScope(a,"bankAccount");a.verifyBankAccount=
{verify1:"",verify2:""};b.editController(a,{elementKey:"verifyBankAccount",modelKey:"editableVerifyBankAccount",update:f.bankAccount.verify,params:function(){return{shortname:a.bankAccount.company.shortname,bankAccountPk:a.bankAccount.pk}},defaultModel:{verify1:"",verify2:""},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");g.success(T("Verified bank account"))},errorCallback:function(b,c){a.editCtrl.edit(c)}});b.removeController(a,{collectionKey:"bankAccounts",elementKey:"bankAccount",
remove:f.bankAccount.remove,params:function(){return{shortname:a.bankAccount.company.shortname,bankAccountPk:a.bankAccount.pk}},removeCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");g.success(T("Removed bank account"))}})}]);h.controller("dashboard.shared.PreferredPickupRemoveableCtrl",["$scope","controllers","db","events","require",function(a,b,f,e,g){g.inScope(a,"preferredPickups");g.inScope(a,"preferredPickup");return b.removeController(a,{collectionKey:"preferredPickups",
elementKey:"preferredPickup",remove:f.preferredPickup.remove,params:function(){return{shortname:a.preferredPickup.company.shortname,lodgingPk:a.preferredPickup.lodging.pk,preferredPickupPk:a.preferredPickup.pk}},removeCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}})}]);h.controller("dashboard.shared.PickupEditableCtrl",["$scope","controllers","db","events","navigation","require","urls",function(a,b,f,e,g,d,l){d.inScope(a,"pickup");d.inScope(a,"pickups");return b.editController(a,
{collectionKey:"pickups",elementKey:"pickup",modelKey:"editablePickup",update:f.pickup.update,remove:f.pickup.remove,params:function(){return{shortname:a.pickup.company.shortname,pickupPk:a.pickup.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");a.editCtrl.edit()},removeCallback:function(){g.navigate(a.pickup.$url(l.dashboard.settings.pickups.index))},editing:!0})}]);h.controller("dashboard.shared.RouteEditableCtrl",["$scope","controllers","db","events","navigation",
"require","urls",function(a,b,f,e,g,d,l){d.inScope(a,"transRoute");d.inScope(a,"routes");return b.editController(a,{collectionKey:"routes",elementKey:"transRoute",modelKey:"editableRoute",get:f.route,params:function(){return{shortname:a.transRoute.company.shortname,routePk:a.transRoute.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){g.navigate(a.transRoute.$url(l.dashboard.settings.routes.index))}})}]);h.controller("dashboard.shared.StopEditableCtrl",
["$scope","controllers","db","events","navigation","require",function(a,b,f,e,g,d){d.inScope(a,"stops");d.inScope(a,"stop","dashboard.shared.StopEditableCtrl");return b.editController(a,{collectionKey:"stops",elementKey:"stop",modelKey:"editableStop",get:f.stop,params:function(){return{shortname:a.stop.company.shortname,routePk:a.stop.route.pk,stopPk:a.stop.pk}},editCallback:function(){a.editableStop.pickup=a.stop.pickup.pk},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},
removeCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},editing:!0})}]);h.controller("dashboard.shared.AvailabilityStatusEditable",["$scope","controllers","db","events","require","toggles",function(a,b,f,e,g,d){g.inScope(a,"availability");a.bookingRestrictions=f.bookingRestrictions({shortname:a.availability.company.shortname});a.$watch("editCtrl.isRestrictionsOverridden",function(b){!1===b?a.editableAvailability.bookingRestriction=null:!0===b&&!a.editableAvailability.bookingRestriction&&
(a.editableAvailability.bookingRestriction=a.bookingRestrictions[0].pk)});b.editController(a,{elementKey:"availability",modelKey:"editableAvailability",update:f.availability.status.update,editCallback:function(){a.editableAvailability.isUnlistedBackingField=a.editableAvailability.isUnlisted;a.editableAvailability.bookingRestriction=_.get(a.availability,"bookingRestriction.pk",null)},submitCallback:function(){a.editableAvailability.isUnlistedBackingField=a.editableAvailability.isUnlisted},successCallback:function(){e.broadcast("dashboard.shared.AvailabilityStatusEditable.updated",
{availability:a.availability});e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");d.toggle("availability-status",!1);a.editCtrl.editingBookingRestriction=!1},params:function(){return{shortname:a.availability.company.shortname,itemPk:a.availability.item.pk,availabilityPk:a.availability.pk}},editing:!0})}]);h.controller("dashboard.shared.BookingBrowserCtrl",["$scope","auth","controllers","db","events","models","navigation","require","sonar",function(a,b,f,e,g,d,l,m,k){m.inScope(a,"company");m.inScope(a,
"browserFilter");var h,s=function(b,c,f,g){g=g||{};_.extend(c,{filter:d.Calendar.filterUrl(a.browserFilter.networkSelection)});var k=b(c,{},null,f);g.quiet||(a.status="loading");g.quiet||(g.paginate?g.firstPage&&(a.nextPage=null,a.bookings=[]):(a.nextPage=null,a.bookings=k));h&&h.cancel&&h.cancel();h=k.$promise;h.then(function(d){if(d!==e.CANCELLED){var l=null;d.data.nextPage&&(l=function(){var a=_.extend({},f,{page:d.data.nextPage});s(b,c,a,{paginate:!0})});g.quiet?(k=_.filter(k,function(b){return!_.contains(a.bookings,
b)}),_.overwrite(a.bookings,_.append(k,a.bookings))):g.paginate&&(_.forEach(k,function(b){_.contains(a.bookings,b)||a.bookings.push(b)}),a.nextPage=l);a.status="success"}},function(){a.status="error"})},p=_.debounce(function(){a.$apply(function(){return s(e.bookings.searchByQuery,{shortname:a.company.shortname},{q:a.browserFilter.query})})},500),r=function(b){if(a.browserFilter.showRecent)return b=_.extend({paginate:!0,firstPage:!0},b),s(e.bookings.searchByNew,{shortname:a.company.shortname},null,
b);a.bookings=[]};a.$watch("browserFilter.query",function(b,c){b?(a.status="loading",c&&(a.nextPage=null,a.bookings=[]),p()):c&&r()});a.$watch("browserFilter.networkSelection",function(a,b){a!==b&&r()});a.$watch("browserFilter.showRecent",function(b){b&&!a.browserFilter.query&&r()});k.watch(a,a.company,"bookings",function(){a.browserFilter.showRecent&&!a.browserFilter.query&&"loading"!==a.status&&r({paginate:!1,firstPage:!1,quiet:!0})});a.bowserFilterTracker=_.tracker();g.on(a,"dashboard.shared.ItemColorEditableCtrl.updated",
function(){a.bowserFilterTracker.modified()})}]);h.controller("dashboard.shared.DuplicateGroupCtrl",["$scope","dashboard.shared.duplicatingController","db","flash","navigation","require","urls",function(a,b,f,e,g,d,l){d.inScope(a,"groups","dashboard.shared.DuplicateGroupCtrl");d.inScope(a,"group","dashboard.shared.DuplicateGroupCtrl");b(a,{endpoint:f.group.duplicate,params:{groupPk:a.group.pk,shortname:a.group.company.shortname},successCallback:function(b){a.group.name?e.success(interpolate(T("Duplicated %(groupName)s"),
{groupName:a.group.name})):e.success(T("Duplicated group"));a.groups.push(b);g.navigate(b.$url(l.dashboard.settings.permissions.group))}})}]);h.controller("dashboard.shared.GroupEditableCtrl",["$scope","controllers","db","events","navigation","require","urls",function(a,b,f,e,g,d,l){d.inScope(a,"group","dashboard.shared.GroupEditableCtrl");return b.editController(a,{collectionKey:"groups",elementKey:"group",modelKey:"editableGroup",get:f.group,remove:f.group.remove,editCallback:function(){_.extend(a.editableGroup,
a.group.groupPermissions);_.extendWithPrefix("conditions-",a.editableGroup,a.group.conditions)},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){g.navigate(a.group.company.$url(l.dashboard.settings.permissions.groups))},params:function(){return{shortname:a.group.company.shortname,groupPk:a.route.bindings.groupPk}},editing:!0,skipResetAfterError:!0})}]);h.controller("dashboard.shared.WaiverCtrl",["$scope","require",function(a,b){b.inScope(a,
"waiver","dashboard.shared.WaiverCtrl");return a}]);h.controller("dashboard.shared.WaiverEditableCtrl",["$scope","controllers","db","navigation","require","urls","events",function(a,b,f,e,g,d,l){g.inScope(a,"waiver");return b.editController(a,{collectionKey:"waivers",elementKey:"waiver",modelKey:"editableWaiver",get:f.waiver,removeCallback:function(){e.navigate(a.waiver.company.$url(d.dashboard.settings.waivers.index))},successCallback:function(){l.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},
params:function(){return{shortname:a.waiver.company.shortname,waiverPk:a.waiver.pk}},editing:!0,skipResetAfterError:!0})}]);h.controller("dashboard.shared.ConnectedWaiverRemoveableCtrl",["$scope","controllers","db","events","require",function(a,b,f,e,g){g.inScope(a,"connectedWaivers","dashboard.shared.ConnectedWaiverRemoveableCtrl");g.inScope(a,"connectedWaiver","dashboard.shared.ConnectedWaiverRemoveableCtrl");return b.removeController(a,{collectionKey:"connectedWaivers",elementKey:"connectedWaiver",
remove:f.connectedWaiver.remove,params:function(){return{shortname:a.connectedWaiver.company.shortname,customFieldPk:a.connectedWaiver.customField.pk,connectedWaiverPk:a.connectedWaiver.pk}},removeCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}})}]);h.controller("dashboard.shared.LocationEditableCtrl",["$scope","controllers","db","events","flash","navigation","require","urls",function(a,b,f,e,g,d,l,m){l.inScope(a,"location");l.inScope(a,"locations");return b.editController(a,
{collectionKey:"locations",elementKey:"location",modelKey:"editableLocation",get:f.location,editing:!0,params:function(){return{shortname:a.location.company.shortname,locationPk:a.location.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){g.success(T("Deleted location"));d.navigate(a.location.company.$url(m.dashboard.settings.locations.index))}})}]);h.controller("dashboard.shared.LocationItemsCtrl",["$scope","controllers","db","require",
function(a,b,f,e){e.inScope(a,"location","dashboard.shared.LocationItemsCtrl");a.items=f.location.items({shortname:a.location.company.shortname,locationPk:a.location.pk});return b.dataController(a,{promises:[a.items.$promise]})}]);h.factory("dashboard.shared.duplicatingController",["$timeout","db","flash",function(a,b,f){return function(e,g){var d=g.endpoint,l=g.modelKey||"",m=g.successCallback||_.ignore,k=g.errorCallback||_.ignore,h=_.isFunction(g.params)?g.params:_.constant(g.params||{});(function(a){return _.set(e,
l,a)})(_.extend({},g.defaultModel||{}));e.duplicatingCtrl={duplicating:!1};var s=function(a){e.duplicatingCtrl.duplicating=!1;k(a)},p,r=function(d,f){p=a(function(){b.taskResult({taskId:d}).$promise.then(function(a){var b=a.data.taskState;"SUCCESS"===b?(e.duplicatingCtrl.duplicating=!1,m(a.data.taskResult)):"PENDING"===b?r(d,5E3):s(a)},s)},f)};e.$on("$destroy",function(){p&&a.cancel(p)});e.duplicatingCtrl.duplicate=function(a){e.duplicatingCtrl.duplicating=!0;var b=_.get(e,l),c=d(h(),b,a);c.$promise.then(function(a){a.data.taskId?
(f.success(T("Duplication in progress. This might take a while.")),r(a.data.taskId,2E3)):(e.duplicatingCtrl.duplicating=!1,m(c))},s)}}}]);h.factory("dashboard.shared.activitiesController",["auth","convert","db","events","models","require","sonar",function(a,b,f,e,g,d,l){return function(b,c){b.activityObject?c.object=b.activityObject:b.activityObjectsKey&&(c.objects=b.$eval(b.activityObjectsKey));var h,s;c.objects||c.object?(h=f.activities,s=function(){var a,b,d;c.objects?(a=_.pluck(c.objects,"pk").join(","),
b=c.objects[0].cls,d=g.Company.forObject(c.objects[0])):(a=c.object.pk,b=c.object.cls,d=g.Company.forObject(c.object));return{shortname:d.shortname,activityObjectCls:b,activityObjectPks:a}}):(h=c.get,s=c.params);d.assert(h,"dashboard.controllers.activitiesController: expected object or endpoint");d.assert(s,"dashboard.controllers.activitiesController: expected object or params");b.activitiesCtrl={isFilteringEnabled:!1,dateFilter:"",userFilter:"",queryFilter:""};b.activitiesCtrl.isFilteringEnabled=
c.isFilteringEnabled&&_.get(a.currentUser,"company.isAdmin",!1);b.activitiesCtrl.isFiltering=function(){return!(!b.activitiesCtrl.dateFilter&&!b.activitiesCtrl.userFilter&&!b.activitiesCtrl.queryFilter)};b.activitiesCtrl.reset=function(){b.activitiesCtrl.dateFilter="";b.activitiesCtrl.userFilter="";b.activitiesCtrl.queryFilter="";v()};b.activitiesCtrl.showingActivityLinks=!c.object;b.activitiesCtrl.status="success";b.activitiesCtrl.activities=[];var p,r=function(){var a={};b.activitiesCtrl.dateFilter&&
(a.date=b.activitiesCtrl.dateFilter);b.activitiesCtrl.userFilter&&(a.user=b.activitiesCtrl.userFilter);b.activitiesCtrl.queryFilter&&(a.q=b.activitiesCtrl.queryFilter);return a},t,v=function(){t&&t.cancel&&(t.cancel(),t=null);if(c.objects&&!c.objects.length)_.overwrite(b.activitiesCtrl.activities,[]);else{b.activitiesCtrl.status="refreshing";var a=r();p=a;var d=h(s(),null,null,a,{tagAlong:!0,flashError:!1});t=d.$promise;d.$promise.then(function(a){a!==f.CANCELLED&&(b.activitiesCtrl.status="success",
_.overwrite(b.activitiesCtrl.activities,d),b.activitiesCtrl.nextPage=a.data.nextPage)},function(){b.activitiesCtrl.status="success";b.activitiesCtrl.nextPage=null})}},y=_.debounce(function(){var a=r();angular.equals(a,p)||b.$apply(function(){v()})},500),q=function(){b.activitiesCtrl.status="loading";var a=r();a.page=b.activitiesCtrl.nextPage;var c=h(s(),null,null,a,{tagAlong:!0,flashError:!1});t=c.$promise;c.$promise.then(function(a){b.activitiesCtrl.status="success";_.forEach(c,function(a){_.contains(b.activitiesCtrl.activities,
a)||b.activitiesCtrl.activities.push(a)});b.activitiesCtrl.nextPage=a.data.nextPage})};b.activitiesCtrl.refresh=function(){v()};b.activitiesCtrl.loadMore=function(){q()};c.object&&(b.activitiesCtrl.newNote={},b.activitiesCtrl.canCreateNote=a.permissions.canCreate(g.Activity,g.Company.forObject(c.object)),b.activitiesCtrl.submit=function(a){var d=f.activities.notes.create({shortname:s().shortname,activityObjectPk:c.object.pk,activityObjectCls:c.object.cls},b.activitiesCtrl.newNote,a);d.$promise.then(function(){b.activitiesCtrl.newNote=
{};a.$setPristine();b.activitiesCtrl.activities.unshift(d)})});e.on(b,"dashboard.shared.ActivitiesCtrl.refresh",function(a,b){(!b||!b.object||b.object===c.object)&&v()});c.object&&l.watch(b,c.object,"activities",v);c.object&&c.object.modifiedAt?b.$watch(function(){return c.object.modifiedAt.format()},function(){v()}):b.activityObjectsKey?b.$watchCollection(b.activityObjectsKey,function(a){c.objects=a||[];v()}):v();var B=function(a,b){a!==b&&y()};b.$watch("activitiesCtrl.dateFilter",B);b.$watch("activitiesCtrl.userFilter",
B);b.$watch("activitiesCtrl.queryFilter",B);b.activitiesCtrl.isCampaignPage=c.object&&"Campaign"===c.object.cls?1:0;B=function(a,b){return function(){var c=_.toArray(arguments),d={};_.forEach(b,function(a,b){d[a]=c[b]});e.broadcast(a,d)}};b.activitiesCtrl.actions={};b.activitiesCtrl.actions.clearAvailabilitiesByTag=B("dashboard.shared.ActivitiesCtrl.clearAvailabilitiesByTag",["tag"]);b.activitiesCtrl.actions.clearResourceOverridesByTag=B("dashboard.shared.ActivitiesCtrl.clearResourceOverridesByTag",
["tag"]);b.activitiesCtrl.actions.clearCodesByTag=B("dashboard.shared.ActivitiesCtrl.clearCodesByTag",["tag"]);return b}}]);h.factory("dashboard.shared.subscriptionsController",["models","require","urls",function(a,b,f){return function(e,f){b.defined(f,"company","dashboard.shared.subscriptionsController");var d=f.modelKey,l=function(a){a=a.replace(/-([a-z])/g,function(a,b){return b.toUpperCase()});return f.prefix?f.prefix+"-"+a:a};e.subscriptionsCtrl={};e.subscriptionsCtrl.defaultModel=function(){var b=
{};_.forEach(a.Subscription.HOURS_BEFORE_SUBSCRIPTION_TYPES,function(c){var d=l(c)+"HoursBefore";b[d]=a.Subscription.HOURS_BEFORE_DEFAULTS[c]});return b}();e.subscriptionsCtrl.edit=function(b){_.extend(e[d],e.subscriptionsCtrl.defaultModel);b&&_.forEach(b,function(b){var c=l(b.type);e[d][c]=!0;_.contains(a.Subscription.BOOKING_OPTION_TYPES,b.type)&&_.forEach(a.Subscription.BOOKING_OPTIONS_BY_TYPE[b.type],function(a){var f=c+_.capitalize(a);e[d][f]=b[a]});e[d][c+"IsForCrewAvailabilitiesOnly"]=b.isForCrewAvailabilitiesOnly;
b.hoursBefore&&(e[d][c+"HoursBefore"]=b.hoursBefore)})};e.subscriptionsCtrl.getKey=l;e.$watch(function(){var b;e[d]?(b=l(a.Subscription.DAILY_MANIFEST_TYPE)+"HoursBefore",b=e[d][b]):b=void 0;return b},function(a){var b=e.subscriptionsCtrl;a=parseFloat(a);a=_.isNumber(a)?moment().startOf("day").subtract(a,"hours"):void 0;b.dailyManifestTime=a});var m=function(a){a=l(a);return!!e[d][a]};e.subscriptionsCtrl.isTypeSelected=m;var k=function(b){var c=l(b);return _.some(a.Subscription.BOOKING_OPTIONS,function(a){a=
c+_.capitalize(a);return e[d][a]})};e.subscriptionsCtrl.isOptionSelectedForType=k;e.subscriptionsCtrl.isTypeSupported=function(b){return a.Subscription.isTypeSupported(f.company,b)};var h=function(){return!e[d]?!1:_.all(a.Subscription.BOOKING_OPTION_TYPES,function(a){return!m(a)||k(a)})};e.$watch(function(){return h()},function(a){e.subscriptionsCtrl.isValid=a});return e}}]);h.controller("dashboard.shared.AvailabilityUpdaterCtrl",["$scope","$q","db","events","filterFields","flash","models","moment",
"navigation","require","urls",function(a,b,f,e,g,d,l,m,k,h,s){h.inScope(a,"availabilityUpdater");var p=a.availabilityUpdater;a.company=p.company;a.allItems=p.allItems;var r=["update-customer-type-rate-capacity","update-customer-type-rate-party-sizes"],t=["customerPrototype","customerTypeRateCapacity","customerTypeRateMinimumPartySize","customerTypeRateMaximumPartySize"];a.$watch("currentOptionTargets.customerPrototypeFilter",function(b){b?a.data[u("customerPrototype")]=b.pk:a.resetFilter("customerPrototype")});
var v={"update-status":{isUnlisted:"unchanged"},"update-customer-type-rate-pricing":{visibility:"unchanged",priceType:"unchanged",sheetRateType:"unchanged",isTaxable:"unchanged"}};a.currentOptionTargets={};a.data=p.data=p.data||{};a.$watch("data.updateForm",function(b){a.isRemoveAction="hide-availabilities"===b;a.data[b]||(a.data[b]={});_.defaults(a.data[b],v[b])});a.routes=f.routes.pickable({shortname:a.company.shortname});a.affiliations=f.affiliates.pickable({shortname:a.company.shortname});var y=
f.users({shortname:a.company.shortname});y.$promise.then(function(){a.users=l.User.sortActiveFirst(y)});a.roles=f.roles({shortname:a.company.shortname});a.bookingRestrictions=f.bookingRestrictions({shortname:a.company.shortname});if(a.item){a.customFieldInstanceGroups=f.customFieldInstanceGroups({shortname:a.company.shortname,itemPk:a.item.pk});a.requirementGroups=[];f.requirementGroups({shortname:a.company.shortname,itemPk:a.item.pk}).then(function(b){a.requirementGroups=b});a.customerPrototypes=
f.customerPrototypes.all({shortname:a.company.shortname,itemPk:a.item.pk});var q=f.totalSheets({shortname:a.item.company.shortname}),B=f.invoiceSheets({shortname:a.item.company.shortname});a.taxTypes=f.taxTypes({shortname:a.company.shortname});b.all([q.$promise,B.$promise,a.taxTypes.$promise]).then(function(){v["update-customer-type-rate-pricing"].taxTypes=_.keyBy(a.taxTypes,"pk",function(){return l.PriceLine.INHERIT_IS_TAXABLE});a.sheets=_.append(q,B);v["update-customer-type-rate-pricing"].sheet=
a.sheets.length?_.first(a.sheets):""})}a.FILTER_PREFIX="filters";var u=function(a){return"filters-"+a.replace("filters-","")};a.isFilterSet=function(b){return g.isSet(a.data[u(b)])};a.resetFilter=function(b){a.isDryRunComplete||delete a.data[u(b)]};a.isAnyWeekdaySet=function(){return _.any(l.Rule.WEEK_DAYS_KEYS,function(b){return!!a.data[u(b)]})};a.suggestedFilterNames=[];a.suggestedFilters={};a.suggestFilters=function(b){a.suggestedFilterNames=b;a.suggestedFilters=_.mapKeys(b)};a.data[u("startDate")]=
"";a.data[u("endDate")]="";a.minDate=m("1990-01-01");a.data.items={};_.forEach(p.initialSelectedItems,function(b){a.data.items[b.pk]=!0});var z=function(){return _.choose(p.allItems,function(b){return a.data.items[b.pk]?b:void 0})};a.numCheckedItems=function(b){var c=_.sum(a.data.items,function(a){return a?1:0});b.$setValidity("items",0<c);return c};var C=function(a){_.clear(p.highlightedAvailabilityPks);_.forEach(a,function(a,b){p.highlightedAvailabilityPks[a]=!0})},F=function(){C([]);a.isDryRunComplete=
!1;a.count=0},x=function(b,c){b.isDryRun=!1;"update-capacity"===b.updateForm&&!_.isNumber(b.capacity)&&!window.confirm(interpolate(nT("Are you sure you want to remove the capacity restriction from %(count)s availability?","Are you sure you want to remove the capacity restriction from %(count)s availabilities?",a.count),{count:a.count}))?a.cancel():f.availabilities.update({shortname:a.company.shortname},b,c).$promise.then(function(b){a.count=b.data.updateAvailabilities.count;d.success(a.isRemoveAction?
interpolate(nT("Removed %(count)s availability","Removed %(count)s availabilities",a.count),{count:a.count}):interpolate(nT("Updated %(count)s availability","Updated %(count)s availabilities",a.count),{count:a.count}));e.broadcast("lib.shared.CalendarCtrl.refresh");e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");F()},function(){d.error(T("Please try again"))})},w=function(b,c){e.broadcast("dashboard.shared.availabilityUpdater.beforeDryRun",{selectedItems:z()});b.isDryRun=!0;f.availabilities.update({shortname:a.company.shortname},
b,c).$promise.then(function(b){a.count=b.data.updateAvailabilities.count;a.isEmptyCount=!a.count;a.count&&(a.isDryRunComplete=!0,C(b.data.updateAvailabilities.pks))},function(a,b){})};a.$watch("isDryRunComplete",function(a){p.isCalendarFilteringDisabled=a});var G=function(a){var b=a.sheet;delete a.sheet;var c=a.sheetRate,c=l.PriceSheet.sheetRateFromModel(c);b.cls===l.TotalSheet.cls?(a.totalSheet=b.pk,c=l.TotalSheet.fromDisplaySheetRate(c)):b.cls===l.InvoiceSheet.cls&&(a.invoiceSheet=b.pk,c=l.InvoiceSheet.fromDisplaySheetRate(c,
b.relationship));a.sheetRate=l.PriceSheet.sheetRateToModel(c);return a};a.submit=function(b){var c={updateForm:a.data.updateForm};_.extend(c,a.data[a.data.updateForm]);_.extend(c,_.pick(a.data,function(b,c){var d;if(d="filters"===c.slice(0,7))if(d=a.isFilterSet(c))d=c,_.contains(r,a.data.updateForm)?d=!0:(d=d.replace("filters-",""),d=!_.contains(t,d));return d}));c.items=_.pluck(z(),"pk");"update-customer-type-rate-pricing"===c.updateForm&&G(c);a.isDryRunComplete?x(c,b):w(c,b)};a.cancel=function(){a.isDryRunComplete?
F():p.isOpen=!1};a.goToCreateAvailabilitiesForm=function(){e.broadcast("dashboard.shared.availabilityUpdater.createAvailabilities",{date:a.data[u("startDate")]})};a.$on("$destroy",function(){F()})}]);h.controller("dashboard.shared.AnalyticsServiceEditableCtrl",["$scope","db","require","controllers","events","flash","navigation","urls",function(a,b,f,e,g,d,l,m){f.inScope(a,"analyticsService","dashboard.shared.analyticsServiceEditableCtrl");f.inScope(a,"analyticsServices","dashboard.shared.analyticsServiceEditableCtrl");
return e.editController(a,{collectionKey:"analyticsServices",elementKey:"analyticsService",jsonFieldKeys:["customIdentifiers"],modelKey:"editableAnalyticsService",update:b.analyticsService.update,remove:b.analyticsService.remove,editing:!0,params:function(){return{shortname:a.analyticsService.company.shortname,analyticsServicePk:a.analyticsService.pk}},successCallback:function(){g.broadcast("dashboard.shared.analyticsServiceEditableCtrl.updated");g.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},
removeCallback:function(){d.success(T("Deleted analytics service"));l.navigate(a.analyticsService.company.$url(m.dashboard.settings.analyticsServices.index))}})}]);h.controller("dashboard.shared.SuggestedItemsCtrl",["$scope","db","require",function(a,b,f){f.inScope(a,"company","dashboard.shared.SuggestedItemsCtrl");a.flowNodes=b.flowNodes.pages({shortname:a.company.shortname})}]);h.controller("dashboard.shared.CalendarSubscribeCtrl",["$scope","auth","controllers","db","models","require",function(a,
b,f,e,g,d){d.inScope(a,"company","dashboard.shared.CalendarSubscribeCtrl");!b.isAuthenticatedForAdminCompany()&&!b.currentUser.calendarToken&&(a.submitted=!1,f.createController(a,{modelKey:"newResellerKey",create:e.resellerKeys.create,successCallback:function(){a.submitted=!0;e.user({shortname:b.currentUser.company.shortname,username:b.currentUser.username})},params:{shortname:b.currentUser.company.shortname,username:b.currentUser.username},defaultModel:{name:g.User.ICS_RESELLER_KEY_NAME}}))}])})();
(function(){var h=angular.module("dashboard.services",["lib.services"]);h.factory("popovers",["$compile","$rootScope","$templateCache","require","shortcuts",function(b,a,c,f,e){angular.element("html").on("click",function(a){a=angular.element(a.target);!a.is(".ng-open-popover, .ng-popover-link, [ng-preserve-popover]")&&!a.parents(".ng-open-popover, .ng-popover-link, [ng-preserve-popover]").length&&a.closest("html").length&&m.closeAll()});var g,d=function(){a.$apply(function(){m.closeAll()})},l={},
m={register:function(a,d,e){f.assert(a,"popovers.register: expected template name: "+a);f.assert(!l[a],"popovers.register: already registered: "+a);var g=c.get(a);f.assert(g,"popovers.register: expected template: "+a);g=b(g);l[a]={templateFn:g,containerElement:d,referenceElement:null,childElement:null,childScope:null,currentKey:null,options:e||{}}},unregister:function(a){f.assert(a,"popovers.unregister: expected template name: "+a);f.assert(l[a],"popovers.unregister: not registered: "+a);m.close(a);
delete l[a]},popover:function(a){var b=l[a];f.assert(b,"popovers.popover: not registered: "+a);return b},reopen:function(a,b,c,d){var e=m.popover(a);f.assert(e,"popovers.popover: not registered: "+a);e.currentKey===d&&(e.referenceElement=c,b.$evalAsync(function(){e.referenceElement.addClass("current")}))},open:function(a,b,c,h,r,t){c.addClass("ng-open-popover");f.assert(a,"popovers.open: expected template name: "+a);var v=l[a];f.assert(v,"popovers.open: not registered: "+a);h=h||c;var y=h===v.currentKey;
r?m.closeAll():m.close(a);y||(v.childScope=b.$new(),v.templateFn(v.childScope,function(a){var b=v.options.x||0,f=v.options.y||0,k=_.isUndefined(v.options.width)?a.width():v.options.width;v.referenceElement=c;v.childElement=a;v.currentKey=h;c.addClass("current");for(var l=c.position(),m=v.containerElement[0].clientWidth,n=c.outerWidth(!0),r=c.offsetParent(),y;r[0]!==v.containerElement[0];){y=r.position();l.top+=y.top;l.left+=y.left;y=r.offsetParent();if(y[0]===r[0]||!y.length)break;r=y}y={top:l.top+
v.containerElement.scrollTop()+f};var M=!1,r=f=!1;if(t){var f=!0,K=v.containerElement.offset(),K=t.pageX-K.left+$(window).scrollLeft();l.left=Math.max(K-34,0);l.left>m-k&&(r=K-(m-k)>k/2,l.left=m-k)}else f=v.options.isFlushLeft?!0:(M=l.left+n+k+b+80>m)&&l.left<k+b;f?(y.left=l.left-b,y.top+=c.outerHeight(!0)):M?y.right=m-l.left-b:y.left=l.left+n-b;a.css(y);b=f?"top":M?"right":"left";f&&(b+=r?" arrow-right":" arrow-left");a.addClass("ng-popover "+b);v.containerElement.append(a);g||(g=e.register({keySet:"esc",
action:d}))}))},close:function(a){f.assert(a,"popovers.register: expected template name: "+a);var b=l[a];f.assert(b,"popovers.register: not registered: "+a);b.referenceElement&&b.referenceElement.removeClass("current");b.referenceElement=null;b.childElement&&b.childElement.remove();b.childElement=null;b.childScope&&b.childScope.$destroy();b.childScope=null;b.currentKey=null;g&&e.unregister(g);g=null},closeAll:function(){_.forEach(l,function(a,b){m.close(b)})}};return m}]);h.factory("availabilityUpdater",
[function(){return function(b){var a=_.extend({isOpen:!1,company:null,allItems:null,initialSelectedItems:null,startDate:null,endDate:null,onOpen:_.ignore,open:function(){a.isOpen||(a.isOpen=!0,a.onOpen())},close:function(){a.isOpen=!1},highlightedAvailabilityPks:{}},b);return a}}]);h.factory("stickyHeaders",[function(){var b={},a=function(a,f){var e=b[a];if(!e)return console.warn("stickyHeaders: invalid group:",a),!1;var g=e.elements;return!g[f]?(console.warn("stickyHeaders: no element for group:",
e,"identifier:",f),!1):[e,g]};return{addElement:function(a,f,e){b[a]=b[a]||{currentIdentifier:"",elements:{}};b[a].elements[f]=e;e.css("display","none")},removeElement:function(b,f){var e=a(b,f);if(e){var g=e[0];delete e[1][f];g.currentIdentifier===f&&(g.currentIdentifier="")}},updateGroup:function(b,f){var e=a(b,f);if(!e)return!1;var g=e[0],e=e[1];if(g.currentIdentifier===f)return!1;g.currentIdentifier=f;_.forEach(e,function(a){a.css("display","none")});e[f].css("display","");return!0}}}]);h.factory("pagination",
["$q",function(b){return{endpoint:function(a,b){return function(f,e){return a(b,null,null,f,e)}},constant:function(a){a.$promise=b.when(a);return _.constant(a)}}}])})();
(function(){var h=angular.module("dashboard.directives",["db.services","lib.filters"]);h.directive("ngActivities",["auth","models",function(a,b){return{restrict:"A",scope:!0,templateUrl:"ng-activities",controller:["$scope","$attrs",function(f,e){var g=this;g.isNoteEnabled=f.isSet(e.ngActivitiesNote);g.header=f.$interpolate(e.ngActivitiesHeader)||"";g.forceShowLinks=f.isSet(e.ngActivitiesForceShowLinks);g.canList=!1;var d=function(d){_.isArray(d)?(f.activityObject=null,f.activityObjectsKey=e.ngActivities):
(f.activityObject=d,f.activityObjectsKey=null);g.canList=f.activityObject?a.permissions.canList(b.Activity,b.Company.forObject(d)):f.activityObjectsKey?_.all(d,function(d){return a.permissions.canList(b.Activity,b.Company.forObject(d))}):!1};d(f.$eval(e.ngActivities));f.$watch(e.ngActivities,d)}],controllerAs:"objectActivitiesCtrl"}}]);h.directive("ngProcessorIdentifier",["$parse",function(a){return{restrict:"A",scope:!0,templateUrl:"dashboard.processorIdentifier",compile:function(b,f){var e=f.ngProcessorIdentifier?
a(f.ngProcessorIdentifier):null,g=f.ngProcessorIdentifierIdentifier?a(f.ngProcessorIdentifierIdentifier):null,d=f.ngProcessorIdentifierCompany?a(f.ngProcessorIdentifierCompany):null;return function(a,b){var c=e?e(a):a.instance;a.processorIdentifier=g?g(a):c.processorIdentifier;a.processorType=c.processorType;a.company=d?d(a):c.company}}}}]);h.directive("ngLanguageDropdown",["db","models","require",function(a,b,f){return{controllerAs:"languageDropdownCtrl",controller:["$attrs","$scope",function(e,
g){f.inScope(g,"company");var d=this,l=!g.isSet(e.ngLanguageDropdownHideUnsupportedLanguages),m=function(a,d){d=d||"";return _.map(a,function(a){return{code:a,display:b.SupportedLanguage.display(a)||a,group:d}})};d.isLoading=!0;var k=a.understoodLanguages({shortname:g.contact?g.contact.company.shortname:g.company.shortname});k.$promise.then(function(){var a=[],e=k.full,f=k.partial,h=b.SupportedLanguage.LANGUAGE_CODES_SORTED,h=l?_.difference(h,e,f):[];if(g.contact&&g.contact.language&&!b.SupportedLanguage.isRecognizedLanguage(g.contact.language)){var a=
[g.contact.language],t=b.SupportedLanguage.rootLanguage(g.contact.language);b.SupportedLanguage.isRecognizedLanguage(t)&&(e=_.without(e,t),f=_.without(f,t),h=_.without(h,t))}a=m(a);e=m(e,T("Translation available"));f=m(f,T("Limited translation available"));h=m(h,T("No translation available"));d.languageChoices=_.append(a,e,f,h);g.$applyAsync(function(){d.isLoading=!1})});d.languageChoices=m(g.contact?[g.contact.language]:[])}]}}]);var b=function(a,b){h.directive("ng"+a,["popovers",function(a){return{restrict:"A",
link:function(f,d,l){a.register(b.template,d,b.popoverOptions);f.$on("$destroy",function(){a.unregister(b.template)})}}}]);var f="ngOpen"+a;h.directive(f,["$injector","$parse","d","popovers","require",function(a,g,d,l,m){return{compile:function(k,h){var s=g(h[f]),p=d.safeInvoke(a,b.link),r=_.isUndefined(h.ngOpenPopoverPreservingOthers),t=!_.isUndefined(h.ngOpenPopoverNearCursor);return function(a,d,e){var g=s(a);m.assert(g,f+": expected instance: "+h[f]);a[b.instanceKey]=g;var k=function(e){var f=
[b.template,a,d,g,r];t&&e&&f.push(e);l.open.apply(l,f)},z=p&&p(a,d,e)||k;l.reopen(b.template,a,d,g);d.on("click",function(a){z(a,_.partial(k,a))})}}}}]);h.directive("ngClose"+a,["popovers",function(a){return{link:function(f,d,l){d.on("click",function(d){a.close(b.template)})}}}])};b("AvailabilityPopover",{instanceKey:"availability",template:"availability-popover",popoverOptions:{x:8,y:4,width:176},link:["$filter","navigation","rebook","require","urls",function(a,b,f,e,g){return function(d,e,m){d.resource=
d.$eval(m.ngOpenAvailabilityPopoverResource)||null;d.needsCalBlock=!_.isUndefined(m.ngOpenAvailabilityPopoverWithCalBlock);return function(e,l){var h=m.ngOpenAvailabilityPopoverWhen?d.$eval(m.ngOpenAvailabilityPopoverWhen):!0;d.$apply(function(){!e.shiftKey&&(!e.ctrlKey&&!e.metaKey&&!e.altKey)&&(h?l():f.currentBooking?b.navigate(d.availability.$url(g.company.item.book)):b.navigate(a("availabilityUrl")(d.availability)))})}}}]});b("AggregatedUsePopover",{instanceKey:"aggregatedUse",template:"aggregated-use-popover",
popoverOptions:{x:0,y:0,width:280},link:["$q","db",function(a,b){return function(a,e,g){var d=a.popoverCtrl={date:a.$eval(g.ngOpenAggregatedUsePopoverDate),view:"main",bookings:[],availabilities:[]},l=function(b,c,e){_.extend(c,{shortname:a.company.shortname});var g=b(c);g.$promise.then(function(){d[e]=g})},m=_.map(a.aggregatedUse.bookings,"uuid"),k=_.uniq(_.map(a.aggregatedUse.bookings,"availability.pk"));d.hasOneBookingAndAvailability=1===m.length&&1===k.length;return function(d,e){a.aggregatedUse.bookings.length&&
(l(b.bookings.searchByUuid,{bookingUuids:m},"bookings"),l(b.availabilities.searchByPk,{availabilityPks:k},"availabilities"));e()}}}]});b("CreateUsePopover",{instanceKey:"resource",template:"create-use-popover",popoverOptions:{x:0,y:0,width:280},link:["$q","db","require","dashboard.bookings.timeline",function(a,b,f,e){var g={},d=function(d,e){var f=d.format("YYYY-MM-DD"),h=f+":"+e.pk;if(g[h]&&g[h].timestamp+6E5>Date.now())return a.when(g[h].availabilities);var s=b.resource.availabilities({shortname:e.company.shortname,
resourcePk:e.pk,date:f});return s.$promise.then(function(){g[h]={timestamp:Date.now(),availabilities:s};return s})};return function(a,b,c){var g=a.popoverCtrl={};g.date=a.$eval(c.ngOpenCreateUsePopoverDate);g.range=a.$eval(c.ngOpenCreateUsePopoverRange);f.assert(g.date||g.range,"ngOpenCreateUsePopover: Expected date or range.");return function(b,c){g.$promise=d(g.range.startAt||g.date,a.resource).then(function(a){g.range&&(a=_.filter(a,e.overlapsWith(g.range,!0)));g.noAvailabilities=!a.length;var b=
_.groupBy(a,"item.uri"),c=_.map(b,"[0].item");g.isGrouped=1<c.length&&_.any(b,function(a){return 1<a.length});g.availabilities=g.isGrouped?null:a;g.items=_.sortBy(c,"sortableIndex");g.selectedItem=null;g.selectItem=function(a){g.availabilities=a?b[a.uri]:null;g.selectedItem=a}});c()}}}]});b("TotalCapacityOverviewRangePopover",{instanceKey:"range",template:"total-capacity-overview-range-popover",popoverOptions:{x:0,y:0,width:280},link:[function(){return function(a,b,f){a.popoverCtrl={date:a.$eval(f.ngOpenTotalCapacityOverviewRangePopoverDate)}}}]});
b("ResourceOverridePopover",{instanceKey:"override",template:"resource-override-popover",popoverOptions:{x:0,y:0,width:280},link:[function(){return function(a,b,f){a.popoverCtrl={date:a.$eval(f.ngOpenResourceOverridePopoverDate)}}}]});b("FlowNodePopover",{instanceKey:"flowNode",template:"flow-node-popover",popoverOptions:{x:-2,y:-53,width:280,isFlushLeft:!0},link:["auth","require","toggles","popovers",function(a,b,f,e){return function(g,d,l){l=e.popover("flow-node-popover");g.flowNode===l.currentKey&&
(e.close("flow-node-popover"),e.open("flow-node-popover",g,d,g.flowNode));return function(d,e){b.inScope(g,"flowNode");b.inScope(g,"expandFlowPage");var l=a.permissions.canUpdate(g.flowNode),h=(d.shiftKey||d.altKey)&&!d.controlKey&&!d.metaKey;g.$apply(function(){d.preventDefault();d.stopPropagation();!l||h?g.expandFlowPage(g.flowNode):(f.closeAll(),e())})}}}]});b("SupportedLanguagesPopover",{instanceKey:"field",template:"supported-languages-popover",popoverOptions:{x:-35,y:3,width:280,isFlushLeft:!0,
isBottomArrowRight:!0},link:["$parse","$q","auth","cache","db","models","navigation","parseAttrsForScope","urls",function(a,b,f,e,g,d,l,m,k){return function(a,f,l){var h=null,t=m(l,a,{fieldName:"@",parentField:"=",fieldNgModel:"&"},"ngOpenSupportedLanguagesPopover"),v=t.fieldName;t.parentField&&(h=t.fieldName,v=t.parentField);var y=function(){var b={shortname:a.company.shortname},c=k.populate(k.api.supportedLanguages,b),c=e.read(c,!0);c.$fresh&&(c=g.supportedLanguages(b));return c};return function(e,
f){var k=a.popoverCtrl={};k.status="loading";var l=t.fieldNgModel,m=l(a),l={shortname:a.company.shortname,objectType:m.cls,objectId:m.pk,objectField:v};h&&(l.subfield=h,a.subfield=h);k.supportedLanguages=y();var p=h?g.translationsForSubfield(l):g.translationsForField(l);k.fetchTranslatedFieldValue=function(a){a=k.fieldValueTranslation[a];return h?a.fieldValue[h]:a.fieldValue};k.translationOverlayUrl=function(b){return d.Translation.translationOverlayUrl(v,m,a.company.shortname,b.pk,h)};b.all([k.supportedLanguages.$promise,
p.$promise]).then(function(){k.fieldValueTranslation={};_.forEach(k.supportedLanguages,function(a){var b=_.find(p.translationsForField,function(b){return b.supportedLanguage.pk===a.pk})||{fieldValue:null};k.fieldValueTranslation[a.pk]=b});k.status="success"},function(){k.status="error"});f()}}}]});h.directive("ngPasswordGenerator",["$parse","events",function(a,b){var f=/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}$/;return{restrict:"A",templateUrl:"dashboard.passwordGenerator",require:["^form","ngPasswordGenerator"],
controller:function(){var a=this;a.model={};a.update=function(b,c){a.model=b;a.field=c};a.password="";a.generate=function(){for(var b="";!b;){for(var c=0;10>c;c++)b+="abcdefghijknpqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ23456789$#*!@?".charAt(Math.floor(61*Math.random()));f.test(b)||(b="")}a.password=a.model.password=a.model.verifyPassword=b;a.field&&a.field.$setDirty();return b}},compile:function(b,c){var d=a(c.ngPasswordGenerator),f=a(c.ngPasswordGeneratorField);return function(a,b,c,e){var g=e[0];a.generatorCtrl=
e[1];a.generatorCtrl.update(d(a),g[f(a)]);a.$watch(_.bind(d,null,a),function(){a.generatorCtrl.update(d(a),g[f(a)])})}}}}]);h.directive("ngRuleForm",["$parse","models",function(a,b){return{require:["form"],controllerAs:"ruleFormCtrl",controller:["$scope","$attrs","$parse",function(a,e,g){var d=this;d.startTime=null;d.endTime=null;d.days=null;d.rule=null;d.periods=[];var l=function(a,b){return"period"+a.index.toString()+"-"+b},m=function(a){delete d.rule[l(a,"time")];delete d.rule[l(a,"hours")]},k=
function(a){d.rule[l(a,"time")]=a.time;d.rule[l(a,"hours")]=a.hours};d.addPeriod=function(){var a={time:"",hours:"",startTime:"",endTime:"",days:"",index:d.periods.length};if(1===d.periods.length){var b=d.periods[0];a.time=moment(b.time,"HH:mm").add(b.hours,"hours").format("HH:mm");a.hours=b.hours;a.days=b.days}else if(1<d.periods.length){var b=d.periods[d.periods.length-1],c=d.periods[d.periods.length-2].time,e=b.time,c=moment(e,"HH:mm").diff(moment(c,"HH:mm")),e=moment(e,"HH:mm").add(c,"ms").format("HH:mm");
a.time=e;a.hours=b.hours;a.days=b.days}d.periods.push(a);d.rule&&k(a)};d.removePeriod=function(a){1>=d.periods.length||(m(a),_.ref.remove(d.periods,a),_.forEach(d.periods,function(a,b){m(a);a.index=b;k(a)}))};d.isDayFieldsValid=function(){return d.rule.repeat!==b.Rule.WEEKLY_REPEAT?!0:_.any(b.Rule.WEEK_DAYS_KEYS,function(a){return d.rule[a]})};var h=g(e.ngRuleForm||"");a.$watch(function(){return(h(a)||{}).startOn||""},function(a){a&&(d.startAt=moment(a,"YYYY-MM-DD"))});a.$watch(h,function(a){d.rule=
a;_.clear(d.periods);d.periods.length||d.addPeriod();d.periods[0].hours=_.isNumber(d.rule.hours)?d.rule.hours:"";d.periods[0].time=d.rule.time||"";_.forEach(d.periods,function(a){k(a)});d.rule.periodCount=d.periods.length});a.$watch(function(){d.rule&&d.rule.startOn&&(_.forEach(d.periods,function(a){a.time=d.rule[l(a,"time")];a.hours=d.rule[l(a,"hours")];a.startTime=moment(d.rule.startOn+" "+a.time,"YYYY-MM-DD HH:mm");a.endTime=a.startTime.clone().add("hours",a.hours||0);var b=a.startTime.clone().startOf("day");
a.days=a.endTime.diff(b,"days")}),d.rule.periodCount=d.periods.length)})}]}}]);h.directive("ngWaiver",["$parse","$window","auth","events","native","navigation","require","urls",function(a,b,f,e,g,d,l,m){return{scope:!0,restrict:"A",compile:function(b,c){var e=a(c.ngWaiver),g=a(c.ngWaiverBooking);return function(a,b,c){b.on("click",function(){var b=e(a),c=g(a),b=c.company.smartwaiverUrl+"?auto_waiverid="+b.waiverUuid+"&auto_tag=fh_id_"+c.pk;f.storage.set("smartwaiverBookingUri",d.url);d.navigate(b)})}}}}]);
h.directive("ngPortionCalculator",["$parse","toggles",function(a,b){return{restrict:"A",templateUrl:"dashboard.portionCalculator",scope:!0,controller:["$scope","$attrs",function(f,e){var g=this;g.currency=f.$eval(e.ngPortionCalculatorCurrency);g.toggleValue=e.ngPortionCalculatorToggleValue?a(e.ngPortionCalculatorToggleValue)(f):!1;g.labelsKey=e.ngPortionCalculatorLabelsFor;var d=e.ngPortionCalculatorExclude?a(e.ngPortionCalculatorExclude)(f):[];g.needsField=function(a){return!_.includes(d,a)};g.total=
a(e.ngPortionCalculator)(f);var l=a(e.ngPortionCalculatorModel);g.max=e.ngPortionCalculatorMax?a(e.ngPortionCalculatorMax)(f):g.total;g.result=null;g.remaining=null;g.percentage=null;var m=function(a){0<=a&&a<=g.max&&isFinite(a)&&(g.result=a||0,g.remaining=g.total-a,g.percentage=0===g.total?0:_.roundHalfToEven(100*(a/g.total),2),0===g.percentage&&(g.percentage=null))};m(l(f));f.$watch(l,m);g.updateFromPercentage=function(){if(!isNaN(g.percentage)){var a;a=0>=g.percentage||100<g.percentage?0:_.roundHalfToEven(g.percentage/
100*g.total);g.result=Math.min(a,g.max);g.remaining=g.total-g.result}};g.updateFromRemaining=function(){if(!isNaN(g.remaining)){var a;a=0>g.remaining||g.remaining>=g.total?0:_.roundHalfToEven(g.total-g.remaining);g.result=Math.min(a,g.max);g.percentage=0===g.total?0:_.roundHalfToEven(100*(g.result/g.total),2)}};g.useResult=function(){0>=g.result||g.result>g.max||(l.assign(f,g.result),g.toggleValue&&b.toggle(g.toggleValue,!1))}}],controllerAs:"portionCalculatorCtrl"}}]);h.controller("AvailabilityResourceUsesCtrl",
["$scope","$attrs","db","urls",function(a,b,f,e){var g=this;g.status="loading";g.availability=a.$eval(b.ngAvailabilityResourceUses);g.resourceUses=f.availability.resourceUses({shortname:g.availability.item.company.shortname,itemPk:g.availability.item.pk,availabilityPk:g.availability.pk});var d=g.availability.startAt.format("YYYY-MM-DD");g.resourceUsesRows=[];g.resourceUses.$promise.then(function(a){g.resourceUsesRows=_.sortBy(_.values(_.reduce(g.resourceUses,function(a,b){var c=b.resourceRequirement.resource,
f=c.uri;a[f]={dayViewUrl:e.populate(e.dashboard.resources.resource.uses.day,{shortname:c.company.shortname,resourcePk:c.pk,date:d}),resourceName:c.name,useCount:a[f]?a[f].useCount+b.useCount:b.useCount};return a},{})),"resourceName");g.status="success"},function(){g.status="error"})}]);h.directive("ngAvailabilityResourceUses",[function(){return{restrict:"A",templateUrl:"availabilityResourceUses",controller:"AvailabilityResourceUsesCtrl",controllerAs:"resourceUsesCtrl"}}]);h.directive("ngActivityFlyout",
["$parse","auth","db","models","require",function(a,b,f,e,g){return{templateUrl:"activity-flyout",link:function(a,l,m){g.inScope(a,"activity");a.canToggleAdminOnlyStatus=b.permissions.can("toggleAdminOnlyStatus",a.activity);a.showActivityLink=a.activity.object.cls!==e.Activity.cls&&a.activity.pk!==parseInt(a.route.bindings.activityPk);a.adminOnlyText=function(){return e.Activity.isAdminOnly(a.activity)?T("Make not admin-only"):T("Make admin-only")};a.toggleAdminOnly=function(){b.permissions.can("toggleAdminOnlyStatus",
a.activity)?f.activity.update({shortname:a.activity.company.shortname,activityPk:a.activity.pk},{isAdminOnly:!e.Activity.isAdminOnly(a.activity)}):console.error("Activity admin-only status cannot be changed.")}}}}]);h.directive("ngAnalyticsServiceForm",["$parse",function(a){return{controller:["$scope","$attrs","models",function(a,b,e){var g=a.$eval(b.ngAnalyticsServiceForm),d=null;a.$watch(_.getter(g,"type"),function(a){a===e.AnalyticsService.OPTIMIZELY_TYPE?(d=g.isCrossDomainOnly,g.isCrossDomainOnly=
!0):null!==d&&(g.isCrossDomainOnly=d,d=null)})}]}}]);h.directive("ngRangeField",["dateUtils",function(a){return{restrict:"A",scope:!0,require:["^form","?ngResettableFilter","ngRangeField"],controllerAs:"rangeFieldCtrl",controller:function(){this.isInverted=!1},link:function(b,f,e,g){var d=g[0],l=g[1],m=g[2];b.$watchCollection(e.ngRangeField,function(b){m.isInverted=a.isInvertedRange(b);d.$setValidity("rangeField",!m.isInverted);l&&(l.isInvalid=m.isInverted)})}}}]);h.directive("ngCompanyTypeField",
[function(){return{restrict:"A",scope:!0,require:["^form"],controller:function(){},link:function(a,b,f,e){var g=e[0];a.$watchCollection(f.ngCompanyTypeField,function(){g.$setValidity("companyFieldType",g.isCharter.$modelValue||g.isAffiliate.$modelValue)})}}}]);h.directive("ngFieldOrBoolean",["$parse",function(a){return{scope:!0,transclude:!0,templateUrl:"field-or-boolean",controllerAs:"fieldCtrl",require:"fieldCtrl",controller:["$scope","$attrs","$parse",function(a,b,e){var g=this,d=e(b.ngFieldOrBoolean);
e(b.ngFieldOrBooleanType);var l=e(b.ngDisabled);e=e(b.ngFieldOrBooleanLabels)(a)||{};b=a.$eval(b.ngFieldOrBooleanAllowEmpty);g.types=[{type:"exact",label:e.exact||T("is")},{type:"non-empty",label:e["non-empty"]||T("is set")}];!1!==b&&g.types.push({type:"empty",label:e.empty||T("is empty")});var m;a.$watch(d,function(a){g.type=!1===a?"empty":!0===a?"non-empty":"exact";"exact"===g.type&&(m=a)});a.$watch("fieldCtrl.type",function(b){"exact"===b?d.assign(a,m):"empty"===b?d.assign(a,!1):"non-empty"===
b&&d.assign(a,!0)});a.$watch(l,function(a){g.isDisabled=a})}]}}]);h.directive("ngResettableFilters",["$parse",function(a){return{scope:!0,controllerAs:"resettableFiltersCtrl",controller:function(){var a=[];this.addFilter=function(b){a.push(b)};this.removeFilter=function(b){_.overwriteWithout(a,b)};this.isAnyFilterSet=function(){return _.any(a,function(a){return a.isFilterSet()})};this.resetAll=function(){return _.invoke(a,"resetFilter")}}}}]);h.directive("ngResettableFilter",["$parse",function(a){return{scope:!0,
require:["^ngResettableFilters","ngResettableFilter"],transclude:!0,templateUrl:"dashboard.resettableFilter",controllerAs:"resettableFilterCtrl",controller:function(){this.isFilterSet=_.never;this.resetFilter=_.ignore;this.isRequired=this.isInvalid=!1},compile:function(b,f){var e=a(f.ngResettableFilterIsSet),g=a(f.ngResettableFilterReset);return function(a,b,c,k){var h=k[0],s=k[1];s.isFilterSet=_.bind(e,s,a);s.resetFilter=_.bind(g,s,a);h.addFilter(s);c.$observe("ngResettableFilter",function(a){s.name=
a});a.$watch(f.ngResettableFilterIsRequired,function(a){s.isRequired=!!a;s.isRequired&&(s.isToggled=!0)});s.toggle=function(){s.isToggled=s.isRequired||!s.isToggled};a.$on("$destroy",function(){h.removeFilter(s)})}}}}]);h.directive("ngMultipleChoiceField",["$parse","$filter",function(a,b){return{templateUrl:"ngMultipleChoiceField",scope:!0,controllerAs:"multipleChoiceCtrl",transclude:!0,require:["ngMultipleChoiceField","^?ngModel"],controller:["$scope","$attrs",function(b,c){var g=this;g.NONE_CHOICE=
"none";g.ANY_CHOICE="any";g.showNoneChoice=b.$eval(c.ngMultipleChoiceFieldShowNoneChoice);g.showAnyChoice=b.$eval(c.ngMultipleChoiceFieldShowAnyChoice);g.defaults=b.$eval(c.ngMultipleChoiceFieldDefaults);g.isRequired=b.$eval(c.ngMultipleChoiceFieldRequired);var d=a(c.ngMultipleChoiceField);b.$watch(d,function(a){g.selections=a;_.isPlainObject(a)||(g.selections=_.toTrueKeys(a),d.assign(b,g.selections));_.ref.compactObject(g.selections);g.setValidity()});g.onChange=function(a){g.selections[a]||delete g.selections[a];
a===g.ANY_CHOICE&&g.selections[a]&&_.ref.pick(g.selections,[g.NONE_CHOICE,g.ANY_CHOICE]);g.ngModelCtrl&&(g.setValidity(),g.ngModelCtrl.$setDirty())};g.setValidity=function(){g.ngModelCtrl&&g.isRequired&&g.ngModelCtrl.$setValidity("required",_.any(g.selections))};g.selectAllCallback=function(){_.ref.compactObject(g.selections);g.ngModelCtrl&&(g.setValidity(),g.ngModelCtrl.$setDirty())}}],link:function(a,b,c,d){d[0].ngModelCtrl=d[1]}}}]);h.directive("ngMultipleChoiceFieldChoices",["$parse","$filter",
function(a,b){return{templateUrl:"ngMultipleChoiceFieldChoices",require:["^ngMultipleChoiceField","ngMultipleChoiceFieldChoices"],scope:!0,controllerAs:"choicesCtrl",controller:["$scope","$attrs",function(f,e){var g=this;g.$id="choices-"+f.$id;var d=a(e.ngMultipleChoiceFieldChoices);g.choices=d(f);f.$watchCollection(d,function(a){g.choices=a});var d=f.$eval(e.ngMultipleChoiceFieldChoicesValueField),l=f.$eval(e.ngMultipleChoiceFieldChoicesNameField);g.valueField=d?_.makeIteratee(d):b("value");g.nameField=
l?_.makeIteratee(l):b("name");g.showSelectAll=f.$eval(e.ngMultipleChoiceFieldChoicesShowSelectAll);e.$observe("ngMultipleChoiceFieldChoicesEmptyNote",function(a){g.emptyNote=a});g.header=f.$eval(e.ngMultipleChoiceFieldHeader);g.allowToggle=f.$eval(e.ngMultipleChoiceFieldAllowToggle)}]}}]);h.directive("ngFormatJson",["$parse","moment",function(a,b){return{templateUrl:"dashboard.ngFormatJson",restrict:"A",compile:function(f,e){var g=a(e.ngFormatJson);return function(a){a.data=g(a);a.data.data&&(a.data=
a.data.data);a.isTable=function(a){return _.isArray(a)&&a.length&&_.all(a,_.isPlainObject)};a.isList=function(a){return _.isArray(a)&&a.length&&!_.all(a,_.isPlainObject)};a.isPlainObject=_.isPlainObject;a.asMoment=function(a){if(_.isString(a))return a=b(a),a.isValid()?a:void 0};a.keys=function(a){return _.choose(a,function(a,b){return"$$hashKey"===b?void 0:b})}}}}}]);h.directive("ngStickyTableHeader",["stickyHeaders",function(a){return{restrict:"A",link:function(b,f,e){var g=b.$eval(e.ngStickyTableHeader);
e=e.ngStickyTableHeaderGroup;a.addElement(e,g,f);b.$on("$destroy",_.partial(a.removeElement,e,g))}}}]);h.directive("ngStickyTableHeaderLink",["stickyHeaders",function(a){var b=/(auto|scroll)/;return{restrict:"A",link:function(f,e,g){var d=g.ngStickyTableHeaderWhenOnce;if(!d||f.$eval(d)){var l=f.$eval(g.ngStickyTableHeaderLink),m=g.ngStickyTableHeaderGroup,k=e.parents().filter(function(){var a=$(this);return b.test(a.css("overflow")+a.css("overflow-y")+a.css("overflow-x"))}).eq(0)||$(document);g=function(){var b=
e.offset().top-k.offset().top;0>=b&&0<b+e.outerHeight()&&a.updateGroup(m,l)&&f.$digest()};var h=_.debounce(g,0),s=_.debounce(g,10);f.$watch(h);k.on("scroll",s);f.$on("$destroy",function(){k.off("scroll",s);h.cancel();s.cancel()})}}}}]);h.directive("ngScrollResetTo",["$parse","$timeout",function(a,b){return{restrict:"A",link:function(f,e,g){var d=g.ngScrollResetTo,l=g.ngScrollResetDelay||1500,m=g.ngScrollResetPadding||0,k=g.ngScrollResetAnimationDuration||500,h=g.ngScrollResetWatch?a(g.ngScrollResetWatch):
_.ignore,s=function(){var a=e.find(d).eq(0);if(a.length){var b=e.offset(),c=a.offset(),f=c.left-b.left,b=c.top-b.top;(0>f||f+a.width()>e.width())&&e.animate({scrollLeft:e.scrollLeft()+f-m},k);(0>b||b+a.height()>e.height())&&e.animate({scrollTop:e.scrollTop()+b-m},k)}},p,r=function(){p&&b.cancel(p);p=b(s,l)},t,v=_.debounce(function(){var a=h(f);a!==t?(t=a,s()):r()},0),y=_.debounce(r,10);f.$watch(v);e.on("scroll",y);f.$on("$destroy",function(){e.off("scroll",y);v.cancel();y.cancel()})}}}]);h.controller("CustomFieldManagerCtrl",
["$scope","$attrs","$q","controllers","db","events","flash","require","toggles",function(a,b,f,e,g,d,l,m,k){var h=this,s=a.$eval(b.ngCustomFieldManager);m.assert(s,"ng-custom-field-manager: expected item or items");_.isArray(s)||(s=[s]);m.inScope(a,"company","dashboard.items.item.ManageCustomFieldInstancesCtrl");m.inScope(a,"customFields","dashboard.items.item.ManageCustomFieldInstancesCtrl");h.items=s;h.allCustomFields=a.customFields;h.allCustomerPrototypes=[];h.allCustomFieldInstanceGroups=[];h.data=
{updateType:"create"};var p=function(){var a=[],b={};_.forEach(s,function(c){var d=g.customerPrototypes({shortname:c.company.shortname,itemPk:c.pk},null,null,null,{tagAlong:!0});a.push(d.$promise);var e=g.customFieldInstanceGroups({shortname:c.company.shortname,itemPk:c.pk},null,null,null,{tagAlong:!0});a.push(e.$promise);b[c.uri]={customerPrototypes:d,customFieldInstanceGroups:e}});return f.all(a).then(function(a){h.byItem=b;h.allCustomerPrototypes=_.flatten(_.pluck(h.byItem,"customerPrototypes"));
h.allCustomFieldInstanceGroups=_.flatten(_.pluck(h.byItem,"customFieldInstanceGroups"));r()})},r=function(){if("remove"===h.data.updateType){var a={},b=_.append(h.allCustomerPrototypes,h.allCustomFieldInstanceGroups);_.forEach(b,function(b){_.forEach(b.customFieldInstances,function(b){a[b.customField.uri]=!0})});h.customFields=_.filter(h.allCustomFields,function(b){return a[b.uri]})}else h.customFields=h.allCustomFields},t=function(a){return!!h.data[_.uncapitalize(a.cls+a.pk+_.capitalize("isSelected"))]&&
h.isSelectable(a)};h.isAnySelected=function(){return _.any(h.allCustomerPrototypes,t)||_.any(h.allCustomFieldInstanceGroups)};h.isSelectable=function(a){return _.isArray(a)?_.any(a,h.isSelectable):!h.data.customField?!0:"remove"===h.data.updateType?_.any(a.customFieldInstances,function(a){return a.customField.pk===h.data.customField}):!0};h.isAnySelectable=function(){return h.isSelectable(h.allCustomerPrototypes)||h.isSelectable(h.allCustomFieldInstanceGroups)};h.status="loading";var v=a.$watch(function(){return k.state("manageCustomFieldInstances")},
function(b){b&&(v(),b=p(),e.dataController(a,{promises:[b,h.allCustomFields.$promise],successCallback:function(){h.status="success";a.$watch("customFieldManagerCtrl.data.updateType",r);d.on(a,"dashboard.items.item.CustomerPrototypesCtrl.created",p);d.on(a,"dashboard.items.item.CustomFieldInstanceGroupsCtrl.created",p);d.on(a,"dashboard.items.item.CustomerPrototypeEditableCtrl.removed",p);d.on(a,"dashboard.items.item.CustomFieldInstanceGroupEditableCtrl.removed",p);e.createController(a,{modelKey:"customFieldManagerCtrl.data",
defaultModel:{updateType:"create"},create:g.customFieldInstances.multi,reset:!1,params:function(){return{shortname:a.company.shortname}},successCallback:function(b){"remove"===h.data.updateType&&(h.data.customField="");"create"===h.data.updateType?l.success(a.$interpolate(interpolate(nT("Added %(count)s custom field","Added %(count)s custom fields",b.length),{count:b.length}),{objects:b})):l.success(a.$interpolate(interpolate(nT("Removed %(count)s custom field","Removed %(count)s custom fields",b.length),
{count:b.length}),{objects:b}));d.broadcast("dashboard.shared.ActivitiesCtrl.refresh");_.forEach(b,function(a){var b={item:a.item};d.broadcast("dashboard.items.item.CustomerPrototypesCtrl.refresh",b);d.broadcast("dashboard.items.item.CustomFieldInstanceGroupsCtrl.refresh",b);d.broadcast("pricing.ngPricing.refresh",{object:a.item})});p()}})}}))})}]);h.directive("ngCustomFieldManager",[function(){return{scope:!0,controller:"CustomFieldManagerCtrl",controllerAs:"customFieldManagerCtrl",templateUrl:"ng-custom-field-manager"}}]);
h.controller("ItemManagerCtrl",["$scope","$attrs","$q","controllers","db","events","flash","models","require","toggles",function(a,b,f,e,g,d,l,m,k,h){var s=this;b=a.$eval(b.ngItemManager);k.assert(b,"ng-item-manager: expected item or items");_.isArray(b)||(b=[b]);k.inScope(a,"company","dashboard.items.item.ManageCustomFieldInstancesCtrl");s.items=b;s.isAnySelected=function(){return _.any(s.items,function(a){return!!s.data[_.uncapitalize("item"+a.pk+_.capitalize("isSelected"))]})};var p=function(){return s.data.type===
m.CustomerPrototype.cls?g.customerPrototypes.multi.apply(g.customerPrototypes.multi,arguments):g.customFieldInstanceGroups.multi.apply(g.customFieldInstanceGroups.multi,arguments)};s.status="loading";var r=a.$watch(function(){return h.state("manageItems")},function(b){b&&(r(),s.customerTypes=g.customerTypes({shortname:a.company.shortname},null,null,null,{tagAlong:!0}),e.dataController(a,{promises:[s.items,s.customerTypes],successCallback:function(){s.status="success";e.createController(a,{modelKey:"itemManagerCtrl.data",
defaultModel:{customerType:"",isExclusive:!1,type:m.CustomerPrototype.cls},create:p,reset:!1,params:function(){return{shortname:a.company.shortname}},successCallback:function(b){s.data.type===m.CustomerPrototype.cls?l.success(a.$interpolate(interpolate(nT("Added %(count)s customer","Added %(count)s customers",b.length),{count:b.length}),{objects:b})):l.success(a.$interpolate(interpolate(nT("Added %(count)s field group","Added %(count)s field groups ",b.length),{count:b.length}),{objects:b}));d.broadcast("dashboard.shared.ActivitiesCtrl.refresh");
_.forEach(b,function(a){var b={item:a.item};d.broadcast("dashboard.items.item.CustomerPrototypesCtrl.refresh",b);d.broadcast("dashboard.items.item.CustomFieldInstanceGroupsCtrl.refresh",b);d.broadcast("pricing.ngPricing.refresh",{object:a.item})})}})}}))})}]);h.directive("ngItemManager",[function(){return{restrict:"A",scope:!0,controller:"ItemManagerCtrl",controllerAs:"itemManagerCtrl",templateUrl:"ng-item-manager"}}]);h.directive("ngPresetDateRange",["$parse","dateUtils","require",function(a,b,f){return{compile:function(e,
g){var d=a(g.ngPresetDateRange),l=a(g.ngPresetDateRangeStart),m=a(g.ngPresetDateRangeEnd),k,h;return function(a,e,g){f.inScope(a,"company","ngPresetDateRange");a.$watch(d,function(d){d&&(b.DATE_RANGES[d]?(d=b.dateRange(d,a.company),k=d[0].format("YYYY-MM-DD"),h=d[1].format("YYYY-MM-DD"),l.assign(a,k),m.assign(a,h)):console.warn("ngPresetDateRange: invalid date range",d))});a.$watchGroup([l,m],function(b){(b[0]!==k||b[1]!==h)&&d.assign(a,"")})}}}}]);h.filter("paginate",[function(){return function(a,
b){return b.paginate(a)}}]);h.directive("ngPagination",["db","events","navigation",function(a,b,f){return{scope:!0,controller:["$scope","$attrs",function(e,g){var d=this;d.status="initializing";d.collection=[];d.pages=[];d.maxPageSize=1E5;d.pageSize=g.ngPaginationPageSize?e.$eval(g.ngPaginationPageSize):100;d.pageCount=1;d.endpoint=e.$eval(g.ngPagination);var l=g.ngPaginationTarget;l&&_.set(e,l,d.collection);l=f.getInt("page");if(_.isUndefined(l)||1>l)l=1;d.currentPage=l-1;var m=function(){d.currentPage>=
d.pageCount&&(d.currentPage=d.pageCount-1);0>d.currentPage&&(d.currentPage=0)};d.nextPage=function(){d.currentPage+=1;m()};d.previousPage=function(){d.currentPage-=1;m()};var k=function(){d.status="loading";var b=d.endpoint({page:d.currentPage,"page-size":d.pageSize||1});b.$promise.then(function(c){c!==a.CANCELLED&&(d.status="success",_.overwrite(d.collection,b),d.collection.$count=c.data.count,d.pageCount=Math.ceil(d.collection.$count/(d.pageSize||1)),_.overwrite(d.pages,_.range(0,d.pageCount)),
m())},function(){d.status="error";_.clear(d.collection)});d.currentPage?f.set("page",d.currentPage+1,!0):f.clear("page",!0)};e.$watch("paginationCtrl.currentPage",function(a,b){a!==b&&k()});e.$watch("paginationCtrl.pageSize",function(a,b){a!==b&&k()});b.on(e,"ng-pagination.refresh",function(){k()});k()}],controllerAs:"paginationCtrl"}}]);h.directive("ngStaticPagination",[function(){return{restrict:"A",scope:!0,controller:["$scope","$attrs",function(a,b){var f=this;f.collection=[];f.pages=[];f.pageSize=
10;f.maxPageSize=1E5;f.pageCount=1;f.currentPage=0;var e=function(){f.pageCount=Math.ceil(f.collection.length/(f.pageSize||1));_.overwrite(f.pages,_.range(0,f.pageCount))},g=function(){f.currentPage>=f.pageCount&&(f.currentPage=f.pageCount-1);0>f.currentPage&&(f.currentPage=0)};f.nextPage=function(){f.currentPage+=1;g()};f.previousPage=function(){f.currentPage-=1;g()};f.paginate=function(a){if(1>=f.pageCount)return a;var b=f.pageSize||1,c=f.currentPage*b,b=Math.min(c+b,a.length);return _.slice(a,
c,b)};a.$watchCollection(b.ngStaticPagination,function(a){f.collection=a;e();g()});a.$watch("paginationCtrl.pageSize",function(){e();g()})}],controllerAs:"paginationCtrl"}}]);h.directive("ngPaginationNavigation",[function(){return{restrict:"A",require:["?^ngPagination","?^ngStaticPagination"],templateUrl:"ng-pagination-navigation"}}]);h.directive("ngPaginationSettings",[function(){return{restrict:"A",require:["?^ngPagination","?^ngStaticPagination"],templateUrl:"ng-pagination-settings"}}]);h.directive("ngPaginationSettingsFlyout",
[function(){return{restrict:"A",require:["?^ngPagination","?^ngStaticPagination"],templateUrl:"ng-pagination-settings-flyout"}}]);h.directive("ngPaginationJump",["$interpolate","navigation",function(a,b){return{require:"^ngPagination",templateUrl:"ng-pagination-jump",controller:["$scope","$attrs",function(f,e){var g=this;g.selected=null;var d=f.$new(),l=a(e.ngPaginationJump);g.option=function(a){d.$element=a;return l(d)};g.endpoint=function(a){return f.paginationCtrl.endpoint({q:a})};f.$watch("paginationJumpCtrl.selected",
function(){g.selected&&b.navigate(g.selected.$url())})}],controllerAs:"paginationJumpCtrl",replace:!0}}]);h.directive("ngColorpicker",["$parse","models",function(a,b){return{require:"ngModel",restrict:"A",templateUrl:"ng-colorpicker",replace:!0,controller:function(){var a=this;a.modelCtrl=null;a.isSelected=function(b){return a.modelCtrl.$modelValue===b};a.select=function(b){a.modelCtrl.$setViewValue(b)};a.colors=_.range(0,b.Item.MAX_COLOR+1)},link:function(a,b,c,d){a.colorPickerCtrl.modelCtrl=d},
controllerAs:"colorPickerCtrl"}}]);h.directive("ngFlowNodeSizeField",["$parse",function(a){return{templateUrl:"ng-flow-node-size-field",restrict:"A",require:["ngFlowNodeSizeField","^?form"],controller:["$scope","$attrs",function(a,b){var e=this;e.model=a.$eval(b.ngFlowNodeSizeField);var g=b.ngPrefix;a.$watch(function(){return e.model[g+"-width"]+"\u00d7"+e.model[g+"-height"]},function(a,b){a!==b&&e.formCtrl.$setDirty()});e.handleClick=function(a,b){e.model[g+"-width"]=a;e.model[g+"-height"]=b};e.isSize=
function(a,b){return e.model[g+"-width"]===a&&e.model[g+"-height"]===b}}],link:function(a,b,e,g){g[0].formCtrl=g[1]},controllerAs:"flowNodeSizeFieldCtrl"}}]);h.directive("ngBookingRestrictionFields",["$parse",function(a){return{restrict:"A",require:["ngBookingRestrictionFields","^?form"],controllerAs:"bookingRestrictionFieldsCtrl",controller:["$scope","$attrs","models",function(b,f,e){var g=this;f=f.ngBookingRestrictionFields;var d=a(f);b.$watch(f+".isBookableEverByPhone",function(a,e){!a&&e&&(d(b).soldOutText=
"")});b.$watch(f+".autoOpenHours",function(a){g.isAutoOpenSet=g.isAutoOpenSet||_.isNumber(a)});b.$watch("bookingRestrictionFieldsCtrl.isAutoOpenSet",function(a){var f=d(b);!1===a?f.autoOpenHours=null:!0===a&&(null===f.autoOpenHours&&(f.autoOpenHours=e.BookingRestriction.DEFAULT_AUTO_OPEN_HOURS),f.autoOpenKind=f.autoOpenKind||e.BookingRestriction.BEFORE_MIDNIGHT_CUTOFF_KIND)})}]}}]);h.directive("ngNagContent",[function(){return{restrict:"A",templateUrl:"ng-nag-content",controllerAs:"nagContentCtrl",
controller:["moment","navigation",function(a,b){this.downtimeStartAt=a.tz("2018-12-23 02:00-08:00",b.currentCompany.timezone);this.downtimeEndAt=this.downtimeStartAt.clone().add(2,"hour");this.daysUntilDowntime=Math.round((this.downtimeStartAt-a())/864E5)}]}}]);h.directive("ngIntRange",[function(){return{restrict:"A",scope:!0,controllerAs:"intRangeCtrl",controller:["$scope","$attrs","require",function(a,b,f){f.inScope(a,"customField");var e=this;e.fieldNames=["rangeStart","rangeEnd"];e.model=a.$eval(b.ngIntRange);
e.getOptionsForField=function(b){var c;"rangeStart"===b?(b=a.customField.countMin,c=e.model.rangeEnd):(b=e.model.rangeStart+1,c=a.customField.countMax+1);return _.range(b,c)};b=a.customField.countMin;f=a.customField.countMax;var g=b,d=f;if(_.isObject(e.model.properties)){var l=e.model.properties.rangeStart,m=e.model.properties.rangeEnd;_.isNumber(l)&&(l>b&&l<f)&&(g=l);_.isNumber(m)&&(m>b&&m<f)&&(d=m)}e.model.rangeStart=g;e.model.rangeEnd=d}]}}])})();angular.module("dashboard.admin",["dashboard.admin.controllers"]);
(function(){var h=angular.module("dashboard.admin.controllers",[]);h.controller("dashboard.admin.IndexCtrl",["$scope",function(b){return b}]);h.controller("dashboard.admin.JumpCtrl",["$scope","controllers","db","navigation","toggles","urls",function(b,a,c,f,e,g){b.companiesEndpoint=c.searchEndpoint(c.companies.jump);b.jump={company:""};b.$watch("jump.company",function(){b.jump.company&&(f.navigate(b.jump.company.$url(g.dashboard.index)),e.toggle("adminJump",!1));b.jump.company=""})}]);h.controller("dashboard.admin.CompaniesCtrl",
["$scope","controllers","db","models","navigation","processors","urls",function(b,a,c,f,e,g,d){b.users=c.searchEndpoint(c.users.pickable,{shortname:f.Company.ADMIN_SHORTNAME});b.userCtrl={currentUser:null};a.imageUploadController(b,{id:"logo",elementKey:"newCompany",modelKey:"newCompany"});a.imageUploadController(b,{id:"email",elementKey:"newCompany",modelKey:"newCompany",field:"imageEmailUrl"});var l={shortname:"",name:"",isDemoModeEnabled:!0,isAdmin:!1,isCharter:!0,isAffiliate:!1,isChargingAffiliate:!1,
feeType:f.Company.PERCENTAGE_FEE_TYPE,processingFeeRate:1.9,processingFlatFee:30,percentageFeeRate:6,minimumFee:100,payoutPeriodType:f.Company.ROLLING_WINDOW_PERIOD_TYPE,isPayoutAfterAvailability:!1,tieredFeeSchedule:_.stringifyJSON(f.Company.DEFAULT_TIERED_FEE_SCHEDULE),rollingWindowDays:1,country:"US",billingCountry:"US",defaultDashboardBookingsView:f.Company.GRID_VIEW,isInvoicingEnabled:!1,isReceiptsEnabled:!0,isBocaEnabled:!1,isCancellationPoliciesEnabled:!0,isCheckinEnabled:!0,isSmsEnabled:!0,
invoiceFeeRate:f.Company.INVOICE_FEE_RATE,invoiceFlatFee:f.Company.INVOICE_FLAT_FEE,language:f.Company.DEFAULT_LANGUAGE,timeFormatType:f.Company.COMPANY_LOCALE_DEFAULT_TIME_FORMAT_TYPE,anonymousTimeFormatType:f.Company.ANONYMOUS_USER_LOCALE_DEFAULT_TIME_FORMAT_TYPE,"features-isCancellationPoliciesEnabled":!0,"features-isCheckinEnabled":!0,"features-isTransportationEnabled":!1,"features-isOnlineStoredValueCardRedemptionEnabled":!0,"features-isStoredValueCardBookingFeesEnabled":!0,"features-isSuggestedItemsEnabled":!1,
"features-isPaymentsReportLegacy":!0,"features-isPayoutCreationErrorEmailsEnabled":!0,"features-isTicketLayoutsEnabled":!1,"features-isSonarEnabled":!0,"features-isSundayBased":!0,"features-isInternationalSmsEnabled":!0,"features-isItemColorsEnabled":!0,"features-isDayViewEnabled":!1,"features-isAmountDueOnReceiptsEnabled":!0,"features-isLocationsEnabled":!0,"features-isConnectEnabled":!1,"companyFeatures-summarizeBookingCustomersMinimum":10,"companyFeatures-isResourceBookableCapacityEnabled":!0,
"companyFeatures-isRefundReserveRecurringTransferEnabled":!1,"companyFeatures-refundReserve":"off"};l["companyFeatures-refundReserveRecurringTransferFormat"]=f.Company.REFUND_RESERVE_AMOUNT_FORMAT;b.supportedCurrencyChoices=[];b.supportedDashboardBookingsViews=f.Company.dashboardBookingsViewChoices(!0);b.options={};b.options.isTaxIncludedEnabled=null!==b.company.features.includedTaxRate;a.dataController(b,{promises:[b.users.$promise],successCallback:function(){a.createController(b,{modelKey:"newCompany",
create:c.companies.create,successCallback:function(a){b.imageUploadCtrl.logo.submit();b.imageUploadCtrl.email.submit();e.navigate(a.$url(d.dashboard.index))},params:_.ignore,defaultModel:l});b.$watch("newCompany.processorCountry",function(){if(b.newCompany.processorCountry){var a=g.supportedCurrencies(g.DEFAULT_PROCESSOR_TYPE,b.newCompany.processorCountry),a=f.Company.getCurrencyChoices(a);_.overwrite(b.supportedCurrencyChoices,a);b.newCompany.processorCurrency=1===b.supportedCurrencyChoices.length?
b.supportedCurrencyChoices[0][0]:"";(a=f.Company.getCountryDefaults(b.newCompany.processorCountry))&&_.extend(b.newCompany,a)}b.newCompany["features-isExtendedBreakdownEnabled"]=b.newCompany.processorCountry&&"US"!==b.newCompany.processorCountry});b.$watch("newCompany['features-isDayViewEnabled']",function(a){b.supportedDashboardBookingsViews=f.Company.dashboardBookingsViewChoices(a);b.newCompany.defaultDashboardBookingsView===f.Company.DAY_VIEW&&(b.newCompany.defaultDashboardBookingsView=f.Company.GRID_VIEW)});
b.$watch("options.isTaxIncludedEnabled",function(a){a?(a=f.Company.DEFAULT_INCLUDED_TAX_PERCENTAGE_BY_COUNTRY[b.newCompany.processorCountry],_.isUndefined(a)||(b.newCompany["features-includedTaxRate"]=a)):b.newCompany["features-includedTaxRate"]=null})}})}]);h.controller("dashboard.admin.NavigationCtrl",["$scope","models",function(b,a){b.browserFilter={networkSelection:a.Calendar.ADMIN_FILTER,showRecent:!0}}]);h.controller("dashboard.admin.SystemActivitiesCtrl",["$scope","dashboard.shared.activitiesController",
"db","navigation","require",function(b,a,c,f,e){e.notNull(f,"currentCompany");return a(b,{get:c.company.activities.system,params:function(){return{shortname:f.currentCompany.shortname}}})}]);h.controller("dashboard.admin.AdminActivitiesCtrl",["$scope","dashboard.shared.activitiesController","db","navigation","require",function(b,a,c,f,e){e.notNull(f,"currentCompany");return a(b,{get:c.company.activities.admin,params:function(){return{shortname:f.currentCompany.shortname}}})}])})();
angular.module("dashboard.bookings",["dashboard.bookings.controllers","dashboard.bookings.directives","dashboard.booking.services"]);
(function(){var h=angular.module("dashboard.bookings.controllers",["book.services","lib.factories"]);h.controller("dashboard.bookings.IndexCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.inScope(a,"company","dashboard.bookings.IndexCtrl");a.customCalendars=f.customCalendars({shortname:a.company.shortname});b.dataController(a,{promises:[a.customCalendars.$promise]})}]);h.controller("dashboard.bookings.NavigationCtrl",["$scope","$q","auth","availabilityUpdater","controllers",
"db","events","models","navigation","require","urls",function(a,b,f,e,g,d,l,m,k,h,s){h.inScope(a,"company","dashboard.bookings.NavigationCtrl");a.isNetwork=!1;a.isPartner=!1;a.navigationFilter={date:moment().startOf("day")};a.visibleCompany=a.company.isCharter?a.company:null;a.browserFilter={networkSelection:a.company.isCharter?m.Calendar.COMPANY_FILTER:m.Calendar.NETWORK_FILTER,query:"",showRecent:!1};a.calendarFilter=null;var p={};p[m.Company.MONTH_VIEW]="calendarViewUrl";p[m.Company.DAY_VIEW]=
"dayViewUrl";p[m.Company.AGENDA_VIEW]="agendaViewUrl";p[m.Company.GRID_VIEW]="gridViewUrl";p[m.Company.TIMELINE_VIEW]="timelineViewUrl";var r={};r[s.dashboard.bookings.calendar]=m.Company.MONTH_VIEW;r[s.dashboard.bookings.day.index]=m.Company.DAY_VIEW;r[s.dashboard.bookings.agenda.index]=m.Company.AGENDA_VIEW;r[s.dashboard.bookings.grid.index]=m.Company.GRID_VIEW;r[s.dashboard.bookings.timeline.index]=m.Company.TIMELINE_VIEW;a.isRedirectNeeded=function(){return!!k.pathEquals(s.dashboard.bookings.index)};
var t=function(b){return b===m.Company.DAY_VIEW&&!a.company.features.isDayViewEnabled?m.Company.TIMELINE_VIEW:b},v=function(){a.calendarFilter&&(a.calendarFilter.dashboardBookingsView=_.chooseFirst(r,function(a,b){if(k.pathStartsWith(b))return a}))};k.watch(a,v);a.applyCalendarFilter=function(b,c){a.calendarFilter||(a.calendarFilter={});_.overwrite(a.calendarFilter,b);if(a.isRedirectNeeded()){var d=a.calendarFilter.dashboardBookingsView;d||(d=a.company.defaultDashboardBookingsView);var d=t(d),e=k.get("date");
e?(e=moment(e,"YYYY-MM-DD"),k.clear("date",!0)):e=moment().startOf("day");d=a[p[d]||p[m.Company.GRID_VIEW]](e);k.redirect(d)}else if(d=a.calendarFilter.dashboardBookingsView,(d=t(d))&&!c)d=a[p[d]||p[m.Company.GRID_VIEW]](void 0),k.navigate(d);v()};var y=function(){return!a.calendarFilter||!a.calendarFilter.items?[]:_.choose(a.items,function(b){if(a.calendarFilter.items[b.uri])return b})};a.isCalendarFiltered=function(b){if(!a.calendarFilter)return!0;if(b.cls===m.CrewMember.cls)return a.calendarFilter.noCrewAssigned?
!0:_.any(a.calendarFilter.users)&&!a.calendarFilter.users[b.user.uri];if(b.cls===m.Resource.cls)return a.calendarFilter.noResourcesUsed?!0:_.any(a.calendarFilter.resources)&&!a.calendarFilter.resources[b.uri];var c=b.cls===m.Item.cls?b:b.item;if(a.availabilityUpdater.isCalendarFilteringDisabled)return c&&!a.calendarFilter.items[c.uri];if(a.calendarFilter.hideEmpty&&0===b.customerCount)return!0;var d=b.cls===m.Availability.cls?b:null;if(d&&""!==a.calendarFilter.minimumAvailableCapacity)if(0<a.calendarFilter.minimumAvailableCapacity){if(d.bookableCapacity<
a.calendarFilter.minimumAvailableCapacity||!d.isResourcesAvailable)return!0}else if(0===a.calendarFilter.minimumAvailableCapacity&&0!==d.bookableCapacity)return!0;if(a.calendarFilter.hideNoAvailableResources&&0===b.customerCount&&(a.visibleCompany.companyFeatures.isResourceBookableCapacityEnabled&&0===b.bookableCapacity||!a.visibleCompany.companyFeatures.isResourceBookableCapacityEnabled&&!b.isResourcesAvailable)||c&&!a.calendarFilter.items[c.uri])return!0;c=b.crewMembers;if(a.calendarFilter.noCrewAssigned&&
c&&c.length)return!0;d=b.users;if(a.calendarFilter.noCrewAssigned&&d&&d.length)return!0;b=b.resourceUseSummaries;return a.calendarFilter.noResourcesUsed&&b&&b.length||!a.calendarFilter.noCrewAssigned&&(c&&_.any(a.calendarFilter.users))&&!_.any(c,function(b){return a.calendarFilter.users[b.user.uri]})||!a.calendarFilter.noCrewAssigned&&(d&&_.any(a.calendarFilter.users))&&!_.any(d,function(b){return a.calendarFilter.users[b.uri]})||!a.calendarFilter.noResourcesUsed&&(b&&_.any(a.calendarFilter.resources))&&
!_.any(b,function(b){return a.calendarFilter.resources[b.resource.uri]})?!0:!1};a.$watch("browserFilter.networkSelection",function(b,c){a.isNetwork=a.isPartner=!1;b===m.Calendar.NETWORK_FILTER?(a.isNetwork=!0,a.visibleCompany=null):b!==m.Calendar.COMPANY_FILTER?(a.isPartner=!0,a.visibleCompany=b):a.visibleCompany=a.company;B()});a.$watch("calendarFilter.showRecent",function(b){a.browserFilter.showRecent=b});a.toggleRecent=function(){a.calendarFilter&&(a.calendarFilter.showRecent=!a.calendarFilter.showRecent);
a.browserFilter.showRecent=!a.browserFilter.showRecent};a.items=[];a.resources=[];var q,B=function(){if(a.browserFilter.networkSelection===m.Calendar.NETWORK_FILTER)return[];var e;e=a.browserFilter.networkSelection===m.Calendar.COMPANY_FILTER?a.company:a.browserFilter.networkSelection;if(e!==q){q=e;var g=[];a.items=d.items.pickable({shortname:e.shortname});g.push(a.items.$promise);a.resources=[];0<e.resourcesCount&&f.permissions.canList(m.Resource,e)&&(a.resources=d.resources({shortname:e.shortname}),
g.push(a.resources.$promise));b.all(g).then(function(){a.filteredItems=y();l.broadcast("dashboard.bookings.NavigationCtrl.filterChoicesUpdated",{filteredItems:a.filteredItems,resources:a.resources})})}};a.partners=[];f.permissions.can("view",m.Affiliation,a.company)&&(a.partners=d.partners({shortname:a.company.shortname}),g.dataController(a,{stale:[a.partners],promises:[a.partners.$promise],successCallback:function(){a.networkSelections=[];a.company.isCharter&&a.networkSelections.push({text:a.company.name,
value:m.Calendar.COMPANY_FILTER});if(a.company.isAffiliate){var b=_.filter(a.partners,function(a){return!a.company.isDemoModeEnabled});b.length&&(a.networkSelections.push({text:T("All partners"),value:m.Calendar.NETWORK_FILTER}),_.forEach(b,function(b){a.networkSelections.push({text:b.company.name,value:b.company})}))}a.networkSelections.length&&(a.browserFilter.networkSelection=a.networkSelections[0].value);var c=f.storage.get("currentPartnerSelection");c&&((b=_.find(a.networkSelections,function(a){a=
a.value;return _.isString(a)?a===c:a.uri===c}))?a.browserFilter.networkSelection=b.value:f.storage.del("currentPartnerSelection"));a.$watch("browserFilter.networkSelection",function(a){f.storage.set("currentPartnerSelection",a.uri||a)})}}));g=k.get("q")||"";k.clear("q");g&&(a.browserFilter.query=g);var u=s.calendarUrls(s.dashboard.bookings.calendar);a.calendarViewUrl=function(b){b=b||a.navigationFilter.date;return s.populate(u.month,{shortname:a.company.shortname,year:b.format("YYYY"),month:b.format("MM")})};
a.dayViewUrl=function(b){b=b||a.navigationFilter.date;return s.populate(s.dashboard.bookings.day.date,{shortname:a.company.shortname,date:b.format("YYYY-MM-DD")})};a.agendaViewUrl=function(b){b=b||a.navigationFilter.date;return s.populate(s.dashboard.bookings.agenda.date,{shortname:a.company.shortname,date:b.format("YYYY-MM-DD")})};a.gridViewUrl=function(b){b=b||a.navigationFilter.date;return s.populate(s.dashboard.bookings.grid.date,{shortname:a.company.shortname,date:b.format("YYYY-MM-DD")})};a.timelineViewUrl=
function(b,c){b=b||a.navigationFilter.date;var d=s.populate(s.dashboard.bookings.timeline.date,{shortname:a.company.shortname,date:b.format("YYYY-MM-DD")});c&&(d=k.compose(d,{"timeline-type":c}));return d};a.goToViewForDay=function(b){a.navigationFilter.date=b.at;b=a.company.defaultDashboardBookingsView===m.Company.AGENDA_VIEW?a.agendaViewUrl():a.company.features.isDayViewEnabled?a.dayViewUrl():a.timelineViewUrl(null,m.Company.AVAILABILITY_TIMELINE);k.navigate(b)};l.on(a,"lib.shared.CalendarCtrl.month",
function(b,c){var d=c.date.format("YYYY-MM");if(d!==a.navigationFilter.date.format("YYYY-MM")){var e=moment().startOf("day");d===e.format("YYYY-MM")?a.navigationFilter.date=e:a.navigationFilter.date=c.date.startOf("month")}});a.$watchCollection("calendarFilter.items",function(){a.filteredItems=y();l.broadcast("dashboard.bookings.NavigationCtrl.calendarFilter.items",{items:a.filteredItems})});g=function(){l.broadcast("lib.shared.CalendarCtrl.refresh")};l.on(a,"dashboard.shared.AvailabilityEditableCtrl.updated",
g);l.on(a,"dashboard.shared.AvailabilityEditableCtrl.removed",g);l.on(a,"dashboard.shared.AvailabilityStatusEditable.updated",g);a.availabilityUpdater=e({onOpen:function(){this.allItems=a.items;this.initialSelectedItems=[];this.startDate=a.navigationFilter.date.clone();this.endDate=a.navigationFilter.date.clone();k.pathEquals(u.month)&&(this.startDate.startOf("month"),this.endDate.endOf("month"));this.company=a.visibleCompany}});l.on(a,"dashboard.shared.availabilityUpdater.beforeDryRun",function(b,
c){_.clear(a.calendarFilter.items);_.forEach(c.selectedItems,function(b){a.calendarFilter.items[b.uri]=!0})});l.on(a,"dashboard.shared.availabilityUpdater.createAvailabilities",function(b,c){k.navigate(a.company.$url(s.dashboard.items.index))})}]);h.factory("dayAvailabilitiesController",["cache","db","events","navigation","require","sonar","urls",function(a,b,f,e,g,d,l){return function(m,k){g.inScope(m,"navigationFilter");g.inScope(m,"filteredItems");g.inScope(m,"visibleCompany");g.inScope(m,"company");
g.defined(k,"success");g.defined(k,"viewPath");m.dayAvailabilitiesCtrl={status:"loading",isRetrieving:!1,hasAnyAvailabilities:!1};var h=k.viewPath,s,p;m.items=m.filteredItems;var r=function(d){var e={},f=m.visibleCompany;if(f&&(e.shortname=f.shortname,e.date=m.navigationFilter.date.format("YYYY-MM-DD"),m.items.length&&(e.itemPks=_.pluck(m.items,"pk").join(",")),d||!angular.equals([e],[s])))s=e,m.dayAvailabilitiesCtrl.status="loading",m.dayAvailabilitiesCtrl.isRetrieving=!0,p&&p.$promise&&p.$promise.cancel(),
p=b.availabilities.searchByDate(_.clone(e)),a.fresh(p)||(m.dayAvailabilitiesCtrl.status="success",m.dayAvailabilitiesCtrl.isRetrieving=!1,m.dayAvailabilitiesCtrl.hasAnyAvailabilities=!!p.length,k.success(p)),p.$promise.then(function(a){a!==b.CANCELLED&&(m.dayAvailabilitiesCtrl.status="success",m.dayAvailabilitiesCtrl.isRetrieving=!1,m.dayAvailabilitiesCtrl.hasAnyAvailabilities=!!p.length,k.success(p))},function(){m.dayAvailabilitiesCtrl.status="error";m.dayAvailabilitiesCtrl.isRetrieving=!1;m.dayAvailabilitiesCtrl.hasAnyAvailabilities=
!1})};m.dayAvailabilitiesCtrl.refreshAvailabilities=r;var t=function(){r(!0)};f.on(m,"lib.shared.CalendarCtrl.refresh",t);f.on(m,"dashboard.shared.BlocksCtrl.created",t);f.on(m,"dashboard.shared.BlockEditableCtrl.updated",t);f.on(m,"dashboard.shared.BlockEditableCtrl.removed",t);f.on(m,"dashboard.shared.ItemColorEditableCtrl.updated",t);var v=_.debounce(function(){m.$safeApply(function(){t()})},1E3,{leading:!0});d.watch(m,m.company,"bookings",t);f.on(m,"dashboard.bookings.NavigationCtrl.filterChoicesUpdated",
function(a,b){b&&b.filteredItems&&(m.items=b.filteredItems);r()});f.on(m,"dashboard.bookings.NavigationCtrl.calendarFilter.items",function(a,b){var c=_.difference(b.items,m.items).length;m.items=b.items;c&&v()});e.watch(m,function(a){if(e.pathEquals(h.index))e.redirect(l.populate(h.date,{shortname:m.company.shortname,date:moment().format("YYYY-MM-DD")}));else{var b=e.pathEquals(h.date);if(b)a=moment(b.date),m.navigationFilter.date=a,m.dayAvailabilitiesCtrl.selectedDate=a.format("YYYY-MM-DD"),r();
else throw Error("dashboard.bookings.NavigationCtrl: invalid agenda view url "+a);}});var y=function(a){return l.populate(h.date,{shortname:m.company.shortname,date:a.format("YYYY-MM-DD")})};m.dayAvailabilitiesCtrl.nextDayUrl=function(){var a=m.navigationFilter.date.clone();a.add(1,"days");return y(a)};m.dayAvailabilitiesCtrl.currentDayUrl=function(){return y(moment())};m.dayAvailabilitiesCtrl.previousDayUrl=function(){var a=m.navigationFilter.date.clone();a.add(-1,"days");return y(a)};m.dayAvailabilitiesCtrl.selectedDate=
m.navigationFilter.date.format("YYYY-MM-DD");m.$watch("dayAvailabilitiesCtrl.selectedDate",function(a){a=moment(a,"YYYY-MM-DD");m.navigationFilter.date.diff(a)&&e.navigate(y(a))});return m}}]);h.controller("dashboard.bookings.DayCtrl",["$scope","$filter","urls","require","dayAvailabilitiesController",function(a,b,f,e,g){e.inScope(a,"isCalendarFiltered");var d=b("isAllDay");a.isRowFiltered=function(b){return(b=a.overview.itemsByStartAt[b])?_.all(b,function(b,c){return 0===b.length||a.isCalendarFiltered(b[0].item)?
!0:_.all(b,a.isCalendarFiltered)}):!0};return g(a,{viewPath:f.dashboard.bookings.day,success:function(b){var c=new Number(-1);c.isAllDay=!0;a.overview=a.overview||{itemsByStartAt:{}};_.clear(a.overview.itemsByStartAt);_.forEach(b,function(b){var e=b.startAt;d(b)&&(e=c);a.overview.itemsByStartAt[e]=a.overview.itemsByStartAt[e]||{};a.overview.itemsByStartAt[e][b.item.uri]=a.overview.itemsByStartAt[e][b.item.uri]||[];a.overview.itemsByStartAt[e][b.item.uri].push(b)});a.overview.startAts=_.map(_.keys(a.overview.itemsByStartAt),
function(a){return a==c?c:moment(a)});a.overview.startAts.sort()}})}]);h.controller("dashboard.bookings.AgendaCtrl",["$scope","$filter","urls","require","dayAvailabilitiesController",function(a,b,f,e,g){e.inScope(a,"isCalendarFiltered");var d=b("isAllDay");a.isRowFiltered=function(b){return(b=a.overview.availabilitiesByStartAt[b])&&b.length?_.all(b,function(b){return a.isCalendarFiltered(b.item)})||_.all(b,a.isCalendarFiltered):!0};return g(a,{viewPath:f.dashboard.bookings.agenda,success:function(b){var c=
new Number(-1);c.isAllDay=!0;a.overview=a.overview||{availabilitiesByStartAt:{}};_.clear(a.overview.availabilitiesByStartAt);_.forEach(b,function(b){var e=b.startAt;d(b)&&(e=c);var f=a.overview.availabilitiesByStartAt[e]||[];a.overview.availabilitiesByStartAt[e]=f;f.push(b)});a.overview.startAts=_.map(_.keys(a.overview.availabilitiesByStartAt),function(a){return a==c?c:moment(a)});a.overview.startAts.sort()}})}]);h.controller("dashboard.bookings.TimelineSettingsCtrl",["$scope","$filter","dashboard.bookings.grid",
"require","dashboard.bookings.timeline",function(a,b,f,e,g){var d=a.timelineSettingsCtrl=this;e.inScope(a,"visibleCompany","dashboard.bookings.TimelineSettingsCtrl");d.resourceUseGroupings=g.RESOURCE_USE_GROUPINGS;d.rangeTypes=g.RANGE_TYPES;var l=b("time"),m=moment().startOf("day"),k=function(a){return _.map(a,function(a){var b=m.clone().add(a,"hours");return{value:a,name:l(b)}})};d.hourRangeStartChoices=k(_.range(24));a.$watch("calendarFilter.timelineHourRangeStart",function(b){d.hourRangeEndChoices=
k(_.range(b+1,25));d.hourRangeEndChoices[d.hourRangeEndChoices.length-1].name+="+1";a.calendarFilter&&b>=a.calendarFilter.timelineHourRangeEnd&&(a.calendarFilter.timelineHourRangeEnd=24)});d.reset=function(){if(a.calendarFilter){var b=g.defaultSettings();delete b.timelineType;_.extend(a.calendarFilter,b)}};d.availabilityAxisChoices=f.filterAxisChoices(g.AVAILABILITY_AXIS_CHOICES,a.visibleCompany);a.$watch("visibleCompany",function(){d.availabilityAxisChoices=f.filterAxisChoices(g.AVAILABILITY_AXIS_CHOICES,
a.visibleCompany)})}]);h.controller("dashboard.bookings.TimelineCtrl",["$scope","$filter","$q","$sniffer","cache","dayAvailabilitiesController","db","events","dashboard.bookings.grid","models","navigation","require","sonar","dashboard.bookings.timeline","urls",function(a,b,f,e,g,d,l,m,k,h,s,p,r,t,v){p.inScope(a,"resources","dashboard.bookings.TimelineCtrl");var y=a.timelineCtrl=this;y.version=0;y.rows=[];y.status="initializing";y.needsLegendColumn=function(){return!a.calendarFilter||a.calendarFilter.timelineType===
h.Company.RESOURCE_TIMELINE?!0:a.calendarFilter.timelineType===h.Company.AVAILABILITY_TIMELINE?a.calendarFilter.timelineAvailabilityAxis!==k.NULL_AXIS:!0};y.rowAxisLabel=function(){return!a.calendarFilter?"":a.calendarFilter.timelineType===h.Company.AVAILABILITY_TIMELINE?k.AXIS_TYPE_LABELS[a.calendarFilter.timelineAvailabilityAxis]||"":a.calendarFilter.timelineType===h.Company.RESOURCE_TIMELINE?"Resource":""};y.availabilitiesNeedItem=function(){return!a.calendarFilter||a.calendarFilter.timelineAvailabilityAxis!==
k.ITEM_AXIS};var q=function(a,b){if(!a.length)return null;var c=_.map(a,function(a){return a.endAt.diff(a.startAt)||72E5}),c=80/(_.min(c)/b),c=Math.ceil(c);return Math.min(c,1E3)},B=function(b,c){var d=b.clone().startOf("day"),e=d.clone().add(1,"days"),f,g;a.calendarFilter.timelineHourRangeType===t.RANGE_TYPES.AUTO?(g=t.automaticHourRange(c,1),f=g.startAt,g=g.endAt):a.calendarFilter.timelineHourRangeType===t.RANGE_TYPES.CUSTOM?(f=d.clone().add(a.calendarFilter.timelineHourRangeStart,"hours"),g=d.clone().add(a.calendarFilter.timelineHourRangeEnd,
"hours")):(f=d,g=e);if(!moment.isMoment(f)||f<d)f=d;if(!moment.isMoment(g)||g>e)g=e;if(!y.minStartAt||!f.isSame(y.minStartAt))y.minStartAt=f;if(!y.maxEndAt||!g.isSame(y.maxEndAt))y.maxEndAt=g;y.minWidth=q(c,g.diff(f))},u=function(a){return _.filter(a,t.overlapsWith({startAt:y.minStartAt,endAt:y.maxEndAt}))},z=b("name"),C={},F=function(b,c){var d=_.groupBy(b,function(b){var c=b.startAt.toString()+":"+b.endAt.toString();b=t.groupingObject(a.calendarFilter.timelineGrouping,b);return c+":"+(b?b.pk:"none")}),
d=_.mapObject(d,function(b,d){var e=t.groupingObject(a.calendarFilter.timelineGrouping,b[0]);return _.extend((C[c]?C[c][d]:{})||{},{useCount:_.sum(b,"useCount"),bookings:_.uniq(_.map(b,"booking")),startAt:b[0].startAt,endAt:b[0].endAt,groupingObject:e,popoverMessage:t.popoverMessage(a.calendarFilter.timelineGrouping),orderBy:t.orderBy(e),displayLines:t.displayLines(e)})});C[c]=d;return _.sortBy(d,"orderBy")},x={},w=function(a,b,c){var d={},e=function(a){var b=a.toString();d[b]=d[b]||a};_.forEach(a,
function(a){a.endAt<y.minStartAt||a.startAt>y.maxEndAt||(e(moment.max(a.startAt,y.minStartAt)),e(moment.min(a.endAt,y.maxEndAt)))});e(y.minStartAt);e(y.maxEndAt);d=_.values(d);d=_.sortBy(d);return _.map(_.range(0,d.length-1),function(e){var f=c+":"+d[e].toString()+":"+d[e+1].toString();e=x[f]||{startAt:d[e],endAt:d[e+1]};x[f]=e;b(e,_.filter(a,t.overlapsWith(e,!0)));return e})},G=function(a,b,c){return w(b,function(b,c){b.resource=a;b.overrides=c;b.maximumUseCount=c.length?_.min(c,"maximumUseCount").maximumUseCount:
a.maximumUseCount;b.isMaxFinite=_.isFinite(b.maximumUseCount)},c+".totalCapacity")},M=function(a,b){return w(a,function(a,b){_.extend(a,_.groupBy(b,function(a){return a.startAt.isSame(a.endAt)?"zeroLengthUses":"uses"}));a.useCount=_.sum(a.uses,"useCount");a.bookings=_.uniq(_.map(a.uses,"booking"));a.zeroLengthUses&&(a.zeroLengthOverview={startAt:a.startAt,endAt:a.startAt,useCount:_.sum(a.zeroLengthUses,"useCount"),bookings:_.uniq(_.map(a.zeroLengthUses,"booking"))})},b+".useOverview")},K=function(a,
b,c,d){b=w(b.concat(c),function(b,c){var d,e;c[0].overrides?(d=c[1],e=c[0]):(d=c[0],e=c[1]);e=e.maximumUseCount;var f=d.useCount;b.availableUseCount=_.isFinite(e)?e-f:Infinity;b.isSpaceFinite=_.isFinite(e);b.resource=a;d.zeroLengthOverview&&(b.zeroLengthOverview={startAt:b.startAt,endAt:b.startAt,availableUseCount:_.isFinite(e)?e-d.zeroLengthOverview.useCount:Infinity,isSpaceFinite:b.isSpaceFinite,resource:a})},d+".spaceOverview");for(d=0;d<b.length;d++){for(c=d+1;c<b.length&&b[d].availableUseCount===
b[c].availableUseCount&&!b[c].zeroLengthOverview;)c++;c>d+1&&(b[d].endAt=b[c-1].endAt,b.splice(d+1,c-1-d))}return b},H={},L=function(b,c,d,e){if(a.calendarFilter.timelineType===h.Company.RESOURCE_TIMELINE&&(y.rows=[],c.length)){d=_.reject(d,function(b){return a.isCalendarFiltered(b.resourceRequirement.resource)});e=_.reject(e,function(b){return a.isCalendarFiltered(b.resource)});var f=[];a.calendarFilter.showUsesOnTimeline&&(f=f.concat(d));a.calendarFilter.showOverridesOnTimeline&&(f=f.concat(e));
B(b,f);d=u(d);e=u(e);var g=_.groupBy(d,"resourceRequirement.resource.uri"),k=_.groupBy(e,"resource.uri");a.calendarFilter.hideEmptyResourcesOnTimeline&&(c=_.filter(c,function(a){return!!g[a.uri]}));_.forEach(c,function(b){var c=a.calendarFilter.showCapacityOverviewsOnTimeline||a.calendarFilter.showSpaceOverviewsOnTimeline?G(b,k[b.uri],b.uri):[],d=a.calendarFilter.showUseOverviewsOnTimeline||a.calendarFilter.showSpaceOverviewsOnTimeline?M(g[b.uri],b.uri):[],e=a.calendarFilter.showSpaceOverviewsOnTimeline?
K(b,d,c,b.uri):[],f=_.sortBy(k[b.uri],function(a){return-a.maximumUseCount}),c={displayName:z(b),resource:b,aggregatedUses:F(g[b.uri],b.uri),overrides:f,totalCapacityOverviewRanges:c,useOverviewRanges:d,spaceOverviewRanges:e};H[b.uri]?_.extend(H[b.uri],c):H[b.uri]=c;_.insertSorted(y.rows,H[b.uri],"displayName")})}},E={},N=function(b,c){if(a.calendarFilter.timelineType===h.Company.AVAILABILITY_TIMELINE&&(y.rows=[],c=_.reject(c,a.isCalendarFiltered),c.length)){B(b,c);c=u(c);var d=a.calendarFilter.timelineAvailabilityAxis,
e=k.axisMappers[d];if(e){var f={};_.forEach(c,function(b){_.forEach(_.castArray(e(b)),function(c){if(!c.isFiltered(a)){var d=c.identifier;f[d]||(f[d]=!0,E[d]?E[d].availabilities=[]:E[d]={coordinate:c,resource:c.resource,displayName:c.displayName,availabilities:[]},_.insertSorted(y.rows,E[d],"coordinate.orderBy"));E[d].availabilities.push(b)}})})}else console.warn("timeline: invalid axis type:",d)}},I={},D,Z,ia,J;I[h.Company.RESOURCE_TIMELINE]=function(b,c,d){var e=_.filter(a.resources,function(b){return!!a.calendarFilter.resources[b.uri]});
e.length||(e=a.resources);var k=_.pluck(e,"pk");if(k.length){L(c,e,ia,J);d={shortname:d.shortname,date:c.format("YYYY-MM-DD"),needsUses:a.calendarFilter.showUsesOnTimeline||a.calendarFilter.showUseOverviewsOnTimeline||a.calendarFilter.showSpaceOverviewsOnTimeline,needsOverrides:a.calendarFilter.showOverridesOnTimeline||a.calendarFilter.showCapacityOverviewsOnTimeline||a.calendarFilter.showSpaceOverviewsOnTimeline};var m=angular.equals(d,Z)&&!_.difference(k,D).length;Z=d;D=k;if(b||!m)y.status="loading",
ia&&ia.$promise&&ia.$promise.cancel(),J&&J.$promise&&J.$promise.cancel(),b={shortname:d.shortname,date:d.date,resourcePk:k.join(",")},ia=d.needsUses?l.resourceUses.byDate(b):[],J=d.needsOverrides?l.resourceOverrides.byDate(b):[],!g.fresh(ia)&&!g.fresh(J)&&L(c,e,ia,J),f.all([ia.$promise,J.$promise]).then(function(b){a.calendarFilter.timelineType===h.Company.RESOURCE_TIMELINE&&!_.any(b,_.isReferenceEqualTo(l.CANCELLED))&&(y.version++,L(c,e,ia,J),y.status="success")})}else L(c,e,[],[])};var ea=[],P,
wa;I[h.Company.AVAILABILITY_TIMELINE]=function(b,c,d){var e=_.filter(a.items,function(b){return!!a.calendarFilter.items[b.uri]});e.length||N(c,[]);e=_.map(e,"pk");N(c,ea);d={shortname:d.shortname,date:c.format("YYYY-MM-DD")};var f=angular.equals(d,wa)&&!_.difference(e,P).length;P=e;wa=d;if(b||!f)y.status="loading",ea&&ea.$promise&&ea.$promise.cancel(),ea=l.availabilities.searchByDate({shortname:d.shortname,date:d.date,itemPks:e.join(",")},null,null,{overlapping:"yes"}),g.fresh(ea)||N(c,ea),ea.$promise.then(function(b){a.calendarFilter.timelineType===
h.Company.AVAILABILITY_TIMELINE&&b!==l.CANCELLED&&(y.version++,y.status="success",N(c,ea))})};var ja=function(b,c){if(a.calendarFilter){var d=s.get("timeline-type");d&&(e.history&&s.clear("timeline-type",!0),I[d]&&(a.calendarFilter.timelineType=d));if(!(c&&a.calendarFilter.timelineType!==c))if(I[a.calendarFilter.timelineType]){if(d=a.visibleCompany){var f=a.navigationFilter.date.clone();I[a.calendarFilter.timelineType](b,f,d)}}else console.error("timeline: Invalid timeline type:",a.calendarFilter.timelineType)}},
ba=_.debounce(function(){a.$safeApply(ja)},1E3,{leading:!0}),S=_.partial(ja,!0,""),ca=_.partial(ja,!0,h.Company.AVAILABILITY_TIMELINE),la=function(b){return v.populate(v.dashboard.bookings.timeline.date,{shortname:a.company.shortname,date:b.format("YYYY-MM-DD")})};y.nextDayUrl=function(){var b=a.navigationFilter.date.clone();b.add(1,"days");return la(b)};y.currentDayUrl=function(){return la(moment())};y.previousDayUrl=function(){var b=a.navigationFilter.date.clone();b.add(-1,"days");return la(b)};
var na=!1;b=function(){na||(na=!0,a.$watch("timelineCtrl.selectedDate",function(b){b=moment(b,"YYYY-MM-DD");a.navigationFilter.date.diff(b)&&s.navigate(la(b))}),s.watch(a,function(b){if(s.pathEquals(v.dashboard.bookings.timeline.index))s.redirect(v.populate(v.dashboard.bookings.timeline.date,{shortname:a.company.shortname,date:moment().format("YYYY-MM-DD")}));else{var c=s.pathEquals(v.dashboard.bookings.timeline.date);c?(b=moment(c.date),a.navigationFilter.date=b,y.selectedDate=b.format("YYYY-MM-DD"),
S()):console.warn("invalid timeline view path",b)}}),a.$watch("calendarFilter",ba,!0),m.on(a,"lib.shared.CalendarCtrl.refresh",S),m.on(a,"dashboard.shared.BlocksCtrl.created",ca),m.on(a,"dashboard.shared.BlockEditableCtrl.updated",ca),m.on(a,"dashboard.shared.BlockEditableCtrl.removed",ca),m.on(a,"dashboard.shared.ItemColorEditableCtrl.updated",ja),m.on(a,"dashboard.bookings.NavigationCtrl.filterChoicesUpdated",S),r.watch(a,a.company,"bookings",S))};!g.fresh(a.resources)&&!g.fresh(a.items)&&b();f.all([a.resources.$promise,
a.items.$promise]).then(b)}]);h.controller("dashboard.bookings.GridCtrl",["$scope","$filter","$q","cache","db","events","dashboard.bookings.grid","localization","navigation","require","sonar","urls",function(a,b,f,e,g,d,l,m,k,h,s,p){h.inScope(a,"navigationFilter","dashboard.bookings.GridCtrl");h.inScope(a,"filteredItems","dashboard.bookings.GridCtrl");h.inScope(a,"visibleCompany","dashboard.bookings.GridCtrl");h.inScope(a,"company","dashboard.bookings.GridCtrl");moment().startOf("day");var r=a.filteredItems,
t=_.times(l.DIMENSIONS,function(){return[]}),v={},y=function(a){return _.pluck(a,"identifier").join(",")},q=function J(b,c){if(c){if(c.length){var d=_.last(c);c=_.initial(c);b=_.clone(b);return!_.any(t[d],function(e){if(e.isFiltered(a))return!1;b[d]=e;return!J(b,c)})}var e=v[y(b)];if(!e)return!0;e=e.availabilities;return!e.length?!0:!_.any(e,function(b){return!a.isCalendarFiltered(b)})}b||(b={});if(_.any(b,function(b){return b.isFiltered(a)}))return!0;_.isArray(b)||(b=l.orderedArray(b));c=[];_.forEach(b,
function(a,b){a||c.push(b)});return J(b,c)},B=function(b,c){if(c.dontFilterHeading)return!1;var d={};d[b]=c;return c.isFiltered(a)||q(d)};b=function(b,c,d,e){if(d.dontFilterHeading)return!1;var f={};f[b]=d;f[c]=e;return d.isFiltered(a)||e.isFiltered(a)||q(f)};m=function(a,b){return _.reject(t[a],_.partial(B,b))};var u=a.gridCtrl={version:0,selectedDate:a.navigationFilter.date.format("YYYY-MM-DD"),columnAxis:t[l.COLUMN_INDEX],rowAxis:t[l.ROW_INDEX],groupAxis:t[l.GROUP_INDEX],hasStartOnAxis:function(){return _.any(t,
"isStartOnAxis")},filteredColumnAxis:_.partial(m,l.COLUMN_INDEX,"column"),filteredRowAxis:_.partial(m,l.ROW_INDEX,"row"),filteredGroupAxis:_.partial(m,l.GROUP_INDEX,"group"),everyDayHasLoaded:!0,point:function(a){return v[y(l.orderedArray(a))]},hasAnyUnfilteredPoints:function(){return 0<_.size(v)&&!q()},isColumnFiltered:_.partial(B,"column"),isGroupFiltered:_.partial(B,"group"),isRowFilteredInGroup:_.partial(b,"row","group"),isGroupFilteredInColumn:_.partial(b,"group","column"),isPointFiltered:q,
isColumnEmpty:function(a){return q({column:a})},activeColumnCoord:null,setActiveColumn:function(a){u.activeColumnCoord=a},setActiveColumnToToday:function(){u.columnAxis.axisType===l.START_ON_AXIS&&(u.activeColumnCoord=l.startOnCoordinate(moment()))},isActiveColumn:function(a){return u.activeColumnCoord&&u.activeColumnCoord.identifier===a.identifier},axisTypeLabel:_.propertyOf(l.AXIS_TYPE_LABELS),availabilityClasses:function(){if(!a.calendarFilter)return"";var b=a.calendarFilter.gridAxisTypes,c=[];
_.includes(b,l.START_TIME_AXIS)&&c.push("availabilities-hide-time");_.includes(b,l.ITEM_AXIS)&&c.push("availabilities-hide-item");_.includes(b,l.CREW_AXIS)&&c.push("availabilities-hide-crew");return c.join(" ")},pastPresentFutureClass:function(a){if(a.isToday)return"current-day";if(a.isPastDay)return"past-day"}},z=function(a,b,c){var d=_.find(a,"identifier",c.identifier);d||(_.insertSorted(a,c,"orderBy"),d=c,d.dayKeys={});d.dayKeys[b]=!0},C=function(a,b,c){c=t[c];a=_.castArray((0,l.axisMappers[c.axisType])(a));
_.forEach(a,_.partial(z,c,b));return a},F=function(a,b,c){var d=y(c);v[d]||(v[d]={coordinates:c,dayKey:b,availabilities:[]});v[d].availabilities.push(a)},x=function ea(a){if(1===a.length)return _.map(a[0],function(a){return[a]});var b=a[0],c=ea(_.tail(a));return _.reduce(b,function(a,b){return a.concat(_.map(c,function(a){return[b].concat(a)}))},[])},w=function(a,b){_.forEach(v,function(b){b.dayKey===a&&_.clear(b.availabilities)});_.forEach(b,function(b){var c=_.map(_.range(l.DIMENSIONS),_.partial(C,
b,a)),c=x(c);_.forEach(c,_.partial(F,b,a))})},G={},M={},K=function(a){return 6E5>=Date.now()-a.timestamp},H=function(a,b,c){var d=l.dayIdentifier(c);b=_.extend({date:c.format("YYYY-MM-DD")},b);var k=_.stringifyJSON(b);if((c=M[k])&&K(c))if(w(d,c.availabilities),!a)return f.when("cached");if(G[k])return e.fresh(G[k].availabilities)||w(d,G[k].availabilities),G[k].$promise;var m=g.availabilities.searchByDate(b);G[k]={dayKey:d,params:b,availabilities:m,$promise:m.$promise};e.fresh(m)||w(d,m);return m.$promise.then(function(a){delete G[k];
if(a===g.CANCELLED)return"cancelled";M[k]={timestamp:Date.now(),availabilities:m};w(d,m);return"loaded"},function(){})};b=function(b){if(a.visibleCompany&&a.calendarFilter&&r&&r.length){var c=_.zipObject(_.map(_.range(a.calendarFilter.gridDayRange),function(b){b=a.navigationFilter.date.clone().add(b,"days");return[l.dayIdentifier(b),b]})),d={shortname:a.visibleCompany.shortname,itemPks:_.pluck(r,"pk").join(",")};G=_.pick(G,function(a){var b=c[a.dayKey];(b=!!b&&angular.equals(a.params,_.extend({date:b.format("YYYY-MM-DD")},
d)))||a.$promise.cancel();return b});M=_.pick(M,K);var e=a.calendarFilter.gridAxisTypes,g=!1;_.forEach(t,function(a,b){var d=e[b],f=d===l.START_ON_AXIS;a.axisType!==d?(_.clear(a),a.axisType=d,a.isNullAxis=d===l.NULL_AXIS,a.isStartOnAxis=d===l.START_ON_AXIS,a.isItemAxis=d===l.ITEM_AXIS,g=!0):f||_.overwriteWithout(a,function(a){return _.reduce(_.keys(a.dayKeys),function(b,d){if(c[d])return!0;delete a.dayKeys[d];return b},!1)});f&&(_.clear(a),_.forEach(c,function(b){z(a,b,l.startOnCoordinate(b))}))});
if(!u.activeColumnCoord||!_.find(u.columnAxis,"identifier",u.activeColumnCoord.identifier))u.activeColumnCoord=u.columnAxis.axisType===l.START_ON_AXIS?u.columnAxis[0]:null;g?_.clear(v):_.overwriteWithout(v,function(a){return!c[a.dayKey]});b=_.map(c,_.partial(H,b,d));u.everyDayHasLoaded=!1;f.all(b).then(function(a){_.any(a,_.isReferenceEqualTo("cancelled"))||(u.everyDayHasLoaded=!0,u.version++)})}};var L=_.partial(b,!1),E=_.partial(b,!0),N=_.debounce(function(){a.$safeApply(E)},1E3,{leading:!0}),I=
_.debounce(function(){a.$safeApply(L)},500,{leading:!0}),D;a.$watch("calendarFilter.gridAxisTypes",function(b,c){if(b&&b.length){if(c){var d=null,e=!1;_.forEach(b,function(a,b){a!==c[b]&&(null!==d&&(e=!0),d=b)});if(!e&&null!==d){var f=b[d],g=_.indexOf(c,f);-1<g&&f!==l.NULL_AXIS&&(b[g]=l.NULL_AXIS)}}_.any(t,function(a,c){return a.axisType!==b[c]})&&(f=_.indexOf(b,l.START_ON_AXIS),-1===f?(1<a.calendarFilter.gridDayRange&&(D=a.calendarFilter.gridDayRange),a.calendarFilter.gridDayRange=1):(D&&(a.calendarFilter.gridDayRange=
D,D=null),a.calendarFilter.gridDayRange=Math.min(l.MAX_DAY_RANGES[f],a.calendarFilter.gridDayRange)),E())}},!0);a.$watch("calendarFilter.gridDayRange",L);s.watch(a,a.company,"bookings",E);d.on(a,"lib.shared.CalendarCtrl.refresh",E);d.on(a,"dashboard.shared.BlocksCtrl.created",E);d.on(a,"dashboard.shared.BlockEditableCtrl.updated",E);d.on(a,"dashboard.shared.BlockEditableCtrl.removed",E);d.on(a,"dashboard.shared.ItemColorEditableCtrl.updated",E);d.on(a,"dashboard.bookings.NavigationCtrl.filterChoicesUpdated",
function(a,b){b&&b.filteredItems&&(r=b.filteredItems);L()});d.on(a,"dashboard.bookings.NavigationCtrl.calendarFilter.items",function(a,b){var c=_.difference(b.items,r).length;r=b.items;c&&N()});k.watch(a,function(b){if(k.pathEquals(p.dashboard.bookings.grid.index))k.redirect(p.populate(p.dashboard.bookings.grid.date,{shortname:a.company.shortname,date:moment().format("YYYY-MM-DD")}));else{var c=k.pathEquals(p.dashboard.bookings.grid.date);if(c)b=moment(c.date),a.navigationFilter.date=b,u.columnAxis.axisType===
l.START_ON_AXIS&&(u.activeColumnCoord=l.startOnCoordinate(b)),u.selectedDate=b.format("YYYY-MM-DD"),I();else throw Error("dashboard.bookings.NavigationCtrl: invalid grid view url "+b);}});var Z=function(b){return p.populate(p.dashboard.bookings.grid.date,{shortname:a.company.shortname,date:b.format("YYYY-MM-DD")})};u.nextDayUrl=function(){var b=a.navigationFilter.date.clone();b.add(1,"days");return Z(b)};u.currentDayUrl=function(){return Z(moment())};u.previousDayUrl=function(){var b=a.navigationFilter.date.clone();
b.add(-1,"days");return Z(b)};u.nextDaysUrl=function(){var b=a.navigationFilter.date.clone();b.add(a.calendarFilter?a.calendarFilter.gridDayRange:7,"days");return Z(b)};u.previousDaysUrl=function(){var b=a.navigationFilter.date.clone();b.add(-(a.calendarFilter?a.calendarFilter.gridDayRange:7),"days");return Z(b)};a.$watch("gridCtrl.selectedDate",function(b){b=moment(b,"YYYY-MM-DD");a.navigationFilter.date.diff(b)&&k.navigate(Z(b))})}]);h.controller("dashboard.bookings.CrewCtrl",["$scope","controllers",
"db","models","require",function(a,b,f,e,g){var d=f.users({shortname:a.company.shortname});a.showInactiveUsers=!1;a.toggleInactiveUsers=function(){a.showInactiveUsers=!a.showInactiveUsers;a.users=a.showInactiveUsers?e.User.sortActiveFirst(d):e.User.getActive(d)};return b.dataController(a,{promises:[d.$promise],successCallback:function(){a.users=e.User.getActive(d)},stale:[d]})}]);h.controller("dashboard.bookings.ResourcesCtrl",["$scope","require",function(a,b){b.inScope(a,"company","dashboard.bookings.ResourcesCtrl");
b.inScope(a,"resources","dashboard.bookings.ResourcesCtrl")}]);h.controller("dashboard.bookings.GridSettingsCtrl",["$scope","auth","models","dashboard.bookings.grid","require",function(a,b,f,e,g){g.inScope(a,"visibleCompany","dashboard.bookings.GridSettingsCtrl");var d=a.gridSettingsCtrl={dimensions:e.DIMENSIONS,axisLabels:e.AXIS_LABELS,axisChoices:e.filterAxisChoices(e.AXIS_CHOICES,a.visibleCompany),startOnAxis:e.START_ON_AXIS,maxDayRanges:e.MAX_DAY_RANGES,reset:function(){a.calendarFilter&&_.extend(a.calendarFilter,
e.defaultSettings())}};a.$watch("visibleCompany",function(){d.axisChoices=e.filterAxisChoices(e.AXIS_CHOICES,a.visibleCompany)})}]);h.controller("dashboard.bookings.CustomCalendarsCtrl",["$scope","auth","controllers","db","events","dashboard.bookings.grid","models","navigation","require","dashboard.bookings.timeline",function(a,b,f,e,g,d,l,m,k,h){k.inScope(a,"company","dashboard.bookings.CustomCalendarsCtrl");k.inScope(a,"items","dashboard.bookings.CustomCalendarsCtrl");k.inScope(a,"resources","dashboard.bookings.CustomCalendarsCtrl");
var s=function(){var b={name:T("All items"),settings:{items:{},users:{},groupedItems:{},resources:{},hideEmpty:!1,showRecent:!1,showCrew:!0,showResources:!1,showAllResources:!0,visibleResources:{},showPrivateHeadline:!0,showFilledSeats:!1,showEmptySeats:!0,countBlockedAsFilled:!0,isColorCoded:!0,customGrouping:!1,minimumAvailableCapacity:""}};_.extend(b.settings,d.defaultSettings());_.extend(b.settings,h.defaultSettings());_.forEach(a.items,function(a){b.settings.items[a.uri]=!0;b.settings.groupedItems[a.uri]=
a.isGroupedCalendar});_.forEach(a.resources,function(a){b.settings.resources[a.uri]=!1;b.settings.visibleResources[a.uri]=!1});return b},p=!0,r=a.currentCustomCalendar=null;a.refreshCurrentCalendar=function(){p=a.currentCustomCalendar?_.all(a.calendarFilter,function(a,b){var c=r[b];return"dashboardBookingsView"===b&&!c?!0:angular.equals(a,c)}):!0};a.isCustomCalendarSelected=function(b){return a.currentCustomCalendar===b};a.isCustomCalendarDirty=function(b){return!p&&a.isCustomCalendarSelected(b)};
a.updateCurrentCustomCalendar=function(d,e){var f="customCalendar:"+m.currentCompany.shortname;d?(b.storage.set(f,d.uri),a.currentCustomCalendar=d,r=_.clone(e,!0)):(b.storage.del(f),r=a.currentCustomCalendar=null);p=!0};a.applyCustomCalendar=function(b,c){var d=s(),e=_.extend({},d.settings,b?b.settings:{});_.forEach(e,function(a,b){e[b]=_.clone(a)});e.isColorCoded=e.isColorCoded&&a.visibleCompany.features.isItemColorsEnabled;a.applyCalendarFilter(e,c);b&&b.uri?a.updateCurrentCustomCalendar(b,e):a.updateCurrentCustomCalendar()};
a.isFiltering=function(b){return!a.calendarFilter?!1:!b&&(a.calendarFilter.hideEmpty||a.calendarFilter.minimumAvailableCapacity||a.calendarFilter.hideNoAvailableResources||a.calendarFilter.noCrewAssigned||a.calendarFilter.noResourcesUsed)||_.any(a.calendarFilter.users)||_.any(a.calendarFilter.resources)?!0:!1};var t=null,v=null,y=function(){var b;b=a.browserFilter.networkSelection===l.Calendar.COMPANY_FILTER?a.currentCustomCalendar||t||v||_.first(a.customCalendars):null;a.applyCustomCalendar(b,!0)};
b.currentUser.defaultCustomCalendar&&(v=_.contains(a.customCalendars,b.currentUser.defaultCustomCalendar)?b.currentUser.defaultCustomCalendar:null);var q=b.storage.get("customCalendar:"+m.currentCompany.shortname);q&&(t=_.find(a.customCalendars,function(a){return a.uri===q}));f.listController(a,{collectionKey:"customCalendars",modelKey:"newCustomCalendar",create:e.customCalendars.create,submitCallback:function(){a.newCustomCalendar.settings=_.stringifyJSON(a.calendarFilter)},successCallback:function(b){a.applyCustomCalendar(b)},
params:function(){return{shortname:m.currentCompany.shortname}},sortable:!0});var B=!0;m.watch(a,function(){(B||a.isRedirectNeeded())&&y();B=!1},"path");g.on(a,"dashboard.bookings.NavigationCtrl.filterChoicesUpdated",function(a,b){y()});var u=function(a,b){a!==b&&g.broadcast("lib.shared.CalendarCtrl.refresh")};_.forEach(["calendarFilter.isColorCoded","calendarFilter.countBlockedAsFilled"],function(b){a.$watch(b,u)})}]);h.controller("dashboard.bookings.CalendarCtrl",["$scope","availabilityCalendarController",
"db","events","models","require","sonar","urls",function(a,b,f,e,g,d,l,m){d.inScope(a,"company","dashboard.bookings.CalendarCtrl");d.inScope(a,"browserFilter","dashboard.bookings.CalendarCtrl");d.inScope(a.browserFilter,"networkSelection","dashboard.bookings.CalendarCtrl");d.inScope(a,"filteredItems","dashboard.bookings.CalendarCtrl");d.inScope(a,"goToViewForDay","dashboard.bookings.CalendarCtrl");e=function(){a.calendarFilter&&(a.filteredItems&&a.filteredItems.length)&&a.calendarCtrl.debouncedRefresh()};
a.$watch("calendarFilter.customGrouping",e);a.$watchCollection("calendarFilter.groupedItems",e);b(a,{url:a.company.$url(m.dashboard.bookings.calendar),company:a.company,isSundayBased:function(){return a.visibleCompany.features.isSundayBased},isEmptyAllowed:!0,endpoint:f.items.calendar,params:function(){var b=a.company;a.browserFilter.networkSelection!==g.Calendar.COMPANY_FILTER&&(b=a.browserFilter.networkSelection);return{shortname:b.shortname}},items:a.filteredItems,queryParams:function(){var b=
{};if(a.calendarFilter.customGrouping){var c=_.choose(a.filteredItems,function(b){if(a.calendarFilter.groupedItems[b.uri])return b.pk});c.length&&(b.groups=c.join(","))}else b.allowGrouped="yes";return b},beforeRequest:function(){return!a.isNetwork},largeDaySelected:a.goToViewForDay,autoOpenItemGroups:!1});l.watch(a,a.calendarCtrl.company,"bookings",a.calendarCtrl.debouncedRefresh)}]);h.controller("dashboard.bookings.AvailabilityCtrl",["$scope","auth","controllers","db","events","models","navigation",
"require","sonar","urls",function(a,b,f,e,g,d,l,m,k,h){var s=this;m.inScope(a,"company","dashboard.bookings.AvailabilityCtrl");var p=a.route.bindings.availabilityPk,r=a.route.bindings.itemPk;d=d.Availability.CONTACT_NAME_SORT_ORDER;var t=function(){a.availability=e.availability({shortname:a.company.shortname,itemPk:r,availabilityPk:p})};t();a.allBookings=e.bookings({shortname:a.company.shortname,itemPk:r,availabilityPk:p});s.preferredSortOrder=b.storage.get("AvailabilityCtrl.sortOrder")||d;s.preferredCancelledSortOrder=
b.storage.get("AvailabilityCtrl.cancelledSortOrder")||d;d=_.every(["bookingCount","customerBreakdown","customerCount","bookableCapacity"],function(b){return!_.isUndefined(a.availability[b])});g.on(a,"dashboard.shared.AvailabilityEditableCtrl.removed",function(a,b){var c=l.multiUrl(l.currentCompany.$url(h.dashboard.overlay.close));l.redirect(c,"replace")});s.saveSortOrder=function(a){s.preferredSortOrder=a;b.storage.set("AvailabilityCtrl.sortOrder",a)};s.saveCancelledSortOrder=function(a){s.preferredCancelledSortOrder=
a;b.storage.set("AvailabilityCtrl.cancelledSortOrder",a)};return f.dataController(a,{stale:d?[a.availability]:null,promises:[a.availability.$promise],successCallback:function(){a.item=a.availability.item;k.watch(a,a.availability,"bookings",function(){t()});k.watch(a,a.availability,"updated",function(){return k.get(a.availability.uri).$promise})}})}]);h.controller("dashboard.bookings.AvailabilityActionsCtrl",["$scope","auth","controllers","db","events","models","navigation","require","urls",function(a,
b,f,e,g,d,l,m,k){m.inScope(a,"availability","dashboard.bookings.AvailabilityActionsCtrl");a.actionsCtrl={NONE:"none",NOTIFY:"notify",NOTIFY_SMS:"notify-sms",SETTINGS:"settings",PRICES:"prices",INTEGRATIONS:"integrations"};a.actionsCtrl.selected=a.actionsCtrl.NONE;var h={};h[a.actionsCtrl.NOTIFY]=function(){return b.permissions.canCreate(d.Notification,a.company)&&a.availability.bookingCount};h[a.actionsCtrl.NOTIFY_SMS]=function(){return b.permissions.canCreate(d.SmsNotification,a.company)&&a.availability.bookingCount};
h[a.actionsCtrl.SETTINGS]=function(){return b.permissions.canUpdate(a.availability)};h[a.actionsCtrl.PRICES]=_.always;h[a.actionsCtrl.INTEGRATIONS]=e.slipstream("isReadonlyEnabled")?_.never:_.always;a.actionsCtrl.isSelectable=function(a){return _.has(h,a)?h[a]():!1};a.actionsCtrl.select=function(b){a.actionsCtrl.isSelectable(b)&&(a.actionsCtrl.selected=b)};a.actionsCtrl.reset=function(){a.actionsCtrl.selected=a.actionsCtrl.NONE;a.actionsCtrl.populateSmsOptedOutBookings([])};a.createBooking=b.permissions.canCreate(d.Booking,
a.company);l.watch(a,function(){var b=l.get("action");_.has(h,b)&&(l.clear("action",!0),a.actionsCtrl.select(b));l.pathEquals(k.dashboard.overlay.availability.index)&&a.actionsCtrl.reset()},"url");a.actionsCtrl.isSelected=function(b){return a.actionsCtrl.selected===b};a.actionsCtrl.smsOptedOutBookings=[];a.actionsCtrl.populateSmsOptedOutBookings=function(b){a.actionsCtrl.smsOptedOutBookings=b}}]);h.controller("dashboard.bookings.CustomerTypeRatesCtrl",["$scope","controllers","db","events","require",
function(a,b,f,e,g){g.inScope(a,"availability","dashboard.bookings.CustomerTypeRatesCtrl");a.customerTypeRates=a.availability.customerTypeRates;a.customerPrototypes=[];var d=f.customerPrototypes({shortname:a.availability.company.shortname,itemPk:a.availability.item.pk}),l=function(){var b={};_.forEach(a.availability.customerTypeRates,function(a){b[a.customerPrototype.uri]=!0});var c=_.filter(d,function(a){return!b[a.uri]});_.overwrite(a.customerPrototypes,c)};b.dataController(a,{promises:[d.$promise],
successCallback:function(){l();b.listController(a,{collectionKey:"customerTypeRates",modelKey:"newCustomerTypeRate",create:f.customerTypeRates.create,params:function(){return{shortname:a.availability.company.shortname,itemPk:a.availability.item.pk,availabilityPk:a.availability.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");e.broadcast("pricing.ngPricing.refresh",{object:a.availability});l()},defaultModel:{isExclusive:!1,capacity:"",minimumPartySize:"",maximumPartySize:""}})}});
e.on(a,"dashboard.shared.CustomerTypeRateEditableCtrl.removed",function(){l()})}]);h.controller("dashboard.bookings.AvailabilityPricingCtrl",["$scope","controllers","require",function(a,b,f){f.inScope(a,"availability","dashboard.bookings.AvailabilityPricingCtrl");a.editingPricing=!0;a.editPricing=function(){a.editingPricing=!0};b.dataController(a,{promises:[a.availability.$promise],successCallback:function(){a.editingPricing=!a.availability.isInheritedPricing}})}]);h.controller("dashboard.bookings.ItemCtrl",
["$scope","controllers","db","navigation","require","urls",function(a,b,f,e,g,d){g.inScope(a,"company","dashboard.bookings.ItemCtrl");e=a.route.bindings.shortname;g=a.route.bindings.itemPk;a.date=moment(a.route.bindings.date,"YYYY-MM-DD");a.nextDate=a.date.clone().add(1,"days");a.previousDate=a.date.clone().subtract(1,"days");a.item=f.item({shortname:e,itemPk:g});a.availabilities=f.availabilities.byDate({shortname:e,itemPk:g,date:a.date.format("YYYY-MM-DD")});a.itemManifestUrl=d.populate(d.dashboard.manifest.items,
{shortname:e,itemPk:g,date:a.date.format("YYYY-MM-DD")});a.dayUrl=d.dayUrlForCompany(a.company,a.date);return b.dataController(a,{promises:[a.item.$promise,a.availabilities.$promise]})}]);h.controller("dashboard.bookings.ContactCtrl",["$scope","$filter","controllers","db","events","models","navigation","sonar","urls",function(a,b,f,e,g,d,l,m,k){a.contact=e.contact({shortname:a.route.bindings.shortname,contactPk:a.route.bindings.contactPk});a.contactTracker=_.tracker();var h=function(){return m.get(a.contact.uri).$promise.then(function(){a.contactTracker.modified()})};
g.on(a,"dashboard.bookings.ContactCtrl.refresh",h);var s=function(){var b=[a.contact];_.forEach(a.contact.relatedOrders,function(a){b.push(a);_.ref.append(b,a.allBookings)});_.ref.append(b,a.contact.standAloneBookings);return b},p=function(a){return _.chooseFirst(a,function(a){return l.pathStartsWith(a)})},r=[k.dashboard.overlay.contact.order,k.dashboard.bookings.contact.order,k.dashboard.bookings.contact.affiliateOrderPermalink],t=[k.dashboard.overlay.contact.booking,k.dashboard.bookings.contact.booking,
k.dashboard.bookings.contact.affiliateBookingPermalink],v=function(a){var b;if(b=p(r))return b=b.orderUuid,_.find(a,{uuid:b});if(b=p(t))return b=b.bookingUuid,_.find(a,{uuid:b})},y=function(a){var e,f=s();e=(e=v(f))?_.indexOf(f,e):0;e=(e+(a||1))%f.length;0>e&&(e=f.length-1);e=f[e];if(e.cls===d.Contact.cls)a=b("contactUrl")(e);else if(e.cls===d.Order.cls)a=b("orderUrl")(e);else if(e.cls===d.Booking.cls)a=b("bookingUrl")(e);else return;l.navigate(a)};a.selectNext=function(){y(1)};a.selectPrevious=function(){y(-1)};
a.currentBooking=function(){var a=s();if(a=v(a))return a.cls===d.Order.cls&&(a=a.allBookings[0]),a};return f.dataController(a,{stale:[a.contact,a.contact.relatedOrders,a.contact.relatedBookings],promises:[a.contact.$promise],successCallback:function(){m.watch(a,a.contact,"updated",h);m.watch(a,a.contact,"bookings",h);a.contactTracker.modified()}})}]);h.controller("dashboard.bookings.ViewContactCtrl",["$scope","$q","controllers","db","sonar",function(a,b,f,e,g){var d=_.map(a.contact.relatedOrders,
function(a){return e.order({shortname:a.company.shortname,orderUuid:a.uuid})}),d=b.all(_.pluck(d,"$promise")),l=_.map(a.contact.standAloneBookings,function(a){return e.booking({shortname:a.company.shortname,itemPk:a.availability.item.pk,bookingUuid:a.uuid})});b=b.all(_.pluck(l,"$promise"));f.dataController(a,{promises:[d,b],successCallback:function(){g.watch(a,a.contact.relatedOrders,"updated",function(a){return g.get(a.uri).$promise});g.watch(a,a.contact.standAloneBookings,"updated",function(a){return g.get(a.uri).$promise})}})}]);
h.controller("dashboard.bookings.ViewOrderCtrl",["$scope","auth","controllers","db","models","sonar",function(a,b,f,e,g,d){a.order=e.order({shortname:a.route.bindings.shortname,orderUuid:a.route.bindings.orderUuid});a.orderTracker=_.tracker();var l=function(){return d.get(a.order.uri).$promise.then(function(){a.orderTracker.modified()})};b=_.append([a.order,a.order.allBookings],_.pluck(a.order.allBookings,"customers"));f.dataController(a,{stale:b,promises:[a.order.$promise],successCallback:function(){a.contact=
a.order.contact;d.watch(a,a.order,"updated",l);d.watch(a,a.order.allBookings,"updated",l);a.order.company.features.isTaxTypeBreakdownEnabled&&(a.taxTypes=e.taxTypes.all({shortname:a.order.company.shortname}))}})}]);h.controller("dashboard.bookings.DeprecatedBookingPermalinkPages",["$scope","controllers","db","navigation","urls",function(a,b,f,e,g){var d=a.route.bindings.bookingUuid,l=a.route.bindings.shortname;a.booking=f.booking({shortname:l,bookingUuid:d});b.dataController(a,{stale:[a.booking],
promises:[a.booking.$promise],successCallback:function(){if(a.isAffiliate)return e.navigate(g.populate(g.dashboard.bookings.contact.affiliateBookingPermalink,{contactPk:a.booking.contact.pk,bookingUuid:d,shortname:l,affiliateShortname:a.route.bindings.affiliateShortname}));e.navigate(g.populate(g.dashboard.bookings.contact.booking,{contactPk:a.booking.contact.pk,bookingUuid:d,shortname:l}))}})}]);h.controller("dashboard.bookings.DeprecatedBookingOverlay",["$scope","controllers","db","navigation",
"urls",function(a,b,f,e,g){var d=a.route.bindings.shortname;a.booking=f.booking({shortname:d,bookingUuid:a.route.bindings.bookingUuid});b.dataController(a,{stale:[a.booking],promises:[a.booking.$promise],successCallback:function(){e.navigate(g.populate(g.dashboard.overlay.contact.booking,{contactPk:a.booking.contact.pk,bookingUuid:a.booking.uuid,shortname:d}))}})}]);h.controller("dashboard.bookings.ViewBookingCtrl",["$scope","auth","controllers","db","events","models","navigation","plusbook","require",
"sonar","urls","moment",function(a,b,f,e,g,d,l,m,k,h,s,p){k.notNull(l,"currentCompany");a.canViewAmounts=!1;a.canViewInvoiceAmounts=!1;a.displayOptions={showInvoicePrices:!1};a.needsPrice=function(b){return!b||!a.canViewAmounts||_.isArray(b)?!1:!!b.totalCost.price};l=a.route.bindings.bookingUuid;var r=a.route.bindings.shortname;a.bookingTracker=_.tracker();var t=function(){return h.get(a.booking.uri).$promise.then(function(){a.bookingTracker.modified()})};a.booking=e.booking({shortname:r,bookingUuid:l});
a.checkinStatuses=[];a.inStorePaymentTypes=[];f.dataController(a,{stale:[a.booking,a.booking.customers,a.booking.availability,a.booking.item,a.checkinStatuses],promises:[a.booking.$promise,a.inStorePaymentTypes],successCallback:function(){h.watch(a,a.booking,"updated",t);a.canViewAmounts=b.permissions.can("viewAmounts",a.booking.company);a.canViewInvoiceAmounts=b.permissions.can("viewInvoiceAmounts",a.booking.company);a.canEditCustomFieldValues=b.permissions.can("editCustomFieldValues",a.booking);
a.availability=a.booking.availability;a.item=a.booking.item;a.contact=a.booking.contact;a.booking.company.features.isTaxTypeBreakdownEnabled&&(a.taxTypes=e.taxTypes.all({shortname:a.booking.company.shortname}));b.permissions.canList(d.CheckinStatus,a.booking.company)&&(a.checkinStatuses=e.checkinStatuses({shortname:r},null,null,null,{tagAlong:!0}));b.permissions.canList(d.InStorePaymentType,a.booking.company)&&b.permissions.can("createInStore",d.Payment,a.booking)&&(a.inStorePaymentTypes=e.inStorePaymentTypes({shortname:r},
null,null,null,{tagAlong:!0}));_.forEach(a.booking.groupedWaiverInstances,function(a){_.forEach(a.waiverInstances,function(a){_.forEach(a.participants,function(a){a.ageInYears=p().diff(a.dobAt,"years")})})});if(a.booking.groupedWaiverInstances){var f=_.flatten(_.pluck(a.booking.customers,"customFieldValues")),f=a.booking.customFieldValues.concat(f),f=_.choose(f,function(a){a=a.customFieldInstance.customField;if(a.type==d.CustomField.WAIVER_TYPE)return a.connectedWaivers}),f=_.uniq(_.map(_.flatten(f),
"waiver"));_.forEach(f,function(b){_.find(a.booking.groupedWaiverInstances,{waiver:b})||a.booking.groupedWaiverInstances.push({waiver:b,participants:[],waiverParticipantCount:0})})}f=function(){a.paymentsAndRefunds=d.Booking.paymentsAndRefunds(a.booking);a.paymentsCollectedByAffiliate=_.filter(a.booking.payments,"isCollectedByAffiliate");a.paymentsCollectedByCharter=_.reject(a.booking.payments,"isCollectedByAffiliate")};f();g.on(a,"dashboard.bookings.PaymentsCtrl.created",f);g.on(a,"dashboard.bookings.DeferredPaymentCtrl.created",
f);g.on(a,"dashboard.bookings.RefundsCtrl.refunded",f);g.on(a,"fareharbor.native.overlay.closed",function(){t()})}})}]);h.controller("dashboard.bookings.LineItemsCtrl",["$scope","auth","controllers","db","events","require",function(a,b,f,e,g,d){d.inScope(a,"booking","dashboard.bookings.LineItemsCtrl");a.$bind("lineItems","booking.lineItems");a.addLineItemFormVisible=!1;a.showAddLineItemForm=function(){a.addLineItemFormVisible=!0};return f.listController(a,{collectionKey:"lineItems",modelKey:"newLineItem",
create:e.lineItems.create,params:function(){return{shortname:a.booking.company.shortname,bookingUuid:a.booking.uuid}},successCallback:function(){g.broadcast("dashboard.shared.ActivitiesCtrl.refresh");a.addLineItemFormVisible=!1},defaultModel:{offset:"",isTaxable:!0,isPrivate:!1}})}]);h.controller("dashboard.bookings.NoteEditableCtrl",["$scope","controllers","db","events","require",function(a,b,f,e,g){g.inScope(a,"booking");return b.editController(a,{elementKey:"booking",modelKey:"editableBooking",
update:f.booking.note.update,successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},params:function(){return{shortname:a.booking.company.shortname,bookingUuid:a.booking.uuid}}})}]);h.controller("dashboard.bookings.WaiverEditableCtrl",["$scope","controllers","db","events","flash","require",function(a,b,f,e,g,d){d.inScope(a,"waiverInstance","dashboard.bookings.WaiverEditableCtrl");return b.removeController(a,{collectionKey:"waiverInstances",elementKey:"waiverInstance",remove:f.waiverInstance.remove,
params:function(){return{shortname:a.booking.company.shortname,waiverPk:a.waiverInstance.waiver.pk,waiverInstancePk:a.waiverInstance.pk}},removeCallback:function(){_.overwriteWithout(a.groupedWaiverInstance.waiverInstances,a.waiverInstance);a.groupedWaiverInstance.waiverParticipantCount-=a.waiverInstance.participants.length;g.success(T("Removed waiver"));e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}})}]);var b=function(a,b){var f=_.capitalize(a),e="is"+f;h.controller("dashboard.bookings."+
f+"EditableCtrl",["$scope","controllers","db","events","require",function(f,d,l,m,k){k.inScope(f,"booking");return d.editController(f,{elementKey:"booking",modelKey:"editableBooking",update:l.booking[a].update,submitCallback:function(){f.editableBooking[e]||(f.editableBooking[a]="")},successCallback:function(){m.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},editCallback:function(){f.editableBooking[e]=null!==f.booking[a];f.editableBooking[a]=null!==f.booking[a]?f.booking[a]:f.booking[b]},
params:function(){return{shortname:f.booking.company.shortname,bookingUuid:f.booking.uuid}}})}])};b("explicitGross","gross");b("explicitInvoicePrice","invoicePrice");h.controller("dashboard.bookings.NotificationOptionsEditableCtrl",["$scope","controllers","db","events","require",function(a,b,f,e,g){g.inScope(a,"booking","dashboard.bookings.NotificationOptionsEditableCtrl");g.inScope(a,"item","dashboard.bookings.NotificationOptionsEditableCtrl");b.dataController(a,{promises:[a.booking.$promise],successCallback:function(){b.editController(a,
{elementKey:"booking",modelKey:"editableBooking",update:f.booking.notificationOptions.update,successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},params:function(){return{shortname:a.booking.company.shortname,bookingUuid:a.booking.uuid}},editing:!0})}})}]);h.controller("dashboard.bookings.ContactActionsCtrl",["$scope","$attrs","auth","controllers","db","events","models","navigation","rebook","require","urls",function(a,b,f,e,g,d,l,m,k,h,s){h.inScope(a,"contact","dashboard.bookings.ContactActionsCtrl");
a.actionsCtrl={NONE:"none",CREATE_BOOKING:"create",MODIFY:"modify",MERGE:"merge"};a.actionsCtrl.actions=_.values(a.actionsCtrl);a.actionsCtrl.selected=a.actionsCtrl.NONE;a.isSet(b.isMenu)||m.watch(a,function(){var b=m.get("action");b&&(a.actionsCtrl.select(b),m.clear("action",!0))},"url");var p={};p[a.actionsCtrl.CREATE_BOOKING]=function(){return f.permissions.canCreate(l.Booking,a.contact.company)};p[a.actionsCtrl.MODIFY]=function(){return!f.permissions.canUpdate(a.contact)?!1:0<a.contact.relatedOrders.length||
1<a.contact.standAloneBookings.length&&a.contact.company.features.isDashboardOrdersEnabled?!0:!1};p[a.actionsCtrl.MERGE]=function(){return!1};a.actionsCtrl.isAnySelectable=function(b){var c=_.reject(a.actionsCtrl.actions,_.isReferenceEqualTo(a.actionsCtrl.NONE));b&&(c=_.reject(c,_.isReferenceEqualTo(b)));return _.any(c,a.actionsCtrl.isSelectable)};a.actionsCtrl.isSelectable=function(b){return!a.contact?!1:_.has(p,b)?p[b]():!1};a.actionsCtrl.isSelected=function(b){return a.actionsCtrl.selected===b};
a.actionsCtrl.select=function(b){a.actionsCtrl.isSelectable(b)&&(a.actionsCtrl.selected=b)};a.actionsCtrl.reset=function(){a.actionsCtrl.selected=a.actionsCtrl.NONE}}]);h.controller("dashboard.bookings.MergeContactsCtrl",[function(){}]);h.controller("dashboard.bookings.ModifyContactBookingsCtrl",["$scope","auth","db","events","navigation","require",function(a,b,f,e,g,d){d.inScope(a,"contact","dashboard.bookings.ModifyContactBookingsCtrl");d.inScope(a,"contactTracker","dashboard.bookings.ModifyContactBookingsCtrl");
d.inScope(a,"actionsCtrl","dashboard.bookings.ModifyContactBookingsCtrl");a.modifyContactBookingsCtrl={CREATE_ORDER_TYPE:"create",TO_ORDER_TYPE:"to",FROM_ORDER_TYPE:"from",status:"editing",selectedBookings:[],selectableBookings:[],selectableOrders:[],selectableStandAloneBookings:[]};a.modifyContactBookingsCtrl.MODIFY_TYPES=[a.modifyContactBookingsCtrl.CREATE_ORDER_TYPE,a.modifyContactBookingsCtrl.TO_ORDER_TYPE,a.modifyContactBookingsCtrl.FROM_ORDER_TYPE];a.modifyContactBookingsCtrl.isModifyTypeValid=
function(b){return b===a.modifyContactBookingsCtrl.FROM_ORDER_TYPE?0<a.contact.relatedOrders.length:b===a.modifyContactBookingsCtrl.CREATE_ORDER_TYPE?!a.contact.company.features.isDashboardOrdersEnabled?!1:0<a.contact.relatedOrders.length||1<a.contact.standAloneBookings.length:!a.contact.company.features.isDashboardOrdersEnabled?!1:1<a.contact.relatedOrders.length||0<a.contact.relatedOrders.length&&0<a.contact.standAloneBookings.length};d=_.append([a.modifyContactBookingsCtrl.CREATE_ORDER_TYPE],_.pluck(a.contact.relatedOrders,
"pk"),[a.modifyContactBookingsCtrl.FROM_ORDER_TYPE]);a.modifyContactBookingsCtrl.isAnyModifyTypeValid=_.any(d,a.modifyContactBookingsCtrl.isModifyTypeValid);a.editableBookings={modifyType:_.find(d,a.modifyContactBookingsCtrl.isModifyTypeValid)};var l=g.get("to")||null;g.clear("to",!0);if(l&&(l=_.find(a.contact.relatedOrders,{identifier:l}))&&_.contains(d,l.pk))a.editableBookings.modifyType=l.pk;d=g.getPk("booking")||null;g.clear("booking",!0);d&&(g=_.find(a.contact.relatedBookings,{pk:d}))&&(a.editableBookings["booking-"+
g.pk]=!0);var m=function(d){if(b.permissions.canUpdate(d)&&(a.editableBookings.modifyType!==a.modifyContactBookingsCtrl.FROM_ORDER_TYPE||d.isOrder)&&!(_.isInteger(a.editableBookings.modifyType)&&_.get(d,"order.pk")===a.editableBookings.modifyType))return d},k=function(){var b=[],c=_.choose(a.contact.relatedOrders,function(a){a.selectableBookings=_.choose(a.allBookings,m);if(a.selectableBookings.length)return _.ref.append(b,a.selectableBookings),a}),d=_.choose(a.contact.standAloneBookings,m);_.ref.append(b,
d);_.overwrite(a.modifyContactBookingsCtrl.selectableBookings,b);_.overwrite(a.modifyContactBookingsCtrl.selectableOrders,c);_.overwrite(a.modifyContactBookingsCtrl.selectableStandAloneBookings,d)},h=function(){var b=_.choose(a.modifyContactBookingsCtrl.selectableBookings,function(b){if(a.editableBookings["booking-"+b.pk])return b});_.overwrite(a.modifyContactBookingsCtrl.selectedBookings,b)};k();h();a.$watch("editableBookings",function(){k();h()},!0);a.modifyContactBookingsCtrl.isValid=function(){if(!a.modifyContactBookingsCtrl.isAnyModifyTypeValid)return!1;
var b=1;a.editableBookings.modifyType===a.modifyContactBookingsCtrl.CREATE_ORDER_TYPE&&(b=2);return a.modifyContactBookingsCtrl.selectedBookings.length>=b};a.modifyContactBookingsCtrl.submit=function(b){a.modifyContactBookingsCtrl.status="loading";var c=null,d=a.editableBookings.modifyType;_.isInteger(d)&&(c=d,d=a.modifyContactBookingsCtrl.TO_ORDER_TYPE);c={modifyType:d,order:c,bookings:_.pluck(a.modifyContactBookingsCtrl.selectedBookings,"pk")};f.contact.bookings.update({shortname:a.contact.company.shortname,
contactPk:a.contact.pk},c,b).$promise.then(function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");a.actionsCtrl.reset();a.contactTracker.modified()},function(){a.modifyContactBookingsCtrl.status="editing"})}}]);h.controller("dashboard.bookings.OrderActionsCtrl",["$scope","auth","controllers","db","events","models","navigation","rebook","require","urls",function(a,b,f,e,g,d,l,m,k,h){k.inScope(a,"order","dashboard.bookings.OrderActionsCtrl");a.actionsCtrl={NONE:"none",REFUND:"refund",CANCEL:"cancel",
MOVE_TO_ORDER:"move",ADD_BOOKING:"add",NOTIFY_ORDER:"notify-order",ADD_PAYMENT:"add-payment",PRINT_RECEIPT:"print-receipt"};a.actionsCtrl.selected=a.actionsCtrl.NONE;var s={};s[a.actionsCtrl.NOTIFY_ORDER]=function(){return b.permissions.canCreate(d.Notification,a.order)};s[a.actionsCtrl.ADD_BOOKING]=function(){return!a.order.company.features.isDashboardOrdersEnabled?!1:b.permissions.canCreate(d.Booking,a.order.company)};s[a.actionsCtrl.MOVE_TO_ORDER]=function(){return!a.order.company.features.isDashboardOrdersEnabled||
!b.permissions.canUpdate(a.order.contact)?!1:1<a.order.contact.relatedOrders.length?!0:0<a.order.contact.standAloneBookings.length};s[a.actionsCtrl.REFUND]=function(){return!_.some(a.order.contributingBookings,function(a){return _.some(a.payments,"isRefundable")})?!1:_.all(a.order.contributingBookings,function(a){return b.permissions.canCreate(d.Refund,a)&&b.permissions.can("viewAmounts",a.company)})};s[a.actionsCtrl.CANCEL]=function(){return _.some(a.order.contributingBookings,function(a){return!a.isCancelled&&
(b.permissions.can("cancel",a)||b.permissions.can("cancelEligible",a))})};s[a.actionsCtrl.ADD_PAYMENT]=function(){return!_.some(a.order.contributingBookings,function(a){return 0<a.amountDue})?!1:_.all(a.order.contributingBookings,function(a){return b.permissions.canCreate(d.Payment,a)&&(b.permissions.can("createInStore",d.Payment,a)||b.permissions.can("createCreditCard",d.Payment,a))})};s[a.actionsCtrl.PRINT_RECEIPT]=_.always;a.actionsCtrl.isSelectable=function(b){return!a.order?!1:_.has(s,b)?s[b]():
!1};a.actionsCtrl.isSelected=function(b){return a.actionsCtrl.selected===b};a.actionsCtrl.select=function(b){a.actionsCtrl.isSelectable(b)&&(a.actionsCtrl.selected=b)};a.actionsCtrl.reset=function(){a.actionsCtrl.selected=a.actionsCtrl.NONE};if(f=l.get("action"))l.clear("action",!0),a.actionsCtrl.select(f);var p=function(b,c){var d="";a.actionsCtrl.isSelected(a.actionsCtrl.CANCEL)&&(d+="refund-payments-for-booking-"+b.booking.pk+"-");return d+"payment-"+b.pk+"-"+c},r=function(a,b,c){var d=p(b,"isSelected");
a[d]=c.isSelected;d=p(b,"isFullRefund");a[d]=c.isFullRefund;c=p(b,"refundGross");a[c]=b.receipt.gross};a.actionsCtrl.setDefaults=r;a.actionsCtrl.initializeRefundablePayments=function(b,c,d,e){_.forEach(c,function(c){r(b,c,e);a.$watch(function(){var a=p(c,"isFullRefund");return b[a]},function(a){var e=p(c,"refundGross");b[e]=a?c.receipt.gross:0<d.amountOverpaid&&d.amountOverpaid<=c.receipt.gross?d.amountOverpaid:""})})};a.actionsCtrl.isPaymentSelected=function(a,b){var c=a[p(b,"isSelected")],d=a[p(b,
"refundGross")],e=a[p(b,"isFullRefund")];return c&&(d||e)};a.actionsCtrl.unselectPayment=function(a,b){a[p(b,"isSelected")]=!1;a[p(b,"isFullRefund")]=!1};a.actionsCtrl.unselectPayments=function(b,c){c=_.filter(c,function(a){return a.isRefundable});_.forEach(c,function(c){a.actionsCtrl.unselectPayment(b,c)})};a.actionsCtrl.selectPartialRefund=function(a,b){a[p(b,"isSelected")]=!0;a[p(b,"isFullRefund")]=!1};a.actionsCtrl.isPartialRefundSelected=function(a,b){var c=a[p(b,"isSelected")],d=a[p(b,"isFullRefund")];
return c&&!d};a.actionsCtrl.selectFullRefund=function(a,b){a[p(b,"isSelected")]=!0;a[p(b,"isFullRefund")]=!0};a.actionsCtrl.selectFullRefunds=function(b,c){c=_.filter(c,function(a){return a.isRefundable});_.forEach(c,function(c){a.actionsCtrl.selectFullRefund(b,c)})};a.actionsCtrl.isFullRefundSelected=function(a,b){var c=a[p(b,"isSelected")],d=a[p(b,"isFullRefund")];return c&&d};a.actionsCtrl.refundTotal=function(b,c){return _.sum(c,function(c){return a.actionsCtrl.isPaymentSelected(b,c)?b[p(c,"isFullRefund")]?
c.receipt.total:b[p(c,"refundGross")]:0})};a.actionsCtrl.previewRefundedPayments=function(b,c){var d=[];_.forEach(c,function(c){if(!c.isCollectedByAffiliate&&!c.isDeferred&&a.actionsCtrl.isPaymentSelected(b,c)){var e;e=b[p(c,"isFullRefund")]?c.receipt.total:b[p(c,"refundGross")];d.push(""+c.pk+":"+e)}});return d.join(",")};a.actionsCtrl.updateOrder=function(b){b=b||_.ignore;a.order=e.order(a.order.uri);a.order.$promise.then(b)};a.actionsCtrl.initializeRefundablePaymentsAfterFailure=function(a,b,c){_.forEach(b,
function(b){c[b.pk]||r(a,b,{isSelected:!1,isFullRefund:!0})})}}]);h.controller("dashboard.bookings.BookingActionsCtrl",["$scope","auth","controllers","db","events","models","navigation","rebook","plusbook","require","urls",function(a,b,f,e,g,d,l,m,k,h,s){h.inScope(a,"booking","dashboard.bookings.BookingActionsCtrl");h.inScope(a,"item","dashboard.bookings.BookingActionsCtrl");h.inScope(a,"inStorePaymentTypes","dashboard.bookings.BookingActionsCtrl");a.actionsCtrl={NONE:"none",CANCEL:"cancel",REBOOK:"rebook",
MODIFY:"modify",ADD:"add",CHECK_IN:"check-in",DEFER:"defer",REFUND:"refund",CUSTOM_REFUND:"custom-refund",NOTIFY:"notify",NOTIFY_SMS:"notify-sms",VIEW_RECEIPT:"view-receipt",PRINT_RECEIPT:"print-receipt",REPRICE:"reprice",REAPPLY_RESOURCE_USES:"reapply-resource-uses",PROCESS:"process",AUTOMATIC_NOTIFICATION_OPTIONS:"automatic-notification-options"};a.isEligibleForAutomaticNotifications=function(){return b.permissions.canCreate(d.Notification,a.booking)&&(d.Booking.isEligibleForAutoFollowUpEmail(a.booking)||
d.Booking.isEligibleForAutoReminderEmail(a.booking))||b.permissions.canCreate(d.SmsNotification,a.booking)&&d.Booking.isEligibleForAutoReminderSms(a.booking)||b.permissions.canCreate(d.ReviewExpressNotification,a.booking)&&d.Booking.isEligibleForReviewExpress(a.booking)};a.actionsCtrl.selected=a.actionsCtrl.NONE;var p={};p[a.actionsCtrl.ADD]=function(){return 0<a.booking.amountDue&&b.permissions.canCreate(d.Payment,a.booking)&&(b.permissions.can("createInStore",d.Payment,a.booking)||b.permissions.can("createCreditCard",
d.Payment,a.booking)||a.booking.affiliation&&b.permissions.can("createAffiliate",d.Payment,a.booking))};p[a.actionsCtrl.REPRICE]=function(){return b.permissions.can("changePriceSheets",a.booking)};p[a.actionsCtrl.PROCESS]=function(){return b.permissions.canUpdate(a.booking)};p[a.actionsCtrl.REFUND]=function(){return b.permissions.canCreate(d.Refund,a.booking)&&b.permissions.can("viewAmounts",a.booking.company)&&_.some(a.booking.payments,"isRefundable")};p[a.actionsCtrl.CUSTOM_REFUND]=function(){return a.inStorePaymentTypes.length&&
b.permissions.can("createCustomRefunds",a.booking)};p[a.actionsCtrl.DEFER]=function(){return b.permissions.can("createDeferred",d.Payment,a.booking)};p[a.actionsCtrl.CANCEL]=function(){return!a.booking.isCancelled&&(b.permissions.can("cancel",a.booking)||b.permissions.can("cancelEligible",a.booking))};p[a.actionsCtrl.NOTIFY]=function(){return b.permissions.canCreate(d.Notification,a.booking)};p[a.actionsCtrl.NOTIFY_SMS]=function(){return b.permissions.canCreate(d.SmsNotification,a.booking)};p[a.actionsCtrl.AUTOMATIC_NOTIFICATION_OPTIONS]=
function(){return a.isEligibleForAutomaticNotifications()};p[a.actionsCtrl.REBOOK]=function(){return b.permissions.can("rebook",a.booking)||b.permissions.can("rebookEligible",a.booking)};p[a.actionsCtrl.CHECK_IN]=function(){return a.booking.company.features.isCheckinEnabled&&b.permissions.can("updateCheckinStatus",d.Customer,a.booking)};p[a.actionsCtrl.MODIFY]=p[a.actionsCtrl.REBOOK];p[a.actionsCtrl.REAPPLY_RESOURCE_USES]=function(){return(a.booking.resourceUses.length||a.booking.availability.requirementGroup)&&
b.permissions.can("reapplyResourceUses",a.booking)};var r=function(a,b){return"payment-"+a.pk+"-"+b};a.actionsCtrl.isSelectable=function(b){return a.booking.rebookedTo?!1:_.has(p,b)?p[b]():!0};a.actionsCtrl.select=function(b){a.actionsCtrl.isSelectable(b)&&(a.actionsCtrl.selected=b)};a.actionsCtrl.reset=function(){a.actionsCtrl.selected=a.actionsCtrl.NONE};a.actionsCtrl.isSelected=function(b){return a.actionsCtrl.selected===b};if(g=l.get("action"))l.clear("action",!0),a.actionsCtrl.select(g);a.actionsCtrl.updateBooking=
function(b){b=b||_.ignore;a.booking=e.booking(a.booking.uri);a.booking.$promise.then(b)};var t=function(a,b,c){var d=r(b,"isSelected");a[d]=c.isSelected;d=r(b,"isFullRefund");a[d]=c.isFullRefund;c=r(b,"refundGross");a[c]=b.receipt.gross};a.actionsCtrl.initializeRefundablePayments=function(b,c,d,e){_.forEach(c,function(c){t(b,c,e);a.$watch(function(){var a=r(c,"isFullRefund");return b[a]},function(a){var e=r(c,"refundGross");b[e]=a?c.receipt.gross:0<d.amountOverpaid&&d.amountOverpaid<=c.receipt.gross?
d.amountOverpaid:""})})};a.actionsCtrl.initializeRefundablePaymentsAfterFailure=function(a,b,c,d){_.forEach(b,function(b){d[b.pk]||t(a,b,{isSelected:!1,isFullRefund:!0})})};var v=function(a){if(_.startsWith(a,"payment-")&&(a=a.split("-"),3===a.length))return parseInt(a[1],10)};a.actionsCtrl.getRefundErrors=function(a){var b={},c=[];a=a.data.refundPaymentsForm;if(!a)return{};_.forEach(a,function(a,d){if(a.length){var e=v(d);e&&(b[e]||(b[e]=[]),_.forEach(a,function(a){b[e].push(a);c.push(a)}))}});a.all&&
_.forEach(a.all,function(a){_.contains(c,a)||(b.all||(b.all=[]),b.all.push(a))});return b};a.actionsCtrl.isPaymentSelected=function(a,b){var c=a[r(b,"isSelected")],d=a[r(b,"refundGross")],e=a[r(b,"isFullRefund")];return c&&(d||e)};a.actionsCtrl.unselectPayment=function(a,b){a[r(b,"isSelected")]=!1;a[r(b,"isFullRefund")]=!1};a.actionsCtrl.unselectPayments=function(b,c){_.forEach(c,function(c){a.actionsCtrl.unselectPayment(b,c)})};a.actionsCtrl.selectPartialRefund=function(a,b){a[r(b,"isSelected")]=
!0;a[r(b,"isFullRefund")]=!1};a.actionsCtrl.isPartialRefundSelected=function(a,b){var c=a[r(b,"isSelected")],d=a[r(b,"isFullRefund")];return c&&!d};a.actionsCtrl.selectFullRefund=function(a,b){a[r(b,"isSelected")]=!0;a[r(b,"isFullRefund")]=!0};a.actionsCtrl.selectFullRefunds=function(b,c){_.forEach(c,function(c){a.actionsCtrl.selectFullRefund(b,c)})};a.actionsCtrl.isFullRefundSelected=function(a,b){var c=a[r(b,"isSelected")],d=a[r(b,"isFullRefund")];return c&&d};a.actionsCtrl.refundTotal=function(b,
c){return _.sum(c,function(c){return a.actionsCtrl.isPaymentSelected(b,c)?b[r(c,"isFullRefund")]?c.receipt.total:b[r(c,"refundGross")]:0})};a.actionsCtrl.previewRefundedPayments=function(b,c){var d=[];_.forEach(c,function(c){if(!c.isCollectedByAffiliate&&!c.isDeferred&&a.actionsCtrl.isPaymentSelected(b,c)){var e;e=b[r(c,"isFullRefund")]?c.receipt.total:b[r(c,"refundGross")];d.push(""+c.pk+":"+e)}});return d.join(",")};a.$watch("actionsCtrl.selected",function(b){b===a.actionsCtrl.REBOOK?m.rebook(a.booking):
b===a.actionsCtrl.MODIFY&&m.rebook(a.booking,a.booking.availability.$url(s.company.item.book))});var y=a.booking.company.features.isCancellationPoliciesEnabled&&(!b.permissions.can("rebook",a.booking)||!b.permissions.can("cancel",a.booking));l=[];if(y){var q=e.booking.effectiveCancellationRule({bookingUuid:a.booking.uuid,shortname:a.booking.company.shortname});l.push(q.$promise);q.$promise.then(function(b){a.maximumCancellationCutoffAt=b.data&&b.data.maximumCancellationCutoffAt})}f.dataController(a,
{promises:l,successCallback:function(){y&&(a.booking.effectiveCancellationRule=q)}});return a}]);h.controller("dashboard.bookings.AdvancedBookingActionsCtrl",["$scope","db",function(a,b){_.isUndefined(a.booking.availability.requirementGroup)&&(a.availability=b.availability({shortname:a.booking.availability.item.company.shortname,itemPk:a.booking.availability.item.pk,availabilityPk:a.booking.availability.pk}))}]);h.controller("dashboard.bookings.CancelBookingCtrl",["$scope","$filter","auth","controllers",
"db","events","flash","models","moment","navigation","require","urls",function(a,b,f,e,g,d,l,m,k,h,s,p){s.inScope(a,"booking","dashboard.bookings.CancelBookingCtrl");a.submitting=!1;a.editablePayments={};a.isCancelEligible=f.permissions.can("cancelEligible",a.booking)&&!f.permissions.can("cancel",a.booking);a.cancelBookingData={sendNotification:a.booking.contact.email?a.booking.company.companyFeatures.isSendCancelledEmailDefault:!1,"notification-language":a.booking.contact.language,"notification-emails":a.booking.contact.email,
"notification-type":m.Notification.BOOKING_CANCELLATION_TYPE,isCancelEligible:a.isCancelEligible};e.emailSubjectsController(a,{target:a.booking,modelKey:"cancelBookingData",prefix:"notification-"});e.emailPreviewController(a,{modelKey:"cancelBookingData",fields:{note:"notification-note",type:"notification-type",subject:"notification-subject",emails:"notification-emails",language:"notification-language"},url:p.email.bookingNotification,params:function(b){return{type:b,bookingUuid:a.booking.uuid,shortname:a.booking.company.shortname}},
data:function(){return{refundedPayments:a.actionsCtrl.previewRefundedPayments(a.editablePayments,a.payments)}}});e.cannedMessagesController(a,{modelKey:"cancelBookingData",noteField:"notification-note",languageKey:"notification-language",types:m.CannedMessage.BOOKING_TYPES,company:m.Booking.affiliateCompany(a.booking)});a.payments=g.payments({shortname:a.booking.company.shortname,bookingUuid:a.booking.uuid});a.nonZeroGeneratedStoredValueCards=_.filter(a.booking.generatedStoredValueCards,function(a){return 0<
a.balance});var r=function(){return _.filter(a.payments,function(b){return!b.isRefundable?!1:a.booking.isAffiliate&&a.booking.affiliation.affiliateCompany===f.currentUser.company?b.isCollectedByAffiliate:!0})},t=function(){var b=a.booking.effectiveCancellationRule;if(b.affiliateRefundPercentage===b.charterRefundPercentage)return[{payments:a.cancelEligiblePayments,refundPercentage:b.charterRefundPercentage}];var c=_.partition(a.cancelEligiblePayments,"isCollectedByAffiliate");return[{payments:c[1],
refundPercentage:b.charterRefundPercentage},{payments:c[0],refundPercentage:b.affiliateRefundPercentage}]};a.isCancelEligible&&(s.defined(a.booking,"effectiveCancellationRule","CancelBookingCtrl: no effectiveCancellationRule"),a.payments.$promise.then(function(){a.cancelEligiblePayments=r();a.groupedCancelEligiblePayments=t()}));var v=function(b){g.booking.cancel({bookingUuid:a.booking.uuid,shortname:a.booking.company.shortname},a.cancelBookingData,b).$promise.then(function(){a.actionsCtrl.reset();
d.broadcast("lib.shared.CalendarCtrl.refresh");l.success(T("Cancelled booking"));a.submitting=!1;d.broadcast("dashboard.bookings.ContactCtrl.refresh")},function(b){d.broadcast("dashboard.shared.ActivitiesCtrl.refresh");a.actionsCtrl.updateBooking(function(){a.payments=_.filter(a.payments,"isRefundable");a.isCancelEligible&&(a.refundErrors=b.data.refundErrors,a.cancelEligiblePayments=r(),a.groupedCancelEligiblePayments=t())});a.submitting=!1})};a.submit=function(b){a.submitting=!0;a.isCancelEligible||
!a.actionsCtrl.refundTotal(a.editablePayments,a.payments)?v(b):g.payments.refund({shortname:a.booking.company.shortname,bookingUuid:a.booking.uuid},a.editablePayments).$promise.then(function(c){a.refundErrors=a.actionsCtrl.getRefundErrors(c);_.isEmpty(a.refundErrors)?v(b):(d.broadcast("dashboard.shared.ActivitiesCtrl.refresh"),a.actionsCtrl.updateBooking(function(){a.payments=_.filter(a.payments,"isRefundable");a.actionsCtrl.initializeRefundablePaymentsAfterFailure(a.editablePayments,a.payments,a.booking,
a.refundErrors)}),a.submitting=!1)},function(b){a.refundErrors=a.actionsCtrl.getRefundErrors(b);a.submitting=!1})};b=_.append([a.payments.$promise],a.cannedMessagesCtrl.promises);e.dataController(a,{promises:b,successCallback:function(){a.payments=_.filter(a.payments,"isRefundable");a.actionsCtrl.initializeRefundablePayments(a.editablePayments,a.payments,a.booking,{isSelected:!1,isFullRefund:!0})}})}]);h.controller("dashboard.bookings.CancelOrderCtrl",["$scope","$filter","auth","controllers","db",
"events","flash","models","moment","navigation","require","urls",function(a,b,f,e,g,d,l,h,k,n,s,p){s.inScope(a,"order","dashboard.bookings.CancelOrderCtrl");a.submitting=!1;a.editablePayments={};b=a.order.company;a.isCompanyCancelEligible=f.permissions.can("cancelEligible",b)&&!f.permissions.can("cancel",b);a.cancelOrderData={sendNotification:a.order.contact.email?a.order.company.companyFeatures.isSendCancelledEmailDefault:!1,"notification-language":a.order.contact.language,"notification-emails":a.order.contact.email,
"notification-type":h.Notification.ORDER_CANCELLATION_TYPE,isCancelEligible:a.isCompanyCancelEligible};e.emailSubjectsController(a,{target:a.order,prefix:"notification-",modelKey:"cancelOrderData"});var r=function(){var b=_.filter(v,function(b){return a.initializeBookingsSelected[b.pk]});return _.pluck(b,"pk").join(",")};e.emailPreviewController(a,{modelKey:"cancelOrderData",fields:{note:"notification-note",type:"notification-type",subject:"notification-subject",emails:"notification-emails",language:"notification-language"},
url:p.email.orderNotification,params:function(b){return{type:b,orderUuid:a.order.uuid,shortname:a.order.company.shortname}},data:function(){return{refundedPayments:a.actionsCtrl.previewRefundedPayments(a.editablePayments,a.orderPayments),cancelledBookings:r()}}});e.cannedMessagesController(a,{modelKey:"cancelOrderData",noteField:"notification-note",languageKey:"notification-language",types:h.CannedMessage.ORDER_TYPES});a.orderPayments=g.orderPayments({shortname:a.order.company.shortname,orderUuid:a.order.uuid});
a.nonZeroGeneratedStoredValueCards=function(a){return _.filter(a.generatedStoredValueCards,function(a){return 0<a.balance})};var t=function(a,b){return _.some(b,function(b){return!b.isRefundable||a!==b.booking?!1:a.isAffiliate&&a.affiliation.affiliateCompany===f.currentUser.company?b.isCollectedByAffiliate:!0})};a.isCancelEligiblePaymentsInSelectedBookings=function(){var b=_.filter(v,function(b){return a.initializeBookingsSelected[b.pk]});_.forEach(b,function(b){if(t(b,a.orderPayments))return!0});
return!1};a.cancelEligiblePayments=_.filter(a.orderPayments,function(a){return!a.isRefundable?!1:!0});a.getCancelRefundErrors=function(a){var b={},c={};_.forEach(a.data.cancelOrderBookingsForm,function(a,d){var e;a:{e=d.split("-");if(_.startsWith(d,"cancel-booking-")){if(4===e.length){e=parseInt(e[2],10);break a}}else if(_.startsWith(d,"refund-payments-for-booking-")&&8===e.length){e=parseInt(e[4],10);break a}e=void 0}var f;a:{if(_.startsWith(d,"refund-payments-for-booking-")&&(f=d.split("-"),8===
f.length)){f=parseInt(f[6],10);break a}f=void 0}a.length&&(_.endsWith(d,"-all")&&e)&&(_.startsWith(d,"cancel-booking-")&&(c[e]=a),_.startsWith(d,"refund-payments-for-booking-")&&(b[e]||(b[e]={}),b[e][f]=a))});return{bookingRefundErrors:b,cancelErrors:c}};a.submit=function(b){a.submitting=!0;a.bookingRefundErrors={};a.cancelErrors={};a.editablePayments.bookings=_.filter(Object.keys(a.initializeBookingsSelected),function(b){return a.initializeBookingsSelected[b]});if(0===a.editablePayments.bookings.length)console.warn("No bookings selected to be cancelled."),
a.submitting=!1;else{_.extend(a.cancelOrderData,a.editablePayments);var c=function(b){b=a.getCancelRefundErrors(b);a.bookingRefundErrors=b.bookingRefundErrors;a.cancelErrors=b.cancelErrors;return!(!Object.keys(a.bookingRefundErrors).length||!Object.keys(a.cancelErrors).length)};g.order.cancel({shortname:a.order.company.shortname,orderUuid:a.order.uuid},a.cancelOrderData,b).$promise.then(function(b){c(b)||(a.actionsCtrl.reset(),d.broadcast("dashboard.shared.ActivitiesCtrl.refresh"),d.broadcast("lib.shared.CalendarCtrl.refresh"),
a.submitting=!1,l.success(T("Cancelled bookings")));a.submitting=!1;d.broadcast("dashboard.bookings.ContactCtrl.refresh")},function(b){c(b);a.submitting=!1;d.broadcast("dashboard.bookings.ContactCtrl.refresh")})}};a.getPaymentsFromBooking=function(b,c){c=c||a.orderPayments;return _.filter(c,function(a){return a.booking.uri===b.uri&&a.isRefundable})};a.nonCancelledContributingBookings=_.filter(a.order.contributingBookings,function(a){return!a.isCancelled});a.canCancelBooking=function(a){return f.permissions.can("cancelEligible",
a)||f.permissions.can("cancel",a)};var v=_.filter(a.nonCancelledContributingBookings,a.canCancelBooking);a.selectAllBookings=function(){_.each(v,function(b){a.initializeBookingsSelected[b.pk]=!0})};a.unselectBooking=function(b){a.initializeBookingsSelected[b.pk]=!1;b=a.getPaymentsFromBooking(b,a.orderPayments);_.each(b,function(b){a.actionsCtrl.setDefaults(a.editablePayments,b,{isSelected:!1,isFullRefund:!0})})};a.unselectAllBookings=function(){_.each(a.nonCancelledContributingBookings,function(b){a.initializeBookingsSelected[b.pk]=
!1;a.unselectBooking(b)})};a.$watchCollection("initializeBookingsSelected",function(){_.each(v,function(b){a.initializeBookingsSelected[b.pk]||a.unselectBooking(b)})});a.isAnyEligibleBookingSelected=function(){return _.some(v,function(b){return a.initializeBookingsSelected[b.pk]})};a.initializeBookingsSelected={};a.unselectAllBookings();h=_.append([a.orderPayments.$promise],a.cannedMessagesCtrl.promises);e.dataController(a,{promises:h,successCallback:function(){_.each(a.nonCancelledContributingBookings,
function(b){a.actionsCtrl.initializeRefundablePayments(a.editablePayments,a.getPaymentsFromBooking(b,a.orderPayments),b,{isSelected:!1,isFullRefund:!0})})}})}]);h.controller("dashboard.bookings.CustomRefundCtrl",["$scope","controllers","db","events","require",function(a,b,f,e,g){g.inScope(a,"booking","dashboard.bookings.CustomRefundCtrl");g.inScope(a,"actionsCtrl","dashboard.bookings.CustomRefundCtrl");g.inScope(a,"inStorePaymentTypes","dashboard.bookings.CustomRefundCtrl");var d=a.inStorePaymentTypes.length?
_.first(a.inStorePaymentTypes).pk:"";b.dataController(a,{promises:[a.inStorePaymentTypes.$promise],successCallback:function(){b.createController(a,{modelKey:"newRefund",create:f.refunds.custom.create,successCallback:function(){a.actionsCtrl.updateBooking(function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");e.broadcast("dashboard.bookings.RefundsCtrl.refunded")});a.actionsCtrl.reset()},params:function(){return{shortname:a.booking.company.shortname,bookingUuid:a.booking.uuid}},defaultModel:{inStorePaymentType:d,
gross:a.booking.amountOverpaid||""}})}})}]);h.controller("dashboard.bookings.RepriceBookingCtrl",["$scope","controllers","db","events","models","require",function(a,b,f,e,g,d){d.inScope(a,"booking","dashboard.bookings.RepriceBookingCtrl");d.inScope(a,"actionsCtrl","dashboard.bookings.RepriceBookingCtrl");var l=f.totalSheets({shortname:a.booking.company.shortname}),h=a.invoiceSheets=[];a.booking.affiliation&&(h=f.invoiceSheets({shortname:a.booking.company.shortname}));b.dataController(a,{promises:[l.$promise,
h.$promise],stale:[l,h],successCallback:function(){a.totalSheets=g.TotalSheet.nonBaseSheets(l);a.invoiceSheets=g.InvoiceSheet.nonBaseSheets(h);b.editController(a,{elementKey:"booking",modelKey:"editableBooking",update:f.booking.reprice,editCallback:function(){a.editableBooking.totalSheet=a.booking.totalSheet?a.booking.totalSheet.pk:"";a.editableBooking.invoiceSheet=a.booking.invoiceSheet?a.booking.invoiceSheet.pk:"";if(!a.editableBooking.totalSheet&&!a.editableBooking.invoiceSheet){var b;b=a.booking.isOnline?
_.find(a.totalSheets,_.property("isOnline")):_.first(a.totalSheets);var c;a.booking.affiliation&&(c=a.booking.affiliation.defaultInvoiceSheet);a.editableBooking.totalSheet=b?b.pk:"";a.editableBooking.invoiceSheet=c?c.pk:""}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");a.actionsCtrl.reset()},params:function(){return{shortname:a.booking.company.shortname,bookingUuid:a.booking.uuid}},editing:!0})}})}]);h.controller("dashboard.bookings.ReapplyBookingResourceUsesCtrl",
["$q","$rootScope","$scope","auth","controllers","db","events","models","require","resourceUseData",function(a,b,f,e,g,d,l,h,k,n){k.inScope(f,"booking","dashboard.bookings.ReapplyBookingResourceUsesCtrl");f.customerTypeRates=_.uniq(_.map(f.booking.customers,"customerTypeRate"));var s=function(a){return _.append(a.bookingLevelResourceUses,_.flatten(_.map(a.customers,"resourceUses")))};f.resourceUses=s(f.booking);l.on(f,"dashboard.resources.ResourceUseEditableCtrl.resourceUse.updated",function(){f.resourceUses=
s(f.booking)});f.resourceUseData=n();a=f.resourceUseData.fetchApplicableRequirements(f.booking.availability,f.customerTypeRates).then(function(a){return f.requirements=a});var p=function(a){return _.reduce(a,function(a,b){a[b.customerTypeRate.pk]=a[b.customerTypeRate.pk]||0;a[b.customerTypeRate.pk]+=1;return a},{})},r=function(a){return function(b){b.booking=a;return b}},t=function(){return f.resourceUseData.fetchReappliedBooking(f.booking,p(f.booking.customers),f.booking.totalSheet.pk).then(function(a){f.toResourceUses=
_.map(a.resourceUses,r(f.booking));f.unsatisfiableResources=a.unsatisfiableResources;f.reapplyBookingResourceUsesModel={selectedResourceRequirements:f.resourceUseData.selectedResourceRequirementPks()}})};b=t();g.dataController(f,{promises:[a,b]});f.reapplyBookingResourceUsesModel={selectedResourceRequirementPks:f.resourceUseData.selectedResourceRequirementPks()};f.reset=function(){f.resourceUseData.clearSelections();t()};f.isResourceUsesChanged=function(){return!_.isEmpty(_.xorBy(f.resourceUses,f.toResourceUses,
function(a,b){return h.ResourceUse.equals(a,b)}))};f.useCount=function(a){return _.sum(a,"useCount")};f.$watch("resourceUseData.selectedSplittableRequirementsResources",function(a,b){a!==b&&t()},!0);f.$watch("resourceUseData.selectedNonSplittableRequirementsResources",function(a,b){a!==b&&t()},!0);g.editController(f,{modelKey:"reapplyBookingResourceUsesModel",params:{shortname:f.booking.availability.item.company.shortname,bookingUuid:f.booking.uuid},refreshActivities:!0,successCallback:function(a,
b){f.resourceUseData.clearSelections();f.actionsCtrl.reset();l.broadcast("dashboard.shared.ActivitiesCtrl.refresh");l.broadcast("lib.shared.CalendarCtrl.refresh");l.broadcast("manifest.IndexCtrl.reconstruct");l.broadcast("dashboard.resources.ResourceUseEditableCtrl.resourceUse.updated")},update:d.resourceUses.reapplyBookingResourceUses})}]);h.controller("dashboard.bookings.ProcessBookingCtrl",["$scope","db","require",function(a,b,f){f.inScope(a,"booking","dashboard.bookings.RepriceBookingCtrl");f.inScope(a,
"actionsCtrl","dashboard.bookings.RepriceBookingCtrl");a.status="loading";b.booking.touch({shortname:a.booking.company.shortname,bookingUuid:a.booking.uuid}).$promise.then(function(){a.status=a.booking.isUnprocessed?"error":"success"},function(){a.status="error"})}]);h.controller("dashboard.bookings.BookingCheckinStatusEditableCtrl",["$scope","checkin","controllers","db","events","require",function(a,b,f,e,g,d){d.inScope(a,"booking","dashboard.bookings.BookingCheckinStatusEditableCtrl");d.inScope(a,
"checkinStatuses","dashboard.bookings.BookingCheckinStatusEditableCtrl");d.inScope(a,"actionsCtrl","dashboard.bookings.BookingCheckinStatusEditableCtrl");f.dataController(a,{promises:[a.checkinStatuses.$promise],successCallback:function(){b.bookingCheckinStatusController(a,{booking:a.booking,checkinStatuses:a.checkinStatuses,submitCallback:function(){a.actionsCtrl.reset()}})}})}]);h.controller("dashboard.bookings.OrderRefundsCtrl",["$scope","auth","controllers","db","events","models","moment","processors",
"require","urls",function(a,b,f,e,g,d,l,h,k,n){k.inScope(a,"order");a.submitting=!1;a.editablePayments={"notification-emails":a.order.contact.email,"notification-type":d.Notification.ORDER_REFUNDED_TYPE,"notification-language":a.order.contact.language};f.emailSubjectsController(a,{target:a.order,modelKey:"editablePayments",prefix:"notification-"});f.emailPreviewController(a,{modelKey:"editablePayments",fields:{note:"notification-note",type:"notification-type",subject:"notification-subject",emails:"notification-emails",
language:"notification-language"},url:n.email.orderNotification,params:function(b){return{type:b,orderUuid:a.order.uuid,shortname:a.order.company.shortname}},isPreviewable:function(){if(a.actionsCtrl.refundTotal(a.editablePayments,a.orderPayments))return!0},data:function(){return{refundedPayments:a.actionsCtrl.previewRefundedPayments(a.editablePayments,a.orderPayments)}}});f.cannedMessagesController(a,{modelKey:"editablePayments",noteField:"notification-note",languageKey:"notification-language",types:d.CannedMessage.ORDER_TYPES});
a.refundErrors={};b=b.permissions.canList(d.Account,a.order.company);a.accounts={};b&&(a.accounts=e.company.accounts({shortname:a.order.company.shortname}));a.orderPayments=[];var s=e.orderPayments({shortname:a.order.company.shortname,orderUuid:a.order.uuid}),p=function(b,c){return a.editablePayments["payment-"+b.pk+"-"+c]},r=function(b){return _.roundHalfToEven(b*(1-a.order.company.processingFeeRate)-a.order.company.processingFlatFee)};a.isUploadPossible=function(){if(a.order.isDemo||!a.order.company.isLinkedRefundsEnabled||
!a.order.company.isDefaultProcessorDefaultBankAccountReadyForUpload)return!1;var b=!1;_.forEach(h.PROCESSOR_TYPES,function(c){var d=0,e=a.accounts[a.order.company.processorCurrency][c];e&&(e.deposit&&e.escrow)&&(e=e.deposit.balance+e.escrow.balance,_.forEach(a.orderPayments,function(a){a.processorType===c&&p(a,"isSelected")&&(d=p(a,"isFullRefund")?d+r(a.receipt.gross):d+r(p(a,"refundGross")))}),d>e&&(b=!0))});return b};var t=function(a){if(_.startsWith(a,"payment-")&&(a=a.split("-"),3===a.length))return parseInt(a[1],
10)};a.getOrderRefundErrors=function(a){var b={},c=[];a=a.data.refundPaymentsForm;if(!a)return{};_.forEach(a,function(a,d){if(a.length){var e=t(d);e&&(b[e]||(b[e]=[]),_.forEach(a,function(a){b[e].push(a);c.push(a)}))}});a.all&&_.forEach(a.all,function(a){_.contains(c,a)||(b.all||(b.all=[]),b.all.push(a))});return b};a.refundingCount=function(){var b=0;_.forEach(a.orderPayments,function(a){p(a,"isSelected")&&(b+=1)});return b};var v=function(a){return a.isRefundable};a.submit=function(b){a.submitting=
!0;var c=e.orderPayments.refund({shortname:a.order.company.shortname,orderUuid:a.order.uuid},a.editablePayments,b);c.$promise.then(function(b){a.refundErrors=a.getOrderRefundErrors(b);g.broadcast("dashboard.shared.ActivitiesCtrl.refresh");a.actionsCtrl.updateOrder(function(){_.isEmpty(a.refundErrors)?a.actionsCtrl.reset():(_.overwrite(a.orderPayments,_.filter(c,v)),a.actionsCtrl.initializeRefundablePaymentsAfterFailure(a.editablePayments,a.orderPayments,a.refundErrors),a.submitting=!1);g.broadcast("dashboard.bookings.OrderRefundsCtrl.refunded")})},
function(b){a.refundErrors=a.getOrderRefundErrors(b);a.submitting=!1})};d=[s.$promise];b&&d.push(a.accounts.$promise);d=_.append(d,a.cannedMessagesCtrl.promises);f.dataController(a,{promises:d,successCallback:function(){_.overwrite(a.orderPayments,_.filter(s,v));a.bookingsWithRefundablePayments=_.filter(a.order.contributingBookings,function(a){return _.some(a.payments,v)});a.order.contributingBookings.forEach(function(b){var c=_.filter(a.orderPayments,function(a){return a.booking===b});a.actionsCtrl.initializeRefundablePayments(a.editablePayments,
c,b,{isSelected:!1,isFullRefund:!0})})}});return a}]);h.controller("dashboard.bookings.RefundsCtrl",["$scope","auth","controllers","db","events","models","moment","processors","require","urls",function(a,b,f,e,g,d,l,h,k,n){k.inScope(a,"booking");a.submitting=!1;a.editablePayments={"notification-emails":a.booking.contact.email,"notification-type":d.Notification.BOOKING_REFUNDED_TYPE,"notification-language":a.booking.contact.language};f.emailSubjectsController(a,{target:a.booking,modelKey:"editablePayments",
prefix:"notification-"});f.emailPreviewController(a,{modelKey:"editablePayments",fields:{note:"notification-note",type:"notification-type",subject:"notification-subject",emails:"notification-emails",language:"notification-language"},url:n.email.bookingNotification,params:function(b){return{type:b,bookingUuid:a.booking.uuid,shortname:a.booking.company.shortname}},isPreviewable:function(){if(a.actionsCtrl.refundTotal(a.editablePayments,a.payments))return!0},data:function(){return{refundedPayments:a.actionsCtrl.previewRefundedPayments(a.editablePayments,
a.payments)}}});f.cannedMessagesController(a,{modelKey:"editablePayments",noteField:"notification-note",languageKey:"notification-language",types:d.CannedMessage.BOOKING_TYPES,company:d.Booking.affiliateCompany(a.booking)});a.refundErrors={};b=b.permissions.canList(d.Account,a.booking.company);a.accounts={};b&&(a.accounts=e.company.accounts({shortname:a.booking.company.shortname}));a.payments=e.payments({shortname:a.booking.company.shortname,bookingUuid:a.booking.uuid});var s=function(b,c){return a.editablePayments["payment-"+
b.pk+"-"+c]},p=function(b){return _.roundHalfToEven(b*(1-a.booking.company.processingFeeRate)-a.booking.company.processingFlatFee)};a.isUploadPossible=function(){if(a.booking.isDemo||!a.booking.company.isLinkedRefundsEnabled||!a.booking.company.isDefaultProcessorDefaultBankAccountReadyForUpload)return!1;var b=!1;_.forEach(h.PROCESSOR_TYPES,function(c){var d=0,e=a.accounts[a.booking.company.processorCurrency][c];e&&(e.deposit&&e.escrow)&&(e=e.deposit.balance+e.escrow.balance,_.forEach(a.payments,function(a){a.processorType===
c&&s(a,"isSelected")&&(d=s(a,"isFullRefund")?d+p(a.receipt.gross):d+p(s(a,"refundGross")))}),d>e&&(b=!0))});return b};a.refundingCount=function(){var b=0;_.forEach(a.payments,function(a){s(a,"isSelected")&&(b+=1)});return b};a.submit=function(b){a.submitting=!0;e.payments.refund({shortname:a.booking.company.shortname,bookingUuid:a.booking.uuid},a.editablePayments,b).$promise.then(function(b){a.refundErrors=a.actionsCtrl.getRefundErrors(b);g.broadcast("dashboard.shared.ActivitiesCtrl.refresh");a.actionsCtrl.updateBooking(function(){_.isEmpty(a.refundErrors)?
a.actionsCtrl.reset():(a.payments=_.filter(a.payments,function(a){return a.isRefundable}),a.actionsCtrl.initializeRefundablePaymentsAfterFailure(a.editablePayments,a.payments,a.booking,a.refundErrors),a.submitting=!1);g.broadcast("dashboard.bookings.RefundsCtrl.refunded")})},function(b){a.refundErrors=a.actionsCtrl.getRefundErrors(b);a.submitting=!1})};d=[a.payments.$promise];b&&d.push(a.accounts.$promise);d=_.append(d,a.cannedMessagesCtrl.promises);f.dataController(a,{promises:d,successCallback:function(){a.payments=
_.filter(a.payments,function(a){return a.isRefundable});a.actionsCtrl.initializeRefundablePayments(a.editablePayments,a.payments,a.booking,{isSelected:!1,isFullRefund:!0})}});return a}]);h.controller("dashboard.bookings.PaymentsCtrl",["$scope","$timeout","auth","controllers","db","events","models","navigation","paymentController","redeemController","require","urls",function(a,b,f,e,g,d,l,h,k,n,s,p){s.inScope(a,"booking");s.inScope(a,"inStorePaymentTypes");a.submitting=!1;a.newPayment={};a.isRedeeming=
!1;a.redeem=function(b){a.isRedeeming=b};e.emailPreviewController(a,{modelKey:"newPayment",fields:{note:"notification-note",type:"notification-type",subject:"notification-subject",emails:"notification-emails",language:"notification-language"},url:p.email.bookingNotification,params:function(b){return{type:b,bookingUuid:a.booking.uuid,shortname:a.booking.company.shortname}}});e.cannedMessagesController(a,{modelKey:"newPayment",noteField:"notification-note",languageKey:"notification-language",types:l.CannedMessage.BOOKING_TYPES,
company:l.Booking.affiliateCompany(a.booking)});var r=_.ignore,t=function(b){var c=a.paymentCtrl.needsReceipt();a.booking=g.booking(a.booking.uri);a.booking.$promise.then(function(){d.broadcast("dashboard.bookings.PaymentsCtrl.created");c&&(h.set("payment","newest",!1),a.actionsCtrl.select(a.actionsCtrl.PRINT_RECEIPT))});d.broadcast("dashboard.shared.ActivitiesCtrl.refresh");c||a.actionsCtrl.reset();r()},v=function(b){a.paymentCtrl.restoreCard();a.submitting=!1;r()};a.submitRedeem=function(b){a.submitting=
!0;a.listCtrl.submit(b)};a.submit=function(b){a.submitting=!0;a.paymentCtrl.saveCard();a.$asyncApply(function(c){r=c;a.paymentCtrl.createToken(b,function(){a.listCtrl.submit(b)},function(){v()})})};a.payments=g.payments({shortname:a.booking.company.shortname,bookingUuid:a.booking.uuid});var y=g.contactPayments({shortname:a.booking.company.shortname,contactPk:a.booking.contact.pk});e.emailSubjectsController(a,{target:a.booking,modelKey:"newPayment",prefix:"notification-"});e.dataController(a,{promises:[a.payments.$promise,
y.$promise],successCallback:function(){var b=a.booking.affiliation&&f.currentUser.company===a.booking.affiliation.affiliateCompany;k(a,{modelKey:"newPayment",company:a.booking.company,isTakeRequired:!0,isPreferAffiliateTakeIgnored:!!a.booking.receiptCollectedByAffiliate.gross,booking:a.booking,bookingGrosses:function(){var b={};b[a.booking.pk]=a.newPayment.gross;return b},swipe:!0,isCompany:!b,isAffiliate:b,isAnonymous:!1,affiliation:_.constant(a.booking.affiliation||null),gross:_.constant(a.booking.amountDue),
bookingFee:_.constant(0),invoicePrice:_.constant(a.booking.invoiceableToAffiliate||0),invoiceRelationship:_.constant(a.booking.invoiceSheet?a.booking.invoiceSheet.relationship:""),isCardRequired:a.booking.item.isCardRequired,cardPayments:y,inStorePaymentTypes:a.inStorePaymentTypes,isRebooking:!1});n(a,{company:a.booking.company,amountDue:_.constant(a.booking.amountDue)});e.splitPaymentController(a,{max:_.constant(a.booking.amountDue),amount:function(b){_.isUndefined(b)||(a.newPayment.gross=b);return a.booking.costs.totalCost.total},
customerCount:_.constant(a.booking.customerCount)});if(b=a.paymentCtrl.preselect())a.submitting=!0,b.then(function(){var b=a.paymentCtrl.form();b?a.submit(b):a.submitting=!1},function(){a.submitting=!1});e.emailSubjectsController(a,{target:a.booking,modelKey:"newPayment",prefix:"notification-"});e.listController(a,{collectionKey:"payments",modelKey:"newPayment",create:g.payments.create,successCallback:t,errorCallback:v,params:function(){return{shortname:a.booking.company.shortname,bookingUuid:a.booking.uuid}},
defaultModel:_.extend(a.paymentCtrl.chargeDefaults({gross:a.booking.amountDue,payBalanceDue:!0}),{"notification-emails":a.booking.contact.email,"notification-type":l.Notification.BOOKING_RECEIPT_TYPE,"notification-language":a.booking.contact.language}),submitCallback:function(){if(a.isRedeeming)return{kind:"redeem",option:"stored-value-card",gross:a.redeemCtrl.gross,isCollectedByAffiliate:!1}}})}});return a}]);h.controller("dashboard.bookings.OrderPaymentsCtrl",["$scope","$timeout","auth","controllers",
"db","events","models","navigation","paymentController","redeemController","require","urls",function(a,b,f,e,g,d,l,h,k,n,s,p){s.inScope(a,"order");a.submitting=!1;a.isRedeeming=!1;a.redeem=function(b){a.isRedeeming=b};var r=a.order.company.shortname;e.emailPreviewController(a,{modelKey:"newOrderPayments",fields:{note:"notification-note",type:"notification-type",subject:"notification-subject",emails:"notification-emails",language:"notification-language"},url:p.email.orderNotification,params:function(b){return{type:b,
orderUuid:a.order.uuid,shortname:r}}});e.cannedMessagesController(a,{modelKey:"newOrderPayments",noteField:"notification-note",languageKey:"notification-language",types:l.CannedMessage.ORDER_TYPES});e.emailSubjectsController(a,{target:a.order,modelKey:"newOrderPayments",prefix:"notification-"});var t=_.ignore,v=function(){var b=a.paymentCtrl.needsReceipt();a.order=g.order(a.order.uri);a.order.$promise.then(function(){d.broadcast("dashboard.bookings.OrderPaymentsCtrl.created");b&&(h.set("payment",
"newest",!1),a.actionsCtrl.select(a.actionsCtrl.PRINT_RECEIPT))});d.broadcast("dashboard.shared.ActivitiesCtrl.refresh");b||a.actionsCtrl.reset();t()},y=function(b,c){a.paymentCtrl.restoreCard();a.submitting=!1;t()};a.maxPaymentsForBooking=function(b){a.newOrderPayments["order-payment-for-booking-"+b.pk+"-gross"]=b.amountDue};a.submitRedeem=function(b){a.submitting=!0;a.listCtrl.submit(b)};a.submit=function(b){a.submitting=!0;a.paymentCtrl.saveCard();a.$asyncApply(function(c){t=c;a.paymentCtrl.createToken(b,
function(){a.listCtrl.submit(b)},function(){y(b)})})};a.orderPayments=g.orderPayments({shortname:r,orderUuid:a.order.uuid});a.inStorePaymentTypes=[];f.permissions.canList(l.InStorePaymentType,a.order.company)&&f.permissions.can("createInStore",l.Payment,a.order)&&(a.inStorePaymentTypes=g.inStorePaymentTypes({shortname:r},null,null,null,{tagAlong:!0}));var q=function(b){return a.newOrderPayments["order-payment-for-booking-"+b.pk+"-gross"]},B=g.contactPayments({shortname:a.order.company.shortname,contactPk:a.order.contact.pk});
e.dataController(a,{promises:[a.orderPayments.$promise,a.inStorePaymentTypes.$promise,B.$promise],successCallback:function(){var b=a.order.contributingBookings,c=_.sum(b,"amountDue");k(a,{modelKey:"newOrderPayments",fieldPrefix:"payment",swipe:!0,company:a.order.company,order:a.order,orderBookingGross:q,bookingGrosses:function(){var a={};_.forEach(b,function(b){a[b.pk]=q(b)});return a},gross:function(){return a.paymentCtrl.kind()===a.paymentCtrl.PARTIAL_KIND?_.sum(_.map(b,q)):c},bookingFee:_.constant(0),
invoicePrice:0,isAffiliate:!1,isAnonymous:!1,isCompany:!0,cardPayments:B,inStorePaymentTypes:a.inStorePaymentTypes,isTakeRequired:!0});a.$watch(_.ary(a.paymentCtrl.kind,0),function(c){c===a.paymentCtrl.FULL_KIND&&_.forEach(b,function(b){a.newOrderPayments["order-payment-for-booking-"+b.pk+"-gross"]=b.amountDue})});n(a,{company:a.order.company,amountDue:function(){return _.sum(b,"amountDue")}});var d=a.paymentCtrl.preselect();d&&(a.submitting=!0,d.then(function(){var b=a.paymentCtrl.form();b?a.submit(b):
a.submitting=!1},function(){a.submitting=!1}));e.listController(a,{modelKey:"newOrderPayments",collectionKey:"bookings",create:g.orderPayments.create,successCallback:v,errorCallback:y,params:function(){return{shortname:r,orderUuid:a.order.uuid}},defaultModel:_.extend(a.paymentCtrl.chargeDefaults(),{"notification-emails":a.order.contact.email,"notification-type":l.Notification.ORDER_RECEIPT_TYPE,"notification-language":a.order.contact.language}),submitCallback:function(){_.forEach(b,function(b){a.newOrderPayments["order-payment-for-booking-"+
b.pk+"-amountDue"]=b.amountDue});if(a.isRedeeming)return{is_redeeming:!0,"payment-kind":"redeem","payment-option":"stored-value-card","payment-gross":a.redeemCtrl.gross,"payment-storedValueCardNumber":a.newOrderPayments.storedValueCardNumber||""}}})}});return a}]);h.controller("dashboard.bookings.DeferredPaymentCtrl",["$scope","auth","controllers","db","events","models","navigation","paymentController","require",function(a,b,f,e,g,d,l,h,k){k.inScope(a,"booking");a.submitting=!1;b=a.booking.affiliation&&
b.currentUser.company===a.booking.affiliation.affiliateCompany;d={gross:0,bookingFee:0};var n=_.ignore;f.createController(a,{modelKey:"newPayment",create:e.payments.create,successCallback:function(){a.booking=e.booking(a.booking.uri);a.booking.$promise.then(function(){g.broadcast("dashboard.bookings.DeferredPaymentCtrl.created")});g.broadcast("dashboard.shared.ActivitiesCtrl.refresh");a.actionsCtrl.reset();n()},errorCallback:function(){a.paymentCtrl.restoreCard();a.submitting=!1;n()},params:function(){return{shortname:a.booking.company.shortname,
bookingUuid:a.booking.uuid}},defaultModel:d});h(a,{modelKey:"newPayment",company:a.booking.company,isInfoRequired:!0,booking:a.booking,swipe:!0,isCompany:!b,isAffiliate:b,isAnonymous:!1,affiliation:function(){return a.booking.affiliation||null},gross:_.constant(0),bookingFee:_.constant(0),invoicePrice:_.constant(0),isRebooking:!1});_.extend(d,a.paymentCtrl.chargeDefaults());a.submit=function(b){a.submitting=!0;a.paymentCtrl.saveCard();a.$asyncApply(function(c){n=c;a.paymentCtrl.createToken(b,function(c){return a.createCtrl.submit(b)},
function(){a.submitting=!1})})};return a}]);h.controller("dashboard.bookings.NotificationCtrl",["$scope","auth","controllers","db","events","models","navigation","require","urls",function(a,b,f,e,g,d,l,h,k){h.inScope(a,"booking");a.submitting=!1;var n=d.Notification.notificationTypesForBooking(a.booking);d.Booking.hasEmailableDisputes(a.booking)&&b.permissions.can("createDisputeType",d.Notification,a.booking)&&n.push(d.Notification.DISPUTE_TYPE);a.notificationTypeOptions=_.map(n,function(a){var b=
d.Notification.displayType(a);a===d.Notification.DISPUTE_TYPE&&(b="["+T("FH Admin Only")+"] "+b);return{value:a,name:b}});a.data={emails:a.booking.contact.email,language:a.booking.contact.language,type:_.first(n)};f.emailSubjectsController(a,{target:a.booking,modelKey:"data"});f.emailPreviewController(a,{modelKey:"data",url:k.email.bookingNotification,params:function(b){return{type:b,bookingUuid:a.booking.uuid,shortname:a.booking.company.shortname}},isPreviewable:function(a){if(_.contains(n,a))return!0}});
f.cannedMessagesController(a,{modelKey:"data",noteField:"note",languageKey:"language",types:d.CannedMessage.BOOKING_TYPES,company:d.Booking.affiliateCompany(a.booking)});a.submit=function(b){a.submitting=!0;e.booking.notification({shortname:a.booking.company.shortname,bookingUuid:a.booking.uuid},a.data,b).$promise.then(function(){g.broadcast("dashboard.shared.ActivitiesCtrl.refresh");a.actionsCtrl.reset()},function(){a.submitting=!1})};return f.dataController(a,{promises:_.append(a.emailSubjectsCtrl.promises,
a.cannedMessagesCtrl.promises)})}]);h.controller("dashboard.bookings.OrderNotificationCtrl",["$scope","controllers","db","events","models","navigation","require","urls",function(a,b,f,e,g,d,l,h){l.inScope(a,"order","dashboard.bookings.OrderNotificationCtrl");a.submitting=!1;d=g.Notification.notificationTypesForOrder(a.order);a.notificationTypeOptions=_.map(d,function(a){return{value:a,name:g.Notification.displayType(a)}});d=_.contains(d,g.Notification.ORDER_CANCELLATION_TYPE)&&_.all(a.order.allBookings,
"isCancelled")?g.Notification.ORDER_CANCELLATION_TYPE:_.first(d);a.data={emails:a.order.contact.email,type:d,language:a.order.contact.language};b.emailSubjectsController(a,{target:a.order,modelKey:"data"});b.emailPreviewController(a,{modelKey:"data",url:h.email.orderNotification,params:function(b){return{type:b,orderUuid:a.order.uuid,shortname:a.order.company.shortname}},isPreviewable:_.always});b.cannedMessagesController(a,{modelKey:"data",noteField:"note",languageKey:"language",types:g.CannedMessage.ORDER_TYPES});
a.submit=function(b){a.submitting=!0;f.order.notification({shortname:a.order.company.shortname,orderUuid:a.order.uuid},a.data,b).$promise.then(function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");a.actionsCtrl.reset()},function(){a.submitting=!1})};return b.dataController(a,{promises:_.append(a.cannedMessagesCtrl.promises,a.emailSubjectsCtrl.promises),successCallback:function(){a.data.language=a.order.contact.language}})}]);h.controller("dashboard.bookings.NotificationsCtrl",["$scope",
"$q","controllers","db","events","flash","models","navigation","require","urls",function(a,b,f,e,g,d,l,h,k,n){k.inScope(a,"availability");a.isLoading=!0;a.data={type:l.Notification.BOOKING_CONFIRMATION_TYPE};var s=function(a){a=a.language;if(l.SupportedLanguage.isRecognizedLanguage(a))return a;var b=l.SupportedLanguage.rootLanguage(a);return l.SupportedLanguage.isRecognizedLanguage(b)?b:(a=_.chooseFirst(l.SupportedLanguage.LANGUAGE_CODES_SORTED,function(a){if(l.SupportedLanguage.rootLanguage(a)===
b)return a}))?a:h.currentCompany.language},p=function(){return a.company.companyFeatures.isContentTranslationEnabled?_.keys(_.groupBy(a.contacts,s)):[a.company.language]},r=function(){a.company.companyFeatures.isContentTranslationEnabled?(a.contactsByLanguage=_.groupBy(a.contacts,s),a.sortedContactLanguages=_.sortBy(_.keys(a.contactsByLanguage),l.SupportedLanguage.display)):(a.contactsByLanguage={},a.contactsByLanguage[a.company.language]=a.contacts,a.sortedContactLanguages=[a.company.language])};
_.isUndefined(a.bookings)&&(k=a.actionsCtrl.smsOptedOutBookings.length?{$promise:b.when(a.actionsCtrl.smsOptedOutBookings)}:e.bookings({shortname:h.currentCompany.shortname,itemPk:a.availability.item.pk,availabilityPk:a.availability.pk},null,null,null,{tagAlong:!0}),a.bookings=k);f.cannedMessagesController(a,{modelKey:"data",noteField:"note",onTranslationsLoad:function(b,c){_.forEach(a.languageMessageCtrls,function(e,f){var g=b(f);g||(g=c.message,l.SupportedLanguage.shareRootLanguage(f,a.availability.company.language)||
d.warn(interpolate("Selected canned message is missing translation for %(language)s, using original message instead.",{language:l.SupportedLanguage.display(f)})));e.cannedMessagesCtrl.addMessageToNote(g)})},addMessageToNote:function(b){_.forEach(a.languageMessageCtrls,function(a){a.cannedMessagesCtrl.addMessageToNote(b)})}});a.submit=function(b){b.$submitting=!0;a.data.addresses=_.pluck(a.contacts,"email");a.data.emailAddresses=a.data.addresses.join(",");e.availability.notifications({shortname:h.currentCompany.shortname,
itemPk:a.availability.item.pk,availabilityPk:a.availability.pk},a.data,b).$promise.then(function(){b.$submitting=!1;a.actionsCtrl.reset();g.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},function(){b.$submitting=!1})};a.$watchCollection("contacts",function(b){r();b=_.keys(a.languageMessageCtrls);var c=p();_.isEmpty(_.xor(c,b))||(a.languageMessageCtrls={},a.languagesForNotifications=[],_.forEach(c,function(b){var c=a.$new(),d="note-"+b,e="subject-"+b;f.cannedMessagesController(c,{modelKey:"data",
noteField:d,languageOverride:b,types:l.CannedMessage.BOOKING_TYPES,cannedMessagesByType:a.cannedMessagesCtrl.cannedMessagesByType});f.emailPreviewController(c,{modelKey:"data",languageOverride:b,fields:{emails:"$previewAddress",note:d,subject:e},url:n.email.bookingNotification,params:function(b){return{type:b,bookingUuid:a.bookings[0].uuid,shortname:a.bookings[0].company.shortname}},isPreviewable:function(){if(!a.bookings.length)return!1}});a.languagesForNotifications.push(b);a.languageMessageCtrls[b]=
{cannedMessagesCtrl:c.cannedMessagesCtrl,emailPreviewCtrl:c.emailPreviewCtrl}}))});a.clearAllNotes=function(){_.forEach(p(),function(b){a.data["note-"+b]=""})};a.removeContact=function(b){_.overwriteWithout(a.contacts,b)};k=a.bookings.$promise.then(function(){a.actionsCtrl.smsOptedOutBookings.length?(a.bookings=a.actionsCtrl.smsOptedOutBookings,a.actionsCtrl.populateSmsOptedOutBookings([])):_.remove(a.bookings,"isCancelled");a.contacts=_.unique(_.filter(_.pluck(a.bookings,"contact"),"email"));r();
if(!_.isEmpty(a.contacts)){a.data.$previewAddress=a.contacts[0].email;var d={};_.forEach(p(),function(a){d["subject-"+a]=a});f.emailSubjectsController(a,{modelKey:"data",subjectKeys:d,target:a.availability});return b.all(a.emailSubjectsCtrl.promises)}});return f.dataController(a,{promises:[k],successCallback:function(){a.bookings=_.filter(a.bookings,function(a){return!a.isCancelled});a.data.addresses=_.unique(_.filter(_.pluck(a.bookings,"contact.email")));a.data.addresses.length&&(a.data.$previewAddress=
a.data.addresses[0]);a.isLoading=!1}})}]);h.controller("dashboard.bookings.SmsNotificationsCtrl",["$scope","controllers","db","events","models","navigation","phoneNumbers","require","urls",function(a,b,f,e,g,d,l,h,k){h.inScope(a,"availability","dashboard.bookings.SmsNotificationsCtrl");h.inScope(a,"item","dashboard.bookings.SmsNotificationsCtrl");a.bookings=f.bookings({shortname:d.currentCompany.shortname,itemPk:a.availability.item.pk,availabilityPk:a.availability.pk});b.cannedMessagesController(a,
{modelKey:"smsNotifications",noteField:"message",cannedField:"smsMessage"});return b.dataController(a,{promises:[a.bookings.$promise],successCallback:function(){a.smsStatusEnabled=_.filter(a.bookings,function(a){return a.isSmsEnabled&&!_.isEmpty(a.contact.phone)&&!a.isCancelled});a.smsStatusDisabled=_.difference(a.bookings,a.smsStatusEnabled);a.emailOptedOutContacts=function(){a.actionsCtrl.populateSmsOptedOutBookings(a.smsStatusDisabled);a.actionsCtrl.select(a.actionsCtrl.NOTIFY)};a.selectedContactCount=
function(){return _.filter(a.smsStatusEnabled,function(b){return a.smsNotifications["booking"+b.pk+"IsSelected"]}).length};var d={message:""};_.forEach(a.smsStatusEnabled,function(a){d["booking"+a.pk+"IsSelected"]=!0});a.submitting=!1;b.createController(a,{modelKey:"smsNotifications",create:f.availability.smsNotifications.create,params:function(){a.submitting=!0;return{shortname:a.availability.company.shortname,itemPk:a.item.pk,availabilityPk:a.availability.pk}},successCallback:function(){a.submitting=
!1;e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");a.actionsCtrl.reset()},defaultModel:d})}})}]);h.controller("dashboard.bookings.SmsNotificationCtrl",["$scope","controllers","db","events","models","navigation","phoneNumbers","require","urls",function(a,b,f,e,g,d,l,h,k){h.inScope(a,"booking","dashboard.bookings.SmsNotificationCtrl");a.smsNotification={};a.submitting=!1;a.isInternationalSmsEnabled=a.booking.company.features.isInternationalSmsEnabled;a.numberRegex=a.isInternationalSmsEnabled?
g.SmsNotification.INTERNATIONAL_ENABLED_NUMBER_REGEX:g.SmsNotification.INTERNATIONAL_DISABLED_NUMBER_REGEX;a.numberMaxLength=a.isInternationalSmsEnabled?g.SmsNotification.INTERNATIONAL_ENABLED_NUMBER_MAX_LENGTH:g.SmsNotification.INTERNATIONAL_DISABLED_NUMBER_MAX_LENGTH;a.countries=a.isInternationalSmsEnabled?g.SmsNotification.INTERNATIONAL_ENABLED_COUNTRIES:g.SmsNotification.INTERNATIONAL_DISABLED_COUNTRIES;b.cannedMessagesController(a,{modelKey:"smsNotification",noteField:"message",cannedField:"smsMessage",
formattingFn:function(a){return a.substr(0,130)}});d=a.booking.contact;l=l.cleanPhoneNumber(d.phone);h=d.phoneCountry;a.isInternationalSmsEnabled||(a.smsNotification.phoneCountry=g.SmsNotification.US_COUNTRY_CODE);g.SmsNotification.isEligiblePhoneNumber(l,h,d.company)&&(h&&(a.smsNotification.phoneCountry=h),a.smsNotification.number=l);a.$watch(function(){return g.SmsNotification.isEligiblePhoneNumber(a.smsNotification.number,a.smsNotification.phoneCountry,a.booking.company)},function(b){a.isEligiblePhoneNumber=
b});a.submit=function(b){a.submitting=!0;f.booking.smsNotification({shortname:a.booking.company.shortname,bookingUuid:a.booking.uuid},a.smsNotification,b).$promise.then(function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");a.actionsCtrl.reset()},function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");a.submitting=!1})};return b.dataController(a)}]);h.controller("dashboard.bookings.ReceiptsCtrl",["$scope","auth","models","navigation","require","toggles",function(a,b,f,e,g,d){var l=
this;g.inScope(a,"company","dashboard.bookings.ReceiptsCtrl");g.inScope(a,"Receipt","dashboard.bookings.ReceiptsCtrl");g.inScope(a,"TicketLayout","dashboard.bookings.ReceiptsCtrl");g=e.get("payment");_.isUndefined(g)||e.clear("payment",!0);e=f.TicketLayout.BOCA_PRINT_FORMAT;l.isPreselecting="newest"===g;l.preferredPrintFormat=f.TicketLayout.RECEIPT_PRINT_FORMAT;a.company.isBocaEnabled&&(l.preferredPrintFormat=a.company.isReceiptsEnabled?b.storage.get("preferredPrintFormat")||e:f.TicketLayout.BOCA_PRINT_FORMAT);
l.savePreferredPrintFormat=function(a){b.storage.set("preferredPrintFormat",a)};l.preparePrinting=function(b){a.printType=l.preferredPrintFormat;a.showWholeParty=!!b.showWholeParty;a.showTickets=!!b.showTickets;a.activePayment=b.activePayment;b.toggle&&d.toggle(b.toggle)};a.visibleLineItems=_.reject(a.booking?a.booking.lineItems:[],"isPrivate")}])})();
(function(){var h=angular.module("dashboard.bookings.directives",[]);h.directive("ngTimeline",["$parse","$templateCache","dashboard.bookings.timeline",function(b,a,c){return{scope:!0,templateUrl:"dashboard.bookings.timeline",compile:function(b,c){var g=c.ngTimelineTemplate||"dashboard.bookings.timelineDefaultTemplate",d=a.get(g);d||(console.warn("ng-timeline: Unable to find template:",g),d=a.get("dashboard.bookings.timelineDefaultTemplate"));b.find(".js-timeline-node").html(d)},controllerAs:"timelineDirectiveCtrl",
controller:["$scope","$attrs",function(a,e){var g=this,d=b(e.ngTimeline),l=b(e.ngTimelineStartAt),h=b(e.ngTimelineEndAt),k=b(e.ngTimelineDate);g.slots=[];g.needsTip=_.isUndefined(e.ngTimelineHideTips);var n=function(a,b,d){var e=d.diff(b);a=_.map(a,function(a){var c={instance:a,startAt:a.startAt,endAt:a.endAt,isZeroLength:!1};a.startAt.isSame(a.endAt)&&(c.endAt=a.startAt.clone().add(2,"hours"),c.isZeroLength=!0);c.isStartClipped=c.startAt.isBefore(b);c.startAt=c.isStartClipped?b:a.startAt;c.isEndClipped=
c.endAt.isAfter(d);c.endAt=c.isEndClipped?d:c.endAt;c.temporalSize=100*c.endAt.diff(c.startAt)/e;c.temporalOffset=100*c.startAt.diff(b)/e;c.isFirst=c.isLast=!1;return c});var f=[];_.forEach(a,function(a){var b;_.forEach(f,function(d,e){if(!_.any(d,c.overlapsWith(a)))return b=e,_.insertSorted(d,a,"temporalOffset"),!1});_.isUndefined(b)&&f.push([a])});_.forEach(f,function(a){var b=a.length-1;_.forEach(a,function(c,d){if(0===d)!0===c.isFirst,c.temporalMargin=c.temporalOffset;else{var e=a[d-1];c.temporalMargin=
c.temporalOffset-e.temporalOffset-e.temporalSize}d===b&&(c.isLast=!0);c.css={marginLeft:c.temporalMargin.toFixed(6)+"%",width:c.temporalSize.toFixed(6)+"%"}})});return f},s=function(){var b=d(a),e=l(a),s=h(a);g.date=k(a);!e||!s?(console.warn("ng-timeline: not provided with ngTimelineStartAt or ngTimelineEndAt"),g.slots=[]):b?(b=_.filter(b,c.overlapsWith({startAt:e,endAt:s})),g.slots=b.length?n(b,e,s):[]):g.slots=[]};a.$watchGroup([l,h,k],s);a.$watchCollection(d,s)}]}}]);h.directive("ngTimelineHeading",
["$filter","$parse",function(b,a){var c=[];return{scope:!0,templateUrl:"dashboard.bookings.timelineHeading",controllerAs:"timelineHeadingCtrl",controller:["$scope","$attrs",function(f,e){var g=this,d=a(e.ngTimelineStartAt),l=a(e.ngTimelineEndAt),h=a(e.ngTimelineDate);f.$watchGroup([d,l,h],function(){g.minStartAt=d(f);g.maxEndAt=l(f);g.date=h(f)});var k=b("time"),n=function(a,b){return{displayName:k(a),startAt:a,endAt:a.clone().add(b,"hours")}},s,p,r,t,v;g.timeHeadings=function(a){if(!g.minStartAt||
!g.maxEndAt||!a)return c;var b=+g.minStartAt!==s||+g.maxEndAt!==p;b&&(s=+g.minStartAt,p=+g.maxEndAt);if(!b&&r===a)return v;r=a;var d=g.maxEndAt.diff(g.minStartAt,"hours"),e,f,k=0;do{k++;f=d%k;if(6===k)break;e=(f||k)/d*a}while(44>e);if(!b&&t===k)return v;t=k;var l=g.minStartAt.clone().startOf("hour");v=_.times(Math.floor(d/k),function(a){return n(l.clone().add(a*k,"hours"),k)});f&&v.push(n(_.last(v).endAt,f));return v}}]}}])})();
(function(){var h=angular.module("dashboard.booking.services",[]);h.factory("dashboard.bookings.grid",["$filter","auth","localization","models",function(b,a,c,f){var e=_.mapValues({NULL_AXIS:["null",T("None")],START_ON_AXIS:["start-on",T("Start date")],START_TIME_AXIS:["start-time",T("Start time")],ITEM_AXIS:["item",T("Item")],RESOURCE_AXIS:["resource",T("Resource"),"Resource"],RESOURCE_USE_AXIS:["resources-use",T("Resource Use"),"ResourceUse"],CREW_AXIS:["crew",T("Crew"),"CrewMember"]},function(a){return{type:a[0],
label:a[1],permissionsModel:a[2]}}),g=function(a){return[a.column,a.row,a.group]},d={DIMENSIONS:3,AXIS_CHOICES:e,COLUMN_INDEX:0,ROW_INDEX:1,GROUP_INDEX:2,orderedArray:g,AXIS_LABELS:g({column:T("columns"),row:T("rows"),group:T("groups")}),AXIS_TYPE_LABELS:_.mapValues(_.mapKeys(e,"type"),"label"),MAX_DAY_RANGES:g({column:10,row:31,group:31}),filterAxisChoices:function(b,c){return _.filter(b,function(b){b=b.permissionsModel;return!b||a.permissions.canList(f[b],c)})},defaultSettings:function(){return{gridDayRange:7,
gridAxisTypes:g({column:d.START_ON_AXIS,row:d.ITEM_AXIS,group:d.NULL_AXIS})}},dayIdentifier:function(a){return a.format("YYYY-MM-DD")}};_.extend(d,_.mapValues(e,"type"));d.startOnCoordinate=function(a){var b=moment().startOf("day"),e="ddd "+c.current().DATE_FORMATS.shortNoYear+(a.isSame(b,"year")?"":"/YY");return{identifier:d.dayIdentifier(a),displayName:a.format(e),orderBy:+a,isFiltered:_.constant(!1),dontFilterHeading:!0,isToday:a.isSame(b,"day"),isPastDay:a.isBefore(b,"day")}};d.axisMappers={};
var l=b("time"),h=b("name");d.axisMappers[d.NULL_AXIS]=function(a){return{identifier:"none",orderBy:0,isFiltered:_.constant(!1)}};d.axisMappers[d.START_ON_AXIS]=function(a){return d.startOnCoordinate(a.startAt.clone().startOf("day"))};d.axisMappers[d.START_TIME_AXIS]=function(a){var b=60*a.startAt.hours()+a.startAt.minutes();return{identifier:b,displayName:l(a.startAt,a.endAt),orderBy:b,isFiltered:_.constant(!1)}};d.axisMappers[d.ITEM_AXIS]=function(a){return{identifier:a.item.uri,displayName:h(a.item),
orderBy:a.item.sortableIndex,isFiltered:function(b){return b.isCalendarFiltered(a.item)}}};d.axisMappers[d.RESOURCE_AXIS]=function(a){return!a.resources.length?{identifier:"no-resources",displayName:T("No resources"),orderBy:"zzzz",isFiltered:_.constant(!1),resource:null}:_.map(a.resources,function(a){return{identifier:a.uri,displayName:h(a),orderBy:a.name,resource:a,isFiltered:_.constant(!1)}})};d.axisMappers[d.RESOURCE_USE_AXIS]=function(a){if(!a.resourceUseSummaries.length)return{identifier:"no-resource-usages",
displayName:T("No resources used"),orderBy:"zzzz",resource:null,isFiltered:function(a){return a.calendarFilter.noResourcesUsed?!1:_.any(a.calendarFilter.resources)}};a=_.map(a.resourceUseSummaries,function(a){return{identifier:a.resource.uri,displayName:h(a.resource),orderBy:a.resource.name,resource:a.resource,isFiltered:function(b){return b.isCalendarFiltered(a.resource)}}});return _.unique(a,!1,"identifier")};d.axisMappers[d.CREW_AXIS]=function(a){return!a.crewMembers.length?{identifier:"no-crew",
displayName:T("No crew"),orderBy:"zzzz",isFiltered:function(a){return a.calendarFilter.noCrewAssigned?!1:_.any(a.calendarFilter.users)}}:_.map(a.crewMembers,function(a){return{identifier:a.user.uri,displayName:h(a.user),orderBy:a.user.name,isFiltered:function(b){return b.isCalendarFiltered(a)}}})};return d}]);h.factory("dashboard.bookings.timeline",["$filter","dashboard.bookings.grid","models",function(b,a,c){var f=b("name"),e=b("datetime"),g=function(a){switch(a){case c.Resource.cls:return"resourceRequirement.resource";
case c.Booking.cls:return"booking";case c.Availability.cls:return"booking.availability";case c.Item.cls:return"booking.availability.item"}},d={RESOURCE_USE_GROUPINGS:[{type:c.Booking.cls,name:T("Booking")},{type:c.Availability.cls,name:T("Availability")},{type:c.Item.cls,name:T("Item")},{type:c.Resource.cls,name:T("Resource")}],RANGE_TYPES:{AUTO:"auto",CUSTOM:"custom"},AVAILABILITY_AXIS_CHOICES:{NULL_AXIS:a.AXIS_CHOICES.NULL_AXIS,ITEM_AXIS:a.AXIS_CHOICES.ITEM_AXIS,RESOURCE_AXIS:a.AXIS_CHOICES.RESOURCE_AXIS,
RESOURCE_USE_AXIS:a.AXIS_CHOICES.RESOURCE_USE_AXIS,CREW_AXIS:a.AXIS_CHOICES.CREW_AXIS},defaultSettings:function(){return{timelineType:c.Company.AVAILABILITY_TIMELINE,timelineHourRangeType:d.RANGE_TYPES.AUTO,timelineHourRangeStart:7,timelineHourRangeEnd:21,timelineAvailabilityAxis:a.ITEM_AXIS,showUsesOnTimeline:!0,timelineGrouping:c.Item.cls,showOverridesOnTimeline:!1,hideEmptyResourcesOnTimeline:!0,showSpaceOverviewsOnTimeline:!0,showUseOverviewsOnTimeline:!1,showCapacityOverviewsOnTimeline:!1}},
groupingObject:function(a,b){return _.get(b,g(a))},popoverMessage:function(a){switch(a){case c.Booking.cls:return T("by this booking");case c.Availability.cls:return T("for this availability");case c.Item.cls:return T("for this item");default:return""}},displayLinesCount:function(a){switch(a){case c.Booking.cls:return 3;case c.Availability.cls:return 2;default:return 1}},displayLines:function(a){return a?a.cls===c.Resource.cls?[]:a.cls===c.Booking.cls?[f(a.contact)+" - #"+a.pk.toString(),f(a.availability.item),
e(a.availability.startAt)]:a.cls===c.Availability.cls?[f(a.item),e(a.startAt)]:a.cls===c.Item.cls?[f(a)]:[]:[]},orderBy:function(a){return a?a.cls===c.Booking.cls?a.availability.item.sortableIndex:a.cls===c.Availability.cls?a.item.sortableIndex:a.cls===c.Item.cls?a.sortableIndex:"":""},automaticHourRange:function(a,b){if(!a||!a.length)return{};b=b||0;var c=_.min(a,"startAt").startAt;if(!moment.isMoment(c))return{};var c=c.clone().startOf("hour").subtract(b,"hours"),d=_.max(a,"endAt").endAt;if(!moment.isMoment(d))return{};
var e=d.clone().startOf("hour"),f=b;d.isSame(e)||f++;d=e.add(f,"hours");return{startAt:c,endAt:d}},overlapsWith:function(a,b){return function(c){return a.startAt<c.endAt&&c.startAt<a.endAt?!0:b?c.startAt.isSame(c.endAt)&&c.startAt.isSame(a.startAt):!1}}};return d}])})();angular.module("dashboard.embedGenerator",["dashboard.embedGenerator.directives","dashboard.embedGenerator.services"]);
(function(){var h=angular.module("dashboard.embedGenerator.directives",[]);h.directive("ngEmbedGenerator",["$parse","db","embedGenerator",function(b,a,c){return{restrict:"A",scope:!0,controllerAs:"embedGeneratorCtrl",controller:["$scope","$attrs",function(b,e){var g=this;g.embedOptions=e.ngEmbedGenerator?b.$eval(e.ngEmbedGenerator):{};g.availability=e.ngEmbedGeneratorAvailability?b.$eval(e.ngEmbedGeneratorAvailability):null;g.flowNode=e.ngEmbedGeneratorFlowNode?b.$eval(e.ngEmbedGeneratorFlowNode):
null;g.availability?(g.embedOptions.availabilityPk=g.availability.pk,g.embedOptions.embedType=c.BOOK_BUTTON_EMBED,g.embedOptions.open=c.AVAILABILITY_OPEN,g.item=g.availability.item):g.flowNode?(g.embedOptions.flowNodePk=g.flowNode.pk,g.embedOptions.embedType=c.BOOK_BUTTON_EMBED,g.embedOptions.open=c.FLOW_PAGE_OPEN,g.embedOptions.fallback=c.SIMPLE_FALLBACK):g.item=e.ngEmbedGeneratorItem?b.$eval(e.ngEmbedGeneratorItem):null;g.item&&(g.embedOptions.itemPk=g.item.pk);g.shortname=b.company.shortname;g.company=
b.company;g.embedOptions.shortname=g.shortname;g.embedNeedsWarning=function(a){var b=g.embedOptions.codeType===c.WORDPRESS_CODE_TYPE,d=g.embedOptions.embedType===c.BOOK_BUTTON_EMBED;if(a){if("lightframe"===a)return d&&!b;if("wordpress"===a)return b}else return b||d;return!1};g.isAutoLightframeEnabled=!0;var d=a.slipstream("protocol"),l=a.slipstream("domain"),h=d+"://"+l+"/embeds/api/v1/";g.lightframeApiSrc=function(){return h+(g.isAutoLightframeEnabled?"?autolightframe=yes":"")}}]}}]);h.directive("ngEmbedGeneratorSetup",
["$q","db","models","embedGenerator",function(b,a,c,f){return{restrict:"A",scope:!0,require:"^^ngEmbedGenerator",templateUrl:"ng-embed-generator-setup",controllerAs:"ctrl",controller:["$scope",function(e){var g=this;g.embedOptions=e.embedGeneratorCtrl.embedOptions;g.isSimpleFallback=!0;e.$watch("ctrl.isSimpleFallback",function(a){g.embedOptions.fallback=a?f.SIMPLE_FALLBACK:f.CLASSIC_FALLBACK});var d=a.totalSheets.online({shortname:e.embedGeneratorCtrl.shortname}),l=a.totalSchedules.online({shortname:e.embedGeneratorCtrl.shortname});
g.isSheetsAndSchedulesLoaded=!1;b.all([d.$promise,l.$promise]).then(function(){g.isSheetsAndSchedulesLoaded=!0;g.onlineSheetsAndSchedules=_.append(d,l)});g.affiliations=[];if(e.embedGeneratorCtrl.company.affiliatesCount){var h=a.affiliates.pickable({shortname:e.embedGeneratorCtrl.shortname});g.affiliations.$promise=h.$promise.then(function(){g.affiliations=h})}e.$watch("ctrl.sheetOrSchedule",function(a){g.embedOptions.schedulePk="";g.embedOptions.sheetPk="";a&&(a.cls===c.TotalSchedule.cls?g.embedOptions.schedulePk=
a.pk:g.embedOptions.sheetPk=a.pk)})}]}}]);h.directive("ngEmbedGeneratorType",["embedGenerator",function(b){return{restrict:"A",scope:!0,require:"^^ngEmbedGenerator",templateUrl:"ng-embed-generator-type",controllerAs:"ctrl",controller:["$scope",function(a){var c=this;c.embedOptions=a.embedGeneratorCtrl.embedOptions;c.embedOptions.embedType=c.embedOptions.embedType||b.BOOK_BUTTON_EMBED;a.$watch("ctrl.embedOptions.embedType",function(f){f===b.ITEM_GRID_EMBED?c.embedOptions.itemPk=null:a.embedGeneratorCtrl.item&&
(c.embedOptions.itemPk=a.embedGeneratorCtrl.item.pk)})}]}}]);h.directive("ngEmbedGeneratorOpen",["$q","db","models","embedGenerator","urls","cache",function(b,a,c,f,e,g){return{restrict:"A",scope:!0,require:"^^ngEmbedGenerator",templateUrl:"ng-embed-generator-open",controllerAs:"openCtrl",controller:["$scope",function(d){var l=this;l.embedOptions=d.embedGeneratorCtrl.embedOptions;var h=function(b){b={shortname:d.company.shortname,flowNodePk:b};var c=e.populate(e.api.flowNode,b),c=g.cache[c];if(!c||
!c.children)c=a.flowNode(b);return c};d.$watch("openCtrl.embedOptions.flowNodePk",function(a){if(a){var d=h(a);(d.$promise||b.when()).then(function(){l.chosenFlowNodeIncludesItems=c.FlowNode.isAllItems(d)||0<c.FlowNode.childItems(d).length;l.chosenFlowNodeSupportsCalendar=c.FlowNode.isCalendarIncluded(d);!l.chosenFlowNodeSupportsCalendar&&l.embedOptions.open===f.FLOW_PAGE_CALENDAR_OPEN&&(l.embedOptions.open=f.FLOW_PAGE_OPEN)})}else l.chosenFlowNodeIncludesItems=!0,l.chosenFlowNodeSupportsCalendar=
!0});d.$watch("openCtrl.embedOptions.embedType",function(){l.embedOptions.open=d.embedGeneratorCtrl.item?f.ITEM_OPEN:f.FLOW_PAGE_OPEN})}]}}]);h.directive("ngEmbedGeneratorMessage",["db","embedGenerator",function(b,a){return{restrict:"A",scope:!0,require:"^^ngEmbedGenerator",templateUrl:"ng-embed-generator-message",controllerAs:"ctrl",controller:["$scope",function(a){this.embedOptions=a.embedGeneratorCtrl.embedOptions}]}}]);h.directive("ngEmbedGeneratorFlowPageSelect",["db","embedGenerator","models",
function(b,a,c){return{restrict:"A",scope:!0,require:"^^ngEmbedGenerator",templateUrl:"ng-embed-generator-flow-page-select",controllerAs:"flowPageSelectCtrl",controller:["$scope","$attrs","$q","db","models",function(a,b,c,d,l){var h=this;h.isRequired=a.$eval(b.ngEmbedGeneratorFlowPageSelectRequired);h.allowNoFlow=a.$eval(b.ngEmbedGeneratorFlowPageSelectAllowNoFlow);h.placeholder=a.$eval(b.ngEmbedGeneratorFlowPageSelectPlaceholder);h.hint=a.$eval(b.ngEmbedGeneratorFlowPageSelectHint);h.label=a.$eval(b.ngEmbedGeneratorFlowPageSelectLabel);
h.item=a.$eval(b.ngEmbedGeneratorFlowPageSelectItem);b=function(){var b=_.get(a.embedGeneratorCtrl,"rootFlowNodes");b||(b=d.flowNodes.root({shortname:a.company.shortname}),_.set(a.embedGeneratorCtrl,"rootFlowNodes",b));return c.when(b.$promise).then(_.constant(b))};var k={};h.promise=h.item?function(){var b="flowNodesWithItem["+h.item.uri+"]",e=_.get(a.embedGeneratorCtrl,b);e||(e=d.item.flowPages.full({shortname:h.item.company.shortname,itemPk:h.item.pk}),_.set(a.embedGeneratorCtrl,b,e));return c.when(e.$promise).then(function(){var a=
[];_.forEach(e,function(b){var c=b.breadcrumbs[0]||b;k[c.uri]=k[c.uri]||[];k[c.uri].push(b);_.contains(a,c)||a.push(c)});return _.sortBy(a,"sortableIndex")})}():b();c.when(h.promise).then(function(a){h.rootFlowNodes=h.allowNoFlow?_.union(a,[l.FlowNode.NO_FLOW]):a;h.isRequired&&h.rootFlowNodes.length&&(h.chosenRootFlowNodePk=h.rootFlowNodes[0].pk)});var n=function(b){var c="flowNodeWithDescendants["+b.uri+"]",e=_.get(a.embedGeneratorCtrl,c);e||(e=d.flowNode.withDescendants({shortname:a.company.shortname,
flowNodePk:b.pk}),_.set(a.embedGeneratorCtrl,c,e));return e};a.$watch("flowPageSelectCtrl.chosenRootFlowNode",function(){h.chosenRootFlowNode?h.chosenRootFlowNode===l.FlowNode.NO_FLOW?a.embedGeneratorCtrl.embedOptions.flowNodePk=l.FlowNode.NO_FLOW.pk:h.item?(h.flowPages=k[h.chosenRootFlowNode.uri],a.embedGeneratorCtrl.embedOptions.flowNodePk=h.flowPages[0].pk):(h.flowPages=[],h.flowPages.$promise=n(h.chosenRootFlowNode).$promise,c.when(h.flowPages.$promise).then(function(){_.ref.append(h.flowPages,
h.chosenRootFlowNode.descendants);h.flowPages.unshift(h.chosenRootFlowNode);a.embedGeneratorCtrl.embedOptions.flowNodePk=h.flowPages[0].pk})):a.embedGeneratorCtrl.embedOptions.flowNodePk=null});h.flowPageName=function(a){return a===h.chosenRootFlowNode?T("Top level")+" ("+a.name+")":a.name}}]}}]);h.directive("ngEmbedGeneratorItemSelect",[function(){return{restrict:"A",require:["^^ngEmbedGenerator","^^ngEmbedGeneratorOpen"],templateUrl:"ng-embed-generator-item-select",controllerAs:"itemSelectCtrl",
controller:["$scope","$attrs","$q","db","models","require",function(b,a,c,f,e,g){g.inScope(b,"embedGeneratorCtrl");var d=this;d.isRequired=b.$eval(a.ngEmbedGeneratorItemSelectRequired);b.embedGeneratorCtrl.item?d.items=[b.embedGeneratorCtrl.item]:(d.items=b.embedGeneratorCtrl.items||f.items.public({shortname:b.embedGeneratorCtrl.shortname}),b.embedGeneratorCtrl.items=d.items);(d.items.$promise||c.when()).then(function(){d.isRequired&&d.items.length&&(b.embedGeneratorCtrl.embedOptions.itemPk=d.items[0].pk)})}]}}]);
h.directive("ngEmbedGeneratorCode",["embedGenerator",function(b){return{restrict:"A",scope:!0,require:"^^ngEmbedGenerator",templateUrl:"ng-embed-generator-code",controllerAs:"ctrl",controller:["$scope",function(a){var c=this;c.embedOptions=a.embedGeneratorCtrl.embedOptions;c.codeType=c.embedOptions.embedType===b.BOOK_BUTTON_EMBED?b.ANCHOR_CODE_TYPE:b.JAVASCRIPT_CODE_TYPE;var f=function(){c.embedOptions.codeType=c.codeType;c.code=b.generate(c.embedOptions)};a.$watch("ctrl.codeType",f);var e=[b.ANCHOR_CODE_TYPE,
b.URL_CODE_TYPE];a.$watch("ctrl.embedOptions.embedType",function(a){a=a===b.BOOK_BUTTON_EMBED;!a&&_.contains(e,c.codeType)&&(c.codeType=b.JAVASCRIPT_CODE_TYPE);a&&c.codeType===b.JAVASCRIPT_CODE_TYPE&&(c.codeType=b.ANCHOR_CODE_TYPE)});a.$watch("ctrl.embedOptions",f,!0)}]}}])})();
(function(){var h=angular.module("dashboard.embedGenerator.services",[]);h.factory("embedGenerator",["db","navigation",function(b,a){var c=T("Book online now!"),f={CALENDAR_EMBED:"calendar-embed",ITEM_GRID_EMBED:"item-grid-embed",BOOK_BUTTON_EMBED:"book-button-embed"},e={ITEM_OPEN:"item",AVAILABILITY_OPEN:"availability",FLOW_PAGE_OPEN:"flow-page",FLOW_PAGE_CALENDAR_OPEN:"flow-calendar"},g={CLASSIC_FALLBACK:"classic",SIMPLE_FALLBACK:"simple"},d={JAVASCRIPT_CODE_TYPE:"js",WORDPRESS_CODE_TYPE:"wordpress",
ANCHOR_CODE_TYPE:"anchor",URL_CODE_TYPE:"url"},l=b.slipstream("domain"),h=b.slipstream("protocol")+"://"+l,k=function(a,b,c){c=c||{};_.forEach(a,function(a,d){var e=b[d];switch(d){case "asnReference":b.asnShortname||(e=null);break;case "isFullItems":case "isKioskModeEnabled":e=e?"yes":null;break;case "isLightframeDisabled":e=e?"no":null;break;case "flowNodePk":e=!1===e?"no":e}e&&(c[a]=e)});return c},n=function(a){a=_.clone(a);var b=a.open===e.AVAILABILITY_OPEN,c=b||a.open===e.ITEM_OPEN;b&&!a.availabilityPk&&
(a.open=e.ITEM_OPEN);c&&!a.itemPk&&(a.open=e.FLOW_PAGE_OPEN);!1===a.flowNodePk&&!a.itemPk&&delete a.flowNodePk;return a},l={onlineBookingReference:"ref",sheetPk:"sheet",schedulePk:"schedule",asnShortname:"asn",asnReference:"asn-ref",isFullItems:"full-items",isKioskModeEnabled:"kiosk",backUrl:"back",flowNodePk:"flow",language:"language"},s=_.extend({buttonTags:"button-tags"},l),p=function(b){var c=h+"/";b=n(b);var d=b.fallback===g.SIMPLE_FALLBACK;d&&(c+="embeds/book/");var c=c+(b.shortname+"/"),f=
b.open===e.FLOW_PAGE_CALENDAR_OPEN,l=b.open===e.AVAILABILITY_OPEN,p=l||b.open===e.ITEM_OPEN;if(!d||f||p&&b.itemPk)c+="items/";p&&b.itemPk?(c+=b.itemPk+"/",l&&b.availabilityPk?c+="availability/"+b.availabilityPk+"/book/":b.isFullItems||(c+="calendar/")):f&&(c+="calendar/");b=k(s,b);return a.compose(c,b)},r={};r[f.CALENDAR_EMBED]="calendar";r[f.ITEM_GRID_EMBED]="item grid";r[f.BOOK_BUTTON_EMBED]="book button";var t=function(a){var b="\x3c!-- FareHarbor "+r[a.embedType],c=a.embedType===f.BOOK_BUTTON_EMBED?
" for ":" of ",d=a.open===e.AVAILABILITY_OPEN;(d||a.open===e.ITEM_OPEN)&&a.itemPk?(b+=c+"item #"+a.itemPk,d&&a.availabilityPk&&(b+=", availability #"+a.availabilityPk)):a.flowNodePk&&(b+=c+"flow #"+a.flowNodePk);return b+" --\x3e\r\n"},v={},y=_.extend({fallback:"fallback",isLightframeDisabled:"lightframe"},l),q=function(b,c,d,e){!1===c.flowNodePk&&!c.itemPk&&(c=_.omit(c,"flowNodePk"));b=h+"/embeds/script/"+b+"/"+c.shortname+"/"+d;k(y,c,e);return a.compose(b,e)};v[f.CALENDAR_EMBED]=function(a){var b=
"";a.open===e.ITEM_OPEN&&a.itemPk&&(b="items/"+a.itemPk+"/");b=q("calendar",a,b,{});return t(a)+'<script src="'+b+'">\x3c/script>'};v[f.ITEM_GRID_EMBED]=function(a){var b={};a.isFullItems&&(b["full-items"]="yes");b=q("items",a,"",b);return t(a)+'<script src="'+b+'">\x3c/script>'};var B=function(a){if(_.isArray(a))return"["+a.join()+"]";if(_.isObject(a)){var b=[];_.forEach(a,function(a,c){a&&(!_.isArray(a)||_.any(a))&&b.push(c+": "+B(a))});return b.length?"{ "+b.join(", ")+" }":""}return isNaN(a)?
"'"+a+"'":a},u={shortname:"shortname",itemPks:"items",fallback:"fallback",onlineBookingReference:"ref",sheetPk:"sheet",schedulePk:"schedule",asnShortname:"asn",asnReference:"asnRef",isFullItems:"fullItems",isLightframeDisabled:"lightframe",isKioskModeEnabled:"kiosk",backUrl:"back",buttonTags:"buttonTags",flowNodePk:"flow",language:"language"};v[f.BOOK_BUTTON_EMBED]=function(a){a=n(a);var b=k(u,a);switch(a.open){case e.FLOW_PAGE_OPEN:b.view="items";break;case e.FLOW_PAGE_CALENDAR_OPEN:b.view="all-availability";
break;case e.ITEM_OPEN:b.view={item:a.itemPk};break;case e.AVAILABILITY_OPEN:b.view={item:a.itemPk,availability:a.availabilityPk}}b="return !(window.FH && FH.open("+B(b)+"));";return t(a)+'<a href="'+p(a)+'" onclick="'+b+'">'+(a.message||c)+"</a>"};var z={},C={shortname:"shortname",fallback:"fallback",onlineBookingReference:"ref",sheetPk:"sheet",schedulePk:"schedule",asnShortname:"asn",asnReference:"asn_ref",isFullItems:"full_items",isLightframeDisabled:"lightframe",flowNodePk:"flow",language:"language"},
F=function(a,b){var c=[];_.forEach(b,function(a,b){(a=_.isArray(a)?a.join():a)&&c.push(b+'="'+a+'"')});return"["+a+" "+c.join(" ")+"]"};z[f.CALENDAR_EMBED]=function(a){var b=k(C,a);b.items=[a.itemPk];b.type="responsive";return F("fareharbor",b)};z[f.ITEM_GRID_EMBED]=function(a){a=k(C,a);return F("itemgrid",a)};var x=_.extend(C,{buttonTags:"button_tags"});z[f.BOOK_BUTTON_EMBED]=function(a){a=n(a);var b=k(x,a);switch(a.open){case e.FLOW_PAGE_CALENDAR_OPEN:b.view="all-availability";break;case e.ITEM_OPEN:b.view_item=
a.itemPk;break;case e.AVAILABILITY_OPEN:b.view_item=a.itemPk,b.view_availability=a.availabilityPk}return F("lightframe",b)+(a.message||c)+"[/lightframe]"};var w={};w[d.JAVASCRIPT_CODE_TYPE]=function(a){return v[a.embedType](a)};w[d.WORDPRESS_CODE_TYPE]=function(a){return z[a.embedType](a)};w[d.ANCHOR_CODE_TYPE]=function(a){return a.embedType!==f.BOOK_BUTTON_EMBED?"":t(a)+'<a href="'+p(a)+'">'+(a.message||c)+"</a>"};w[d.URL_CODE_TYPE]=function(a){return a.embedType!==f.BOOK_BUTTON_EMBED?"":p(a)};l=
{generate:function(a){return!a.codeType?"":w[a.codeType](a)}};_.extend(l,d,e,f,g);l.DEFAULT_MESSAGE=c;return l}]);h.run(["$rootScope","embedGenerator",function(b,a){b.embedGenerator=a}])})();angular.module("dashboard.items",["dashboard.items.controllers"]);
(function(){var h=angular.module("dashboard.items.controllers",[]);h.controller("dashboard.items.IndexCtrl",["$scope","auth","controllers","db","navigation","require","urls",function(b,a,c,f,e,g,d){g.inScope(b,"company","dashboard.items.IndexCtrl");var l={list:d.dashboard.items.list,grid:d.dashboard.items.grid},h=a.isAuthenticatedForAdminCompany()?"list":"grid";e.watch(b,function(){var c;e.pathEquals(d.dashboard.items.index)?(c=a.storage.get("dashboard.items.IndexCtrl.view")||h,e.redirect(b.company.$url(l[c]||
l[h]))):(c=_.chooseFirst(l,function(a,b){if(e.pathStartsWith(a))return b}),_.isUndefined(c)||a.storage.set("dashboard.items.IndexCtrl.view",c))});var k=f.items({shortname:b.company.shortname},null,null,{"include-archived":"yes"});b.items=[];b.hasAnyArchivedItems=function(){return _.any(k,"isArchived")};b.itemFilters=b.itemFilters||{dragToReorder:!0,showArchivedItems:!1};c.dataController(b,{promises:[k.$promise],successCallback:function(){c.reorderController(b,{collectionKey:"items"});b.$watch("itemFilters.showArchivedItems",
function(){b.items=b.itemFilters.showArchivedItems?k:_.filter(k,"isArchived",!1)})}})}]);h.controller("dashboard.items.CreateItemCtrl",["$scope","controllers","db","navigation","require","urls",function(b,a,c,f,e,g){e.inScope(b,"company","dashboard.items.CreateItemCtrl");return a.createController(b,{modelKey:"newItem",create:c.items.create,params:function(){return{shortname:b.company.shortname}},defaultModel:{name:""},successCallback:function(a){f.navigate(a.$url(g.dashboard.items.item.index))}})}]);
h.controller("dashboard.items.item.IndexCtrl",["$scope","controllers","db","navigation","pricingNavigation","require","urls",function(b,a,c,f,e,g,d){g.inScope(b,"company","dashboard.items.item.IndexCtrl");g.inScope(b,"items","dashboard.items.item.IndexCtrl");b.item=c.item({shortname:b.company.shortname,itemPk:b.route.bindings.itemPk});var l=function(a){var c=_.indexOf(b.items,b.item);-1!==c&&(c+=b.items.length+a,c%=b.items.length,c=b.items[c],a=b.item.$url(d.dashboard.items.item.index),c=c.$url(d.dashboard.items.item.index),
a=f.url.replace(a,c),e.sheets.length&&!e.sheets[0].isBase&&(a=f.compose(a,{"sheet-type":e.sheets[0].cls,sheet:e.sheets[0].pk.toString()})),f.navigate(a))};b.previousItem=function(){l(-1)};b.nextItem=function(){l(1)};a.dataController(b,{promises:[b.item.$promise]})}]);h.controller("dashboard.items.item.CalendarCtrl",["$scope","$interpolate","$q","$window","auth","availabilityUpdater","controllers","db","events","flash","models","moment","navigation","require","toggles","urls",function(b,a,c,f,e,g,
d,l,h,k,n,s,p,r,t,v){r.inScope(b,"item","dashboard.items.item.CalendarCtrl");b.requirementGroups=[];l.requirementGroups({shortname:b.company.shortname,itemPk:b.item.pk}).then(function(a){b.requirementGroups=a});b.customFieldInstanceGroups=l.customFieldInstanceGroups({shortname:b.item.company.shortname,itemPk:b.item.pk});b.customerPrototypes=l.customerPrototypes({shortname:b.item.company.shortname,itemPk:b.item.pk});b.affiliations=l.affiliates({shortname:b.item.company.shortname});b.routes=l.routes.pickable({shortname:b.item.company.shortname});
b.bookingRestrictions=l.bookingRestrictions({shortname:b.item.company.shortname});b.newRule={};b.status="showingNone";b.dates={};b.showAllSections=e.permissions.canAdminUpdate(b.item);b.toggleShowAllSections=function(){b.showAllSections=!b.showAllSections};var y=p.absoluteUrl(b.item.$url(v.dashboard.items.item.calendar));b.isCalendarUrl=function(a){return _.startsWith(a,y)};var q=s().add("year",1).endOf("year"),B=function(){var a=_.extend(n.Rule.defaultRule(),{endOn:q.format("YYYY-MM-DD"),capacity:"",
status:n.Availability.AUTO_STATUS,customFieldInstanceGroup:0<b.customFieldInstanceGroups.length?b.customFieldInstanceGroups[0].pk:"",requirementGroup:0<b.requirementGroups.length?b.requirementGroups[0].pk:"",defaultRoute:0<b.routes.length?b.routes[0].pk:""});_.forEach(b.customerPrototypes,function(b){a["customerPrototype"+b.pk+"-isAdded"]=!1;a["customerPrototype"+b.pk+"-capacity"]=b.capacity;a["customerPrototype"+b.pk+"-minimumPartySize"]=b.minimumPartySize;a["customerPrototype"+b.pk+"-maximumPartySize"]=
b.maximumPartySize});return a};b.isPricingValid=function(){return _.any(b.customerPrototypes,function(a){return b.newRule["customerPrototype"+a.pk+"-isAdded"]})};b.onPricing=function(){return t.state("availability-rates")};b.addAvailabilitiesOnDay=function(a){"addingRule"!==b.status&&(b.newRule=B(),b.status="addingRule");b.dates.currentDate=a.at;b.newRule.startOn=b.dates.currentDate.format("YYYY-MM-DD")};b.$watch("newRule.startOn",function(a){b.dates.currentDate=s(a,"YYYY-MM-DD")});b.duplicateAvailability=
function(a){b.dates.currentDate=a.startAt;b.newRule=B();b.newRule.startOn=b.dates.currentDate.format("YYYY-MM-DD");b.newRule.time=a.startAt.format("HH:mm");b.newRule.hours=a.endAt.diff(a.startAt,"hours",!0);b.newRule.days=a.endAt.diff(a.startAt,"days");b.newRule.status=a.status;b.newRule.capacity=a.capacity;b.newRule.headline=a.headline;b.newRule.headlinePrivate=a.headlinePrivate;b.newRule.isUnlisted=a.isUnlisted;l.availability({shortname:a.company.shortname,itemPk:a.item.pk,availabilityPk:a.pk}).$promise.then(function(){b.newRule.customFieldInstanceGroup=
a.customFieldInstanceGroup?a.customFieldInstanceGroup.pk:"";b.newRule.defaultRoute=a.defaultRoute?a.defaultRoute.pk:"";b.newRule.requirementGroup=a.requirementGroup?a.requirementGroup.pk:"";b.newRule.bookingRestriction=a.bookingRestriction?a.bookingRestriction.pk:"";_.forEach(b.customerPrototypes,function(c){var d="customerPrototype"+c.pk.toString();b.newRule[d+NaN]=!1;_.forEach(a.customerTypeRates,function(a){a.customerPrototype===c&&(b.newRule[d+"-isAdded"]=!0,b.newRule[d+"-capacity"]=a.capacity,
b.newRule[d+"-minimumPartySize"]=a.minimumPartySize,b.newRule[d+"-maximumPartySize"]=a.maximumPartySize)})})});b.status="addingRule"};b.cancelAddingRule=function(){"addingRule"===b.status&&(b.status="showingNone",b.editorLocation=null,b.dates.currentDate=null)};h.on(b,"lib.shared.CalendarCtrl.month",function(a,c){b.currentCalendarMonth=c.date});b.needsCapacity=function(a,b){var c=a[b+"-total"];return 0===c||0<c};var u=T("There are no availabilities to remove."),z=b.$new(),C=function(a,c,d,e){var g=
{};a(c,{isDryRun:1}).$promise.then(function(b){b=b.data.removedAvailabilities.count;if(!b)return f.alert(u),g;e?(z.count=b,b=e(z)):b=interpolate(nT("Are you sure you want to remove %(count)s availability?","Are you sure you want to remove %(count)s availabilities?",b),{count:b})+"\n\n"+T("Availabilities with bookings on them will not be affected.");return!f.confirm(b)?g:a(c,{},d).$promise}).then(function(a){a!==g&&(h.broadcast("lib.shared.CalendarCtrl.refresh"),h.broadcast("dashboard.shared.ActivitiesCtrl.refresh"),
b.status="showingNone",a=a.data.removedAvailabilities.count,k.success(b.$interpolate(interpolate(nT("Removed %(count)s availability","Removed %(count)s availabilities",a),{count:a}))))})};h.on(b,"dashboard.shared.ActivitiesCtrl.clearAvailabilitiesByTag",function(a,c){C(l.availabilities.byTag.clear,{shortname:b.item.company.shortname,itemPk:b.item.pk,tag:c.tag})});h.on(b,"dashboard.shared.AvailabilityEditableCtrl.updated",function(){h.broadcast("dashboard.shared.ActivitiesCtrl.refresh");h.broadcast("lib.shared.CalendarCtrl.refresh")});
h.on(b,"dashboard.shared.AvailabilityEditableCtrl.removed",function(a,c){h.broadcast("lib.shared.CalendarCtrl.refresh");h.broadcast("dashboard.shared.ActivitiesCtrl.refresh");b.status="showingDate"});return d.dataController(b,{promises:[b.item.$promise,b.customerPrototypes.$promise,b.affiliations.$promise,b.customFieldInstanceGroups.$promise,b.routes.$promise,b.requirementGroups.$promise],successCallback:function(){var a;b.availabilityUpdater=g({allItems:[b.item],initialSelectedItems:[b.item],onOpen:function(){b.cancelAddingRule();
this.startDate=b.currentCalendarMonth.clone().startOf("month");this.endDate=b.currentCalendarMonth.clone().endOf("month");this.company=b.item.company}});h.on(b,"dashboard.shared.availabilityUpdater.createAvailabilities",function(a,c){b.availabilityUpdater.close();b.addAvailabilitiesOnDay({at:s(c.date)})});b.$watch("status",function(a){"addingRule"===a&&b.availabilityUpdater.close()});return d.listController(b,{modelKey:"newRule",create:l.availabilities.rule,params:function(){return{shortname:b.item.company.shortname,
itemPk:b.item.pk}},submitCallback:function(){a=b.newRule},successCallback:function(c){h.broadcast("dashboard.shared.ActivitiesCtrl.refresh");h.broadcast("lib.shared.CalendarCtrl.refresh");c.count?(k.success(b.$interpolate(interpolate(nT("Created %(count)s availability","Created %(count)s availabilities",c.count),{count:c.count}))),b.newRule=a,t.toggle("ruleGeneral",!0)):k.warn(T("No availabilities created"))},defaultModel:B()})}})}]);h.controller("dashboard.items.item.PricingCtrl",["$scope","controllers",
"db","require",function(b,a,c,f){f.inScope(b,"item","dashboard.items.item.PricingCtrl");b.customFields=c.customFields({shortname:b.item.company.shortname});b.customerTypes=c.customerTypes({shortname:b.item.company.shortname});b.resources=c.resources({shortname:b.item.company.shortname});a.dataController(b,{promises:[b.customFields.$promise,b.customerTypes.$promise,b.resources.$promise]})}]);h.controller("dashboard.items.item.RequirementGroupsCtrl",["$scope","controllers","db","require","events",function(b,
a,c,f,e){f.inScope(b,"item","dashboard.items.item.RequirementGroupsCtrl");f.inScope(b,"resources","dashboard.items.item.RequirementGroupsCtrl");b.customerPrototypes=c.customerPrototypes({shortname:b.item.company.shortname,itemPk:b.item.pk},null,null,null,{tagAlong:!0});b.requirementGroups=c.itemRequirementGroups({shortname:b.item.company.shortname,itemPk:b.item.pk});e.on(b,"dashboard.shared.RequirementGroupEditableCtrl.duplicated",function(a,c){b.requirementGroups.push(c.requirementGroup)});a.dataController(b,
{promises:[b.customerPrototypes.$promise,b.requirementGroups.$promise],successCallback:function(){b.item.requirementGroups=b.requirementGroups;a.listController(b,{collectionKey:"requirementGroups",modelKey:"newRequirementGroup",create:c.itemRequirementGroups.create,params:function(){return{shortname:b.item.company.shortname,itemPk:b.item.pk}},defaultModel:{shortName:""},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}})}})}]);h.controller("dashboard.items.item.CustomFieldInstanceGroupsCtrl",
["$scope","controllers","db","require","events",function(b,a,c,f,e){f.inScope(b,"item","dashboard.items.item.CustomFieldInstanceGroupsCtrl");var g=function(){b.customFieldInstanceGroups=c.customFieldInstanceGroups({shortname:b.item.company.shortname,itemPk:b.item.pk},null,null,null,{tagAlong:!0});b.item.customFieldInstanceGroups=b.customFieldInstanceGroups};g();e.on(b,"dashboard.items.item.CustomFieldInstanceGroupsCtrl.refresh",function(a,c){c.item===b.item&&g()});a.listController(b,{collectionKey:"customFieldInstanceGroups",
modelKey:"newCustomFieldInstanceGroup",create:c.customFieldInstanceGroups.create,params:function(){return{shortname:b.item.company.shortname,itemPk:b.item.pk}},defaultModel:{name:""},successCallback:function(a){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");e.broadcast("dashboard.items.item.CustomFieldInstanceGroupsCtrl.created",{customFieldInstanceGroup:a})}})}]);h.controller("dashboard.items.item.CustomFieldInstanceGroupEditableCtrl",["$scope","controllers","dashboard.shared.duplicatingController",
"db","events","flash","require",function(b,a,c,f,e,g,d){d.inScope(b,"item","dashboard.items.item.CustomFieldInstanceGroupEditableCtrl");d.inScope(b,"customFieldInstanceGroups","dashboard.items.item.CustomFieldInstanceGroupEditableCtrl");d.inScope(b,"customFieldInstanceGroup","dashboard.items.item.CustomFieldInstanceGroupEditableCtrl");a.editController(b,{collectionKey:"customFieldInstanceGroups",elementKey:"customFieldInstanceGroup",modelKey:"editableCustomFieldInstanceGroup",update:f.customFieldInstanceGroup.update,
remove:f.customFieldInstanceGroup.remove,params:function(){return{shortname:b.customFieldInstanceGroup.company.shortname,itemPk:b.customFieldInstanceGroup.item.pk,customFieldInstanceGroupPk:b.customFieldInstanceGroup.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");e.broadcast("dashboard.items.item.CustomFieldInstanceGroupEditableCtrl.removed",{customFieldInstanceGroup:b.customFieldInstanceGroup})}});
c(b,{endpoint:f.customFieldInstanceGroup.duplicate,params:{itemPk:b.customFieldInstanceGroup.item.pk,shortname:b.customFieldInstanceGroup.company.shortname,customFieldInstanceGroupPk:b.customFieldInstanceGroup.pk},successCallback:function(){g.success(T("Duplicated custom field group"));e.broadcast("dashboard.items.item.CustomFieldInstanceGroupsCtrl.refresh",{item:b.item});e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");e.broadcast("pricing.ngPricing.refresh",{object:b.item});b.editCtrl.cancel()}})}]);
h.controller("dashboard.items.item.CustomerPrototypesCtrl",["$scope","$timeout","controllers","db","events","require",function(b,a,c,f,e,g){g.inScope(b,"item","dashboard.items.item.CustomerPrototypesCtrl");g.inScope(b,"customerTypes","dashboard.items.item.CustomerPrototypesCtrl");var d=function(){b.customerPrototypes=f.customerPrototypes({shortname:b.item.company.shortname,itemPk:b.item.pk},null,null,null,{tagAlong:!0});b.item.customerPrototypes=b.customerPrototypes};d();e.on(b,"dashboard.items.item.CustomerPrototypesCtrl.refresh",
function(a,c){c.item===b.item&&d()});c.listController(b,{collectionKey:"customerPrototypes",modelKey:"newCustomerPrototype",create:f.customerPrototypes.create,params:function(){return{shortname:b.item.company.shortname,itemPk:b.item.pk}},defaultModel:{name:""},successCallback:function(c){e.broadcast("pricing.ngPricing.refresh",{object:b.item});e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");e.broadcast("dashboard.items.item.CustomerPrototypesCtrl.created",{customerPrototype:c});a(function(){e.broadcast("pricing.ngPricing.open",
{object:c})})}})}]);h.controller("dashboard.items.item.CustomerPrototypeEditableCtrl",["$scope","controllers","db","events","require","dashboard.shared.duplicatingController","flash",function(b,a,c,f,e,g,d){e.inScope(b,"item","dashboard.items.item.CustomerPrototypeCtrl");e.inScope(b,"customerPrototypes","dashboard.items.item.CustomerPrototypeCtrl");e.inScope(b,"customerPrototype","dashboard.items.item.CustomerPrototypeCtrl");a.editController(b,{collectionKey:"customerPrototypes",elementKey:"customerPrototype",
modelKey:"editableCustomerPrototype",update:c.customerPrototype.update,remove:c.customerPrototype.remove,params:function(){return{shortname:b.customerPrototype.company.shortname,itemPk:b.customerPrototype.item.pk,customerPrototypePk:b.customerPrototype.pk}},editCallback:function(){c.customerPrototype({shortname:b.customerPrototype.company.shortname,itemPk:b.customerPrototype.item.pk,customerPrototypePk:b.customerPrototype.pk})},successCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},
removeCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh");f.broadcast("dashboard.items.item.CustomerPrototypeEditableCtrl.removed",{customerPrototype:b.customerPrototype})}});g(b,{endpoint:c.customerPrototype.duplicate,params:{itemPk:b.customerPrototype.item.pk,shortname:b.customerPrototype.company.shortname,customerPrototypePk:b.customerPrototype.pk},successCallback:function(){d.success(T("Duplicated customer type"));f.broadcast("dashboard.items.item.CustomerPrototypesCtrl.refresh",
{item:b.item});f.broadcast("dashboard.shared.ActivitiesCtrl.refresh");f.broadcast("pricing.ngPricing.refresh",{object:b.item});b.editCtrl.cancel()}})}]);h.controller("dashboard.items.item.CustomFieldInstancesCtrl",["$scope","controllers","db","events","require",function(b,a,c,f,e){e.inScope(b,"item","dashboard.items.item.CustomFieldInstancesCtrl");e.inScope(b,"customFields","dashboard.items.item.CustomFieldInstancesCtrl");b.customFieldInstancesObject=b.customerPrototype||b.customFieldInstanceGroup;
e.inScope(b,"customFieldInstancesObject","dashboard.items.item.CustomFieldInstancesCtrl");b.$watch("customFieldInstancesObject.customFieldInstances",function(a){b.customFieldInstances=a});a.listController(b,{collectionKey:"customFieldInstances",modelKey:"newCustomFieldInstance",create:c.customFieldInstances.create,remove:c.customFieldInstance.remove,params:function(){return{shortname:b.item.company.shortname,itemPk:b.item.pk}},defaultModel:{customerPrototype:b.customerPrototype?b.customerPrototype.pk:
"",customFieldInstanceGroup:b.customFieldInstanceGroup?b.customFieldInstanceGroup.pk:"",customField:""},refreshActivities:!0,successCallback:function(){f.broadcast("pricing.ngPricing.refresh",{object:b.item})},sortable:!0})}]);h.controller("dashboard.items.item.CustomFieldInstanceCtrl",["$scope","controllers","db","events","require",function(b,a,c,f,e){e.inScope(b,"item","dashboard.items.item.CustomFieldInstanceCtrl");e.inScope(b,"customFieldInstances","dashboard.items.item.CustomFieldInstanceCtrl");
e.inScope(b,"customFieldInstance","dashboard.items.item.CustomFieldInstanceCtrl");b.customField=b.customFieldInstance.customField;b.tracker=_.tracker();f.on(b,"dashboard.shared.CustomFieldInstanceEditableCtrl.updated",function(a,c){c.customFieldInstance===b.customFieldInstance&&b.tracker.modified()});f.on(b,"dashboard.shared.CustomFieldEditableCtrl.updated",function(a,d){d.customField===b.customField&&c.customFieldInstance({shortname:b.customFieldInstance.company.shortname,itemPk:b.customFieldInstance.item.pk,
customFieldInstancePk:b.customFieldInstance.pk}).$promise.then(function(){b.tracker.modified()})})}]);h.controller("dashboard.items.item.SubscriptionsCtrl",["$scope","auth","controllers","dashboard.shared.subscriptionsController","db","flash","models","navigation","require",function(b,a,c,f,e,g,d,l,h){h.notNull(l,"currentCompany","dashboard.items.item.SubscriptionsCtrl");h.inScope(b,"item","dashboard.items.item.SubscriptionsCtrl");b.users=[];a.permissions.canList(d.User,l.currentCompany)&&a.permissions.canCreate(d.Subscription,
l.currentCompany)?b.users=e.users({shortname:l.currentCompany.shortname}):a.currentUser.company===l.currentCompany&&(b.users=[a.currentUser]);b.subscriptions=e.item.subscriptions({itemPk:b.item.pk,shortname:l.currentCompany.shortname});b.editableSubscriptions={};b=f(b,{modelKey:"editableSubscriptions",company:b.item.company});b.options={};b.$watch("options.user",function(a){a&&(_.clear(b.editableSubscriptions),b.subscriptionsCtrl.edit(k[a.uri]))});b=c.editController(b,{elementKey:"editableSubscriptions",
modelKey:"editableSubscriptions",update:e.user.itemSubscriptions.update,editing:!0,params:function(){return{shortname:l.currentCompany.shortname,itemPk:b.item.pk,username:b.options.user.username}},successCallback:function(a){g.success(T("Saved subscription settings"));k[b.options.user.uri]=a}});var k={};b.isForAllItems=function(a){var c=b.options.user;return!k[c.uri]?!1:_.some(k[c.uri],function(b){return b.type===a&&_.isNull(b.item)})};return c.dataController(b,{promises:[b.users.$promise,b.subscriptions.$promise],
successCallback:function(){b.users=_.filter(b.users,function(a){return!!a.email});a.currentUser.company===l.currentCompany&&_.contains(b.users,a.currentUser)?b.options.user=a.currentUser:b.users.length&&(b.options.user=_.first(b.users));_.forEach(b.subscriptions,function(a){k[a.user.uri]||(k[a.user.uri]=[]);k[a.user.uri].push(a)})}})}]);h.controller("dashboard.items.item.ImagesCtrl",["$scope","controllers","db","models","navigation","require","auth",function(b,a,c,f,e,g,d){g.inScope(b,"item");b.images=
c.item.images({shortname:b.item.company.shortname,itemPk:b.item.pk});var l=function(){c.item({shortname:b.item.company.shortname,itemPk:b.item.pk})};return a.dataController(b,{promises:[b.images.$promise],successCallback:function(){a.imageUploadController(b,{modelKey:"newImage"});a.listController(b,{collectionKey:"images",modelKey:"newImage",create:c.item.images.create,params:function(){return{shortname:e.currentCompany.shortname,itemPk:b.item.pk}},successCallback:function(){b.imageUploadCtrl.image.submit();
l()},removeCallback:function(){l()},reorderCallback:function(){l()},defaultModel:{gallery:f.Image.CAROUSEL_GALLERY},sortable:!0})}})}]);h.controller("dashboard.items.item.ViatorSettingsCtrl",["$scope","controllers","db","navigation","require","urls",function(b,a,c,f,e,g){e.inScope(b,"item","dashboard.items.item.ViatorSettingsCtrl");return a.editController(b,{elementKey:"item",modelKey:"editableItem",update:c.item.viatorSettings.update,params:function(){return{shortname:b.item.company.shortname,itemPk:b.item.pk}},
editing:!0})}]);h.controller("dashboard.items.item.ViatorMappingsCtrl",["$scope","controllers","db","navigation","require","urls",function(b,a,c,f,e,g){e.inScope(b,"item","dashboard.items.item.ViatorMappingsCtrl");b.customerTypes=c.customerTypes({shortname:b.item.company.shortname});b.viatorMappings=c.item.viatorMappings({shortname:b.item.company.shortname,itemPk:b.item.pk});return a.dataController(b,{promises:[b.customerTypes.$promise,b.viatorMappings.$promise],successCallback:function(){a.listController(b,
{collectionKey:"viatorMappings",modelKey:"newViatorMapping",get:c.item.viatorMappings,params:function(){return{shortname:b.item.company.shortname,itemPk:b.item.pk}}})}})}]);h.controller("dashboard.items.item.ViatorMappingEditableCtrl",["$scope","controllers","db","navigation","require","urls",function(b,a,c,f,e,g){e.inScope(b,"customerTypes","dashboard.items.item.ViatorMappingEditableCtrl");e.inScope(b,"viatorMapping","dashboard.items.item.ViatorMappingEditableCtrl");e.inScope(b,"viatorMappings",
"dashboard.items.item.ViatorMappingEditableCtrl");var d="defaultCustomerType adultCustomerType childCustomerType youthCustomerType infantCustomerType seniorCustomerType".split(" ");return a.editController(b,{collectionKey:"viatorMappings",elementKey:"viatorMapping",modelKey:"editableViatorMapping",get:c.item.viatorMapping,params:function(){return{shortname:b.viatorMapping.company.shortname,itemPk:b.viatorMapping.item.pk,viatorMappingPk:b.viatorMapping.pk}},editCallback:function(){_.forEach(d,function(a){b.viatorMapping[a]&&
(b.editableViatorMapping[a]=b.viatorMapping[a].pk)})}})}]);h.controller("dashboard.items.item.ReviewExpressSettingsCtrl",["$scope","controllers","db","navigation","require","urls",function(b,a,c,f,e,g){e.inScope(b,"item","dashboard.items.item.ReviewExpressSettingsCtrl");var d=c.locations({shortname:b.item.company.shortname});b.reviewExpressLocations=[];return a.dataController(b,{promises:[d.$promise],successCallback:function(){b.reviewExpressLocations=_.filter(d,"isReviewExpressEnabled");b.defaultReviewExpressLocation=
b.reviewExpressLocations.length?d[0]:void 0;a.editController(b,{elementKey:"item",modelKey:"editableItem",update:c.item.reviewExpressSettings.update,editCallback:function(){b.item.reviewExpressLocation&&(b.editableItem.reviewExpressLocation=b.item.reviewExpressLocation.pk)},submitCallback:function(){b.editableItem.isCustomReviewExpressLocation||(b.editableItem.reviewExpressLocation="")},params:function(){return{shortname:b.item.company.shortname,itemPk:b.item.pk}},editing:!1})}})}]);h.controller("dashboard.items.item.PicthriveSettingsCtrl",
["$scope","controllers","db","events","require",function(b,a,c,f,e){e.inScope(b,"item","dashboard.items.item.PicthriveSettingsCtrl");return a.editController(b,{elementKey:"item",modelKey:"editableItem",update:c.item.picthriveSettings.update,params:function(){return{shortname:b.item.company.shortname,itemPk:b.item.pk}},successCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},editing:!0})}]);h.controller("dashboard.items.item.ItemChecklistCtrl",["$scope","auth","controllers",
"db","require",function(b,a,c,f,e){e.inScope(b,"item","dashboard.items.item.ItemChecklistCtrl");b.customerPrototypes=f.customerPrototypes({shortname:b.item.company.shortname,itemPk:b.item.pk});b.customCalendars=f.customCalendars({shortname:b.company.shortname});b.flowNodes=f.item.flowPages({shortname:b.item.company.shortname,itemPk:b.item.pk});var g=f.availabilities.futureCount({shortname:b.company.shortname,objectType:b.item.cls,objectPk:b.item.pk}),d=function(a){return _.filter(a,function(a){return a.settings&&
a.settings.items?a.settings.items[b.item.uri]:!1})};c.dataController(b,{promises:[b.customCalendars.$promise,b.customerPrototypes.$promise,b.flowNodes.$promise,g.$promise],successCallback:function(){b.customCalendarsForItem=d(b.customCalendars);b.customCalendarNamesForItems=_.pluck(b.customCalendarsForItem,"name");b.itemFlowNames=_.pluck(b.flowNodes,"name");b.futureAvailabilityCount=g.count}})}])})();angular.module("dashboard.flows",["dashboard.flows.controllers"]);
(function(){var h=angular.module("dashboard.flows.controllers",["dashboard.services"]);h.controller("dashboard.flows.IndexCtrl",["$scope","require",function(b,a){a.inScope(b,"company","dashboard.flows.IndexCtrl");b.rootFlowNodeTracker=_.tracker()}]);h.controller("dashboard.flows.RootFlowNodesCtrl",["$scope","controllers","db","require","navigation","urls",function(b,a,c,f,e,g){f.inScope(b,"company","dashboard.flows.RootFlowNodesCtrl");b.rootFlowNodes=c.flowNodes.root({shortname:b.company.shortname});
a.dataController(b,{promises:[b.rootFlowNodes.$promise],successCallback:function(){var d=b.rootFlowNodes[0];a.listController(b,{collectionKey:"rootFlowNodes",modelKey:"newFlowNode",create:c.flowNodes.root.create,params:{shortname:b.company.shortname},successCallback:function(a){e.navigate(a.$url(g.dashboard.settings.flows.flowNode.index))},sortable:!0,reorderConfirmWhen:function(a,b,c){return!b||a===d},reorderConfirm:T("Are you sure you want to replace your default booking flow?"),reorderCallback:function(){d=
b.rootFlowNodes[0]}})}})}]);h.controller("dashboard.flows.FlowCtrl",["$scope","$timeout","controllers","db","flows","models","require","navigation","urls","popovers",function(b,a,c,f,e,g,d,l,h,k){d.inScope(b,"company","dashboard.flows.FlowCtrl");e=l.pathStartsWith(h.dashboard.settings.flows.flowNode.index);b.flowNode=f.flowNode(e);b.previewCache={};b.previewCache[b.flowNode.uri]=b.flowNode;b.allItems=f.items({shortname:b.company.shortname});c.dataController(b,{promises:[b.flowNode.$promise,b.allItems.$promise],
successCallback:function(){b.flow=_.union(b.flowNode.breadcrumbs,[b.flowNode]);l.watch(b,function(){var a=l.pathStartsWith(h.dashboard.settings.flows.flowNode.index);a&&(a=_.int(a.flowNodePk),(a=_.find(b.flow,{pk:a}))?1<b.flow.length&&b.scrollToFlowPage(a):b.rootFlowNodeTracker.modified())})}});b.scrollToFlowPage=function(c){b.expandedFlowPages[c.pk]=!0;a(function(){$("html, body").stop().animate({scrollTop:$(".flow-node-preview-"+c.pk).offset().top-90},250)});return!1};b.flowPageNameModified=function(a){b.flowNodeModified(a);
a=_.indexOf(b.flow,a);0<=a&&_.forEach(b.flow.slice(a),b.flowNodeModified)};b.flowNodeTracker={};b.flowNodeModified=function(a){b.flowNodeTracker[a.pk]=b.flowNodeTracker[a.pk]||_.tracker();b.flowNodeTracker[a.pk].modified()};b.nestableItems=function(a){a=_.pluck(a.children,"item");return _.difference(b.allItems,a)};b.expandedFlowPages={};b.expandedFlowPages[e.flowNodePk]=!0;b.toggleFlowPage=function(a){b.expandedFlowPages[a.pk]=!b.expandedFlowPages[a.pk]};b.expandFlowPage=function(a){if(a&&a.type===
g.FlowNode.PAGE_TYPE){var c=_.indexOf(b.flow,a.parent);0<=c&&(b.flow=_.slice(b.flow,0,c+1));b.flow.push(a);c=a.$url(h.dashboard.settings.flows.flowNode.index);l.url!==c?l.redirect(c):b.scrollToFlowPage(a);k.closeAll()}};b.removeFromFlow=function(a){a=_.indexOf(b.flow,a);-1<a&&b.flow.splice(a);b.flow.length?l.redirect(_.last(b.flow).$url(h.dashboard.settings.flows.flowNode.index)):l.redirect(b.company.$url(h.dashboard.settings.flows.index))}}]);h.controller("dashboard.flows.FlowPagePreviewCtrl",["$scope",
"controllers","db","flows","models","require",function(b,a,c,f,e,g){g.inScope(b,"flowNode","dashboard.flows.FlowCtrl");g.inScope(b,"previewCache","dashboard.flows.FlowCtrl");b.flowPage=b.flowNode;b.previewCache[b.flowPage.uri]||(b.flowPage=c.flowNode({shortname:b.flowPage.company.shortname,flowNodePk:b.flowPage.pk}),b.previewCache[b.flowPage.uri]=b.flowPage);var d=function(){_.overwriteWithout(b.flowPage.emptyPageChildren,function(a){return a.item.isPrivate||a.item.isUnlisted})};a.dataController(b,
{promises:[b.flowPage.$promise],successCallback:function(){d();b.$watch("flowPage.children.length",function(a,e){!a&&e?c.flowNode({shortname:b.flowPage.company.shortname,flowNodePk:b.flowPage.pk}).$promise.then(d):b.flowPage.childrenCount=a})}});b.hideSibling=function(a){var c=_.indexOf(b.flow,b.flowPage);-1<c&&(c=b.flow[c+1],c!==a&&b.removeFromFlow(c))}}]);h.controller("dashboard.flows.FlowPageEditableCtrl",["$scope","controllers","dashboard.shared.duplicatingController","db","events","flash","models",
"navigation","require","urls",function(b,a,c,f,e,g,d,l,h,k){h.inScope(b,"flowNode","dashboard.flows.FlowPageEditableCtrl");h.inScope(b,"removeFromFlow","dashboard.flows.FlowPageEditableCtrl");var n=!1;a.editController(b,{elementKey:"flowNode",modelKey:"editableFlowNode",update:f.flowNode.update,remove:f.flowNode.remove,params:function(){return{shortname:b.flowNode.company.shortname,flowNodePk:b.flowNode.pk}},submitCallback:function(){b.editableFlowNode.parent=_.get(b.flowNode,"parent.pk",null);_.extendWithPrefix("properties-",
b.editableFlowNode,b.flowNode.properties);n=b.editableFlowNode.name!==b.flowNode.name||b.editableFlowNode.shortName!==b.flowNode.shortName},successCallback:function(){n?b.flowPageNameModified(b.flowNode):b.flowNodeModified(b.flowNode);e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){f.company({shortname:b.flowNode.company.shortname});b.removeFromFlow(b.flowNode);var a=b.flowNode.parent;a&&a.children&&_.ref.remove(a.children,b.flowNode);a&&e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},
editing:!0,skipResetAfterError:!0});c(b,{endpoint:f.flowNode.duplicate,params:{flowNodePk:b.flowNode.pk,shortname:b.flowNode.company.shortname},successCallback:function(a){g.success(interpolate(T("Duplicated %(flowName)s"),{flowName:b.flowNode.name}));l.navigate(a.$url(k.dashboard.settings.flows.flowNode.index))}})}]);h.controller("dashboard.flows.FlowPageAddChildrenCtrl",["$scope","controllers","db","events","models","navigation","require","toggles","urls",function(b,a,c,f,e,g,d,l,h){d.inScope(b,
"company","dashboard.flows.FlowPageAddChildrenCtrl");d.inScope(b,"flowPage","dashboard.flows.FlowPageAddChildrenCtrl");d.inScope(b,"nestableItems");g=e.FlowNode;b.currentOptions={};b.currentOptions.chooseExistingNode=!1;a.imageUploadController(b,{modelKey:"newFlowNode"});b.$watchCollection("flowPage.children",function(){b.itemChoices=b.nestableItems(b.flowPage)});var k={};k[g.ITEM_TYPE]=["items"];k[g.PAGE_TYPE]=["existingPage","name"];k[g.LINK_TYPE]=["externalUrl","imageUrl","properties-heading",
"properties-subheading"];b.TYPE_CHOICES=[[e.FlowNode.ITEM_TYPE,T("Items")],[e.FlowNode.PAGE_TYPE,T("Flow page")],[e.FlowNode.LINK_TYPE,T("External link")]];a.listController(b,{modelKey:"newFlowNode",collectionKey:"flowPage.children",create:c.flowNodes.multi,submitCallback:function(){b.imageUploadCtrl.image.cancelCrop();var a=_.clone(b.newFlowNode),c=_.flatten(_.values(_.omit(k,a.type)));_.forEach(c,function(b){a[b]=null});return a},params:function(){return{shortname:b.company.shortname,flowNodePk:b.flowPage.pk}},
successCallback:function(a){b.imageUploadCtrl.image.submit();b.newFlowNode.type===e.FlowNode.ITEM_TYPE&&l.closeAll();b.flowNodeModified(b.flowPage);f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},defaultModel:function(){return{type:b.newFlowNode&&b.newFlowNode.type||e.FlowNode.ITEM_TYPE,parent:b.flowPage.pk}}})}]);h.controller("dashboard.flows.RootFlowNodeDropdownCtrl",["$scope","db",function(b,a){b.$watchCollection("FlowNode.childPages(flowNode).length",function(){b.choosableRootFlowNodes=
[];var c=a.flowNodes.root({shortname:b.company.shortname});b.choosableRootFlowNodes.$promise=c.$promise.then(function(){_.ref.append(b.choosableRootFlowNodes,_.rest(c));_.ref.remove(b.choosableRootFlowNodes,b.flow[0])})})}]);h.controller("dashboard.flows.FlowPageReorderCtrl",["$scope","controllers","events","require",function(b,a,c,f){f.inScope(b,"flowPage","dashboard.flows.FlowPageReorderCtrl");f.inScope(b,"flowNodeModified","dashboard.flows.FlowPageReorderCtrl");a.reorderController(b,{collectionKey:"flowPage.children",
reorderCallback:function(a){a.$promise.then(function(){b.flowNodeModified(b.flowPage);c.broadcast("dashboard.shared.ActivitiesCtrl.refresh")})}})}]);h.controller("dashboard.flows.FlowNodeEditableCtrl",["$scope","db","events","models","require","controllers","popovers",function(b,a,c,f,e,g,d){e.inScope(b,"flowNode");e.inScope(b,"flowPage");e.inScope(b,"nestableItems");e.inScope(b,"removeFromFlow");b.currentOptions={};g.imageUploadController(b,{elementKey:"flowNode",modelKey:"editableFlowNode"});var l=
function(){b.flowNode.type==f.FlowNode.ITEM_TYPE&&(b.itemChoices=b.nestableItems(b.flowPage),b.itemChoices.unshift(b.flowNode.item))};l();var h={shortname:b.flowNode.company.shortname,flowNodePk:b.flowNode.pk};g.editController(b,{elementKey:"flowNode",modelKey:"editableFlowNode",update:a.flowNode.update,editCallback:function(){b.imageUploadCtrl.image.edit();b.editableFlowNode.item=_.get(b.flowNode,"item.pk",null);b.editableFlowNode.parent=_.get(b.flowNode,"parent.pk",null);_.extendWithPrefix("properties-",
b.editableFlowNode,b.flowNode.properties)},submitCallback:function(){b.imageUploadCtrl.image.cancelCrop()},params:h,successCallback:function(){l();b.imageUploadCtrl.image.submit();c.broadcast("dashboard.shared.ActivitiesCtrl.refresh");b.flowNodeModified(b.flowNode)},editing:!0});var k=function(){c.broadcast("dashboard.shared.ActivitiesCtrl.refresh");_.overwriteWithout(b.flowPage.children,b.flowNode);d.closeAll();b.flowNodeModified(b.flowPage)};b.removeFromParent=function(c){b.flowNode.type===f.FlowNode.PAGE_TYPE?
(b.editableFlowNode.parent=null,a.flowNode.update(h,b.editableFlowNode,c).$promise.then(function(){b.removeFromFlow(b.flowNode);k()})):a.flowNode.remove(h).$promise.then(k)}}])})();angular.module("dashboard.resources",["dashboard.resources.controllers"]);
(function(){var h=angular.module("dashboard.resources.controllers",[]);h.controller("dashboard.resources.IndexCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.resources.IndexCtrl");b.resources=c.resources({shortname:b.company.shortname});a.dataController(b,{promises:[b.resources.$promise],successCallback:function(){a.reorderController(b,{collectionKey:"resources",modelKey:"newResource",params:function(){return{shortname:b.company.shortname}}})}})}]);
h.controller("dashboard.resources.CreateResourceCtrl",["$scope","controllers","db","navigation","require","urls",function(b,a,c,f,e,g){e.inScope(b,"company","dashboard.resources.CreateResourceCtrl");return a.createController(b,{modelKey:"newResource",create:c.resources.create,params:function(){return{shortname:b.company.shortname}},defaultModel:{name:""},successCallback:function(a){c.company({shortname:b.company.shortname});f.navigate(a.$url(g.dashboard.resources.resource.settings))}})}]);h.controller("dashboard.resources.ResourceCtrl",
["$scope","controllers","db","require","events","flash",function(b,a,c,f,e,g){f.inScope(b,"company","dashboard.resources.ResourceCtrl");b.resource=c.resource({shortname:b.company.shortname,resourcePk:b.route.bindings.resourcePk});a.dataController(b,{promises:[b.resource.$promise],successCallback:function(){e.on(b,"dashboard.shared.ActivitiesCtrl.clearResourceOverridesByTag",function(a,f){c.resourceOverrides.byTag.clear({shortname:b.resource.company.shortname,resourcePk:b.resource.pk,tag:f.tag}).$promise.then(function(a){200===
a.status&&(a=a.data.count,0<a&&(e.broadcast("lib.shared.CalendarCtrl.refresh"),e.broadcast("dashboard.shared.ActivitiesCtrl.refresh"),g.success(b.$interpolate(interpolate(nT("Removed %(count)s override","Removed %(count)s overrides",a),{count:"[[ count ]]"})))))})})}})}]);h.controller("dashboard.resources.ResourceEditableCtrl",["$scope","controllers","db","events","navigation","models","require","urls",function(b,a,c,f,e,g,d,l){d.inScope(b,"resource","dashboard.resources.ResourceEditableCtrl");a.editController(b,
{elementKey:"resource",modelKey:"editableResource",update:c.resource.update,remove:c.resource.remove,params:function(){return{shortname:b.resource.company.shortname,resourcePk:b.resource.pk}},editCallback:function(){b.editableResource.resourceUseSettings=g.ResourceUse.OPTIONS_VALUES_KEYS_MAP[[b.editableResource.isSkipResourceUseCreation,b.editableResource.isIgnoreOveruse].join("-")]},successCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){c.company({shortname:b.company.shortname});
e.navigate(b.resource.company.$url(l.dashboard.resources.index))},editing:!0,skipResetAfterError:!0})}]);h.controller("dashboard.resources.RequirementGroupEditableCtrl",["$scope","controllers","db","dashboard.shared.duplicatingController","events","flash","navigation","require","urls",function(b,a,c,f,e,g,d,l,h){l.inScope(b,"requirementGroups","dashboard.resources.RequirementGroupEditableCtrl");l.inScope(b,"requirementGroup","dashboard.resources.RequirementGroupEditableCtrl");f(b,{endpoint:c.requirementGroup.duplicate,
params:{shortname:b.company.shortname,requirementGroupPk:b.requirementGroup.pk},successCallback:function(a){g.success(T("Duplicated resource requirements"));e.broadcast("dashboard.shared.RequirementGroupEditableCtrl.duplicated",{requirementGroup:a});e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");e.broadcast("pricing.ngPricing.refresh",{object:b.company});a.isItemLevel||d.navigate(a.$url(h.dashboard.settings.requirementGroups.requirementGroup));b.editCtrl.cancel()}});return a.editController(b,
{collectionKey:"requirementGroups",elementKey:"requirementGroup",modelKey:"editableRequirementGroup",update:c.requirementGroup.update,remove:c.requirementGroup.remove,params:function(){return{shortname:b.requirementGroup.company.shortname,requirementGroupPk:b.requirementGroup.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){g.success(interpolate(T("Deleted %(requirementGroupName)s"),{requirementGroupName:b.requirementGroup.shortName}));
b.requirementGroup.isItemLevel?d.navigate(b.requirementGroup.item.$url(h.dashboard.items.item.prices.resources)):d.navigate(b.requirementGroup.company.$url(h.dashboard.settings.requirementGroups.index))}})}]);h.controller("dashboard.resources.RequirementsCtrl",["$scope","controllers","db","events","models","require",function(b,a,c,f,e,g){g.inScope(b,"requirementGroup","dashboard.resources.RequirementsCtrl");b.requirementGroup.isItemLevel?g.inScope(b,"customerPrototypes","dashboard.resources.RequirementsCtrl"):
g.inScope(b,"customerTypes","dashboard.resources.RequirementsCtrl");b.$bind("requirements","requirementGroup.requirements");var d={isSplittable:!1,isAllCustomerPrototypesSelected:!0,isAllCustomerTypesSelected:!0,type:e.Requirement.CUSTOMERS_TYPE};b.requirementGroup.isItemLevel?(d.level="item",_.forEach(b.customerPrototypes,function(a){d["customerPrototype"+a.pk+"IsSelected"]=!1})):(d.level="company",_.forEach(b.customerTypes,function(a){d["customerType"+a.pk+"IsSelected"]=!1}));a.listController(b,
{collectionKey:"requirements",modelKey:"newRequirement",create:c.requirements.create,params:function(){return{shortname:b.requirementGroup.company.shortname,requirementGroupPk:b.requirementGroup.pk}},defaultModel:d,successCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}});b.$watch("newRequirement.isAllCustomerPrototypesSelected",function(a){a&&_.forEach(b.customerPrototypes,function(a){b.newRequirement["customerPrototype"+a.pk+"IsSelected"]=!1})});b.$watch("newRequirement.isAllCustomerTypesSelected",
function(a){a&&_.forEach(b.customerTypes,function(a){b.newRequirement["customerType"+a.pk+"IsSelected"]=!1})});b.$watch(function(){return _.any(_.map(b.customerPrototypes,function(a){return b.newRequirement["customerPrototype"+a.pk+"IsSelected"]||!1}))},function(a){b.newRequirement.isAllCustomerPrototypesSelected=!a});b.$watch(function(){return _.any(_.map(b.customerTypes,function(a){return b.newRequirement["customerType"+a.pk+"IsSelected"]||!1}))},function(a){b.newRequirement.isAllCustomerTypesSelected=
!a})}]);h.controller("dashboard.resources.RequirementEditableCtrl",["$scope","controllers","db","events","require",function(b,a,c,f,e){if(b.requirement.requirementGroup.isItemLevel){e.inScope(b,"customerPrototypes","dashboard.resources.resource.IndexCtrl");var g=function(){_.forEach(b.customerPrototypes,function(a){b.editableRequirement["customerPrototype"+a.pk+"IsSelected"]=!1});_.forEach(b.requirement.customerPrototypeRequirements,function(a){b.editableRequirement["customerPrototype"+a.customerPrototype.pk+
"IsSelected"]=!0});b.editableRequirement.isAllCustomerPrototypesSelected=!d()}}else e.inScope(b,"customerTypes","dashboard.resources.resource.IndexCtrl"),g=function(){_.forEach(b.customerTypes,function(a){b.editableRequirement["customerType"+a.pk+"IsSelected"]=!1});_.forEach(b.requirement.customerTypeRequirements,function(a){b.editableRequirement["customerType"+a.customerType.pk+"IsSelected"]=!0});b.editableRequirement.isAllCustomerTypesSelected=!l()};e.inScope(b,"requirement","dashboard.resources.resource.IndexCtrl");
var d=function(){return _.any(_.map(b.customerPrototypes,function(a){return b.editableRequirement["customerPrototype"+a.pk+"IsSelected"]||!1}))},l=function(){return _.any(_.map(b.customerTypes,function(a){return b.editableRequirement["customerType"+a.pk+"IsSelected"]||!1}))};b.editableRequirement={};a.editController(b,{collectionKey:"requirements",elementKey:"requirement",modelKey:"editableRequirement",update:c.requirement.update,remove:c.requirement.remove,params:function(){return{shortname:b.requirement.requirementGroup.company.shortname,
requirementGroupPk:b.requirement.requirementGroup.pk,requirementPk:b.requirement.pk}},editCallback:g,successCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}});b.$watch("editableRequirement.isAllCustomerPrototypesSelected",function(a){a&&_.forEach(b.customerPrototypes,function(a){b.editableRequirement["customerPrototype"+a.pk+"IsSelected"]=!1})});b.$watch(d,function(a){b.editableRequirement.isAllCustomerPrototypesSelected=
!a});b.$watch("editableRequirement.isAllCustomerTypesSelected",function(a){a&&_.forEach(b.customerTypes,function(a){b.editableRequirement["customerType"+a.pk+"IsSelected"]=!1})});b.$watch(l,function(a){b.editableRequirement.isAllCustomerTypesSelected=!a})}]);h.controller("dashboard.resources.ResourceRequirementsCtrl",["$scope","controllers","db","events","models","require",function(b,a,c,f,e,g){g.inScope(b,"resources","dashboard.resources.ResourceRequirementsCtrl");g.inScope(b,"requirement","dashboard.resources.ResourceRequirementsCtrl");
b.$bind("resourceRequirements","requirement.resourceRequirements");var d=e.ResourceUse.OPTIONS[0].key;b.resourceUseSettingsDisplayText=e.ResourceUse.OPTIONS_KEYS_DISPLAY_TEXT_MAP[d];a.listController(b,{collectionKey:"resourceRequirements",modelKey:"newResourceRequirement",create:c.resourceRequirements.create,params:function(){return{shortname:b.requirement.requirementGroup.company.shortname,requirementGroupPk:b.requirement.requirementGroup.pk,requirementPk:b.requirement.pk}},defaultModel:{useCount:1,
timing:e.ResourceRequirement.START_TIMING,startAtHours:0,endAtKind:e.ResourceRequirement.PADDING_END_AT_KIND,endAtHours:0,hours:0,isCustomGranularity:!1,granularity:e.Resource.NONE_GRANULARITY,isCustomResourceUseSettings:!1,resourceUseSettings:d},successCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},sortable:!0,company:b.requirement.requirementGroup.company});var l=function(){b.resource&&!b.newResourceRequirement.isCustomResourceUseSettings?(b.newResourceRequirement.resourceUseSettings=
b.resource.resourceUseSettings,b.resourceUseSettingsDisplayText=e.ResourceUse.OPTIONS_KEYS_DISPLAY_TEXT_MAP[b.newResourceRequirement.resourceUseSettings]):(b.newResourceRequirement.resourceUseSettings=d,b.resourceUseSettingsDisplayText=e.ResourceUse.OPTIONS_KEYS_DISPLAY_TEXT_MAP[d])};b.$watch("resource",function(){l()});b.$watch("newResourceRequirement.isCustomResourceUseSettings",function(a){l()});b.$watch("newResourceRequirement.isCustomGranularity",function(a){b.newResourceRequirement.granularity=
a?b.resource?b.resource.granularity:e.Resource.NONE_GRANULARITY:e.Resource.NONE_GRANULARITY})}]);h.controller("dashboard.resources.ResourceRequirementEditableCtrl",["$scope","controllers","db","events","models","require",function(b,a,c,f,e,g){g.inScope(b,"resources","dashboard.resources.ResourceRequirementEditableCtrl");g.inScope(b,"resourceRequirement","dashboard.resources.ResourceRequirementEditableCtrl");g.inScope(b,"resourceRequirements","dashboard.resources.ResourceRequirementEditableCtrl");
g=function(){if(e.ResourceUse.getUseSettings(b.resourceRequirement)){var a=e.ResourceUse.getDisplayText(b.resourceRequirement);b.resourceRequirement.resourceUseSettingsDisplayText=a.toLowerCase()}else b.resourceRequirement.resourceUseSettingsDisplayText=""};b.$watch("resourceRequirement.isSkipCreation",g);b.$watch("resourceRequirement.isIgnoreResourceOveruse",g);a.editController(b,{collectionKey:"resourceRequirements",elementKey:"resourceRequirement",modelKey:"editableResourceRequirement",update:c.resourceRequirement.update,
remove:c.resourceRequirement.remove,params:function(){return{shortname:b.resourceRequirement.requirement.requirementGroup.company.shortname,requirementGroupPk:b.resourceRequirement.requirement.requirementGroup.pk,requirementPk:b.resourceRequirement.requirement.pk,resourceRequirementPk:b.resourceRequirement.pk}},editCallback:function(a){(a=e.ResourceUse.getUseSettings(b.resourceRequirement))?(b.resourceUseSettingsDisplayText=e.ResourceUse.getDisplayText(b.resourceRequirement),b.editableResourceRequirement.isCustomResourceUseSettings=
!0):(b.resourceUseSettingsDisplayText=e.ResourceUse.getDisplayText(b.resourceRequirement.resource),a=e.ResourceUse.getUseSettings(b.resourceRequirement.resource));b.editableResourceRequirement.resourceUseSettings=a;b.editableResourceRequirement.resource=b.resourceRequirement.resource.pk;b.editableResourceRequirement.isCustomGranularity=!!b.resourceRequirement.granularity;b.editableResourceRequirement.granularity=b.resourceRequirement.granularity?b.resourceRequirement.granularity:b.resourceRequirement.resource.granularity},
successCallback:function(a,c,e){f.broadcast("pricing.ngPricing.refresh",{object:b.item});f.broadcast("dashboard.shared.ActivitiesCtrl.refresh");_.forEach(b.requirement.resourceRequirements,function(a,c){a===b.resourceRequirement&&(b.requirement.resourceRequirements[c]=e.newResourceRequirement)});b.resourceRequirement=e.newResourceRequirement}})}]);h.controller("dashboard.resources.ResourceUseEditableCtrl",["$scope","auth","controllers","db","events","require",function(b,a,c,f,e,g){g.inScope(b,"booking",
"dashboard.resources.ResourceUseEditableCtrl");g.inScope(b,"resourceUse","dashboard.resources.ResourceUseEditableCtrl");g.inScope(b,"resourceUses","dashboard.resources.ResourceUseEditableCtrl");b.resourceUse.booking=b.booking;b.canUpdateResourceUse=a.permissions.canUpdate(b.resourceUse);b.warnings=[];b.$watch("editableResourceUse.resourceRequirement",function(a){a&&(b.editableResourceUse.useCount=a!==b.resourceUse.resourceRequirement.pk?_.find(b.resourceRequirements,{pk:a}).useCount:b.resourceUse.useCount)});
c.editController(b,{collectionKey:"resourceUses",elementKey:"resourceUse",modelKey:"editableResourceUse",update:f.resourceUse.update,remove:f.resourceUse.remove,params:function(){return{shortname:b.booking.company.shortname,bookingUuid:b.booking.uuid,resourceUsePk:b.resourceUse.pk}},editCallback:function(){b.editableResourceUse.resourceRequirement=b.resourceUse.resourceRequirement.pk;b.resourceRequirements=f.resourceRequirements({shortname:b.resourceUse.company.shortname,itemPk:b.booking.item.pk,
requirementGroupPk:b.resourceUse.resourceRequirement.requirement.requirementGroup.pk,requirementPk:b.resourceUse.resourceRequirement.requirement.pk});b.resourceRequirements.$promise.then(function(){d()},function(){d()})},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");e.broadcast("lib.shared.CalendarCtrl.refresh");e.broadcast("manifest.IndexCtrl.reconstruct");e.broadcast("dashboard.resources.ResourceUseEditableCtrl.resourceUse.updated");b.warnings=[]},submitCallback:function(){b.editableResourceUse.ignoreWarnings=
b.warnings.length},errorCallback:function(a){b.warnings=a.data?a.data.warnings||[]:[]},removeCallback:function(){b.editCtrl.editing=!1;e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");e.broadcast("lib.shared.CalendarCtrl.refresh");e.broadcast("manifest.IndexCtrl.reconstruct");e.broadcast("dashboard.resources.ResourceUseEditableCtrl.resourceUse.updated")}});var d=function(){_.contains(b.resourceRequirements,b.resourceUse.resourceRequirement)||b.resourceRequirements.push(b.resourceUse.resourceRequirement)};
b.cancel=function(a){b.warnings.length?b.warnings.length=0:b.editCtrl.cancel(a)}}]);h.controller("dashboard.resources.ResourceItemsCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"resource","dashboard.resources.ResourceItemsCtrl");b.resourceItems=c.resource.items({shortname:b.resource.company.shortname,resourcePk:b.resource.pk});return a.dataController(b,{promises:[b.resourceItems.$promise]})}]);h.controller("dashboard.resources.uses.IndexCtrl",["$scope","db","require",
"urls","navigation",function(b,a,c,f,e){c.inScope(b,"resource","dashboard.resources.uses.IndexCtrl");a=moment();b.selectedDate={moment:a,formatted:a.format("YYYY-MM-DD")};b.selectDate=function(a){b.selectedDate.moment=a;b.selectedDate.formatted=a.format("YYYY-MM-DD")};e.watch(b,function(a){e.pathEquals(f.dashboard.resources.resource.uses.index)&&e.redirect(b.overviewUrl())});b.overviewUrl=function(){return f.populate(f.calendarUrls(f.dashboard.resources.resource.uses.overview).month,{shortname:b.resource.company.shortname,
resourcePk:b.resource.pk,year:b.selectedDate.moment.format("YYYY"),month:b.selectedDate.moment.format("MM")})};b.dayViewUrl=function(a){return f.populate(f.dashboard.resources.resource.uses.day,{shortname:b.resource.company.shortname,resourcePk:b.resource.pk,date:a?a.format("YYYY-MM-DD"):b.selectedDate.formatted})}}]);h.controller("dashboard.resources.uses.DayCtrl",["$scope","cache","controllers","db","navigation","require","urls",function(b,a,c,f,e,g,d){g.inScope(b,"company","dashboard.resources.UsesCtrl");
g.inScope(b,"resource","dashboard.resources.UsesCtrl");g.inScope(b,"selectDate","dashboard.resources.UsesCtrl");g.inScope(b,"selectedDate","dashboard.resources.UsesCtrl");b.status="loading";b.resourceUses=[];var l=function(){b.status="loading";b.resourceUses&&b.resourceUses.$promise&&b.resourceUses.$promise.cancel();b.resourceUses=f.resourceUses.byDate({shortname:b.resource.company.shortname,resourcePk:b.resource.pk,date:b.selectedDate.formatted});a.fresh(b.resourceUses)||(b.status="success");b.resourceUses.$promise.then(function(a){a!==
f.CANCELLED&&(b.status="success")},function(){b.status="error"})};e.watch(b,function(a){var c=e.pathEquals(d.dashboard.resources.resource.uses.day);if(c)a=moment(c.date),b.selectDate(a),l();else throw Error("dashboard.resources.uses.DayCtrl: invalid day url "+a);});var h=function(a){return d.populate(d.dashboard.resources.resource.uses.day,{shortname:b.resource.company.shortname,resourcePk:b.resource.pk,date:a.format("YYYY-MM-DD")})};b.nextDayUrl=function(){var a=b.selectedDate.moment.clone();a.add("days",
1);return h(a)};b.currentDayUrl=function(){return h(moment())};b.previousDayUrl=function(){var a=b.selectedDate.moment.clone();a.add("days",-1);return h(a)};b.$watch("selectedDate.formatted",function(a){a=moment(a,"YYYY-MM-DD");b.selectedDate.moment.diff(a)&&e.navigate(h(a))})}]);h.controller("dashboard.resources.uses.OverviewCtrl",["$scope","require","models",function(b,a,c){a.inScope(b,"resource","dashboard.resources.uses.OverviewCtrl");b.isCreatingOverrides=!1;b.resourceOverride=null;b.startCreatingRuleOnDay=
function(a){b.cancelEditingOverride();b.isCreatingOverrides=!0;b.creatingRuleAt=a.at};b.cancelCreatingRule=function(){b.isCreatingOverrides=!1};b.startEditingOverride=function(a){b.cancelCreatingRule();b.resourceOverride=a};b.cancelEditingOverride=function(){b.resourceOverride=null}}]);h.controller("dashboard.resources.CreateOverridesCtrl",["$scope","controllers","db","events","flash","models","require",function(b,a,c,f,e,g,d){d.inScope(b,"resource","dashboard.resources.CreateOverrideCtrl");d.inScope(b,
"creatingRuleAt","dashboard.resources.CreateOverrideCtrl");b.newRule={};b.$watch("creatingRuleAt",function(a){b.newRule.startOn=b.creatingRuleAt.format("YYYY-MM-DD")});b.overuses=[];b.cancelOveruses=function(){b.overuses=[]};a.createController(b,{modelKey:"newRule",create:c.resourceOverride.rule,submitCallback:function(){b.newRule.repeat===g.Rule.NO_REPEAT&&(b.newRule.endOn=null);b.newRule.allowOveruse=0<b.overuses.length;b.cancelOveruses()},successCallback:function(a){a.length?(f.broadcast("dashboard.shared.ActivitiesCtrl.refresh"),
f.broadcast("lib.shared.CalendarCtrl.refresh"),e.success(b.$interpolate(interpolate(nT("Created %(count)s resource override","Created %(count)s resource overrides",a.length),{count:a.length})))):e.warn(T("No overrides created"))},errorCallback:function(a){if((a=a.data&&a.data.resourceOveruses)&&a.length)b.overuses=a},params:{shortname:b.resource.company.shortname,resourcePk:b.resource.pk},reset:!1,defaultModel:_.extend(g.Rule.defaultRule(),{period:g.Rule.ALL_DAY_PERIOD,startOn:b.creatingRuleAt.format("YYYY-MM-DD"),
endOn:moment().endOf("year").format("YYYY-MM-DD"),maximumUseCount:""})})}]);h.controller("dashboard.resources.OverrideEditableCtrl",["$scope","controllers","db","events","flash","require",function(b,a,c,f,e,g){g.inScope(b,"resource","dashboard.resources.OverrideEditableCtrl");g.assert(!!b.resourceOverride,"dashboard.resources.OverrideEditableCtrl");g.inScope(b,"cancelEditingOverride","dashboard.resources.OverrideEditableCtrl");b.overuse=null;b.cancelOveruse=function(){b.overuse=null};a.editController(b,
{elementKey:"resourceOverride",modelKey:"editableOverride",update:c.resourceOverride.update,remove:c.resourceOverride.remove,cancelCallback:function(){b.cancelEditingOverride()},editCallback:function(){_.extend(b.editableOverride,{hours:_.round(b.resourceOverride.endAt.diff(b.resourceOverride.startAt,"h",!0),2),time:b.resourceOverride.startAt.format("HH:mm"),startDate:b.resourceOverride.startAt.format("YYYY-MM-DD"),endAt:null,startAt:null})},submitCallback:function(){b.editableOverride.allowOveruse=
!!b.overuse;b.cancelOveruse()},successCallback:function(a){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh");f.broadcast("lib.shared.CalendarCtrl.refresh");e.success(T("Updated resource override"))},errorCallback:function(a){if((a=a.data&&a.data.resourceOveruses)&&a.length)b.overuse=a[0]},removeCallback:function(a){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh");f.broadcast("lib.shared.CalendarCtrl.refresh");e.success(T("Removed resource override"));b.cancelEditingOverride()},params:{shortname:b.resource.company.shortname,
resourcePk:b.resource.pk,resourceOverridePk:b.resourceOverride.pk}});b.editCtrl.edit();a=function(){var a=b.editableOverride.hours,c=moment(b.editableOverride.startDate+" "+b.editableOverride.time,"YYYY-MM-DD HH:mm"),e=c.clone().startOf("day");b.endTime=c.clone().add("hours",a||0);b.days=b.endTime.diff(e,"days")};b.$watch("editableOverride.time",a);b.$watch("editableOverride.hours",a)}]);h.controller("dashboard.resources.uses.CalendarCtrl",["$scope","calendarController","db","events","require","urls",
function(b,a,c,f,e,g){e.inScope(b,"resource","dashboard.resources.uses.CalendarCtrl");e.inScope(b,"startCreatingRuleOnDay","dashboard.resources.uses.CalendarCtrl");e.inScope(b,"selectDate","dashboard.resources.UsesCtrl");f.on(b,"lib.shared.CalendarCtrl.month",function(a,c){b.selectDate(c.date)});f=b.resource.company;a(b,{company:f,url:b.resource.$url(g.dashboard.resources.resource.uses.overview),endpoint:c.resourceUses.calendar,params:{shortname:f.shortname,resourcePk:b.resource.pk},largeDaySelected:b.startCreatingRuleOnDay,
editDay:b.startCreatingRuleOnDay,isDayUsed:function(a){return 0<a.resourceUses.length}});b.dayUseCountSum=function(a){return _.sum(a.resourceUses,"useCount")}}])})();angular.module("dashboard.pricing",["dashboard.pricing.directives","dashboard.pricing.services"]);
(function(){var h=angular.module("dashboard.pricing.services",[]);h.factory("pricing",["models","urls",function(b,a){var c={};c[b.TotalSheet.cls]=a.dashboard.settings.pricing.totalSheet;c[b.InvoiceSheet.cls]=a.dashboard.settings.pricing.invoiceSheet;c[b.Item.cls]=a.dashboard.items.item.prices.index;c[b.CustomerPrototype.cls]=a.dashboard.items.item.prices.customerTypes;c[b.CustomFieldInstance.cls]=function(b){return b.customerPrototype?a.dashboard.items.item.prices.customerTypes:a.dashboard.items.item.prices.fieldGroups};
c[b.Requirement.cls]=a.dashboard.items.item.prices.resources;c[b.ResourceRequirement.cls]=a.dashboard.items.item.prices.resources;c[b.Availability.cls]=a.dashboard.overlay.availability.prices;c[b.CustomerTypeRate.cls]=a.dashboard.overlay.availability.prices;c[b.CustomField.cls]=a.dashboard.settings.customFields.customField;c[b.ExtendedOption.cls]=a.dashboard.settings.customFields.customField;c[b.ConnectedCampaign.cls]=a.dashboard.settings.customFields.customField;c[b.CustomerType.cls]=a.dashboard.settings.customerTypes.customerType;
var f={url:function(e,f){e.cls===b.Company.cls&&(e=f,f=null);var d=a.extract(e);f&&_.extend(d,a.extract(f));var l=c[e.cls];_.isFunction(l)&&(l=l(e));f&&(l+="?sheet-type="+f.cls+"&sheet="+f.pk);return a.populate(l,d)},needsVisibility:function(a){return a?a.cls===b.TotalSheet.cls:!1},pricingRequirements:function(a,c){if(!a||!c)return{isEditable:!1};var d=a.cls===b.CustomField.cls&&!b.CustomField.needsPricing(a),l=a.cls===b.CustomFieldInstance.cls&&!b.CustomField.needsPricing(a.customField);_.contains([b.Requirement.cls,
b.ResourceRequirement.cls],a.cls);var l=(d=!d&&!l&&_.contains([b.CustomerType.cls,b.CustomFieldInstance.cls,b.CustomerPrototype.cls,b.CustomerTypeRate.cls,b.CustomField.cls,b.ExtendedOption.cls,b.ConnectedCampaign.cls],a.cls))||_.contains([b.Item.cls,b.Availability.cls],a.cls),h=c.cls===b.InvoiceSheet.cls||b.Company.forObject(a).features.isTotalSheetDiscountsEnabled,k=l||a.cls===b.Company.cls,d={needsVisibility:f.needsVisibility(c)&&a.cls!==b.Company.cls,needsRequired:a.cls===b.CustomField.cls&&b.CustomField.needsRequired(a)||
a.cls===b.CustomFieldInstance.cls&&b.CustomField.needsRequired(a.customField),needsHidden:_.contains([b.CustomFieldInstance.cls,b.CustomField.cls,b.ExtendedOption.cls],a.cls),needsPrice:d,needsTaxes:k,needsSheetRate:l&&h},l=a;a.cls===b.CustomFieldInstance.cls&&(l=a.customField);d.needsEditableVisibility=a.cls!==b.ConnectedCampaign.cls&&a.cls!==b.ConnectedWaiver.cls&&a.cls!==b.Company.cls&&!(a.cls===b.CustomField.cls&&a.type===b.CustomField.WAIVER_TYPE);d.needsExtendedPrice=d.needsPrice&&_.contains([b.CustomField.cls,
b.ExtendedOption.cls,b.ConnectedCampaign.cls],l.cls);d.needsTaxableOnly=l.cls===b.CustomField.cls&&b.CustomField.pricedByValue(l);d.needsExtendedPrice=d.needsExtendedPrice&&!d.needsTaxableOnly;d.isPricedByOptions=l.cls===b.CustomField.cls&&b.CustomField.pricedByOptions(l);d.isCannotBePriced=!d.needsPrice&&l.cls===b.CustomField.cls;d.isEditable=d.needsVisibility||d.needsPrice||d.needsTaxes||d.needsSheetRate;return d}};return f}]);h.factory("pricingNavigation",[function(){var b={sheets:[],noneOneOrMulti:function(a,
c,f){var e=b.sheets.length;return e?1<e?f:c:a},reset:function(){_.clear(b.sheets)},selectSheet:function(a){_.overwrite(b.sheets,[a])},toggleSheet:function(a){b.isSelected(a)?1<b.sheets.length&&_.overwriteWithout(b.sheets,a):b.sheets.push(a)},isSelected:function(a){return _.contains(b.sheets,a)}};return b}]);h.factory("filterPricing",["models",function(b){var a="",c="",f="",e={items:null,containers:null,fields:null},g={},d=function(a){var b=[],c=[];return(a=_.trim(a||""))?(a=_.filter(_.map(a.split(" "),
_.trim)),_.forEach(a,function(a){var d=!1;"-"===a[0]&&(d=!0,a=a.substr(1));a=a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");d?c.push(a):b.push(a)}),b=b.length?RegExp(b.join("|"),"i"):null,c=c.length?RegExp(c.join("|"),"i"):null,{positive:b,negative:c}):null},l=function(){return!(!a&&!c&&!f&&!k.isHidingFields&&!k.isHidingResources)},h=function(a){if(a.cls===b.Item.cls)return e.items;if(a.cls===b.CustomerType.cls||a.cls===b.CustomerPrototype.cls||a.cls===b.CustomerTypeRate.cls)return e.containers;if(a.cls===
b.RequirementGroup.cls)return k.isHidingResources?e.never:e.containers;if(a.cls===b.CustomFieldInstanceGroup.cls)return k.isHidingFields?e.never:e.containers;if(a.cls===b.CustomFieldInstance.cls)return k.isHidingFields?e.never:e.fields},k={isSimplified:!1,simplify:function(){k.isSimplified=!k.isSimplified},isHidingHiddenObjects:!1,hideHiddenObjects:function(){k.isHidingHiddenObjects=!k.isHidingHiddenObjects},isHidingResources:!1,hideResources:function(){k.isHidingResources=!k.isHidingResources;g=
{}},isHidingFields:!1,hideFields:function(){k.isHidingFields=!k.isHidingFields;g={}},isFiltering:function(){return k.isHidingHiddenObjects||l()},filter:function(b){b=b||{};a=b.items||"";c=b.containers||"";f=b.fields||"";e.items=d(a);e.containers=d(c);e.fields=d(f);e.never={positive:null,negative:/./};g={}},isFiltered:function(a){var c=g[a.uri];if(!_.isUndefined(c))return c;c=!1;if(l()){var d;d=[];a.cls===b.Item.cls?(d.push(a.name),d.push(a.shortName)):a.cls===b.CustomerType.cls?(d.push(a.shortName),
d.push(a.singular),d.push(a.plural)):a.cls===b.CustomerPrototype.cls?(d.push(a.name),d.push(a.customerType.shortName),d.push(a.customerType.singular),d.push(a.customerType.plural)):a.cls===b.CustomerTypeRate.cls?(d.push(a.customerPrototype.name),d.push(a.customerPrototype.customerType.shortName),d.push(a.customerPrototype.customerType.singular),d.push(a.customerPrototype.customerType.plural)):a.cls===b.CustomFieldInstanceGroup.cls?d.push(a.name):a.cls===b.RequirementGroup.cls?d.push(a.shortName):
a.cls===b.CustomFieldInstance.cls&&(d.push(a.customField.title),d.push(a.customField.description),d.push(a.customField.shortDisplayType));d=d.join(" ");var e=h(a);e&&(c=e.positive&&!e.positive.test(d)||e.negative&&e.negative.test(d))}return g[a.uri]=c}};return k}]);h.run(["$rootScope","filterPricing","pricingNavigation",function(b,a,c){b.filterPricing=a;b.pricingNavigation=c}])})();
(function(){var h=angular.module("dashboard.pricing.directives",[]);h.directive("ngEffectiveVisibility",[function(){return{restrict:"A",templateUrl:"dashboard.pricing.effectiveVisibility",scope:!0,link:function(b,a,c){b.visibility=b.$eval(c.ngEffectiveVisibility);b.visibility||console.error("ng-effective-visibility: invalid visibility "+c.ngEffectiveVisibility)}}}]);h.directive("ngEffectiveSheetRate",[function(){return{restrict:"A",templateUrl:"dashboard.pricing.effectiveSheetRate",scope:!0,link:function(b,
a,c){b.sheetRate=b.$eval(c.ngEffectiveSheetRate);b.sheetRate||console.error("ng-effective-sheet-rate: invalid sheet rate "+c.ngEffectiveSheetRate)}}}]);h.directive("ngEffectivePrice",[function(){return{restrict:"A",templateUrl:"dashboard.pricing.effectivePrice",scope:!0,link:function(b,a,c){b.price=b.$eval(c.ngEffectivePrice);b.price||console.error("ng-effective-price: invalid price "+c.ngEffectivePrice)}}}]);h.directive("ngEffectiveTaxes",["require",function(b){return{restrict:"A",templateUrl:"dashboard.pricing.effectiveTaxes",
scope:!0,link:function(a,c,f){b.inScope(a,"company","ng-effective-taxes");b.inScope(a,"pricingCtrl","ng-effective-taxes");a.effectivePricing=a.$eval(f.ngEffectiveTaxes);a.effectivePricing||console.error("ng-effective-taxes: invalid pricing "+f.ngEffectiveTaxes)}}}]);h.directive("ngCostPreview",[function(){return{restrict:"A",templateUrl:"dashboard.pricing.costPreview",scope:!0,controllerAs:"costPreviewCtrl",controller:["$scope","$attrs",function(b,a){var c=this;c.cost=b.$eval(a.ngCostPreview);c.pricing=
b.$eval(a.ngCostPreviewPricing);c.isVerbose=b.isSet(a.ngCostPreviewVerbose);c.showTaxType=function(a){return!_.isUndefined(c.cost.taxByType[a.pk])}}]}}]);h.directive("ngPricing",["$q","$timeout","db","events","filterPricing","models","prices","pricing","pricingNavigation","require",function(b,a,c,f,e,g,d,l,h,k){return{restrict:"A",scope:!0,controller:["$scope","$attrs",function(k,s){var p=this;p.sheets=h.sheets;p.status="loading";p.taxTypes=c.taxTypes({shortname:k.company.shortname});var r=function(){p.status=
"loading";a(function(){p.status="success"})};p.isHiddenOrFiltered=function(a){return e.isHidingHiddenObjects&&!p.totalPricing(a).visibility.isVisible||e.isFiltered(a)?!0:!1};var t={},v=function(a){_.forEach(a,function(a){t[a.sheet.uri+":"+a.forObject.uri]=a});f.broadcast("pricing.ngPricing.updated",{ctrl:p})},y={};p.refresh=function(a,e){a=a||p.sheets;e=e||!1;if(!a.length||!p.object)console.warn("ng-pricing: attempting to refresh without sheet or object",a,p.object);else{var f=_.pluck(p.sheets,"uri");
y=_.pick(y,function(a,b){var c=a.object===p.object&&_.includes(f,b);!c&&a.$promise.cancel&&a.$promise.cancel();return c});e||(p.status="loading");var g=[];_.forEach(a,function(a){if(y[a.uri])g.push(y[a.uri].value);else{var b=d.pricing(p.object,a);g.push(b);y[a.uri]={object:p.object,value:b,$promise:b.$promise};b.$promise.finally(function(){y[a.uri]&&delete y[a.uri]})}});b.all(_.pluck(g,"$promise")).then(function(){_.forEach(g,function(a){a!==c.CANCELLED&&v(a)});r()},function(){p.status="error"})}};
p.cancel=function(){_.forEach(y,function(a){a.$promise.cancel&&a.$promise.cancel()})};p.updateObject=function(a){p.object=a;p.refresh()};k.$watchCollection("pricingNavigation.sheets",function(a,b){p.needsVisibilityColumn=_.any(p.sheets,l.needsVisibility);var c;c=g.Company.forObject(p.object).features.isTotalSheetDiscountsEnabled||_.any(p.sheets,g.PriceSheet.isInvoiceSheet);p.needsSheetRateColumn=c;p.needsVisAndSheetRateColumns=p.needsVisibilityColumn&&p.needsSheetRateColumn;a.length!==_.intersection(a,
b).length&&(c=_.difference(a,b),p.refresh(c))});p.effectivePricing=function(a,b){return!a||!a.uri||!b||!b.uri?(console.warn("ng-pricing: pricing: invalid object"),g.PriceLine.NONE_PRICING):t[b.uri+":"+a.uri]||g.PriceLine.NONE_PRICING};p.totalPricing=function(a){var b=p.sheets[0];return!a||!a.uri||!b||!b.uri?(console.warn("ng-pricing: total pricing: invalid object",a,p.sheets),g.PriceLine.NONE_PRICING):b.cls===g.TotalSheet.cls?p.effectivePricing(a,b):g.TotalLine.NONE_PRICING};p.updatePricing=function(a,
b,c){v(c);1===p.sheets.length||g.PriceSheet.isNonBase(b)?r():p.refresh(p.sheets,!0)}}],link:{pre:function(a,b,c,d){a.pricingCtrl=d},post:function(a,b,c){(b=a.$eval(c.ngPricing)||null)||console.warn("ng-pricing: invalid object",c.ngPricing);a.pricingCtrl.object=b;if(c=a.$eval(c.ngPricingSheet)||null)a.pricingCtrl.sheets=[c];a.pricingCtrl.refresh();f.on(a,"pricing.ngPricing.refresh",function(b,c){(_.isUndefined(c.object)||a.pricingCtrl.object===c.object)&&a.pricingCtrl.refresh()});a.$on("$destroy",
function(){a.pricingCtrl.cancel()})}}}}]);h.directive("ngPricingTools",["filterPricing",function(b){return{restrict:"A",templateUrl:"dashboard.pricing.tools",controller:["$scope","$attrs",function(a,b){var f=this;f.isFilteringItems=a.isSet(b.ngPricingToolsFilterItems);f.isFilteringFields=a.isSet(b.ngPricingToolsFilterFields);f.isHidingFields=a.isSet(b.ngPricingToolsHideFields);f.isHidingResources=a.isSet(b.ngPricingToolsHideResources);f.isSimplified=a.isSet(b.ngPricingToolsSimplify);f.reset=function(){f.pricingHideHiddenCtrl.reset();
f.pricingHideFieldsCtrl&&f.pricingHideFieldsCtrl.reset();f.pricingHideResourcesCtrl&&f.pricingHideResourcesCtrl.reset();f.pricingFilterCtrl.reset();f.pricingSimplifyCtrl&&f.pricingSimplifyCtrl.reset()}}],controllerAs:"pricingToolsCtrl"}}]);h.directive("ngPricingHideHidden",["filterPricing",function(b){return{restrict:"A",require:["^ngPricingTools","ngPricingHideHidden"],templateUrl:"dashboard.pricing.hideHidden",controller:["$scope",function(a){var c=this;c.reset=function(){b.isHidingHiddenObjects=
!1};a.$on("$destroy",function(){c.reset()})}],link:function(a,b,f,e){e[0].pricingHideHiddenCtrl=e[1]},controllerAs:"pricingHideHiddenCtrl"}}]);h.directive("ngPricingSimplify",["filterPricing",function(b){return{restrict:"A",require:["^ngPricingTools","ngPricingSimplify"],templateUrl:"dashboard.pricing.simplify",controller:["$scope","$attrs",function(a,c){var f=a.isSet(c.ngPricingSimplify);b.isSimplified=f;this.reset=function(){b.isSimplified=f};a.$on("$destroy",function(){b.isSimplified=!1})}],link:function(a,
b,f,e){e[0].pricingSimplifyCtrl=e[1]},controllerAs:"pricingSimplifyCtrl"}}]);h.directive("ngPricingHideFields",["filterPricing",function(b){return{restrict:"A",require:["^ngPricingTools","ngPricingHideFields"],templateUrl:"dashboard.pricing.hideFields",controller:["$scope","$attrs",function(a,c){var f=a.isSet(c.ngPricingHideFields);b.isHidingFields=f;this.reset=function(){b.isHidingFields=f};a.$on("$destroy",function(){b.isHidingFields=!1})}],link:function(a,b,f,e){e[0].pricingHideFieldsCtrl=e[1]},
controllerAs:"pricingHideFieldsCtrl"}}]);h.directive("ngPricingHideResources",["filterPricing",function(b){return{restrict:"A",require:["^ngPricingTools","ngPricingHideResources"],templateUrl:"dashboard.pricing.hideResources",controller:["$scope","$attrs",function(a,c){var f=a.isSet(c.ngPricingHideResources);b.isHidingResources=f;this.reset=function(){b.isHidingResources=f};a.$on("$destroy",function(){b.isHidingResources=!1})}],link:function(a,b,f,e){e[0].pricingHideResourcesCtrl=e[1]},controllerAs:"pricingHideResouresCtrl"}}]);
h.directive("ngPricingFilter",["filterPricing",function(b){return{restrict:"A",require:["^ngPricingTools","ngPricingFilter"],templateUrl:"dashboard.pricing.filter",controller:["$scope","$attrs",function(a,c){var f=this;f.isFilteringItems=a.isSet(c.ngPricingFilterItems);f.isFilteringFields=a.isSet(c.ngPricingFilterFields);f.spec={items:"",containers:"",fields:""};var e=function(c){a.$safeApply(function(){b.filter(c)})},g=_.debounce(e,250,{maxWait:1250});a.$watch("pricingFilterCtrl.spec",function(a){!a.items&&
!a.containers&&!a.fields?e(a):g(a)},!0);f.reset=function(){f.spec.items="";f.spec.containers="";f.spec.fields=""};a.$on("$destroy",function(){f.reset()})}],link:function(a,b,f,e){e[0].pricingFilterCtrl=e[1]},controllerAs:"pricingFilterCtrl"}}]);h.directive("ngPricingNavigation",["$q","db","events","models","navigation","pricingNavigation","toggles",function(b,a,c,f,e,g,d){return{restrict:"A",scope:!0,templateUrl:"dashboard.pricing.navigation",require:["ngPricingNavigation"],controller:function(){var c=
this;c.status="loading";c.company=null;c.sheets=[];g.reset();var h=e.get("sheet-type"),k=e.getPk("sheet");e.clear("sheet-type",!0);e.clear("sheet",!0);var n=function(){c.status="loading";var d=a.totalSheets({shortname:c.company.shortname}),e=a.invoiceSheets({shortname:c.company.shortname});b.all([d.$promise,e.$promise]).then(function(){c.totalSheets=f.TotalSheet.nonBaseSheets(d);c.totalSheets.base=f.TotalSheet.baseSheet(d);c.totalSheets.totalBase=f.TotalSheet.totalBaseSheet(d);c.invoiceSheets=f.InvoiceSheet.nonBaseSheets(e);
c.invoiceSheets.invoiceBase=f.InvoiceSheet.invoiceBaseSheet(e);c.sheets=c.company.affiliatesCount?_.append(d,e):d;var a;h&&k&&(a=_.find(c.sheets,function(a){return a.cls===h&&a.pk===k}));a||(a=c.totalSheets.base);g.selectSheet(a);c.status="success"},function(){c.sheets=[];c.status="error"})};c.updateCompany=function(a){c.company=a;n()};c.nextSheet=function(){var a=_.indexOf(c.sheets,g.sheets[0])+1;a>=c.sheets.length&&(a=0);c.selectSheet(c.sheets[a])};c.previousSheet=function(){var a=_.indexOf(c.sheets,
g.sheets[0])-1;0>a&&(a=c.sheets.length-1);c.selectSheet(c.sheets[a])};c.toggleSheet=function(a){g.toggleSheet(a)};c.selectSheet=function(a){g.selectSheet(a);d.toggle("sheetNav",!1)}},link:{pre:function(a,b,c,d){a.pricingNavigationCtrl=d[0]},post:function(a,b,c){a.pricingNavigationCtrl.updateCompany(a.$eval(c.ngPricingNavigation));a.$watch(function(){return{cls:e.get("sheet-type"),pk:e.get("sheet")}},function(b){var c=parseInt(b.pk,10);if(!b.cls||isNaN(c))e.clear("sheet-type",!0),e.clear("sheet",!0);
else{var d=_.find(a.pricingNavigationCtrl.sheets,function(a){return a.cls===b.cls&&a.pk===c});d&&g.selectSheet(d)}},!0);a.$on("$destroy",function(){g.reset()})}}}}]);h.directive("ngPricingEditors",[function(){return{restrict:"A",scope:!0,templateUrl:"dashboard.pricing.editors",controller:["$scope","$attrs",function(b,a){this.object=b.$eval(a.ngPricingEditors)}],controllerAs:"pricingEditorsCtrl"}}]);h.directive("ngPricingEditor",["costComputations","db","events","flash","models","prices","pricing",
"require",function(b,a,c,f,e,g,d,l){return{restrict:"A",scope:!0,templateUrl:"dashboard.pricing.editor",require:["^ngPricing","ngPricingEditor"],controller:["$scope","$attrs",function(l,k){var h=this;h.sheet=l.$eval(k.ngPricingEditorSheet);var s=function(){var a={};a.sheetRateType=h.effectivePricing.line?h.effectivePricing.line.sheetRateType:e.PriceLine.INHERIT_SHEET_RATE_TYPE;var b;h.sheet.cls===e.TotalSheet.cls?b=e.TotalSheet.displaySheetRate(h.effectivePricing.sheetRate.sheetRate):h.sheet.cls===
e.InvoiceSheet.cls&&(b=e.InvoiceSheet.displaySheetRate(h.effectivePricing.sheetRate.sheetRate,h.sheet.relationship));a.sheetRate=e.PriceSheet.sheetRateToModel(b);a.priceType=h.effectivePricing.line?h.effectivePricing.line.priceType:e.PriceLine.INHERIT_PRICE_TYPE;a.offset=h.effectivePricing.price.offset;a.taxInclusion=h.effectivePricing.line?h.effectivePricing.line.taxInclusion:e.PriceLine.INHERIT_TAX_INCLUSION;a.customTax=h.effectivePricing.price.customTax;h.requirements.needsExtendedPrice?(a.modifierType=
h.effectivePricing.price.modifierType,a.modifierKind=h.effectivePricing.price.modifierKind,a.rate=_.roundHalfToEven(100*h.effectivePricing.price.rate,7)):(a.modifierType=e.PriceLine.ADJUST_MODIFIER_TYPE,a.modifierKind=e.PriceLine.OFFSET_MODIFIER_KIND,a.rate=0);a.priceType===e.PriceLine.INHERIT_PRICE_TYPE&&a.modifierType===e.PriceLine.NONE_MODIFIER_TYPE&&(a.modifierType=e.PriceLine.ADJUST_MODIFIER_TYPE,a.modifierKind=e.PriceLine.OFFSET_MODIFIER_KIND,a.offset=0,a.rate=0);a.isTaxable=h.effectivePricing.line?
null===h.effectivePricing.line.isTaxable?e.PriceLine.INHERIT_IS_TAXABLE:h.effectivePricing.line.isTaxable:e.PriceLine.INHERIT_IS_TAXABLE;h.sheet.cls===e.TotalSheet.cls&&(a.visibility=h.effectivePricing.line?h.effectivePricing.line.visibility:e.TotalLine.INHERIT_VISIBILITY,a.isHiddenWhenBooking=h.effectivePricing.visibility.isHiddenWhenBooking,a.isHiddenOnReceipts=h.effectivePricing.visibility.isHiddenOnReceipts,a.isRequired=h.effectivePricing.visibility.isRequired);return a},p=function(){h.editableLine.taxTypes=
{};var a=h.effectivePricing.line,b=e.PriceLine.isCompanyBaseLine(h.object,h.sheet);_.forEach(h.pricingCtrl.taxTypes,function(c){var d;d=a&&_.isBoolean(a.taxTypes[c.pk])?a.taxTypes[c.pk]:b?e.PriceLine.OFF_IS_TAXABLE:e.PriceLine.INHERIT_IS_TAXABLE;h.editableLine.taxTypes[c.pk]=d})};h.editableLine=null;Object.defineProperty(h,"effectivePricing",{get:function(){return h.pricingCtrl.effectivePricing(h.object,h.sheet)},enumerable:!0,configurable:!0});var r={};Object.defineProperty(h,"requirements",{get:function(){return _.extend(r,
d.pricingRequirements(h.object,h.sheet))}});h.inspecting=!1;h.inspect=function(a){_.isUndefined(a)?h.inspecting=!h.inspecting:h.inspecting=a;return h.inspecting};h.editing=!1;h.edit=function(){h.editableLine=s();h.isEditingTaxInclusion=!1;h.isTaxableChoices=e.PriceLine.isTaxableChoices(h.object,h.sheet);h.pricingCtrl.taxTypes=a.taxTypes({shortname:h.sheet.company.shortname});h.pricingCtrl.taxTypes.$promise.then(p);h.editing=!0};h.open=function(){h.editing||h.edit()};h.cancel=function(){h.editing=
!1;h.inspecting=!1};h.reset=function(){h.editableLine=s()};h.object=null;h.updateObject=function(a){h.object=a};h.editTaxInclusion=function(a,b){b.$setDirty();var c=h.calculatedPrice.taxInclusion===e.PriceLine.INHERIT_TAX_INCLUSION?e.PriceLine.INCLUDED_TAX_INCLUSION:h.effectivePricing.price.taxInclusion;h.editableLine.taxInclusion=a?c:e.PriceLine.INHERIT_TAX_INCLUSION};h.submit=function(a){h.status="loading";var b=e.PriceSheet.sheetRateFromModel(h.editableLine.sheetRate);h.sheet.cls===e.TotalSheet.cls?
b=e.TotalSheet.fromDisplaySheetRate(b):h.sheet.cls===e.InvoiceSheet.cls&&(b=e.InvoiceSheet.fromDisplaySheetRate(b,h.sheet.relationship));var d=_.clone(h.editableLine.taxTypes);e.PriceLine.isTaxTypesAllowed(h.editableLine,h.object,h.sheet)||(d={});var b=_.extend({},h.editableLine,{sheetRate:e.PriceSheet.sheetRateToModel(b),taxTypes:d}),k=g.pricing.update(h.object,h.sheet,b,a);k.$promise.then(function(){a.$setPristine();h.inspecting=!1;h.editing=!1;h.status="success";h.pricingCtrl.updatePricing(h.object,
h.sheet,k);c.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},function(a){f.error(T("Error updating pricing"));h.status="success"})};h.calculatedVisibility=function(){if(h.sheet.cls===e.TotalLine.cls){var a=h.editableLine.visibility;return a===e.TotalLine.INHERIT_VISIBILLITY?h.effectivePricing.visibility.isVisible:a===e.TotalLine.VISIBLE_VISIBILITY}return!0};var t={};h.calculatedPrice=function(){var a=h.editableLine.offset,b=h.editableLine.rate/100,c=h.editableLine.modifierType,d=h.editableLine.modifierKind;
h.editableLine.priceType===e.PriceLine.INHERIT_PRICE_TYPE&&(a=h.effectivePricing.price.offset,b=h.effectivePricing.price.rate,c=h.effectivePricing.price.modifierType,d=h.effectivePricing.price.modifierKind);t.offset=a;t.rate=b;t.modifierType=c;t.modifierKind=d;t.taxability=h.editableLine.isTaxable?h.sheet.taxability:e.PriceSheet.NONE_TAXABILITY;t.taxInclusion=h.editableLine.taxInclusion===e.PriceLine.INHERIT_TAX_INCLUSION?h.effectivePricing.price.taxInclusion:h.editableLine.taxInclusion;t.customTax=
h.editableLine.customTax;return t};var v={};h.calculatedTaxes=function(){h.editableLine.isTaxable===e.PriceLine.ON_IS_TAXABLE?(v.taxability=h.sheet.taxability,v.ratesByType={},v.offsetsByType={},_.forEach(h.editableLine.taxTypes,function(a,b){if(a===e.PriceLine.ON_IS_TAXABLE){var c=_.findWhere(h.pricingCtrl.taxTypes,{pk:_.int(b)});c.type===e.TaxType.RATE_TYPE?v.ratesByType[b]=c.rate:v.offsetsByType[b]=c.offset}else if(a!==e.PriceLine.OFF_IS_TAXABLE){var c=h.effectivePricing.taxes.ratesByType[b],d=
h.effectivePricing.taxes.offsetsByType[b];_.isUndefined(c)||(v.ratesByType[b]=c);_.isUndefined(d)||(v.offsetsByType[b]=d)}})):h.editableLine.isTaxable===e.PriceLine.OFF_IS_TAXABLE?(v.taxability=e.PriceSheet.NONE_TAXABILITY,v.ratesByType={},v.offsetsByType={}):(v.taxability=h.effectivePricing.taxes.taxability,v.ratesByType=h.effectivePricing.taxes.ratesByType,v.offsetsByType=h.effectivePricing.taxes.offsetsByType);return v};var y={};h.calculatedSheetRate=function(){var a=h.editableLine.sheetRateType,
b=e.PriceSheet.sheetRateFromModel(h.editableLine.sheetRate);h.sheet.cls===e.TotalSheet.cls?b=e.TotalSheet.fromDisplaySheetRate(b):h.sheet.cls===e.InvoiceSheet.cls&&(b=e.InvoiceSheet.fromDisplaySheetRate(b,h.sheet.relationship));a===e.PriceLine.INHERIT_SHEET_RATE_TYPE&&(b=h.effectivePricing.sheetRate.sheetRate);y.sheetRate=b;return y};var q={};h.calculatedPricing=function(){return _.extend(q,{price:h.calculatedPrice(),taxes:h.calculatedTaxes(),sheetRate:h.calculatedSheetRate()})};var B={};h.costPreview=
function(a){return _.extend(B,b.costPreview(a))}}],link:{pre:function(a,b,c,d){a.pricingEditorCtrl=d[1]},post:function(a,b,d){(b=a.$eval(d.ngPricingEditor)||null)||console.warn("ng-pricing-editor: invalid object",d.ngPricingEditor);a.pricingEditorCtrl.pricingCtrl=a.pricingCtrl;a.pricingEditorCtrl.updateObject(b);a.modifierKindChoices=e.PriceLine.modifierKindChoices(b);c.on(a,"pricing.ngPricing.updated",function(b,c){c.ctrl===a.pricingCtrl&&a.pricingEditorCtrl.reset()});c.on(a,"pricing.ngPricing.open",
function(b,c){c.ctrl===a.pricingCtrl&&c.object===a.pricingEditorCtrl.object&&a.pricingEditorCtrl.open()})}}}}]);h.directive("ngPricingCurrentSheets",["pricingNavigation",function(b){return{restrict:"A",templateUrl:"dashboard.pricing.currentSheets",scope:!0,controller:function(){this.sheets=b.sheets},controllerAs:"pricingCurrentSheetsCtrl"}}]);h.directive("ngPricingInspector",["db","flash","models","prices","pricing","require",function(b,a,c,f,e,g){return{restrict:"A",scope:!0,templateUrl:"dashboard.pricing.inspector",
require:["^ngPricing","ngPricingInspector"],controller:["$scope","$attrs",function(a,g){var h=this;h.sheet=a.$eval(g.ngPricingInspectorSheet);h.status="loading";h.lines=[];h.object=null;h.updateObject=function(a){h.object=a;n()};h.url=function(a,b){return e.url(a,b)};var k,n=function(){if(!h.sheet||!h.object)console.warn("ng-pricing-inspector: attempting to refresh without sheet or object",h.sheet,h.object);else{k&&k.cancel&&k.cancel();k=null;h.status="loading";var a=f.pricing.stack(h.object,h.sheet);
k=a.$promise;k.then(function(d){d!==b.CANCELLED&&(h.lines=a,_.forEach(a,function(a){_.extend(a,e.pricingRequirements(a.object,a.sheet));a.sheetRateType!==c.PriceLine.INHERIT_SHEET_RATE_TYPE&&(h.sheet.relationship===c.InvoiceSheet.AFFILIATE_RELATIONSHIP&&a.sheet.relationship!==c.InvoiceSheet.AFFILIATE_RELATIONSHIP)&&(a.sheetRate=1-a.sheetRate)}),h.status="success")},function(){h.lines=[];h.status="error"})}}}],controllerAs:"pricingInspectorCtrl",link:function(a,b,c){b=a.$eval(c.ngPricingInspector);
g.assert(b,"ng-pricing-inspector: invalid object",c.ngPricingInspector);a.pricingInspectorCtrl.pricingCtrl=a.pricingCtrl;a.pricingInspectorCtrl.updateObject(b)}}}])})();angular.module("dashboard.reports",["dashboard.reports.controllers","dashboard.reports.advancedControllers","dashboard.reports.directives","dashboard.reports.services"]);
(function(){var h=angular.module("dashboard.reports.controllers",[]);h.controller("dashboard.reports.IndexCtrl",["$scope","$filter","$timeout","auth","controllers","db","events","flash","navigation","models","legacyReportDefinitions","legacyReportPermalink","reports","require","urls",function(b,a,c,f,e,g,d,h,m,k,n,s,p,r,t){r.notNull(m,"currentCompany","dashboard.reports.IndexCtrl");b.company=m.currentCompany;n.bookings.needsAffiliateFilter=b.company.isCharter;n.bookings.needsPartnerFilter=b.company.isAffiliate;
n["invoiceable-bookings"].needsAffiliateFilter=b.company.isCharter;n["items-summary"].needsPartner=b.company.isAffiliate;n["users-summary"].needsPartner=b.company.isAffiliate;n["customer-types-summary"].needsPartner=b.company.isAffiliate;var v="cancelledBookingsFilter dateType disputeStatusFilter textFilter transactionTagFilter userTypeFilter isDetailed includeDetailedContactInformation includePaymentSettings includeConnectedStatus includeBalances includePaymentsAndRefunds includeOnlineBookingReference includeCompaniesWithNoActivity".split(" ");
b.CHARTER_SOURCE="charter";b.AFFILIATE_SOURCE="affiliate";b.sourceOptions=[{value:b.CHARTER_SOURCE,name:b.company.name},{value:b.AFFILIATE_SOURCE,name:T("Partner companies")}];b.userTypeFilterOptions=[{value:k.Report.ORIGINAL_USER_TYPE_FILTER_OPTION,name:T("Orginally booked")},{value:k.Report.CURRENT_USER_TYPE_FILTER_OPTION,name:T("Was last to rebook")}];b.cancelledBookingsOptions=[{value:k.Report.NO_CANCELLED_BOOKINGS_FILTER_OPTION,name:T("No cancelled bookings")},{value:k.Report.NON_REFUNDED_CANCELLED_BOOKINGS_FILTER_OPTION,
name:T("Cancelled bookings with > 0 paid")},{value:k.Report.ALL_CANCELLED_BOOKINGS_FILTER_OPTION,name:T("All cancelled bookings")},{value:k.Report.ONLY_CANCELLED_BOOKINGS_FILTER_OPTION,name:T("Only cancelled bookings")}];b.hasFilters=function(a){return!a?!1:_.any([a.needsAffiliate,a.needsAffiliateFilter,a.needsPartner,a.needsPartnerFilter,a.needsCancelledBookingsFilter,a.needsCompanyFilter,a.needsCustomField,a.needsItemFilter,a.needsReferenceDate,a.needsTransactionTagFilter,a.needsSalespersonFilter,
a.needsUserFilter,a.needsUserTypeFilter,a.needsDisputeStatusFilter,a.needsCurrencyFilter])};b.hasOptions=function(a){return!a?!1:_.any([a.needsIsDetailed,a.needsIncludeDetailedContactInformation,a.needsIncludeCompaniesWithNoActivity,a.needsIncludeConnected,a.needsIncludePaymentSettings,a.needsIncludeBalances,a.needsIncludePaymentsAndRefunds])};b.makePermalink=s;b.status="initial";var y=k.Report.AVAILABILITY_DATE_TYPE,q=b.company.isCharter?b.CHARTER_SOURCE:b.AFFILIATE_SOURCE,B={read:function(a){return B[a.type]},
update:function(a,b){B[a.type]=_.extend({},b)}},u=function(a){var c=B.read(a);if(!_.isUndefined(c))return a.overrideOptions&&_.extend(c,a.overrideOptions()),c;var c={source:q},d=b.company.isCharter?k.Report.ALL_AFFILIATE_FILTER_OPTION:k.Report.DIRECT_AFFILIATE_FILTER_OPTION,e=b.company.isCharter?k.Report.DIRECT_PARTNER_FILTER_OPTION:k.Report.ALL_PARTNER_FILTER_OPTION,f=b.company.isCharter?k.Report.DIRECT_PARTNER_FILTER_OPTION:N.length?N[0].company.pk:"";a.needsAffiliateFilter&&(c.affiliateFilter=
d);a.needsPartnerFilter&&(c.partnerFilter=e);a.needsPartner&&(c.partnerFilter=f);a.defaultOptions&&_.extend(c,a.defaultOptions());return c};b.options={source:q,cancelledBookingsFilter:k.Report.NON_REFUNDED_CANCELLED_BOOKINGS_FILTER_OPTION,dateType:y,transactionTagFilter:k.Report.ALL_TRANSACTION_TAG_FILTER_OPTION,disputeStatusFilter:k.Report.ALL_DISPUTE_STATUS_FILTER_OPTION,currencyFilter:b.company.isAdmin?k.Report.ALL_CURRENCY_FILTER_OPTION:b.company.processorCurrency,affiliateFilter:k.Report.ALL_AFFILIATE_FILTER_OPTION,
partnerFilter:k.Report.DIRECT_PARTNER_FILTER_OPTION,salespersonFilter:k.Report.ALL_SALESPERSON_FILTER_OPTION,userFilter:k.Report.ALL_USER_FILTER_OPTION,userTypeFilter:k.Report.CURRENT_USER_TYPE_FILTER_OPTION,itemFilter:k.Report.ALL_ITEM_FILTER_OPTION,textFilter:"",isDetailed:!1};b.$watch("options.source",function(a){a===b.CHARTER_SOURCE?(a=k.Report.ALL_AFFILIATE_FILTER_OPTION,b.reportDefinition&&(b.reportDefinition.needsAffiliateFilter?a=k.Report.ALL_AFFILIATE_FILTER_OPTION:b.reportDefinition.needsAffiliate&&
(a=b.affiliateOptions[0].pk)),b.options.affiliateFilter=a,b.options.partnerFilter=k.Report.DIRECT_PARTNER_FILTER_OPTION):(a=k.Report.DIRECT_PARTNER_FILTER_OPTION,b.reportDefinition&&(b.reportDefinition.needsPartnerFilter?a=k.Report.ALL_PARTNER_FILTER_OPTION:b.reportDefinition.needsPartner&&(a=b.partnerOptions[0].pk)),b.options.partnerFilter=a,b.options.affiliateFilter=k.Report.DIRECT_AFFILIATE_FILTER_OPTION)});b.report=null;var z,C=function(){z&&z.cancel();z=null;b.report=null},F=function(a){r.assert(a,
"expected report");z=a.$promise;z.then(function(c){c===g.CANCELLED?b.status="success":(b.status="success",b.report=a,_.isUndefined(a.options.startAt)||(b.options.startDate=a.options.startAt.format("YYYY-MM-DD")),_.isUndefined(a.options.endAt)||(b.options.endDate=a.options.endAt.format("YYYY-MM-DD")),_.isUndefined(a.options.referenceAt)||(b.options.referenceDate=a.options.referenceAt.format("YYYY-MM-DD")),b.canViewAmounts=f.permissions.can("viewAmounts",a.company),b.isCharterPerspective=!0,a.options.affiliate?
b.options.affiliateFilter=a.options.affiliate.pk:a.options.affiliateFilter&&(b.options.affiliateFilter=_.isString(a.options.affiliateFilter)?a.options.affiliateFilter:a.options.affiliateFilter.pk),a.options.partner?(b.options.partnerFilter=a.options.partner.pk,b.canViewAmounts=f.permissions.can("viewAmounts",a.options.partner),b.isCharterPerspective=!1):a.options.partnerFilter&&(b.options.partnerFilter=_.isString(a.options.partnerFilter)?a.options.partnerFilter:a.options.partnerFilter.pk,b.canViewAmounts=
_.isString(a.options.partnerFilter)?a.options.partnerFilter===k.Report.DIRECT_PARTNER_FILTER_OPTION:f.permissions.can("viewAmounts",a.options.partnerFilter),b.isCharterPerspective=_.isString(a.options.partnerFilter)?a.options.partnerFilter===k.Report.DIRECT_PARTNER_FILTER_OPTION:!1),b.options.source=b.options.partnerFilter===k.Report.DIRECT_PARTNER_FILTER_OPTION?b.CHARTER_SOURCE:b.AFFILIATE_SOURCE,a.options.customField&&(b.options.customField=a.options.customField.pk),a.options.itemFilter&&(b.options.itemFilter=
_.isString(a.options.itemFilter)?a.options.itemFilter:a.options.itemFilter.pk),a.options.userFilter&&(b.options.userFilter=_.isString(a.options.userFilter)?a.options.userFilter:a.options.userFilter.pk),_.forEach(v,function(c){_.isUndefined(a.options[c])||(b.options[c]=a.options[c])}),w())},function(a){b.status="success";C();h.error(b.$interpolate(interpolate(T("Report failed %(message)s"),{message:'[[ message ? "(" + message + ")" : "" ]]'}),{message:a.data?a.data.errorMessage:null}))})},x=[1,1,1,
1,1,2,2,3,3,4,4,5,5,10,15,20,30],w=function(a){if(b.report){if(b.report.isInProgress){a=a||0;var d=a<x.length?x[a]:_.last(x),d=1E3*d,e=g.report({shortname:b.report.company.shortname,reportPk:b.report.pk});z=e.$promise;z.then(function(){e.isInProgress&&(z=c(_.bind(w,null,a+1),d,z),z.cancel=function(){c.cancel(z)})},function(a){b.status="success";C();h.error(b.$interpolate(interpolate(T("Report failed %(message)s"),{message:'[[ message ? "(" + message + ")" : "" ]]'}),{message:a.data.errorMessage}))})}}else console.warn("dashboard.reports.IndexCtrl: attempting to poll invalid report",
b.report)},G=function(){r.assert(b.reportDefinition,"expected report definition");C();b.status="generating";B.update(b.reportDefinition,b.options);var a=moment(b.options.startDate,"YYYY-MM-DD"),c=moment(b.options.endDate,"YYYY-MM-DD"),d=moment(b.options.referenceDate,"YYYY-MM-DD");a.isValid()||(a=moment());if(!c.isValid()||c.isBefore(a,"days"))c=a.clone();!d.isValid()||d.isBefore(a,"days")?d=a.clone():d.isAfter(c,"days")&&(d=c.clone());a={startDate:a.format("YYYY-MM-DD"),endDate:c.format("YYYY-MM-DD"),
referenceDate:d.format("YYYY-MM-DD"),dateType:b.options.dateType,cancelledBookingsFilter:b.options.cancelledBookingsFilter,includeDetailedContactInformation:b.options.includeDetailedContactInformation,includeCompaniesWithNoActivity:b.options.includeCompaniesWithNoActivity,includeBalances:b.options.includeBalances,includeConnected:b.options.includeConnected,includePaymentsAndRefunds:b.options.includePaymentsAndRefunds,includePaymentSettings:b.options.includePaymentSettings,includeOnlineBookingReference:b.options.includeOnlineBookingReference,
isDetailed:b.options.isDetailed,transactionTagFilter:b.options.transactionTagFilter,itemFilter:b.options.itemFilter,salespersonFilter:b.options.salespersonFilter,userFilter:b.options.userFilter,userTypeFilter:b.options.userTypeFilter,affiliateFilter:b.options.affiliateFilter,partnerFilter:b.options.partnerFilter,customField:b.options.customField,textFilter:b.options.textFilter,disputeStatusFilter:b.options.disputeStatusFilter,currencyFilter:b.options.currencyFilter};a=b.reportDefinition.endpoint({shortname:b.company.shortname},
null,null,a,{flashError:!1});F(a)},M=function(a){var c;if(c=a.needsDateType)c=b.options.dateType,c=c===k.Report.DISPUTE_DATE_TYPE&&!a.needsDisputeDateTypeOption?!1:c===k.Report.PAYMENT_DATE_TYPE&&!a.needsPaymentDateTypeOption?!1:!0,c=!c;c&&(b.options.dateType=y);_.extend(b.options,u(a))};b.reportDefinition=null;b.generate=function(){b.reportDefinition&&b.reportDefinition.endpoint&&(m.pathEquals(b.reportDefinition.urls.index||b.reportDefinition.urls)||m.navigate(t.populate(b.reportDefinition.urls.index,
{shortname:b.company.shortname})),G())};b.regenerate=function(){if(b.report){var a=g.report.rerun({shortname:b.report.company.shortname,reportPk:b.report.pk});F(a)}};b.cancel=function(a){a&&g.report.cancel({shortname:a.company.shortname,reportPk:a.pk}).$promise.then(function(){h.success(b.$interpolate(interpolate(T("Cancelled %(report)s report"),{report:"[[ report.displayType|lowercase ]]"}),{report:a}))},function(){h.error(b.$interpolate(interpolate(T("Unable to cancel %(report)s report"),{report:"[[ report.displayType|lowercase ]]"}),
{report:a}))})};b.exportFilename=function(){var a=b.company.shortname;b.report&&(a+="-"+b.report.type,b.reportDefinition.needsDateRange&&(a+="-from-"+b.report.options.startAt.format("YYYY-MM-DD"),a+="-to-"+b.report.options.endAt.format("YYYY-MM-DD")));return a+".csv"};a={label:T("All"),value:k.Report.ALL_TRANSACTION_TAG_FILTER_OPTION};b.transactionTagOptions=[a];_.forEach(k.Transaction.TAGS,function(a){b.transactionTagOptions.push({label:k.Transaction.displayTag(a),value:a})});a={label:T("All"),value:k.Report.ALL_DISPUTE_STATUS_FILTER_OPTION};
d={label:T("All closed"),value:k.Report.ALL_CLOSED_DISPUTE_STATUS_FILTER_OPTION};s={label:T("All open"),value:k.Report.ALL_OPEN_DISPUTE_STATUS_FILTER_OPTION};b.disputeStatusFilterOptions=[a,d,s];_.forEach(k.Dispute.STATUSES,function(a){b.disputeStatusFilterOptions.push({label:k.Dispute.displayStatus(a),value:a})});var K=_.compact(_.map(k.Company.getCurrencyChoices(),function(a){if(a.hasOwnProperty(0)&&a.hasOwnProperty(1))return{label:a[1],value:a[0]}}));K.unshift({label:T("All Currencies Converted to US Dollars"),
value:"all"});b.currencyFilterOptions=function(a){return a.isAdmin?K:[_.find(K,"value",a.processorCurrency)]};b.itemFilterOptions=[];var H=g.items.all({shortname:b.company.shortname});H.$promise.then(function(){_.ref.append(b.itemFilterOptions,H)});b.salespersonFilterOptions=[];a={name:T("Online customers"),pk:k.Report.ONLINE_USER_FILTER_OPTION};b.userFilterOptions=[a];var L=g.users.all({shortname:b.company.shortname});L.$promise.then(function(){_.ref.append(b.salespersonFilterOptions,L);_.ref.append(b.userFilterOptions,
L)});var E={name:T("No affiliates"),pk:k.Report.DIRECT_AFFILIATE_FILTER_OPTION};b.affiliateFilterOptions=[];b.affiliateFilterOptionsWithoutDirect=[];b.affiliateOptions=[];b.affiliateCompanies=[];b.affiliations=g.affiliates.pickable({shortname:b.company.shortname});b.affiliations.$promise.then(function(){b.affiliateCompanies=_.pluck(b.affiliations,"affiliateCompany");b.affiliateFilterOptions.push(E);_.ref.append(b.affiliateFilterOptions,b.affiliateCompanies);_.ref.append(b.affiliateFilterOptionsWithoutDirect,
b.affiliateCompanies);_.ref.append(b.affiliateOptions,b.affiliateCompanies)});b.partnerFilterOptions=[];b.partnerOptions=[];b.partnerCompanies=[];var N=g.partners({shortname:b.company.shortname});N.$promise.then(function(){b.partnerCompanies=_.pluck(N,"company");_.ref.append(b.partnerFilterOptions,b.partnerCompanies);_.ref.append(b.partnerOptions,b.partnerCompanies)});a=f.permissions.canList(k.Account,b.company);b.accounts=[];a&&(b.accounts=g.company.accounts({shortname:b.company.shortname}));var I=
[k.CustomField.EXTENDED_OPTION_TYPE,k.CustomField.SHORT_TYPE,k.CustomField.YES_NO_TYPE,k.CustomField.CODE_GENERATOR_TYPE,k.CustomField.COUNT_TYPE];b.customFields=[];var D=g.customFields.all({shortname:b.company.shortname});D.$promise.then(function(){var a=_.filter(D,function(a){return _.contains(I,a.type)});b.customFields=_.sortBy(a,function(a){return[a.isHidden,a.shortDisplayType,a.name.toLowerCase()]});b.customFields.length&&(a=_.first(b.customFields),b.options.currentCustomField=a,b.options.customField=
a.pk)});d=[];a&&d.push(b.accounts.$promise);b.company.isCharter&&(d.push(b.affiliations.$promise),d.push(D.$promise));b.company.isAffiliate&&d.push(N.$promise);e.dataController(b,{promises:d,successCallback:function(){m.watch(b,function(){var a,c=!1,d=_.find(n,function(b,d){r.assert(b.urls,"report urls for "+b.displayType);if(!b.urls.permalink)return!1;a=m.pathEquals(b.urls.permalink);return c=!!a});d||(d=_.find(n,function(a,b){var c=a.urls.index||a.urls;r.assert(_.isString(c),"expected index url for "+
a.displayType);return!!m.pathEquals(c)}));d?c?(b.status="generating",C(),b.reportDefinition=d,d=g.report({shortname:b.company.shortname,reportPk:a.reportPk}),d.permalink=m.path,F(d)):b.reportDefinition!==d&&(d.endpoint?(M(d),b.reportDefinition=d,G()):(C(),b.reportDefinition=d)):(console.warn("unknown report view",m.path),C())},"path")}})}]);h.controller("dashboard.reports.OverviewCtrl",["$scope","auth","controllers","db","models","legacyReportDefinitions","legacyReportPermalink",function(b,a,c,f,
e,g,d){b.dailyVolumeOverview=f.reports.dailyVolumeOverview({shortname:b.company.shortname});b.paymentOverview=f.reports.paymentOverview({shortname:b.company.shortname});b.itemSummaries=f.reports.itemsSummaryOverview({shortname:b.company.shortname});b.nextPayoutOverview=f.reports.nextPayoutOverview({shortname:b.company.shortname});b.recentReports=f.reports.recent({shortname:b.company.shortname});b.inProgressReports=f.reports.inProgress({shortname:b.company.shortname});b.makePermalink=function(a){return a.type===
e.Report.ADVANCED_TYPE?a.$url():d(a)}}]);h.controller("dashboard.reports.BookingsCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.reports.BookingsCtrl");b.company.partners=c.partners({shortname:b.company.shortname});return a.dataController(b,{promises:[b.company.partners.$promise]})}]);h.controller("dashboard.reports.BookingsReportCtrl",["$scope","$filter","auth","controllers","db","models","navigation","reports","require","urls",function(b,a,c,f,e,g,
d,h,m,k){b.exportToFile=function(){var c=b.report.options.isDetailed,d=b.report.options.partnerFilter!==g.Report.DIRECT_PARTNER_FILTER_OPTION,e=h.formatAmount,f={},k={},m={},y=function(a){_.forEach(a,function(a){a=a.customField;a.isDisplayOnly||(k[a.uri]=a)})},q=function(a){_.forEach(a,function(a){var b=a.customField;if(b.isExtendedOptionType){var c=_.find(b.hiddenExtendedOptions,function(b){return b.pk===a.value});c&&(m[b.uri]||(m[b.uri]={}),m[b.uri][c.uri]=c)}})};_.forEach(b.subreports,function(a){_.forEach(a.bookings,
function(a){_.forEach(a.customers,function(a){var b=a.customerTypeRate.customerPrototype.customerType;f[b.uri]=b;c&&(y(a.customFieldValues),q(a.customFieldValues))});c&&(y(a.customFieldValues),q(a.customFieldValues))})});var B=[];d&&B.push(T("Company"));B=B.concat([cT('"ID" is abbreviation of "Identifier"',"Booking ID"),T("Cancelled?"),T("Created At"),T("Last Rebooked At"),T("Originally Booked By"),T("Item"),T("Availability"),T("Name"),T("Phone"),T("Email"),T("Subscribed to Email?"),T("Booking Notes")]);
c&&B.push(T("Billing ZIP codes"));var B=B.concat([T("Pax"),T("# of Pax"),T("Online Booking Reference")]),B=B.concat([T("Subtotal"),T("Tax"),T("Booking Total"),T("Revenue")]),B=B.concat([T("Affiliate"),T("Voucher"),T("Agent"),T("Desk")]),B=B.concat([T("Affiliate %"),T("Invoice Amount"),T("Collected by Affiliate"),T("Receivable from Affiliate"),T("Payable to Affiliate")]),u={},z=function(a,b){if(_.isUndefined(a))return console.error("dashboard.reports.BookingsReportCtrl: undefined instance"),"";if(a.cls===
g.CustomerType.cls)return a.uri;if(a.cls===g.CustomerTypeRate.cls)return z(a.customerPrototype.customerType);if(a.cls===g.CustomField.cls){var c=a;if(c.isExtendedOptionType){if(_.isUndefined(b))throw"undefined value";return c.uri+"-"+b}return c.uri}if(a.cls===g.BookingCustomFieldValue.cls||a.cls===g.CustomerCustomFieldValue.cls)return c=a.customField,c.isExtendedOptionType?z(c,a.value):c.uri;console.error("dashboard.reports.BookingsReportCtrl: unexpected instance",a);return""},C=function(a,b){var c=
z(a,b);return u[c]},F=function(a,b,c){if(_.isUndefined(a))throw"undefined index";b=z(b,c);u[b]=a},x=B.length;_.forEach(f,function(a){B[x]=a.plural+" (#"+a.pk+")";F(x,a);x+=1});c&&(x=B.length,_.forEach(k,function(b){var c=(b.shortName||b.name)+" (#"+b.pk+")";if(b.isExtendedOptionType){var d=b.extendedOptions,d=d.concat(_.values(m[b.uri]));_.forEach(d,function(d){var e=c+": "+(d.shortName||d.name);if(!_.isUndefined(d.offset))var f=a("amount")(d.offset,b),e=e+(" ("+f+")");B[x]=e;F(x,b,d.pk);x+=1})}else B[x]=
c,F(x,b),x+=1}));var w=function(a,b){_.forEach(b,function(b){var c=b.customField,d=b.value;c.isExtendedOptionType?(b=C(c,d),_.isUndefined(b)||(a[b]=(a[b]||0)+1)):g.CustomField.usesCheckbox(c)?(b=C(c),!_.isUndefined(b)&&d&&(a[b]=(a[b]||0)+1)):(d=b.displayValue,b=C(c),!_.isUndefined(b)&&""!==d&&(a[b]=(a[b]||"")+d+", "))})},G=[B];_.forEach(b.subreports,function(f){_.forEach(f.bookings,function(k){var h=k.isCancelled?T("Cancelled"):T("No"),l=k.rebookedFrom?a("datetime")(k.createdAt):"",m=a("datetime")(k.originalCreatedAt),
q=k.originalUser,q=!q?T("Online"):q.name,r=k.onlineBookingReference||"",t=k.contact.isSubscribed?T("Subscribed"):T("No"),v=_.choose(k.payments,function(a){return a.postalCode||void 0}).join(", ");v&&(v="ZIP: "+v);var u=k.availability,u=a("datetimeRange")(u.startAt,u.endAt),y=(k.affiliation?k.affiliation.affiliateCompany:"").name||"",x=k.voucherNumber||"",z=k.agent?k.agent.name:"",F=k.desk?k.desk.name:"",ja=k.isUnprocessed?"("+T("Updating")+")":e(k.costs.totalCost.price,k),ba=k.isUnprocessed?"("+T("Updating")+
")":e(k.costs.totalCost.tax,k);k.affiliation&&!k.invoiceSheet&&T("Processing");var S=[];d&&S.push(k.company.name);S=S.concat(["#"+k.pk,h,m,l,q,k.item.shortName?k.item.shortName:k.item.name,u,k.contact.name,k.contact.phone,k.contact.email,t,k.note]);c&&S.push(v);S=S.concat([k.customerBreakdownShort,k.customerCount,r]);S=f.canViewAmounts?S.concat([ja,ba,e(k.costs.totalCost.total,k),b.isCharterPerspective?e(k.receiptCollectedByCharter.gross,k):e(k.receiptCollectedByAffiliate.gross,k)]):S.concat(["",
"","",""]);S=S.concat([y,x,z,F]);f.canViewAmounts?(h="",k.affiliation&&(h=k.invoiceSheet?a("percentage")(g.InvoiceSheet.displaySheetRate(k.invoiceSheet.sheetRate,k.invoiceSheet.relationship),"hideplus"):"("+T("Processing")+")"),S=S.concat([h,e(k.costs.invoiceCost.total,k),b.isCharterPerspective?e(k.receiptCollectedByAffiliate.gross,k):e(k.receiptCollectedByCharter.cgross,k),e(k.invoiceableToCharter,k),e(k.invoiceableToAffiliate,k)])):S=S.concat("     ".split(" "));_.forEach(k.customers,function(a){var b=
C(a.customerTypeRate.customerPrototype.customerType);_.isUndefined(b)||(S[b]=(S[b]||0)+1);c&&w(S,a.customFieldValues)});c&&w(S,k.customFieldValues);_.forEach(_.range(B.length),function(a){_.isUndefined(S[a])&&(S[a]="")});G.push(S)})});return G};h.reportController(b,{process:function(a){b.toggleAvailabilityBreakdown=function(a){a.isFullAvailabilityBreakdown=!a.isFullAvailabilityBreakdown;var b=a.availabilityBreakdownPartial;a.isFullAvailabilityBreakdown&&(b=a.availabilityBreakdownFull);a.availabilityBreakdownValues=
b};b.isAvailabilityBreakdownExpandable=function(a){return 5<a.availabilityBreakdownFull.length};var d=function(a,b){var c=b.originalUser,d=c?c.uri:"online",e=a.userBreakdown[d];e||(e={user:c,count:0},a.userBreakdown[d]=e);e.count+=1},e=function(a,b){var c=b.item,d=a.itemBreakdown[c.uri];d||(d={item:c,count:0},a.itemBreakdown[c.uri]=d);d.count+=1},f=function(a,b){var c=b.availability,d=a.availabilityBreakdown[c.uri];d||(d={availability:c,count:0},a.availabilityBreakdown[c.uri]=d);d.count+=1};b.invoiceableToCharterMessage=
b.report.options.partnerFilter===g.Report.DIRECT_PARTNER_FILTER_OPTION?T("You are owed"):T("You owe");b.invoiceableToAffiliateMessage=b.report.options.affiliateFilter===g.Report.DIRECT_AFFILIATE_FILTER_OPTION?T("You owe"):T("You are owed");b.aggregate={};b.aggregate.customerCount=0;b.aggregate.price=0;b.aggregate.tax=0;b.aggregate.total=0;b.aggregate.invoiceableToCharter=0;b.aggregate.invoiceableToAffiliate=0;b.aggregate.netCharterRevenue=0;b.aggregate.userBreakdown={};b.aggregate.customerBreakdown=
{};b.aggregate.itemBreakdown={};b.aggregate.availabilityBreakdown={};a=a.data.bookings;b.report.options.user&&(a=b.report.options.user===g.Report.ALL_USER_FILTER_OPTION?_.filter(a,function(a){return!a.originalUser}):_.filter(a,function(a){return a.originalUser===b.report.options.user}));b.report.options.partner&&(a=_.filter(a,function(a){return a.affiliation&&a.affiliation.company===b.report.options.partner}));var k={};_.forEach(a,function(a){b.aggregate.price+=a.costs.totalCost.price||0;b.aggregate.tax+=
a.costs.totalCost.tax;b.aggregate.total+=a.costs.totalCost.total;b.aggregate.invoiceableToCharter+=a.invoiceableToCharter;b.aggregate.invoiceableToAffiliate+=a.invoiceableToAffiliate;b.aggregate.netCharterRevenue+=a.netCharterRevenue;b.aggregate.customerCount+=a.customerCount;b.aggregate.grossCollectedByCharter+=a.receiptCollectedByCharter.gross;b.aggregate.grossCollectedByAffiliate+=a.receiptCollectedByAffiliate.gross;d(b.aggregate,a);e(b.aggregate,a);f(b.aggregate,a);var h;h=b.report.options.partnerFilter!==
g.Report.DIRECT_PARTNER_FILTER_OPTION?a.affiliation.company:a.affiliation?a.affiliation.affiliateCompany:a.company;var l=h===b.company,m=!a.originalUser,n=h.uri+(m?"online/":""),z=k[n];z||(z={userBreakdown:{},customerCount:0,customerBreakdown:{},itemBreakdown:{},availabilityBreakdown:{},isFullAvailabilityBreakdown:!1,price:0,tax:0,total:0,invoiceableToCharter:0,invoiceableToAffiliate:0,netCharterRevenue:0,company:h,bookings:[],canViewAmounts:c.permissions.can("viewAmounts",a.company),currency:a.company.processorCurrency},
k[n]=z);z.isCurrentCompany=l;z.isBookedOnline=m;z.customerCount+=a.customerCount;d(z,a);e(z,a);f(z,a);z.price+=a.costs.totalCost.price||0;z.tax+=a.costs.totalCost.tax;z.total+=a.costs.totalCost.total;z.invoiceableToCharter+=a.invoiceableToCharter;z.invoiceableToAffiliate+=a.invoiceableToAffiliate;z.netCharterRevenue+=a.netCharterRevenue;z.bookings.push(a)});_.forEach(_.values(k),function(a){a.availabilityBreakdownFull=_.values(a.availabilityBreakdown);a.availabilityBreakdownPartial=_.first(a.availabilityBreakdownFull,
5);a.availabilityBreakdownValues=a.availabilityBreakdownPartial});b.subreports=_.sortBy(_.values(k),function(a){return a.isCurrentCompany?"1":a.isBookedOnline?"2":"3"+a.company.name})}})}]);h.controller("dashboard.reports.InvoicesReportCtrl",["$scope","reports","urls",function(b,a,c){a.reportController(b,{process:function(a){var e=[],g=[],d=[],h=[];_.forEach(a.data.invoices,function(a){var c=null!==a.invoicedToCharter;b.company!==a.company?c?g.push(a):h.push(a):c?d.push(a):e.push(a)});a=function(a){return _.groupBy(a,
function(a){return a.company.processorCurrency})};b.payableInvoices={invoices:a(e),partnerInvoices:a(g),invoiceCount:e.length+g.length};b.receivableInvoices={invoices:a(d),partnerInvoices:a(h),invoiceCount:d.length+h.length};b.invoicesUrl=function(a){return c.populate(c.dashboard.reports.invoices.invoice.multi,{shortname:b.company.shortname,invoicePks:_.pluck(a,"pk").join(",")})}}})}]);h.controller("dashboard.reports.InvoiceableBookingsReportCtrl",["$scope","$filter","controllers","db","flash","models",
"navigation","reports","require","urls",function(b,a,c,f,e,g,d,h,m,k){m.inScope(b,"affiliations","dashboard.reports.InvoiceableBookingsReportCtrl");h.reportController(b,{process:function(h){b.generateForAffiliateCompany=function(a){b.options.affiliateFilter=a.pk;b.generate()};b.generateForAllAffiliateCompanies=function(){b.options.affiliateFilter=g.Report.ALL_AFFILIATE_FILTER_OPTION;b.generate()};b.isOverview=h.options.affiliateFilter===g.Report.ALL_AFFILIATE_FILTER_OPTION;b.isDirect=h.options.affiliateFilter===
g.Report.DIRECT_AFFILIATE_FILTER_OPTION;if(b.isOverview){var l=h.data.aggregates;b.rows=_.map(h.data.affiliateCompanies,function(a){var b=l[a.uri];b.affiliateCompany=a;return b})}else{var m={isExplicitOffset:!1,isExplicitOffsetDirectionInverted:!1,affiliation:null,dueOn:moment().add(1,"month").subtract(1,"day").format("YYYY-MM-DD"),explicitIdentifier:"",explicitTotal:"",date:moment()};b.selectRows=function(a){var b=!_.every(a,"isSelected");_.forEach(a,function(a){a.isSelected=b})};b.selectedRows=
function(a){a=a||b.rows;return _.filter(a,function(a){return a.isSelected})};b.createdAt=moment();b.affiliation=h.data.affiliation;var r=_.filter(h.data.bookings,function(a){return a.isInvoiceable});b.rows=[];_.forEach(r,function(a){m["booking-"+a.pk+"-offset"]=a.invoiceableToCharter-a.invoiceableToAffiliate;b.rows.push({booking:a,earnedByAffiliate:a.receiptCollectedByAffiliate.gross+a.invoicedToAffiliate,earnedByCharter:a.receiptCollectedByCharter.gross+a.invoicedToCharter,isSelected:!0})});b.$watch(function(){return _.pluck(b.rows,
"isSelected")},function(){b.aggregateInvoiceable=a("summary")(_.pluck(b.selectedRows(),"booking"),"invoiceable")},!0);b.aggregateInvoiceable=0;var t=function(a){b.due=Math.abs(a);b.isExplicitTotal&&(b.due=b.newInvoice.explicitTotal);b.isInvoicedToCharter=g.Invoice.isInvoicedToCharter(a,b.affiliation);b.isExplicitTotal&&b.isExplicitTotalDirectionInverted&&(b.isInvoicedToCharter=!b.isInvoicedToCharter)};b.$watch("newInvoice.explicitTotal",function(){t(b.aggregateInvoiceable)});b.$watch("isExplicitTotal",
function(){t(b.aggregateInvoiceable)});b.$watch("isExplicitTotalDirectionInverted",function(){t(b.aggregateInvoiceable)});b.$watch("aggregateInvoiceable",function(a){t(a)});b.$watch("isInvoicedToCharter",function(a){a?(b.billedToCompany=b.affiliation.affiliateCompany||null,b.remitToCompany=h.company):(b.billedToCompany=h.company,b.remitToCompany=b.affiliation?b.affiliation.affiliateCompany:null);b.isOverview||_.forEach(b.rows,function(b){var c=b.booking,c=c.invoiceableToCharter-c.invoiceableToAffiliate;
b.due=a?c:-c})});b.toggleExplicitTotalDirectionInverted=function(){b.isExplicitTotalDirectionInverted=!b.isExplicitTotalDirectionInverted};b.startExplicitTotal=function(){b.isExplicitTotal=!0;b.isExplicitTotalDirectionInverted=!1;b.newInvoice.explicitTotal=b.due};b.cancelExplicitTotal=function(){b.isExplicitTotal=!1;b.isExplicitTotalDirectionInverted=!1;b.newInvoice.explicitTotal=""};b.startExplicitIdentifier=function(){b.isExplicitIdentifier=!0;b.newInvoice.explicitIdentifier=""};b.cancelExplicitIdentifier=
function(){b.isExplicitIdentifier=!1;b.newInvoice.explicitIdentifier=""};b.isSomeRowSelected=function(){return _.some(b.rows,function(a){return a.isSelected})};c.createController(b,{modelKey:"newInvoice",create:f.invoices.create,params:function(){return{shortname:b.company.shortname}},submitCallback:function(){b.newInvoice.affiliation=b.affiliation.pk;b.newInvoice.bookings=_.pluck(_.pluck(b.selectedRows(),"booking"),"pk");b.newInvoice.periodStartOn=h.options.startAt.format("YYYY-MM-DD");b.newInvoice.periodEndOn=
h.options.endAt.format("YYYY-MM-DD");b.isExplicitTotal?(b.newInvoice.explicitOffset=b.newInvoice.explicitTotal,b.isInvoicedToCharter||(b.newInvoice.explicitOffset=-b.newInvoice.explicitOffset)):b.newInvoice.explicitOffset=""},successCallback:function(a){e.success(interpolate(T("Generated invoice %(invoiceId)s"),{invoiceId:a.identifier}));d.navigate(a.$url(k.dashboard.reports.invoices.invoice.index))},defaultModel:m})}}})}]);h.controller("dashboard.reports.InvoiceCtrl",["$scope","controllers","db",
"navigation","require","urls",function(b,a,c,f,e,g){e.inScope(b,"company","dashboard.reports.InvoiceCtrl");e=b.route.bindings.invoicePk;var d=c.invoice;f.pathStartsWith(g.dashboard.reports.invoices.partnerInvoice.index)&&(d=c.invoices.partnerInvoice);b.invoice=d({shortname:b.company.shortname,invoicePk:e});a.dataController(b,{promises:[b.invoice.$promise]})}]);h.controller("dashboard.reports.InvoiceMultiCtrl",["$scope","$q","controllers","db","flash","navigation","require","urls",function(b,a,c,f,
e,g,d,h){d.inScope(b,"company","dashboard.reports.InvoiceCtrl");c=_.splitPks(b.route.bindings.invoicePks);b.invoiceStatuses={};b.invoices=_.map(c,function(a){return f.invoice({shortname:b.company.shortname,invoicePk:a})});var m=0;c=_.map(b.invoices,function(a){return a.$promise.then(function(){m++;b.invoiceStatuses[a.uri]="success";return!0},function(){b.invoiceStatuses[a.uri]="error";return!0})});b.isAllLoaded=!1;a.all(c).then(function(){b.isAllLoaded=!0;var a={count:b.invoices.length,successCount:m};
0===m&&b.invoices.length?e.error(b.$interpolate(interpolate(nT("Unable to load %(count)s invoice","Unable to load %(count)s invoices",a.count),{count:"[[ count ]]"})),a):m!==b.invoices.length?e.warn(b.$interpolate(interpolate(nT("Loaded %(successCount)s of %(count)s invoice","Loaded %(successCount)s of %(count)s invoices",a.count),{successCount:"[[ successCount ]]",count:"[[ count ]]"})),a):e.success(b.$interpolate(interpolate(nT("Loaded %(count)s invoice","Loaded %(count)s invoices",a.count),{count:"[[ count ]]"})),
a)})}]);h.controller("dashboard.reports.InvoiceEditableCtrl",["$scope","controllers","db","events","flash","models","navigation","require","urls",function(b,a,c,f,e,g,d,h,m){h.inScope(b,"invoice","dashboard.reports.InvoiceEditableCtrl");return a.editController(b,{elementKey:"invoice",modelKey:"editableInvoice",update:c.invoice.update,remove:c.invoice.remove,params:function(){return{shortname:b.invoice.company.shortname,invoicePk:b.invoice.pk}},editCallback:function(){b.editableInvoice.status=b.invoice.status===
g.Invoice.UNPAID_STATUS?g.Invoice.PAID_STATUS:g.Invoice.UNPAID_STATUS},successCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){d.navigate(b.invoice.company.$url(m.dashboard.reports.invoices.index))},editing:!0})}]);h.controller("dashboard.reports.InvoiceActionsCtrl",["$scope","controllers","db","navigation","require","urls",function(b,a,c,f,e,g){e.inScope(b,"company","dashboard.reports.InvoiceActionsCtrl");e.inScope(b,"invoice","dashboard.reports.InvoiceActionsCtrl")}]);
h.controller("dashboard.reports.InvoiceNotificationCtrl",["$filter","$scope","controllers","db","events","models","navigation","require","urls",function(b,a,c,f,e,g,d,h,m){h.inScope(a,"company","dashboard.reports.InvoiceNotificationCtrl");h.inScope(a,"invoice","dashboard.reports.InvoiceNotificationCtrl");a.isSubjectEditable=!1;h=a.$interpolate(interpolate(T("Invoice %(invoiceId)s from %(invoiceName)s is ready to view"),{invoiceId:"[[ invoice.identifier ]]",invoiceName:"[[ invoice.remitToCompany.name ]]"}),
{invoice:a.invoice});h={emails:a.invoice.billedToCompany.billingEmail||a.invoice.billedToCompany.email,subject:h,type:g.Notification.INVOICE_PAYMENT_REQUEST_TYPE};a.notification=_.extend({},h);c.emailPreviewController(a,{modelKey:"notification",url:m.email.invoicePaymentRequest,params:function(b){return{type:b,shortname:a.company.shortname,invoicePk:a.invoice.pk}},isPreviewable:function(a){return!0}});c.cannedMessagesController(a,{modelKey:"notification",noteField:"note",types:[g.CannedMessage.INVOICE_PAYMENT_REQUEST_TYPE]});
c.createController(a,{modelKey:"notification",create:f.invoice.notifications.create,params:function(){return{shortname:a.company.shortname,invoicePk:a.invoice.pk}},successCallback:function(c){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");c=b("invoiceUrl")(a.invoice);d.navigate(c)},defaultModel:h});return c.dataController(a,{promises:a.cannedMessagesCtrl.promises})}]);h.controller("dashboard.reports.PaymentsReportCtrl",["$scope","$filter","db","models","reports","require",function(b,a,c,f,
e,g){g.inScope(b,"report","dashboard.reports.PaymentsReportCtrl");var d=["before","on","after"];e.reportController(b,{process:function(a){var c=[],e=[],g={},h=function(a,b){g[b.uri]||(g[b.uri]=!0,a.push(b))};_.forEach(d,function(b){var d=a.data.refunds[b];_.forEach(a.data.payments[b],function(a){a.type===f.Payment.IN_STORE_TYPE?h(c,a.inStorePaymentType):a.type===f.Payment.STORED_VALUE_CARD_TYPE&&h(e,a.storedValueType)});_.forEach(d,function(a){a.payment.type===f.Payment.IN_STORE_TYPE?h(c,a.payment.inStorePaymentType):
a.payment.type===f.Payment.STORED_VALUE_CARD_TYPE&&h(e,a.payment.storedValueType)})});c=_.sortBy(c,"sortableIndex");e=_.sortBy(e,"name");b.paymentTypes=[];b.paymentTypes.push({type:"online-cc",displayType:T("Credit Card"),filter:function(a){return!a.user&&a.isProcessorBasedType}});b.paymentTypes.push({type:"employee-cc",displayType:T("Credit Card (Employee)"),filter:function(a){return a.user&&a.isProcessorBasedType},tip:T("Credit cards charged by logged-in users")});b.paymentTypes.push({type:"charter-relationship",
displayType:T("Affiliate (Reseller)"),filter:function(a){return a.type===f.Payment.AFFILIATE_TYPE&&a.booking.affiliation&&a.booking.invoiceSheet&&a.booking.invoiceSheet.relationship===f.InvoiceSheet.CHARTER_RELATIONSHIP}});b.paymentTypes.push({type:"affiliate-relationship",displayType:T("Affiliate (Referral)"),filter:function(a){return a.type===f.Payment.AFFILIATE_TYPE&&a.booking.affiliation&&a.booking.invoiceSheet&&a.booking.invoiceSheet.relationship===f.InvoiceSheet.AFFILIATE_RELATIONSHIP}});_.forEach(c,
function(a){b.paymentTypes.push({type:f.Payment.IN_STORE_TYPE+"-"+a.pk,displayType:_.capitalize(a.shortName||a.name),filter:function(b){return b.type===f.Payment.IN_STORE_TYPE&&b.inStorePaymentType===a}})});_.forEach(e,function(a){b.paymentTypes.push({type:f.Payment.STORED_VALUE_CARD_TYPE+"-"+a.pk,displayType:_.capitalize(a.shortName||a.name),filter:function(b){return b.type===f.Payment.STORED_VALUE_CARD_TYPE&&b.storedValueType===a}})});b.paymentTypes.push({type:"total",displayType:T("Total"),filter:_.always});
b.paymentAndRefundTypes=[];_.forEach(b.paymentTypes,function(a){b.paymentAndRefundTypes.push({paymentType:a,displayType:cT("Short for Payments","Pmts"),type:"paymentAmounts",factor:1});b.paymentAndRefundTypes.push({paymentType:a,displayType:T("Refunds"),type:"refundAmounts",factor:-1})});var p={paymentAmounts:{},refundAmounts:{}},r=function(c){var d=a.data.payments[c],e=a.data.refunds[c],g={},k={},h={kind:c,paymentAmounts:{},refundAmounts:{},rows:[]},m=function(a){var b=g[a.uri];b||(b={availability:a,
bookings:{},payments:[],refunds:[],paymentAmounts:{},refundAmounts:{},detailRows:[]},g[a.uri]=b,h.rows.push(b));return b},n=function(a,b){var c=k[b.uri];c||(c={booking:b,payments:[],paymentAmounts:{},refundAmounts:{}},k[b.uri]=c,a.detailRows.push(c));return c};_.forEach(b.paymentTypes,function(b){h.paymentAmounts[b.type]=h.paymentAmounts[b.type]||0;h.refundAmounts[b.type]=h.refundAmounts[b.type]||0;p.paymentAmounts[b.type]=p.paymentAmounts[b.type]||0;p.refundAmounts[b.type]=p.refundAmounts[b.type]||
0;_.forEach(d,function(c){if(c.type!==f.Payment.AFFILIATE_TYPE||c.booking.affiliation){var d=c.booking,e=m(d.availability);e.paymentAmounts[b.type]=e.paymentAmounts[b.type]||0;var g;a.options.isDetailed&&(g=n(e,d),g.paymentAmounts[b.type]=g.paymentAmounts[b.type]||0);b.filter(c)&&(e.paymentAmounts[b.type]+=c.initialReceipt.gross,h.paymentAmounts[b.type]+=c.initialReceipt.gross,p.paymentAmounts[b.type]+=c.initialReceipt.gross,e.bookings[d.uri]=d,e.payments.push(c),e.bookings[d.uri]=d,g&&(g.paymentAmounts[b.type]+=
c.initialReceipt.gross))}});_.forEach(e,function(c){var d=c.payment;if(d.type!==f.Payment.AFFILIATE_TYPE||d.booking.affiliation){var e=d.booking,g=m(e.availability);g.refundAmounts[b.type]=g.refundAmounts[b.type]||0;var k;a.options.isDetailed&&(k=n(g,e),k.refundAmounts[b.type]=k.refundAmounts[b.type]||0);b.filter(d)&&(g.refundAmounts[b.type]+=c.receipt.gross,h.refundAmounts[b.type]+=c.receipt.gross,p.refundAmounts[b.type]+=c.receipt.gross,g.bookings[e.uri]=e,g.refunds.push(c),k&&(k.refundAmounts[b.type]+=
c.receipt.gross))}})});return h};b.subreports=_.choose(d,function(a){a=r(a);if(a.rows.length)return a});b.totals=p}})}]);h.controller("dashboard.reports.DisputesReportCtrl",["$scope","$filter","reports",function(b,a,c){c.reportController(b,{process:function(a){b.payments=a.data.payments}})}]);h.controller("dashboard.reports.ContactsReportCtrl",["$scope","$filter","reports",function(b,a,c){c.reportController(b,{process:function(a){b.contacts=a.data.contacts}})}]);h.controller("dashboard.reports.PayoutsCtrl",
["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.reports.PayoutsCtrl");b.accounts=c.company.accounts({shortname:b.company.shortname});a.dataController(b,{promises:[b.accounts.$promise]})}]);h.controller("dashboard.reports.PayoutsReportCtrl",["$scope","$filter","db","reports","urls",function(b,a,c,f,e){a("date");a("datetimeRange");a("capitalize");f.reportController(b,{process:function(a){b.payouts=a.data.payouts;b.futurePayouts=a.data.futurePayouts}})}]);h.controller("dashboard.reports.PayoutCtrl",
["$scope","$filter","db","flash","navigation","reports","require",function(b,a,c,f,e,g,d){d.inScope(b,"company","dashboard.reports.PayoutCtrl");a("date");a("datetimeRange");b.payout=c.payout({shortname:b.company.shortname,payoutPk:b.route.bindings.payoutPk});g.viewController(b,{promises:[b.payout.$promise],successCallback:function(){b.isPayoutLoaded=!0}});b.retry=function(a){c.payout.retry({shortname:b.company.shortname,payoutPk:b.payout.pk},{},a).$promise.then(function(a){f.success(T("Initiated payout"))})}}]);
h.controller("dashboard.reports.shared.PayoutCtrl",["$scope","db","require",function(b,a,c){c.inScope(b,"payout","dashboard.reports.shared.PayoutCtrl");b.status=b.isPayoutLoaded?"visible":"hidden";b.toggleDetails=function(){"visible"===b.status?b.status="hidden":"loading"!==b.status&&(b.isPayoutLoaded||b.payout.isFuture?b.status="visible":(b.status="loading",a.payout({shortname:b.payout.company.shortname,payoutPk:b.payout.pk}).$promise.then(function(){b.isPayoutLoaded=!0;b.status="visible"},function(){b.status=
"hidden"})))}}]);h.controller("dashboard.reports.AccountsCtrl",["$scope","controllers","db","navigation","processors","require","urls",function(b,a,c,f,e,g,d){g.inScope(b,"company","dashboard.reports.AccountsCtrl");b.accounts=c.company.accounts({shortname:b.company.shortname});b.bankAccounts=c.bankAccounts({shortname:b.company.shortname});a.dataController(b,{promises:[b.accounts.$promise,b.bankAccounts.$promise]})}]);h.controller("dashboard.reports.TestReportCtrl",["$scope","reports",function(b,a){a.reportController(b,
{process:function(a){b.message=a.data.message}})}]);h.controller("dashboard.reports.ReportsReportCtrl",["$scope","reports",function(b,a){a.reportController(b,{process:function(a){b.reports=a.data.reports}})}]);h.controller("dashboard.reports.AccountsReportCtrl",["$scope","reports",function(b,a){a.reportController(b,{process:function(a){b.transfers=a.data.transfers;b.uploads=a.data.uploads}})}]);h.controller("dashboard.reports.TransferCtrl",["$scope","db","reports","require",function(b,a,c,f){f.inScope(b,
"company","dashboard.reports.TransferCtrl");a=a.transfer({shortname:b.company.shortname,transferPk:b.route.bindings.transferPk});b.transfers=[a];c.viewController(b,{promises:[a.$promise]})}]);h.controller("dashboard.reports.InvoiceUploadsCtrl",["$filter","$scope","controllers","db","events","models","navigation","processors","reports","require","urls",function(b,a,c,f,e,g,d,h,m,k,n){k.inScope(a,"company","dashboard.reports.InvoiceUploadsCtrl");k.inScope(a,"invoice","dashboard.reports.InvoiceUploadsCtrl");
a.bankAccounts=f.bankAccounts({shortname:a.company.shortname});var s=a.company.processorCurrency;a.isTotalValid=function(){var b=_.find(a.bankAccounts,function(b){return b.pk===a.newUpload.bankAccount});a.minimumChargeAmount=g.Payment.minimumChargeAmounts[b.processorType][s];return a.newUpload.total>=a.minimumChargeAmount};c.dataController(a,{promises:[a.bankAccounts.$promise],successCallback:function(){a.bankAccounts=_.filter(a.bankAccounts,function(a){return a.isUploadsEnabled});c.createController(a,
{modelKey:"newUpload",create:f.invoice.uploads.create,params:function(){return{shortname:a.company.shortname,invoicePk:a.invoice.pk}},successCallback:function(c){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");c=b("invoiceUrl")(a.invoice);d.navigate(c)},defaultModel:{bankAccount:a.bankAccounts.length?a.bankAccounts[0].pk:"",total:a.invoice.isInvoicedToCharter?a.invoice.invoicedToCharter:a.invoice.invoicedToAffiliate}})}})}]);h.controller("dashboard.reports.UploadCtrl",["$scope","db","reports",
"require",function(b,a,c,f){f.inScope(b,"company","dashboard.reports.UploadCtrl");b.upload=a.upload({shortname:b.company.shortname,uploadPk:b.route.bindings.uploadPk});b.uploads=[b.upload];c.viewController(b,{promises:[b.upload.$promise]})}]);h.controller("dashboard.reports.TransactionsCtrl",["$scope","auth","controllers","db","models","navigation","processors","require","urls",function(b,a,c,f,e,g,d,h,m){h.inScope(b,"company","dashboard.reports.TransactionsCtrl");h.assert(a.currentUser.company.isAdmin,
"dashboard.reports.TransactionsCtrl");b.isProjectedRefundReserveRecurringTransferAmountLoaded=!1;b.accounts=f.company.accounts({shortname:b.company.shortname});b.adminAccounts=f.company.accounts({shortname:a.currentUser.company.shortname});f.upcomingRefundReserveAmount({shortname:b.route.bindings.shortname}).$promise.then(function(a){b.company.projectedUpcomingRefundReserveRecurrentTransferAmount=a.data.upcomingRefundReserveAmount;b.isProjectedRefundReserveRecurringTransferAmountLoaded=!0});b.isInvalidAdjustment=
function(){return b.newAdjustment.processorType===d.STRIPE_PROCESSOR_TYPE&&b.newAdjustment.isProcessable&&"from-company"===b.newAdjustment.direction};b.supportedCurrencyChoices=[];e=b.company.isAdmin?e.Adjustment.getCurrencyChoices():e.Adjustment.getCurrencyChoices([b.company.processorCurrency]);_.overwrite(b.supportedCurrencyChoices,e);c.dataController(b,{promises:[b.accounts.$promise,b.adminAccounts.$promise]});c.createController(b,{modelKey:"newAdjustment",create:f.adjustments.create,params:function(){return{shortname:b.company.shortname}},
successCallback:function(c){b.adminAccounts=f.company.accounts({shortname:a.currentUser.company.shortname});g.navigate(c.$url(m.dashboard.reports.transactions.adjustment))},defaultModel:{processorType:d.DEFAULT_PROCESSOR_TYPE,processorCurrency:1===b.supportedCurrencyChoices.length?b.supportedCurrencyChoices[0][0]:"",direction:"to-company",isProcessable:!b.company.isAdmin,isPayable:!1,isExternal:b.company.isAdmin}})}]);h.controller("dashboard.reports.TransactionsReportCtrl",["$scope","reports",function(b,
a){a.reportController(b,{process:function(a){b.transactions=a.data.transactions}})}]);h.controller("dashboard.reports.AdjustmentCtrl",["$scope","db","reports","require",function(b,a,c,f){f.inScope(b,"company","dashboard.reports.AdjustmentCtrl");a=a.adjustment({shortname:b.company.shortname,adjustmentPk:b.route.bindings.adjustmentPk});b.adjustments=[a];c.viewController(b,{promises:[a.$promise]})}]);h.controller("dashboard.reports.EscrowReportCtrl",["$scope","models","reports",function(b,a,c){b.rows=
[];c.reportController(b,{process:function(c){_.clear(b.rows);c=c.data.values;c=[].concat(c.payments,c.refunds,c.adjustments,c.transfers,c.uploads);b.rows=_.map(c,function(b){var c=b.cls===a.Payment.cls,d=b.cls===a.Refund.cls,f=b.cls===a.Upload.cls,h={type:b.cls,user:b.user,createdAt:b.createdAt,booking:null,invoice:null,note:b.note||"",estimatedPayoutCreatedAt:b.estimatedPayoutCreatedAt,isGrossApplicable:c||d||f,isProcessingApplicable:c||d||f};c?(h.booking=b.booking,h.gross=b.initialReceipt.gross,
h.processing=-b.initialReceipt.processingFee,h.net=b.initialReceipt.net):d?(h.booking=b.payment.booking,h.gross=-b.receipt.gross,h.processing=b.receipt.processingFee,h.net=-b.receipt.net):f?(h.type=T("Debit"),h.gross=b.total,h.processing=-b.invoiceFee,h.net=h.gross+h.processing,h.invoice=b.invoice):h.net=b.offset;return h})}})}]);h.controller("dashboard.reports.FundsCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.reports.FundsCtrl");b.accounts=c.company.accounts({shortname:b.company.shortname});
return a.dataController(b,{promises:[b.accounts.$promise]})}]);h.controller("dashboard.reports.FundsReportCtrl",["$scope","reports",function(b,a){a.reportController(b,{process:function(a){b.funds=a.data.funds}})}]);h.controller("dashboard.reports.FundCtrl",["$scope","db","navigation","reports","require",function(b,a,c,f,e,g){g.inScope(b,"company","dashboard.reports.FundCtrl");a=c.fund({shortname:b.company.shortname,fundPk:b.route.bindings.fundPk});b.funds=[a];e.viewController(b,{promises:[a.$promise]})}]);
h.controller("dashboard.reports.VolumeReportCtrl",["$scope","reports",function(b,a){a.reportController(b,{process:function(a){b.volumes=a.data.volumes;b.daily=a.data.daily;b.currency="all"===a.options.currencyFilter?"usd":a.options.currencyFilter}})}]);h.controller("dashboard.reports.CompaniesReportCtrl",["$scope","auth","reports","require",function(b,a,c,f){f.assert(a.currentUser.company.isAdmin,"dashboard.reports.CompaniesReportCtrl");c.reportController(b,{process:function(a){b.volumesByCompany=
a.data.volumes;b.companiesByCurrency=_.map(a.data.companies,function(c){a.options.includeCompaniesWithNoActivity||(c=_.filter(c,function(a){a=b.volumesByCompany[a.uri];return!(!a.bookings.count&&!a.payments.count&&!a.refunds.count&&!a.uploads.count)}));c=_.map(c,function(a){return $.extend(a,{province:a.primaryLocation?a.primaryLocation.province:a.province})});return{processorCurrency:_.get(_.first(c),"processorCurrency"),companies:c}})}})}]);h.controller("dashboard.reports.LineItemsCtrl",["$scope",
function(b){}]);h.controller("dashboard.reports.LineItemsReportCtrl",["$scope","reports",function(b,a){a.reportController(b,{process:function(a){b.lineItems=a.data.lineItems}})}]);h.controller("dashboard.reports.AgentsSummaryReportCtrl",["$scope","summaryReportController",function(b,a){a(b,{elementHeader:T("Agent"),needsCustomerCount:!0,getElements:function(a){return a.agents},getItemAggregates:function(a,b){return a.aggregates[b.uri]},getElementName:function(a,b){return b.company.name+" - "+b.name}})}]);
h.controller("dashboard.reports.BookingTypesSummaryReportCtrl",["$scope","summaryReportController",function(b,a){a(b,{elementHeader:T("Source"),needsCustomerCount:!0,getElements:function(a){var b=[],e={name:T("Online"),type:"online"};b.push(e);e={name:T("Direct"),type:"direct"};b.push(e);_.forEach(a.affiliateCompanies,function(a){var c=a.name;a=a.uri;b.push({name:c,type:"affiliate",uri:a});c={name:interpolate(T("%(name)s (Online)"),{name:c}),type:"affiliate-online",uri:a};b.push(c)});return b},getItemAggregates:function(a,
b){if("affiliate"===b.type)return a.aggregates.affiliate[b.uri];if("affiliate-online"===b.type)return a.aggregates["affiliate-online"][b.uri];if("direct"===b.type)return a.aggregates.direct;if("online"===b.type)return a.aggregates.online;throw Error("dashboard.reports.BookingTypesSummaryReportCtrl: invalid element: "+b);}})}]);h.controller("dashboard.reports.CampaignsSummaryReportCtrl",["$scope","summaryReportController",function(b,a){a(b,{elementHeader:T("Campaign"),getElementName:function(a,b){return b.name},
getElements:function(a){return a.campaigns},getItemAggregates:function(a,b){return a.aggregates[b.uri]}})}]);h.controller("dashboard.reports.CrewSummaryReportCtrl",["$scope","summaryReportController",function(b,a){a(b,{needsAvailabilityCount:!0,needsCustomerCount:!0,elementHeader:T("Crew Member"),getElements:function(a){return a.users},getItemAggregates:function(a,b){return a.aggregates[b.uri]}})}]);h.controller("dashboard.reports.CustomerTypesSummaryReportCtrl",["$scope","summaryReportController",
function(b,a){a(b,{elementHeader:T("Customer Type"),useCountHeader:T("Customers"),getElements:function(a){return a.customerTypes},getItemAggregates:function(a,b){return a.aggregates[b.uri]},getUseCount:function(a){return a.customerCount}})}]);h.controller("dashboard.reports.CustomFieldSummaryReportCtrl",["$scope","models","summaryReportController",function(b,a,c){var f=T("True"),e=T("False"),g=[T("Used"),T("Not Used")];c(b,{needsCustomerCount:!0,elementHeader:T("Option"),getElementName:function(b,
c){if(a.CustomField.usesCheckbox(b.customField)){if(c===e)return T("No");if(c===f)return T("Yes")}return c?c.name||c:"none"},getElements:function(b){var c=b.customField;if(a.CustomField.usesCheckbox(b.customField))return[e,f];if(c.type===a.CustomField.COUNT_TYPE)return g;b=[];if(c.type===a.CustomField.EXTENDED_OPTION_TYPE){if(_.isUndefined(c.extendedOptions))throw Error("dashboard.reports.CustomFieldSummaryReportCtrl: extended options are undefined");_.ref.append(b,c.extendedOptions);if(_.isUndefined(c.hiddenExtendedOptions))throw Error("dashboard.reports.CustomFieldSummaryReportCtrl: hidden extended options are undefined");
_.ref.append(b,c.hiddenExtendedOptions)}_.contains(b,"")||b.push("");return b},getItemAggregates:function(b,c){if(_.isUndefined(c))throw Error("dashboard.reports.CustomFieldSummaryReportCtrl: element is undefined");return b.customField.type===a.CustomField.EXTENDED_OPTION_TYPE&&c&&c.pk?b.aggregates[c.pk.toString()]:b.aggregates[c]},getUseCount:function(a){return a.bookingUseCount+a.customerUseCount}})}]);h.controller("dashboard.reports.DesksSummaryReportCtrl",["$scope","summaryReportController",function(b,
a){a(b,{elementHeader:T("Desk"),needsCustomerCount:!0,getElementName:function(a,b){return b.company.name+" - "+b.name},getElements:function(a){return a.desks},getItemAggregates:function(a,b){return a.aggregates[b.uri]}})}]);h.controller("dashboard.reports.ItemsSummaryReportCtrl",["$scope","summaryReportController",function(b,a){a(b,{needsCustomerCount:!0})}]);h.controller("dashboard.reports.LodgingsSummaryReportCtrl",["$scope","summaryReportController",function(b,a){a(b,{elementHeader:T("Lodging"),
needsCustomerCount:!0,getElementName:function(a,b){return b.name||(b.hotel?b.hotel.name:"")},getElements:function(a){return _.append(a.lodgings,[{name:T("None"),uri:"none"}])},getItemAggregates:function(a,b){return a.aggregates[b.uri]}})}]);h.controller("dashboard.reports.RevenueSummaryReportCtrl",["$scope","$timeout","models","reports",function(b,a,c,f){b.displayOptions={splitNets:!1,showRealized:!0};var e={};e[c.Payment.CC_TYPE]=T("Credit card");e[c.Payment.LEGACY_CC_TYPE]=cT("Legacy describes an old version",
"Credit card (legacy)");b.displayPaymentType=function(a){return a.paymentType===c.Payment.AFFILIATE_TYPE?T("Affiliate")+"("+c.InvoiceSheet.displayRelationship(a.relationship)+")":a.paymentType===c.Payment.IN_STORE_TYPE?a.inStorePaymentType.shortName||a.inStorePaymentType.name:a.paymentType===c.Payment.STORED_VALUE_CARD_TYPE?a.storedValueType.shortName||a.storedValueType.name:e[a.paymentType]||a.paymentType||a};b.PAYMENTS_DETAIL_VIEW="payments-detail-view";b.REFUNDS_DETAIL_VIEW="refunds-detail-view";
var g=function(c,d,e,f){b.status="processing";a(function(){b.selectedSubreport=c;b.selectedRow=d;b.detailObjects=e;b.detailView=f;b.status="success"})};b.showPaymentsDetail=function(a,c,d){g(a,c,d,b.PAYMENTS_DETAIL_VIEW)};b.showRefundsDetail=function(a,c,d){g(a,c,d,b.REFUNDS_DETAIL_VIEW)};b.showSummary=function(){b.status="processing";a(function(){b.selectedSubreport=null;b.selectedRow=null;b.detailObjects=null;b.detailView=null;b.status="success"})};var d=function(a){var b={realizedPayments:[],realizedRefunds:[],
createdRealizedPayments:[],createdRealizedRefunds:[],createdPayments:[],createdRefunds:[]},c="realizedPaymentsCount realizedPaymentsInitialGross realizedPaymentsInitialProcessingFee realizedRefundsCount realizedRefundsGross realizedRefundsProcessingFee createdRealizedPaymentsCount createdRealizedPaymentsInitialGross createdRealizedPaymentsInitialProcessingFee createdRealizedRefundsCount createdRealizedRefundsGross createdRealizedRefundsProcessingFee createdPaymentsCount createdPaymentsInitialGross createdPaymentsInitialProcessingFee createdRefundsCount createdRefundsGross createdRefundsProcessingFee".split(" ");
_.forEach(c,function(c){b[c]=_.sum(_.pluck(a,c))});c="realizedPayments realizedRefunds createdRealizedPayments createdRealizedRefunds createdPayments createdRefunds".split(" ");_.forEach(c,function(c){b[c]=_.flatten(_.pluck(a,c),!0)});return b},h=function(a){a=d(a);return _.extend(a,{item:{name:T("all")},isSummaryRow:!0})},m=function(a){var b=d(a),c=function(a,c){a=_.capitalize(a);return _.append.apply(null,_.map(c,function(c){return b[c+a]}))},e=function(a,c){a=_.capitalize(a);return _.sum(_.map(c,
function(c){return b[c+a]}))};a=function(a){a={payments:c("payments",a),paymentsCount:e("paymentsCount",a),paymentsInitialGross:e("paymentsInitialGross",a),paymentsInitialProcessingFee:e("paymentsInitialProcessingFee",a),refunds:c("refunds",a),refundsCount:e("refundsCount",a),refundsGross:e("refundsGross",a),refundsProcessingFee:e("refundsProcessingFee",a)};a.netCollected=a.paymentsInitialGross-a.refundsGross;return a};var f={};f.realized=a(["realized","createdRealized"]);f.created=a(["createdRealized",
"created"]);f.all=a(["realized","createdRealized","created"]);return f};b.subreports=[];f.reportController(b,{process:function(a){_.clear(b.subreports);b.selectedSubreport=null;b.selectedRow=null;b.detailObjects=null;b.detailView=null;var c=a.data,e=c.aggregates,f={};_.forEach(c.typeFilters,function(a){var d={typeFilter:a,rows:[]};_.forEach(c.items,function(b){var c={realizedPayments:[],realizedPaymentsCount:0,realizedPaymentsInitialGross:0,realizedPaymentsInitialProcessingFee:0,realizedRefunds:[],
realizedRefundsCount:0,realizedRefundsGross:0,realizedRefundsProcessingFee:0,createdRealizedPayments:[],createdRealizedPaymentsCount:0,createdRealizedPaymentsInitialGross:0,createdRealizedPaymentsInitialProcessingFee:0,createdRealizedRefunds:[],createdRealizedRefundsCount:0,createdRealizedRefundsGross:0,createdRealizedRefundsProcessingFee:0,createdPayments:[],createdPaymentsCount:0,createdPaymentsInitialGross:0,createdPaymentsInitialProcessingFee:0,createdRefunds:[],createdRefundsCount:0,createdRefundsGross:0,
createdRefundsProcessingFee:0,item:b},g=e.realizedPayments[a.effectiveType];if(g=g?g[b.uri]:null)c.realizedPayments=g.paymentValues,c.realizedPaymentsCount=g.paymentsCount,c.realizedPaymentsInitialGross=g.paymentsInitialGross,c.realizedPaymentsInitialProcessingFee=g.paymentsInitialProcessingFee;if(g=(g=e.realizedRefunds[a.effectiveType])?g[b.uri]:null)c.realizedRefunds=g.refundValues,c.realizedRefundsCount=g.refundsCount,c.realizedRefundsGross=g.refundsGross,c.realizedRefundsProcessingFee=g.refundsProcessingFee;
if(g=(g=e.createdRealizedPayments[a.effectiveType])?g[b.uri]:null)c.createdRealizedPayments=g.paymentValues,c.createdRealizedPaymentsCount=g.paymentsCount,c.createdRealizedPaymentsInitialGross=g.paymentsInitialGross,c.createdRealizedPaymentsInitialProcessingFee=g.paymentsInitialProcessingFee;if(g=(g=e.createdRealizedRefunds[a.effectiveType])?g[b.uri]:null)c.createdRealizedRefunds=g.refundValues,c.createdRealizedRefundsCount=g.refundsCount,c.createdRealizedRefundsGross=g.refundsGross,c.createdRealizedRefundsProcessingFee=
g.refundsProcessingFee;if(g=(g=e.createdPayments[a.effectiveType])?g[b.uri]:null)c.createdPayments=g.paymentValues,c.createdPaymentsCount=g.paymentsCount,c.createdPaymentsInitialGross=g.paymentsInitialGross,c.createdPaymentsInitialProcessingFee=g.paymentsInitialProcessingFee;if(g=(g=e.createdRefunds[a.effectiveType])?g[b.uri]:null)c.createdRefunds=g.refundValues,c.createdRefundsCount=g.refundsCount,c.createdRefundsGross=g.refundsGross,c.createdRefundsProcessingFee=g.refundsProcessingFee;if(c.realizedPaymentsCount||
c.realizedRefundsCount||c.createdRealizedPaymentsCount||c.createdRealizedRefundsCount||c.createdPaymentsCount||c.createdRefundsCount)d.rows.push(c),f[b.uri]||(f[b.uri]=[]),f[b.uri].push(c)});if(d.rows.length){var g=h(d.rows);d.rows.push(g);d.overview=m([g]);b.subreports.push(d)}});if(b.subreports.length){var g={isTotalsSubreport:!0,rows:[],typeFilter:"all"};_.forEach(c.items,function(a){if(f[a.uri]){var b=d(f[a.uri]);b.item=a;g.rows.push(b)}});a=h(g.rows);g.rows.push(a);g.overview=m([a]);b.subreports.push(g)}}})}]);
h.controller("dashboard.reports.PickupsSummaryReportCtrl",["$scope","summaryReportController",function(b,a){a(b,{elementHeader:T("Pickup"),needsCustomerCount:!0,getElements:function(a){return a.pickups},getItemAggregates:function(a,b){return a.aggregates[b.uri]}})}]);h.controller("dashboard.reports.UsersSummaryReportCtrl",["$scope","summaryReportController",function(b,a){a(b,{needsCustomerCount:!0,elementHeader:T("User"),getElements:function(a){return a.users},getItemAggregates:function(a,b){return a.aggregates[b.uri]}})}]);
h.controller("dashboard.reports.NavigationCtrl",["$scope","advancedReport","require","models",function(b,a,c,f){c.inScope(b,"company","dashboard.reports.NavigationCtrl");a=a.relevantCompanies(b.company);var e=_.any(a,"isCharter");b.allowAdvancedModel=function(a){return a===f.CustomFieldValue?e||b.company.isAdmin:!0}}])})();
(function(){var h=angular.module("dashboard.reports.advancedControllers",[]);h.controller("dashboard.reports.AdvancedIndexCtrl",["$scope","auth","controllers","db","models","navigation","poller","require","currentSuggestedReport","currentCustomReport","newReportCache","advancedReport","urls",function(b,a,c,f,e,g,d,h,m,k,n,s,p){h.inScope(b,"company","dashboard.reports.AdvancedIndexCtrl");a=b.route.bindings.modelSlug;e=e.Report;b.relevantCompanies=s.relevantCompanies(b.company);b.newReport=n.getNewReport(b.relevantCompanies);
b.reportModel=_.findWhere(e.MODELS,{slug:a}).model;b.newReport.options.modelName=b.reportModel.cls;b.currentCustomReport=k(b.relevantCompanies,b.newReport);b.currentSuggestedReport=m(b.relevantCompanies,b.newReport)}]);h.controller("dashboard.reports.AdvancedReportCtrl",["$scope","$timeout","advancedReport","db","events","flash","models","navigation","require","convert","poller","reportGroups","reportFilters",function(b,a,c,f,e,g,d,h,m,k,n,s,p){m.inScope(b,"company","dashboard.reports.AdvancedReportCtrl");
var r=d.Report;b.status="loading";b.report=f.report({shortname:b.company.shortname,reportPk:b.route.bindings.reportPk});b.report.$promise.then(function(){b.status="success";b.route.bindings.modelSlug!=r.MODELS[b.report.options.modelName].slug?h.redirect(b.report.$url()):(e.broadcast("dashboard.reports.AdvancedReportCtrl.reportLoaded",{report:b.report}),y(b.report,b.breadcrumbs[0]))},function(){g.error("Report not found");h.navigate(r.advancedUrl(b.company,b.reportModel.cls))});b.breadcrumbs=[{report:b.report,
columnVisibility:null,groupSets:null}];var t=b.report,v=function(d,e){b.isProcessing=!0;a(function(){e.report=d;b.report=d;b.processorCurrency=b.report.options.processorCurrency;e.columnVisibility||(e.columnVisibility=c.generateColumnVisibility(d));b.columnVisibility=e.columnVisibility;e.groupSets||(e.groupSets=c.buildGroupSets(d));b.groupSets=e.groupSets;b.isProcessing=!1})},y=function(a,b){a.isInProgress?n({endpoint:f.report,params:{shortname:a.company.shortname,reportPk:a.pk},errorMessage:"Report failed"}).poll().$promise.then(function(){v(a,
b)}):v(a,b)};b.makePermalink=function(a){return 0<_.findIndex(b.breadcrumbs,{report:"report"})?"":a?a.$url():""};var q=function(a,b){var c=s.groupsToFilters[a.name];if(!c)throw Error("Grouping needs corresponding filter:"+a.name);var d=b[a.key],e=d.object||{},f={};c===r.CUSTOM_FIELD_VALUE_FILTER_TYPE?(f.customFieldType=e.type,f.value=e.value):c===r.CUSTOM_FIELD_FILTER_TYPE?(f.customField=e.pk,f.valueType="",f.value="",f.isCustomerLevel=!0,f.isWholeBookingLevel=!0):c===r.PAYMENT_TYPE_FILTER_TYPE?f.value=
[e.paymentType+":"+(e.pk||"")]:_.contains([r.BOOKING_CREATED_AT_WEEKDAY_FILTER_TYPE,r.BOOKING_ORIGINAL_CREATED_AT_WEEKDAY_FILTER_TYPE,r.AVAILABILITY_START_AT_WEEKDAY_FILTER_TYPE,r.LINE_ITEM_CREATED_AT_WEEKDAY_FILTER_TYPE,r.PAYMENT_OR_REFUND_CREATED_AT_WEEKDAY_FILTER_TYPE],c)?(f={},e=d.object.value,e=moment().day(e).format("dddd").toLowerCase(),f[e]=!0):_.contains([r.BOOKING_CREATED_AT_DAY_FILTER_TYPE,r.BOOKING_CREATED_AT_WEEK_FILTER_TYPE,r.BOOKING_CREATED_AT_MONTH_FILTER_TYPE,r.BOOKING_CREATED_AT_YEAR_FILTER_TYPE,
r.BOOKING_CREATED_AT_HOUR_FILTER_TYPE,r.AVAILABILITY_START_AT_DAY_FILTER_TYPE,r.AVAILABILITY_START_AT_WEEK_FILTER_TYPE,r.AVAILABILITY_START_AT_MONTH_FILTER_TYPE,r.AVAILABILITY_START_AT_YEAR_FILTER_TYPE,r.AVAILABILITY_START_AT_HOUR_FILTER_TYPE,r.LINE_ITEM_CREATED_AT_DAY_FILTER_TYPE,r.LINE_ITEM_CREATED_AT_WEEK_FILTER_TYPE,r.LINE_ITEM_CREATED_AT_MONTH_FILTER_TYPE,r.LINE_ITEM_CREATED_AT_YEAR_FILTER_TYPE,r.LINE_ITEM_CREATED_AT_HOUR_FILTER_TYPE,r.PAYMENT_OR_REFUND_CREATED_AT_DAY_FILTER_TYPE,r.PAYMENT_OR_REFUND_CREATED_AT_WEEK_FILTER_TYPE,
r.PAYMENT_OR_REFUND_CREATED_AT_MONTH_FILTER_TYPE,r.PAYMENT_OR_REFUND_CREATED_AT_YEAR_FILTER_TYPE,r.PAYMENT_OR_REFUND_CREATED_AT_HOUR_FILTER_TYPE],c)?f.value=e.value:(d=p[c],f.value=[e[d&&d.valueField||"pk"]||e.value||"none"]);return{type:c,data:f}},B=function(a,d){var e=c.transformReportOptions(t.options);e.isDetailed=!0;e.drilldownFilters=a;var g=_.indexOf(t.options.groups,d.grouping.name);e.groups=_.slice(t.options.groups,g+1);b.report=f.company.advancedReport({shortname:b.company.shortname},e);
b.status="loading";b.report.$promise.then(function(){b.status="success";y(b.report,d)},function(a){b.status="success"})},u=function(){var a=_.rest(b.breadcrumbs),d=r.emptyFilters();_.forEach(a,function(a){var e=a.grouping;a=a.group;var f;try{f=q(e,a)}catch(g){console.error("createDrilldownFilter:",g);return}e=_.find(r.MODELS_BY_GROUP[e.name],function(a){return c.isCoveredByReport(b.report,a)});d[e.cls].push(f)});return d},z=function(a,c){var d=_.pluck(b.breadcrumbs,"grouping.name");_.forEach(a,function(a){_.contains(d,
a.name)||b.breadcrumbs.push({grouping:a,group:c,report:null})})};b.drilldown=function(a,c){var d;d=t.data.groupings;var e=_.findWhere(d,{name:a.name}),e=_.indexOf(d,e);d=_.slice(d,0,e+1);z(d,c);d=u();e=_.last(b.breadcrumbs);B(d,e)};b.drillBackTo=function(a){if(!b.isBreadcrumbsDisabled()&&!b.report.isInProgress&&a!==_.last(b.breadcrumbs)&&_.contains(b.breadcrumbs,a)){var c=_.indexOf(b.breadcrumbs,a);b.breadcrumbs=_.slice(b.breadcrumbs,0,c+1);a.report?v(a.report,a):(c=u(),B(c,a))}};b.isBreadcrumbsDisabled=
function(){return"success"!==b.status||b.report.isInProgress};b.pathToAvailability=function(a){return"Booking"==_.get(a,"objects[0].cls")?"availability":"booking.availability"};b.isAggregateUnsound=function(a,c){if(b.report.options){var d;if(d=c)d=this.isFooter?_.contains(_.pluck(b.report.data.groupings,"name"),r.COMPANY_CURRENCY_GROUP):_.get(_.last(b.report.data.groupings),"name")===r.COMPANY_CURRENCY_GROUP;if(d||this.isFooter&&_.any(b.report.data.groupings,function(a){return _.contains(r.ALWAYS_UNSOUND_GROUPINGS,
a.name)}))return!0;d=_.get(_.last(b.report.data.groupings),"name");return _.contains(r.ALWAYS_UNSOUND_GROUPINGS,d)?!0:a.cls===b.report.options.modelName||0>_.indexOf(r.ORDERED_MODELS,a)?!1:_.any(b.report.data.groupings,function(b){return!b.cls?!1:_.contains(r.UNSOUND_AGGREGATES[b.cls],a)})}};b.$on("$destroy",function(){e.broadcast("dashboard.reports.AdvancedReportCtrl.reportCleared")})}]);h.controller("dashboard.reports.AdvancedReportEditableCtrl",["$scope","advancedPermissions","advancedReport",
"auth","cache","db","events","flash","require","models","navigation","urls","poller","convert","reportColumns","reportGroups","suggestedReports",function(b,a,c,f,e,g,d,h,m,k,n,s,p,r,t,v,y){m.inScope(b,"company","dashboard.reports.AdvancedReportEditableCtrl");m.inScope(b,"relevantCompanies","dashboard.reports.AdvancedReportEditableCtrl");m.inScope(b,"newReport","dashboard.reports.AdvancedReportEditableCtrl");m.inScope(b,"currentCustomReport","dashboard.reports.AdvancedReportEditableCtrl");m.inScope(b,
"currentSuggestedReport","dashboard.reports.AdvancedReportEditableCtrl");m.inScope(b,"reportModel","dashboard.reports.AdvancedReportEditableCtrl");var q=k.Report,B=k.SuggestedReport,u=k.CustomReport;n.get(q.SWITCH_QUERY_PARAM_KEY)||b.currentSuggestedReport.applySuggestedReport("default",b.newReport);b.$watch("newReport.options.customFieldValueModel",function(a){b.reportModelWithSubmodels=c.reportModelWithSubmodels(b.newReport);b.flattenedGroups=_.uniq(_.flatten(_.map(b.reportModelWithSubmodels,function(a){return q.VALID_GROUPS[a.cls]})))});
b.isCoveredByReport=c.isCoveredByReport;b.columnName=c.columnName;b.filterName=c.filterName;b.groupName=c.groupName;d.on(b,"dashboard.reports.AdvancedReportCtrl.reportLoaded",function(a,d){var e=d.report;b.createdReport&&b.createdReport.pk===e.pk||(b.createdReport=e,b.newReport.options=c.transformReportOptions(b.createdReport.options),_.defaultsDeep(b.newReport.options,q.emptyReportOptions(b.relevantCompanies)))});var z=function(a){var c=g.customReport({shortname:b.company.shortname,customReportPk:a});
e.fresh(c)?c.$promise.then(function(){b.currentCustomReport.applyCustomReport(c,b.newReport)}):b.currentCustomReport.applyCustomReport(c,b.newReport);b.currentSuggestedReport.object=null};n.watch(b,function(){var a=n.get(B.QUERY_PARAM);a&&(b.currentSuggestedReport.applySuggestedReport(a,b.newReport),b.currentCustomReport.object=null);var c=n.getPk(u.QUERY_PARAM);c&&z(c);if(a||c)b.createdReport=null});b.tracker=_.tracker();b.$watch("newReport.options",b.tracker.modified);b.validFilters=q.VALID_FILTERS;
var C=_.any(b.relevantCompanies,"affiliatesCount"),F=_.any(b.relevantCompanies,"features.isTransportationEnabled"),x=_.all(b.relevantCompanies,"features.isAggregateTaxEnabled");b.columnsByModel=_.mapValues(q.VALID_COLUMNS,function(a,b){var c=[],d=[],e=[];_.forEach(a,function(a){var b=a[0],f=a[1];a=a[2];e.push(b);f&&c.push(b);a&&d.push(b)});return{summary:c,detail:d,all:e}});b.isModelColumnsProhibited=function(a){return _.any((q.PROHIBITED_HIGHER_GROUPS[a.cls]||{})[b.newReport.options.modelName]||
[],function(a){return _.contains(b.newReport.options.groups,a)})};b.columnGroups=[{name:"summary",title:T("Summary")},{name:"detail",title:T("Detail")},{name:"all",title:T("All")}];b.columnGroupToggle={current:"summary"};b.$watch("newReport.options.isDetailed",function(a){a&&(b.columnGroupToggle.current="detail")});b.showColumn=function(c){return!a.permitColumn(c)?!1:0<b.selectedAffiliateCount?!0:!C&&t.affiliateColumns[c]||!F&&t.transportationColumns[c]||x&&t.taxByTypeColumns[c]||c===q.COMPANY_COLUMN&&
1===b.selectedAffiliateCount+b.selectedCharterCount?!1:!0};b.showGroup=function(d){if(d===q.COMPANY_CURRENCY_GROUP||!a.permitGroup(d))return!1;var e=v.affiliateGroups[d],f=v.transportationGroups[d];if(!C&&e&&!b.selectedAffiliateCount||!F&&f&&!b.selectedAffiliateCount)return!1;e=0<b.selectedAffiliateCount||1<b.selectedCharterCount||b.company.isAdmin;return d===q.COMPANY_GROUP&&!e||_.contains(q.PROHIBITED_GROUPS[b.newReport.options.modelName],d)?!1:c.isGroupCoveredByReport(b.newReport,d)};b.showFilter=
function(b){return a.permitFilter(b.type)};var w=function(){if(b.company.isAdmin)a.updateCompanies([b.company]);else{var c=_.filter(b.relevantCompanies,function(a){return b.newReport.options.selectedCharters[a.pk]});_.forEach(b.newReport.options.selectedAffiliates,function(a,d){if(a){var e=b.newReport.options.companies[d],f=e.selectedAllPartners,g=e.selectedPartners,e=_.findWhere(b.relevantCompanies,{pk:_.int(d)});f&&!e.$partners?b.loadPartners(e):_.forEach(e.$partners,function(a){(f||g[a.pk])&&c.push(a)})}});
a.updateCompanies(c)}},G=function(){var a=_.fromTrueKeys(b.newReport.options.selectedCharters);_.forEach(b.newReport.options.selectedAffiliates,function(c,d){if(c){var e=b.newReport.options.companies[d];e.selectedAllPartners?a.push(d+":all"):_.forEach(e.selectedPartners,function(b,c){b&&a.push(c)})}});return a.join(",")};b.$watch(function(){return G()},function(){var a=_.fromTrueKeys(b.newReport.options.selectedCharters);b.selectedCharterCount=a.length;a=_.fromTrueKeys(b.newReport.options.selectedAffiliates);
b.selectedAffiliateCount=a.length;b.seperateUniversalFilters=1<b.selectedCharterCount||0<b.selectedAffiliateCount;w()});b.loadPartners=function(b){b.$partners||(b.$partners=g.partners({shortname:b.shortname}),b.$partners.$promise.then(function(){b.$partners=_.choose(b.$partners,function(b){if(a.permitPartner(b.company))return b.company});b.$partners=_.uniq(b.$partners);w()}))};b.submit=function(a){b.newReport.options.groups=_.filter(b.newReport.options.groups,b.showGroup);b.newReport.options.columns=
_.mapValues(b.newReport.options.columns,function(a){return _.pick(a,function(a,c){return b.showColumn(c)})});b.createdReport=g.company.advancedReport({shortname:b.company.shortname},b.newReport.options,a);b.createdReport.$promise.then(function(){n.navigate(b.createdReport.$url())},function(a){b.cancel()});b.currentCustomReport.refresh(b.newReport);b.currentSuggestedReport.refresh(b.newReport)};b.cancel=function(){b.createdReport&&b.createdReport.$promise&&b.createdReport.$promise.cancel();b.createdReport&&
b.createdReport.pk&&g.report.cancel({shortname:b.createdReport.company.shortname,reportPk:b.createdReport.pk}).$promise.then(function(){b.createdReport=null},function(){h.error(b.$interpolate(interpolate(T("Unable to cancel %(reportType)s report"),{reportType:"[[ createdReport.displayType|lowercase ]]"})))})};b.setModelBeingFiltered=function(a){b.modelBeingFiltered=a};b.setModelBeingFiltered(k[b.newReport.options.modelName]);b.unselectGroup=function(a){_.ref.remove(b.newReport.options.groups,a)};
b.selectGroup=function(a){b.newReport.options.groups=_.union(b.newReport.options.groups,[a])};b.reorderGroups=function(a,c,d){_.ref.reorder(b.newReport.options.groups,a,c,d)};var M=function(a){return a===q.LINE_ITEM_DATE_TYPE?b.newReport.options.modelName===k.LineItem.cls:a===q.PAYMENT_OR_REFUND_ACCRUAL_DATE_TYPE||a===q.PAYMENT_OR_REFUND_DATE_TYPE?b.newReport.options.modelName===k.Payment.cls:a===q.BOOKING_DATE_TYPE||a===q.BOOKING_ORIGINAL_DATE_TYPE?b.newReport.options.modelName!==k.Payment.cls:!0};
M(b.newReport.options.dateType)||(b.newReport.options.dateType=q.BOOKING_DATE_TYPE);b.allowDateTypeChoice=function(a){return M(a.value)}}]);h.controller("dashboard.reports.CustomReportsCtrl",["$scope","auth","controllers","db","events","models","require","urls",function(b,a,c,f,e,g,d,h){d.inScope(b,"company","dashboard.bookings.CustomReportsCtrl");d.inScope(b,"currentCustomReport","dashboard.bookings.CustomReportsCtrl");d.inScope(b,"newReport","dashboard.bookings.CustomReportsCtrl");d.inScope(b,"reportModel",
"dashboard.bookings.CustomReportsCtrl");d.assert(b.newReport.options,"dashboard.bookings.CustomReportsCtrl");if(a.permissions.canList(g.CustomReport,b.company)){var m=f.customReports({shortname:b.company.shortname});e.on(b,"dashboard.shared.CustomReportEditableCtrl.updated",function(a,c){b.currentCustomReport.applyCustomReport(c.customReport,b.newReport)});c.dataController(b,{promises:[m.$promise],successCallback:function(){b.customReports=_.filter(m,function(a){return a.options.modelName===b.reportModel.cls});
c.listController(b,{collectionKey:"customReports",modelKey:"newCustomReport",create:f.customReports.create,submitCallback:function(){b.newCustomReport.options=_.stringifyJSON(b.newReport.options)},successCallback:function(a){b.currentCustomReport.applyCustomReport(a,b.newReport);e.broadcast("dashboard.shared.CustomReportEditableCtrl.created",a)},params:function(){return{shortname:b.company.shortname}},sortable:!0})}})}}]);h.controller("dashboard.shared.CustomReportEditableCtrl",["$scope","controllers",
"db","events","require",function(b,a,c,f,e){e.inScope(b,"company","dashboard.bookings.CustomReportsCtrl");e.inScope(b,"customReports","dashboard.shared.CustomReportEditableCtrl");e.inScope(b,"customReport","dashboard.shared.CustomReportEditableCtrl");return a.editController(b,{collectionKey:"customReports",elementKey:"customReport",modelKey:"editableCustomReport",update:c.customReport.update,remove:c.customReport.remove,submitCallback:function(){b.editableCustomReport.options=_.stringifyJSON(b.editableCustomReport.overwriteOptions?
b.newReport.options:b.customReport.options)},successCallback:function(){f.broadcast("dashboard.shared.CustomReportEditableCtrl.updated",{customReport:b.customReport})},params:function(){return{shortname:b.customReport.company.shortname,customReportPk:b.customReport.pk}}})}]);h.controller("dashboard.reports.SuggestedReportsCtrl",["$scope","models","require","suggestedReports",function(b,a,c,f){c.inScope(b,"relevantCompanies","dashboard.reports.SuggestedReportsCtrl");c.inScope(b,"reportModel","dashboard.reports.SuggestedReportsCtrl");
b.suggestedReports=f.forCompanies(b.relevantCompanies,b.reportModel.cls)}]);h.controller("dashboard.reports.ReportShareCtrl",["$scope","dateUtils","events","models","require",function(b,a,c,f,e){e.inScope(b,"currentCustomReport","dashboard.reports.ReportShareCtrl");e.inScope(b,"currentSuggestedReport","dashboard.reports.ReportShareCtrl");e.inScope(b,"company","dashboard.reports.ReportShareCtrl");var g=f.Report;c.on(b,"dashboard.reports.AdvancedReportCtrl.reportLoaded",function(a,c){b.report=c.report});
c.on(b,"dashboard.reports.AdvancedReportCtrl.reportCleared",function(a,c){b.report=null});b.makeShareLink=function(){return b.report?b.report.$url():b.currentCustomReport.object?f.CustomReport.url(b.currentCustomReport.object):b.currentSuggestedReport.object?f.SuggestedReport.url(b.currentSuggestedReport.object,b.company):""};b.exportFilename=function(){if(!b.report)return"";var c=g.MODELS[b.report.options.modelName].name,e=b.report.options.startAt,f=b.report.options.endAt,k=b.report.options.presetDateRange;
k&&(f=a.dateRange(k,b.company),e=f[0],f=f[1]);e=e.format("YYYY-MM-DD");f=f.format("YYYY-MM-DD");return c+"--"+e+"--"+f+".csv"}}]);h.controller("dashboard.reports.SidebarCtrl",["$scope","auth","controllers","db","events","models","navigation","require","suggestedReports","advancedReport","urls",function(b,a,c,f,e,g,d,h,m,k,n){h.inScope(b,"company","dashboard.reports.SidebarCtrl");h.inScope(b,"model","dashboard.reports.SidebarCtrl");b.reportModelName=g.Report.MODELS[b.model.cls].name;h=[];var s;a.permissions.canList(g.CustomReport,
b.company)&&(s=f.customReports({shortname:b.company.shortname}),h.push(s.$promise));b.relevantCompanies=k.relevantCompanies(b.company);b.suggestedReports=m.forCompanies(b.relevantCompanies,b.model.cls);d.watch(b,function(){var a=d.pathStartsWith(n.dashboard.reports.advanced.index),a=_.findWhere(g.Report.MODELS,{slug:a.modelSlug});b.currentModel=a?a.model:null});e.on(b,"dashboard.shared.CustomReportEditableCtrl.created",function(a,c){c.options.modelName===b.model.cls&&b.customReports.push(c)});c.dataController(b,
{promises:h,successCallback:function(){s&&(b.customReports=_.filter(s,function(a){return a.options.modelName===b.model.cls}))}})}])})();
(function(){var h=angular.module("dashboard.reports.directives",[]);h.directive("ngReportsAccounts",["$parse","models","processors",function(b,a,c){return{restrict:"A",templateUrl:"reports.accounts",scope:!0,compile:function(f,e){var g=b(e.ngReportsAccounts);return function(b){var e=g(b);b.company=e.company;b.includeAdminAccounts=e.company.isAdmin;var f=a.Company.getCurrencyCodes();b.accounts=e.company.isAdmin?_.compact(_.flatten(_.map(f,function(a){return _.map(c.PROCESSOR_TYPES,function(b){return _.get(e,
[a,b])})}))):_.map(c.PROCESSOR_TYPES,function(a){return e[e.company.processorCurrency][a]});b.accounts=_.sortByAll(b.accounts,function(a){return"usd"===a.currency?"":a.currency},"!isDefault")}}}}]);h.directive("ngAdvancedShowGroup",["$parse","advancedReport",function(b,a){return{restrict:"A",scope:!0,compile:function(c,f){var e=f.ngAdvancedShowGroupWhen?b(f.ngAdvancedShowGroupWhen):_.always;return function(b,c,f){var h=b.$index,k=b.report.data.groupings,n=b.group;if(f.ngAdvancedShowGroup&&!b.$eval(f.ngAdvancedShowGroup))c.addClass("ng-invisible");
else{var s=function(e,f){if(e){var l=_.indexOf(f,n),s=!1;if(0===l){l=_.indexOf(b.tablesCtrl.tables,b.groupSetTable);if(0>=l){c.toggleClass("ng-invisible",!1);return}l=b.tablesCtrl.tables[l-1];l=l.collection[l.collection.length-1]}else l=f[l-1];for(var y,q=0;q<h+1;q++)if(y=k[q],!a.compareGroupsByGroupingObject(y,n,l)){s=!0;break}c.toggleClass("ng-invisible",!s)}else c.toggleClass("ng-invisible",!0)};b.$watch(e,function(a){s(a,b.groupSetTable.collection)});b.$watchCollection("groupSetTable.collection",
function(a){s(e(b),a)})}}}}}]);h.directive("ngAdvancedShowColumn",[function(){return{restrict:"A",priority:1E3,link:{pre:function(b,a,c){b.columnVisibility[c.ngAdvancedShowColumn]||(a.$abort=!0,a.remove())}}}}]);h.directive("ngAdvancedSuperHeader",["reportColumns","require",function(b,a){return{restrict:"A",scope:!0,link:function(c,f,e){a.inScope(c,"columnVisibility","ngAdvancedSuperHeader");var g=c.$eval(e.ngAdvancedSuperHeader),d=e.ngAdvancedSuperHeaderModel;(e=_.sum(g,function(a){return c.columnVisibility[d+
"-"+a]?b.taxByTypeColumns[a]?(c.report.data.taxTypes||[]).length:1:0}))?f.attr("colspan",e):f.addClass("ng-hide")}}}]);h.directive("ngAdvancedHeader",["advancedReport",function(b){return{restrict:"A",scope:!0,link:function(a,c,f){(a=b.columnName(f.ngAdvancedHeader))&&c.text(a)}}}]);h.directive("ngAdvancedFilterGroupCount",["advancedPermissions",function(b){return{restrict:"A",scope:!0,controller:["$scope",function(a){this.count=function(c){var f=a.newReport.options,e=function(a){var e=0;_.forEach(a[c],
function(a){b.permitFilter(a.type)&&(e+=1)});return e},g=e(f.filters);_.forEach(f.companies,function(a,b){f.selectedCharters[b]&&(g+=e(a.filters));f.selectedAffiliates[b]&&(g+=e(a.allPartnerFilters));_.forEach(f.partners,function(b,c){a.selectedPartners[c]&&(g+=e(b.filters))})});return g}}],controllerAs:"filterGroupCountCtrl"}}]);h.directive("ngAdvancedFilterGroup",["$parse","$filter","advancedPermissions","filterFields","models","reportFilters","require",function(b,a,c,f,e,g,d){return{restrict:"A",
require:["ngAdvancedFilterGroup"],templateUrl:"dashboard.reports.ngAdvancedFilterGroup",scope:!0,controller:["$scope","$attrs",function(a,h){d.inScope(a,"modelBeingFiltered","ngAdvancedFilterGroup");d.inScope(a,"newReport","ngAdvancedFilterGroup");var k=this,n=e.Report;k.company=a.$eval(h.ngAdvancedFilterGroupCompany);k.types=a.$eval(h.ngAdvancedFilterGroupTypes);k.forceType=a.$eval(h.ngAdvancedFilterGroupForceType);k.addBtnText=a.$eval(h.ngAdvancedFilterGroupAddBtnText);var s=b(h.ngAdvancedFilterGroup);
k.filters=s(a);k.multiTypes=a.$eval(h.ngAdvancedFilterGroupMultiTypes);if(k.multiTypes){var p=[];k.types=[];var r={};_.forEach(k.multiTypes,function(a,b){d.assert(_.isArray(k.filters[b]),"Array not defined: "+b);_.ref.append(k.types,a);_.ref.append(p,k.filters[b]);_.forEach(a,function(a){r[a]=k.filters[b]})});k.filters=p}else k.filters||(k.filters=[],s.assign(a,k.filters));a.$watch("filterGroupCtrl.newFilter.type",function(b,c){if(b&&b!==c){var d=k.newFilter,e;e=(e=g[b])&&e.defaults?e.defaults(a,
k):{};d.data=e}});k.allowType=function(b){if(!c.permitFilter(b))return!1;var d=g[b];if(!d)return!0;if(d.isAllowed&&!d.isAllowed(a))return!1;d.allowMany=d.allowMany||{};return!d.allowMany[a.modelBeingFiltered.cls]?1>_.filter(k.filters,{type:b}).length:!0};k.remove=function(a){_.ref.remove(k.filters,a);k.multiTypes&&_.ref.remove(r[a.type],a)};k.isAdding=!1;k.newFilter=null;k.add=function(a){k.isAdding=!0;k.newFilter={type:a||k.forceType||"",data:{}}};k.submit=function(){var a=g[k.newFilter.type];a&&
a.formatFilterData&&(k.newFilter=a.formatFilterData(k.newFilter));k.filters.push(k.newFilter);k.isAdding=!1;k.multiTypes&&r[k.newFilter.type].push(k.newFilter)};k.isValid=function(a){if(!a.type)return!1;var b=g[a.type];return b&&b.isValid?b.isValid(a):_.any(a.data,function(a){return f.isSet(a)})};k.allowAdding=function(){return k.forceType?k.allowType(k.forceType):_.filter(k.types,k.allowType).length};a.newReport.options.modelName===e.CustomFieldValue.cls&&(a.modelBeingFiltered===e.CustomFieldValue&&
_.contains(k.types,n.CUSTOM_FIELDS_FILTER_TYPE))&&(1===k.types.length&&(k.forceType=n.CUSTOM_FIELDS_FILTER_TYPE,k.addBtnText=T("Add custom fields")),a.$watch(function(){return _.any(k.filters,{type:n.CUSTOM_FIELDS_FILTER_TYPE})},function(a){k.requireCustomFields=!a;k.requireCustomFields&&k.add(n.CUSTOM_FIELDS_FILTER_TYPE)}))}],controllerAs:"filterGroupCtrl"}}]);h.directive("ngAdvancedFilter",["$parse","filterFields","convert","reportFilters",function(b,a,c,f){return{restrict:"A",require:["^ngAdvancedFilterGroup",
"ngAdvancedFilter"],templateUrl:"dashboard.reports.ngAdvancedFilter",scope:!0,controller:["$scope","$attrs",function(a,c){var d=this,h=b(c.ngAdvancedFilter);d.filter=h(a);d.filter||console.error("ngAdvancedFilter: invalid filter",c.ngAdvancedFilter);d.isEditing=!1;d.edit=function(){d.isEditing=!0;d.editableFilter=_.deepClone(d.filter)};d.submit=function(){var a=f[d.editableFilter.type];a&&a.formatFilterData&&(d.editableFilter=a.formatFilterData(d.editableFilter));_.overwrite(d.filter,d.editableFilter);
d.isEditing=!1};d.summary=function(){var a=f[d.filter.type];return!a||!a.summary?"":a.summary(d.filter)}}],controllerAs:"filterCtrl"}}]);h.directive("ngAdvancedFilterForm",["$parse","$compile","$templateCache","$filter","require","models","reportFilters",function(b,a,c,f,e,g,d){return{restrict:"A",scope:!0,controller:["$scope","$attrs",function(a,b){this.filter=a.$eval(b.ngAdvancedFilterForm);(this.filterSpec=d[this.filter.type])&&this.filterSpec.formCtrl&&this.filterSpec.formCtrl(a,this)}],controllerAs:"filterFormCtrl",
require:["?^ngAdvancedFilterGroup","?^ngAdvancedFilter","ngAdvancedFilterForm"],compile:function(){return{pre:function(b,d,e,f){e=f[2];(f=c.get("ngAdvancedFilterForm."+_.replaceAll(e.filter.type,"-","")))||(e.template?f=c.get("ngAdvancedFilterForm."+e.template):e.filterSpec.template&&(f=c.get("ngAdvancedFilterForm."+e.filterSpec.template)));f?a(f)(b,function(a){d.append(a)}):console.error("ngAdvancedFilterForm: template not found for filter: ",e.filter)}}}}}]);h.filter("advancedDisplay",["$filter",
"models",function(b,a){var c=b("name"),f=b("date"),e=b("datetimeRange");return function(b){return _.isUndefined(b)||null===b?"":moment.isMoment(b)?f(b):_.isString(b)||_.isNumber(b)||_.isBoolean(b)?b:b.cls===a.Availability.cls?e(b.startAt,b.endAt):b.cls===a.Booking.cls?"#"+b.pk.toString():b.cls===a.CustomerType.cls?b.singular+(b.shortName?" ("+b.shortName+")":""):b.cls===a.CustomerPrototype.cls?b.name?b.name:b.customerType.singular+(b.customerType.shortName?" ("+b.customerType.shortName+")":""):b.cls===
a.Lodging.cls?c(b)||c(b.hotel):b.cls||b.name?c(b):b.value?b.value:b.unicode||""}}]);h.filter("advancedSort",["$filter","models","require",function(b,a,c){var f=b("name");return function(b){c.assertDefined(b,"advancedSort: expected group");return!b?"":moment.isMoment(b)||_.isString(b)||_.isNumber(b)||_.isBoolean(b)?b:b.cls===a.Availability?[b.startAt,b.endAt]:b.cls===a.Booking.cls?b.pk:b.cls===a.CustomerType.cls?b.singular:b.cls||b.name?f(b):b.value?b.value:f(b)}}]);h.filter("advancedGroupingSort",
["$filter","require",function(b,a){var c=b("advancedSort");return function(b,e){a.assert(b,"advancedGroupingSort: expected group");a.assert(e,"advancedGroupingSort: expected grouping");return!b[e.key]?_.constant(null):c(b[e.key].object||null)}}]);h.directive("ngAdvancedDisplayGrouping",["$filter","require",function(b,a){return{restrict:"A",templateUrl:"ng-advanced-display-header",scope:!0}}]);h.directive("ngAdvancedDisplayObject",["$filter","require",function(b,a){var c=b("advancedDisplay");return{restrict:"A",
templateUrl:"ng-advanced-display-object",scope:!0,compile:function(b,e){var g=!_.isUndefined(e.ngAdvancedDisplayObjectNameOnly);return function(b){a.assert(b.group,"ng-advanced-display-object: expected group");a.assert(b.grouping,"ng-advanced-display-object: expected grouping");var e=b.group[b.grouping.key];b.object=e.displayObject||e.object||null;b.objectDisplay=c(b.object,b.grouping);b.objectUrl="";!g&&(b.object&&b.object.$url)&&(b.objectUrl=b.object.$url())}}}}]);h.directive("ngAdvancedBreadcrumbs",
[function(){return{restrict:"A",templateUrl:"dashboard.reports.advanced.breadcrumbs"}}]);h.directive("ngAdvancedPrintDescription",[function(){return{restrict:"A",templateUrl:"dashboard.reports.advanced.printDescription"}}]);h.directive("ngAdvancedCurrency",["require",function(b){return{restrict:"A",priority:450,link:{pre:function(a,b,f){if(!a.report.options.processorCurrency){var e;a.group&&a.group.processorCurrency?e=a.group.processorCurrency.object.value:a.groupSet&&(a.groupSet[0]&&a.groupSet[0].processorCurrency)&&
(e=a.groupSet[0].processorCurrency.object.value);e&&(f=a,b.attr("ng-repeat-start")&&(f=a.$parent),f.processorCurrency=e)}}}}}]);h.directive("ngAdvancedReportCancel",["db","flash",function(b,a){return{restrict:"A",scope:!0,link:function(c){c.cancel=function(f){b.report.cancel({shortname:f.company.shortname,reportPk:f.pk}).$promise.then(function(){a.success(c.$interpolate(interpolate(T("Cancelled %(report)s report"),{report:"[[ report.displayType|lowercase ]]"}),{report:f}))},function(){a.error(c.$interpolate(interpolate(T("Unable to cancel %(report_type)s report"),
{report_type:"[[ report.displayType|lowercase ]]"})))})}}}}])})();
(function(){var h=angular.module("dashboard.reports.services",[]);h.factory("poller",["$timeout","$q","db","flash",function(b,a,c,f){var e=[1,1,1,1,1,2,2,3,3,4,4,5,5,10],g=function(a){var c=this;if(!c.isCancelled)if(c.result&&!c.result.isInProgress)c.deferred.resolve(c.result);else{a=a||0;var h=e[Math.min(a,e.length-1)],h=1E3*h;c.result=c.endpoint(c.params);c.request=c.result.$promise;c.request.then(function(e){c.status="success";c.isCancelled||(c.result.isInProgress?(c.request=b(_.bind(g,c,a+1),
h,c.request),c.request.cancel=function(){b.cancel(c.request)}):c.deferred.resolve(c.result))},function(a){c.status="success";c.cancel();var b=a.data.errorMessage;f.error(c.errorMessage+(b?"("+b+")":""));c.deferred.reject(a)})}};return function(b){var c=a.defer();return{endpoint:b.endpoint,params:b.params||{},errorMessage:b.errorMessage||"",isComplete:b.isComplete||_.constant(!0),status:"initial",isCancelled:!1,request:null,result:null,deferred:c,poll:function(){this.isCancelled=!1;g.apply(this);return this},
cancel:function(){this.isCancelled=!0;this.request&&this.request.cancel();this.request=null;return this},$promise:c.promise}}}]);h.factory("reportFilters",["$filter","$q","auth","db","models",function(b,a,c,f,e){var g=e.Report;c=function(a){a=a.data.value;_.isArray(a)||(a=_.fromTrueKeys(a));return a.join(", ")};var d=function(a){a=a.data.value;_.isArray(a)||(a=_.fromTrueKeys(a));return!a.length?"":a.length+" selected"},h=function(a,c,d){d=d||{};return function(e,g){g.template="multipleChoice";g.isNullable=
c;var h=b("name");g.choiceName=function(a){var b=h(a);a.isHidden?b+=" ("+T("deleted")+")":a.isInactive&&(b+=" ("+T("deactivated")+")");return b};var k=f[a],l=k.all;l||console.warn("reportFilters: not fetching 'all' "+a+", disabled will not be included");g.choices=(l||k)({shortname:e.filterGroupCtrl.company.shortname});g.choices.$promise.then(function(){d.formatChoices&&(g.choices=d.formatChoices(g.choices));var a=_.partition(g.choices,{isHidden:!1}),b=_.partition(a[0],{isArchived:!1});g.choices=_.union(b[0],
b[1],a[1])})}},m=function(a,c){return function(d){d=d.data[a];return c?b("fieldOrBoolean")(d):d}},k=function(a){return function(b,c){c.template=a?"nullableString":"string"}},n=function(a){return _.choose(e.Rule.WEEK_DAYS_KEYS,function(b){return a.data[b]?e.Rule.WEEK_DAYS[b]:void 0}).join(", ")},s=function(a){return _.any(a.data)},p,r=function(a){return{isCustomerLevel:!0,isWholeBookingLevel:a.modelBeingFiltered!==e.Customer}},t={};t[g.CANCELLED_STATUS_FILTER_TYPE]={summary:function(a){var b={};b[g.UNCANCELLED_FILTER_OPTION]=
T("uncancelled");b[g.REFUNDED_CANCELLED_FILTER_OPTION]=T("cancelled $0 paid");b[g.UNREFUNDED_CANCELLED_FILTER_OPTION]=T("cancelled > $0 paid");a=a.data.value;_.isArray(a)||(a=_.fromTrueKeys(a));return _.map(a,function(a){return b[a]}).join(", ")},name:T("Cancelled Status")};t[g.PAID_STATUS_FILTER_TYPE]={summary:c,name:T("Paid Status")};t[g.INVOICE_SHEET_RELATIONSHIP_FILTER_TYPE]={summary:c,name:T("Invoice Sheet Relationship")};t[g.SOURCE_FILTER_TYPE]={summary:c,name:T("Source")};t[g.CUSTOM_FIELDS_FILTER_TYPE]=
{summary:d,formCtrl:function(a,b){a.allCustomFields=f.customFields.all({shortname:a.filterGroupCtrl.company.shortname});a.allCustomFields.$fresh||(a.customFields=_.reject(a.allCustomFields,e.CustomField.isDisplayOnly),p=_.keyBy(a.customFields,"pk"));a.allCustomFields.$promise.then(function(){a.customFields=_.reject(a.allCustomFields,e.CustomField.isDisplayOnly);p=_.keyBy(a.customFields,"pk")})},name:T("Custom Field"),allowMany:{Customer:!0,Booking:!0}};t[g.CUSTOM_FIELD_FILTER_TYPE]={formCtrl:function(a,
b){b.filter.data.jsValue&&(b.filter.data.value=b.filter.data.jsValue);a.$watch("filterFormCtrl.customField",function(c,d){_.defaults(b.filter.data,r(a));_.isUndefined(d)||(delete b.filter.data.valueType,delete b.filter.data.jsValue,delete b.filter.data.value);c&&f.customField({shortname:c.company.shortname,customFieldPk:c.pk})})},isValid:function(a){return a.data&&a.data.customField&&(a.data.isCustomerLevel||a.data.isWholeBookingLevel)},name:function(a){return!p?T("Loading..."):e.CustomField.dropdownName(p[parseInt(a.data.customField,
10)])},defaults:r,summary:function(a){if(a.data.valueType){if(a.data.valueType===e.CustomFieldInstanceCondition.SELECTED_TYPE)return T("when selected");if(a.data.valueType===e.CustomFieldInstanceCondition.NOT_SELECTED_TYPE)return T("when not selected")}else return T("when any value");a=a.data.jsValue||a.data.value;return _.isString(a)?a:_.isBoolean(a)?a?T("when selected"):T("when not selected"):T("when exact value")},allowMany:{Customer:!0,Booking:!0,CustomFieldValue:!0}};t[g.PAYMENT_TYPE_FILTER_TYPE]=
{summary:d,formCtrl:function(c,d){d.template="multipleChoice";d.isNullable=!1;var g=b("name");d.choiceName=function(a){var b=g(a);a.isHidden&&(b+=" ("+T("deleted")+")");return b};var h=[{name:T("Credit card"),pk:e.Payment.CC_TYPE+":",isHidden:!1},{name:T("Affiliate"),pk:e.Payment.AFFILIATE_TYPE+":",isHidden:!1}],k=f.inStorePaymentTypes.all({shortname:c.filterGroupCtrl.company.shortname}),l=(0,f.storedValueTypes)({shortname:c.filterGroupCtrl.company.shortname});a.all([k.$promise,l.$promise]).then(function(){var a=
_.map(k,function(a){return{name:_.capitalize(a.name),isHidden:a.isHidden,pk:e.Payment.IN_STORE_TYPE+":"+a.pk}}),b=_.map(l,function(a){return{name:_.capitalize(a.name),isHidden:a.isHidden,pk:e.Payment.STORED_VALUE_CARD_TYPE+":"+a.pk}});d.choices=_.append(h,a,b);a=_.partition(d.choices,{isHidden:!1});d.choices=_.union(a[0],a[1]);d.status="success"},function(){d.status="error"})},name:T("Payment Type")};t[g.ITEM_FILTER_TYPE]={summary:d,formCtrl:h("items"),name:T("Item")};t[g.AFFILIATE_FILTER_TYPE]={summary:d,
valueField:"shortname",formatFilterData:function(a){a.data.value=_.fromTrueKeys(a.data.value);return a},name:T("Affiliate"),formCtrl:h("affiliates",!0,{formatChoices:function(a){return _.uniq(_.pluck(a,"affiliateCompany"),"shortname")}}),isAllowed:function(a){a=a.filterGroupCtrl.company;return 0<a.affiliatesCount||_.isUndefined(a.affiliatesCount)},defaults:function(){return{value:["any"]}}};t[g.AGENT_FILTER_TYPE]={summary:d,formCtrl:h("agents",!0),name:T("Agent")};t[g.DESK_FILTER_TYPE]={summary:d,
formCtrl:h("desks",!0),name:T("Desk")};t[g.TOTAL_SHEET_FILTER_TYPE]={summary:d,formCtrl:h("totalSheets"),name:T("Total Sheet")};t[g.INVOICE_SHEET_FILTER_TYPE]={summary:d,formCtrl:h("invoiceSheets"),name:T("Invoice Sheet")};t[g.BOOKING_RESOURCE_USE_FILTER_TYPE]={summary:d,formCtrl:h("resources",!0),name:T("Resource Use"),isAllowed:function(a){return 0<a.filterGroupCtrl.company.resourcesCount},allowMany:{Customer:!0,Booking:!0}};t[g.CUSTOMER_RESOURCE_USE_FILTER_TYPE]={summary:d,formCtrl:h("resources",
!0),name:T("Customer Resource Use"),isAllowed:function(a){return 0<a.filterGroupCtrl.company.resourcesCount},allowMany:{Customer:!0,Booking:!0}};t[g.CHECKIN_STATUS_FILTER_TYPE]={summary:d,formCtrl:h("checkinStatuses",!0),name:T("Check-in Status")};t[g.CUSTOMER_TYPE_FILTER_TYPE]={summary:d,formCtrl:h("customerTypes"),name:T("Customer Type"),allowMany:{Booking:!0}};t[g.CREW_MEMBER_USER_FILTER_TYPE]={summary:d,formCtrl:h("users",!0),name:T("Crew Member"),allowMany:{Booking:!0}};t[g.CREW_MEMBER_ROLE_FILTER_TYPE]=
{summary:d,formCtrl:h("roles",!0),name:T("Crew Role"),allowMany:{Booking:!0}};t[g.ROUTE_FILTER_TYPE]={summary:d,formCtrl:h("routes",!0),name:T("Route"),isAllowed:function(a){return a.filterGroupCtrl.company.features.isTransportationEnabled}};t[g.LODGING_FILTER_TYPE]={summary:d,formCtrl:h("lodgings",!0),name:T("Lodging"),isAllowed:function(a){return a.filterGroupCtrl.company.features.isTransportationEnabled}};t[g.PICKUP_FILTER_TYPE]={summary:d,formCtrl:h("pickups",!0),name:T("Pickup"),isAllowed:function(a){return a.filterGroupCtrl.company.features.isTransportationEnabled}};
t[g.USER_FILTER_TYPE]={summary:d,formCtrl:h("users",!0),name:T("Booked By")};t[g.ORIGINAL_USER_FILTER_TYPE]={summary:d,formCtrl:function(){return function(c,d){d.template="bookedByUser";d.isNullable=!0;var e=b("name");d.choiceName=function(a){var b=e(a);a.isHidden&&(b+=" ("+T("deleted")+")");return b};d.allUsers=f.users.all({shortname:c.filterGroupCtrl.company.shortname});d.relatedUsers=f.users.related({shortname:c.filterGroupCtrl.company.shortname});var g=function(a){a=_.partition(a,{isHidden:!1});
return _.union(a[0],a[1])};a.all([d.allUsers.$promise,d.relatedUsers.$promise]).then(function(){d.allUsers=g(d.allUsers);d.relatedUsers=g(d.relatedUsers);d.relatedUsers=_.difference(d.relatedUsers,d.allUsers)})}}(),name:T("Originally Booked By")};t[g.PAYMENT_USER_FILTER_TYPE]={summary:d,formCtrl:h("users",!0),name:T("Created By")};t[g.LINE_ITEM_DESCRIPTION_FILTER_TYPE]={name:T("Expense/Discount Description"),summary:m("value"),formCtrl:k(),allowMany:{Booking:!0}};t[g.ONLINE_BOOKING_REFERENCE_FILTER_TYPE]=
{summary:m("value",!0),formCtrl:k(!0),name:T("Online Booking Reference")};t[g.BOOKING_NOTE_FILTER_TYPE]={summary:m("value",!0),formCtrl:k(!0),name:T("Booking Note")};t[g.AVAILABILITY_NOTE_FILTER_TYPE]={name:T("Availability Notes"),summary:m("value",!0),formCtrl:k(!0)};t[g.HEADLINE_FILTER_TYPE]={summary:m("value",!0),formCtrl:k(!0),name:T("Public Headline")};t[g.PRIVATE_HEADLINE_FILTER_TYPE]={summary:m("value",!0),formCtrl:k(!0),name:T("Private Headline")};t[g.AVAILABILITY_START_AT_WEEKDAY_FILTER_TYPE]=
{summary:n,template:"weekday",name:T("Availability Day"),isValid:s};t[g.BOOKING_CREATED_AT_WEEKDAY_FILTER_TYPE]={summary:n,template:"weekday",name:T("Booking Day"),isValid:s};t[g.BOOKING_ORIGINAL_CREATED_AT_WEEKDAY_FILTER_TYPE]={summary:n,template:"weekday",name:T("Original Booking Day"),isValid:s};t[g.PAYMENT_OR_REFUND_CREATED_AT_WEEKDAY_FILTER_TYPE]={summary:n,template:"weekday",name:T("Payment Day"),isValid:s};t[g.PROCESSOR_BASED_TYPE_FILTER_TYPE]={summary:c,name:T("Credit Card Type")};t[g.DISPUTE_STATUS_FILTER_TYPE]=
{summary:c,name:T("Dispute Status")};t[g.PAYMENT_RECOGNIZED_FILTER_TYPE]={summary:c,name:T("Recognized Status")};t[g.PAYMENT_COLLECTED_FILTER_TYPE]={summary:c,name:T("Collected Status")};t[g.PAYMENT_ACCRUAL_STATUS_FILTER_TYPE]={summary:c,name:T("Accrual Status")};t[g.CHARTER_FILTER_TYPE]={summary:d,valueField:"shortname",isAllowed:function(a){return a.company.isAdmin},formCtrl:function(a,b){b.filter.data.value=b.filter.data.value||[];b.companiesEndpoint=f.searchEndpoint(f.companies.pickable);b.add=
function(){b.adding=!0};a.$watch("filterFormCtrl.newCompany",function(a){a&&(b.filter.data.value.push(a.shortname),b.adding=!1);b.newCompany=""});b.remove=function(a){b.filter.data.value=_.without(b.filter.data.value,a)}}};t[g.COMPANY_CURRENCY_FILTER_TYPE]={summary:c,name:T("Currency")};t[g.CONTACT_LANGUAGE_FILTER_TYPE]={summary:c,name:T("Contact Language")};return t}]);h.factory("reportColumns",["models",function(b){b=b.Report;var a={};a.affiliateColumns=_.toTrueKeys([b.AFFILIATE_COLUMN,b.AFFILIATE_PERCENTAGE_COLUMN,
b.COLLECTED_BY_AFFILIATE_TOTAL_COST_PRICE_COLUMN,b.COLLECTED_BY_AFFILIATE_TOTAL_COST_TAX_COLUMN,b.COLLECTED_BY_AFFILIATE_TOTAL_COST_TOTAL_COLUMN,b.COLLECTED_BY_CHARTER_TOTAL_COST_PRICE_COLUMN,b.COLLECTED_BY_CHARTER_TOTAL_COST_TAX_COLUMN,b.COLLECTED_BY_CHARTER_TOTAL_COST_TOTAL_COLUMN,b.VOUCHER_NUMBER_COLUMN,b.AGENT_COLUMN,b.DESK_COLUMN,b.IS_INVOICED_COLUMN,b.INVOICEABLE_TO_CHARTER_COLUMN,b.INVOICEABLE_TO_AFFILIATE_COLUMN,b.INVOICED_TO_CHARTER_COLUMN,b.INVOICED_TO_AFFILIATE_COLUMN,b.INVOICE_SHEET_COLUMN,
b.INVOICE_COST_PRICE_COLUMN,b.INVOICE_COST_TAX_COLUMN,b.INVOICE_COST_TOTAL_COLUMN,b.RECEIPT_COLLECTED_BY_AFFILIATE_PROCESSING_FEE_COLUMN,b.RECEIPT_COLLECTED_BY_AFFILIATE_NET_COLUMN,b.RECEIPT_COLLECTED_BY_CHARTER_PROCESSING_FEE_COLUMN,b.RECEIPT_COLLECTED_BY_CHARTER_NET_COLUMN]);a.transportationColumns=_.toTrueKeys([b.ROUTE_COLUMN,b.LODGING_COLUMN,b.PICKUP_COLUMN,b.ROOM_COLUMN]);a.taxByTypeColumns=_.toTrueKeys([b.TOTAL_COST_TAX_BY_TYPE_COLUMN,b.COLLECTED_TOTAL_COST_TAX_BY_TYPE_COLUMN,b.PAYMENT_AND_REFUND_TOTAL_TAX_BY_TYPE_COLUMN]);
var c=a.names={};c[b.AVAILABILITY_DATETIME_COLUMN]=T("Availability");c[b.AVAILABILITY_START_TIME_COLUMN]=T("Availability Start Time");c[b.AVAILABILITY_START_DATE_COLUMN]=T("Availability Start Date");c[b.AVAILABILITY_END_TIME_COLUMN]=T("Availability End Time");c[b.AVAILABILITY_END_DATE_COLUMN]=T("Availability End Date");c[b.AVAILABILITY_ID_COLUMN]=cT('"ID" is abbreviation of "Identifier"',"Availability ID");c[b.AVAILABILITY_PRIVATE_HEADLINE_COLUMN]=T("Availability Private Headline");c[b.AVAILABILITY_PUBLIC_HEADLINE_COLUMN]=
T("Availability Public Headline");c[b.BOOKING_ID_COLUMN]=cT('"ID" is abbreviation of "Identifier"',"Booking ID");c[b.BOOKING_IS_CANCELLED_COLUMN]=T("Cancelled?");c[b.BOOKING_LAST_REBOOKED_AT_COLUMN]=T("Last Rebooked At");c[b.BOOKING_LAST_REBOOKED_AT_DATE_COLUMN]=T("Last Rebooked at Date");c[b.BOOKING_LAST_REBOOKED_AT_TIME_COLUMN]=T("Last Rebooked at Time");c[b.BOOKING_NOTE_COLUMN]=T("Booking Notes");c[b.BOOKING_ORIGINALLY_BOOKED_BY_COLUMN]=T("Originally Booked By");c[b.BOOKING_BOOKED_BY_COLUMN]=T("Booked By");
c[b.ONLINE_BOOKING_REFERENCE_COLUMN]=T("Online Booking Reference");c[b.PAID_STATUS_COLUMN]=T("Paid Status");c[b.TOTAL_SHEET_COLUMN]=T("Total Sheet");c[b.DAY_OF_WEEK_COLUMN]=T("Availability Day");c[b.IS_SUBSCRIBED_TO_EMAIL_COLUMN]=T("Subscribed to Email?");c[b.IS_SUBSCRIBED_TO_SMS_COLUMN]=cT('"SMS" as in text message',"Subscribed to SMS?");c[b.CONTACT_EMAIL_COLUMN]=T("Email");c[b.CONTACT_NAME_COLUMN]=T("Contact Name");c[b.CONTACT_PHONE_COLUMN]=T("Phone");c[b.CONTACT_LANGUAGE_COLUMN]=T("Contact Language");
c[b.BOOKING_COUNT_COLUMN]=T("# of Bookings");c[b.CANCELLED_COUNT_COLUMN]=T("# Cancelled");c[b.INVOICED_COUNT_COLUMN]=T("# Invoiced");c[b.CUSTOMER_COUNT_COLUMN]=cT("Pax is an abbreviation for passengers","# of Pax (Customer Count)");c[b.EMAIL_SUBSCRIBED_COUNT_COLUMN]=T("# Subscribed to Email");c[b.SMS_SUBSCRIBED_COUNT_COLUMN]=cT('"SMS" as in text message',"# Subscribed to SMS");c[b.ITEM_ID_COLUMN]=cT('"ID" is abbreviation of "Identifier"',"Item ID");c[b.ITEM_NAME_COLUMN]=T("Item");c[b.ROUTE_COLUMN]=
T("Route");c[b.LODGING_COLUMN]=T("Lodging");c[b.PICKUP_COLUMN]=T("Pickup");c[b.STOP_TIME_COLUMN]=T("Pickup Time");c[b.ROOM_COLUMN]=T("Room Number");c[b.AFFILIATE_COLUMN]=T("Affiliate");c[b.AGENT_COLUMN]=T("Agent");c[b.DESK_COLUMN]=T("Desk");c[b.VOUCHER_NUMBER_COLUMN]=T("Voucher Number");c[b.INVOICE_SHEET_COLUMN]=T("Invoice Sheet");c[b.INVOICE_SHEET_DESCRIPTION_COLUMN]=T("Invoice Sheet Description");c[b.IS_INVOICED_COLUMN]=T("Invoiced?");c[b.INVOICEABLE_TO_AFFILIATE_COLUMN]=T("Payable to Affiliate");
c[b.INVOICED_TO_AFFILIATE_COLUMN]=T("Paid to Affiliate");c[b.INVOICEABLE_TO_CHARTER_COLUMN]=T("Receivable from Affiliate");c[b.INVOICED_TO_CHARTER_COLUMN]=T("Received from Affiliate");c[b.CHECKIN_STATUS_COLUMN]=T("Check-in Status");c[b.CUSTOMER_TYPE_COLUMN]=T("Customer Type");c[b.CUSTOMER_PROTOTYPE_COLUMN]=T("Customer Type (Item)");c[b.LINE_ITEM_DESCRIPTION_COLUMN]=T("Description");c[b.NET_CHARTER_REVENUE_COLUMN]=cT('"Net" is an accounting term meaning "total amount after adjustment"',"Net Revenue Collected");
c[b.AMOUNT_DUE_COLUMN]=T("Amount Due");c[b.TOTAL_COST_PRICE_COLUMN]=T("Subtotal");c[b.TOTAL_COST_TAX_COLUMN]=T("Total Tax");c[b.TOTAL_COST_TAX_BY_TYPE_COLUMN]=T("Tax By Type");c[b.TOTAL_COST_TOTAL_COLUMN]=T("Total");c[b.INVOICE_COST_PRICE_COLUMN]=T("Invoice Subtotal");c[b.INVOICE_COST_TAX_COLUMN]=T("Invoice Tax");c[b.INVOICE_COST_TOTAL_COLUMN]=T("Invoice Total");c[b.PAYMENT_OR_REFUND_COLUMN]=T("Payment or Refund");c[b.PAYMENT_TYPE_COLUMN]=T("Payment Type");c[b.AFFILIATE_PAYMENT_TYPE_COLUMN]=T("Affiliate Payment Type");
c[b.PROCESSOR_BASED_TYPE_COLUMN]=T("Credit Card Type");c[b.PROCESSOR_BASED_IDENTIFIER_COLUMN]=T("Last 4 Digits of Credit Card");c[b.CREDIT_CARD_POSTAL_CODE_COLUMN]=T("Credit Card Postal Code");c[b.STORED_VALUE_CARD_NUMBER_COLUMN]=T("Gift Card Number");c[b.STORED_VALUE_CARD_TYPE_COLUMN]=T("Gift Card Type");c[b.DISPUTE_STATUS_COLUMN]=T("Dispute Status");c[b.PAYMENT_INITIAL_GROSS_COLUMN]=T("Payment Gross");c[b.PAYMENT_INITIAL_PROCESSING_FEE_COLUMN]=T("Payment Processing Fees");c[b.PAYMENT_INITIAL_NET_COLUMN]=
cT('"Net" is an accounting term meaning "total amount after adjustment"',"Payment Net");c[b.PAYMENT_COUNT_COLUMN]=T("Payment Count");c[b.REFUND_COUNT_COLUMN]=T("Refund Count");c[b.PAYMENT_AND_REFUND_COUNT_COLUMN]=T("Payment and Refund Count");c[b.PAYMENT_AND_REFUND_GROSS_COLUMN]=T("Gross");c[b.PAYMENT_AND_REFUND_PROCESSING_FEE_COLUMN]=T("Processing Fees");c[b.PAYMENT_AND_REFUND_NET_COLUMN]=cT('an accounting term meaning "total amount after adjustment"',"Net");c[b.PAYMENT_NOTE_LABEL_COLUMN]=T("Payment Note Label");
c[b.PAYMENT_NOTE_COLUMN]=T("Payment Note");c[b.REFUND_GROSS_COLUMN]=T("Refund Gross");c[b.REFUND_PROCESSING_FEE_COLUMN]=T("Refund Processing Fee");c[b.REFUND_NET_COLUMN]=cT('"Net" is an accounting term meaning "total amount after adjustment"',"Refund Net");c[b.PAYMENT_AND_REFUND_TOTAL_TAX_COLUMN]=T("Total Tax Paid");c[b.PAYMENT_AND_REFUND_TOTAL_TAX_BY_TYPE_COLUMN]=T("Tax Paid By Type");c[b.PAYMENT_AND_REFUND_TOTAL_PRICE_COLUMN]=T("Subtotal Paid");c[b.PAYMENT_USER_COLUMN]=T("Created By");c[b.PAYMENT_OR_REFUND_ID_COLUMN]=
cT('"ID" is abbreviation of "Identifier"',"Payment or Refund ID");c[b.RECEIPT_PROCESSING_FEE_COLUMN]=T("Card Processing Fees");c[b.RECEIPT_BOOKING_FEE_COLUMN]='<span class="admin-badge">FH</span> '+T("Booking Fees");c[b.RECEIPT_NET_COLUMN]=T("Total Paid after Processing Fees");c[b.RECEIPT_COLLECTED_BY_CHARTER_PROCESSING_FEE_COLUMN]=T("Card Processing Fees Charged to Provider");c[b.RECEIPT_COLLECTED_BY_CHARTER_NET_COLUMN]=T("Total Paid to Provider after Processing Fees");c[b.RECEIPT_COLLECTED_BY_AFFILIATE_PROCESSING_FEE_COLUMN]=
T("Card Processing Fees Charged to Affiliate");c[b.RECEIPT_COLLECTED_BY_AFFILIATE_NET_COLUMN]=T("Total Paid to Affiliate after Processing Fees");c[b.COLLECTED_TOTAL_COST_PRICE_COLUMN]=T("Subtotal Paid");c[b.COLLECTED_TOTAL_COST_TAX_COLUMN]=T("Total Tax Paid");c[b.COLLECTED_TOTAL_COST_TAX_BY_TYPE_COLUMN]=T("Tax Paid By Type");c[b.COLLECTED_TOTAL_COST_TOTAL_COLUMN]=T("Total Paid");c[b.COLLECTED_BY_CHARTER_TOTAL_COST_PRICE_COLUMN]=T("Subtotal Paid to Provider");c[b.COLLECTED_BY_CHARTER_TOTAL_COST_TAX_COLUMN]=
T("Tax Paid to Provider");c[b.COLLECTED_BY_CHARTER_TOTAL_COST_TOTAL_COLUMN]=T("Total Paid to Provider");c[b.COLLECTED_BY_AFFILIATE_TOTAL_COST_PRICE_COLUMN]=T("Subtotal Paid to Affiliate");c[b.COLLECTED_BY_AFFILIATE_TOTAL_COST_TAX_COLUMN]=T("Tax Paid to Affiliate");c[b.COLLECTED_BY_AFFILIATE_TOTAL_COST_TOTAL_COLUMN]=T("Total Paid to Affiliate");c[b.TOTAL_COST_TOTAL_PERCENTAGE_COLUMN]=T("% Total");c[b.COLLECTED_TOTAL_COST_TOTAL_PERCENTAGE_COLUMN]=T("% Total Paid");c[b.USE_COUNT_COLUMN]=T("Use Count");
c[b.DISPLAY_COUNT_COLUMN]=T("Display Count");c[b.CUSTOM_FIELD_VALUE_COLUMN]=T("Answer");c[b.CREATED_AT_COLUMN]=T("Created At");c[b.CREATED_AT_TIME_COLUMN]=T("Created at Time");c[b.CREATED_AT_DATE_COLUMN]=T("Created at Date");return a}]);h.factory("reportGroups",["models",function(b){b=b.Report;var a={},c=a.names={};c[b.ORIGINAL_USER_GROUP]=T("Originally Booked By");c[b.USER_GROUP]=T("Booked By");c[b.BOOKING_CREATED_AT_DAY_GROUP]=T("Booking Date");c[b.BOOKING_CREATED_AT_WEEK_GROUP]=T("Booking Week");
c[b.BOOKING_CREATED_AT_MONTH_GROUP]=T("Booking Month");c[b.BOOKING_CREATED_AT_YEAR_GROUP]=T("Booking Year");c[b.BOOKING_CREATED_AT_HOUR_GROUP]=T("Booking Hour");c[b.BOOKING_CREATED_AT_WEEKDAY_GROUP]=T("Booking Day");c[b.AVAILABILITY_START_AT_DAY_GROUP]=T("Availability Date");c[b.AVAILABILITY_START_AT_WEEK_GROUP]=T("Availability Week");c[b.AVAILABILITY_START_AT_MONTH_GROUP]=T("Availability Month");c[b.AVAILABILITY_START_AT_YEAR_GROUP]=T("Availability Year");c[b.AVAILABILITY_START_AT_HOUR_GROUP]=T("Availability Hour");
c[b.AVAILABILITY_START_AT_WEEKDAY_GROUP]=T("Availability Day");c[b.LINE_ITEM_CREATED_AT_DAY_GROUP]=T("Expense/Discount Date");c[b.LINE_ITEM_CREATED_AT_WEEK_GROUP]=T("Expense/Discount Week");c[b.LINE_ITEM_CREATED_AT_MONTH_GROUP]=T("Expense/Discount Month");c[b.LINE_ITEM_CREATED_AT_YEAR_GROUP]=T("Expense/Discount Year");c[b.LINE_ITEM_CREATED_AT_HOUR_GROUP]=T("Expense/Discount Hour");c[b.LINE_ITEM_CREATED_AT_WEEKDAY_GROUP]=T("Expense/Discount Day");c[b.PAYMENT_OR_REFUND_CREATED_AT_DAY_GROUP]=T("Payment Date");
c[b.PAYMENT_OR_REFUND_CREATED_AT_WEEK_GROUP]=T("Payment Week");c[b.PAYMENT_OR_REFUND_CREATED_AT_MONTH_GROUP]=T("Payment Month");c[b.PAYMENT_OR_REFUND_CREATED_AT_YEAR_GROUP]=T("Payment Year");c[b.PAYMENT_OR_REFUND_CREATED_AT_HOUR_GROUP]=T("Payment Hour");c[b.PAYMENT_OR_REFUND_CREATED_AT_WEEKDAY_GROUP]=T("Payment Day");c[b.CHECKIN_STATUS_GROUP]=T("Check-in Status");c[b.BOOKING_CHECKIN_STATUS_GROUP]=T("Check-in Status");c[b.COMPANY_CURRENCY_GROUP]=T("Currency");c[b.INVOICE_SHEET_GROUP]=T("Invoice Sheet");
c[b.TOTAL_SHEET_GROUP]=T("Total Sheet");c[b.CUSTOM_FIELD_VALUE_GROUP]=T("Custom Field Answer");c[b.CUSTOM_FIELD_GROUP]=T("Custom Field");c[b.CUSTOMER_TYPE_GROUP]=T("Customer Type");c[b.CUSTOMER_PROTOTYPE_GROUP]=T("Customer Type (Item)");c[b.ITEM_GROUP]=T("Item");c[b.BOOKING_GROUP]=T("Booking");c[b.CAMPAIGN_GROUP]=T("Campaign");c[b.AFFILIATE_GROUP]=T("Affiliate");c[b.AVAILABILITY_GROUP]=T("Availability");c[b.AGENT_GROUP]=T("Agent");c[b.DESK_GROUP]=T("Desk");c[b.LODGING_GROUP]=T("Lodging");c[b.PICKUP_GROUP]=
T("Pickup");c[b.SOURCE_GROUP]=T("Source");c[b.PAID_STATUS_GROUP]=T("Paid Status");c[b.INVOICE_SHEET_RELATIONSHIP_GROUP]=T("Invoice Sheet Relationship");c[b.CREW_MEMBER_USER_GROUP]=T("Crew Member");c[b.CREW_MEMBER_ROLE_GROUP]=T("Crew Role");c[b.BOOKING_RESOURCE_GROUP]=T("Booking Resource");c[b.CUSTOMER_RESOURCE_GROUP]=T("Customer Resource");c[b.PAYMENT_USER_GROUP]=T("Created By");c[b.PAYMENT_TYPE_GROUP]=T("Payment Type");c[b.PROCESSOR_BASED_TYPE_GROUP]=T("Credit Card Type");c[b.DISPUTE_STATUS_GROUP]=
T("Dispute Status");c[b.PAYMENT_ACCRUAL_STATUS_GROUP]=T("Accrual Status");c[b.CONTACT_LANGUAGE_GROUP]=T("Contact Language");a.affiliateGroups=_.toTrueKeys([b.AFFILIATE_GROUP,b.DESK_GROUP,b.AGENT_GROUP]);a.transportationGroups=_.toTrueKeys([b.LODGING_GROUP,b.PICKUP_GROUP]);c=a.groupsToFilters={};c[b.BOOKING_GROUP]=b.BOOKING_FILTER_TYPE;c[b.ITEM_GROUP]=b.ITEM_FILTER_TYPE;c[b.AFFILIATE_GROUP]=b.AFFILIATE_FILTER_TYPE;c[b.AGENT_GROUP]=b.AGENT_FILTER_TYPE;c[b.DESK_GROUP]=b.DESK_FILTER_TYPE;c[b.AVAILABILITY_GROUP]=
b.AVAILABILITY_FILTER_TYPE;c[b.CUSTOMER_TYPE_GROUP]=b.CUSTOMER_TYPE_FILTER_TYPE;c[b.CUSTOMER_PROTOTYPE_GROUP]=b.CUSTOMER_PROTOTYPE_FILTER_TYPE;c[b.CUSTOM_FIELD_GROUP]=b.CUSTOM_FIELD_FILTER_TYPE;c[b.CUSTOM_FIELD_VALUE_GROUP]=b.CUSTOM_FIELD_VALUE_FILTER_TYPE;c[b.CREW_MEMBER_USER_GROUP]=b.CREW_MEMBER_USER_FILTER_TYPE;c[b.CREW_MEMBER_ROLE_GROUP]=b.CREW_MEMBER_ROLE_FILTER_TYPE;c[b.BOOKING_RESOURCE_GROUP]=b.BOOKING_RESOURCE_USE_FILTER_TYPE;c[b.CUSTOMER_RESOURCE_GROUP]=b.CUSTOMER_RESOURCE_USE_FILTER_TYPE;
c[b.USER_GROUP]=b.USER_FILTER_TYPE;c[b.ORIGINAL_USER_GROUP]=b.ORIGINAL_USER_FILTER_TYPE;c[b.PAYMENT_USER_GROUP]=b.PAYMENT_USER_FILTER_TYPE;c[b.LODGING_GROUP]=b.LODGING_FILTER_TYPE;c[b.PICKUP_GROUP]=b.PICKUP_FILTER_TYPE;c[b.SOURCE_GROUP]=b.SOURCE_FILTER_TYPE;c[b.INVOICE_SHEET_RELATIONSHIP_GROUP]=b.INVOICE_SHEET_RELATIONSHIP_FILTER_TYPE;c[b.PAID_STATUS_GROUP]=b.PAID_STATUS_FILTER_TYPE;c[b.PROCESSOR_BASED_TYPE_GROUP]=b.PROCESSOR_BASED_TYPE_FILTER_TYPE;c[b.DISPUTE_STATUS_GROUP]=b.DISPUTE_STATUS_FILTER_TYPE;
c[b.PAYMENT_TYPE_GROUP]=b.PAYMENT_TYPE_FILTER_TYPE;c[b.BOOKING_ORIGINAL_CREATED_AT_DAY_GROUP]=b.BOOKING_ORIGINAL_CREATED_AT_DAY_FILTER_TYPE;c[b.PAYMENT_RECOGNIZED_GROUP]=b.PAYMENT_RECOGNIZED_FILTER_TYPE;c[b.PAYMENT_COLLECTED_GROUP]=b.PAYMENT_COLLECTED_FILTER_TYPE;c[b.PAYMENT_ACCRUAL_STATUS_GROUP]=b.PAYMENT_ACCRUAL_STATUS_FILTER_TYPE;c[b.CHECKIN_STATUS_GROUP]=b.CHECKIN_STATUS_FILTER_TYPE;c[b.BOOKING_CHECKIN_STATUS_GROUP]=b.CHECKIN_STATUS_FILTER_TYPE;c[b.COMPANY_GROUP]=b.CHARTER_FILTER_TYPE;c[b.COMPANY_CURRENCY_GROUP]=
b.COMPANY_CURRENCY_FILTER_TYPE;c[b.INVOICE_SHEET_GROUP]=b.INVOICE_SHEET_FILTER_TYPE;c[b.TOTAL_SHEET_GROUP]=b.TOTAL_SHEET_FILTER_TYPE;c[b.CAMPAIGN_GROUP]=b.CAMPAIGN_FILTER_TYPE;c[b.BOOKING_CREATED_AT_DAY_GROUP]=b.BOOKING_CREATED_AT_DAY_FILTER_TYPE;c[b.BOOKING_CREATED_AT_WEEK_GROUP]=b.BOOKING_CREATED_AT_WEEK_FILTER_TYPE;c[b.BOOKING_CREATED_AT_MONTH_GROUP]=b.BOOKING_CREATED_AT_MONTH_FILTER_TYPE;c[b.BOOKING_CREATED_AT_YEAR_GROUP]=b.BOOKING_CREATED_AT_YEAR_FILTER_TYPE;c[b.BOOKING_CREATED_AT_HOUR_GROUP]=
b.BOOKING_CREATED_AT_HOUR_FILTER_TYPE;c[b.BOOKING_CREATED_AT_WEEKDAY_GROUP]=b.BOOKING_ORIGINAL_CREATED_AT_WEEKDAY_FILTER_TYPE;c[b.AVAILABILITY_START_AT_DAY_GROUP]=b.AVAILABILITY_START_AT_DAY_FILTER_TYPE;c[b.AVAILABILITY_START_AT_WEEK_GROUP]=b.AVAILABILITY_START_AT_WEEK_FILTER_TYPE;c[b.AVAILABILITY_START_AT_MONTH_GROUP]=b.AVAILABILITY_START_AT_MONTH_FILTER_TYPE;c[b.AVAILABILITY_START_AT_YEAR_GROUP]=b.AVAILABILITY_START_AT_YEAR_FILTER_TYPE;c[b.AVAILABILITY_START_AT_HOUR_GROUP]=b.AVAILABILITY_START_AT_HOUR_FILTER_TYPE;
c[b.AVAILABILITY_START_AT_WEEKDAY_GROUP]=b.AVAILABILITY_START_AT_WEEKDAY_FILTER_TYPE;c[b.LINE_ITEM_CREATED_AT_DAY_GROUP]=b.LINE_ITEM_CREATED_AT_DAY_FILTER_TYPE;c[b.LINE_ITEM_CREATED_AT_WEEK_GROUP]=b.LINE_ITEM_CREATED_AT_WEEK_FILTER_TYPE;c[b.LINE_ITEM_CREATED_AT_MONTH_GROUP]=b.LINE_ITEM_CREATED_AT_MONTH_FILTER_TYPE;c[b.LINE_ITEM_CREATED_AT_YEAR_GROUP]=b.LINE_ITEM_CREATED_AT_YEAR_FILTER_TYPE;c[b.LINE_ITEM_CREATED_AT_HOUR_GROUP]=b.LINE_ITEM_CREATED_AT_HOUR_FILTER_TYPE;c[b.LINE_ITEM_CREATED_AT_WEEKDAY_GROUP]=
b.LINE_ITEM_CREATED_AT_WEEKDAY_FILTER_TYPE;c[b.PAYMENT_OR_REFUND_CREATED_AT_DAY_GROUP]=b.PAYMENT_OR_REFUND_CREATED_AT_DAY_FILTER_TYPE;c[b.PAYMENT_OR_REFUND_CREATED_AT_WEEK_GROUP]=b.PAYMENT_OR_REFUND_CREATED_AT_WEEK_FILTER_TYPE;c[b.PAYMENT_OR_REFUND_CREATED_AT_MONTH_GROUP]=b.PAYMENT_OR_REFUND_CREATED_AT_MONTH_FILTER_TYPE;c[b.PAYMENT_OR_REFUND_CREATED_AT_YEAR_GROUP]=b.PAYMENT_OR_REFUND_CREATED_AT_YEAR_FILTER_TYPE;c[b.PAYMENT_OR_REFUND_CREATED_AT_HOUR_GROUP]=b.PAYMENT_OR_REFUND_CREATED_AT_HOUR_FILTER_TYPE;
c[b.PAYMENT_OR_REFUND_CREATED_AT_WEEKDAY_GROUP]=b.PAYMENT_OR_REFUND_CREATED_AT_WEEKDAY_FILTER_TYPE;c[b.CONTACT_LANGUAGE_GROUP]=b.CONTACT_LANGUAGE_FILTER_TYPE;return a}]);h.factory("suggestedReports",["models","reportColumns",function(b,a){var c=b.Report,f=b.SuggestedReport.DEFAULT_SLUG,e=function(a,b){return{slug:b.slug,name:b.name,note:b.note,options:_.defaults({modelName:a.cls},b.options),tags:_.toTrueKeys(b.tags||[])}},g={};g[b.Booking.cls]=[e(b.Booking,{slug:f}),e(b.Booking,{slug:"bookings-by-item",
name:T("Bookings by Item"),note:T("Booking summary grouped by item"),options:{groups:[c.ITEM_GROUP]}}),e(b.Booking,{slug:"bookings-by-user",name:T("Bookings by User"),note:T("Booking summary grouped by most recent booking user, then by item"),options:{groups:[c.USER_GROUP,c.ITEM_GROUP]}}),e(b.Booking,{slug:"source",name:T("Booking Source"),note:T("Online vs affiliate vs direct"),options:{presetDateRange:c.LAST_MONTH_DATE_RANGE,groups:[c.SOURCE_GROUP,c.AFFILIATE_GROUP]}}),e(b.Booking,{slug:"agents",
name:"Agents",note:T("Booking summary grouped by agent"),options:{groups:[c.AFFILIATE_GROUP,c.AGENT_GROUP]},tags:["affiliate"]}),e(b.Booking,{slug:"desks",name:T("Desks"),note:T("Booking summary grouped by desk"),options:{groups:[c.AFFILIATE_GROUP,c.DESK_GROUP]},tags:["affiliate"]}),e(b.Booking,{slug:"lodgings",name:T("Lodgings"),note:T("Booking summary grouped by lodging"),options:{groups:[c.LODGING_GROUP]},tags:["transportation"]}),e(b.Booking,{slug:"pickups",name:T("Pickup Locations"),note:T("Booking summary grouped by pickup location"),
options:{groups:[c.PICKUP_GROUP]},tags:["transportation"]}),e(b.Booking,{slug:"details",name:T("Booking Details"),note:T("Bookings with detailed data"),options:{presetDateRange:c.LAST_WEEK_DATE_RANGE,isDetailed:!0,groups:[],columns:_.extend(c.emptyColumns(),{Booking:_.toTrueKeys([c.BOOKING_ID_COLUMN,c.BOOKING_IS_CANCELLED_COLUMN,c.BOOKING_LAST_REBOOKED_AT_COLUMN,c.BOOKING_BOOKED_BY_COLUMN,c.ITEM_NAME_COLUMN,c.AVAILABILITY_DATETIME_COLUMN,c.CONTACT_NAME_COLUMN,c.CONTACT_PHONE_COLUMN,c.CONTACT_LANGUAGE_COLUMN,
c.CONTACT_EMAIL_COLUMN,c.IS_SUBSCRIBED_TO_EMAIL_COLUMN,c.BOOKING_NOTE_COLUMN,c.CUSTOMER_COUNT_COLUMN,c.ONLINE_BOOKING_REFERENCE_COLUMN,c.TOTAL_COST_PRICE_COLUMN,c.TOTAL_COST_TAX_COLUMN,c.TOTAL_COST_TOTAL_COLUMN,c.COLLECTED_TOTAL_COST_TAX_COLUMN,c.COLLECTED_TOTAL_COST_TOTAL_COLUMN,c.AFFILIATE_COLUMN,c.VOUCHER_COLUMN,c.AGENT_COLUMN,c.DESK_COLUMN,c.INVOICE_COST_TOTAL_COLUMN,c.INVOICED_TO_CHARTER_COLUMN,c.INVOICED_TO_AFFILIATE_COLUMN,c.INVOICEABLE_TO_CHARTER_COLUMN,c.INVOICEABLE_TO_AFFILIATE_COLUMN])})}}),
e(b.Booking,{slug:"future-underpaid",name:T("Underpaid"),note:T("Bookings requiring payment"),options:{presetDateRange:c.NEXT_THIRTY_DAYS_DATE_RANGE,isDetailed:!0,filters:_.extend(c.emptyFilters(),{Booking:[c.defaultBookingCancelledStatusFilter(),{type:c.PAID_STATUS_FILTER_TYPE,data:{value:[b.Booking.UNPAID_PAID_STATUS,b.Booking.UNDERPAID_PAID_STATUS]}}]})}}),e(b.Booking,{slug:"cancelled",name:T("Cancelled"),note:T("Cancelled bookings grouped by item"),options:{presetDateRange:c.LAST_MONTH_DATE_RANGE,
isDetailed:!0,filters:_.extend(c.emptyFilters(),{Booking:[{type:c.CANCELLED_STATUS_FILTER_TYPE,data:{value:[c.UNREFUNDED_CANCELLED_FILTER_OPTION,c.REFUNDED_CANCELLED_FILTER_OPTION]}}]})}})];g[b.Customer.cls]=[e(b.Customer,{slug:f,options:{groups:[c.CUSTOMER_TYPE_GROUP],columns:c.defaultCustomerReportColumns()}}),e(b.Customer,{slug:"customer-types",name:T("Customer Types"),note:T("Customer summary grouped by customer type, then by item"),options:{groups:[c.CUSTOMER_TYPE_GROUP,c.ITEM_GROUP],columns:c.defaultCustomerReportColumns()}})];
g[b.CustomFieldValue.cls]=[e(b.CustomFieldValue,{slug:f,options:{isOpened:!0,groups:[c.CUSTOM_FIELD_VALUE_GROUP],columns:_.extend(c.emptyColumns(),{CustomFieldValue:c.defaultCustomFieldValueColumns()})}})];g[b.LineItem.cls]=[e(b.LineItem,{slug:f,options:{isDetailed:!0}})];g[b.Payment.cls]=[e(b.Payment,{slug:f,options:{isOpened:!0,dateType:c.PAYMENT_OR_REFUND_DATE_TYPE,filters:c.emptyFilters(),groups:[c.PAYMENT_TYPE_GROUP],columns:_.extend(c.emptyColumns(),{Payment:c.defaultPaymentColumns(),Booking:_.toTrueKeys([c.BOOKING_ID_COLUMN,
c.CREATED_AT_COLUMN,c.ITEM_NAME_COLUMN,c.AVAILABILITY_DATETIME_COLUMN])})}}),e(b.Payment,{slug:"sales-by-user",name:T("Sales by User"),note:T("Transactions grouped by user, then payment type"),options:{presetDateRange:c.TODAY_DATE_RANGE,dateType:c.PAYMENT_OR_REFUND_DATE_TYPE,filters:c.emptyFilters(),groups:[c.PAYMENT_USER_GROUP,c.PAYMENT_TYPE_GROUP],columns:_.extend(c.emptyColumns(),{Payment:c.defaultPaymentColumns(),Booking:_.toTrueKeys([c.BOOKING_ID_COLUMN,c.AVAILABILITY_DATETIME_COLUMN])})}}),
e(b.Payment,{slug:"sales-by-availability",name:T("Sales by Availability"),note:T("Transactions grouped by availability, then payment type"),options:{presetDateRange:c.TODAY_DATE_RANGE,dateType:c.PAYMENT_OR_REFUND_DATE_TYPE,filters:c.emptyFilters(),groups:[c.AVAILABILITY_GROUP,c.ITEM_GROUP,c.PAYMENT_TYPE_GROUP],columns:_.extend(c.emptyColumns(),{Payment:c.defaultPaymentColumnsWithTax(),Booking:_.toTrueKeys([c.BOOKING_ID_COLUMN,c.AVAILABILITY_DATETIME_COLUMN])})}}),e(b.Payment,{slug:"sales-by-item",
name:T("Sales by Item"),note:T("Transactions grouped by item"),options:{presetDateRange:c.LAST_THIRTY_DAYS_DATE_RANGE,dateType:c.PAYMENT_OR_REFUND_DATE_TYPE,filters:c.emptyFilters(),groups:[c.ITEM_GROUP],columns:_.extend(c.emptyColumns(),{Payment:c.defaultPaymentColumnsWithTax(),Booking:_.toTrueKeys([c.BOOKING_ID_COLUMN,c.AVAILABILITY_DATETIME_COLUMN])})}}),e(b.Payment,{slug:"revenue-by-type",name:T("Revenue by Type"),note:T("Transactions grouped by accrual status, then payment type, then item"),
options:{presetDateRange:c.TODAY_DATE_RANGE,dateType:c.PAYMENT_OR_REFUND_ACCRUAL_DATE_TYPE,filters:c.emptyFilters(),groups:[c.PAYMENT_ACCRUAL_STATUS_GROUP,c.PAYMENT_TYPE_GROUP,c.ITEM_GROUP],columns:_.extend(c.emptyColumns(),{Payment:c.defaultPaymentColumnsWithTax(),Booking:_.toTrueKeys([c.BOOKING_ID_COLUMN,c.CREATED_AT_COLUMN,c.AVAILABILITY_DATETIME_COLUMN])})}})];return{forCompanies:function(a,b){var c=g[b],e=_.any(a,"affiliatesCount"),f=_.any(a,"features.isTransportationEnabled");e||(c=_.reject(c,
"tags.affiliate"));f||(c=_.reject(c,"tags.transportation"));return c}}}]);h.factory("currentSuggestedReport",["advancedReport","models","navigation","suggestedReports",function(b,a,c,f){return function(e){return{object:null,is:function(a){return this.object&&this.object.slug===a.slug},applySuggestedReport:function(b,c){var h=f.forCompanies(e,c.options.modelName);if(h=_.findWhere(h,{slug:b})){h=_.deepClone(h);_.defaults(h.options,a.Report.defaultReportOptions(e));this.object=h;var m=c.options.isOpened;
c.options=_.deepClone(h.options);m&&(c.options.isOpened=m)}else console.warn("currentSuggestedReport: invalid slug: ",b)},refresh:function(e){this.object&&!b.compareReportOptions(e.options,this.object.options,!1)&&(this.object=null,c.clear(a.SuggestedReport.QUERY_PARAM,!0))}}}}]);h.factory("currentCustomReport",["models","navigation","filterFields","advancedReport",function(b,a,c,f){return function(c){var g=b.Report.emptyReportOptions(c);return{object:null,applyCustomReport:function(a,b){this.object=
a;this.object.isEdited=!1;var c=b.options.isOpened;b.options=_.deepClone(a.options);c&&(b.options.isOpened=c)},is:function(a){return this.object===a},refresh:function(c){this.object&&(_.defaults(this.object.options,g),f.compareReportOptions(c.options,this.object.options,!1)?this.object.isEdited=!f.compareReportOptions(c.options,this.object.options,!0):(this.object=null,a.clear(b.CustomReport.QUERY_PARAM,!0)))}}}}]);h.factory("newReportCache",[function(){var b={};return{getNewReport:function(a){a=
_.pluck(a,"shortname").join(":");b[a]||(b[a]={options:{}});return b[a]}}}]);h.factory("advancedReport",["models","auth","convert","reportColumns","reportFilters","reportGroups",function(b,a,c,f,e,g){var d=b.Report,h=function(a,b,c){b=b[a.key].object;a=c[a.key].object;b&&!b.uri&&(b=b.value||null);a&&!a.uri&&(a=a.value||null);return b===a},m=function(a){var c=d.MODELS[a.options.modelName].submodels;a.options.modelName===b.CustomFieldValue.cls&&a.options.customFieldValueModel==b.BookingCustomFieldValue.cls&&
(c=_.without(c,b.Customer));return c},k=function(a,b){if(b.cls===a.options.modelName)return!0;var c=m(a);return _.contains(c,b)};return{transformReportOptions:function s(a){return _.transform(a,function(a,c,d){"companies"===d?(a[d]=_.keyBy(c,"company.pk",s),a.selectedCharters=_.mapValues(a[d],_.property("selectedAsCharter")),a.selectedAffiliates=_.mapValues(a[d],_.property("selectedAsAffiliate"))):"partners"===d?(a[d]=_.keyBy(c,"partner.pk",s),a.selectedPartners=_.toTrueKeys(c,"partner.pk")):"selectedAllPartners"===
d?a[d]=!!c:_.isModelObject(c)?a[d]=c.cls===b.Company.cls?c.shortname:parseInt(c.pk,10):"startAt"===d&&c?a.startDate=c.clone().format("YYYY-MM-DD"):"endAt"===d&&c?a.endDate=c.clone().format("YYYY-MM-DD"):_.isObject(c)?a[d]=s(c):a[d]=c})},buildGroupSets:function(a){if(a.data){var b=[],c=[];b.push(c);var d;_.forEach(a.data.groups,function(e){1<a.data.groupings.length&&!_.all(a.data.groupings,function(b,c){return!d||c===a.data.groupings.length-1?!0:h(b,e,d)})&&(c=[],b.push(c));c.push(e);d=e});return b}},
compareGroupsByGroupingObject:h,generateColumnVisibility:function(a){var b={};_.forEach(d.VALID_COLUMNS,function(c,d){_.forEach(c,function(c){var e=c[0],f=c[1];c=c[2];if(_.contains((a.options.columns||{})[d],e))b[d+"-"+e]=c&&a.options.isDetailed||f&&!a.options.isDetailed})});return b},compareReportOptions:function(a,b,c){return _.deepEquals(a,b,function(d,e,f){if("isOpened"===f)return!0;if(c){if(("startDate"===f||"endDate"===f)&&a.presetDateRange)return a.presetDateRange===b.presetDateRange}else if("startDate"===
f||"endDate"===f||"presetDateRange"==f)return!0})},relevantCompanies:function(b){var c=_.filter(a.relatedCompanies(),function(b){return a.permissions.can("viewAdvancedType",d,b)});return _.unique(_.append([b],c))},isCoveredByReport:k,reportModelWithSubmodels:function(a){var c=b[a.options.modelName];a=m(a);return _.union([c],a)},isGroupCoveredByReport:function(a,b){return _.any(d.MODELS_BY_GROUP[b],function(b){return k(a,b)})},columnName:function(a){return f.names[a]||c.humanize(a,!0)},filterName:function(a,
b){var d=e[a];return d&&_.isString(d.name)?d.name:d&&_.isFunction(d.name)?d.name(b):c.humanize(a,!0)},groupName:function(a){return g.names[a]||c.humanize(a,!0)}}}]);h.factory("advancedPermissions",["models","auth","db",function(b,a,c){var f=b.Report,e={"can-view-amounts":[b.Company,"viewAmounts"],"can-admin":[b.Company,"viewAdminSection"],"can-view-booking-note":[b.Booking,"viewBookingNote"],"can-view-availability-private-headline":[b.Availability,"reportOn"],"can-list-checkin-statuses":[b.CheckinStatus,
"list"],"can-view-private-custom-fields":[b.CustomField,"viewPrivate"],"can-list-line-items":[b.LineItem,"reportOn"],"can-list-resources":[b.Resource,"list"],"can-list-crew-members":[b.CrewMember,"list"],"can-list-total-sheets":[b.TotalSheet,"reportOn"],"can-list-invoice-sheets":[b.InvoiceSheet,"reportOn"]},g=c.slipstream("reports.groupPermissions"),d=c.slipstream("reports.columnPermissions"),h=c.slipstream("reports.filterPermissions"),m={},k=function(a,b){var c=b[a];return!c?!0:m[c]},n=function(b){_.forEach(e,
function(c,d){var e=c[0],f=c[1],e="list"===f?a.permissions.canList(e,b):a.permissions.can(f,e,b),f=m[d];_.isUndefined(f)&&(f=!0);m[d]=!(!f||!e)})};return{permitFilter:function(a){return k(a,h)},permitColumn:function(a){return k(a,d)},permitGroup:function(a){return k(a,g)},updateCompanies:function(a){_.clear(m);_.forEach(a,n)},permitPartner:function(b){return a.permissions.can("report",f,b)}}}]);h.factory("reports",["$filter","$timeout","controllers","models","navigation","require","urls",function(b,
a,c,f,e,g,d){var h=b("amount");return{formatAmount:function(a,b){var c=0>a;a=Math.abs(a);var d=h(a,b,!1,!1);return c?"-"+d:d},reportController:function(b,c){g.inScope(b,"company","dashboard.reports.services.reportController");b.status="loading";b.isProcessing=!1;b.$watch(function(){return b.report?[b.report.uri,b.report.status]:["",""]},function(){b.report?(b.status="success",b.report.status===f.Report.SUCCEEDED_STATUS&&(b.isProcessing=!0,a(function(){b.isProcessing=!1;c.process(b.report)}))):b.status=
"loading"},!0)},viewController:function(a,b){return c.dataController(a,b)}}}]);h.factory("summaryReportController",["$timeout","auth","models","reports","urls",function(b,a,c,f,e){return function(a,c){c=c||{};a.AVAILABILITIES_DETAIL_VIEW="availabilities";a.BOOKINGS_DETAIL_VIEW="bookings";a.needsAvailabilityCount=!!c.needsAvailabilityCount;a.needsCustomerCount=!!c.needsCustomerCount;a.needsUseCount=!_.isUndefined(c.getUseCount);a.elementHeader=c.elementHeader;a.itemsOnly=_.isUndefined(c.getElements);
a.useCountHeader=_.isUndefined(c.useCountHeader)?T("Uses"):c.useCountHeader;var e=function(a){var b={};_.forEach("availabilityCount bookingCount customerCount useCount price tax total netCharterRevenue invoiceableToCharter invoiceableToAffiliate grossCollectedByCharter grossCollectedByAffiliate".split(" "),function(c){b[c]=a.length?_.sum(_.pluck(a,c)):0});return b},h=function(a,b){var e=[],f;(f=a.totals&&b===a.totals?a.totals:c.getItemAggregates?c.getItemAggregates(a,b):a.aggregates)&&_.forEach(a.items,
function(a){var b=f[a.uri];if(b){var g=b.bookingCount,h=c.getUseCount?c.getUseCount(b):g;e.push({item:a,availabilityCount:b.availabilityCount,bookingCount:g,customerCount:b.customerCount,useCount:h,price:b.price,tax:b.tax,total:b.total,netCharterRevenue:b.netCharterRevenue,invoiceableToCharter:b.invoiceableToCharter,invoiceableToAffiliate:b.invoiceableToAffiliate,grossCollectedByCharter:b.grossCollectedByCharter,grossCollectedByAffiliate:b.grossCollectedByAffiliate,availabilities:b.availabilityValues,
bookings:b.bookingValues,dailyAggregates:b.dailyAggregates})}});return e},k=function(a,b){var f=h(a,b),g=e(f),k=f.slice();k.push(g);var n;n=a.totals&&b===a.totals?T("totals"):c.getElementName?c.getElementName(a,b):b?b.name||b:T("none");return{element:b,elementName:n,allRows:k,rows:f,summaryRow:g}},n=function(a){a=_.map(a,function(a){return a.summaryRow.total});return _.reduce(a,function(a,b){return a+b})},s=function(a){var b=n(a),b=Math.max(b,0);_.forEach(a,function(a){_.forEach(a.allRows,function(a){var c=
Math.max(a.total,0),c=b?100*(c/b):0,c=_.roundHalfToEven(c,2);a.percentTotalSales=c})})},p=function(a){var b=[];if(c.getElements){var e=c.getElements(a);_.forEach(e,function(c){c=k(a,c);c.summaryRow.bookingCount&&b.push(c)})}else e=k(a),e.summaryRow.bookingCount&&b.push(e);b.length&&s(b);return b};a.showDetails=function(c,d,e){a.status="processing";b(function(){a.selectedSubreport=c;a.selectedRow=d;a.detailView=e;a.status="success"})};a.showSummary=function(){a.selectedSubreport=null;a.selectedRow=
null;a.detailView=null};f.reportController(a,{process:function(b){a.selectedRow=null;a.selectedSubreport=null;a.detailView=null;a.currency=b.options.partnerFilter?b.options.partnerFilter.processorCurrency:b.company.processorCurrency;a.subreports=p(b.data);1<a.subreports.length?(a.totalsSubreport=k(b.data,b.data.totals),s([a.totalsSubreport])):a.totalsSubreport=null}})}}]);h.factory("legacyReportDefinitions",["db","models","urls",function(b,a,c){var f=function(a,b){a=a||30;var c=moment(),e=c.clone().subtract("days",
a);return _.extend({startDate:e.format("YYYY-MM-DD"),endDate:c.format("YYYY-MM-DD")},b)},e=function(a){var b=moment().format("YYYY-MM-DD");return _.extend({startDate:b,endDate:b},a)};b={overview:{displayType:T("Overview"),urls:c.dashboard.reports.index},test:{displayType:T("Test"),urls:c.dashboard.reports.test,endpoint:b.testReport,needsGenerate:!0,needsDateRange:!0,defaultOptions:function(){return f(60)}},reports:{displayType:T("Reports"),urls:c.dashboard.reports.reports,endpoint:b.reports.report,
needsGenerate:!0},bookings:{displayType:T("Detailed Bookings"),urls:c.dashboard.reports.bookings,endpoint:b.bookings.report,needsGenerate:!0,needsCancelledBookingsFilter:!0,needsDateType:!0,needsDateRange:!0,needsUserFilter:!0,needsIsDetailed:!0,isDetailedMessage:T("Export payments and custom fields"),needsIncludeDetailedContactInformation:!0,needsIncludeOnlineBookingReference:!0,needsPrint:!0,helpLink:"/help/reporting/reports/detailed-bookings/",defaultOptions:function(){return e({affiliateFilter:a.Report.DIRECT_AFFILIATE_FILTER_OPTION,
userFilter:a.Report.ALL_USER_FILTER_OPTION})}},invoices:{displayType:T("View invoices"),urls:c.dashboard.reports.invoices,endpoint:b.invoices.report,needsGenerate:!0,needsDateRange:!0,needsPrint:!0,defaultOptions:function(){return f(30)}},invoiceView:{displayType:T("Invoices"),urls:c.dashboard.reports.invoices.invoice.index,needsPrint:!0},invoiceMultiView:{displayType:T("Invoices"),urls:c.dashboard.reports.invoices.invoice.multi,needsPrint:!0},partnerInvoiceView:{displayType:T("Partner Invoices"),
urls:c.dashboard.reports.invoices.partnerInvoice.index,needsPrint:!0},"invoiceable-bookings":{displayType:T("Create Invoices"),urls:c.dashboard.reports.invoices.create,endpoint:b.bookings.invoiceableReport,needsGenerate:!0,needsDateRange:!0,needsCancelledBookingsFilter:!0,noAffiliateDirectOption:!0,defaultOptions:function(){var b=moment().subtract("months",1).startOf("month"),c=b.clone().add("months",1).subtract("days",1);return{startDate:b.format("YYYY-MM-DD"),endDate:c.format("YYYY-MM-DD"),affiliateFilter:a.Report.ALL_AFFILIATE_FILTER_OPTION}},
overrideOptions:function(){return{affiliateFilter:a.Report.ALL_AFFILIATE_FILTER_OPTION}}},contacts:{displayType:T("Contacts"),urls:c.dashboard.reports.contacts,endpoint:b.contacts.report,needsAffiliateFilter:!0,needsCancelledBookingsFilter:!0,needsDateType:!0,needsDateRange:!0,needsGenerate:!0,needsItemFilter:!0,needsPrint:!0,needsUserFilter:!0,helpLink:"/help/reporting/reports/contacts/",defaultOptions:function(){return f(90,{itemFilter:a.Report.ALL_ITEM_FILTER_OPTION})}},"line-items":{displayType:T("Expenses and Discounts"),
urls:c.dashboard.reports.lineItems,endpoint:b.lineItems.report,needsGenerate:!0,needsDateRange:!0,needsDateType:!0,needsCancelledBookingsFilter:!0,needsTextFilter:!0,needsPrint:!0,defaultOptions:function(){return e()}},payments:{displayType:T("Payments Summary"),urls:c.dashboard.reports.payments,endpoint:b.payments.report,needsGenerate:!0,needsDateRange:!0,needsReferenceDate:!0,needsIsDetailed:!0,needsPrint:!0,isDetailedMessage:T("Include bookings"),defaultOptions:function(){return e()}},disputes:{displayType:T("Disputes"),
urls:c.dashboard.reports.disputes,endpoint:b.disputes.report,needsGenerate:!0,needsDateRange:!0,needsDateType:!0,needsDisputeDateTypeOption:!0,needsPaymentDateTypeOption:!0,needsDisputeStatusFilter:!0,needsPrint:!0,helpLink:"/help/reporting/types/credit-card-disputes/",helpText:T("Learn about disputes"),defaultOptions:function(){return f(90,{disputeStatusFilter:a.Report.ALL_DISPUTE_STATUS_FILTER_OPTION,dateType:a.Report.DISPUTE_DATE_TYPE})}},transactions:{displayType:T("Transactions"),urls:c.dashboard.reports.transactions,
endpoint:b.transactions.report,needsGenerate:!0,needsDateRange:!0,needsTransactionTagFilter:!0,needsPrint:!0,defaultOptions:function(){return e({transactionTagFilter:a.Report.ALL_TRANSACTION_TAG_FILTER_OPTION})}},volume:{displayType:cT("Volume as in quantity","Volume"),urls:c.dashboard.reports.volume,endpoint:b.payments.volumeReport,needsGenerate:!0,needsDateRange:!0,needsCurrencyFilter:!0,needsPrint:!0,defaultOptions:function(){var a=moment(),b=a.clone().startOf("month");a.diff(b,"days")||b.subtract("months",
1);return _.extend({startDate:b.format("YYYY-MM-DD"),endDate:a.format("YYYY-MM-DD")},void 0)}},accounts:{displayType:T("Transfers"),urls:c.dashboard.reports.accounts,endpoint:b.company.accounts.report,needsGenerate:!0,needsDateRange:!0,needsAccountTabs:!0,needsPrint:!0,helpLink:"/help/payments/refunds/",helpText:T("Learn about refunds"),defaultOptions:function(){return f(90)}},transferView:{displayType:T("Accounts"),urls:c.dashboard.reports.accounts.transfer,needsPrint:!0},uploadView:{displayType:T("Accounts"),
urls:c.dashboard.reports.accounts.upload,needsPrint:!0},payouts:{displayType:T("Payouts"),urls:c.dashboard.reports.payouts,endpoint:b.payouts.report,needsGenerate:!0,needsDateRange:!0,needsAccountTabs:!0,needsPrint:!0,helpLink:"/help/reporting/types/payouts/",defaultOptions:function(){return f(30)}},payoutView:{displayType:T("Payouts"),urls:c.dashboard.reports.payouts.payout,needsPrint:!0},escrow:{displayType:T("Future Payouts"),urls:c.dashboard.reports.escrow,endpoint:b.company.escrowReport,needsAccountTabs:!0,
needsPrint:!0,helpLink:"/help/reporting/types/payouts/"},companies:{displayType:T("Companies"),urls:c.dashboard.reports.companies,endpoint:b.companies.report,needsGenerate:!0,needsDateRange:!0,needsIncludeCompaniesWithNoActivity:!0,needsIncludeBalances:!0,needsIncludeConnected:!0,needsIncludePaymentsAndRefunds:!0,needsIncludePaymentSettings:!0,needsSalespersonFilter:!0,needsPrint:!0,defaultOptions:function(){return e({salespersonFilter:a.Report.ALL_SALESPERSON_FILTER_OPTION})}},"booking-types-summary":{displayType:T("Booking Sources"),
urls:c.dashboard.reports.bookingTypesSummary,endpoint:b.company.summaryReport.bookingTypes,needsGenerate:!0,needsDateRange:!0,needsDateType:!0,needsCancelledBookingsFilter:!0,needsPrint:!0},"items-summary":{displayType:T("Bookings by Item"),urls:c.dashboard.reports.itemsSummary,endpoint:b.company.summaryReport.items,needsGenerate:!0,needsDateRange:!0,needsDateType:!0,needsCancelledBookingsFilter:!0,needsPrint:!0},"users-summary":{displayType:T("Bookings by User"),urls:c.dashboard.reports.usersSummary,
endpoint:b.company.summaryReport.users,needsGenerate:!0,needsDateRange:!0,needsDateType:!0,needsCancelledBookingsFilter:!0,needsUserTypeFilter:!0,needsPrint:!0},"crew-summary":{displayType:T("Crew"),urls:c.dashboard.reports.crewSummary,endpoint:b.company.summaryReport.crew,needsGenerate:!0,needsDateRange:!0,needsDateType:!0,needsCancelledBookingsFilter:!0,needsPrint:!0},"agents-summary":{displayType:T("Agents"),urls:c.dashboard.reports.agentsSummary,endpoint:b.company.summaryReport.agents,needsGenerate:!0,
needsDateRange:!0,needsDateType:!0,needsCancelledBookingsFilter:!0,needsPrint:!0},"desks-summary":{displayType:T("Desks"),urls:c.dashboard.reports.desksSummary,endpoint:b.company.summaryReport.desks,needsGenerate:!0,needsDateRange:!0,needsDateType:!0,needsCancelledBookingsFilter:!0,needsPrint:!0},"campaigns-summary":{displayType:T("Campaigns"),urls:c.dashboard.reports.campaignsSummary,endpoint:b.company.summaryReport.campaigns,needsGenerate:!0,needsDateRange:!0,needsDateType:!0,needsCancelledBookingsFilter:!0,
needsPrint:!0,helpLink:"/help/reporting/types/campaigns/"},"customer-types-summary":{displayType:T("Customer Types"),urls:c.dashboard.reports.customerTypesSummary,endpoint:b.company.summaryReport.customerTypes,needsGenerate:!0,needsDateRange:!0,needsDateType:!0,needsCancelledBookingsFilter:!0,needsCustomerType:!0,needsPrint:!0},"custom-field-summary":{displayType:T("Custom Field Uses"),urls:c.dashboard.reports.customFieldSummary,endpoint:b.company.summaryReport.customField,needsGenerate:!0,needsDateRange:!0,
needsDateType:!0,needsCancelledBookingsFilter:!0,needsCustomField:!0,needsPrint:!0,helpLink:"/help/reporting/types/legacy/custom-field-use/"},"lodgings-summary":{displayType:T("Lodging"),urls:c.dashboard.reports.lodgingsSummary,endpoint:b.company.summaryReport.lodgings,needsGenerate:!0,needsCancelledBookingsFilter:!0,needsDateRange:!0,needsDateType:!0,needsPrint:!0},"pickups-summary":{displayType:T("Pickup Locations"),urls:c.dashboard.reports.pickupsSummary,endpoint:b.company.summaryReport.pickups,
needsGenerate:!0,needsCancelledBookingsFilter:!0,needsDateRange:!0,needsDateType:!0,needsPrint:!0},"revenue-summary":{displayType:T("Revenue by Type"),urls:c.dashboard.reports.revenueSummary,endpoint:b.company.summaryReport.revenue,needsGenerate:!0,needsDateRange:!0,needsUserFilter:!0,needsPrint:!0,helpLink:"/help/reporting/types/revenue-by-type/",defaultOptions:function(){return e()}}};_.forEach(b,function(a,b){a.type=b});return b}]);h.factory("legacyReportPermalink",["legacyReportDefinitions","urls",
function(b,a){return function(c){var f=b[c.type];if(!f)return"";if(f.urls&&f.urls.permalink)return a.populate(f.urls.permalink,{shortname:c.company.shortname,reportPk:c.pk})}}])})();angular.module("dashboard.settings","dashboard.settings.translations dashboard.settings.pricing dashboard.settings.storedValue dashboard.settings.reseller dashboard.settings.seating dashboard.settings.ticketLayouts dashboard.settings.controllers dashboard.settings.directives".split(" "));
(function(){var h=angular.module("dashboard.settings.controllers",["db.services","lib.factories","lib.services","navigation.services"]);h.controller("dashboard.settings.IndexCtrl",["$scope","db","navigation","require","urls",function(a,b,f,e,g){e.notNull(f,"currentCompany");a.company=b.company({shortname:a.route.bindings.shortname})}]);h.controller("dashboard.settings.ConnectCtrl",["$scope","controllers","db","models","require","sonar",function(a,b,f,e,g,d){g.inScope(a,"company","dashboard.settings.ConnectCtrl");
a.connect=function(b){b.isConnecting=!0;var c=f.resellerAppRequests.create({shortname:a.company.shortname},{resellerApp:b.resellerApp.pk,status:e.ResellerAppRequest.PENDING_STATUS},null,null,{flashError:!0});c.$promise.then(function(){b.resellerAppRequest=c}).finally(function(){b.isConnecting=!1;d.watch(a,c,"connected",function(a){d.get(a.uri)})})};a.remove=function(b){f.resellerAppRequest.remove({shortname:a.company.shortname,resellerAppRequestPk:b.resellerAppRequest.pk}).$promise.then(function(){b.resellerAppRequest=
null})};a.completeConnection=function(b){f.resellerAppRequest.update({shortname:a.company.shortname,resellerAppRequestPk:b.resellerAppRequest.pk},{resellerApp:b.resellerApp.pk,status:e.ResellerAppRequest.CONNECTED_STATUS})};var h=f.resellerAppRequests({shortname:a.company.shortname}),m=function(){var g=f.resellerApps({shortname:e.Company.ADMIN_SHORTNAME});b.dataController(a,{promises:[g.$promise,h.$promise],successCallback:function(){var b=_.filter(g,"isConnectEnabled");a.requests=_.map(b,function(a){var b=
_.find(h,function(b){return b.resellerApp===a});return{isConnecting:!1,resellerApp:a,resellerAppRequest:b||null}});h.length&&d.watch(a,h,"connected",function(a){d.get(a.uri)})}})};m();a.refreshConnections=function(){h=f.resellerAppRequests.refresh({shortname:a.company.shortname});m()}}]);h.controller("dashboard.settings.CannedMessagesCtrl",["$scope","controllers","db","navigation","require","models","events",function(a,b,f,e,g,d,h){g.notNull(e,"currentCompany");a.TYPES=d.CannedMessage.TYPES;a.displayType=
d.CannedMessage.displayType;a.cannedMessages=f.cannedMessages({shortname:e.currentCompany.shortname});a.cannedMessagesByType={};var m=function(){var b={};_.forEach(a.TYPES,function(a){b[a]=[]});_.forEach(a.cannedMessages,function(a){b[a.type].push(a)});_.overwrite(a.cannedMessagesByType,b)};h.on(a,"dashboard.shared.CannedMessageEditableCtrl.updated",function(){m()});return b.dataController(a,{promises:[a.cannedMessages.$promise],successCallback:function(){a.$watch(function(){return a.cannedMessages.length},
function(){m()});b.listController(a,{collectionKey:"cannedMessages",modelKey:"newCannedMessage",get:f.cannedMessages,params:function(){return{shortname:e.currentCompany.shortname}},defaultModel:{type:d.CannedMessage.MESSAGE_TYPE,name:"",message:""},sortable:!0,reorderCallback:function(){m()}})}})}]);h.controller("dashboard.settings.CannedMessageCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");a.cannedMessage=f.cannedMessage({shortname:e.currentCompany.shortname,
cannedMessagePk:a.route.bindings.cannedMessagePk});b.dataController(a,{promises:[a.cannedMessage.$promise]})}]);h.controller("dashboard.settings.InStorePaymentTypesCtrl",["$scope","controllers","db","navigation","require","controllers",function(a,b,f,e,g){g.inScope(a,"company","dashboard.settings.InStorePaymentTypesCtrl");a.inStorePaymentTypes=f.inStorePaymentTypes({shortname:a.company.shortname});return b.dataController(a,{promises:[a.inStorePaymentTypes.$promise],successCallback:function(){b.listController(a,
{collectionKey:"inStorePaymentTypes",modelKey:"newInStorePaymentType",create:f.inStorePaymentTypes.create,params:function(){return{shortname:a.company.shortname}},defaultModel:{name:"",shortName:"",prefix:T("paid with"),isLegalTender:!1,isVisibleWhenCollectedByCharter:a.company.isCharter,isVisibleWhenCollectedByAffiliate:a.company.isAffiliate&&!a.company.isCharter},sortable:!0})}})}]);h.controller("dashboard.settings.EmvDevicesCtrl",["$scope","$q","controllers","db","events","emv","require",function(a,
b,f,e,g,d,h){h.inScope(a,"company","dashboard.settings.EmvDevicesCtrl");a.discoveredEmvDevices=[];var m=d.discoverEmvDevices(a.company);return f.dataController(a,{promises:[m],successCallback:function(){m.then(function(b){_.overwrite(a.discoveredEmvDevices,b);f.listController(a,{modelKey:"newEmvDevice",refreshActivities:!0,create:e.emvDevices.create,successCallback:function(b){m=d.discoverEmvDevices(a.company);m.then(function(b){_.overwrite(a.discoveredEmvDevices,b)})},params:function(){return{shortname:a.company.shortname}},
defaultModel:{providerType:"stripe"}})})}})}]);h.controller("dashboard.settings.BankAccountsCtrl",["$scope","auth","controllers","db","events","models","navigation","processors","require","controllers",function(a,b,f,e,g,d,h,m,k){k.inScope(a,"company","dashboard.settings.BankAccountsCtrl");a.bankAccounts=e.bankAccounts({shortname:a.company.shortname});return f.dataController(a,{promises:[a.bankAccounts.$promise],successCallback:function(){var h="",k="",l=function(d,e,f){e=e||_.ignore;f=f||_.ignore;
d.all||(d.all={});d.all.$error={$tokenization:[]};var g={company:a.company.shortname},l=m.DEFAULT_PROCESSOR_TYPE;b.permissions.canAdminUpdate(a.company)&&(l=a.company.defaultProcessorType);m.get(l).tokenizeBankAccount(a.company,a.newBankAccount,g).then(function(b){_.extend(a.newBankAccount,b);h=a.newBankAccount.accountNumber;k=a.newBankAccount.accountNumber2;a.newBankAccount.accountNumber=m.SECRET_FIELD;a.newBankAccount.accountNumber2=m.SECRET_FIELD;return e()},function(a){_.forEach(a,function(a){d.all.$error.$tokenization.push(a)});
d.all.$error.$tokenization.length||d.all.$error.$tokenization.push(m.ERRORS.GENERIC_BANK_ACCOUNT);return f()})};a.accountNumbersMatch=!0;a.routingNumbersMatch=!0;a.showNumbersMismatchError=!1;a.routingNumberRegex=/^[\S]+$/;a.submit=function(b){b.all||(b.all={$error:{}});!a.accountNumbersMatch||!a.routingNumbersMatch?a.showNumbersMismatchError=!0:(b.$submitting=!0,l(b,function(){a.listCtrl.submit(b)},function(){b.$submitting=!1}))};var r=function(){a.showNumbersMismatchError=!1;a.accountNumbersMatch=
a.newBankAccount.accountNumber2===a.newBankAccount.accountNumber},t=function(){a.showNumbersMismatchError=!1;a.routingNumbersMatch=a.newBankAccount.routingNumber2===a.newBankAccount.routingNumber};a.$watch("newBankAccount.accountNumber",r);a.$watch("newBankAccount.accountNumber2",r);a.$watch("newBankAccount.routingNumber",t);a.$watch("newBankAccount.routingNumber2",t);a.$watch("newBankAccount.processorCountry",function(){var b=a.newBankAccount.processorCountry;a.isVerificationEnabledForBankAccountCountry=
m.isVerificationEnabledForBankAccountCountry(a.company.defaultProcessorType,a.company.processorCountry,b);var c=d.BankAccount.ROUTING_NUMBER_REGEX_BY_COUNTRY[b];c&&(a.routingNumberRegex=c);a.isIbanRequired=d.BankAccount.isIbanRequired(b);a.isRoutingNumberRequired=d.BankAccount.isRoutingNumberRequired(b)});var v=function(){1===a.supportedBankAccountCountryChoices.length&&(a.newBankAccount.processorCountry=a.supportedBankAccountCountryChoices[0][0])};a.setSupportedBankAccountCountryChoices=function(){var b=
m.supportedBankAccountCountries(a.company.defaultProcessorType,a.company.processorCountry,a.company.processorCurrency);a.supportedBankAccountCountryChoices=_.map(b,function(a){return _.find(d.Company.COUNTRIES,function(b){return b[0]===a})});v()};f.listController(a,{collectionKey:"bankAccounts",modelKey:"newBankAccount",create:e.bankAccounts.create,params:function(){return{shortname:a.company.shortname}},successCallback:function(){g.broadcast("dashboard.shared.ActivitiesCtrl.refresh");v()},errorCallback:function(){a.newBankAccount.accountNumber=
h;a.newBankAccount.accountNumber2=k},defaultModel:{accountHolderType:d.BankAccount.INDIVIDUAL_ACCOUNT_HOLDER_TYPE,accountHolderName:"",routingNumber:"",routingNumber2:"",accountNumber:"",accountNumber2:"",processorCountry:""},sortable:!0})}})}]);h.controller("dashboard.settings.RefundReserveActionsCtrl",["$scope","controllers","db","navigation",function(a,b,f,e){a.actionsCtrl={NONE:"none",ONE_TIME_TRANSFER:"one-time-transfer",RECURRING_TRANSFER:"recurring-transfer"};a.actionsCtrl.selected=a.actionsCtrl.NONE;
"open"===e.get("recurring-transfer-form")&&(a.actionsCtrl.selected=a.actionsCtrl.RECURRING_TRANSFER,e.clear("recurring-transfer-form",!0));a.actionsCtrl.select=function(b){a.actionsCtrl.selected=b};a.actionsCtrl.reset=function(){a.actionsCtrl.selected=a.actionsCtrl.NONE};a.actionsCtrl.isSelected=function(b){return a.actionsCtrl.selected===b}}]);h.controller("dashboard.settings.RefundReserveCtrl",["$scope","controllers","db","reports","require",function(a,b,f,e,g){g.inScope(a,"company","dashboard.settings.RefundReserveCtrl");
a.isProjectedRefundReserveRecurringTransferAmountLoaded=!1;a.accounts=f.company.accounts({shortname:a.company.shortname});a.bankAccounts=f.bankAccounts({shortname:a.company.shortname});f.upcomingRefundReserveAmount({shortname:a.route.bindings.shortname}).$promise.then(function(b){a.company.projectedUpcomingRefundReserveRecurrentTransferAmount=b.data.upcomingRefundReserveAmount;a.isProjectedRefundReserveRecurringTransferAmountLoaded=!0});b.dataController(a,{promises:[a.accounts.$promise,a.bankAccounts.$promise]});
e.reportController(a,{process:function(b){a.transfers=b.data.transfers;a.uploads=b.data.uploads}})}]);h.controller("dashboard.settings.TransfersCtrl",["$scope","auth","controllers","db","flash","models","navigation","processors","require","urls",function(a,b,f,e,g,d,h,m,k,n){k.inScope(a,"company","dashboard.settings.TransfersCtrl");k.inScope(a,"bankAccounts","dashboard.settings.TransfersCtrl");a.bankAccounts=_.filter(a.bankAccounts,function(a){return a.isUploadsEnabled});a.directionChoices={TO_DEPOSIT:"to-deposit",
FROM_DEPOSIT:"from-deposit",BANK_TO_REFUND_RESERVE:"bank-to-refund-reserve",BANK_TO_FH:"bank-to-FH"};a.canTransferBankToRefundReserve=function(){return b.permissions.can("createDirectType",d.Upload,a.company)&&b.permissions.can("editAccounting",a.company)};f.listController(a,{elementKey:"oneTimeTransfer",modelKey:"newOneTimeTransfer",create:e.oneTimeTransfer.create,params:function(){return{shortname:a.company.shortname}},successCallback:function(a){a.transfer&&h.navigate(a.transfer.$url(n.dashboard.reports.accounts.transfer));
a.upload&&h.navigate(a.upload.$url(n.dashboard.reports.accounts.upload))},defaultModel:{direction:"to-deposit","transfer-processorType":m.DEFAULT_PROCESSOR_TYPE,"upload-bankAccount":a.bankAccounts.length?a.bankAccounts[0].pk:""}})}]);h.controller("dashboard.settings.CardsCtrl",["$scope","auth","controllers","db","models","navigation","paymentController","urls",function(a,b,f,e,g,d,h,m){var k={};a.submitting=!1;a.isShowCardFields=!0;a.cards=e.cards({shortname:a.company.shortname});f.dataController(a,
{promises:[a.cards.$promise]});var n=_.ignore,s=function(){a.paymentCtrl.restoreCard();p();n();a.submitting=!1};f.listController(a,{collectionKey:"cards",modelKey:"newCard",get:e.cards,sortable:!0,params:{shortname:a.company.shortname},defaultModel:k,successCallback:function(b){p();n();a.submitting=!1;d.navigate(b.$url(m.dashboard.settings.payments.cards.card.index))},errorCallback:s});var p=function(){h(a,{modelKey:"newCard",company:a.company,isInfoRequired:!0,isPostalCodeRequired:!0,swipe:!0,isCompany:!0,
isAffiliate:!1,isAnonymous:!1,gross:_.constant(0),bookingFee:_.constant(0),invoicePrice:_.constant(0),isRebooking:!1,isDemo:!1});_.extend(k,a.paymentCtrl.chargeDefaults())};p();a.submit=function(b){a.submitting=!0;a.paymentCtrl.saveCard();a.$asyncApply(function(c){n=c;a.paymentCtrl.createToken(b,function(){return a.listCtrl.submit(b)},function(){s()})})}}]);h.controller("dashboard.settings.CardCtrl",["$scope","controllers","db","flash","navigation","paymentController","urls",function(a,b,f,e,g,d,
h){a.card=f.card({shortname:a.company.shortname,cardPk:a.route.bindings.cardPk});b.dataController(a,{promises:[a.card.$promise]})}]);h.controller("dashboard.settings.CardEditableCtrl",["$scope","controllers","db","flash","navigation","paymentController","require","urls",function(a,b,f,e,g,d,h,m){h.inScope(a,"card","dashboard.settings.CardEditableCtrl");var k={},n=_.ignore,s=function(){a.paymentCtrl.restoreCard();p()},p=function(){a.card.kind="defer";r();n();a.submitting=!1};b.editController(a,{elementKey:"card",
modelKey:"editableCard",update:f.card.update,remove:f.card.remove,editing:!0,refreshActivities:!0,modelFields:["cardholdersName","isInactive","name","kind"],successCallback:function(){p();g.redirect(a.card.$url(m.dashboard.settings.payments.cards.card.settings))},errorCallback:s,removeCallback:function(){e.success(interpolate(T("Deleted %(creditCardName)s"),{creditCardName:a.card.name}));g.navigate(a.card.company.$url(m.dashboard.settings.payments.cards.index))},params:{shortname:a.card.company.shortname,
cardPk:a.card.pk}});var r=function(){d(a,{modelKey:"editableCard",company:a.company,isInfoRequired:!0,isPostalCodeRequired:!0,swipe:!0,isCompany:!0,isAffiliate:!1,isAnonymous:!1,gross:_.constant(0),bookingFee:_.constant(0),invoicePrice:_.constant(0),isRebooking:!1,isDemo:!1});_.extend(k,a.paymentCtrl.chargeDefaults())};r();a.replace=function(b){a.submitting=!0;a.paymentCtrl.saveCard();a.$asyncApply(function(c){n=c;a.paymentCtrl.createToken(b,function(){return a.editCtrl.submit(b)},function(){s()})})}}]);
h.controller("dashboard.settings.CardAffiliationsCtrl",["$scope","controllers","db","events","require",function(a,b,f,e,g){a.affiliates=f.affiliates({shortname:a.company.shortname});a.partners=f.partners({shortname:a.company.shortname});a.cardAffiliations=f.cardAffiliations({shortname:a.company.shortname,cardPk:a.card.pk});b.dataController(a,{promises:[a.affiliates.$promise,a.partners.$promise,a.cardAffiliations.$promise],successCallback:function(){a.subFormDataForCardAffiliations={};var b=[].concat(a.affiliates,
a.partners);_.forEach(b,function(b){var c=_.find(a.cardAffiliations,function(a){return a.affiliation===b})||{};a.subFormDataForCardAffiliations["affiliation-"+b.pk+"-isCompanyPaymentMethod"]=!!c.isCompanyPaymentMethod;a.subFormDataForCardAffiliations["affiliation-"+b.pk+"-isShared"]=!!c.isShared})}});a.submit=function(b){f.cardAffiliations.create({shortname:a.company.shortname,cardPk:a.card.pk},a.subFormDataForCardAffiliations,b).$promise.then(function(){b.$setPristine();e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")})}}]);
h.controller("dashboard.settings.TagGroupsCtrl",["$scope","controllers","db","navigation","require","urls",function(a,b,f,e,g,d){g.inScope(a,"company","dashboard.settings.TagGroupsCtrl");a.tagGroups=f.tagGroups({shortname:a.company.shortname});return b.dataController(a,{promises:[a.tagGroups.$promise],successCallback:function(){b.listController(a,{collectionKey:"tagGroups",modelKey:"newTagGroup",create:f.tagGroups.create,params:function(){return{shortname:a.company.shortname}},defaultModel:{name:"",
shortName:""},successCallback:function(a){e.navigate(a.$url(d.dashboard.settings.tagGroups.tagGroup.index))},sortable:!0})}})}]);h.controller("dashboard.settings.TagGroupCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.inScope(a,"company","dashboard.settings.TagGroupCtrl");a.tagGroup=f.tagGroup({shortname:a.company.shortname,tagGroupPk:a.route.bindings.tagGroupPk});b.dataController(a,{promises:[a.tagGroup.$promise]})}]);h.controller("dashboard.settings.TagsCtrl",["$scope",
"controllers","db","events","navigation","require",function(a,b,f,e,g,d){d.inScope(a,"tagGroup","dashboard.settings.TagsCtrl");a.$bind("tags","tagGroup.tags");b.listController(a,{collectionKey:"tags",modelKey:"newTag",get:f.tags,params:function(){return{shortname:a.tagGroup.company.shortname,tagGroupPk:a.tagGroup.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},defaultModel:{name:"",shortName:""}})}]);h.controller("dashboard.settings.TagCtrl",["$scope","navigation",
"require","urls",function(a,b,f,e){f.inScope(a,"company","dashboard.settings.TagCtrl");f.inScope(a,"tagGroup","dashboard.settings.TagCtrl");a.tag=null;f=_.parseInt(a.route.bindings.tagPk,10);isNaN(f)||(a.tag=_.find(a.tagGroup.tags,{pk:f}));a.tag||b.redirect(a.tagGroup.$url(e.dashboard.settings.tagGroups.tagGroup.index))}]);h.controller("dashboard.settings.RequirementGroupsCtrl",["$scope","controllers","db","require","events",function(a,b,f,e,g){e.inScope(a,"company","dashboard.settings.RequirementGroupsCtrl");
a.customerTypes=f.customerTypes({shortname:a.company.shortname},null,null,null,{tagAlong:!0});a.requirementGroups=f.companyRequirementGroups({shortname:a.company.shortname});a.resources=f.resources({shortname:a.company.shortname});g.on(a,"dashboard.shared.RequirementGroupEditableCtrl.duplicated",function(b,c){a.requirementGroups.push(c.requirementGroup)});b.dataController(a,{promises:[a.customerTypes.$promise,a.requirementGroups.$promise],successCallback:function(){b.listController(a,{collectionKey:"requirementGroups",
modelKey:"newRequirementGroup",create:f.companyRequirementGroups.create,sortable:!0,params:{shortname:a.company.shortname},successCallback:function(){g.broadcast("dashboard.shared.ActivitiesCtrl.refresh")}})}})}]);h.controller("dashboard.settings.RequirementGroupCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){a.requirementGroup=f.requirementGroup({shortname:e.currentCompany.shortname,requirementGroupPk:a.route.bindings.requirementGroupPk});b.dataController(a,{promises:[a.requirementGroup.$promise]})}]);
h.controller("dashboard.settings.CustomerTypesCtrl",["$scope","controllers","db","navigation","require","urls",function(a,b,f,e,g,d){g.notNull(e,"currentCompany","dashboard.settings.CustomerTypesCtrl");a.customerTypes=f.customerTypes({shortname:e.currentCompany.shortname});return b.dataController(a,{promises:[a.customerTypes.$promise],successCallback:function(){b.listController(a,{collectionKey:"customerTypes",modelKey:"newCustomerType",create:f.customerTypes.create,params:function(){return{shortname:e.currentCompany.shortname}},
defaultModel:{singular:"",plural:""},successCallback:function(a){e.navigate(a.$url(d.dashboard.settings.customerTypes.customerType))},sortable:!0})}})}]);h.controller("dashboard.settings.CustomerTypeCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany","dashboard.settings.CustomerTypeCtrl");a.customerType=f.customerType({shortname:e.currentCompany.shortname,customerTypePk:a.route.bindings.customerTypePk});b.dataController(a,{promises:[a.customerType.$promise]})}]);
h.controller("dashboard.settings.CheckinStatusesCtrl",["$scope","controllers","db","models","navigation","require","controllers",function(a,b,f,e,g,d){d.notNull(g,"currentCompany");a.checkinStatuses=f.checkinStatuses({shortname:g.currentCompany.shortname});a.updateStatuses=function(){a.groups=[{name:T("Checked in"),checkinStatuses:_.filter(a.checkinStatuses,e.CheckinStatus.isCheckedIn)},{name:T("No show"),checkinStatuses:_.filter(a.checkinStatuses,e.CheckinStatus.isNoShow)}]};return b.dataController(a,
{promises:[a.checkinStatuses.$promise],successCallback:function(){a.updateStatuses();b.listController(a,{collectionKey:"checkinStatuses",modelKey:"newCheckinStatus",create:f.checkinStatuses.create,params:function(){return{shortname:g.currentCompany.shortname}},defaultModel:{type:e.CheckinStatus.CHECKED_IN_TYPE,name:""},sortable:!0,successCallback:a.updateStatuses,reorderCallback:a.updateStatuses})}})}]);h.controller("dashboard.settings.CustomFieldsCtrl",["$scope","$timeout","controllers","db","events",
"models","navigation","require","toggles","urls",function(a,b,f,e,g,d,h,m,k,n){m.inScope(a,"company","dashboard.settings.CustomFieldsCtrl");a.customFields=e.customFields({shortname:a.company.shortname});a.storedValueTypes=e.storedValueTypes({shortname:a.company.shortname});a.waivers=e.waivers({shortname:h.currentCompany.shortname});a.$watch("newCustomField.isRequired",function(b,c){b&&(!c&&a.newCustomField)&&(a.newCustomField.isPrivate=!1)});a.filteredCustomFields=[];g.on(a,"dashboard.shared.CustomFieldEditableCtrl.duplicated",
function(b,c){var d=c.customField;a.customFields.push(d);a.filteredCustomFields.push(d)});a.typeUrls={};_.forEach(d.CustomField.GROUPED_TYPES,function(b,c){a.typeUrls[c]=n.populate(n.dashboard.settings.customFields.type,{type:c,shortname:a.company.shortname})});h.pathEquals(a.company.$url(n.dashboard.settings.customFields.index))&&h.redirect(a.typeUrls.text);return f.dataController(a,{promises:[a.customFields.$promise,a.storedValueTypes.$promise,a.waivers.$promise],successCallback:function(){h.watch(a,
function(e){e=h.pathEquals(n.dashboard.settings.customFields.type);a.groupedType=e?e.type:null;a.types=a.groupedType?d.CustomField.GROUPED_TYPES[a.groupedType]:null;a.filteredCustomFields.length=0;a.filtering=!0;b(function(){_.forEach(a.customFields,function(b){(!a.types||_.contains(a.types,b.type))&&a.filteredCustomFields.push(b)});a.filtering=!1});k.state("newCustomFieldForm")||(a.newCustomField.type=a.types?a.types[0]:d.CustomField.SHORT_TYPE)});f.listController(a,{collectionKey:"customFields",
modelKey:"newCustomField",get:e.customFields,params:function(){return{shortname:a.company.shortname}},defaultModel:{name:"",type:"short",isRequired:!1,offset:0,rate:0,modifierKind:d.CustomField.OFFSET_MODIFIER_KIND,modifierType:d.CustomField.ADJUST_MODIFIER_TYPE,isTaxable:!0,isPrivate:!1},submitCallback:function(){a.newCustomField.type===d.CustomField.COUNT_TYPE&&(a.newCustomField.parameters=_.stringifyJSON({min:a.newCustomField.countMin,max:a.newCustomField.countMax}))},successCallback:function(a){h.navigate(a.$url(n.dashboard.settings.customFields.customField))}});
a.$watch("newCustomField.type",function(b){a.newCustomField.storedValueType=b===d.CustomField.CARD_GENERATOR_TYPE?a.storedValueTypes.length?a.storedValueTypes[0].pk:"":""})}})}]);h.controller("dashboard.settings.customField.IndexCtrl",["$scope","controllers","db","events","models","navigation","require","urls",function(a,b,f,e,g,d,h,m){h.notNull(d,"currentCompany","dashboard.settings.customField.IndexCtrl");a.customField=f.customField({shortname:d.currentCompany.shortname,customFieldPk:a.route.bindings.customFieldPk});
a.customFieldTypeUrl=function(a){return g.CustomField.groupedType(a.type)?m.populate(m.dashboard.settings.customFields.type,{type:g.CustomField.groupedType(a.type),shortname:a.company.shortname}):m.populate(m.dashboard.settings.customFields.index,{shortname:a.company.shortname})};a.tracker=_.tracker();e.on(a,"dashboard.shared.CustomFieldEditableCtrl.updated",function(b,c){c.customField===a.customField&&a.tracker.modified()});return b.dataController(a,{promises:[a.customField.$promise],successCallback:function(){b.removeController(a,
{collectionKey:"customFields",elementKey:"customField",remove:f.customField.remove,params:function(){return{shortname:a.customField.company.shortname,customFieldPk:a.customField.pk}},removeCallback:function(b){d.navigate(a.customFieldTypeUrl(b))}})}})}]);h.controller("dashboard.settings.customField.TransportationOptionsCtrl",["$scope","controllers","db","events","navigation","require",function(a,b,f,e,g,d){d.notNull(g,"currentCompany");d.inScope(a,"customField");a.$bind("transportationOptions","customField.transportationOptions");
return b.listController(a,{collectionKey:"transportationOptions",modelKey:"newTransportationOption",get:f.transportationOptions,params:function(){return{shortname:g.currentCompany.shortname,customFieldPk:a.customField.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},defaultModel:{location:"",address:"",minuteOffset:0}})}]);h.controller("dashboard.settings.customField.ExtendedOptionsCtrl",["$scope","controllers","db","events","models","navigation","require",function(a,
b,f,e,g,d,h){h.notNull(d,"currentCompany");h.inScope(a,"customField");a.$bind("extendedOptions","customField.extendedOptions");return b.listController(a,{collectionKey:"extendedOptions",modelKey:"newExtendedOption",get:f.extendedOptions,params:function(){return{shortname:d.currentCompany.shortname,customFieldPk:a.customField.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");e.broadcast("pricing.ngPricing.refresh",{object:a.customField})},defaultModel:{name:"",
short_name:"",description:"",offset:0,rate:0,modifierKind:g.CustomField.OFFSET_MODIFIER_KIND,modifierType:g.CustomField.ADJUST_MODIFIER_TYPE,isTaxable:!0},sortable:!0})}]);h.controller("dashboard.settings.customField.ConnectedCampaignsCtrl",["$scope","controllers","db","events","models","navigation","require",function(a,b,f,e,g,d,h){h.notNull(d,"currentCompany");h.inScope(a,"customField");a.$bind("connectedCampaigns","customField.connectedCampaigns");a.campaigns=f.campaigns({shortname:d.currentCompany.shortname});
return b.dataController(a,{promises:[a.campaigns.$promise],successCallback:function(){b.listController(a,{collectionKey:"connectedCampaigns",modelKey:"newConnectedCampaign",create:f.connectedCampaigns.create,params:function(){return{shortname:d.currentCompany.shortname,customFieldPk:a.customField.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");e.broadcast("pricing.ngPricing.refresh",{object:a.customField})},defaultModel:{campaign:"",offset:0,rate:0,modifierKind:g.CustomField.OFFSET_MODIFIER_KIND,
modifierType:g.CustomField.ADJUST_MODIFIER_TYPE,isTaxable:!0}})}})}]);h.controller("dashboard.settings.customField.GeneratingCampaignsCtrl",["$scope","controllers","db","events","models","navigation","require",function(a,b,f,e,g,d,h){h.notNull(d,"currentCompany");h.inScope(a,"customField");a.$bind("generatingCampaigns","customField.generatingCampaigns");a.campaigns=f.campaigns({shortname:d.currentCompany.shortname});return b.dataController(a,{promises:[a.campaigns.$promise],successCallback:function(){b.listController(a,
{collectionKey:"generatingCampaigns",modelKey:"newGeneratingCampaign",create:f.generatingCampaigns.create,params:function(){return{shortname:d.currentCompany.shortname,customFieldPk:a.customField.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},defaultModel:{campaign:"",maximumUses:1,isPerCustomer:!1,instructions:""}})}})}]);h.controller("dashboard.settings.PermissionsCtrl",["$scope","require",function(a,b){b.inScope(a,"company","dashboard.settings.PermissionsCtrl")}]);
h.controller("dashboard.settings.UsersCtrl",["$scope","controllers","dashboard.shared.subscriptionsController","db","events","flash","models","navigation","require","urls",function(a,b,f,e,g,d,h,m,k,n){k.notNull(m,"currentCompany");a.allUsers=e.users({shortname:m.currentCompany.shortname});a.customCalendars=e.customCalendars({shortname:a.company.shortname});a.customManifests=e.customManifests({shortname:a.company.shortname});var s=e.groups({shortname:a.company.shortname});a=b.imageUploadController(a,
{modelKey:"newUser"});a=f(a,{modelKey:"newUser",prefix:"subscriptions",company:a.company});a.userFilters={isInactive:!1};a.hasAnyDeactivatedUsers=function(a){return _.any(a,"isInactive")};a.users=[];var p=function(){a.userFilters.isInactive?_.overwrite(a.users,a.allUsers):a.users=h.User.getActive(a.allUsers)};g.on(a,"dashboard.settings.UsersCtrl.created",p);g.on(a,"dashboard.shared.UserEditableCtrl.success",p);b.dataController(a,{promises:[a.allUsers.$promise,a.customManifests.$promise,a.customCalendars.$promise,
s.$promise],successCallback:function(){a.groups=_.filter(s,{type:h.Group.COMPANY_TYPE});a.partnerGroups=_.filter(s,{type:h.Group.PARTNER_TYPE});a.$watch("userFilters.isInactive",function(){p()});var f=a.subscriptionsCtrl.defaultModel;_.extend(f,{username:"",name:"",email:"",isWelcomeSendable:!a.company.isDemoModeEnabled,group:"",partnerGroup:"",image:"",defaultCustomCalendar:"",defaultCustomManifest:""});b.listController(a,{collectionKey:"allUsers",modelKey:"newUser",create:e.users.create,successCallback:function(b){a.imageUploadCtrl.image.submit();
d.success(interpolate(T("Created user %(username)s"),{username:b.username}));g.broadcast("dashboard.settings.UsersCtrl.created");m.redirect(b.$url(n.dashboard.settings.permissions.user.settings))},params:function(){return{shortname:m.currentCompany.shortname}},defaultModel:f})}})}]);h.controller("dashboard.settings.user.IndexCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");g=a.route.bindings.username;a.now=moment();a.user=f.user({shortname:e.currentCompany.shortname,
username:g});return b.dataController(a,{promises:[a.user.$promise]})}]);h.controller("dashboard.settings.user.OverviewCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany","dashboard.settings.user.OverviewCtrl");g.inScope(a,"user","dashboard.settings.user.OverviewCtrl");a.overview=f.user.overview({shortname:a.user.company.shortname,username:a.user.username});return b.dataController(a,{promises:[a.overview.$promise],stale:[a.overview],successCallback:function(){a.paymentOverview=
a.overview.paymentOverview}})}]);h.controller("dashboard.settings.GroupOverridesCtrl",["$scope","controllers","db","events","flash","models","navigation","require","urls",function(a,b,f,e,g,d,h,m,k){m.notNull(h,"currentCompany");a.groupOverrides=[];h.currentCompany.features.isGroupOverridesEnabled&&(a.groupOverrides=f.groupOverrides({shortname:h.currentCompany.shortname}));var n=f.groupOverrides.related({shortname:h.currentCompany.shortname}),s=f.groups({shortname:a.company.shortname});b.dataController(a,
{promises:[n.$promise,s.$promise,a.groupOverrides.$promise],successCallback:function(){a.groups=_.filter(s,{type:d.Group.COMPANY_TYPE});a.enabledRelatedGroupOverrides=_.filter(n,function(a){return a.company.features.isGroupOverridesEnabled});b.listController(a,{collectionKey:"groupOverrides",modelKey:"newGroupOverride",create:f.groupOverrides.create,successCallback:function(a){a.relateduser?g.success(interpolate(T("Added outside user %(username)s"),{username:a.relatedUser.username})):g.success(interpolate(T("Added outside users from %(companyName)s"),
{companyName:a.relatedCompany.name}))},params:function(){return{shortname:h.currentCompany.shortname}},defaultModel:{username:"",company:"",group:""}})}})}]);h.controller("dashboard.settings.NetworkCtrl",["$scope","auth","controllers","db","navigation","require","urls","models",function(a,b,f,e,g,d,h,m){d.notNull(g,"currentCompany");d=g.currentCompany;var k=e.totalSheets.nonBase({shortname:d.shortname}),n=e.invoiceSheets.nonBase({shortname:d.shortname}),s=e.totalSchedules({shortname:d.shortname}),
p=e.invoiceSchedules({shortname:d.shortname}),r=e.groups({shortname:d.shortname});d.features.isCancellationPoliciesEnabled&&b.permissions.canList(m.CancellationPolicy,g.currentCompany)?a.cancellationPolicies=e.cancellationPolicies({shortname:d.shortname}):a.cancellationPolicies=[];b.permissions.canView(m.Affiliation,d)?a.defaultNetworkUrl=d.$url(h.dashboard.settings.network.affiliates.index):a.defaultNetworkUrl=d.$url(h.dashboard.settings.index);f.dataController(a,{promises:[k.$promise,n.$promise,
s.$promise,p.$promise,r.$promise,a.cancellationPolicies.$promise],successCallback:function(){a.affiliateGroups=_.filter(r,{type:m.Group.AFFILIATE_TYPE});a.totalSheetsAndSchedules=_.append(k,s);a.invoiceSheetsAndSchedules=_.append(n,p)}})}]);h.controller("dashboard.settings.AffiliatesCtrl",["$scope","controllers","db","events","flash","models","navigation","require","toggles",function(a,b,f,e,g,d,h,m,k){m.inScope(a,"company","dashboard.settings.AffiliatesCtrl");a.affiliations=f.affiliates.pickable({shortname:a.company.shortname});
var n=f.groups({shortname:a.company.shortname});a.companiesEndpoint=f.searchEndpoint(f.companies.pickable);a.isCompanyHidden=function(b){return!b.isAffiliate||b.uri===h.currentCompany.uri?!0:_.find(a.affiliations,function(a){return a.affiliateCompany===b})};return b.dataController(a,{promises:[a.affiliations.$promise,n.$promise],successCallback:function(){a.affiliateGroups=_.filter(n,{type:d.Group.AFFILIATE_TYPE});b.listController(a,{collectionKey:"affiliations",modelKey:"newAffiliate",create:f.affiliates.create,
params:function(){return{shortname:h.currentCompany.shortname}},defaultModel:{affiliateCompany:"",isVoucherNumberRequired:!0,paymentPreference:d.Affiliation.AFFILIATE_TAKE_PAYMENT_PREFERENCE,affiliateGroup:"",isReceiptEmailsEnabled:!0},successCallback:function(a){g.success(interpolate(T("Added new affiliate %(affiliateName)s"),{affiliateName:a.affiliateCompany.name}))}})}})}]);h.controller("dashboard.settings.PartnersCtrl",["$scope","controllers","db","events","navigation","require",function(a,b,
f,e,g,d){d.notNull(g,"currentCompany");b.listController(a,{get:f.partners.pickable,collectionKey:"partners",params:{shortname:g.currentCompany.shortname},remove:f.partner.remove});return b.dataController(a,{promises:[a.partners.$promise]})}]);h.controller("dashboard.settings.PartnerCtrl",["$scope","controllers","db","navigation",function(a,b,f,e){a.partner=f.partner({affiliateShortname:e.currentCompany.shortname,affiliationPk:a.route.bindings.affiliationPk});return b.dataController(a,{promises:[a.partner.$promise]})}]);
h.controller("dashboard.settings.PartnerCardsCtrl",["$scope","controllers","db","navigation",function(a,b,f,e){a.partner=f.partner({affiliateShortname:e.currentCompany.shortname,affiliationPk:a.route.bindings.affiliationPk});a.cardAffiliations=f.partnerCardAffiliations({shortname:a.company.shortname,affiliationPk:a.route.bindings.affiliationPk});a.canListCardAffiliations=!0;a.cardAffiliations.$promise.catch(function(b){403===b.status&&(a.canListCardAffiliations=!1)});return b.dataController(a,{promises:[a.cardAffiliations.$promise,
a.partner.$promise],successCallback:function(){a.companyCardAffiliations=_.filter(a.cardAffiliations,function(b){return b.card.company===a.partner.affiliateCompany});a.partnerCardAffiliations=_.filter(a.cardAffiliations,function(b){return b.card.company===a.partner.company})}})}]);h.controller("dashboard.settings.AffiliateCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");a.affiliation=f.affiliate({shortname:e.currentCompany.shortname,affiliationPk:a.route.bindings.affiliationPk});
return b.dataController(a,{promises:[a.affiliation.$promise]})}]);h.controller("dashboard.settings.AffiliateCardsCtrl",["$scope","controllers","db",function(a,b,f){a.cardAffiliations=f.affiliateCardAffiliations({shortname:a.company.shortname,affiliationPk:a.route.bindings.affiliationPk});a.canListCardAffiliations=!0;a.cardAffiliations.$promise.catch(function(b){403===b.status&&(a.canListCardAffiliations=!1)});return b.dataController(a,{promises:[a.cardAffiliations.$promise],successCallback:function(){a.companyCardAffiliations=
_.filter(a.cardAffiliations,function(b){return b.card.company===a.affiliation.company});a.affiliateCardAffiliations=_.filter(a.cardAffiliations,function(b){return b.card.company===a.affiliation.affiliateCompany})}})}]);h.controller("dashboard.settings.AgentsCtrl",["$scope","controllers","db","events","navigation","require","urls",function(a,b,f,e,g,d,h){d.notNull(g,"currentCompany");a.agents=f.agents({shortname:g.currentCompany.shortname});return b.dataController(a,{promises:[a.agents.$promise],successCallback:function(){b.listController(a,
{collectionKey:"agents",modelKey:"newAgent",get:f.agents,params:function(){return{shortname:g.currentCompany.shortname}},successCallback:function(a){g.navigate(a.$url(h.dashboard.settings.agents.agent))}})}})}]);h.controller("dashboard.settings.AgentCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");a.agent=f.agent({shortname:e.currentCompany.shortname,agentPk:a.route.bindings.agentPk});return b.dataController(a,{promises:[a.agent.$promise]})}]);
h.controller("dashboard.settings.DesksCtrl",["$scope","controllers","db","events","navigation","require","urls",function(a,b,f,e,g,d,h){d.notNull(g,"currentCompany");a.desks=f.desks({shortname:g.currentCompany.shortname});return b.dataController(a,{promises:[a.desks.$promise],successCallback:function(){b.listController(a,{collectionKey:"desks",modelKey:"newDesk",get:f.desks,params:function(){return{shortname:g.currentCompany.shortname}},successCallback:function(a){g.navigate(a.$url(h.dashboard.settings.desks.desk))}})}})}]);
h.controller("dashboard.settings.DeskCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");a.desk=f.desk({shortname:e.currentCompany.shortname,deskPk:a.route.bindings.deskPk});return b.dataController(a,{promises:[a.desk.$promise]})}]);h.controller("dashboard.settings.ActivityCtrl",["$scope",function(a){return a}]);h.controller("dashboard.settings.DuplicateAcrossCompaniesActivityCtrl",["$scope",function(a){var b=a.activity.context.changes;a.unnecessaryDuplications=
_.keys(_.pick(b,function(a){return _.isEmpty(a)}));a.actualDuplications=_.keys(_.pick(b,function(a){return!_.isEmpty(a)}));return a}]);h.controller("dashboard.settings.CampaignsCtrl",["$scope","controllers","db","models","navigation","pagination","require","urls",function(a,b,f,e,g,d,h,m){h.inScope(a,"company","dashboard.settings.CampaignsCtrl");var k=d.endpoint(f.campaigns,{shortname:a.company.shortname});a.endpoint=function(a){var b=k(a,{sideKeys:["codes"]});b.$promise.then(function(a){_.ref.append(b,
a.codes)});return b};a.codeOrCampaignDisplayName=function(a){if(a)return a.cls===e.Campaign.cls?a.name:a.code+" ("+a.campaign.name+")"};b.listController(a,{modelKey:"newCampaign",get:f.campaigns,params:function(){return{shortname:a.company.shortname}},successCallback:function(a){g.navigate(a.$url(m.dashboard.settings.campaigns.campaign.index))}})}]);h.controller("dashboard.settings.campaign.IndexCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");
a.campaign=f.campaign({shortname:e.currentCompany.shortname,campaignPk:a.route.bindings.campaignPk});return b.dataController(a,{promises:[a.campaign.$promise]})}]);h.controller("dashboard.settings.campaign.CampaignValidityRuleCtrl",["$scope","controllers","db","events","navigation","require","models","flash",function(a,b,f,e,g,d,h,m){d.notNull(g,"currentCompany");d.inScope(a,"campaign");a.campaignValidityRules=f.campaignValidityRules({shortname:g.currentCompany.shortname,campaignPk:a.campaign.pk});
var k=function(){a.validCampaignValidityRules=_.where(a.campaignValidityRules,{validity:h.CampaignValidityRule.VALID_VALIDITY});a.invalidCampaignValidityRules=_.where(a.campaignValidityRules,{validity:h.CampaignValidityRule.INVALID_VALIDITY})};a.validityLabels={};a.validityLabels[h.CampaignValidityRule.VALID_VALIDITY]=T("Valid dates");a.validityLabels[h.CampaignValidityRule.INVALID_VALIDITY]=T("Blackout dates");a.showDaysAfter=function(a){return _.contains([h.CampaignValidityRule.DAYS_AFTER_CODE_CREATION_FOR_BOOKING_TYPE,
h.CampaignValidityRule.DAYS_AFTER_CODE_CREATION_FOR_AVAILABILITY_TYPE],a)};b.dataController(a,{promises:[a.campaignValidityRules.$promise],successCallback:function(){k();b.listController(a,{collectionKey:"campaignValidityRules",modelKey:"newCampaignValidityRule",get:f.campaignValidityRules,params:function(){return{shortname:g.currentCompany.shortname,campaignPk:a.campaign.pk}},successCallback:function(b){k();e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");m.success(interpolate(T("Added %(campaignValidityRuleLabel)s"),
{campaignValidityRuleLabel:a.validityLabels[b.validity]}))},remove:f.campaignValidityRule.remove,removeCallback:function(b){k();e.broadcast("dashboard.shared.ActivitiesCtrl.refresh");m.success(interpolate(T("Removed %(campaignValidityRuleLabel)s"),{campaignValidityRuleLabel:a.validityLabels[b.validity]}))},defaultModel:_.extend({validity:h.CampaignValidityRule.INVALID_VALIDITY,type:h.CampaignValidityRule.DATE_RANGE_FOR_AVAILABILITY_TYPE,startDate:moment().format("YYYY-MM-DD"),endDate:moment().format("YYYY-MM-DD")},
h.Rule.weekDaysDefaultModel()),reset:!1})}})}]);h.controller("dashboard.settings.campaign.CodesCtrl",["$scope","controllers","db","events","models","pagination","require","flash",function(a,b,f,e,g,d,h,m){h.inScope(a,"campaign");a.endpoint=d.endpoint(f.codes,{shortname:a.campaign.company.shortname,campaignPk:a.campaign.pk});b.listController(a,{modelKey:"newCodes",create:f.codes.create,params:function(){return{shortname:a.campaign.company.shortname,campaignPk:a.campaign.pk}},successCallback:function(){e.broadcast("ng-pagination.refresh");
e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},defaultModel:{type:"enter"},overwrite:!0});e.on(a,"dashboard.shared.ActivitiesCtrl.clearCodesByTag",function(b,c){f.codes.byTag.clear({shortname:a.campaign.company.shortname,tag:c.tag,campaignPk:a.campaign.pk}).$promise.then(function(b){200===b.status&&(e.broadcast("ng-pagination.refresh"),e.broadcast("dashboard.shared.ActivitiesCtrl.refresh"),b=b.data.count,m.success(a.$interpolate(interpolate(nT("Deleted %(count)s code","Deleted %(count)s codes",
b),{count:b}))))})})}]);h.controller("dashboard.settings.campaign.CodeCtrl",["$scope","dataController","db","navigation","require",function(a,b,f,e,g){g.inScope(a,"campaign");g.notNull(e,"currentCompany");a.code=f.code({shortname:e.currentCompany.shortname,campaignPk:a.campaign.pk,codePk:a.route.bindings.codePk});b(a,{promises:[a.code.$promise]})}]);h.controller("dashboard.settings.HotelsCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");a.hotels=
f.hotels({shortname:e.currentCompany.shortname});return b.dataController(a,{promises:[a.hotels.$promise],successCallback:function(){b.listController(a,{collectionKey:"hotels",modelKey:"newHotel",get:f.hotels,params:function(){return{shortname:e.currentCompany.shortname}}})}})}]);h.controller("dashboard.settings.HotelCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");a.hotel=f.hotel({shortname:e.currentCompany.shortname,hotelPk:a.route.bindings.hotelPk});
b.dataController(a,{promises:[a.hotel.$promise]})}]);h.controller("dashboard.settings.LodgingsCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");a.lodgings=f.lodgings({shortname:e.currentCompany.shortname});a.hotelsEndpoint=f.searchEndpoint(f.hotels,{shortname:e.currentCompany.shortname});a.pickups=f.pickups({shortname:e.currentCompany.shortname});a.hotelCtrl={currentHotel:null};return b.dataController(a,{promises:[a.lodgings.$promise],successCallback:function(){b.listController(a,
{collectionKey:"lodgings",modelKey:"newLodging",get:f.lodgings,params:function(){return{shortname:e.currentCompany.shortname}},defaultModel:{hotel:""}})}})}]);h.controller("dashboard.settings.LodgingCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");a.lodging=f.lodging({shortname:e.currentCompany.shortname,lodgingPk:a.route.bindings.lodgingPk});b.dataController(a,{promises:[a.lodging.$promise]})}]);var b=function(a,b,f){return["$scope","dashboard.shared.duplicatingController",
"db","urls","navigation","flash",function(e,g,d,h,m,k){var n=_.get(d,a),s=_.get(h,b);e.companiesEndpoint=d.searchEndpoint(d.companies.pickable);g(e,{modelKey:"duplicateData",defaultModel:{shortname:""},endpoint:n,params:{shortname:e.company.shortname},successCallback:function(a){var b=h.populate(s,{shortname:e.duplicateData.shortname});m.navigate(b);k.success(interpolate(T("%(count)s %(collectionName)s sent for duplication"),{count:a.length,collectionName:f}))}})}]};h.controller("dashboard.settings.DuplicateLodgingsAcrossCompaniesCtrl",
b("lodgings.duplicate","dashboard.settings.lodgings.index","Lodgings"));h.controller("dashboard.settings.DuplicatePickupsAcrossCompaniesCtrl",b("pickups.duplicate","dashboard.settings.pickups.index","Pickups"));h.controller("dashboard.settings.DuplicateRoutesAcrossCompaniesCtrl",b("routes.duplicate","dashboard.settings.routes.index","Routes"));h.controller("dashboard.settings.PreferredPickupsCtrl",["$scope","controllers","db","events","navigation","require",function(a,b,f,e,g,d){d.inScope(a,"lodging");
a.preferredPickups=f.preferredPickups({shortname:a.lodging.company.shortname,lodgingPk:a.lodging.pk});a.pickups=f.pickups({shortname:a.lodging.company.shortname});return b.dataController(a,{promises:[a.preferredPickups.$promise,a.pickups.$promise],successCallback:function(){b.listController(a,{collectionKey:"preferredPickups",modelKey:"newPreferredPickup",create:f.preferredPickups.create,params:function(){return{shortname:g.currentCompany.shortname,lodgingPk:a.lodging.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},
defaultModel:{pickup:""},sortable:!0})}})}]);h.controller("dashboard.settings.RoutesCtrl",["$scope","controllers","db","events","navigation","require",function(a,b,f,e,g,d){d.notNull(g,"currentCompany");a.routes=f.routes({shortname:g.currentCompany.shortname});e.on(a,"dashboard.settings.RouteCtrl.duplicated",function(b,c){a.routes.push(c.route)});return b.dataController(a,{promises:[a.routes.$promise],successCallback:function(){b.listController(a,{collectionKey:"routes",modelKey:"newRoute",get:f.routes,
params:function(){return{shortname:g.currentCompany.shortname}},defaultModel:{name:"",shortName:""}})}})}]);h.controller("dashboard.settings.RouteCtrl",["$scope","controllers","db","events","flash","navigation","require",function(a,b,f,e,g,d,h){h.notNull(d,"currentCompany");a.duplicate=function(){var b=f.route.duplicate({routePk:a.transRoute.pk,shortname:a.transRoute.company.shortname});b.$promise.then(function(){g.success(T("Duplicated route"));e.broadcast("dashboard.settings.RouteCtrl.duplicated",
{route:b})})};a.transRoute=f.route({shortname:d.currentCompany.shortname,routePk:a.route.bindings.routePk},null,null,{withCounts:"yes"});b.dataController(a,{promises:[a.transRoute.$promise]})}]);h.controller("dashboard.settings.StopsCtrl",["$scope","controllers","db","events","navigation","require",function(a,b,f,e,g,d){d.inScope(a,"transRoute");a.stops=f.stops({shortname:a.transRoute.company.shortname,routePk:a.transRoute.pk});a.pickups=f.pickups({shortname:a.transRoute.company.shortname});var h=
{pickup:"",time:""};return b.dataController(a,{promises:[a.stops.$promise,a.pickups.$promise],successCallback:function(){b.listController(a,{collectionKey:"stops",modelKey:"newStop",get:f.stops,params:function(){return{shortname:a.transRoute.company.shortname,routePk:a.transRoute.pk}},submitCallback:function(){h.time=a.newStop.time},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},defaultModel:h})}})}]);h.controller("dashboard.settings.PickupsCtrl",["$scope","controllers",
"db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");a.pickups=f.pickups({shortname:e.currentCompany.shortname});return b.dataController(a,{promises:[a.pickups.$promise],successCallback:function(){b.listController(a,{collectionKey:"pickups",modelKey:"newPickup",get:f.pickups,params:function(){return{shortname:e.currentCompany.shortname}},defaultModel:{name:"",shortName:"",startTime:""}})}})}]);h.controller("dashboard.settings.PickupCtrl",["$scope","controllers","db","navigation",
"require",function(a,b,f,e,g){g.notNull(e,"currentCompany");a.pickup=f.pickup({shortname:e.currentCompany.shortname,pickupPk:a.route.bindings.pickupPk});b.dataController(a,{promises:[a.pickup.$promise]})}]);h.controller("dashboard.settings.CompanyActivitiesCtrl",["$scope","dashboard.shared.activitiesController","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");return b(a,{get:f.company.activities.all,params:function(){return{shortname:e.currentCompany.shortname}},isFilteringEnabled:!0})}]);
h.controller("dashboard.settings.GroupsCtrl",["$scope","controllers","db","flash","models","navigation","require","urls","events",function(a,b,f,e,g,d,h,m,k){h.notNull(d,"currentCompany");a.groups=f.groups({shortname:d.currentCompany.shortname});b.dataController(a,{promises:[a.groups.$promise],successCallback:function(){b.listController(a,{collectionKey:"groups",modelKey:"newGroup",create:f.groups.create,successCallback:function(a){d.navigate(a.$url(m.dashboard.settings.permissions.group))},params:function(){return{shortname:d.currentCompany.shortname}},
defaultModel:{type:g.Group.COMPANY_TYPE}})}})}]);h.controller("dashboard.settings.group.IndexCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");a.group=f.group({shortname:e.currentCompany.shortname,groupPk:a.route.bindings.groupPk});return b.dataController(a,{promises:[a.group.$promise]})}]);h.controller("dashboard.settings.GroupOverrideCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");
a.groupOverride=f.groupOverride({shortname:e.currentCompany.shortname,groupOverridePk:a.route.bindings.groupOverridePk});b.dataController(a,{promises:[a.groupOverride.$promise]})}]);h.controller("dashboard.settings.WaiversCtrl",["$scope","controllers","db","navigation","require","urls",function(a,b,f,e,g,d){g.notNull(e,"currentCompany");a.waivers=f.waivers({shortname:e.currentCompany.shortname});return b.dataController(a,{promises:[a.waivers.$promise],successCallback:function(){b.listController(a,
{collectionKey:"waivers",modelKey:"newWaiver",get:f.waivers,params:function(){return{shortname:e.currentCompany.shortname}},successCallback:function(a){e.navigate(a.$url(d.dashboard.settings.waivers.waiver.index))}})}})}]);h.controller("dashboard.settings.waiver.IndexCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");a.waiver=f.waiver({shortname:e.currentCompany.shortname,waiverPk:a.route.bindings.waiverPk});return b.dataController(a,{promises:[a.waiver.$promise]})}]);
h.controller("dashboard.settings.customField.ConnectedWaiversCtrl",["$scope","controllers","db","events","models","navigation","require",function(a,b,f,e,g,d,h){h.notNull(d,"currentCompany");h.inScope(a,"customField");a.$bind("connectedWaivers","customField.connectedWaivers");a.waivers=f.waivers({shortname:d.currentCompany.shortname});return b.dataController(a,{promises:[a.waivers.$promise],successCallback:function(){b.listController(a,{collectionKey:"connectedWaivers",modelKey:"newConnectedWaiver",
create:f.connectedWaivers.create,params:function(){return{shortname:d.currentCompany.shortname,customFieldPk:a.customField.pk}},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},defaultModel:{waiver:""}})}})}]);h.controller("dashboard.settings.LocationsCtrl",["$scope","controllers","db","navigation","require","controllers",function(a,b,f,e,g){g.notNull(e,"currentCompany");var d=e.currentCompany;a.locations=f.locations({shortname:d.shortname});return b.dataController(a,
{promises:[a.locations.$promise],successCallback:function(){var e=function(){var b={isOnline:!0,country:d.country};return a.locations.length?b:_.extend(b,_.pick(d,"street city province postalCode country name".split(" ")))};b.listController(a,{collectionKey:"locations",modelKey:"newLocation",get:f.locations,params:function(){return{shortname:d.shortname}},successCallback:function(){a.newLocation=_.extend({},e());d.features.isLocationsEnabled||f.company({shortname:d.shortname})},defaultModel:e(),sortable:!0})}})}]);
h.controller("dashboard.settings.LocationCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");a.location=f.location({shortname:e.currentCompany.shortname,locationPk:a.route.bindings.locationPk});b.dataController(a,{promises:[a.location.$promise]})}]);h.controller("dashboard.settings.CreatePrimaryLocationCtrl",["$scope","controllers","db","require","flash",function(a,b,f,e,g){e.inScope(a,"company","dashboard.settings.CreatePrimaryLocationCtrl");
return b.createController(a,{modelKey:"newPrimaryLocation",create:f.locations.createPrimary,params:{shortname:a.company.shortname},defaultModel:_.extend({isDefaultItemPrimaryLocation:!1,isOnline:!0},_.pick(a.company,"street city province postalCode country name".split(" "))),successCallback:function(b){f.company({shortname:a.company.shortname});g.success(T("Your default location has been set."))}})}]);h.controller("dashboard.settings.AnalyticsServicesCtrl",["$scope","controllers","db","navigation",
"require","models",function(a,b,f,e,g,d){g.notNull(e,"currentCompany");a.analyticsServices=f.analyticsServices({shortname:e.currentCompany.shortname});return b.dataController(a,{promises:[a.analyticsServices.$promise],successCallback:function(){b.listController(a,{collectionKey:"analyticsServices",modelKey:"newAnalyticsService",get:f.analyticsServices,params:function(){return{shortname:e.currentCompany.shortname}},defaultModel:{type:d.AnalyticsService.GOOGLE_ANALYTICS_TYPE,isCrossDomainOnly:!1}})}})}]);
h.controller("dashboard.settings.AnalyticsServiceCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");a.analyticsService=f.analyticsService({shortname:e.currentCompany.shortname,analyticsServicePk:a.route.bindings.analyticsServicePk});b.dataController(a,{promises:[a.analyticsService.$promise]})}]);h.controller("dashboard.settings.CancellationPoliciesCtrl",["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.notNull(e,"currentCompany");
a.company=e.currentCompany;a.cancellationPolicies=f.cancellationPolicies({shortname:a.company.shortname});b.dataController(a,{promises:[a.cancellationPolicies.$promise],successCallback:function(){b.listController(a,{collectionKey:"cancellationPolicies",modelKey:"newCancellationPolicy",get:f.cancellationPolicies,params:function(){return{shortname:a.company.shortname}},sortable:!0})}})}]);h.controller("dashboard.settings.CancellationPolicyCtrl",["$scope","controllers","db","navigation","require",function(a,
b,f,e,g){g.notNull(e,"currentCompany");a.company=e.currentCompany;a.cancellationPolicy=f.cancellationPolicy({shortname:a.company.shortname,cancellationPolicyPk:a.route.bindings.cancellationPolicyPk});b.dataController(a,{promises:[a.cancellationPolicy.$promise],successCallback:function(){}})}]);h.controller("dashboard.settings.CancellationPolicyEditableCtrl",["$scope","controllers","db","require","flash","navigation","urls",function(a,b,f,e,g,d,h){e.inScope(a,"cancellationPolicy","dashboard.settings.CancellationPolicyEditableCtrl");
e.inScope(a,"company","dashboard.settings.CancellationPolicyEditableCtrl");b.editController(a,{elementKey:"cancellationPolicy",modelKey:"editableCancellationPolicy",get:f.cancellationPolicy,remove:f.cancellationPolicy.remove,params:function(){return{shortname:a.company.shortname,cancellationPolicyPk:a.cancellationPolicy.pk}},removeCallback:function(){g.success(T("Removed cancellation policy"));d.redirect(a.company.$url(h.dashboard.settings.cancellationPolicies))},refreshActivities:!0,editing:!0})}]);
h.controller("dashboard.settings.CancellationRulesCtrl",["$scope","controllers","db","require","models",function(a,b,f,e,g){e.inScope(a,"cancellationPolicy","dashboard.settings.CancellationRulesCtrl");e.inScope(a,"company","dashboard.settings.CancellationRulesCtrl");a.cancellationRules=f.cancellationRules({shortname:a.company.shortname,cancellationPolicyPk:a.cancellationPolicy.pk});b.dataController(a,{promises:[a.cancellationRules.$promise],successCallback:function(){b.listController(a,{collectionKey:"cancellationRules",
modelKey:"newCancellationRule",get:f.cancellationRules,params:function(){return{shortname:a.company.shortname,cancellationPolicyPk:a.cancellationPolicy.pk}},sortable:!0,defaultModel:{baseType:g.CancellationRule.HOURS_BEFORE_PSEUDO_TYPE,hoursBeforeType:g.CancellationRule.HOURS_BEFORE_AVAILABILITY_START_TYPE,hours:48,isCancellationAllowed:!0,charterRefundPercentage:100,affiliateRefundPercentage:!0},refreshActivities:!0})}})}]);h.controller("dashboard.settings.CancellationRuleEditableCtrl",["$scope",
"controllers","db","require","flash","models",function(a,b,f,e,g,d){e.inScope(a,"cancellationPolicy","dashboard.settings.CancellationRuleEditableCtrl");e.inScope(a,"cancellationRules","dashboard.settings.CancellationRuleEditableCtrl");e.inScope(a,"cancellationRule","dashboard.settings.CancellationRuleEditableCtrl");e.inScope(a,"company","dashboard.settings.CancellationRuleEditableCtrl");b.editController(a,{elementKey:"cancellationRule",modelKey:"editableCancellationRule",get:f.cancellationRule,remove:f.cancellationRule.remove,
params:function(){return{shortname:a.company.shortname,cancellationPolicyPk:a.cancellationPolicy.pk,cancellationRulePk:a.cancellationRule.pk}},removeCallback:function(b){g.success(T("Removed cancellation rule"));_.overwriteWithout(a.cancellationRules,_.isReferenceEqualTo(b))},refreshActivities:!0,editCallback:function(){_.contains([d.CancellationRule.HOURS_BEFORE_AVAILABILITY_MIDNIGHT_TYPE,d.CancellationRule.HOURS_BEFORE_AVAILABILITY_START_TYPE],a.cancellationRule.type)?(a.editableCancellationRule.baseType=
d.CancellationRule.HOURS_BEFORE_PSEUDO_TYPE,a.editableCancellationRule.hoursBeforeType=a.cancellationRule.type):(a.editableCancellationRule.baseType=a.cancellationRule.type,a.editableCancellationRule.hoursBeforeType=d.CancellationRule.HOURS_BEFORE_AVAILABILITY_MIDNIGHT_TYPE);a.editableCancellationRule.charterRefundPercentage=100*a.cancellationRule.charterRefundPercentage;a.editableCancellationRule.affiliateRefundPercentage=0<a.cancellationRule.affiliateRefundPercentage?!0:!1}})}]);h.controller("dashboard.settings.PaymentsOverviewCtrl",
["$scope","processors","require",function(a,b,f){f.inScope(a,"company","dashboard.settings.BankAccountsCtrl");a.isBankAccountVerificationRelevant=!b.isBankAccountVerificationEnabled(a.company.defaultProcessorType,a.company.processorCountry,a.company.processorCurrency)?!1:!a.company.isDefaultProcessorBankAccountConnected?!0:a.company.isVerificationEnabledForDefaultProcessorDefaultBankAccount}]);h.controller("dashboard.settings.BookingRestrictionsCtrl",["$scope","controllers","db","require",function(a,
b,f,e){e.inScope(a,"company","dashboard.settings.BookingRestrictionsCtrl");a.bookingRestrictions=f.bookingRestrictions({shortname:a.company.shortname});b.dataController(a,{promises:[a.bookingRestrictions.$promise],successCallback:function(){b.listController(a,{collectionKey:"bookingRestrictions",modelKey:"newBookingRestriction",create:f.bookingRestrictions.create,params:function(){return{shortname:a.company.shortname}},defaultModel:{},sortable:!0})}})}]);h.controller("dashboard.settings.BookingRestrictionCtrl",
["$scope","controllers","db","require","urls",function(a,b,f,e,g){e.inScope(a,"company","dashboard.settings.BookingRestrictionCtrl");e.inScope(a,"bookingRestrictions","dashboard.settings.BookingRestrictionCtrl");a.bookingRestriction=f.bookingRestriction({shortname:a.company.shortname,bookingRestrictionPk:a.route.bindings.bookingRestrictionPk});b.dataController(a,{promises:[a.bookingRestriction.$promise],successCallback:function(){b.editController(a,{collectionKey:"bookingRestrictions",elementKey:"bookingRestriction",
modelKey:"editableBookingRestriction",update:f.bookingRestriction.update,remove:f.bookingRestriction.remove,params:{shortname:a.company.shortname,bookingRestrictionPk:a.bookingRestriction.pk},editCallback:function(){},successCallback:function(){},navigateAfterRemove:a.company.$url(g.dashboard.settings.bookingRestrictions.index),flashAfterRemove:!0,refreshActivities:!0,editing:!0,skipResetAfterError:!0})}})}]);h.controller("dashboard.settings.ProcessorOnboardCtrl",["$scope","controllers","db","flash",
"navigation","require",function(a,b,f,e,g,d){d.inScope(a,"company","dashboard.settings.ProcessorOnboardCtrl");if(d=g.get("result"))console.info("dashboard.settings.ProcessorOnboardCtrl: result",d),"success"===d?e.success(T("Company information updated. This could take a while.")):"failure"===d&&e.error(T("Company information not updated.")),g.clear("result",!0);a.processorOnboard={processorType:a.company.defaultProcessorType};b.editController(a,{elementKey:"processorOnboard",modelKey:"editableProcessorOnboard",
update:f.company.processorOnboard.update,successCallback:function(a){(a=a.redirectUrl)?g.navigate(a):e.error(T("Unable to start processor onboarding."))},params:{shortname:a.company.shortname}})}])})();
(function(){var h=angular.module("dashboard.settings.directives",[]);h.directive("ngUseCount",["$parse","auth","db","models","urls",function(a,b,f,e,g){var d={};d[e.CustomerType.cls]={};d[e.CustomerType.cls][e.Item.cls]={endpoint:f.customerType.items,url:g.dashboard.items.item.prices.index};d[e.CustomField.cls]={};d[e.CustomField.cls][e.Item.cls]={endpoint:f.customField.items,url:g.dashboard.items.item.prices.index};d[e.Resource.cls]={};d[e.Resource.cls][e.Item.cls]={endpoint:f.resource.items,url:g.dashboard.items.item.prices.resources};
d[e.Resource.cls][e.RequirementGroup.cls]={endpoint:f.resource.requirementGroups};d[e.Campaign.cls]={};d[e.Campaign.cls][e.CustomField.cls]={endpoint:f.campaign.customFields,url:g.dashboard.settings.customFields.customField};d[e.CancellationPolicy.cls]={};d[e.CancellationPolicy.cls][e.Affiliation.cls]={endpoint:f.cancellationPolicy.affiliations,url:g.dashboard.settings.network.affiliates.affiliate.index};d[e.CancellationPolicy.cls][e.Item.cls]={endpoint:f.cancellationPolicy.items,url:g.dashboard.items.item.index};
d[e.Item.cls]={};d[e.Item.cls][e.FlowNode.cls]={endpoint:f.item.flowPages,url:g.dashboard.settings.flows.flowNode.index};d[e.CannedMessage.cls]={};d[e.CannedMessage.cls][e.Item.cls]={endpoint:f.cannedMessage.items,url:g.dashboard.items.item.notifications.external};d[e.BookingRestriction.cls]={};d[e.BookingRestriction.cls][e.Item.cls]={endpoint:f.bookingRestriction.items,url:g.dashboard.items.item.onlineBooking};d[e.TotalSchedule.cls]={};d[e.TotalSchedule.cls][e.Affiliation.cls]={endpoint:f.totalSchedule.affiliations,
url:g.dashboard.settings.network.affiliates.affiliate.index,propertyName:"scheduleAffiliations"};d[e.InvoiceSchedule.cls]={};d[e.InvoiceSchedule.cls][e.Affiliation.cls]={endpoint:f.invoiceSchedule.affiliations,url:g.dashboard.settings.network.affiliates.affiliate.index,propertyName:"scheduleAffiliations"};d[e.TotalSheet.cls]={};d[e.TotalSheet.cls][e.TotalSchedule.cls]={endpoint:f.totalSheet.schedules,url:g.dashboard.settings.pricing.totalSchedules.index,propertyName:"totalSheetSchedules",countKey:"scheduleCount"};
d[e.TotalSheet.cls][e.Affiliation.cls]={endpoint:f.totalSheet.affiliations,url:g.dashboard.settings.network.affiliates.affiliate.index,propertyName:"totalSheetAffiliations",countKey:"affiliationCount"};d[e.InvoiceSheet.cls]={};d[e.InvoiceSheet.cls][e.InvoiceSchedule.cls]={endpoint:f.invoiceSheet.schedules,url:g.dashboard.settings.pricing.invoiceSchedules.index,propertyName:"invoiceSheetSchedules",countKey:"scheduleCount"};d[e.InvoiceSheet.cls][e.Affiliation.cls]={endpoint:f.invoiceSheet.affiliations,
url:g.dashboard.settings.network.affiliates.affiliate.index,propertyName:"invoiceSheetAffiliations",countKey:"affiliationCount"};d[e.Route.cls]={};d[e.Route.cls][e.Item.cls]={endpoint:f.route.items,url:g.dashboard.items.item.index,propertyName:"routeItems",countKey:"itemCount"};return{templateUrl:"dashboard.settings.UseCount",scope:!0,controllerAs:"useCountCtrl",controller:["$scope","$attrs",function(f,g){var h=g.ngUseCount.match(/^\s*([\s\S]+)\s+on\s+([\s\S]+)\s*$/);if(!h)throw Error("ng-use-count: "+
g.ngUseCount+": expected expression of the form '_type_ on _object_'");var n=h[1],h=a(h[2]);this.modelCls=n;this.model=e[n];this.owner=h(f);this.btnText=f.$eval(g.ngUseCountBtnText);if(this.model)if(!this.owner||!d[this.owner.cls])console.error("ng-use-count: invalid owner",g.ngUseCount);else{if((this.canViewUseCount=b.permissions.canList(this.model,this.owner.company))&&this.model===e.Item)this.canViewUseCount=b.permissions.can("listAssociatedItems",this.owner.cls,this.owner.company);this.canViewUseCount&&
((this.config=d[this.owner.cls][this.model.cls])?(n=this.config.countKey||_.uncapitalize(this.model.cls)+"Count",n=this.owner[n],this.count=_.isUndefined(n)?"these":n||0):console.error("ng-use-count: invalid owner or model",this.owner,this.model))}else console.error("ng-use-count: invalid model",this.modelCls)}]}}]);h.directive("ngUses",["urls",function(a){return{templateUrl:"dashboard.settings.uses",restrict:"A",scope:!0,controllerAs:"usesCtrl",require:"^^ngUseCount",controller:["$scope","$attrs",
function(b,f){var e=this;e.modelCls=b.useCountCtrl.modelCls;e.model=b.useCountCtrl.model;e.owner=b.useCountCtrl.owner;var g=b.useCountCtrl.config;e.propertyName=g.propertyName||e.owner.cls+e.model.cls+"s";var d=a.extract(e.owner);e.url=g.url;e.status="loading";var h=g.endpoint(d);e.unarchivedObjects=[];e.archivedObjects=[];h.$promise.then(function(){_.forEach(h,function(a){(a.isArchived?e.archivedObjects:e.unarchivedObjects).push(a)});e.status="success"});e.name=function(a){return e.model.name?e.model.name(a):
a.name||a.unicode}}]}}]);h.directive("ngCompanyCardAffiliations",[function(){return{templateUrl:"ng-company-card-affiliations",scope:{cardAffiliations:"="}}}]);h.directive("ngAffiliateCardAffiliations",[function(){return{templateUrl:"dashboard.settings.affiliateCardAffiliations",scope:{cardAffiliations:"="}}}]);var b=function(a){var b="ng"+_.capitalize(a.name);h.directive(b,["$injector","$q","d","db","require",function(f,e,g,d,h){var m=_.get(d,a.endpoint),k=g.safeInvoke(f,a.saveCallbacks)||{};return{controllerAs:a.name+
"Ctrl",controller:["$scope","$attrs",function(d,f){var g=this;h.inScope(d,"company",b);var r=(a.paramsBuilder||function(a){return{shortname:a.company.shortname}})(d),t=f[b];if(t){var v=k[t]||_.ignore;a.filterKey&&(t=a.filterKey(t));g.status="success";g.save=function(a){if(_.isUndefined(a))console.warn(b+": not saving undefined");else if("success"===g.status){g.status="saving";var f={};f[t]=a;m(r,f).$promise.then(function(){e.when(v(d)).then(function(){g.status="success"})},function(){g.status="error"})}};
a.saveTrueFunctionName&&(g[a.saveTrueFunctionName]=_.partial(g.save,!0));a.saveTrueFunctionName&&(g[a.saveFalseFunctionName]=_.partial(g.save,!1))}else console.warn(b+": expected key")}]}}])};b({name:"editItemColorsFeatureFlag",endpoint:"company.itemColorsFeature.update",saveCallbacks:["db",function(a){return{isItemColorsEnabled:function(b){return a.items.pickable({shortname:b.company.shortname}).$promise}}}],saveTrueFunctionName:"enable",saveFalseFunctionName:"disable"});b({name:"editCompanyFeature",
endpoint:"company.companyFeatures.update",filterKey:function(a){return"companyFeatures-"+a},saveTrueFunctionName:"enable",saveFalseFunctionName:"disable"});b({name:"editCompanyNag",endpoint:"company.nags.update",saveTrueFunctionName:"dismiss",saveFalseFunctionName:"undismiss"});b({name:"editUserNag",endpoint:"user.nags.update",saveTrueFunctionName:"dismiss",saveFalseFunctionName:"undismiss",paramsBuilder:function(a){return{shortname:a.auth.currentUser.company.shortname,username:a.auth.currentUser.username}}});
h.directive("ngAvailableActionsCount",["auth","models",function(a,b){return{scope:!0,link:function(f){var e=f.company;e&&(e={"company.primaryLocation":a.permissions.canCreate(b.Location,e),"company.companyFeatures.isResourceBookableCapacityEnabled":!0,"company.features.isItemColorsEnabled":a.permissions.canUpdate(b.CustomCalendar,e)&&a.permissions.canUpdate(b.Item,e),"company.nags.newYearSchedule.isDismissed":!0,"company.nags.boost.isDismissed":!0},f.$watchGroup(_.keys(_.pick(e,_.identity)),function(a){f.availableActionsCount=
_.reject(a).length}))}}}]);h.directive("ngGeocode",[function(){return{scope:!0,require:["^?form","ngGeocode"],link:function(a,b,f,e){e[1].formCtrl=e[0]},controllerAs:"ngGeocodeCtrl",controller:["$scope","$attrs","$rootScope","$window",function(a,b,f,e){var g=this,d=b.ngGeocode,h=a.$eval(b.ngGeocodeAuto),m,k=function(a,b){m.geocode({address:b},function(b,c){var d,e;"OK"===c?(e=b[0].geometry.location,d=parseFloat(e.lat()).toFixed(6),e=parseFloat(e.lng()).toFixed(6)):e=d=null;g.formCtrl&&(d!==a.latitude||
e!==a.longitude)&&g.formCtrl.$setDirty();a.latitude=d;a.longitude=e;g.isGeocoding=!1;f.$digest()})},n=_.throttle(k,1E3,{leading:!1});g.geocode=function(b){if(m){var c=a.$eval(d);if(c.street){var e=(c.street+",+"+c.city+",+"+c.province+"+"+c.postalCode).replace(/\s+/g,"+");g.isGeocoding=!0;(b?n:k)(c,e)}}};var s=function(){a.$watchGroup([d+".street",d+".city",d+".province",d+".postalCode",d+".country"],function(a,b){_.isEqual(a,b)||g.geocode(!0)})};b=function(){m=new google.maps.Geocoder;s();h&&g.geocode()};
"google"in e?b():e.$.getScript("https://maps.googleapis.com/maps/api/js?key=AIzaSyDsax6eIDMiI4U0lQMogXwrxbK4QTj5V7g").done(b)}]}}])})();angular.module("dashboard.settings.translations",["dashboard.settings.translations.controllers"]);
(function(){var h=angular.module("dashboard.settings.translations.controllers",[]);h.controller("dashboard.settings.translations.LanguageListCtrl",["$scope","db","events",function(b,a,c){this.refreshLanguages=function(){b.supportedLanguages=a.supportedLanguages({shortname:b.company.shortname})};c.on(b,"translations.language.deleted",this.refreshLanguages);c.on(b,"translations.language.created",this.refreshLanguages);this.refreshLanguages()}]);h.controller("dashboard.settings.translations.LanguagesCtrl",
["$scope","auth","controllers","db","events","models","navigation","require",function(b,a,c,f,e,g,d,h){h.inScope(b,"company","LanguagesCtrl");h.inScope(b,"supportedLanguages","LanguagesCtrl");b.canUpdateLanguages=a.permissions.canUpdate(g.SupportedLanguage,b.company)||a.permissions.canUpdate(g.Translation,b.company);this.display=function(a){return g.SupportedLanguage.display(a)+" - "+a};this.languageOptions=_.without(g.SupportedLanguage.LANGUAGE_CODES_SORTED,[b.company.language]);c.listController(b,
{collectionKey:"languages",modelKey:"newLanguage",create:f.supportedLanguages.create,params:function(){return{shortname:b.company.shortname}},submitCallback:function(a){return{language:a.language.$modelValue}},successCallback:function(a){e.broadcast("translations.language.created");d.navigate(a.$url())}})}]);h.controller("dashboard.settings.translations.LanguageIndexCtrl",["$scope","controllers","db","events","require",function(b,a,c,f,e){e.inScope(b,"company","LanguageIndexCtrl");b.language=c.supportedLanguage({shortname:b.company.shortname,
languagePk:b.route.bindings.languagePk});a.dataController(b,{promises:[b.language.$promise]})}]);h.controller("dashboard.settings.translations.LanguageTranslationCtrl",["$scope","$q","db","events","flash","models","navigation","require","urls",function(b,a,c,f,e,g,d,h,m){var k=this;h.inScope(b,"language","LanguageTranslationCtrl");h.inScope(b,"company","LanguageTranslationCtrl");b.Translation=g.Translation;var n=c.slipstream("translatableModels");k.CSV_FILENAME=T("translations")+"-"+b.language.language+
"-"+b.language.pk+".csv";var s=function(a,b){_.forEach(a.fieldTranslations,function(c){var d=g.Translation.fieldDisplayValue(c,a.instance),e={};_.isString(d)?e[c.fieldName]=d:e=d;_.forEach(e,function(d,e){if(k.showEmptyFields||d||c.fieldValue){var f=n[a.instance.cls],h=_.isObject(c.fieldValue)?c.fieldValue[e]:c.fieldValue,l=c.subfieldDisplayNames?c.subfieldDisplayNames[e]:c.fieldDisplayName,m="";a.instance.cls===g.Company.cls?m="Info & Policies":f&&(m=_.titleize(f.singular));b.push([m,g.Translation.displayNameForInstance(a.instance),
_.capitalize(l),d,h]);_.forEach(a.childModelTranslations,function(a){s(a,b)})}})})};k.translationsAsCsv=function(){var d=[];_.forEach(k.translationTabs,function(a){d.push(b.translationsForModel=c.translationsForModel({shortname:b.company.shortname,languagePk:b.route.bindings.languagePk,modelName:a.className}).$promise)});return a.all(d).then(function(a){if(!_.reduce(a,function(a,b){return b&&b.data&&a},!0))return null;var b=[];b.push([cT("As in category","Type"),T("Name"),cT("As in a place to enter information",
"Field"),T("Default Language"),T("Translation")]);_.forEach(a,function(a){a=a.data.translationsForModel;_.isArray(a)&&_.forEach(a,function(a){s(a,b)})});return b})};k.tabUrl=function(a){a=_.merge({},b.language,{modelName:a});return m.populate(m.dashboard.settings.translations.language.translations.forModel,m.extract(a))};k.isNotHiddenByFeatureFlag=function(a){return(a=g[a.className].RELATED_FEATURE_FLAG)?!_.isUndefined(b.company.companyFeatures[a])?b.company.companyFeatures[a]:b.company.features[a]:
!0};k.translationTabs=[];_.forEach(_.merge({},n),function(a,b){"Company"===b?k.translationTabs.push({className:"Company",displayName:T("info & policies")}):_.isString(a.plural)&&k.translationTabs.push({className:b,displayName:a.plural})});k.translationTabs=_.sortBy(k.translationTabs,function(a){return a.displayName});k.DEFAULT_TAB="Company"}]);h.controller("dashboard.settings.translations.TranslationsForModelCtrl",["$scope","controllers","db","models","navigation","require","urls",function(b,a,c,
f,e,g,d){var h=this;g.inScope(b,"language","TranslationsForModelCtrl");h.modelTranslationVisibility={};h.hasVisibleTranslations=!1;h.translationOverlayUrl=function(a,c,d){return f.Translation.translationOverlayUrl(a.fieldName,c,b.company.shortname,b.language.pk,d)};h.fieldDisplayLabel=function(a,b){return b?a.subfieldDisplayNames[b]:a.fieldDisplayName};h.fieldValue=function(a,b,c){return c?(b=a.fieldValue[c],a.subfieldDisplayNames[c]?b:""):_.isString(a.fieldValue)?a.fieldValue:""};h.displayNameForInstance=
function(a){return f.Translation.displayNameForInstance(a.instance)};h.isSimpleField=function(a){return!a.subfieldDisplayNames};h.visibilityKey=function(a){return a.instance.cls+a.instance.pk};h.showTranslationTable=function(a){a=h.visibilityKey(a);return h.modelTranslationVisibility[a]};h.showTranslationRow=function(a,c,d){var e=h.visibilityKey(a);a=f.Translation.fieldDisplayValue(c,a.instance,d);c=b.languageTranslationCtrl.showEmptyFields||h.fieldValue(c,d);c=_.isObject(a)?c||_.reduce(a,function(a,
b){return b||a},!1):c||a;h.modelTranslationVisibility[e]=h.modelTranslationVisibility[e]||c;h.hasVisibleTranslations=h.hasVisibleTranslations||h.modelTranslationVisibility[e];return c};e=f.Translation.modelNameFromUrl(b.route.bindings.modelName);b.translationsForModel=c.translationsForModel({shortname:b.company.shortname,languagePk:b.route.bindings.languagePk,modelName:e});b.$watch(function(){return b.languageTranslationCtrl.showEmptyFields},function(){h.modelTranslationVisibility={};h.hasVisibleTranslations=
!1});a.dataController(b,{promises:[b.translationsForModel.$promise],successCallback:function(){b.translationsForModel=_.sortBy(b.translationsForModel,h.displayNameForInstance)}})}]);h.controller("dashboard.settings.translations.LanguageEditCtrl",["$scope","controllers","db","events","flash","navigation","require","urls",function(b,a,c,f,e,g,d,h){d.inScope(b,"language","LanguageTranslationCtrl");d.inScope(b,"company","LanguageTranslationCtrl");this.previewUrl=window.location.origin+"/embeds/book/"+
b.company.shortname+"/?language="+b.language.language+"&preview-language="+b.language.pk;a.editController(b,{elementKey:"language",modelKey:"editableLanguage",update:c.supportedLanguage.update,remove:c.supportedLanguage.remove,params:function(){return{shortname:b.company.shortname,languagePk:b.language.pk}},successCallback:function(){e.success(interpolate(T("Updated %(languageName)s"),{languageName:b.language.unicode}))},removeCallback:function(){e.success(interpolate(T("Deleted %(languageName)s"),
{languageName:b.language.unicode}));delete b.language;f.broadcast("translations.language.deleted");g.navigate(b.company.$url(h.dashboard.settings.translations.index))},refreshActivities:!0,editing:!0})}]);h.controller("dashboard.settings.translations.TranslationOverlayCtrl",["$scope","$timeout","auth","controllers","db","events","models","navigation","urls",function(b,a,c,f,e,g,d,h,m){var k=this;b.MARKDOWN_TEXTAREA_FIELD_TYPE="TranslatableMarkdownField";b.canUpdateLanguages=c.permissions.canUpdate(d.SupportedLanguage,
b.company)||c.permissions.canUpdate(d.Translation,b.company);a=function(){var a={shortname:b.company.shortname,objectType:d.Translation.modelNameFromUrl(b.route.bindings.objectType),objectId:b.route.bindings.objectId,objectField:d.Translation.fieldNameFromUrl(b.route.bindings.objectField)};k.subfield&&(a.subfield=k.subfield);return a};b.route.bindings.subfield&&(k.subfield=d.Translation.fieldNameFromUrl(b.route.bindings.subfield));k.languages=e.supportedLanguages({shortname:b.company.shortname});
k.fieldValueKey=function(a){return"fieldValue"+a.pk};e=b.route.bindings.subfield?e.translationsForSubfield:e.translationsForField;var n=e(a());f.dataController(b,{promises:[n.$promise,k.languages.$promise],successCallback:function(){k.updatableTranslationModels={};k.sourceField=n.sourceField;k.sourceFieldValue=n.sourceFieldValue;k.displayNameForInstance=n.sourceObjectName;k.translationsByLanguage=[];_.forEach(k.languages,function(a){var b=_.find(n.translationsForField,function(b){return b.supportedLanguage.pk===
a.pk})||{fieldValue:""};k.translationsByLanguage.push({supportedLanguage:a,translation:b});var c=b.fieldValue;k.subfield&&(b=b.fieldValue[_.camelCase(k.subfield)],c=k.sourceFieldValue!==b?b:"");k.updatableTranslationModels[k.fieldValueKey(a)]=c});k.highlightLanguage=h.getPk(d.SupportedLanguage.SCROLL_TO_LANGUAGE_PARAM)}});b.$on("$destroy",function(){h.clear(d.SupportedLanguage.SCROLL_TO_LANGUAGE_PARAM,!0)});f.editController(b,{update:e.update,elementKey:"",refreshActivities:!0,params:a,submitCallback:function(){k.errors=
{};return k.updatableTranslationModels},successCallback:function(){h.navigate(b.company.$url(m.dashboard.translationsOverlay.close))}})}])})();angular.module("dashboard.settings.pricing",["dashboard.settings.pricing.controllers"]);
(function(){var h=angular.module("dashboard.settings.pricing.controllers",[]);h.controller("dashboard.settings.pricing.IndexCtrl",["$scope","controllers","db","models","require",function(a,b,f,e,g){g.inScope(a,"company","dashboard.settings.pricing.IndexCtrl");var d=f.totalSheets({shortname:a.company.shortname}),h=f.invoiceSheets({shortname:a.company.shortname});a.totalSchedules=f.totalSchedules({shortname:a.company.shortname});a.invoiceSchedules=f.invoiceSchedules({shortname:a.company.shortname});
b.dataController(a,{promises:[d.$promise,h.$promise,a.totalSchedules.$promise,a.invoiceSchedules.$promise],successCallback:function(){a.totalSheets=e.TotalSheet.nonBaseSheets(d);a.totalSheets.base=e.TotalSheet.baseSheet(d);a.totalSheets.totalBase=e.TotalSheet.totalBaseSheet(d);a.invoiceSheets=e.InvoiceSheet.nonBaseSheets(h);a.invoiceSheets.invoiceBase=e.InvoiceSheet.invoiceBaseSheet(h)}})}]);h.controller("dashboard.settings.pricing.OverviewCtrl",["$scope","controllers","db","models","require",function(a,
b,f,e,g){g.inScope(a,"company","dashboard.settings.pricing.IndexCtrl");a.items=f.items({shortname:a.company.shortname});a.customerTypes=f.customerTypes({shortname:a.company.shortname});a.resources=f.resources({shortname:a.company.shortname});a.customFields=f.customFields({shortname:a.company.shortname});b.dataController(a,{promises:[a.items.$promise,a.resources.$promise]})}]);h.controller("dashboard.settings.pricing.TotalSheetsCtrl",["$scope","controllers","db","models","navigation","require","urls",
function(a,b,f,e,g,d,h){d.inScope(a,"company","dashboard.settings.pricing.TotalSheetsCtrl");d.inScope(a,"totalSheets","dashboard.settings.pricing.TotalSheetsCtrl");b.listController(a,{collectionKey:"totalSheets",modelKey:"newTotalSheet",create:f.totalSheets.create,params:function(){return{shortname:a.company.shortname}},defaultModel:{name:"",sheetRate:"0",isCascading:!0,isTaxable:!0},submitCallback:function(){return{sheetRate:e.PriceSheet.sheetRateToModel(e.TotalSheet.fromDisplaySheetRate(e.PriceSheet.sheetRateFromModel(a.newTotalSheet.sheetRate)))}},
successCallback:function(a){g.navigate(a.$url(h.dashboard.settings.pricing.totalSheet))},sortable:!0})}]);h.controller("dashboard.settings.pricing.TotalSheetCtrl",["$scope","controllers","db","require",function(a,b,f,e){e.inScope(a,"company","dashboard.settings.pricing.TotalSheetCtrl");a.totalSheet=f.totalSheet({shortname:a.company.shortname,totalSheetPk:a.route.bindings.totalSheetPk});b.dataController(a,{promises:[a.totalSheet.$promise]})}]);h.controller("dashboard.settings.pricing.TotalSheetEditableCtrl",
["$scope","controllers","dashboard.shared.duplicatingController","db","events","flash","models","navigation","require","urls",function(a,b,f,e,g,d,h,m,k,n){k.inScope(a,"company","dashboard.settings.pricing.TotalSheetEditableCtrl");k.inScope(a,"totalSheet","dashboard.settings.pricing.TotalSheetEditableCtrl");k.inScope(a,"totalSheets","dashboard.settings.pricing.TotalSheetEditableCtrl");a.isEditable=!a.totalSheet.isBase&&!a.totalSheet.isTotalBase;a.isEditable&&(f(a,{endpoint:e.totalSheet.duplicate,
params:function(){return{shortname:a.totalSheet.company.shortname,totalSheetPk:a.totalSheet.pk}},successCallback:function(b){d.success(T("Your price sheet has been duplicated."));var c=e.totalSheet({shortname:a.company.shortname,totalSheetPk:b});c.$promise.then(function(){a.totalSheets.push(c);m.navigate(c.$url())})}}),b.editController(a,{collectionKey:"totalSheets",elementKey:"totalSheet",modelKey:"editableTotalSheet",update:e.totalSheet.update,remove:e.totalSheet.remove,params:function(){return{shortname:a.totalSheet.company.shortname,
totalSheetPk:a.totalSheet.pk}},editCallback:function(){a.editableTotalSheet.sheetRate=h.PriceSheet.sheetRateToModel(h.TotalSheet.displaySheetRate(a.totalSheet.sheetRate))},submitCallback:function(){return{sheetRate:h.PriceSheet.sheetRateToModel(h.TotalSheet.fromDisplaySheetRate(h.PriceSheet.sheetRateFromModel(a.editableTotalSheet.sheetRate)))}},successCallback:function(){g.broadcast("pricing.ngPricing.refresh",{object:a.company});g.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){m.navigate(a.company.$url(n.dashboard.settings.pricing.index));
d.success(T("Deleted total price sheet"))}}))}]);h.controller("dashboard.settings.pricing.InvoiceSheetsCtrl",["$scope","controllers","db","events","models","navigation","require","urls",function(a,b,f,e,g,d,h,m){h.inScope(a,"company","dashboard.settings.pricing.InvoiceSheetsCtrl");h.inScope(a,"invoiceSheets","dashboard.settings.pricing.InvoiceSheetsCtrl");b.listController(a,{collectionKey:"invoiceSheets",modelKey:"newInvoiceSheet",create:f.invoiceSheets.create,params:function(){return{shortname:a.company.shortname}},
defaultModel:{name:"",relationship:g.InvoiceSheet.CHARTER_RELATIONSHIP,sheetRate:"",isCascading:!0,taxability:g.PriceSheet.NONE_TAXABILITY},submitCallback:function(){return{sheetRate:g.PriceSheet.sheetRateToModel(g.InvoiceSheet.fromDisplaySheetRate(g.PriceSheet.sheetRateFromModel(a.newInvoiceSheet.sheetRate),a.newInvoiceSheet.relationship))}},successCallback:function(a){d.navigate(a.$url(m.dashboard.settings.pricing.invoiceSheet))},sortable:!0})}]);h.controller("dashboard.settings.pricing.InvoiceSheetCtrl",
["$scope","controllers","db","navigation","require",function(a,b,f,e,g){g.inScope(a,"company","dashboard.settings.pricing.InvoiceSheetCtrl");a.invoiceSheet=f.invoiceSheet({shortname:a.company.shortname,invoiceSheetPk:a.route.bindings.invoiceSheetPk});b.dataController(a,{promises:[a.invoiceSheet.$promise]})}]);h.controller("dashboard.settings.pricing.InvoiceSheetEditableCtrl",["$scope","controllers","dashboard.shared.duplicatingController","db","events","flash","models","navigation","require","urls",
function(a,b,f,e,g,d,h,m,k,n){k.inScope(a,"invoiceSheet","dashboard.settings.pricing.InvoiceSheetEditableCtrl");k.inScope(a,"invoiceSheets","dashboard.settings.pricing.InvoiceSheetEditableCtrl");a.isEditable=!a.invoiceSheet.isInvoiceBase;a.isEditable&&(f(a,{endpoint:e.invoiceSheet.duplicate,params:function(){return{shortname:a.invoiceSheet.company.shortname,invoiceSheetPk:a.invoiceSheet.pk}},successCallback:function(b){d.success(T("Your price sheet has been duplicated."));var c=e.invoiceSheet({shortname:a.company.shortname,
invoiceSheetPk:b});c.$promise.then(function(){a.invoiceSheets.push(c);m.navigate(c.$url())})}}),b.editController(a,{collectionKey:"invoiceSheets",elementKey:"invoiceSheet",modelKey:"editableInvoiceSheet",update:e.invoiceSheet.update,remove:e.invoiceSheet.remove,params:function(){return{shortname:a.invoiceSheet.company.shortname,invoiceSheetPk:a.invoiceSheet.pk}},editCallback:function(){a.editableInvoiceSheet.sheetRate=h.PriceSheet.sheetRateToModel(h.InvoiceSheet.displaySheetRate(a.invoiceSheet.sheetRate,
a.invoiceSheet.relationship))},submitCallback:function(){return{sheetRate:h.PriceSheet.sheetRateToModel(h.InvoiceSheet.fromDisplaySheetRate(h.PriceSheet.sheetRateFromModel(a.editableInvoiceSheet.sheetRate),a.editableInvoiceSheet.relationship))}},successCallback:function(){g.broadcast("pricing.ngPricing.refresh",{object:a.company});g.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){m.navigate(a.company.$url(n.dashboard.settings.pricing.index));d.success(T("Deleted invoice price sheet"))}}))}]);
var b=function(a){h.controller(a.controllerName,["$scope","controllers","db","navigation","require","urls",function(b,f,e,g,d,h){d.inScope(b,"company",a.controllerName);d.inScope(b,a.collectionKey,a.controllerName);b.sheets=b[a.sheets];f.listController(b,{collectionKey:a.collectionKey,modelKey:a.modelKey,create:_.getDotted(e,a.create),params:function(){return{shortname:b.company.shortname}},successCallback:function(b){g.navigate(b.$url(_.getDotted(h,a.url)))}})}])};b({controllerName:"dashboard.settings.pricing.TotalSchedulesCtrl",
collectionKey:"totalSchedules",modelKey:"newTotalSchedule",create:"totalSchedules.create",url:"dashboard.settings.pricing.totalSchedules.index",sheets:"totalSheets"});b({controllerName:"dashboard.settings.pricing.InvoiceSchedulesCtrl",collectionKey:"invoiceSchedules",modelKey:"newInvoiceSchedule",create:"invoiceSchedules.create",url:"dashboard.settings.pricing.invoiceSchedules.index",sheets:"invoiceSheets"});b=function(a){h.controller(a.controllerName,["$scope","controllers","db","require",function(b,
f,e,g){g.inScope(b,"company",a.controllerName);b.sheets=b[a.sheets];g={shortname:b.company.shortname};g[a.schedulePkKey]=b.route.bindings[a.schedulePkKey];b[a.scheduleKey]=e[a.scheduleKey](g);f.dataController(b,{promises:[b[a.scheduleKey].$promise]})}])};b({controllerName:"dashboard.settings.pricing.TotalScheduleCtrl",scheduleKey:"totalSchedule",schedulePkKey:"totalSchedulePk",entriesKey:"totalScheduleEntries",sheets:"totalSheets"});b({controllerName:"dashboard.settings.pricing.InvoiceScheduleCtrl",
scheduleKey:"invoiceSchedule",schedulePkKey:"invoiceSchedulePk",entriesKey:"invoiceScheduleEntries",sheets:"invoiceSheets"});b=function(a){h.controller(a.name,["$scope","controllers","db","dashboard.shared.duplicatingController","events","flash","navigation","require","urls",function(b,f,e,g,d,h,m,k,n){k.inScope(b,a.scheduleKey,a.name);k.inScope(b,a.schedulesKey,a.name);d=function(){var d={shortname:b[a.scheduleKey].company.shortname};d[a.scheduleKey+"Pk"]=b[a.scheduleKey].pk;return d};g(b,{endpoint:e[a.scheduleKey].duplicate,
params:d,successCallback:function(d){b[a.schedulesKey].push(d);h.success(interpolate(T("Duplicated %(scheduleName)s"),{scheduleName:b[a.scheduleKey].displayName}));m.navigate(d.$url(n.dashboard.settings.pricing[a.schedulesKey].index))}});f.editController(b,{collectionKey:a.schedulesKey,elementKey:a.scheduleKey,modelKey:a.modelKey,update:e[a.scheduleKey].update,remove:e[a.scheduleKey].remove,editing:!0,params:d,refreshActivities:!0,skipResetAfterError:!0,successCallback:function(){h.success(interpolate(T("Updated %(scheduleName)s"),
{scheduleName:b[a.scheduleKey].displayName}))},editCallback:function(){b[a.modelKey].fallback=_.get(b[a.scheduleKey],"fallback.pk",null)},removeCallback:function(){h.success(interpolate(T("Deleted %(scheduleName)s"),{scheduleName:b[a.scheduleKey].displayName}));m.navigate(b.company.$url(n.dashboard.settings.pricing.schedules))}})}])};b({name:"dashboard.settings.pricing.TotalScheduleEditableCtrl",scheduleKey:"totalSchedule",schedulesKey:"totalSchedules",modelKey:"editableTotalSchedule"});b({name:"dashboard.settings.pricing.InvoiceScheduleEditableCtrl",
scheduleKey:"invoiceSchedule",schedulesKey:"invoiceSchedules",modelKey:"editableInvoiceSchedule"});b=function(a){h.controller(a.name,["$scope","controllers","db","models","require",function(b,f,e,g,d){d.inScope(b,a.scheduleKey,a.name);var h={shortname:b.company.shortname};h[a.scheduleKey+"Pk"]=b[a.scheduleKey].pk;b[a.entriesKey]=e[a.entriesKey](h);f.dataController(b,{promises:[b[a.entriesKey].$promise],successCallback:function(){f.listController(b,{collectionKey:a.entriesKey,modelKey:a.modelKey,get:e[a.entriesKey],
create:e[a.entriesKey].create,remove:e[a.entriesKey].remove,refreshActivities:!0,params:h,sortable:!0,adding:!b[a.entriesKey].length,closeAfterSubmit:!1,reset:!0})}})}])};b({name:"dashboard.settings.pricing.TotalScheduleEntriesCtrl",scheduleKey:"totalSchedule",entriesKey:"totalScheduleEntries",modelKey:"newTotalScheduleEntry"});b({name:"dashboard.settings.pricing.InvoiceScheduleEntriesCtrl",scheduleKey:"invoiceSchedule",entriesKey:"invoiceScheduleEntries",modelKey:"newInvoiceScheduleEntry"});b=function(a){h.controller(a.name,
["$scope","controllers","db","require",function(b,f,e,g){g.inScope(b,"company",a.name);g={shortname:b.company.shortname};g[a.scheduleKey+"Pk"]=b[a.scheduleKey].pk;g[a.scheduleEntryKey+"Pk"]=b.route.bindings[a.scheduleEntryKey+"Pk"];b[a.scheduleEntryKey]=e[a.scheduleEntryKey](g);f.dataController(b,{promises:[b[a.scheduleEntryKey].$promise]})}])};b({name:"dashboard.settings.pricing.TotalScheduleEntryCtrl",scheduleKey:"totalSchedule",scheduleEntryKey:"totalScheduleEntry"});b({name:"dashboard.settings.pricing.InvoiceScheduleEntryCtrl",
scheduleKey:"invoiceSchedule",scheduleEntryKey:"invoiceScheduleEntry"});b=function(a){h.controller(a.controllerName,["$scope","controllers","db","flash","models","navigation","require","urls",function(b,f,e,g,d,h,m,k){m.inScope(b,a.elementKey,a.controllerName);m.inScope(b,"totalSchedules",a.controllerName);m.inScope(b,"invoiceSchedules",a.controllerName);f.editController(b,{elementKey:a.elementKey,modelKey:a.modelKey,update:e[a.elementKey].update,remove:e[a.elementKey].remove,refreshActivities:!0,
editing:!0,params:function(){var d={};d.shortname=b.company.shortname;d[a.scheduleKey+"Pk"]=b[a.elementKey].schedule.pk;d[a.scheduleKey+"EntryPk"]=b[a.elementKey].pk;return d},editCallback:function(){b[a.modelKey].sheet=b[a.elementKey].sheet.pk},successCallback:function(){g.success(interpolate(T("Updated %(scheduleName)s"),{scheduleName:b[a.elementKey].sheet.displayName}))},removeCallback:function(){g.success(interpolate(T("Removed %(scheduleName)s"),{scheduleName:b[a.elementKey].sheet.displayName}));
h.navigate(b[a.elementKey].schedule.$url(_.getDotted(k,a.removeCallbackUrl)))}});f.dataController(b,{promises:[b.invoiceSheets.$promise,b.totalSheets.$promise],successCallback:function(){b.totalSheets=d.TotalSheet.nonBaseSheets(b.totalSheets);b.invoiceSheets=d.InvoiceSheet.nonBaseSheets(b.invoiceSheets)}})}])};b({scheduleKey:"totalSchedule",elementKey:"totalScheduleEntry",modelKey:"editableTotalScheduleEntry",removeCallbackUrl:"dashboard.settings.pricing.totalSchedules.index",controllerName:"dashboard.settings.pricing.TotalScheduleEntryEditableCtrl"});
b({scheduleKey:"invoiceSchedule",elementKey:"invoiceScheduleEntry",modelKey:"editableInvoiceScheduleEntry",removeCallbackUrl:"dashboard.settings.pricing.invoiceSchedules.index",controllerName:"dashboard.settings.pricing.InvoiceScheduleEntryEditableCtrl"});b=function(a){h.controller(a.name,["$scope","controllers","db","flash","models","require",function(b,f,e,g,d,h){h.inScope(b,"company",a.name);h.inScope(b,a.entryKey,a.name);var m=function(){var d={};d.shortname=b.company.shortname;d[a.scheduleKey+
"Pk"]=b[a.entryKey].schedule.pk;d[a.scheduleKey+"EntryPk"]=b[a.entryKey].pk;return d};b.isWeekdaysEmpty=function(){return d.ScheduleEntryRule.isDayOfWeekType(b.newRule)&&!_.any(d.Rule.WEEK_DAYS_KEYS,function(a){return b.newRule[a]})};b.rules=e[a.rulesKey](m());var k=function(){b.groupedRules=d.ScheduleEntryRule.groupRules(b.rules,b.company)};f.dataController(b,{promises:[b.rules.$promise],successCallback:function(){k();f.listController(b,{collectionKey:"rules",modelKey:"newRule",get:e[a.rulesKey],
remove:e[a.ruleKey].remove,refreshActivities:!0,successCallback:function(){k()},removeCallback:function(){g.success(T("Deleted rule"));k()},defaultModel:{type:"booking"},params:m,adding:!b.rules.length,closeAfterSubmit:!1,reset:!1})}})}])};b({name:"dashboard.settings.pricing.TotalScheduleEntryRulesCtrl",scheduleKey:"totalSchedule",entryKey:"totalScheduleEntry",ruleKey:"totalScheduleEntryRule",rulesKey:"totalScheduleEntryRules"});b({name:"dashboard.settings.pricing.InvoiceScheduleEntryRulesCtrl",scheduleKey:"invoiceSchedule",
entryKey:"invoiceScheduleEntry",ruleKey:"invoiceScheduleEntryRule",rulesKey:"invoiceScheduleEntryRules"});h.controller("dashboard.settings.TaxTypesCtrl",["$scope","controllers","db","models","navigation","require","urls",function(a,b,f,e,g,d,h){d.inScope(a,"company","dashboard.settings.TaxTypesCtrl");a.taxTypes=f.taxTypes({shortname:a.company.shortname});return b.dataController(a,{promises:[a.taxTypes.$promise],successCallback:function(){b.listController(a,{collectionKey:"taxTypes",modelKey:"newTaxType",
create:f.taxTypes.create,params:function(){return{shortname:a.company.shortname}},sortable:!0,submitCallback:function(){a.newTaxType.type===e.TaxType.RATE_TYPE?a.newTaxType.offset=0:a.newTaxType.rate=0},successCallback:function(a){g.navigate(a.$url(h.dashboard.settings.payments.taxTypes.taxType))},defaultModel:{type:e.TaxType.RATE_TYPE,rate:0,offset:0}})}})}]);h.controller("dashboard.settings.TaxTypeCtrl",["$scope","controllers","db","require",function(a,b,f,e){e.inScope(a,"company","dashboard.settings.TaxTypeCtrl");
a.taxType=f.taxType({shortname:a.company.shortname,taxTypePk:a.route.bindings.taxTypePk});a.baseSheets=f.totalSheets.bases({shortname:a.company.shortname});b.dataController(a,{promises:[a.taxType.$promise,a.baseSheets.$promise]})}]);h.controller("dashboard.shared.TaxTypeEditableCtrl",["$scope","controllers","db","events","flash","models","navigation","require","urls",function(a,b,f,e,g,d,h,m,k){m.inScope(a,"taxType","dashboard.shared.TaxTypeEditableCtrl");return b.editController(a,{collectionKey:"taxTypes",
elementKey:"taxType",modelKey:"editableTaxType",update:f.taxType.update,remove:f.taxType.remove,editing:!0,skipResetAfterError:!0,params:function(){return{shortname:a.taxType.company.shortname,taxTypePk:a.taxType.pk}},editCallback:function(){a.editableTaxType.rate=a.taxType.percentage},submitCallback:function(){a.editableTaxType.type===d.TaxType.RATE_TYPE?a.editableTaxType.offset=0:a.editableTaxType.rate=0},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){g.success(interpolate(T("Removed %(taxTypeName)s"),
{taxTypeName:a.taxType.name}));h.navigate(a.taxType.$url(k.dashboard.settings.payments.taxTypes.index))}})}])})();angular.module("dashboard.settings.storedValue",["dashboard.settings.storedValue.controllers"]);
(function(){var h=angular.module("dashboard.settings.storedValue.controllers",[]);h.controller("dashboard.settings.storedValue.IndexCtrl",["$scope","require",function(b,a){a.inScope(b,"company","dashboard.settings.storedValue.IndexCtrl")}]);h.controller("dashboard.settings.storedValue.StoredValueTypesCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.settings.storedValue.StoredValueTypesCtrl");b.storedValueTypes=c.storedValueTypes({shortname:b.company.shortname});
a.dataController(b,{promises:[b.storedValueTypes.$promise],successCallback:function(){a.listController(b,{collectionKey:"storedValueTypes",modelKey:"newStoredValueType",create:c.storedValueTypes.create,params:function(){return{shortname:b.company.shortname}},defaultModel:{name:"",shortName:""}})}})}]);h.controller("dashboard.settings.storedValue.StoredValueTypeEditableCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"storedValueType","dashboard.settings.storedValue.StoredValueTypeEditableCtrl");
f.inScope(b,"storedValueTypes","dashboard.settings.storedValue.StoredValueTypeEditableCtrl");return a.editController(b,{collectionKey:"storedValueTypes",elementKey:"storedValueType",modelKey:"editableStoredValueType",update:c.storedValueType.update,remove:c.storedValueType.remove,params:function(){return{shortname:b.storedValueType.company.shortname,storedValueTypePk:b.storedValueType.pk}}})}]);h.controller("dashboard.settings.storedValue.StoredValueCardsCtrl",["$scope","auth","controllers","db",
"events","flash","models","pagination","require",function(b,a,c,f,e,g,d,h,m){m.inScope(b,"company","dashboard.settings.storedValue.StoredValueCardsCtrl");b.options={showInternalIdentifier:!1};a.permissions.canList(d.StoredValueCard,b.company)?b.endpoint=h.endpoint(f.storedValueCards,{shortname:b.company.shortname}):b.endpoint=h.constant([]);b.storedValueTypes=f.storedValueTypes({shortname:b.company.shortname});c.dataController(b,{promises:[b.storedValueTypes.$promise],successCallback:function(){c.listController(b,
{modelKey:"newStoredValueCard",create:f.storedValueCards.create,successCallback:function(a){g.success(b.$interpolate(interpolate(nT("Created %(count)s card","Created %(count)s cards",a.length),{count:a.length})));e.broadcast("ng-pagination.refresh");e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},params:function(){return{shortname:b.company.shortname}},defaultModel:{type:"simple",amount:"",notes:"",count:1,code:"",codes:"",storedValueType:0<b.storedValueTypes.length?b.storedValueTypes[0].pk:
""},overwrite:!0})}})}]);h.controller("dashboard.settings.storedValue.StoredValueCardCtrl",["$scope","controllers","db","navigation","require",function(b,a,c,f,e){e.inScope(b,"company","dashboard.settings.storedValue.StoredValueCardCtrl");b.storedValueCard=c.storedValueCard({shortname:b.company.shortname,storedValueCardPk:b.route.bindings.storedValueCardPk});b.storedValueTypes=c.storedValueTypes({shortname:b.company.shortname});a.dataController(b,{promises:[b.storedValueCard.$promise,b.storedValueTypes.$promise]})}]);
h.controller("dashboard.settings.storedValue.StoredValueCardEditableCtrl",["$scope","controllers","db","events","flash","navigation","require","urls",function(b,a,c,f,e,g,d,h){d.inScope(b,"company","dashboard.settings.storedValue.StoredValueCardEditableCtrl");d.inScope(b,"storedValueCard","dashboard.settings.storedValue.StoredValueCardEditableCtrl");d.inScope(b,"storedValueTypes","dashboard.settings.storedValue.StoredValueCardEditableCtrl");return a.editController(b,{elementKey:"storedValueCard",
modelKey:"editableStoredValueCard",update:c.storedValueCard.update,remove:c.storedValueCard.remove,editCallback:function(){b.editableStoredValueCard.storedValueType=b.storedValueCard.storedValueType.pk},successCallback:function(){f.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},params:function(){return{shortname:b.storedValueCard.company.shortname,storedValueCardPk:b.storedValueCard.pk}},editing:!0,removeCallback:function(a){e.success(T("Removed card"));g.redirect(b.company.$url(h.dashboard.settings.storedValue.storedValueCards))}})}]);
h.controller("dashboard.settings.storedValue.StoredValueTransactionsCtrl",["$scope","controllers","db","events","models","navigation","require",function(b,a,c,f,e,g,d){d.inScope(b,"storedValueCard","dashboard.settings.storedValue.StoredValueTransactionsCtrl");b.storedValueAdjustments=c.storedValueAdjustments({shortname:b.storedValueCard.company.shortname,storedValueCardPk:b.storedValueCard.pk});b.payments=c.storedValueCard.payments({shortname:b.storedValueCard.company.shortname,storedValueCardPk:b.storedValueCard.pk});
b.transactions=[];var h={};h[e.StoredValueAdjustment.cls]=function(a){return a.user};h[e.Payment.cls]=function(a){return a.user};h[e.Refund.cls]=function(a){return a.user};b.transactionUser=function(a){return h[a.cls](a)};var m={};m[e.StoredValueAdjustment.cls]=function(a){return a.offset};m[e.Payment.cls]=function(a){return-a.initialReceipt.gross};m[e.Refund.cls]=function(a){return a.receipt.gross};b.transactionOffset=function(a){return m[a.cls](a)};b.transactionType=function(a){return a.cls===e.StoredValueAdjustment.cls?
"adjustment":a.cls};b.transactionBooking=function(a){return a.payment?a.payment.booking:a.booking||null};b.transactionNote=function(a){return a.cls===e.StoredValueAdjustment.cls?a.noteSafeHtml:""};var k=function(){_.clear(b.transactions);_.ref.append(b.transactions,b.storedValueAdjustments,b.payments);_.forEach(b.payments,function(a){_.ref.append(b.transactions,a.refunds)})};a.dataController(b,{promises:[b.storedValueAdjustments.$promise,b.payments.$promise],successCallback:function(){k();a.listController(b,
{collectionKey:"transactions",modelKey:"newStoredValueAdjustment",create:c.storedValueAdjustments.create,successCallback:function(){b.storedValueAdjustments=c.storedValueAdjustments({shortname:b.storedValueCard.company.shortname,storedValueCardPk:b.storedValueCard.pk});b.storedValueAdjustments.$promise.then(k)},params:function(){return{shortname:b.storedValueCard.company.shortname,storedValueCardPk:b.storedValueCard.pk}},defaultModel:{offset:"",note:""}})}})}])})();
angular.module("dashboard.settings.reseller",["dashboard.settings.reseller.controllers"]);
(function(){var h=angular.module("dashboard.settings.reseller.controllers",[]);h.controller("dashboard.settings.reseller.ResellerCompaniesCtrl",["$scope","require","controllers","db","navigation",function(b,a,c,f,e){a.inScope(b,"company","dashboard.settings.reseller.ResellerCompaniesCtrl");c.listController(b,{collectionKey:"resellerCompanies",modelKey:"newResellerCompany",get:f.resellerCompanies,params:function(){return{shortname:b.company.shortname}}})}]);h.controller("dashboard.settings.reseller.ResellerCompanyCtrl",
["$scope","auth","controllers","db","models","require",function(b,a,c,f,e,g){g.inScope(b,"company","dashboard.settings.reseller.ResellerCompanyCtrl");g=[];b.resellerCompany=null;a.permissions.canList(e.ResellerCompany,b.company)&&(b.resellerCompany=f.resellerCompany({shortname:b.company.shortname,resellerCompanyPk:b.route.bindings.resellerCompanyPk}),g.push(b.resellerCompany.$promise));c.dataController(b,{promises:g})}]);h.controller("dashboard.settings.reseller.ResellerCompanyEditableCtrl",["$scope",
"controllers","db","require","flash","navigation","urls",function(b,a,c,f,e,g,d){f.inScope(b,"resellerCompany","dashboard.settings.reseller.ResellerCompanyEditableCtrl");a.editController(b,{elementKey:"resellerCompany",modelKey:"editableResellerCompany",get:c.resellerCompany,remove:c.resellerCompany.remove,editCallback:function(){_.extendWithPrefix("settings-",b.editableResellerCompany,b.resellerCompany.settings)},params:function(){return{shortname:b.company.shortname,resellerCompanyPk:b.resellerCompany.pk}},
removeCallback:function(){e.success(T("Removed reseller company"));g.redirect(b.company.$url(d.dashboard.settings.reseller.index))},refreshActivities:!0,editing:!0})}]);h.controller("dashboard.settings.reseller.ResellerCompanyMappingsCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"resellerCompany","dashboard.settings.reseller.ResellerCompanyMappingsCtrl");b.companiesEndpoint=c.searchEndpoint(c.companies.pickable);a.listController(b,{collectionKey:"resellerCompanyMappings",
modelKey:"newResellerCompanyMapping",get:c.resellerCompanyMappings,remove:c.resellerCompanyMapping.remove,params:function(){return{shortname:b.company.shortname,resellerCompanyPk:b.resellerCompany.pk}},refreshActivities:!0})}]);h.controller("dashboard.settings.reseller.ResellerItemsCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"resellerCompany","dashboard.settings.reseller.ResellerItemsCtrl");a.listController(b,{collectionKey:"resellerItems",modelKey:"newResellerItem",
get:c.resellerItems,remove:c.resellerItem.remove,params:function(){return{shortname:b.company.shortname,resellerCompanyPk:b.resellerCompany.pk}},refreshActivities:!0})}]);h.controller("dashboard.settings.reseller.ResellerItemCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.settings.reseller.ResellerItemCtrl");b.resellerItem=c.resellerItem({shortname:b.company.shortname,resellerCompanyPk:b.route.bindings.resellerCompanyPk,resellerItemPk:b.route.bindings.resellerItemPk},
null,null,{availabilityCount:!0});a.dataController(b,{promises:[b.resellerItem.$promise]})}]);h.controller("dashboard.settings.reseller.ResellerItemEditableCtrl",["$scope","controllers","db","require","flash","navigation","urls",function(b,a,c,f,e,g,d){f.inScope(b,"resellerItem","dashboard.settings.reseller.ResellerItemEditableCtrl");f.inScope(b,"company","dashboard.settings.reseller.ResellerItemEditableCtrl");a.editController(b,{elementKey:"resellerItem",modelKey:"editableResellerItem",get:c.resellerItem,
editCallback:function(){_.extendWithPrefix("settings-",b.editableResellerItem,b.resellerItem.settings)},params:function(){return{shortname:b.company.shortname,resellerCompanyPk:b.resellerItem.resellerCompany.pk,resellerItemPk:b.resellerItem.pk}},remove:c.resellerItem.remove,removeCallback:function(){e.success(T("Removed reseller item"));g.redirect(b.resellerItem.resellerCompany.$url())},editing:!0,refreshActivities:!0})}]);h.controller("dashboard.settings.reseller.ResellerItemMappingsCtrl",["$scope",
"controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.settings.reseller.ResellerItemMappingsCtrl");f.inScope(b,"resellerItem","dashboard.settings.reseller.ResellerItemMappingsCtrl");b.refreshUnmappedItems=function(){b.unmappedItems=c.resellerUnmappedItems({shortname:b.company.shortname,resellerCompanyPk:b.resellerItem.resellerCompany.pk,resellerItemPk:b.resellerItem.pk})};b.refreshUnmappedItems();a.listController(b,{collectionKey:"resellerItemMappings",modelKey:"newResellerItemMapping",
get:c.resellerItemMappings,remove:c.resellerItemMapping.remove,params:function(){return{shortname:b.company.shortname,resellerCompanyPk:b.resellerItem.resellerCompany.pk,resellerItemPk:b.resellerItem.pk}},successCallback:function(){b.refreshUnmappedItems()},removeCallback:function(){b.refreshUnmappedItems()},refreshActivities:!0})}]);h.controller("dashboard.settings.reseller.ResellerCustomerTypesCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.settings.reseller.ResellerCustomerTypesCtrl");
f.inScope(b,"resellerItem","dashboard.settings.reseller.ResellerCustomerTypesCtrl");a.listController(b,{collectionKey:"resellerCustomerTypes",modelKey:"newResellerCustomerType",get:c.resellerCustomerTypes,params:function(){return{shortname:b.company.shortname,resellerCompanyPk:b.resellerItem.resellerCompany.pk,resellerItemPk:b.resellerItem.pk}},refreshActivities:!0})}]);h.controller("dashboard.settings.reseller.ResellerCustomerTypeCtrl",["$q","$scope","controllers","db","require",function(b,a,c,f,
e){e.inScope(a,"company","dashboard.settings.reseller.ResellerCustomerTypeCtrl");var g=[{shortname:a.company.shortname,resellerCompanyPk:a.route.bindings.resellerCompanyPk,resellerItemPk:a.route.bindings.resellerItemPk,resellerCustomerTypePk:a.route.bindings.resellerCustomerTypePk},null,null,{availabilityCount:!0}],d=f.resellerCustomerType;a.resellerCustomerType=d.apply(f,g);a.refreshResellerCustomerType=function(){var b=d.apply(f,g);b.$promise.then(function(){a.resellerCustomerType=b})};c.dataController(a,
{promises:[a.resellerCustomerType.$promise]})}]);h.controller("dashboard.settings.reseller.ResellerCustomerTypeEditableCtrl",["$scope","controllers","db","require","flash","navigation","urls",function(b,a,c,f,e,g,d){f.inScope(b,"resellerCustomerType","dashboard.settings.reseller.ResellerCustomerTypeEditableCtrl");f.inScope(b,"company","dashboard.settings.reseller.ResellerCustomerTypeEditableCtrl");a.editController(b,{elementKey:"resellerCustomerType",modelKey:"editableResellerCustomerType",get:c.resellerCustomerType,
params:function(){return{shortname:b.company.shortname,resellerCompanyPk:b.resellerCustomerType.resellerItem.resellerCompany.pk,resellerItemPk:b.resellerCustomerType.resellerItem.pk,resellerCustomerTypePk:b.resellerCustomerType.pk}},remove:c.resellerCustomerType.remove,removeCallback:function(){e.success(T("Removed reseller customer type"));g.redirect(b.resellerCustomerType.resellerItem.$url())},editing:!0,refreshActivities:!0})}]);h.controller("dashboard.settings.reseller.ResellerCustomerTypeMappingsCtrl",
["$scope","controllers","db","require","models",function(b,a,c,f,e){f.inScope(b,"company","dashboard.settings.reseller.ResellerCustomerTypeMappingsCtrl");f.inScope(b,"resellerCustomerType","dashboard.settings.reseller.ResellerCustomerTypeMappingsCtrl");f.inScope(b,"refreshResellerCustomerType","dashboard.settings.reseller.ResellerCustomerTypeEditableCtrl");var g=b.resellerCustomerType.resellerItem,d=g.resellerCompany;b.refreshUnmappedCustomerPrototypes=function(){b.unmappedCustomerPrototypes=c.resellerUnmappedCustomerPrototypes({shortname:b.company.shortname,
resellerCompanyPk:d.pk,resellerItemPk:g.pk,resellerCustomerTypePk:b.resellerCustomerType.pk})};b.groupForItem=function(a){return a.item.name+" ("+cT('"ID" is abbreviation of "Identifier"',"ID:")+" "+a.item.pk+")"};b.dropdownDisplayName=function(a){return[e.CustomerPrototype.name(a),e.CustomerPrototype.customerTypeSuffix(a),a.isHidden?"("+T("hidden")+")":""].join(" ")};b.refreshUnmappedCustomerPrototypes();a.dataController(b,{promises:[c.resellerItemMappings({shortname:b.company.shortname,resellerCompanyPk:d.pk,
resellerItemPk:g.pk})],successCallback:function(){a.listController(b,{collectionKey:"resellerCustomerTypeMappings",modelKey:"newResellerCustomerTypeMapping",get:c.resellerCustomerTypeMappings,remove:c.resellerCustomerTypeMapping.remove,params:function(){return{shortname:b.company.shortname,resellerCompanyPk:d.pk,resellerItemPk:g.pk,resellerCustomerTypePk:b.resellerCustomerType.pk}},successCallback:function(){b.refreshResellerCustomerType();b.refreshUnmappedCustomerPrototypes()},refreshActivities:!0})}})}]);
h.controller("dashboard.settings.reseller.ResellerCustomerTypeMappingEditableCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.settings.reseller.ResellerCustomerTypeMappingEditableCtrl");f.inScope(b,"resellerCustomerTypeMapping","dashboard.settings.reseller.ResellerCustomerTypeMappingEditableCtrl");f.inScope(b,"resellerCustomerTypeMappings","dashboard.settings.reseller.ResellerCustomerTypeMappingEditableCtrl");f.inScope(b,"resellerCustomerType","dashboard.settings.reseller.ResellerCustomerTypeMappingEditableCtrl");
f.inScope(b,"refreshResellerCustomerType","dashboard.settings.reseller.ResellerCustomerTypeMappingEditableCtrl");f.inScope(b,"refreshUnmappedCustomerPrototypes","dashboard.settings.reseller.ResellerCustomerTypeMappingEditableCtrl");var e=b.resellerCustomerType.resellerItem,g=e.resellerCompany;a.editController(b,{collectionKey:"resellerCustomerTypeMappings",elementKey:"resellerCustomerTypeMapping",modelKey:"editableResellerCustomerTypeMapping",get:c.resellerCustomerTypeMapping,params:function(){return{shortname:b.company.shortname,
resellerCompanyPk:g.pk,resellerItemPk:e.pk,resellerCustomerTypePk:b.resellerCustomerType.pk,resellerCustomerTypeMappingPk:b.resellerCustomerTypeMapping.pk}},editCallback:function(){b.unmappedCustomerPrototypes=_.unique(_.append(b.unmappedCustomerPrototypes,[b.resellerCustomerTypeMapping.customerPrototype]));b.editableResellerCustomerTypeMapping.customerPrototype=b.resellerCustomerTypeMapping.customerPrototype.pk},successCallback:function(){b.refreshUnmappedCustomerPrototypes();b.refreshResellerCustomerType()},
removeCallback:function(){b.refreshUnmappedCustomerPrototypes();b.refreshResellerCustomerType()},refreshActivities:!0})}]);h.controller("dashboard.settings.reseller.ResellerOptionsCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.settings.reseller.ResellerOptionsCtrl");f.inScope(b,"resellerItem","dashboard.settings.reseller.ResellerOptionsCtrl");a.listController(b,{collectionKey:"resellerOptions",modelKey:"newResellerOption",get:c.resellerOptions,params:function(){return{shortname:b.company.shortname,
resellerCompanyPk:b.resellerItem.resellerCompany.pk,resellerItemPk:b.resellerItem.pk}},refreshActivities:!0})}]);h.controller("dashboard.settings.reseller.ResellerOptionCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.settings.reseller.ResellerOptionCtrl");var e=[{shortname:b.company.shortname,resellerCompanyPk:b.route.bindings.resellerCompanyPk,resellerItemPk:b.route.bindings.resellerItemPk,resellerOptionPk:b.route.bindings.resellerOptionPk},null,null,
{availabilityCount:!0}],g=c.resellerOption;b.resellerOption=g.apply(c,e);b.refreshResellerOption=function(){var a=g.apply(c,e);a.$promise.then(function(){b.resellerOption=a})};a.dataController(b,{promises:[b.resellerOption.$promise]})}]);h.controller("dashboard.settings.reseller.ResellerOptionEditableCtrl",["$scope","controllers","db","require","flash","navigation","urls",function(b,a,c,f,e,g,d){f.inScope(b,"resellerOption","dashboard.settings.reseller.ResellerOptionEditableCtrl");f.inScope(b,"company",
"dashboard.settings.reseller.ResellerOptionEditableCtrl");a.editController(b,{elementKey:"resellerOption",modelKey:"editableResellerOption",get:c.resellerOption,params:function(){return{shortname:b.company.shortname,resellerCompanyPk:b.resellerOption.resellerItem.resellerCompany.pk,resellerItemPk:b.resellerOption.resellerItem.pk,resellerOptionPk:b.resellerOption.pk}},remove:c.resellerOption.remove,removeCallback:function(){e.success(T("Removed reseller option"));g.redirect(b.resellerOption.resellerItem.$url())},
editing:!0,refreshActivities:!0})}]);h.controller("dashboard.settings.reseller.ResellerOptionMappingsCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.settings.reseller.ResellerOptionMappingsCtrl");f.inScope(b,"resellerOption","dashboard.settings.reseller.ResellerOptionMappingsCtrl");f.inScope(b,"refreshResellerOption","dashboard.settings.reseller.ResellerOptionMappingsCtrl");var e=b.resellerOption.resellerItem,g=e.resellerCompany,d=c.resellerItemMappings({shortname:b.company.shortname,
resellerCompanyPk:g.pk,resellerItemPk:e.pk});d.$promise.then(function(){b.items=_.pluck(d,"item")});a.listController(b,{collectionKey:"resellerOptionMappings",modelKey:"newResellerOptionMapping",get:c.resellerOptionMappings,remove:c.resellerOptionMapping.remove,params:function(){return{shortname:b.company.shortname,resellerCompanyPk:g.pk,resellerItemPk:e.pk,resellerOptionPk:b.resellerOption.pk}},successCallback:function(){b.refreshResellerOption()},refreshActivities:!0})}]);h.controller("dashboard.settings.reseller.ResellerOptionMappingEditableCtrl",
["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.settings.reseller.ResellerOptionMappingEditableCtrl");f.inScope(b,"resellerOptionMapping","dashboard.settings.reseller.ResellerOptionMappingEditableCtrl");f.inScope(b,"resellerOptionMappings","dashboard.settings.reseller.ResellerOptionMappingEditableCtrl");f.inScope(b,"resellerOption","dashboard.settings.reseller.ResellerOptionMappingEditableCtrl");f.inScope(b,"refreshResellerOption","dashboard.settings.reseller.ResellerOptionMappingsCtrl");
var e=b.resellerOption.resellerItem,g=e.resellerCompany;a.editController(b,{collectionKey:"resellerOptionMappings",elementKey:"resellerOptionMapping",modelKey:"editableResellerOptionMapping",get:c.resellerOptionMapping,params:function(){return{shortname:b.company.shortname,resellerCompanyPk:g.pk,resellerItemPk:e.pk,resellerOptionPk:b.resellerOption.pk,resellerOptionMappingPk:b.resellerOptionMapping.pk}},editCallback:function(){b.editableResellerOptionMapping.item=b.resellerOptionMapping.item?b.resellerOptionMapping.item.pk:
void 0},successCallback:function(){b.refreshResellerOption()},removeCallback:function(){b.refreshResellerOption()},refreshActivities:!0})}]);h.controller("dashboard.settings.reseller.ResellerKeysCtrl",["$scope","require","controllers","db","navigation",function(b,a,c,f,e){a.inScope(b,"company","dashboard.settings.reseller.ResellerKeysCtrl");a.inScope(b,"user","dashboard.settings.reseller.ResellerKeysCtrl");c.listController(b,{collectionKey:"resellerKeys",modelKey:"newResellerKey",get:f.resellerKeys,
params:function(){return{shortname:b.company.shortname,username:b.user.username}}})}]);h.controller("dashboard.settings.reseller.ResellerKeyEditableCtrl",["$scope","controllers","db","require","flash","navigation","urls",function(b,a,c,f,e,g,d){f.inScope(b,"company","dashboard.settings.reseller.ResellerKeyEditableCtrl");f.inScope(b,"user","dashboard.settings.reseller.ResellerKeyEditableCtrl");b.resellerKey=c.resellerKey({shortname:b.company.shortname,username:b.user.username,resellerKeyPk:b.route.bindings.resellerKeyPk});
a.dataController(b,{promises:[b.resellerKey.$promise],successCallback:function(){a.editController(b,{collectionKey:"resellerKeys",elementKey:"resellerKey",modelKey:"editableResellerKey",update:c.resellerKey.update,remove:c.resellerKey.remove,params:function(){return{shortname:b.company.shortname,resellerKeyPk:b.resellerKey.pk}},removeCallback:function(){e.success(T("Removed API key"));g.redirect(b.user.$url(d.dashboard.settings.permissions.user.apiKeys.index))},refreshActivities:!0,editing:!0})}})}]);
h.controller("dashboard.settings.reseller.ResellerAppsCtrl",["$scope","require","controllers","db","navigation",function(b,a,c,f,e){a.inScope(b,"company","dashboard.settings.reseller.ResellerAppsCtrl");c.listController(b,{collectionKey:"resellerApps",modelKey:"newResellerApp",get:f.resellerApps,params:function(){return{shortname:b.company.shortname}},imageUpload:!0,sortable:!0})}]);h.controller("dashboard.settings.reseller.ResellerAppCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,
"company","dashboard.settings.reseller.ResellerAppCtrl");b.resellerApp=c.resellerApp({shortname:b.company.shortname,resellerAppPk:b.route.bindings.resellerAppPk});a.dataController(b,{promises:[b.resellerApp.$promise]})}]);h.controller("dashboard.settings.reseller.ResellerAppEditableCtrl",["$scope","controllers","db","require","flash","navigation","urls",function(b,a,c,f,e,g,d){f.inScope(b,"company","dashboard.settings.reseller.ResellerAppEditableCtrl");f.inScope(b,"resellerApp","dashboard.settings.reseller.ResellerAppEditableCtrl");
f.inScope(b,"resellerApps","dashboard.settings.reseller.ResellerAppEditableCtrl");a.editController(b,{collectionKey:"resellerApps",elementKey:"resellerApp",modelKey:"editableResellerApp",update:c.resellerApp.update,remove:c.resellerApp.remove,params:function(){return{shortname:b.company.shortname,resellerAppPk:b.resellerApp.pk}},editCallback:function(){_.extendWithPrefix("settings-",b.editableResellerApp,b.resellerApp.settings)},removeCallback:function(){e.success(T("Removed channel app"));g.redirect(b.company.$url(d.dashboard.settings.reseller.apps.index))},
imageUpload:!0,refreshActivities:!0,editing:!0})}]);h.controller("dashboard.settings.reseller.ResellerAppCompaniesCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.settings.reseller.ResellerAppCompaniesCtrl");f.inScope(b,"resellerApp","dashboard.settings.reseller.ResellerAppCompaniesCtrl");b.companiesEndpoint=c.searchEndpoint(c.companies.pickable);a.listController(b,{collectionKey:"resellerAppCompanies",modelKey:"newResellerAppCompany",get:c.resellerAppCompanies,
remove:c.resellerAppCompany.remove,params:function(){return{shortname:b.company.shortname,resellerAppPk:b.resellerApp.pk}},refreshActivities:!0})}]);h.controller("dashboard.settings.reseller.ResellerAppCompanyCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.settings.reseller.ResellerAppCompanyCtrl");b.resellerAppCompany=c.resellerAppCompany({shortname:b.company.shortname,resellerApp:b.route.bindings.resellerAppPk});a.dataController(b,{promises:[b.resellerAppCompany.$promise]})}])})();
angular.module("dashboard.settings.seating",["dashboard.settings.seating.controllers"]);
(function(){var h=angular.module("dashboard.settings.seating.controllers",[]);h.controller("dashboard.settings.seating.SeatMapsCtrl",["$scope","controllers","db","navigation","require","urls",function(b,a,c,f,e,g){e.inScope(b,"company","dashboard.settings.seating.SeatMapsCtrl");b.seatMaps=c.seatMaps({shortname:f.currentCompany.shortname});return a.dataController(b,{promises:[b.seatMaps.$promise],successCallback:function(){a.listController(b,{collectionKey:"seatMaps",modelKey:"newSeatMap",create:c.seatMaps.create,
params:{shortname:b.company.shortname},successCallback:function(a){f.navigate(a.$url(g.dashboard.settings.seating.seatMap.index))},sortable:!0})}})}]);h.controller("dashboard.settings.seating.SeatMapCtrl",["$scope","controllers","db",function(b,a,c){b.seatMap=c.seatMap({shortname:b.company.shortname,seatMapPk:b.route.bindings.seatMapPk});a.dataController(b,{promises:[b.seatMap.$promise]})}]);h.controller("dashboard.settings.seating.SeatMapEditableCtrl",["$scope","controllers","db","flash","navigation",
"require","urls",function(b,a,c,f,e,g,d){g.inScope(b,"seatMap","dashboard.settings.seating.SeatMapEditableCtrl");a.editController(b,{elementKey:"seatMap",modelKey:"editableSeatMap",get:c.seatMap,remove:c.seatMap.remove,params:{shortname:b.seatMap.company.shortname,seatMapPk:b.seatMap.pk},editing:!0,removeCallback:function(a){f.success(T("Removed seat map"));_.overwriteWithout(b.seatMaps,_.isReferenceEqualTo(a));e.navigate(b.seatMap.company.$url(d.dashboard.settings.seating.index))},refreshActivities:!0})}]);
h.controller("dashboard.settings.seating.SeatZonesCtrl",["$scope","controllers","db","navigation","require","urls",function(b,a,c,f,e,g){e.inScope(b,"seatMap","dashboard.settings.seating.SeatZonesCtrl");b.seatZones=c.seatZones({shortname:b.seatMap.company.shortname,seatMapPk:b.seatMap.pk});return a.dataController(b,{promises:[b.seatZones.$promise],successCallback:function(){a.listController(b,{collectionKey:"seatZones",modelKey:"newSeatZone",create:c.seatZones.create,params:{shortname:b.seatMap.company.shortname,
seatMapPk:b.seatMap.pk},sortable:!0,defaultModel:{color:0}})}})}]);h.controller("dashboard.settings.seating.SeatZoneCtrl",["$scope","controllers","db","navigation","require",function(b,a,c,f,e){e.inScope(b,"seatMap","dashboard.settings.seating.SeatZoneCtrl");b.seatZone=c.seatZone({shortname:f.currentCompany.shortname,seatMapPk:b.seatMap.pk,seatZonePk:b.route.bindings.seatZonePk});return a.dataController(b,{promises:[b.seatZone.$promise]})}]);h.controller("dashboard.settings.seating.SeatZoneEditableCtrl",
["$scope","controllers","db","events","flash","models","navigation","require","urls",function(b,a,c,f,e,g,d,h,m){h.inScope(b,"seatZone","dashboard.settings.seating.SeatZoneEditableCtrl");return a.editController(b,{collectionKey:"seatZones",elementKey:"seatZone",modelKey:"editableSeatZone",update:c.seatZone.update,remove:c.seatZone.remove,editing:!0,params:{shortname:b.seatZone.company.shortname,seatMapPk:b.seatZone.seatMap.pk,seatZonePk:b.seatZone.pk},removeCallback:function(){e.success(interpolate(T("Removed %(seatZoneName)s"),
{seatZoneName:b.seatZone.name}));d.navigate(b.seatZone.$url(m.dashboard.settings.seating.seatMap.seatZones.index));c.seatMap({shortname:b.company.shortname,seatMapPk:b.seatMap.pk})},refreshActivities:!0})}]);h.controller("dashboard.settings.seating.SeatMapLayoutCtrl",["$scope","controllers","db","navigation","require",function(b,a,c,f,e){e.inScope(b,"company","dashboard.settings.seating.SeatMapBuilderCtrl");b.seatMap=c.seatMap({shortname:b.company.shortname,seatMapPk:b.route.bindings.seatMapPk});
b.seatGroups=c.seatGroups({shortname:b.company.shortname,seatMapPk:b.route.bindings.seatMapPk});b.seatZones=c.seatZones({shortname:b.company.shortname,seatMapPk:b.route.bindings.seatMapPk});a.dataController(b,{promises:[b.seatMap.$promise,b.seatGroups.$promise,b.seatZones.$promise],successCallback:function(){b.seatZonesByPk=_.indexBy(b.seatZones,"pk")}})}]);h.controller("dashboard.settings.seating.SeatGroupsCtrl",["$scope","controllers","db","events","models","navigation","require",function(b,a,c,
f,e,g,d){d.inScope(b,"company","dashboard.settings.seating.SeatGroupsCtrl");d.inScope(b,"seatMap","dashboard.settings.seating.SeatGroupsCtrl");d.inScope(b,"seatGroups","dashboard.settings.seating.SeatGroupsCtrl");b.seatsByGroup=_.groupBy(b.seatMap.seats,"seatGroupPk");var h=_.last(b.seatGroups);a.listController(b,{collectionKey:"seatGroups",modelKey:"newSeatGroup",create:c.seatGroups.create,params:{shortname:b.company.shortname,seatMapPk:b.seatMap.pk},successCallback:function(){_.overwriteWithout(b.seatGroups,
h);b.seatGroups.push(h)},alwaysLast:h,sortable:!0});f.on(b,"ngSeatMapBuilder.positionClicked",function(a,c,d){g.navigate(e.Seat.createUrl(c,d,_.last(b.seatGroups)))});f.on(b,"ngSeat.seatClicked",function(a,c){g.navigate(e.Seat.editUrl([c],b.seatMap))});f.on(b,"ngSeat.seatAltClicked",function(a,c){var d=_.where(b.seatMap.seats,{seatGroup:c.seatGroupPk});g.navigate(e.Seat.editUrl(d,b.seatMap))})}]);h.controller("dashboard.settings.seating.SeatGroupCtrl",["$scope","controllers","db","events","flash",
"models","navigation","require","urls",function(b,a,c,f,e,g,d,h,m){h.inScope(b,"company","dashboard.settings.seating.SeatGroupCtrl");h.inScope(b,"seatMap","dashboard.settings.seating.SeatGroupCtrl");b.seatGroup=_.find(b.seatGroups,{pk:_.int(b.route.bindings.seatGroupPk)});a.reorderController(b,{collectionKey:"seatMap.seats",company:b.company,cls:g.Seat.cls});b.isInSeatGroup=function(a){return a.seatGroupPk===b.seatGroup.pk};b.isAddingSeats=!1;b.startAddingSeats=function(){b.isAddingSeats=!0};b.isAddingSeat=
function(a){return a.$addingToGroup===b.seatGroup.pk};b.submitSeatsToGroup=function(a){var d=_.filter(b.seatMap.seats,b.isAddingSeat);_.forEach(d,function(a){a.seatGroupPk=a.$addingToGroup});c.seatMap.update({shortname:b.company.shortname,seatMapPk:b.seatMap.pk},{seats:_.map(d,_.pickPrimitives),type:"update"},a).$promise.then(function(){b.cancelAddingSeats(d)})};b.cancelAddingSeat=function(a){a.$addingToGroup&&(delete a.$addingToGroup,a.$style())};b.cancelAddingSeats=function(a){_.forEach(a||b.seatMap.seats,
b.cancelAddingSeat);b.isAddingSeats=!1};f.on(b,"ngSeatMapBuilder.positionClicked",function(a,c,e){d.navigate(g.Seat.createUrl(c,e,b.seatGroup))});f.on(b,"ngSeat.seatAltClicked",function(a,c){var e=_.where(b.seatMap.seats,{seatGroup:c.seatGroupPk});d.navigate(g.Seat.editUrl(e,b.seatMap))});f.on(b,"ngSeat.seatClicked",function(a,c){c.$addingToGroup?b.cancelAddingSeat(c):b.isAddingSeats?c.seatGroupPk===b.seatGroup.pk||c.$addingToGroup&&c.$addingToGroup[c.seatGroupPk]||(c.$addingToGroup=b.seatGroup.pk,
c.$style()):d.navigate(g.Seat.editUrl([c],b.seatMap))});b.$on("$destroy",function(){b.isAddingSeats&&b.cancelAddingSeats()});return a.editController(b,{collectionKey:"seatGroups",elementKey:"seatGroup",modelKey:"editableSeatGroup",update:c.seatGroup.update,remove:c.seatGroup.remove,params:{shortname:b.seatGroup.company.shortname,seatGroupPk:b.seatGroup.pk,seatMapPk:b.seatGroup.seatMap.pk},removeCallback:function(){e.success(interpolate(T("Removed %(seatGroupName)s"),{seatGroupName:b.seatGroup.name}));
c.seatMap({shortname:b.company.shortname,seatMapPk:b.seatMap.pk}).$promise.then(function(){d.navigate(b.seatGroup.$url(m.dashboard.settings.seating.seatMap.layout.index))})}})}]);h.controller("dashboard.settings.seating.CreateSeatCtrl",["$scope","events","db","models","navigation","require",function(b,a,c,f,e,g){g.inScope(b,"seatZones","dashboard.settings.seating.CreateSeatCtrl");g.inScope(b,"seatGroups","dashboard.settings.seating.CreateSeatCtrl");g=_.int(b.route.bindings.xCoord)||0;var d=_.int(b.route.bindings.yCoord)||
0,h=_.first(b.seatZones).pk,m=_.int(b.route.bindings.seatGroupPk);b.seatGroup=_.find(b.seatGroups,{pk:m});var k=f.Seat.defaultSeat(g,d,h,m);(g=f.Seat.getOverlappingSeat(k,b.seatMap.seats))&&e.redirect(f.Seat.editUrl([g],b.seatMap));b.seatFormModel=_.pick(k,f.Seat.FORM_FIELDS);b.seatMap.seats.push(k);a.broadcast("dashboard.settings.seating.CreateSeatCtrl.createdSeat");b.submit=function(a){c.seatMap.update({shortname:b.company.shortname,seatMapPk:b.seatMap.pk},{seats:[k],type:"create"},a).$promise.then(function(){a.$setPristine();
e.navigate(b.seatGroup.$url())})};var n=function(){k.$style();a.broadcast("dashboard.settings.seating.CreateSeatCtrl.editedSeat")};a.on(b,"ngSeatMapBuilder.positionClicked",function(a,c,d){f.Seat.reposition(k,c,d);b.seatFormModel.name=k.name;n()});b.$watch("seatFormModel",function(a,b){a!==b&&(_.extend(k,a),k.capacity===f.Seat.UNLIMITED&&(k.capacity=null),n())},!0);b.$on("$destroy",function(){_.overwriteWithout(b.seatMap.seats,k);a.broadcast("dashboard.settings.seating.CreateSeatCtrl.removedSeats")})}]);
h.controller("dashboard.settings.seating.EditSeatsCtrl",["$scope","events","db","models","navigation","require",function(b,a,c,f,e,g){g.inScope(b,"company","dashboard.settings.seating.EditSeatCtrl");g.inScope(b,"seatMap","dashboard.settings.seating.EditSeatCtrl");g.inScope(b,"seatGroups","dashboard.settings.seating.EditSeatCtrl");var d=_.toTrueKeys(_.split(b.route.bindings.seatPks,","));b.seats=_.filter(b.seatMap.seats,function(a){return!!d[a.pk]});b.seats.length||e.redirect(b.seatMap.$url());b.isMultiEdit=
1<b.seats.length;b.seatGroup=f.Seat.commonSeatGroup(b.seats,b.seatGroups);var h,m=function(){h={};_.forEach(b.seats,function(a){var b=_.append(f.Seat.FORM_FIELDS,["xCoord","yCoord"]);h[a.pk]=_.pick(a,b)})};m();var k=function(){b.seatFormModel=_.pick(b.seats[0],f.Seat.FORM_FIELDS);_.forEach(_.rest(b.seats),function(a){_.forEach(b.seatFormModel,function(c,d){c!==a[d]&&delete b.seatFormModel[d]})});null===b.seatFormModel.capacity&&(b.seatFormModel.capacity=f.Seat.UNLIMITED)};k();b.submitting=!1;b.submit=
function(a){b.submitting=!0;c.seatMap.update({shortname:b.company.shortname,seatMapPk:b.seatMap.pk},{seats:_.map(b.seats,_.pickPrimitives),type:"update"},a).$promise.then(function(){a.$setPristine();m();var c=f.Seat.commonSeatGroup(b.seats,b.seatGroups);e.navigate(c?c.$url():b.seatMap.$url())},function(){b.submitting=!1})};b.deleting=!1;b.delete=function(d){b.deleting=!0;c.seatMap.update({shortname:b.company.shortname,seatMapPk:b.seatMap.pk},{seats:_.map(b.seats,_.pickPrimitives),type:"hide"},d).$promise.then(function(){e.navigate(b.seatGroup?
b.seatGroup.$url():b.seatMap.$url());a.broadcast("dashboard.settings.seating.EditSeatsCtrl.removedSeats")},function(){b.deleting=!1})};var n=function(){_.forEach(b.seats,function(a){_.extend(a,h[a.pk]);a.$style&&a.$style()});k();a.broadcast("dashboard.settings.seating.EditSeatsCtrl.editedSeats")};b.cancel=function(a){n();b.submitting=!1;a.$setPristine()};a.on(b,"ngSeat.seatClicked",function(a,c){e.navigate(f.Seat.editUrl([c],b.seatMap))});a.on(b,"ngSeat.seatAltClicked",function(a,c){_.contains(b.seats,
c)?_.overwriteWithout(b.seats,c):b.seats.push(c);e.navigate(b.seats.length?f.Seat.editUrl(b.seats,b.seatMap):b.seatMap.$url())});b.$watch("seatFormModel",function(c,d){c!==d&&(_.forEach(b.seats,function(a){_.forEach(b.seatFormModel,function(b,c){""===b&&(b=h[a.pk][c]);"capacity"===c&&b===f.Seat.UNLIMITED&&(b=null);a[c]=b});a.$style()}),a.broadcast("dashboard.settings.seating.EditSeatsCtrl.editedSeats"))},!0);b.$on("$destroy",n)}]);h.controller("dashboard.settings.seating.MoveSeatsCtrl",["$scope",
"events","flash","models","require",function(b,a,c,f,e){e.inScope(b,"seatMap","dashboard.settings.seating.MoveSeatsCtrl");e.inScope(b,"seats","dashboard.settings.seating.MoveSeatsCtrl");e.inScope(b,"seatFormModel","dashboard.settings.seating.MoveSeatsCtrl");var g=function(d,e){var g=f.Seat.newPositions(b.seats,d,e),h=_.difference(b.seatMap.seats,b.seats);_.find(b.seats,function(a,b){var c=_.extend({},a,g[b]);return f.Seat.getOverlappingSeat(c,h)})?c.warn(T("Seat overlap conflict. Please choose a different location.")):
(_.forEach(b.seats,function(a,b){f.Seat.reposition(a,g[b].xCoord,g[b].yCoord);a.$style()}),1===b.seats.length&&(b.seatFormModel.name=b.seats[0].name),a.broadcast("dashboard.settings.seating.MoveSeatsCtrl.movedSeats"),b.seatMapForm.$setDirty())};a.on(b,"ngSeatMapBuilder.positionClicked",function(a,b,c){g(b,c)})}]);h.controller("dashboard.settings.seating.DuplicateSeatCtrl",["$scope","events","db","flash","models","navigation","require",function(b,a,c,f,e,g,d){d.inScope(b,"company","dashboard.settings.seating.DuplicateSeatCtrl");
d.inScope(b,"seatMap","dashboard.settings.seating.DuplicateSeatCtrl");d.inScope(b,"seatGroups","dashboard.settings.seating.DuplicateSeatCtrl");var h=_.toTrueKeys(_.split(b.route.bindings.seatPks,","));b.seats=_.filter(b.seatMap.seats,function(a){return!!h[a.pk]});b.duplicates=[];b.submit=function(a){c.seatMap.update({shortname:b.company.shortname,seatMapPk:b.seatMap.pk},{seats:b.duplicates,type:"duplicate"},a).$promise.then(function(){a.$setPristine();var c=e.Seat.commonSeatGroup(b.duplicates,b.seatGroups);
g.navigate(c?c.$url():b.seatMap.$url())})};var m=function(c,d){var g=e.Seat.newPositions(b.seats,c,d);_.find(b.seats,function(a,c){var d=_.extend({},a,g[c]);return e.Seat.getOverlappingSeat(d,b.seatMap.seats)})?f.warn(T("Seat overlap conflict. Please choose a different location.")):(_.forEach(b.seats,function(a,c){var d=_.pick(a,e.Seat.FORM_FIELDS);d.xCoord=a.xCoord;d.yCoord=a.yCoord;e.Seat.reposition(d,g[c].xCoord,g[c].yCoord,!0);b.seatMap.seats.push(d);b.duplicates.push(d)}),a.broadcast("dashboard.settings.seating.DuplicateSeatCtrl.createdSeats"))};
a.on(b,"ngSeat.seatClicked",function(a,c){c.pk||(_.overwriteWithout(b.seatMap.seats,c),_.overwriteWithout(b.duplicates,c))});a.on(b,"ngSeatMapBuilder.positionClicked",function(a,b,c){m(b,c)});b.cancel=function(){g.navigate(e.Seat.editUrl(b.seats,b.seatMap))};b.$on("$destroy",function(){_.overwriteWithout(b.seatMap.seats,function(a){return!a.pk})})}]);h.controller("dashboard.settings.seating.SeatMapGridCtrl",["$scope","events","db","models","navigation","require","urls",function(b,a,c,f,e,g,d){g.inScope(b,
"company","dashboard.settings.seating.SeatMapGridCtrl");g.inScope(b,"seatMap","dashboard.settings.seating.SeatMapGridCtrl");g.inScope(b,"seatGroups","dashboard.settings.seating.SeatMapGridCtrl");g.inScope(b,"seatZonesByPk","dashboard.settings.seating.SeatMapGridCtrl");b.isGridHidden=!1;b.hideGrid=function(){b.isGridHidden=!b.isGridHidden};b.getSeatGroup=function(a){return _.find(b.seatGroups,{pk:a})};e.watch(b,function(){var a=e.pathEquals(d.dashboard.settings.seating.seatMap.layout.seatGroup)||(e.pathEquals(d.dashboard.settings.seating.seatMap.layout.duplicate)||
e.pathEquals(d.dashboard.settings.seating.seatMap.layout.seats)||e.pathEquals(d.dashboard.settings.seating.seatMap.layout.new))||{};b.selectedSeatPks={};b.selectedSeatGroupPks={};var c=_.indexBy(b.seatMap.seats,"pk");a.seatGroupPk?b.selectedSeatGroupPks[a.seatGroupPk]=!0:a.seatPks&&_.forEach(_.split(a.seatPks,","),function(a){if(a=c[a])b.selectedSeatPks[a.pk]=!0,b.selectedSeatGroupPks[a.seatGroupPk]=!0});_.forEach(b.seatMap.seats,function(a){a.$toggleSelected&&a.$toggleSelected()})})}])})();
angular.module("dashboard.settings.ticketLayouts",["dashboard.settings.ticketLayouts.controllers","dashboard.settings.ticketLayouts.directives"]);
(function(){var h=angular.module("dashboard.settings.ticketLayouts.controllers",[]);h.controller("dashboard.settings.ticketLayouts.TicketLayoutViewCtrl",["$scope","controllers","db","models","storage","require",function(b,a,c,f,e,g){var d=this;g.inScope(b,"Receipt","dashboard.settings.ticketLayouts.TicketLayoutViewCtrl");b.TicketLayout=f.TicketLayout;var h="selectedTicketLayoutPk:"+b.company.shortname,m="selectedReceiptCopyType:"+b.company.shortname;d.MERCHANT_COPY="merchant";d.CUSTOMER_COPY="customer";
d.BOTH_COPIES="both";d.receiptCopyTypes=[{id:d.MERCHANT_COPY,display:T("Merchant copy")},{id:d.CUSTOMER_COPY,display:T("Customer copy")},{id:d.BOTH_COPIES,display:T("Customer and merchant copy")}];d.changeReceiptCopyType=function(){e.set(m,d.selectedReceiptCopyType)};d.ticketLayouts=c.ticketLayouts({shortname:b.company.shortname});d.changeTicketLayout=function(){d.selectedTicketLayout=b.company.features.isTicketLayoutsEnabled?_.find(d.ticketLayouts,function(a){return a.pk===d.selectedTicketLayoutPk})||
d.ticketLayouts[0]||f.TicketLayout.STANDARD:f.TicketLayout.STANDARD;e.set(h,d.selectedTicketLayout.pk)};d.needsPrintSettings=function(){return b.company.features.isTicketLayoutsEnabled&&d.printType===f.TicketLayout.BOCA_PRINT_FORMAT&&0<d.ticketLayouts.length?!0:_.isUndefined(b.activePayment)?!1:b.activePayment===f.Receipt.ALL_PAYMENT_RECEIPTS||b.activePayment.isProcessorBasedType?!0:!1};a.dataController(b,{promises:[d.ticketLayouts.$promise],stale:[d.ticketLayouts],successCallback:function(){d.selectedReceiptCopyType=
e.get(m)||d.BOTH_COPIES;d.selectedTicketLayoutPk=e.get(h);d.changeTicketLayout()}})}]);h.controller("dashboard.settings.ticketLayouts.IndexCtrl",["$scope","controllers","db","models","require",function(b,a,c,f,e){e.inScope(b,"company","dashboard.settings.ticketLayouts.IndexCtrl");b.ticketLayouts=c.ticketLayouts({shortname:b.company.shortname});var g=Object.assign({},f.TicketLayout.BLANK);_.extendWithPrefix("settings-",g,g.settings);delete g.settings;a.dataController(b,{promises:[b.ticketLayouts.$promise],
successCallback:function(){a.listController(b,{collectionKey:"ticketLayouts",modelKey:"newTicketLayout",create:c.ticketLayouts.create,params:function(){return{shortname:b.company.shortname}},defaultModel:g,sortable:!0})}})}]);h.controller("dashboard.settings.ticketLayouts.TicketLayoutCtrl",["$scope","controllers","db","require",function(b,a,c,f){f.inScope(b,"company","dashboard.settings.ticketLayouts.TicketLayoutCtrl");b.ticketLayout=c.ticketLayout({shortname:b.company.shortname,ticketLayoutPk:b.route.bindings.ticketLayoutPk});
a.dataController(b,{promises:[b.ticketLayout.$promise]})}]);h.controller("dashboard.settings.ticketLayouts.TicketLayoutEditableCtrl",["$scope","controllers","db","flash","events","navigation","require","urls",function(b,a,c,f,e,g,d,h){d.inScope(b,"company","dashboard.settings.ticketLayouts.TicketLayoutEditableCtrl");d.inScope(b,"ticketLayout","dashboard.settings.ticketLayouts.TicketLayoutEditableCtrl");d.inScope(b,"ticketLayouts","dashboard.settings.ticketLayouts.TicketLayoutEditableCtrl");a.editController(b,
{collectionKey:"ticketLayouts",elementKey:"ticketLayout",modelKey:"editableTicketLayout",update:c.ticketLayout.update,remove:c.ticketLayout.remove,params:function(){return{shortname:b.company.shortname,ticketLayoutPk:b.ticketLayout.pk}},editCallback:function(){_.extendWithPrefix("settings-",b.editableTicketLayout,b.ticketLayout.settings)},successCallback:function(){e.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},removeCallback:function(){f.success(interpolate(T("Deleted %(ticketLayoutName)s"),
{ticketLayoutName:b.ticketLayout.unicode}));g.navigate(b.ticketLayout.company.$url(h.dashboard.settings.ticketLayouts.index))},editing:!0,skipResetAfterError:!0})}])})();(function(){angular.module("dashboard.settings.ticketLayouts.directives",[]).directive("ngBocaStylesForLayout",function(){return{restrict:"A",templateUrl:"ng-boca-styles-for-layout",scope:{ngBocaStylesForLayout:"="}}})})();angular.module("graphs",["graphs.directives","graphs.services"]);
(function(){angular.module("graphs.services",[]).factory("graphs",["$filter",function(h){var b=function(a,b){return _.map(a,function(a){var c=b.date(a);return{startAt:c,endAt:c,date:c.toDate(),value:b.extract(a)}})},a=function(a,f){if(48>=a.length)return b(a,f);if(140>=a.length){var e=[],g,d,h=a.length%7;h&&(h=7-h);for(var m,k=0;k<a.length;k++)m=a[k],d=Math.floor((h+k)/7),g=e[d]||{startAt:f.date(m),value:0},e[d]=g,g.endAt=f.date(m),g.date=g.endAt.toDate(),g.value+=f.extract(m);return e}e=f.date(a[0]).clone();
e.startOf("month");g=[];var n,s;m=0;for(k=a.length;m<k;m++)d=a[m],h=f.date(d),n=h.clone(),n.startOf("month"),s=n.diff(e,"months",!0),n=g[s]||{startAt:h,date:h.toDate(),value:0},g[s]=n,n.endAt=h,n.value+=f.extract(d);return g};return{series:function(b,f){f.extract=f.extract||function(a){return a};f.date=f.date||function(a){return a.at};var e=a(b,f),g=_.reduce(e,function(a,b){return a+b.value},0),d=_.reduce(e,function(a,b){return Math.max(a,b.value)},0);return{data:e,total:g,max:d}},transformers:{any:_.identity,
amount:function(a){return a/100}},formatters:{any:_.identity,amount:h("amount"),date:_.compose(h("date"),moment)}}}])})();
(function(){angular.module("graphs.directives",[]).directive("ngLineGraph",["$compile","$interpolate","d3","graphs",function(h,b,a,c){var f=function(a,c,d){d=d||"";a=c.find('[name="'+a+'"]');return!a.length?b(d):b(a.text())};return{restrict:"A",compile:function(b,g){var d=f("title",b),l=f("subTitle",b),m=f("tip",b),k=f("format",b);b.empty();return function(b,e,f){e.addClass("d3");var g=b.$eval(f.ngLineGraph);b.isSet(f.ngLineGraphReversed)&&(g=_.reversed(g));var t=b.$eval(f.ngLineGraphOptions);_.isString(t)&&
(t={isAmount:!0,key:t});t.aspectRatio||(t.aspectRatio=0.333);f=t.key;_.isString(f)&&(f=function(a){return _.getDotted(a,t.key)});var g=c.series(g,{extract:f,date:t.dateKey&&function(a){return _.getDotted(a,t.dateKey)},transform:t.isAmount?c.transformers.amount:c.transformers.any}),v=b.$new();v.graph=g;f=Math.min(e.width(),800);var y=f*t.aspectRatio;e.height(y);f=f-100-40;var y=y-40-40,q=a.time.scale().range([0,f]),B=a.scale.linear().range([y,0]),u=a.svg.axis().scale(q).orient("bottom").ticks(5).outerTickSize(0).innerTickSize(0).tickPadding(10).tickFormat(c.formatters.date),
z;z=1>=g.max?1:2===g.max?2:3;z=a.svg.axis().scale(B).orient("left").ticks(z).outerTickSize(0).innerTickSize(-f).tickPadding(10).tickFormat(function(a){v.value=a;return k(v)});e=a.select(e[0]).append("svg").attr("width",f+100+40).attr("height",y+40+40).append("g").attr("transform","translate(100,40)");var C=a.svg.line().x(function(a){return q(a.date)}).y(function(a){return B(a.value)}),F=a.svg.area().x(function(a){return q(a.date)}).y0(y).y1(function(a){return B(a.value)});q.domain(a.extent(g.data,
function(a){return a.date}));B.domain([0,a.max(g.data,function(a){return a.value})]);e.append("g").attr("class","x axis").attr("transform","translate(0,"+y+")").call(u);e.append("g").attr("class","y axis").call(z);e.append("text").attr("x",0).attr("y",-20).attr("text-anchor","end").attr("class","title").text(d(v));e.append("text").attr("x",f).attr("y",-20).attr("text-anchor","end").attr("class","sub-title").text(l(v));e.append("path").datum(g.data).attr("class","area").attr("d",F);e.append("path").datum(g.data).attr("class",
"line").attr("d",C);g=e.selectAll(".point").data(g.data).enter().append("g").attr("class","point").attr("ng-tip",function(a){v.d=a;return m(v)});g.append("circle").attr("class","coarse-point").attr("cx",C.x()).attr("cy",C.y()).attr("r",10);g.append("circle").attr("class","fine-point").attr("cx",C.x()).attr("cy",C.y()).attr("r",5);h(e[0])(b)}}}}])})();angular.module("realtime",["realtime.directives","realtime.services"]);
(function(){var h=angular.module("realtime.services",[]);h.constant("Pusher",window.Pusher);h.factory("pusherClient",["$browser","db","Pusher",function(b,a,c){var f=function(){return b.cookies().csrftoken||a.slipstream("csrfToken")||""},e=new c(a.slipstream("pusherKey"),{encrypted:!0,authEndpoint:"/realtime/auth/",auth:{headers:{"X-CSRFToken":f(),"X-Requested-With":"XMLHttpRequest"}}});e.updateCurrentCompany=function(a){e.config.authEndpoint=a?"/realtime/"+a.shortname+"/auth/":"/realtime/auth/";e.config.auth.headers["X-CSRFToken"]=
f()};return e}]);h.factory("PusherChannel",["convert","db","pusherClient",function(b,a){function c(a){var b=!0;_.isObject(a)||(a={name:a,members:[]},b=!1);this.isReal=b;this.channel=a;this.name=a.name;this.isPresence=_.startsWith(a.name,"presence-")}var f={memberAdded:"pusher:member_added",memberRemoved:"pusher:member_removed",subscriptionSucceeded:"pusher:subscription_succeeded"};c.prototype={members:function(){if(!this.isPresence)throw Error("PusherChannel: can't get members of non-presence channel");
if(this.isReal){var c=[];this.channel.members.each(function(f){c.push(a.serverResponse(b.serverResponse(_.clone(f.info))))});return c}return this.channel.members},setMembers:function(a){if(this.isReal)throw Error("PusherChannel: can't set members of real channel");if(!this.isPresence)throw Error("PusherChannel: can't set members of non-presence channel");_.overwrite(this.channel.members,a)},reconnect:function(){this.isReal&&(this.channel.subscribed||this.channel.subscribe())},bind:function(a,b,c){a=
f[a]||a;this.channel.bind(a,b,c)},unbind:function(a,b,c){a=f[a]||a;this.channel.unbind(a,b,c)},trigger:function(a,b){if(!a)throw Error("PusherChannel: no event name specified");if(0!==a.indexOf("client-"))throw Error("PusherChannel: event name requires 'client-' prefix");return this.channel.trigger(a,b)}};return c}]);h.factory("sonar",["$q","$rootScope","auth","convert","db","events","realtime",function(b,a,c,f,e,g,d){var h=function(){return!c.currentUser.isAuthenticated?(console.info("sonar: not authenticated"),
!1):!d.company?(console.warn("sonar: invalid company"),!1):!d.company.features.isSonarEnabled?(console.info("sonar: not enabled for company",d.company),!1):!0},m=function(){h()&&(d.disconnectOnInactivity(!1),r.subscription?console.warn("sonar: already subscribed to ",r.subscription.channelName):(r.subscription=d.subscribe(a,r.CHANNEL_IDENTIFIER,d.channelTypes.PRIVATE,d.subscriptionTypes.STANDARD),console.info("sonar: subscribed to channel",r.subscription.channelName)))};g.on(a,"navigation.company.updated",
function(a,b){r.subscription&&(d.disconnectOnInactivity(!0),r.subscription?(d.unsubscribe(r.subscription),r.subscription=null,console.info("sonar: unsubscribed from channel")):console.warn("sonar: not subscribed"));b.company&&m()});var k=function(a){return _.isString(a)?a:_.isObject(a)?a.cls&&a.pk?a.cls+"."+a.pk:"":""},n=function(a,b){b=b||"";_.overwriteWithout(r.paused,function(c){return!a||c.identifier===a&&c.tag===b})},s=function(a,c){c=c||"";_.forEach(r.paused,function(d){if(!a||d.identifier===
a&&d.tag===c)(d.fn()||b.when()).then(function(){_.forEach(d.options.actions,function(a){a()})})});n(a,c)},p={},r={CHANNEL_IDENTIFIER:"sonar",EVENT_NAME:"ping",channel:null,get:function(a,b){var c={tagAlong:!0},c=_.isFunction(a)?a(b||{},null,null,null,c):e.refresh(a,c);c.$promise=c.$promise.then(function(a){return!_.isUndefined(a.primaryData)?a.primaryData:a});return c},paused:[],potentiallyPaused:p,pause:function(a,b,c,d){if(h()){c=c||"";var e=k(b),f=e+":"+c;b=p[f]||{};b[a.$id]?console.warn("sonar: already pausing in scope",
f,a.$id):(b[a.$id]=d||{},p[f]=b,a.$on("$destroy",function(){var b=p[f];delete b[a.$id];_.isEmpty(b)&&(delete p[f],n(e,c))}))}},unpause:function(a,b){var c=k(a);s(c,b)},flush:function(a,b){var c=k(a);n(c,b)},watch:function(a,b){if(!h())return _.ignore;_.isArray(b)||(b=[b]);var c=_.last(arguments)||_.ignore,e="";4===arguments.length&&(e=arguments[2]||"");var g={},n=_.choose(b,function(a){var b=k(a);if(b)return g[b]=a,b;console.warn("sonar: unable to watch object",a)});if(!n.length)return console.warn("sonar: no objects to watch",
arguments),_.ignore;r.subscription||m();var s=function(h){try{var k=f.serverResponse(h),l=k.identifier;if(l){var m=k.realtimeIdentifier||"";if((!m||!(d.connectionIdentifier&&m===d.connectionIdentifier))&&_.contains(n,l)){var s=k.tag||"";if(s===e){var x=g[l];if(x){var z=function(){console.info("sonar: trigger ping handler",l,s,k);return c(x,k.options||{},k)},C=p[l+":"+s];C?a.$safeApply(function(){var a=s,a=a||"",b=_.values(C),b=b={actions:_.pluck(b,"action"),descriptions:_.pluck(b,"description")};
r.paused.push({object:x,identifier:l,tag:a,fn:z,options:b})}):a.$safeApply(z)}else console.warn("sonar: invalid object identifier",l,"watching",b)}}}else console.warn("sonar: invalid ping",k)}catch(I){console.warn("sonar: invalid ping",I,h)}},C=function(a){_.isArray(a)?_.forEach(a,s):s(a)};console.info("sonar: binding",r.EVENT_NAME,n,e);r.subscription.pusherChannel.bind(r.EVENT_NAME,C);var F=function(){console.info("sonar: unbinding",r.EVENT_NAME,n,e);r.subscription&&r.subscription.pusherChannel.unbind(r.EVENT_NAME,
C)},x=a.$on("$destroy",F);return function(){x();F()}}};return r}]);h.factory("realtime",["$document","$http","$window","$q","$rootScope","$timeout","auth","db","events","PusherChannel","pusherClient","require",function(b,a,c,f,e,g,d,h,m,k,n,s){var p=function(a,b,c){return b+"-@"+c.shortname+"="+a.replace(/\//g,"-").replace(/[^0-9a-zA-Z_\-=@,.;]/g,"")},r={},t=function(a,b){var c=_.contains([E.subscriptionTypes.FULL,E.subscriptionTypes.STANDARD],b)?new k(n.subscribe(a)):new k(a);return{channelName:a,
subscriptionType:b,pusherChannel:c,scopes:[],userCount:0,users:[]}},v=function(){E.isBroken=!0;setTimeout(function(){E.isBroken=!1;q=0;H()},3E4)},y=function(a){_.isUndefined(a)?_.forEach(r,y):_.forEach(a,function(a){_.forEach(a.scopes,function(a){a.$safeDigest()})})},q=0,B=!1,u=!1,z={},C=function(a){if(a=r[a]){var b=a[E.subscriptionTypes.FULL]||a[E.subscriptionTypes.VIEW_MEMBERS];if(b){var c=_.uniq(b.pusherChannel.members(),function(a){return a.uri});_.forEach(a,function(a){_.overwrite(a.users,_.choose(c,
function(a){if(a.uri!==d.currentUser.uri)return a}));a.userCount=a.users.length})}y(a)}},F=function(a){a&&(z[a]=!0);E.isBroken||x()},x=_.debounce(function(){if(E.company)if(B)u=!0;else{u=!1;B=!0;var a=[];_.forEach(_.keys(z),function(b){var c=r[b];c&&(c[E.subscriptionTypes.FULL]?(C(b),delete z[b]):c[E.subscriptionTypes.VIEW_MEMBERS]&&a.push(b))});var b=z;z={};var c=[],d;a.length&&(d=h.pusher.members({shortname:E.company.shortname},{channels:a},null,null,{flashError:!1}),c.push(d.$promise));var e;e=
h.pusher.channels({shortname:E.company.shortname},null,null,null,{flashError:!1});c.push(e.$promise);f.all(c).then(function(a){B=!1;var b={};_.forEach(d,function(a){b[a.channel]=a.users||[]});var c={};_.forEach(e,function(a){c[a.channel]=a.userCount||0});_.forEach(r,function(a,f){var g=!1,h=_.get(a,E.subscriptionTypes.VIEW_MEMBERS),k=_.get(a,E.subscriptionTypes.VIEW_STATS);if(d&&h){var l=b[f];l&&(h.pusherChannel.setMembers(l),C(f),g=!0)}!g&&(e&&k)&&(k.userCount=c[f]||0,C(f))});u&&F()},function(){B=
!1;q++;_.extend(z,b);5<q&&v()})}},500,{trailing:!0,maxWait:1E3}),w=function(a){var b=function(b){C(a.channelName)};a.pusherChannel.bind("subscriptionSucceeded",function(c){b(c);G?G.pusherChannel.trigger("client-subscribed",{channelName:a.channelName,activity:"subscribed"}):console.warn("realtime: not subscribed to activity channel")});a.pusherChannel.bind("memberAdded",b);a.pusherChannel.bind("memberRemoved",b)},G=null,M=function(a){a=a.channelName;r[a]&&(z[a]=!0,F())},K=function(){if(E.company){var a=
p("activity",E.channelTypes.PRIVATE,E.company);G&&a!==G.channelName&&G&&(E.unsubscribe(G),G=null);G||(G=E.subscribe(null,"activity",E.channelTypes.PRIVATE,E.subscriptionTypes.STANDARD),G.pusherChannel.bind("client-subscribed",M),G.pusherChannel.bind("client-unsubscribed",M))}else console.warn("realtime: invalid company when subscribing to activity channel")};n.connection.bind("state_change",function(b){b="connected"===(b&&b.current);E.connectionIdentifier=(b?n.connection.socket_id:"")||"";E.connectionIdentifier?
(console.info("realtime: connection identified",E.connectionIdentifier),a.defaults.headers.common["X-FH-Realtime-ID"]=E.connectionIdentifier):delete a.defaults.headers.common["X-FH-Realtime-ID"];b&&(_.forEach(r,function(a){_.forEach(a,function(a){a.pusherChannel.reconnect()})}),F())});n.connection.bind("error",function(a){a=_.get(a,"error.data.message","");0===a.indexOf("Existing subscription to channel ")&&(a=a.replace("Existing subscription to channel ",""),_.forEach(r[a]||{},function(a){a.pusherChannel.reconnect()}))});
var H=function(){d.currentUser.isAuthenticated&&"disconnected"===n.connection.state&&(console.info("realtime: reconnecting..."),n.connection.connect())},L=new Date;setInterval(function(){var a=b[0].hasFocus(),c=new Date;a&&(L=c);6E4<c-L&&E.isDisconnectOnInactivityAllowed?"disconnected"!==n.connection.state&&(console.info("realtime: disconnecting..."),n.connection.disconnect()):a&&H()},1E4);angular.element(c).on("focus",function(){L=new Date;H()});var E={channelSubscriptions:r,channelTypes:{PRESENCE:"presence",
PRIVATE:"private"},subscriptionTypes:{FULL:"full",VIEW_MEMBERS:"view-members",VIEW_STATS:"view-stats",STANDARD:"standard"},connectionIdentifier:"",isBroken:!1,company:null,isDisconnectOnInactivityAllowed:!0,disconnectOnInactivity:function(a){E.isDisconnectOnInactivityAllowed=a;E.isDisconnectOnInactivityAllowed||H()},subscribe:function(a,b,c,d,e){if(e=e||E.company){b=p(b,c,e);var f=(c=_.get(r,b+"."+d,null))||t(b,d);_.set(r,b+"."+d,f);f.subscriptionType===E.subscriptionTypes.FULL&&w(f);!c&&!_.contains([E.subscriptionTypes.FULL,
E.subscriptionTypes.STANDARD],d)&&F(b);a&&(f.scopes.push(a),a.$on("$destroy",function(){_.overwriteWithout(f.scopes,a);f.scopes.length||E.unsubscribe(f)}));return f}console.warn("realtime: invalid company when subscribing to channel",b)},unsubscribe:function(a,b,c,d){var e,f;if(1===arguments.length)e=arguments[0]||null,f=r[e.channelName]||null;else{d=d||E.company;if(!d){console.warn("realtime: invalid company when unsubscribing from channel",a);return}e=p(a,b,d);f=r[e]||null;if(!f)return;e=f[c]||
null}e?(e.pusherChannel.isReal&&(n.unsubscribe(e.channelName),G&&e.subscriptionType===E.subscriptionTypes.FULL?G.pusherChannel.trigger("client-unsubscribed",{channelName:e.channelName,activity:"unsubscribed"}):G||console.warn("realtime: already unsubscribed from activity channel")),delete f[e.subscriptionType],_.isEmpty(f)&&delete r[e.channelName]):console.warn("realtime: already unsubscribed from channel")}};m.on(e,"navigation.company.updated",function(a,b){var c=b.company;c?(E.company=c,n.updateCurrentCompany(c),
H(),console.info("realtime: subscribing to activity channel",E.company),K()):g(function(){var a=E.company;E.company=null;n.updateCurrentCompany(null);console.info("realtime: unsubscribing from activity channel",a);G&&(E.unsubscribe(G),G=null)})});return E}]);h.run(["$rootScope","realtime","sonar",function(b,a,c){b.realtime=a;b.sonar=c}])})();
(function(){var h=angular.module("realtime.directives",[]);h.directive("ngPresence",["$templateCache","$parse","auth","d","db","models","realtime",function(a,b,f,e,g,d,h){var m="production"===g.slipstream("configuration");return{restrict:"A",scope:!0,compile:function(g,n){var s=a.get("realtime.users");s||console.warn("ng-presence: template not found");g.html(s);var p=function(a){return a.company===f.currentUser.company?a.name:a.company.shortname===d.Company.ADMIN_SHORTNAME?a.name+' <span class="badge badge-blue">FH</span>':
a.name+" ("+a.company.shortname+")"},r=b(n.ngPresenceCompany);return function(a,b,c){a.effectiveName=p;c.$observe("ngPresenceTip",function(b){a.tip=b});c.$observe("ngPresenceIcon",function(b){a.icon=b});if(b=e.observer(c,"ngPresence")()){c=a.isSet(c.ngPresenceViewOnly)?h.subscriptionTypes.VIEW_MEMBERS:h.subscriptionTypes.FULL;var d=r(a);m&&f.isAuthenticatedForAdminCompany()&&(c=d&&(d.isAdmin||d.isDemoModeEnabled)?c:h.subscriptionTypes.VIEW_MEMBERS);a.channel=h.subscribe(a,b,h.channelTypes.PRESENCE,
c,d)}else console.warn("ng-presence: invalid channel name")}}}}]);h.directive("ngPresenceIndicator",["d","ngTipDirective","realtime",function(a,b,f){var e=function(a){return a.channel&&0<a.channel.userCount};return{restrict:"A",scope:!0,link:function(g,d,h){var m=function(){h.ngTip=h.ngPresenceTip;b[0].compile()(g,d,h);m=_.ignore},k=a.observer(h,"ngPresenceIndicator")();k?(g.$watch(e,function(a){d.removeClass("active");a&&(d.addClass("active "+status),m())}),g.channel=f.subscribe(g,k,f.channelTypes.PRESENCE,
f.subscriptionTypes.VIEW_STATS)):console.warn("ng-presence-indicator: invalid channel name")}}}]);h.directive("ngSonarBookingIndicator",["sonar",function(a){return{restrict:"A",link:function(b,f,e){var g=null;(e=b.$eval(e.ngSonarBookingIndicator))&&a.watch(b,e,"bookings.created",function(){g&&(clearTimeout(g),g=null);f.addClass("active");g=setTimeout(function(){f.addClass("done");g=setTimeout(function(){f.removeClass("active done");g=null},2500)},2500)})}}}]);h.directive("ngSonarPaused",["sonar",
function(a){return{restrict:"A",scope:!0,controller:[function(){var b=[];this.descriptions=function(){_.overwrite(b,_.unique(_.flatten(_.pluck(a.paused,"options.descriptions"))));return b};this.unpause=function(){a.unpause()};this.dismiss=function(){a.flush()}}],templateUrl:"ng-sonar-paused",controllerAs:"sonarPausedCtrl"}}]);var b=function(a){var b=a=a||"",f="";if(a=a.match(/^\s*([\s\S]+)\s+when\s+([\s\S]+)\s*$/))b=a[1],f=_.trim(a[2]);return{objectExpr:b,tag:f}};h.directive("ngSonarPause",["$parse",
"sonar",function(a,c){return{restrict:"A",link:function(f,e,g){e=b(g.ngSonarPause);var d=f.$eval(e.objectExpr),h=f.$interpolate(g.ngSonarPauseDescription)||d.unicode;g=_.bind(a(g.ngSonarPauseAction),null,f);!d||!h?console.warn("ng-sonar-pause: invalid arguments",d,h):c.pause(f,d,e.tag,{description:h,action:g})}}}]);h.directive("ngSonarUnpause",["sonar",function(a){return{restrict:"A",link:function(c,f,e){var g=b(e.ngSonarUnpause),d=c.$eval(g.objectExpr);f.on("click",function(){c.$safeApply(function(){a.unpause(d,
g.tag)})})}}}])})();
(function(){var h=angular.module("scanning",["db","lib","native"]);h.factory("scanning",["$rootScope","$q","$window","checkin","db","events","flash","models","native","require",function(b,a,c,f,e,g,d,h,m,k){var n=null;d={NOT_SCANNING:"not-scanning",SCANNING:"scanning",LOADING:"loading",SUCCESS:"success",ERROR:"error"};var s={AUTO_CHECKIN_CUSTOMER_TYPE:"auto-customer",AUTO_CHECKIN_BOOKING_TYPE:"auto-booking",CHECKIN_CUSTOMER_TYPE:"customer",CHECKIN_BOOKING_TYPE:"booking",VIEW_TYPE:"view"};s.DEFAULT_AUTO_SCANNING_TYPE=
s.AUTO_CHECKIN_CUSTOMER_TYPE;var p={DISABLE_INVALID_CHECKIN_TYPE:"disable-invalid-checkin",ALLOW_INVALID_CHECKIN_TYPE:"allow-invalid-checkin",AUTO_INVALID_CHECKIN_TYPE:"auto-invalid-checkin"};p.DEFAULT_INVALID_CHECKIN_TYPE=p.ALLOW_INVALID_CHECKIN_TYPE;var r={NO_CHECKIN_STATUSES:T("No checkin statuses"),CUSTOMER_NOT_ON_MANIFEST_ERROR:T("Customer not on manifest"),CUSTOMER_NOT_ON_MANIFEST_ERROR_ALREADY_CHECKED_IN:T("Customer already checked in"),BOOKING_ALREADY_CHECKED_IN_ERROR:T("Already checked in"),
CUSTOMER_NOT_FOUND_ERROR:T("Booking not found"),CUSTOMER_ALREADY_CHECKED_IN_ERROR:T("Already checked in"),UNKNOWN_ERROR:T("Something went wrong")};angular.element(c).on("beforeunload",function(){x.stop()});g.on(b,"fareharbor.native.scanning.scannedCode",function(a,b){var c=x.decode(b.code);console.info("scanning: scanned code",b.code,c,c?"valid":"invalid");c?(m.indicate(m.WEAK_SUCCESS_INDICATION),v(c)):(m.indicate(m.STRONG_ERROR_INDICATION),x.scanCode());g.broadcast("scanning.scanned")});g.on(b,"fareharbor.native.scanning.started",
function(a,b){x.isScanning=!0});g.on(b,"fareharbor.native.scanning.stopped",function(a,b){x.isScanning=!1});var t=function(a,b){return _.chooseFirst(a.customers,function(a){if(a.encodedPk===b)return a})},v=function(a){var b=_.chooseFirst(n.bookings,function(b){return t(b,a)});return b?y(b):q(a)},y=function(a){x.invalidBooking=null;x.invalidCustomer=null;x.currentCustomer=a;x.currentBooking=a.booking;switch(x.autoScanningType){case x.VIEW_TYPE:x.currentCustomer.checkinStatus?(console.warn("scanning: customer already checked in",
x.currentCustomer),z(x.CUSTOMER_ALREADY_CHECKED_IN_ERROR)):x.status=x.SUCCESS;B();break;case x.CHECKIN_CUSTOMER_TYPE:B();C(!0);break;case x.CHECKIN_BOOKING_TYPE:B();F(!0);break;case x.AUTO_CHECKIN_CUSTOMER_TYPE:C(!0).then(function(){x.scanCode()});break;case x.AUTO_CHECKIN_BOOKING_TYPE:F(!0).then(function(){x.scanCode()})}},q=function(b){x.invalidBooking=null;x.invalidCustomer=null;x.currentBooking=null;x.currentCustomer=null;x.invalidCheckinType!==x.AUTO_INVALID_CHECKIN_TYPE&&(B(),x.status=x.LOADING,
x.errorMessage=x.CUSTOMER_NOT_ON_MANIFEST_ERROR);var c=e.customers.find({encodedPk:b});c.$promise.then(function(){if(c.company!==n.company)return console.warn("scanning: customer found but for wrong company",b,c),z(x.CUSTOMER_NOT_FOUND_ERROR),a.reject(x.CUSTOMER_NOT_FOUND_ERROR);x.invalidBooking=c;x.invalidCustomer=t(c,b);if(x.invalidCheckinType===x.AUTO_INVALID_CHECKIN_TYPE&&!x.invalidCustomer.checkinStatus&&x.autoScanningType!==x.VIEW_TYPE)x.useInvalid();else{var d=x.invalidCustomer.checkinStatus?
x.CUSTOMER_NOT_ON_MANIFEST_ERROR_ALREADY_CHECKED_IN:x.CUSTOMER_NOT_ON_MANIFEST_ERROR;z(d);return a.reject(d)}},function(){console.warn("scanning: customer not found",b);z(x.CUSTOMER_NOT_FOUND_ERROR);return a.reject(x.CUSTOMER_NOT_FOUND_ERROR)})},B=function(){m.broadcast("fareharbor.native.scanning.stop")},u=function(){x.status=x.SUCCESS;x.errorMessage="";m.indicate(m.STRONG_SUCCESS_INDICATION)},z=function(a){x.status=x.ERROR;x.errorMessage=a;m.indicate(m.STRONG_ERROR_INDICATION);B()},C=function(b){k.assert(x.currentCustomer,
"scanning: invalid customer");k.assert(x.currentBooking,"scanning: invalid customer");x.isCheckingIn=!0;if(!n.checkinStatuses.length)return console.warn("scanning: no checkin statuses"),z(x.NO_CHECKIN_STATUSES),a.reject(x.NO_CHECKIN_STATUSES);var c=n.checkinStatuses[0];if(b&&x.currentCustomer.checkinStatus)return console.warn("scanning: customer already checked in",x.currentCustomer),z(x.CUSTOMER_ALREADY_CHECKED_IN_ERROR),a.reject(x.CUSTOMER_ALREADY_CHECKED_IN_ERROR);x.status=x.LOADING;return f.updateCustomer(x.currentCustomer,
c,{enqueue:"yes",validate:"yes"}).then(function(){u()},function(b){e.booking({shortname:x.currentCustomer.booking.company.shortname,bookingUuid:x.currentCustomer.booking.uuid});b=b.data.checkinError||x.UNKNOWN_ERROR;z(b);return a.reject(b)})},F=function(b,c){k.assert(x.currentBooking,"scanning: invalid booking");x.currentCustomer=null;x.isCheckingIn=!c;if(!n.checkinStatuses.length)return console.warn("scanning: no checkin statuses"),z(x.NO_CHECKIN_STATUSES),a.reject(x.NO_CHECKIN_STATUSES);var d=c?
null:n.checkinStatuses[0];if(b&&null!==h.CheckinStatus.bookingCheckinStatus(x.currentBooking))return console.warn("scanning: booking already checked in"),z(x.BOOKING_ALREADY_CHECKED_IN_ERROR),a.reject(x.BOOKING_ALREADY_CHECKED_IN_ERROR);x.status=x.LOADING;return f.updateBooking(x.currentBooking,d,{enqueue:"yes",validate:"yes"}).then(function(){u()},function(b){b=b.data.checkinError||x.UNKNOWN_ERROR;z(b);return a.reject(b)})},x={isScanning:!1,status:d.NOT_SCANNING,autoScanningType:s.DEFAULT_AUTO_SCANNING_TYPE,
isCheckinIn:!0,invalidBooking:null,invalidCustomer:null,invalidCheckinType:p.DEFAULT_INVALID_CHECKIN_TYPE,isInvalidCheckinAllowed:function(){return x.autoScanningType!==x.VIEW_TYPE&&x.invalidCheckinType!==x.DISABLE_INVALID_CHECKIN_TYPE&&x.invalidCustomer&&!x.invalidCustomer.checkinStatus},currentBooking:null,currentCustomer:null,updateContext:function(a,b){k.defined(b,"company","scanning.updateContext");k.defined(b,"bookings","scanning.updateContext");k.defined(b,"checkinStatuses","scanning.updateContext");
n=b;a.$on("$destroy",function(){n=null})},useInvalid:function(){y(x.invalidCustomer)},scanCode:function(){k.assert(n,"scanning: context required");console.info("scanning: starting scanning");x.status===x.NOT_SCANNING&&(x.status=x.SCANNING);m.broadcast("fareharbor.native.scanning.scanCode");x.isScanning=!0},stop:function(){console.info("scanning: stopping scanning");x.status=x.NOT_SCANNING;x.currentBooking=null;x.currentCustomer=null;B()},toggle:function(){x.isScanning?x.stop():x.scanCode()},decode:function(a){var b=
e.slipstream("checkinDomain");if(0===a.indexOf(b)&&(a=a.split("/")[1]))return a},checkinCustomer:_.bind(C,null,!1),checkinBooking:_.bind(F,null,!1)};_.extend(x,d);_.extend(x,s);_.extend(x,p);_.extend(x,r);return x}]);h.run(["$rootScope","scanning",function(b,a){b.scanning=a}]);h.directive("ngScanning",["$parse","$window","events","models","scanning","$timeout",function(b,a,c,f,e,g){return{restrict:"A",controller:["$scope","$element","$attrs",function(a,b,h){var k=this,n=a.$eval(h.ngScanning),s=a.$eval(h.ngScanningBookings);
h=a.$eval(h.ngScanningCheckinStatuses);e.updateContext(a,{company:n,bookings:s,checkinStatuses:h});k.submitting=!1;var p=function(){k.submitting=!1};k.checkin=function(){k.submitting=!0;e.checkinBooking().then(p,p)};k.removeCheckin=function(){k.submitting=!0;e.checkinBooking("remove").then(p,p)};k.isBookingCheckinAllowed=function(){if(!e.currentBooking)return!1;var a=f.CheckinStatus.bookingCheckinStatus(e.currentBooking);return!a||a===f.CheckinStatus.MIXED_CHECKIN_STATUS};k.resume=function(){e.scanCode()};
k.done=function(){e.stop()};k.useInvalid=function(){e.useInvalid()};c.on(a,"scanning.scanned",function(a,c){var d=$("body, html"),f=0;if(e.currentBooking){var h=b.find(".scanning-booking-"+e.currentBooking.pk.toString());h.length&&(f=h.offset().top);d.scrollTop(f)}else g(function(){var a=d.find(".scanning-message");a.length&&(f=a.offset().top);d.scrollTop(f)})});a.$on("$destroy",function(){e.stop()})}],controllerAs:"scanningCtrl"}}]);h.directive("ngScanningBooking",[function(){return{restrict:"A",
require:"^ngScanning",templateUrl:"scanning.booking"}}]);h.directive("ngScanningMessage",[function(){return{restrict:"A",require:"^ngScanning",templateUrl:"scanning.message"}}])})();
(function(){angular.module("checkin",["auth","db","lib"]).factory("checkin",["auth","db","events","flash","models",function(h,b,a,c,f){var e={updateCustomer:function(e,d,f){var h=e.checkinStatus;e.checkinStatus=d;a.broadcast("manifest.IndexCtrl.reconstruct");f=_.extend({checkinStatus:d?d.pk:""},f);return b.customer.checkinStatus.update({shortname:e.booking.company.shortname,bookingUuid:e.booking.uuid,customerPk:e.pk},f,null,null,{flashError:!1}).$promise.then(function(){a.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},
function(){e.checkinStatus=h;c.error(T("Unable to update check-in"));a.broadcast("manifest.IndexCtrl.reconstruct")})},updateBooking:function(e,d,f){var h=_.map(e.customers,function(a){var b=a.checkinStatus;a.checkinStatus=d;return b});a.broadcast("manifest.IndexCtrl.reconstruct");f=_.extend({checkinStatus:d?d.pk:""},f);return b.booking.checkinStatus.update({shortname:e.company.shortname,bookingUuid:e.uuid},f,null,null,{flashError:!1}).$promise.then(function(){a.broadcast("dashboard.shared.ActivitiesCtrl.refresh")},
function(){_.forEach(h,function(a,b){e.customers[b].checkinStatus=a||null});c.error(T("Unable to update check-in"));a.broadcast("manifest.IndexCtrl.reconstruct")})},updateBookings:function(e){var d=e.successCallback||_.ignore,l=e.bookings,m=e.checkinStatus;e=e.company;var l=_.filter(l,function(a){return h.permissions.can("updateCheckinStatus",f.Customer,a)}),k={};_.forEach(l,function(a){_.forEach(a.customers,function(a){k[a.pk]=a.checkinStatus;a.checkinStatus=m})});a.broadcast("manifest.IndexCtrl.reconstruct");
b.checkinStatus.updateBookings({shortname:e.shortname},{bookings:_.pluck(l,"pk"),checkinStatus:m?m.pk:null}).$promise.then(function(){d()},function(){c.error(T("Unable to update check-in"));_.forEach(l,function(a){_.forEach(a.customers,function(a){a.checkinStatus=k[a.pk]})});a.broadcast("manifest.IndexCtrl.reconstruct")})},checkinStatusOptions:function(a,b){var c=b.checkinStatuses;if(b.currentCheckinStatus&&!_.contains(b.checkinStatuses,b.currentCheckinStatus)&&b.currentCheckinStatus!==f.CheckinStatus.EMPTY_CHECKIN_STATUS&&
b.currentCheckinStatus!==f.CheckinStatus.MIXED_CHECKIN_STATUS)var e=b.currentCheckinStatus,c=[e].concat(c),h=a.$watch(b.watchValue,function(a,b){a!==b&&(_.overwriteWithout(c,e),h())});return c},bookingCheckinStatusController:function(a,b){var h=!!b.mixedCheckinStatus,m=b.booking,k=b.checkinStatuses,n=b.submitCallback||_.ignore,s=b.successCallback||_.ignore,p=b.errorCallback||_.ignore;a.bookingCheckinStatusCtrl={};var r=function(){var a=f.CheckinStatus.bookingCheckinStatus(m);return a?a.pk:""};a.bookingCheckinStatusCtrl.editableBooking=
{checkinStatus:r()};a.$watch(r,function(b){a.bookingCheckinStatusCtrl.editableBooking.checkinStatus=b});var t=[f.CheckinStatus.EMPTY_CHECKIN_STATUS];_.forEach(k,function(a){t.push(a)});h&&t.push(f.CheckinStatus.MIXED_CHECKIN_STATUS);a.bookingCheckinStatusCtrl.options=e.checkinStatusOptions(a,{currentCheckinStatus:f.CheckinStatus.bookingCheckinStatus(m),watchValue:r,checkinStatuses:t});var v={};_.forEach(a.bookingCheckinStatusCtrl.options,function(a){v[a.pk]=a});v[f.CheckinStatus.EMPTY_CHECKIN_STATUS.pk]=
null;a.bookingCheckinStatusCtrl.changeCheckinStatus=function(b){b===f.CheckinStatus.MIXED_CHECKIN_STATUS?s(b):(b===f.CheckinStatus.EMPTY_CHECKIN_STATUS&&(b=null),n(b),e.updateBooking(a.booking,b).then(function(){s()},function(){c.error(T("Unable to update check-in"));p()}))};a.$watch("bookingCheckinStatusCtrl.editableBooking.checkinStatus",function(b,c){var d=f.CheckinStatus.bookingCheckinStatus(a.booking),e=v[b];e!==d&&b!==c&&a.bookingCheckinStatusCtrl.changeCheckinStatus(e)})}};return e}])})();
(function(){var h=angular.module("site","lib auth book cache cart checkin clientOptions db flash graphs heartbeat lightframe native navigation plusbook prices rebook seating scanning tracking urls realtime company manifest dashboard root site.controllers".split(" "));configure(h)})();
(function(){angular.module("site.controllers",[]).controller("site.IndexCtrl",["$scope","navigation","urls",function(h,b,a){h.isShowingLegacyManifestUrlWarning=!1;h.resetLegacyManifestUrlWarning=function(){h.isShowingLegacyManifestUrlWarning=!1};b.pathStartsWith(a.legacyManifest)&&(h.isShowingLegacyManifestUrlWarning=!0,a=b.url.split("/"),a.splice(2,0,"dashboard"),b.redirect(a.join("/")));return h}])})();
